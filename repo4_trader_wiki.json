{
  "code": 200,
  "data": {
    "description": "This page provides a high-level introduction to the trader system, explaining its purpose, architecture, and major components. For detailed information on specific subsystems, see: $1, $1, $1, $1, and",
    "external": {
      "apple-touch-icon": {
        "https://deepwiki.com/apple-icon.png?a4f658907db0ab87": {
          "sizes": "180x180",
          "type": "image/png"
        }
      },
      "canonical": {
        "https://deepwiki.com/timercrack/trader": {}
      },
      "icon": {
        "https://deepwiki.com/favicon.ico": {
          "sizes": "48x48",
          "type": "image/x-icon"
        },
        "https://deepwiki.com/icon.png?1ee4c6a68a73a205": {
          "sizes": "48x48",
          "type": "image/png"
        }
      },
      "preload": {
        "https://deepwiki.com/_next/static/chunks/webpack-5400bf868d87f903.js?dpl=dpl_3mLkJC9WsEUqB2wKLhtmuPqhxVgT": {
          "as": "script",
          "fetchpriority": "low"
        },
        "https://deepwiki.com/_next/static/media/4cf2300e9c8272f7-s.p.woff2": {
          "as": "font",
          "crossorigin": "",
          "type": "font/woff2"
        },
        "https://deepwiki.com/_next/static/media/93f479601ee12b01-s.p.woff2": {
          "as": "font",
          "crossorigin": "",
          "type": "font/woff2"
        }
      }
    },
    "html": "<html lang=\"en\" class=\"light\" style=\"color-scheme: light;\"><head><meta charset=\"utf-8\"><meta name=\"viewport\" content=\"width=device-width, initial-scale=1\"><link rel=\"preload\" href=\"/_next/static/media/4cf2300e9c8272f7-s.p.woff2\" as=\"font\" crossorigin=\"\" type=\"font/woff2\"><link rel=\"preload\" href=\"/_next/static/media/93f479601ee12b01-s.p.woff2\" as=\"font\" crossorigin=\"\" type=\"font/woff2\"><link rel=\"stylesheet\" href=\"/_next/static/css/de70bee13400563f.css?dpl=dpl_3mLkJC9WsEUqB2wKLhtmuPqhxVgT\" data-precedence=\"next\"><link rel=\"stylesheet\" href=\"/_next/static/css/b54d92a85d180acc.css?dpl=dpl_3mLkJC9WsEUqB2wKLhtmuPqhxVgT\" data-precedence=\"next\"><link rel=\"preload\" as=\"script\" fetchpriority=\"low\" href=\"/_next/static/chunks/webpack-5400bf868d87f903.js?dpl=dpl_3mLkJC9WsEUqB2wKLhtmuPqhxVgT\"><script src=\"/_next/static/chunks/87c73c54-dd8d81ac9604067c.js?dpl=dpl_3mLkJC9WsEUqB2wKLhtmuPqhxVgT\" async=\"\"></script><script src=\"/_next/static/chunks/18-6b7bc0c3a8ab7ea5.js?dpl=dpl_3mLkJC9WsEUqB2wKLhtmuPqhxVgT\" async=\"\"></script><script src=\"/_next/static/chunks/main-app-57aa1716f0d0f500.js?dpl=dpl_3mLkJC9WsEUqB2wKLhtmuPqhxVgT\" async=\"\"></script><script src=\"/_next/static/chunks/b1298b8d-5cac6cd7c8e952ff.js?dpl=dpl_3mLkJC9WsEUqB2wKLhtmuPqhxVgT\" async=\"\"></script><script src=\"/_next/static/chunks/378e5a93-860e027c5a5e0c0d.js?dpl=dpl_3mLkJC9WsEUqB2wKLhtmuPqhxVgT\" async=\"\"></script><script src=\"/_next/static/chunks/f7f68e2d-d8bf979db5ff4e9d.js?dpl=dpl_3mLkJC9WsEUqB2wKLhtmuPqhxVgT\" async=\"\"></script><script src=\"/_next/static/chunks/1265-fa8a95d3842768f5.js?dpl=dpl_3mLkJC9WsEUqB2wKLhtmuPqhxVgT\" async=\"\"></script><script src=\"/_next/static/chunks/9885-b57089f03806c3b8.js?dpl=dpl_3mLkJC9WsEUqB2wKLhtmuPqhxVgT\" async=\"\"></script><script src=\"/_next/static/chunks/659-ee9e1e775e30dcef.js?dpl=dpl_3mLkJC9WsEUqB2wKLhtmuPqhxVgT\" async=\"\"></script><script src=\"/_next/static/chunks/app/layout-0537c2076823e553.js?dpl=dpl_3mLkJC9WsEUqB2wKLhtmuPqhxVgT\" async=\"\"></script><script src=\"/_next/static/chunks/7bf36345-1ac10ec2f0e0c88f.js?dpl=dpl_3mLkJC9WsEUqB2wKLhtmuPqhxVgT\" async=\"\"></script><script src=\"/_next/static/chunks/c16f53c3-b390b6f98a69dcec.js?dpl=dpl_3mLkJC9WsEUqB2wKLhtmuPqhxVgT\" async=\"\"></script><script src=\"/_next/static/chunks/2602-735d398a11941702.js?dpl=dpl_3mLkJC9WsEUqB2wKLhtmuPqhxVgT\" async=\"\"></script><script src=\"/_next/static/chunks/8461-369a9f0c48ea2626.js?dpl=dpl_3mLkJC9WsEUqB2wKLhtmuPqhxVgT\" async=\"\"></script><script src=\"/_next/static/chunks/4429-92c77bf2d3e82e1c.js?dpl=dpl_3mLkJC9WsEUqB2wKLhtmuPqhxVgT\" async=\"\"></script><script src=\"/_next/static/chunks/9976-726fc148e3fe0730.js?dpl=dpl_3mLkJC9WsEUqB2wKLhtmuPqhxVgT\" async=\"\"></script><script src=\"/_next/static/chunks/1481-e8a771bf9a2ec0bd.js?dpl=dpl_3mLkJC9WsEUqB2wKLhtmuPqhxVgT\" async=\"\"></script><script src=\"/_next/static/chunks/app/%5Borg%5D/%5Brepo%5D/%5B%5B...wikiRoutes%5D%5D/page-82e5155a284526b9.js?dpl=dpl_3mLkJC9WsEUqB2wKLhtmuPqhxVgT\" async=\"\"></script><script src=\"/_next/static/chunks/25-9f305b682cea7558.js?dpl=dpl_3mLkJC9WsEUqB2wKLhtmuPqhxVgT\" async=\"\"></script><script src=\"/_next/static/chunks/7391-db08a263f1c857d8.js?dpl=dpl_3mLkJC9WsEUqB2wKLhtmuPqhxVgT\" async=\"\"></script><script src=\"/_next/static/chunks/2512-fc2ad2e11d161d20.js?dpl=dpl_3mLkJC9WsEUqB2wKLhtmuPqhxVgT\" async=\"\"></script><script src=\"/_next/static/chunks/6375-6b1e677037ddc4d1.js?dpl=dpl_3mLkJC9WsEUqB2wKLhtmuPqhxVgT\" async=\"\"></script><script src=\"/_next/static/chunks/9437-00f165dda9ad3a42.js?dpl=dpl_3mLkJC9WsEUqB2wKLhtmuPqhxVgT\" async=\"\"></script><script src=\"/_next/static/chunks/app/%5Borg%5D/%5Brepo%5D/layout-1d48b1e2f124e49f.js?dpl=dpl_3mLkJC9WsEUqB2wKLhtmuPqhxVgT\" async=\"\"></script><meta name=\"next-size-adjust\" content=\"\"><title>timercrack/trader | DeepWiki</title><meta name=\"description\" content=\"This page provides a high-level introduction to the trader system, explaining its purpose, architecture, and major components. For detailed information on specific subsystems, see: $1, $1, $1, $1, and\"><meta name=\"keywords\" content=\"timercrack/trader,timercrack,trader,documentation,wiki,codebase,AI documentation,Devin,Overview\"><link rel=\"canonical\" href=\"https://deepwiki.com/timercrack/trader\"><meta property=\"og:title\" content=\"timercrack/trader | DeepWiki\"><meta property=\"og:description\" content=\"This page provides a high-level introduction to the trader system, explaining its purpose, architecture, and major components. For detailed information on specific subsystems, see: $1, $1, $1, $1, and\"><meta property=\"og:url\" content=\"https://deepwiki.com/timercrack/trader\"><meta property=\"og:site_name\" content=\"DeepWiki\"><meta property=\"og:image\" content=\"https://deepwiki.com/timercrack/trader/og-image.png?page=1\"><meta property=\"og:type\" content=\"website\"><meta name=\"twitter:card\" content=\"summary_large_image\"><meta name=\"twitter:site\" content=\"@cognition\"><meta name=\"twitter:creator\" content=\"@cognition\"><meta name=\"twitter:title\" content=\"timercrack/trader | DeepWiki\"><meta name=\"twitter:description\" content=\"This page provides a high-level introduction to the trader system, explaining its purpose, architecture, and major components. For detailed information on specific subsystems, see: $1, $1, $1, $1, and\"><meta name=\"twitter:image\" content=\"https://deepwiki.com/timercrack/trader/og-image.png?page=1\"><link rel=\"icon\" href=\"/favicon.ico\" type=\"image/x-icon\" sizes=\"48x48\"><link rel=\"icon\" href=\"/icon.png?1ee4c6a68a73a205\" type=\"image/png\" sizes=\"48x48\"><link rel=\"apple-touch-icon\" href=\"/apple-icon.png?a4f658907db0ab87\" type=\"image/png\" sizes=\"180x180\"><script src=\"/_next/static/chunks/polyfills-42372ed130431b0a.js?dpl=dpl_3mLkJC9WsEUqB2wKLhtmuPqhxVgT\" nomodule=\"\"></script><style type=\"text/css\">[data-sonner-toaster][dir=ltr],html[dir=ltr]{--toast-icon-margin-start:-3px;--toast-icon-margin-end:4px;--toast-svg-margin-start:-1px;--toast-svg-margin-end:0px;--toast-button-margin-start:auto;--toast-button-margin-end:0;--toast-close-button-start:0;--toast-close-button-end:unset;--toast-close-button-transform:translate(-35%, -35%)}[data-sonner-toaster][dir=rtl],html[dir=rtl]{--toast-icon-margin-start:4px;--toast-icon-margin-end:-3px;--toast-svg-margin-start:0px;--toast-svg-margin-end:-1px;--toast-button-margin-start:0;--toast-button-margin-end:auto;--toast-close-button-start:unset;--toast-close-button-end:0;--toast-close-button-transform:translate(35%, -35%)}[data-sonner-toaster]{position:fixed;width:var(--width);font-family:ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial,Noto Sans,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol,Noto Color Emoji;--gray1:hsl(0, 0%, 99%);--gray2:hsl(0, 0%, 97.3%);--gray3:hsl(0, 0%, 95.1%);--gray4:hsl(0, 0%, 93%);--gray5:hsl(0, 0%, 90.9%);--gray6:hsl(0, 0%, 88.7%);--gray7:hsl(0, 0%, 85.8%);--gray8:hsl(0, 0%, 78%);--gray9:hsl(0, 0%, 56.1%);--gray10:hsl(0, 0%, 52.3%);--gray11:hsl(0, 0%, 43.5%);--gray12:hsl(0, 0%, 9%);--border-radius:8px;box-sizing:border-box;padding:0;margin:0;list-style:none;outline:0;z-index:999999999;transition:transform .4s ease}@media (hover:none) and (pointer:coarse){[data-sonner-toaster][data-lifted=true]{transform:none}}[data-sonner-toaster][data-x-position=right]{right:var(--offset-right)}[data-sonner-toaster][data-x-position=left]{left:var(--offset-left)}[data-sonner-toaster][data-x-position=center]{left:50%;transform:translateX(-50%)}[data-sonner-toaster][data-y-position=top]{top:var(--offset-top)}[data-sonner-toaster][data-y-position=bottom]{bottom:var(--offset-bottom)}[data-sonner-toast]{--y:translateY(100%);--lift-amount:calc(var(--lift) * var(--gap));z-index:var(--z-index);position:absolute;opacity:0;transform:var(--y);touch-action:none;transition:transform .4s,opacity .4s,height .4s,box-shadow .2s;box-sizing:border-box;outline:0;overflow-wrap:anywhere}[data-sonner-toast][data-styled=true]{padding:16px;background:var(--normal-bg);border:1px solid var(--normal-border);color:var(--normal-text);border-radius:var(--border-radius);box-shadow:0 4px 12px rgba(0,0,0,.1);width:var(--width);font-size:13px;display:flex;align-items:center;gap:6px}[data-sonner-toast]:focus-visible{box-shadow:0 4px 12px rgba(0,0,0,.1),0 0 0 2px rgba(0,0,0,.2)}[data-sonner-toast][data-y-position=top]{top:0;--y:translateY(-100%);--lift:1;--lift-amount:calc(1 * var(--gap))}[data-sonner-toast][data-y-position=bottom]{bottom:0;--y:translateY(100%);--lift:-1;--lift-amount:calc(var(--lift) * var(--gap))}[data-sonner-toast][data-styled=true] [data-description]{font-weight:400;line-height:1.4;color:#3f3f3f}[data-rich-colors=true][data-sonner-toast][data-styled=true] [data-description]{color:inherit}[data-sonner-toaster][data-sonner-theme=dark] [data-description]{color:#e8e8e8}[data-sonner-toast][data-styled=true] [data-title]{font-weight:500;line-height:1.5;color:inherit}[data-sonner-toast][data-styled=true] [data-icon]{display:flex;height:16px;width:16px;position:relative;justify-content:flex-start;align-items:center;flex-shrink:0;margin-left:var(--toast-icon-margin-start);margin-right:var(--toast-icon-margin-end)}[data-sonner-toast][data-promise=true] [data-icon]>svg{opacity:0;transform:scale(.8);transform-origin:center;animation:sonner-fade-in .3s ease forwards}[data-sonner-toast][data-styled=true] [data-icon]>*{flex-shrink:0}[data-sonner-toast][data-styled=true] [data-icon] svg{margin-left:var(--toast-svg-margin-start);margin-right:var(--toast-svg-margin-end)}[data-sonner-toast][data-styled=true] [data-content]{display:flex;flex-direction:column;gap:2px}[data-sonner-toast][data-styled=true] [data-button]{border-radius:4px;padding-left:8px;padding-right:8px;height:24px;font-size:12px;color:var(--normal-bg);background:var(--normal-text);margin-left:var(--toast-button-margin-start);margin-right:var(--toast-button-margin-end);border:none;font-weight:500;cursor:pointer;outline:0;display:flex;align-items:center;flex-shrink:0;transition:opacity .4s,box-shadow .2s}[data-sonner-toast][data-styled=true] [data-button]:focus-visible{box-shadow:0 0 0 2px rgba(0,0,0,.4)}[data-sonner-toast][data-styled=true] [data-button]:first-of-type{margin-left:var(--toast-button-margin-start);margin-right:var(--toast-button-margin-end)}[data-sonner-toast][data-styled=true] [data-cancel]{color:var(--normal-text);background:rgba(0,0,0,.08)}[data-sonner-toaster][data-sonner-theme=dark] [data-sonner-toast][data-styled=true] [data-cancel]{background:rgba(255,255,255,.3)}[data-sonner-toast][data-styled=true] [data-close-button]{position:absolute;left:var(--toast-close-button-start);right:var(--toast-close-button-end);top:0;height:20px;width:20px;display:flex;justify-content:center;align-items:center;padding:0;color:var(--gray12);background:var(--normal-bg);border:1px solid var(--gray4);transform:var(--toast-close-button-transform);border-radius:50%;cursor:pointer;z-index:1;transition:opacity .1s,background .2s,border-color .2s}[data-sonner-toast][data-styled=true] [data-close-button]:focus-visible{box-shadow:0 4px 12px rgba(0,0,0,.1),0 0 0 2px rgba(0,0,0,.2)}[data-sonner-toast][data-styled=true] [data-disabled=true]{cursor:not-allowed}[data-sonner-toast][data-styled=true]:hover [data-close-button]:hover{background:var(--gray2);border-color:var(--gray5)}[data-sonner-toast][data-swiping=true]::before{content:'';position:absolute;left:-100%;right:-100%;height:100%;z-index:-1}[data-sonner-toast][data-y-position=top][data-swiping=true]::before{bottom:50%;transform:scaleY(3) translateY(50%)}[data-sonner-toast][data-y-position=bottom][data-swiping=true]::before{top:50%;transform:scaleY(3) translateY(-50%)}[data-sonner-toast][data-swiping=false][data-removed=true]::before{content:'';position:absolute;inset:0;transform:scaleY(2)}[data-sonner-toast][data-expanded=true]::after{content:'';position:absolute;left:0;height:calc(var(--gap) + 1px);bottom:100%;width:100%}[data-sonner-toast][data-mounted=true]{--y:translateY(0);opacity:1}[data-sonner-toast][data-expanded=false][data-front=false]{--scale:var(--toasts-before) * 0.05 + 1;--y:translateY(calc(var(--lift-amount) * var(--toasts-before))) scale(calc(-1 * var(--scale)));height:var(--front-toast-height)}[data-sonner-toast]>*{transition:opacity .4s}[data-sonner-toast][data-x-position=right]{right:0}[data-sonner-toast][data-x-position=left]{left:0}[data-sonner-toast][data-expanded=false][data-front=false][data-styled=true]>*{opacity:0}[data-sonner-toast][data-visible=false]{opacity:0;pointer-events:none}[data-sonner-toast][data-mounted=true][data-expanded=true]{--y:translateY(calc(var(--lift) * var(--offset)));height:var(--initial-height)}[data-sonner-toast][data-removed=true][data-front=true][data-swipe-out=false]{--y:translateY(calc(var(--lift) * -100%));opacity:0}[data-sonner-toast][data-removed=true][data-front=false][data-swipe-out=false][data-expanded=true]{--y:translateY(calc(var(--lift) * var(--offset) + var(--lift) * -100%));opacity:0}[data-sonner-toast][data-removed=true][data-front=false][data-swipe-out=false][data-expanded=false]{--y:translateY(40%);opacity:0;transition:transform .5s,opacity .2s}[data-sonner-toast][data-removed=true][data-front=false]::before{height:calc(var(--initial-height) + 20%)}[data-sonner-toast][data-swiping=true]{transform:var(--y) translateY(var(--swipe-amount-y,0)) translateX(var(--swipe-amount-x,0));transition:none}[data-sonner-toast][data-swiped=true]{user-select:none}[data-sonner-toast][data-swipe-out=true][data-y-position=bottom],[data-sonner-toast][data-swipe-out=true][data-y-position=top]{animation-duration:.2s;animation-timing-function:ease-out;animation-fill-mode:forwards}[data-sonner-toast][data-swipe-out=true][data-swipe-direction=left]{animation-name:swipe-out-left}[data-sonner-toast][data-swipe-out=true][data-swipe-direction=right]{animation-name:swipe-out-right}[data-sonner-toast][data-swipe-out=true][data-swipe-direction=up]{animation-name:swipe-out-up}[data-sonner-toast][data-swipe-out=true][data-swipe-direction=down]{animation-name:swipe-out-down}@keyframes swipe-out-left{from{transform:var(--y) translateX(var(--swipe-amount-x));opacity:1}to{transform:var(--y) translateX(calc(var(--swipe-amount-x) - 100%));opacity:0}}@keyframes swipe-out-right{from{transform:var(--y) translateX(var(--swipe-amount-x));opacity:1}to{transform:var(--y) translateX(calc(var(--swipe-amount-x) + 100%));opacity:0}}@keyframes swipe-out-up{from{transform:var(--y) translateY(var(--swipe-amount-y));opacity:1}to{transform:var(--y) translateY(calc(var(--swipe-amount-y) - 100%));opacity:0}}@keyframes swipe-out-down{from{transform:var(--y) translateY(var(--swipe-amount-y));opacity:1}to{transform:var(--y) translateY(calc(var(--swipe-amount-y) + 100%));opacity:0}}@media (max-width:600px){[data-sonner-toaster]{position:fixed;right:var(--mobile-offset-right);left:var(--mobile-offset-left);width:100%}[data-sonner-toaster][dir=rtl]{left:calc(var(--mobile-offset-left) * -1)}[data-sonner-toaster] [data-sonner-toast]{left:0;right:0;width:calc(100% - var(--mobile-offset-left) * 2)}[data-sonner-toaster][data-x-position=left]{left:var(--mobile-offset-left)}[data-sonner-toaster][data-y-position=bottom]{bottom:var(--mobile-offset-bottom)}[data-sonner-toaster][data-y-position=top]{top:var(--mobile-offset-top)}[data-sonner-toaster][data-x-position=center]{left:var(--mobile-offset-left);right:var(--mobile-offset-right);transform:none}}[data-sonner-toaster][data-sonner-theme=light]{--normal-bg:#fff;--normal-border:var(--gray4);--normal-text:var(--gray12);--success-bg:hsl(143, 85%, 96%);--success-border:hsl(145, 92%, 87%);--success-text:hsl(140, 100%, 27%);--info-bg:hsl(208, 100%, 97%);--info-border:hsl(221, 91%, 93%);--info-text:hsl(210, 92%, 45%);--warning-bg:hsl(49, 100%, 97%);--warning-border:hsl(49, 91%, 84%);--warning-text:hsl(31, 92%, 45%);--error-bg:hsl(359, 100%, 97%);--error-border:hsl(359, 100%, 94%);--error-text:hsl(360, 100%, 45%)}[data-sonner-toaster][data-sonner-theme=light] [data-sonner-toast][data-invert=true]{--normal-bg:#000;--normal-border:hsl(0, 0%, 20%);--normal-text:var(--gray1)}[data-sonner-toaster][data-sonner-theme=dark] [data-sonner-toast][data-invert=true]{--normal-bg:#fff;--normal-border:var(--gray3);--normal-text:var(--gray12)}[data-sonner-toaster][data-sonner-theme=dark]{--normal-bg:#000;--normal-bg-hover:hsl(0, 0%, 12%);--normal-border:hsl(0, 0%, 20%);--normal-border-hover:hsl(0, 0%, 25%);--normal-text:var(--gray1);--success-bg:hsl(150, 100%, 6%);--success-border:hsl(147, 100%, 12%);--success-text:hsl(150, 86%, 65%);--info-bg:hsl(215, 100%, 6%);--info-border:hsl(223, 43%, 17%);--info-text:hsl(216, 87%, 65%);--warning-bg:hsl(64, 100%, 6%);--warning-border:hsl(60, 100%, 9%);--warning-text:hsl(46, 87%, 65%);--error-bg:hsl(358, 76%, 10%);--error-border:hsl(357, 89%, 16%);--error-text:hsl(358, 100%, 81%)}[data-sonner-toaster][data-sonner-theme=dark] [data-sonner-toast] [data-close-button]{background:var(--normal-bg);border-color:var(--normal-border);color:var(--normal-text)}[data-sonner-toaster][data-sonner-theme=dark] [data-sonner-toast] [data-close-button]:hover{background:var(--normal-bg-hover);border-color:var(--normal-border-hover)}[data-rich-colors=true][data-sonner-toast][data-type=success]{background:var(--success-bg);border-color:var(--success-border);color:var(--success-text)}[data-rich-colors=true][data-sonner-toast][data-type=success] [data-close-button]{background:var(--success-bg);border-color:var(--success-border);color:var(--success-text)}[data-rich-colors=true][data-sonner-toast][data-type=info]{background:var(--info-bg);border-color:var(--info-border);color:var(--info-text)}[data-rich-colors=true][data-sonner-toast][data-type=info] [data-close-button]{background:var(--info-bg);border-color:var(--info-border);color:var(--info-text)}[data-rich-colors=true][data-sonner-toast][data-type=warning]{background:var(--warning-bg);border-color:var(--warning-border);color:var(--warning-text)}[data-rich-colors=true][data-sonner-toast][data-type=warning] [data-close-button]{background:var(--warning-bg);border-color:var(--warning-border);color:var(--warning-text)}[data-rich-colors=true][data-sonner-toast][data-type=error]{background:var(--error-bg);border-color:var(--error-border);color:var(--error-text)}[data-rich-colors=true][data-sonner-toast][data-type=error] [data-close-button]{background:var(--error-bg);border-color:var(--error-border);color:var(--error-text)}.sonner-loading-wrapper{--size:16px;height:var(--size);width:var(--size);position:absolute;inset:0;z-index:10}.sonner-loading-wrapper[data-visible=false]{transform-origin:center;animation:sonner-fade-out .2s ease forwards}.sonner-spinner{position:relative;top:50%;left:50%;height:var(--size);width:var(--size)}.sonner-loading-bar{animation:sonner-spin 1.2s linear infinite;background:var(--gray11);border-radius:6px;height:8%;left:-10%;position:absolute;top:-3.9%;width:24%}.sonner-loading-bar:first-child{animation-delay:-1.2s;transform:rotate(.0001deg) translate(146%)}.sonner-loading-bar:nth-child(2){animation-delay:-1.1s;transform:rotate(30deg) translate(146%)}.sonner-loading-bar:nth-child(3){animation-delay:-1s;transform:rotate(60deg) translate(146%)}.sonner-loading-bar:nth-child(4){animation-delay:-.9s;transform:rotate(90deg) translate(146%)}.sonner-loading-bar:nth-child(5){animation-delay:-.8s;transform:rotate(120deg) translate(146%)}.sonner-loading-bar:nth-child(6){animation-delay:-.7s;transform:rotate(150deg) translate(146%)}.sonner-loading-bar:nth-child(7){animation-delay:-.6s;transform:rotate(180deg) translate(146%)}.sonner-loading-bar:nth-child(8){animation-delay:-.5s;transform:rotate(210deg) translate(146%)}.sonner-loading-bar:nth-child(9){animation-delay:-.4s;transform:rotate(240deg) translate(146%)}.sonner-loading-bar:nth-child(10){animation-delay:-.3s;transform:rotate(270deg) translate(146%)}.sonner-loading-bar:nth-child(11){animation-delay:-.2s;transform:rotate(300deg) translate(146%)}.sonner-loading-bar:nth-child(12){animation-delay:-.1s;transform:rotate(330deg) translate(146%)}@keyframes sonner-fade-in{0%{opacity:0;transform:scale(.8)}100%{opacity:1;transform:scale(1)}}@keyframes sonner-fade-out{0%{opacity:1;transform:scale(1)}100%{opacity:0;transform:scale(.8)}}@keyframes sonner-spin{0%{opacity:1}100%{opacity:.15}}@media (prefers-reduced-motion){.sonner-loading-bar,[data-sonner-toast],[data-sonner-toast]>*{transition:none!important;animation:none!important}}.sonner-loader{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);transform-origin:center;transition:opacity .2s,transform .2s}.sonner-loader[data-visible=false]{opacity:0;transform:scale(.8) translate(-50%,-50%)}</style><script id=\"hotjar-init-script\" crossorigin=\"anonymous\">(function(h,o,t,j,a,r){h.hj=h.hj||function(){(h.hj.q=h.hj.q||[]).push(arguments)};h._hjSettings={hjid:6382967,hjsv:6,hjdebug:false};a=o.getElementsByTagName('head')[0];r=o.createElement('script');r.async=1;r.src=t+h._hjSettings.hjid+j+h._hjSettings.hjsv;a.appendChild(r);})(window,document,'https://static.hotjar.com/c/hotjar-','.js?sv=');</script><script async=\"\" src=\"https://static.hotjar.com/c/hotjar-6382967.js?sv=6\"></script><script async=\"\" src=\"https://script.hotjar.com/modules.ddd41caee2adfc4aedb8.js\" charset=\"utf-8\"></script></head><body class=\"__variable_188709 font-geist-sans relative min-h-screen __variable_9a8899 bg-background antialiased\" style=\"overflow: auto;\"><div hidden=\"\"><!--$--><!--/$--></div><section aria-label=\"Notifications alt+T\" tabindex=\"-1\" aria-live=\"polite\" aria-relevant=\"additions text\" aria-atomic=\"false\"></section><script>((a,b,c,d,e,f,g,h)=>{let i=document.documentElement,j=[\"light\",\"dark\"];function k(b){var c;(Array.isArray(a)?a:[a]).forEach(a=>{let c=\"class\"===a,d=c&&f?e.map(a=>f[a]||a):e;c?(i.classList.remove(...d),i.classList.add(f&&f[b]?f[b]:b)):i.setAttribute(a,b)}),c=b,h&&j.includes(c)&&(i.style.colorScheme=c)}if(d)k(d);else try{let a=localStorage.getItem(b)||c,d=g&&\"system\"===a?window.matchMedia(\"(prefers-color-scheme: dark)\").matches?\"dark\":\"light\":a;k(d)}catch(a){}})(\"class\",\"theme\",\"light\",null,[\"light\",\"dark\"],null,true,true)</script><!--$--><div class=\"flex min-h-screen w-full flex-col text-white\" id=\"codebase-wiki-repo-page\"><div class=\"bg-background border-b-border sticky top-0 z-30 border-b border-dashed\"><div class=\"font-geist-mono relative flex h-8 items-center justify-center text-xs font-medium sm:hidden\"><div class=\"powered-by-devin-gradient absolute inset-0 z-[-1] h-8 w-full\"></div><button class=\"flex items-center gap-2\"><svg class=\"size-3 [&amp;_path]:stroke-0 [&amp;_path]:animate-[custom-pulse_1.8s_infinite_var(--delay,0s)]\" xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"110 110 460 500\"><path style=\"fill:#21c19a\" class=\"[--delay:0.6s]\" d=\"M418.73,332.37c9.84-5.68,22.07-5.68,31.91,0l25.49,14.71c.82.48,1.69.8,2.58,1.06.19.06.37.11.55.16.87.21,1.76.34,2.65.35.04,0,.08.02.13.02.1,0,.19-.03.29-.04.83-.02,1.64-.13,2.45-.32.14-.03.28-.05.42-.09.87-.24,1.7-.59,2.5-1.03.08-.04.17-.06.25-.1l50.97-29.43c3.65-2.11,5.9-6.01,5.9-10.22v-58.86c0-4.22-2.25-8.11-5.9-10.22l-50.97-29.43c-3.65-2.11-8.15-2.11-11.81,0l-50.97,29.43c-.08.04-.13.11-.2.16-.78.48-1.51,1.02-2.15,1.66-.1.1-.18.21-.28.31-.57.6-1.08,1.26-1.51,1.97-.07.12-.15.22-.22.34-.44.77-.77,1.6-1.03,2.47-.05.19-.1.37-.14.56-.22.89-.37,1.81-.37,2.76v29.43c0,11.36-6.11,21.95-15.95,27.63-9.84,5.68-22.06,5.68-31.91,0l-25.49-14.71c-.82-.48-1.69-.8-2.57-1.06-.19-.06-.37-.11-.56-.16-.88-.21-1.76-.34-2.65-.34-.13,0-.26.02-.4.02-.84.02-1.66.13-2.47.32-.13.03-.27.05-.4.09-.87.24-1.71.6-2.51,1.04-.08.04-.16.06-.24.1l-50.97,29.43c-3.65,2.11-5.9,6.01-5.9,10.22v58.86c0,4.22,2.25,8.11,5.9,10.22l50.97,29.43c.08.04.17.06.24.1.8.44,1.64.79,2.5,1.03.14.04.28.06.42.09.81.19,1.62.3,2.45.32.1,0,.19.04.29.04.04,0,.08-.02.13-.02.89,0,1.77-.13,2.65-.35.19-.04.37-.1.56-.16.88-.26,1.75-.59,2.58-1.06l25.49-14.71c9.84-5.68,22.06-5.68,31.91,0,9.84,5.68,15.95,16.27,15.95,27.63v29.43c0,.95.15,1.87.37,2.76.05.19.09.37.14.56.25.86.59,1.69,1.03,2.47.07.12.15.22.22.34.43.71.94,1.37,1.51,1.97.1.1.18.21.28.31.65.63,1.37,1.18,2.15,1.66.07.04.13.11.2.16l50.97,29.43c1.83,1.05,3.86,1.58,5.9,1.58s4.08-.53,5.9-1.58l50.97-29.43c3.65-2.11,5.9-6.01,5.9-10.22v-58.86c0-4.22-2.25-8.11-5.9-10.22l-50.97-29.43c-.08-.04-.16-.06-.24-.1-.8-.44-1.64-.8-2.51-1.04-.13-.04-.26-.05-.39-.09-.82-.2-1.65-.31-2.49-.33-.13,0-.25-.02-.38-.02-.89,0-1.78.13-2.66.35-.18.04-.36.1-.54.15-.88.26-1.75.59-2.58,1.07l-25.49,14.72c-9.84,5.68-22.07,5.68-31.9,0-9.84-5.68-15.95-16.27-15.95-27.63s6.11-21.95,15.95-27.63Z\"></path><path style=\"fill:#3969ca\" d=\"M141.09,317.65l50.97,29.43c1.83,1.05,3.86,1.58,5.9,1.58s4.08-.53,5.9-1.58l50.97-29.43c.08-.04.13-.11.2-.16.78-.48,1.51-1.02,2.15-1.66.1-.1.18-.21.28-.31.57-.6,1.08-1.26,1.51-1.97.07-.12.15-.22.22-.34.44-.77.77-1.6,1.03-2.47.05-.19.1-.37.14-.56.22-.89.37-1.81.37-2.76v-29.43c0-11.36,6.11-21.95,15.96-27.63s22.06-5.68,31.91,0l25.49,14.71c.82.48,1.69.8,2.57,1.06.19.06.37.11.56.16.87.21,1.76.34,2.64.35.04,0,.09.02.13.02.1,0,.19-.04.29-.04.83-.02,1.65-.13,2.45-.32.14-.03.28-.05.41-.09.87-.24,1.71-.6,2.51-1.04.08-.04.16-.06.24-.1l50.97-29.43c3.65-2.11,5.9-6.01,5.9-10.22v-58.86c0-4.22-2.25-8.11-5.9-10.22l-50.97-29.43c-3.65-2.11-8.15-2.11-11.81,0l-50.97,29.43c-.08.04-.13.11-.2.16-.78.48-1.51,1.02-2.15,1.66-.1.1-.18.21-.28.31-.57.6-1.08,1.26-1.51,1.97-.07.12-.15.22-.22.34-.44.77-.77,1.6-1.03,2.47-.05.19-.1.37-.14.56-.22.89-.37,1.81-.37,2.76v29.43c0,11.36-6.11,21.95-15.95,27.63-9.84,5.68-22.07,5.68-31.91,0l-25.49-14.71c-.82-.48-1.69-.8-2.58-1.06-.19-.06-.37-.11-.55-.16-.88-.21-1.76-.34-2.65-.35-.13,0-.26.02-.4.02-.83.02-1.66.13-2.47.32-.13.03-.27.05-.4.09-.87.24-1.71.6-2.51,1.04-.08.04-.16.06-.24.1l-50.97,29.43c-3.65,2.11-5.9,6.01-5.9,10.22v58.86c0,4.22,2.25,8.11,5.9,10.22Z\"></path><path style=\"fill:#0294de\" class=\"[--delay:1.2s]\" d=\"M396.88,484.35l-50.97-29.43c-.08-.04-.17-.06-.24-.1-.8-.44-1.64-.79-2.51-1.03-.14-.04-.27-.06-.41-.09-.81-.19-1.64-.3-2.47-.32-.13,0-.26-.02-.39-.02-.89,0-1.78.13-2.66.35-.18.04-.36.1-.54.15-.88.26-1.76.59-2.58,1.07l-25.49,14.72c-9.84,5.68-22.06,5.68-31.9,0-9.84-5.68-15.96-16.27-15.96-27.63v-29.43c0-.95-.15-1.87-.37-2.76-.05-.19-.09-.37-.14-.56-.25-.86-.59-1.69-1.03-2.47-.07-.12-.15-.22-.22-.34-.43-.71-.94-1.37-1.51-1.97-.1-.1-.18-.21-.28-.31-.65-.63-1.37-1.18-2.15-1.66-.07-.04-.13-.11-.2-.16l-50.97-29.43c-3.65-2.11-8.15-2.11-11.81,0l-50.97,29.43c-3.65,2.11-5.9,6.01-5.9,10.22v58.86c0,4.22,2.25,8.11,5.9,10.22l50.97,29.43c.08.04.17.06.25.1.8.44,1.63.79,2.5,1.03.14.04.29.06.43.09.8.19,1.61.3,2.43.32.1,0,.2.04.3.04.04,0,.09-.02.13-.02.88,0,1.77-.13,2.64-.34.19-.04.37-.1.56-.16.88-.26,1.75-.59,2.57-1.06l25.49-14.71c9.84-5.68,22.06-5.68,31.91,0,9.84,5.68,15.95,16.27,15.95,27.63v29.43c0,.95.15,1.87.37,2.76.05.19.09.37.14.56.25.86.59,1.69,1.03,2.47.07.12.15.22.22.34.43.71.94,1.37,1.51,1.97.1.1.18.21.28.31.65.63,1.37,1.18,2.15,1.66.07.04.13.11.2.16l50.97,29.43c1.83,1.05,3.86,1.58,5.9,1.58s4.08-.53,5.9-1.58l50.97-29.43c3.65-2.11,5.9-6.01,5.9-10.22v-58.86c0-4.22-2.25-8.11-5.9-10.22Z\"></path></svg>Index your code with Devin</button></div><div class=\"container-wrapper\"><div class=\"container mx-auto flex w-full flex-row items-center gap-2 py-4 md:py-6\"><a class=\"flex items-center gap-3\" href=\"/\"><span class=\"text-base font-medium leading-none md:text-lg hidden sm:block\">DeepWiki</span></a><div class=\"flex-1\"><div class=\"flex flex-row items-center gap-2\"><a class=\"block text-xs font-medium leading-none text-white sm:hidden md:text-lg\" href=\"/\">DeepWiki</a><p class=\"text-sm font-normal leading-none md:text-lg\"><a href=\"https://github.com/timercrack/trader\" target=\"_blank\" rel=\"noopener noreferrer\" title=\"Open repository\" class=\"text-muted-foreground hover:text-muted-foreground/80 group inline-flex items-center gap-1 transition-colors\">timercrack/trader<!-- --> <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"16\" height=\"16\" fill=\"currentColor\" viewBox=\"0 0 256 256\" class=\"opacity-0 transition-opacity group-hover:opacity-100\"><path d=\"M224,104a8,8,0,0,1-16,0V59.32l-66.33,66.34a8,8,0,0,1-11.32-11.32L196.68,48H152a8,8,0,0,1,0-16h64a8,8,0,0,1,8,8Zm-40,24a8,8,0,0,0-8,8v72H48V80h72a8,8,0,0,0,0-16H48A16,16,0,0,0,32,80V208a16,16,0,0,0,16,16H176a16,16,0,0,0,16-16V136A8,8,0,0,0,184,128Z\"></path></svg></a></p></div></div><div class=\"flex items-center gap-4\"><button class=\"group hidden items-center gap-1.5 md:flex\"><div class=\"relative\"><span class=\"text-foreground/70 group-hover:text-foreground text-xs font-light transition-colors\">Index your code with</span><div class=\"bg-foreground/30 absolute bottom-0 left-0 h-[1px] w-0 transition-all duration-300 group-hover:w-full\"></div></div><div class=\"flex items-center gap-1 transition-transform duration-300 group-hover:translate-x-0.5\"><svg class=\"size-4 transform transition-transform duration-700 group-hover:rotate-180 [&amp;_path]:stroke-0\" xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"110 110 460 500\"><path style=\"fill:#21c19a\" class=\"\" d=\"M418.73,332.37c9.84-5.68,22.07-5.68,31.91,0l25.49,14.71c.82.48,1.69.8,2.58,1.06.19.06.37.11.55.16.87.21,1.76.34,2.65.35.04,0,.08.02.13.02.1,0,.19-.03.29-.04.83-.02,1.64-.13,2.45-.32.14-.03.28-.05.42-.09.87-.24,1.7-.59,2.5-1.03.08-.04.17-.06.25-.1l50.97-29.43c3.65-2.11,5.9-6.01,5.9-10.22v-58.86c0-4.22-2.25-8.11-5.9-10.22l-50.97-29.43c-3.65-2.11-8.15-2.11-11.81,0l-50.97,29.43c-.08.04-.13.11-.2.16-.78.48-1.51,1.02-2.15,1.66-.1.1-.18.21-.28.31-.57.6-1.08,1.26-1.51,1.97-.07.12-.15.22-.22.34-.44.77-.77,1.6-1.03,2.47-.05.19-.1.37-.14.56-.22.89-.37,1.81-.37,2.76v29.43c0,11.36-6.11,21.95-15.95,27.63-9.84,5.68-22.06,5.68-31.91,0l-25.49-14.71c-.82-.48-1.69-.8-2.57-1.06-.19-.06-.37-.11-.56-.16-.88-.21-1.76-.34-2.65-.34-.13,0-.26.02-.4.02-.84.02-1.66.13-2.47.32-.13.03-.27.05-.4.09-.87.24-1.71.6-2.51,1.04-.08.04-.16.06-.24.1l-50.97,29.43c-3.65,2.11-5.9,6.01-5.9,10.22v58.86c0,4.22,2.25,8.11,5.9,10.22l50.97,29.43c.08.04.17.06.24.1.8.44,1.64.79,2.5,1.03.14.04.28.06.42.09.81.19,1.62.3,2.45.32.1,0,.19.04.29.04.04,0,.08-.02.13-.02.89,0,1.77-.13,2.65-.35.19-.04.37-.1.56-.16.88-.26,1.75-.59,2.58-1.06l25.49-14.71c9.84-5.68,22.06-5.68,31.91,0,9.84,5.68,15.95,16.27,15.95,27.63v29.43c0,.95.15,1.87.37,2.76.05.19.09.37.14.56.25.86.59,1.69,1.03,2.47.07.12.15.22.22.34.43.71.94,1.37,1.51,1.97.1.1.18.21.28.31.65.63,1.37,1.18,2.15,1.66.07.04.13.11.2.16l50.97,29.43c1.83,1.05,3.86,1.58,5.9,1.58s4.08-.53,5.9-1.58l50.97-29.43c3.65-2.11,5.9-6.01,5.9-10.22v-58.86c0-4.22-2.25-8.11-5.9-10.22l-50.97-29.43c-.08-.04-.16-.06-.24-.1-.8-.44-1.64-.8-2.51-1.04-.13-.04-.26-.05-.39-.09-.82-.2-1.65-.31-2.49-.33-.13,0-.25-.02-.38-.02-.89,0-1.78.13-2.66.35-.18.04-.36.1-.54.15-.88.26-1.75.59-2.58,1.07l-25.49,14.72c-9.84,5.68-22.07,5.68-31.9,0-9.84-5.68-15.95-16.27-15.95-27.63s6.11-21.95,15.95-27.63Z\"></path><path style=\"fill:#3969ca\" d=\"M141.09,317.65l50.97,29.43c1.83,1.05,3.86,1.58,5.9,1.58s4.08-.53,5.9-1.58l50.97-29.43c.08-.04.13-.11.2-.16.78-.48,1.51-1.02,2.15-1.66.1-.1.18-.21.28-.31.57-.6,1.08-1.26,1.51-1.97.07-.12.15-.22.22-.34.44-.77.77-1.6,1.03-2.47.05-.19.1-.37.14-.56.22-.89.37-1.81.37-2.76v-29.43c0-11.36,6.11-21.95,15.96-27.63s22.06-5.68,31.91,0l25.49,14.71c.82.48,1.69.8,2.57,1.06.19.06.37.11.56.16.87.21,1.76.34,2.64.35.04,0,.09.02.13.02.1,0,.19-.04.29-.04.83-.02,1.65-.13,2.45-.32.14-.03.28-.05.41-.09.87-.24,1.71-.6,2.51-1.04.08-.04.16-.06.24-.1l50.97-29.43c3.65-2.11,5.9-6.01,5.9-10.22v-58.86c0-4.22-2.25-8.11-5.9-10.22l-50.97-29.43c-3.65-2.11-8.15-2.11-11.81,0l-50.97,29.43c-.08.04-.13.11-.2.16-.78.48-1.51,1.02-2.15,1.66-.1.1-.18.21-.28.31-.57.6-1.08,1.26-1.51,1.97-.07.12-.15.22-.22.34-.44.77-.77,1.6-1.03,2.47-.05.19-.1.37-.14.56-.22.89-.37,1.81-.37,2.76v29.43c0,11.36-6.11,21.95-15.95,27.63-9.84,5.68-22.07,5.68-31.91,0l-25.49-14.71c-.82-.48-1.69-.8-2.58-1.06-.19-.06-.37-.11-.55-.16-.88-.21-1.76-.34-2.65-.35-.13,0-.26.02-.4.02-.83.02-1.66.13-2.47.32-.13.03-.27.05-.4.09-.87.24-1.71.6-2.51,1.04-.08.04-.16.06-.24.1l-50.97,29.43c-3.65,2.11-5.9,6.01-5.9,10.22v58.86c0,4.22,2.25,8.11,5.9,10.22Z\"></path><path style=\"fill:#0294de\" class=\"\" d=\"M396.88,484.35l-50.97-29.43c-.08-.04-.17-.06-.24-.1-.8-.44-1.64-.79-2.51-1.03-.14-.04-.27-.06-.41-.09-.81-.19-1.64-.3-2.47-.32-.13,0-.26-.02-.39-.02-.89,0-1.78.13-2.66.35-.18.04-.36.1-.54.15-.88.26-1.76.59-2.58,1.07l-25.49,14.72c-9.84,5.68-22.06,5.68-31.9,0-9.84-5.68-15.96-16.27-15.96-27.63v-29.43c0-.95-.15-1.87-.37-2.76-.05-.19-.09-.37-.14-.56-.25-.86-.59-1.69-1.03-2.47-.07-.12-.15-.22-.22-.34-.43-.71-.94-1.37-1.51-1.97-.1-.1-.18-.21-.28-.31-.65-.63-1.37-1.18-2.15-1.66-.07-.04-.13-.11-.2-.16l-50.97-29.43c-3.65-2.11-8.15-2.11-11.81,0l-50.97,29.43c-3.65,2.11-5.9,6.01-5.9,10.22v58.86c0,4.22,2.25,8.11,5.9,10.22l50.97,29.43c.08.04.17.06.25.1.8.44,1.63.79,2.5,1.03.14.04.29.06.43.09.8.19,1.61.3,2.43.32.1,0,.2.04.3.04.04,0,.09-.02.13-.02.88,0,1.77-.13,2.64-.34.19-.04.37-.1.56-.16.88-.26,1.75-.59,2.57-1.06l25.49-14.71c9.84-5.68,22.06-5.68,31.91,0,9.84,5.68,15.95,16.27,15.95,27.63v29.43c0,.95.15,1.87.37,2.76.05.19.09.37.14.56.25.86.59,1.69,1.03,2.47.07.12.15.22.22.34.43.71.94,1.37,1.51,1.97.1.1.18.21.28.31.65.63,1.37,1.18,2.15,1.66.07.04.13.11.2.16l50.97,29.43c1.83,1.05,3.86,1.58,5.9,1.58s4.08-.53,5.9-1.58l50.97-29.43c3.65-2.11,5.9-6.01,5.9-10.22v-58.86c0-4.22-2.25-8.11-5.9-10.22Z\"></path></svg><span class=\"text-sm font-medium\">Devin</span></div></button><button aria-label=\"Edit Wiki\" class=\"flex items-center rounded-md cursor-pointer transition-all border border-border bg-surface hover:border-border-hover hover:bg-component disabled:cursor-default disabled:opacity-50 disabled:hover:border-border disabled:hover:bg-surface gap-2 px-3 py-1.5 text-sm\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" fill=\"currentColor\" viewBox=\"0 0 256 256\"><path d=\"M227.32,73.37,182.63,28.69a16,16,0,0,0-22.63,0L36.69,152A15.86,15.86,0,0,0,32,163.31V208a16,16,0,0,0,16,16H216a8,8,0,0,0,0-16H115.32l112-112A16,16,0,0,0,227.32,73.37ZM92.69,208H48V163.31l88-88L180.69,120ZM192,108.69,147.32,64l24-24L216,84.69Z\"></path></svg>Edit Wiki</button><button class=\"flex items-center rounded-md !text-white cursor-pointer transition-all border bg-blue-500 hover:bg-blue-600 border-blue-500 hover:border-blue-600 dark:bg-blue-900 dark:hover:bg-blue-800 dark:border-blue-900 dark:hover:border-blue-800 disabled:cursor-default disabled:opacity-50 disabled:hover:bg-blue-500 disabled:hover:border-blue-500 dark:disabled:hover:bg-blue-900 dark:disabled:hover:border-blue-900 gap-1.5 px-3 py-1.5 text-sm\" aria-label=\"Share\" data-state=\"closed\" data-slot=\"tooltip-trigger\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"h-4 w-4\"><circle cx=\"18\" cy=\"5\" r=\"3\"></circle><circle cx=\"6\" cy=\"12\" r=\"3\"></circle><circle cx=\"18\" cy=\"19\" r=\"3\"></circle><line x1=\"8.59\" y1=\"13.51\" x2=\"15.42\" y2=\"17.49\"></line><line x1=\"15.41\" y1=\"6.51\" x2=\"8.59\" y2=\"10.49\"></line></svg><span>Share</span></button><button class=\"hover:bg-surface-hover flex h-8 w-8 cursor-pointer items-center justify-center rounded-md transition-colors\" aria-label=\"Switch to dark mode\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"1em\" height=\"1em\" fill=\"currentColor\" viewBox=\"0 0 256 256\" class=\"h-5 w-5 text-gray-700\"><path d=\"M235.54,150.21a104.84,104.84,0,0,1-37,52.91A104,104,0,0,1,32,120,103.09,103.09,0,0,1,52.88,57.48a104.84,104.84,0,0,1,52.91-37,8,8,0,0,1,10,10,88.08,88.08,0,0,0,109.8,109.8,8,8,0,0,1,10,10Z\"></path></svg></button></div></div></div></div><!--$--><script type=\"application/ld+json\">{\"@context\":\"https://schema.org\",\"@type\":\"TechArticle\",\"headline\":\"Overview\",\"description\":\"This page provides a high-level introduction to the trader system, explaining its purpose, architecture, and major components. For detailed information on specific subsystems, see: $1, $1, $1, $1, and\",\"image\":\"https://deepwiki.com/timercrack/trader/og-image.png\",\"datePublished\":\"2025-10-30T08:11:36.456527\",\"dateModified\":\"2025-10-30T08:11:36.456527\",\"author\":{\"@type\":\"Organization\",\"name\":\"DeepWiki\",\"url\":\"https://deepwiki.com\"},\"publisher\":{\"@type\":\"Organization\",\"name\":\"DeepWiki\",\"logo\":{\"@type\":\"ImageObject\",\"url\":\"https://deepwiki.com/icon.png\"}},\"mainEntityOfPage\":{\"@type\":\"WebPage\",\"@id\":\"https://deepwiki.com/timercrack/trader\"}}</script><div class=\"w-full flex-1\"><div class=\"container-wrapper relative mx-auto h-full px-0\"><div class=\"container relative mx-auto flex h-full w-full flex-col gap-0 max-md:!px-0 md:flex-row md:gap-6 lg:gap-10\"><div class=\"border-r-border hidden max-h-screen border-r border-dashed py-6 pr-4 transition-[border-radius] md:sticky md:left-0 md:top-20 md:block md:h-[calc(100vh-82px)] md:w-64 md:flex-shrink-0 md:overflow-y-auto lg:py-9 xl:w-72\"><div class=\"flex h-full w-full max-w-full flex-shrink-0 flex-col overflow-hidden\" style=\"scrollbar-color:var(--color-border) transparent\"><div class=\"flex-shrink-0 px-2\"><div class=\"text-secondary pb-1 text-xs\">Last indexed: <!-- -->30 October 2025<!-- --> (<a href=\"https://github.com/timercrack/trader/commits/3307c308\" target=\"_blank\" rel=\"noopener noreferrer\" class=\"underline-offset-2 hover:underline\">3307c3</a>)</div></div><ul class=\"flex-1 flex-shrink-0 space-y-1 overflow-y-auto py-1\" style=\"scrollbar-width:none\"><li style=\"padding-left:0\"><a data-selected=\"true\" class=\"hover:bg-hover block w-full rounded px-2 py-1.5 text-left text-sm transition-none text-secondary data-[selected=true]:bg-hover data-[selected=true]:text-primary font-normal data-[selected=true]:font-normal\" href=\"/timercrack/trader/1-overview\">Overview</a></li><li style=\"padding-left:0\"><a data-selected=\"false\" class=\"hover:bg-hover block w-full rounded px-2 py-1.5 text-left text-sm transition-none text-secondary data-[selected=true]:bg-hover data-[selected=true]:text-primary font-normal data-[selected=true]:font-normal\" href=\"/timercrack/trader/2-getting-started\">Getting Started</a></li><li style=\"padding-left:12px\"><a data-selected=\"false\" class=\"hover:bg-hover block w-full rounded px-2 py-1.5 text-left text-sm transition-none text-secondary data-[selected=true]:bg-hover data-[selected=true]:text-primary font-normal data-[selected=true]:font-normal\" href=\"/timercrack/trader/2.1-installation\">Installation</a></li><li style=\"padding-left:12px\"><a data-selected=\"false\" class=\"hover:bg-hover block w-full rounded px-2 py-1.5 text-left text-sm transition-none text-secondary data-[selected=true]:bg-hover data-[selected=true]:text-primary font-normal data-[selected=true]:font-normal\" href=\"/timercrack/trader/2.2-configuration\">Configuration</a></li><li style=\"padding-left:12px\"><a data-selected=\"false\" class=\"hover:bg-hover block w-full rounded px-2 py-1.5 text-left text-sm transition-none text-secondary data-[selected=true]:bg-hover data-[selected=true]:text-primary font-normal data-[selected=true]:font-normal\" href=\"/timercrack/trader/2.3-running-the-system\">Running the System</a></li><li style=\"padding-left:0\"><a data-selected=\"false\" class=\"hover:bg-hover block w-full rounded px-2 py-1.5 text-left text-sm transition-none text-secondary data-[selected=true]:bg-hover data-[selected=true]:text-primary font-normal data-[selected=true]:font-normal\" href=\"/timercrack/trader/3-architecture\">Architecture</a></li><li style=\"padding-left:12px\"><a data-selected=\"false\" class=\"hover:bg-hover block w-full rounded px-2 py-1.5 text-left text-sm transition-none text-secondary data-[selected=true]:bg-hover data-[selected=true]:text-primary font-normal data-[selected=true]:font-normal\" href=\"/timercrack/trader/3.1-system-components\">System Components</a></li><li style=\"padding-left:12px\"><a data-selected=\"false\" class=\"hover:bg-hover block w-full rounded px-2 py-1.5 text-left text-sm transition-none text-secondary data-[selected=true]:bg-hover data-[selected=true]:text-primary font-normal data-[selected=true]:font-normal\" href=\"/timercrack/trader/3.2-data-flow-pipeline\">Data Flow Pipeline</a></li><li style=\"padding-left:12px\"><a data-selected=\"false\" class=\"hover:bg-hover block w-full rounded px-2 py-1.5 text-left text-sm transition-none text-secondary data-[selected=true]:bg-hover data-[selected=true]:text-primary font-normal data-[selected=true]:font-normal\" href=\"/timercrack/trader/3.3-message-bus-and-communication\">Message Bus and Communication</a></li><li style=\"padding-left:0\"><a data-selected=\"false\" class=\"hover:bg-hover block w-full rounded px-2 py-1.5 text-left text-sm transition-none text-secondary data-[selected=true]:bg-hover data-[selected=true]:text-primary font-normal data-[selected=true]:font-normal\" href=\"/timercrack/trader/4-trading-strategy-system\">Trading Strategy System</a></li><li style=\"padding-left:12px\"><a data-selected=\"false\" class=\"hover:bg-hover block w-full rounded px-2 py-1.5 text-left text-sm transition-none text-secondary data-[selected=true]:bg-hover data-[selected=true]:text-primary font-normal data-[selected=true]:font-normal\" href=\"/timercrack/trader/4.1-tradestrategy-class\">TradeStrategy Class</a></li><li style=\"padding-left:12px\"><a data-selected=\"false\" class=\"hover:bg-hover block w-full rounded px-2 py-1.5 text-left text-sm transition-none text-secondary data-[selected=true]:bg-hover data-[selected=true]:text-primary font-normal data-[selected=true]:font-normal\" href=\"/timercrack/trader/4.2-basemodule-framework\">BaseModule Framework</a></li><li style=\"padding-left:12px\"><a data-selected=\"false\" class=\"hover:bg-hover block w-full rounded px-2 py-1.5 text-left text-sm transition-none text-secondary data-[selected=true]:bg-hover data-[selected=true]:text-primary font-normal data-[selected=true]:font-normal\" href=\"/timercrack/trader/4.3-signal-generation\">Signal Generation</a></li><li style=\"padding-left:12px\"><a data-selected=\"false\" class=\"hover:bg-hover block w-full rounded px-2 py-1.5 text-left text-sm transition-none text-secondary data-[selected=true]:bg-hover data-[selected=true]:text-primary font-normal data-[selected=true]:font-normal\" href=\"/timercrack/trader/4.4-order-execution-flow\">Order Execution Flow</a></li><li style=\"padding-left:12px\"><a data-selected=\"false\" class=\"hover:bg-hover block w-full rounded px-2 py-1.5 text-left text-sm transition-none text-secondary data-[selected=true]:bg-hover data-[selected=true]:text-primary font-normal data-[selected=true]:font-normal\" href=\"/timercrack/trader/4.5-risk-management\">Risk Management</a></li><li style=\"padding-left:12px\"><a data-selected=\"false\" class=\"hover:bg-hover block w-full rounded px-2 py-1.5 text-left text-sm transition-none text-secondary data-[selected=true]:bg-hover data-[selected=true]:text-primary font-normal data-[selected=true]:font-normal\" href=\"/timercrack/trader/4.6-scheduled-tasks\">Scheduled Tasks</a></li><li style=\"padding-left:0\"><a data-selected=\"false\" class=\"hover:bg-hover block w-full rounded px-2 py-1.5 text-left text-sm transition-none text-secondary data-[selected=true]:bg-hover data-[selected=true]:text-primary font-normal data-[selected=true]:font-normal\" href=\"/timercrack/trader/5-data-management\">Data Management</a></li><li style=\"padding-left:12px\"><a data-selected=\"false\" class=\"hover:bg-hover block w-full rounded px-2 py-1.5 text-left text-sm transition-none text-secondary data-[selected=true]:bg-hover data-[selected=true]:text-primary font-normal data-[selected=true]:font-normal\" href=\"/timercrack/trader/5.1-data-models\">Data Models</a></li><li style=\"padding-left:12px\"><a data-selected=\"false\" class=\"hover:bg-hover block w-full rounded px-2 py-1.5 text-left text-sm transition-none text-secondary data-[selected=true]:bg-hover data-[selected=true]:text-primary font-normal data-[selected=true]:font-normal\" href=\"/timercrack/trader/5.2-exchange-data-acquisition\">Exchange Data Acquisition</a></li><li style=\"padding-left:12px\"><a data-selected=\"false\" class=\"hover:bg-hover block w-full rounded px-2 py-1.5 text-left text-sm transition-none text-secondary data-[selected=true]:bg-hover data-[selected=true]:text-primary font-normal data-[selected=true]:font-normal\" href=\"/timercrack/trader/5.3-main-contract-calculation\">Main Contract Calculation</a></li><li style=\"padding-left:12px\"><a data-selected=\"false\" class=\"hover:bg-hover block w-full rounded px-2 py-1.5 text-left text-sm transition-none text-secondary data-[selected=true]:bg-hover data-[selected=true]:text-primary font-normal data-[selected=true]:font-normal\" href=\"/timercrack/trader/5.4-technical-analysis\">Technical Analysis</a></li><li style=\"padding-left:12px\"><a data-selected=\"false\" class=\"hover:bg-hover block w-full rounded px-2 py-1.5 text-left text-sm transition-none text-secondary data-[selected=true]:bg-hover data-[selected=true]:text-primary font-normal data-[selected=true]:font-normal\" href=\"/timercrack/trader/5.5-historical-signal-calculation\">Historical Signal Calculation</a></li><li style=\"padding-left:0\"><a data-selected=\"false\" class=\"hover:bg-hover block w-full rounded px-2 py-1.5 text-left text-sm transition-none text-secondary data-[selected=true]:bg-hover data-[selected=true]:text-primary font-normal data-[selected=true]:font-normal\" href=\"/timercrack/trader/6-ctp-api-integration\">CTP API Integration</a></li><li style=\"padding-left:12px\"><a data-selected=\"false\" class=\"hover:bg-hover block w-full rounded px-2 py-1.5 text-left text-sm transition-none text-secondary data-[selected=true]:bg-hover data-[selected=true]:text-primary font-normal data-[selected=true]:font-normal\" href=\"/timercrack/trader/6.1-request-response-patterns\">Request-Response Patterns</a></li><li style=\"padding-left:12px\"><a data-selected=\"false\" class=\"hover:bg-hover block w-full rounded px-2 py-1.5 text-left text-sm transition-none text-secondary data-[selected=true]:bg-hover data-[selected=true]:text-primary font-normal data-[selected=true]:font-normal\" href=\"/timercrack/trader/6.2-order-management\">Order Management</a></li><li style=\"padding-left:12px\"><a data-selected=\"false\" class=\"hover:bg-hover block w-full rounded px-2 py-1.5 text-left text-sm transition-none text-secondary data-[selected=true]:bg-hover data-[selected=true]:text-primary font-normal data-[selected=true]:font-normal\" href=\"/timercrack/trader/6.3-market-data-handling\">Market Data Handling</a></li><li style=\"padding-left:12px\"><a data-selected=\"false\" class=\"hover:bg-hover block w-full rounded px-2 py-1.5 text-left text-sm transition-none text-secondary data-[selected=true]:bg-hover data-[selected=true]:text-primary font-normal data-[selected=true]:font-normal\" href=\"/timercrack/trader/6.4-error-codes-and-handling\">Error Codes and Handling</a></li><li style=\"padding-left:0\"><a data-selected=\"false\" class=\"hover:bg-hover block w-full rounded px-2 py-1.5 text-left text-sm transition-none text-secondary data-[selected=true]:bg-hover data-[selected=true]:text-primary font-normal data-[selected=true]:font-normal\" href=\"/timercrack/trader/7-configuration-reference\">Configuration Reference</a></li><li style=\"padding-left:12px\"><a data-selected=\"false\" class=\"hover:bg-hover block w-full rounded px-2 py-1.5 text-left text-sm transition-none text-secondary data-[selected=true]:bg-hover data-[selected=true]:text-primary font-normal data-[selected=true]:font-normal\" href=\"/timercrack/trader/7.1-configuration-file-format\">Configuration File Format</a></li><li style=\"padding-left:12px\"><a data-selected=\"false\" class=\"hover:bg-hover block w-full rounded px-2 py-1.5 text-left text-sm transition-none text-secondary data-[selected=true]:bg-hover data-[selected=true]:text-primary font-normal data-[selected=true]:font-normal\" href=\"/timercrack/trader/7.2-constants-and-enumerations\">Constants and Enumerations</a></li><li style=\"padding-left:0\"><a data-selected=\"false\" class=\"hover:bg-hover block w-full rounded px-2 py-1.5 text-left text-sm transition-none text-secondary data-[selected=true]:bg-hover data-[selected=true]:text-primary font-normal data-[selected=true]:font-normal\" href=\"/timercrack/trader/8-development-guide\">Development Guide</a></li><li style=\"padding-left:12px\"><a data-selected=\"false\" class=\"hover:bg-hover block w-full rounded px-2 py-1.5 text-left text-sm transition-none text-secondary data-[selected=true]:bg-hover data-[selected=true]:text-primary font-normal data-[selected=true]:font-normal\" href=\"/timercrack/trader/8.1-testing\">Testing</a></li><li style=\"padding-left:12px\"><a data-selected=\"false\" class=\"hover:bg-hover block w-full rounded px-2 py-1.5 text-left text-sm transition-none text-secondary data-[selected=true]:bg-hover data-[selected=true]:text-primary font-normal data-[selected=true]:font-normal\" href=\"/timercrack/trader/8.2-callback-system\">Callback System</a></li><li style=\"padding-left:12px\"><a data-selected=\"false\" class=\"hover:bg-hover block w-full rounded px-2 py-1.5 text-left text-sm transition-none text-secondary data-[selected=true]:bg-hover data-[selected=true]:text-primary font-normal data-[selected=true]:font-normal\" href=\"/timercrack/trader/8.3-creating-custom-strategies\">Creating Custom Strategies</a></li><li style=\"padding-left:12px\"><a data-selected=\"false\" class=\"hover:bg-hover block w-full rounded px-2 py-1.5 text-left text-sm transition-none text-secondary data-[selected=true]:bg-hover data-[selected=true]:text-primary font-normal data-[selected=true]:font-normal\" href=\"/timercrack/trader/8.4-logging-and-monitoring\">Logging and Monitoring</a></li><li style=\"padding-left:0\"><a data-selected=\"false\" class=\"hover:bg-hover block w-full rounded px-2 py-1.5 text-left text-sm transition-none text-secondary data-[selected=true]:bg-hover data-[selected=true]:text-primary font-normal data-[selected=true]:font-normal\" href=\"/timercrack/trader/9-deployment\">Deployment</a></li><li style=\"padding-left:0\"><a data-selected=\"false\" class=\"hover:bg-hover block w-full rounded px-2 py-1.5 text-left text-sm transition-none text-secondary data-[selected=true]:bg-hover data-[selected=true]:text-primary font-normal data-[selected=true]:font-normal\" href=\"/timercrack/trader/10-api-reference\">API Reference</a></li><li style=\"padding-left:12px\"><a data-selected=\"false\" class=\"hover:bg-hover block w-full rounded px-2 py-1.5 text-left text-sm transition-none text-secondary data-[selected=true]:bg-hover data-[selected=true]:text-primary font-normal data-[selected=true]:font-normal\" href=\"/timercrack/trader/10.1-tradestrategy-api\">TradeStrategy API</a></li><li style=\"padding-left:12px\"><a data-selected=\"false\" class=\"hover:bg-hover block w-full rounded px-2 py-1.5 text-left text-sm transition-none text-secondary data-[selected=true]:bg-hover data-[selected=true]:text-primary font-normal data-[selected=true]:font-normal\" href=\"/timercrack/trader/10.2-basemodule-api\">BaseModule API</a></li><li style=\"padding-left:12px\"><a data-selected=\"false\" class=\"hover:bg-hover block w-full rounded px-2 py-1.5 text-left text-sm transition-none text-secondary data-[selected=true]:bg-hover data-[selected=true]:text-primary font-normal data-[selected=true]:font-normal\" href=\"/timercrack/trader/10.3-data-utilities-api\">Data Utilities API</a></li><li style=\"padding-left:12px\"><a data-selected=\"false\" class=\"hover:bg-hover block w-full rounded px-2 py-1.5 text-left text-sm transition-none text-secondary data-[selected=true]:bg-hover data-[selected=true]:text-primary font-normal data-[selected=true]:font-normal\" href=\"/timercrack/trader/10.4-django-models-api\">Django Models API</a></li><li style=\"padding-left:0\"><a data-selected=\"false\" class=\"hover:bg-hover block w-full rounded px-2 py-1.5 text-left text-sm transition-none text-secondary data-[selected=true]:bg-hover data-[selected=true]:text-primary font-normal data-[selected=true]:font-normal\" href=\"/timercrack/trader/11-troubleshooting\">Troubleshooting</a></li><li style=\"padding-left:0\"><a data-selected=\"false\" class=\"hover:bg-hover block w-full rounded px-2 py-1.5 text-left text-sm transition-none text-secondary data-[selected=true]:bg-hover data-[selected=true]:text-primary font-normal data-[selected=true]:font-normal\" href=\"/timercrack/trader/12-appendix\">Appendix</a></li></ul></div></div><div class=\"flex h-full flex-1 flex-col overflow-hidden\"><div class=\"bg-background border-b-border sticky top-0 z-10 border-b border-dashed md:hidden\"><div class=\"flex cursor-pointer items-center gap-2 p-3\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"16\" height=\"16\" fill=\"currentColor\" viewBox=\"0 0 256 256\" class=\"transition-transform\"><path d=\"M184.49,136.49l-80,80a12,12,0,0,1-17-17L159,128,87.51,56.49a12,12,0,1,1,17-17l80,80A12,12,0,0,1,184.49,136.49Z\"></path></svg><span class=\"truncate text-base font-normal\">Menu</span></div></div><div class=\"relative flex-1 overflow-y-auto px-3 pt-3 md:rounded-md md:px-0 md:pt-0 [&amp;_::selection]:bg-purple-500/40\" style=\"scrollbar-color:var(--color-night) transparent\"><div class=\"pb-30 mx-auto max-w-2xl md:pb-40 md:pt-6 lg:pt-8\"><div class=\"prose prose-invert dark:prose-invert prose-headings:text-inherit prose-p:text-inherit max-w-none\"><div><div class=\"prose-custom prose-custom-md prose-custom-gray !max-w-none text-neutral-300 [overflow-wrap:anywhere]\"><h1 id=\"overview\" class=\"group\" data-header=\"true\">Overview<button class=\"relative ml-2 cursor-pointer align-baseline text-gray-400 opacity-0 transition-opacity hover:text-blue-400 focus:opacity-100 group-hover:opacity-100\" aria-label=\"Copy link to header\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"1em\" height=\"1em\" fill=\"currentColor\" viewBox=\"0 0 256 256\" class=\"h-4 w-4\"><path d=\"M117.18,188.74a12,12,0,0,1,0,17l-5.12,5.12A58.26,58.26,0,0,1,70.6,228h0A58.62,58.62,0,0,1,29.14,127.92L63.89,93.17a58.64,58.64,0,0,1,98.56,28.11,12,12,0,1,1-23.37,5.44,34.65,34.65,0,0,0-58.22-16.58L46.11,144.89A34.62,34.62,0,0,0,70.57,204h0a34.41,34.41,0,0,0,24.49-10.14l5.11-5.12A12,12,0,0,1,117.18,188.74ZM226.83,45.17a58.65,58.65,0,0,0-82.93,0l-5.11,5.11a12,12,0,0,0,17,17l5.12-5.12a34.63,34.63,0,1,1,49,49L175.1,145.86A34.39,34.39,0,0,1,150.61,156h0a34.63,34.63,0,0,1-33.69-26.72,12,12,0,0,0-23.38,5.44A58.64,58.64,0,0,0,150.56,180h.05a58.28,58.28,0,0,0,41.47-17.17l34.75-34.75a58.62,58.62,0,0,0,0-82.91Z\"></path></svg></button></h1>\n<details>\n<summary>Relevant source files</summary>\n<ul>\n<li><a href=\"https://github.com/timercrack/trader/blob/3307c308/README.rst\" target=\"_blank\" rel=\"noopener noreferrer\" class=\"mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75\"><span class=\"flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4] rounded-r\"><svg class=\"mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block\" fill=\"currentColor\" viewBox=\"0 0 24 24\"><path d=\"M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z\"></path></svg>README.rst</span></a></li>\n<li><a href=\"https://github.com/timercrack/trader/blob/3307c308/panel/models.py\" target=\"_blank\" rel=\"noopener noreferrer\" class=\"mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75\"><span class=\"flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4] rounded-r\"><svg class=\"mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block\" fill=\"currentColor\" viewBox=\"0 0 24 24\"><path d=\"M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z\"></path></svg>panel/models.py</span></a></li>\n<li><a href=\"https://github.com/timercrack/trader/blob/3307c308/trader/strategy/brother2.py\" target=\"_blank\" rel=\"noopener noreferrer\" class=\"mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75\"><span class=\"flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4] rounded-r\"><svg class=\"mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block\" fill=\"currentColor\" viewBox=\"0 0 24 24\"><path d=\"M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z\"></path></svg>trader/strategy/brother2.py</span></a></li>\n<li><a href=\"https://github.com/timercrack/trader/blob/3307c308/trader/utils/__init__.py\" target=\"_blank\" rel=\"noopener noreferrer\" class=\"mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75\"><span class=\"flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4] rounded-r\"><svg class=\"mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block\" fill=\"currentColor\" viewBox=\"0 0 24 24\"><path d=\"M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z\"></path></svg>trader/utils/__init__.py</span></a></li>\n</ul>\n</details>\n<p>This page provides a high-level introduction to the trader system, explaining its purpose, architecture, and major components. For detailed information on specific subsystems, see: <a href=\"/timercrack/trader/2-getting-started\" class=\"text-neutral-300 hover:text-neutral-200 hover:underline\">Getting Started</a>, <a href=\"/timercrack/trader/3-architecture\" class=\"text-neutral-300 hover:text-neutral-200 hover:underline\">Architecture</a>, <a href=\"/timercrack/trader/4-trading-strategy-system\" class=\"text-neutral-300 hover:text-neutral-200 hover:underline\">Trading Strategy System</a>, <a href=\"/timercrack/trader/5-data-management\" class=\"text-neutral-300 hover:text-neutral-200 hover:underline\">Data Management</a>, and <a href=\"/timercrack/trader/6-ctp-api-integration\" class=\"text-neutral-300 hover:text-neutral-200 hover:underline\">CTP API Integration</a>.</p>\n<h2 id=\"purpose-and-scope\" class=\"group\" data-header=\"true\">Purpose and Scope<button class=\"relative ml-2 cursor-pointer align-baseline text-gray-400 opacity-0 transition-opacity hover:text-blue-400 focus:opacity-100 group-hover:opacity-100\" aria-label=\"Copy link to header\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"1em\" height=\"1em\" fill=\"currentColor\" viewBox=\"0 0 256 256\" class=\"h-4 w-4\"><path d=\"M117.18,188.74a12,12,0,0,1,0,17l-5.12,5.12A58.26,58.26,0,0,1,70.6,228h0A58.62,58.62,0,0,1,29.14,127.92L63.89,93.17a58.64,58.64,0,0,1,98.56,28.11,12,12,0,1,1-23.37,5.44,34.65,34.65,0,0,0-58.22-16.58L46.11,144.89A34.62,34.62,0,0,0,70.57,204h0a34.41,34.41,0,0,0,24.49-10.14l5.11-5.12A12,12,0,0,1,117.18,188.74ZM226.83,45.17a58.65,58.65,0,0,0-82.93,0l-5.11,5.11a12,12,0,0,0,17,17l5.12-5.12a34.63,34.63,0,1,1,49,49L175.1,145.86A34.39,34.39,0,0,1,150.61,156h0a34.63,34.63,0,0,1-33.69-26.72,12,12,0,0,0-23.38,5.44A58.64,58.64,0,0,0,150.56,180h.05a58.28,58.28,0,0,0,41.47-17.17l34.75-34.75a58.62,58.62,0,0,0,0-82.91Z\"></path></svg></button></h2>\n<p>The trader system is an automated futures trading platform designed for Chinese commodity exchanges. It provides a complete solution for:</p>\n<ul>\n<li><strong>Market Data Acquisition</strong>: Daily data fetching from five Chinese exchanges (SHFE, DCE, CZCE, CFFEX, GFEX)</li>\n<li><strong>Signal Generation</strong>: Technical analysis-based trading signals using ATR, SMA, and breakout detection</li>\n<li><strong>Order Execution</strong>: Automated order placement through the CTP (China Futures Trading Platform) API</li>\n<li><strong>Position Management</strong>: Real-time tracking of positions, P&amp;L, and risk metrics</li>\n<li><strong>Performance Analytics</strong>: Daily NAV calculation and equity curve tracking</li>\n</ul>\n<p>The system operates entirely in Python using Django for data persistence and Redis for asynchronous message-based communication with the CTP trading API.</p>\n<p><strong>Sources</strong>: <a href=\"https://github.com/timercrack/trader/blob/3307c308/trader/strategy/brother2.py#L1-L40\" target=\"_blank\" rel=\"noopener noreferrer\" class=\"mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75\"><span class=\"flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4]\"><svg class=\"mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block\" fill=\"currentColor\" viewBox=\"0 0 24 24\"><path d=\"M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z\"></path></svg>trader/strategy/brother2.py</span><span class=\"flex flex-shrink-0 items-center rounded-r border-l px-2 py-1.5 border-[#dddddd] bg-[#d8d8d8] text-[#666666] dark:border-[#333333] dark:bg-[#2a2a2a] dark:text-[#888888]\">1-40</span></a> <a href=\"https://github.com/timercrack/trader/blob/3307c308/README.rst#L1-L26\" target=\"_blank\" rel=\"noopener noreferrer\" class=\"mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75\"><span class=\"flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4]\"><svg class=\"mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block\" fill=\"currentColor\" viewBox=\"0 0 24 24\"><path d=\"M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z\"></path></svg>README.rst</span><span class=\"flex flex-shrink-0 items-center rounded-r border-l px-2 py-1.5 border-[#dddddd] bg-[#d8d8d8] text-[#666666] dark:border-[#333333] dark:bg-[#2a2a2a] dark:text-[#888888]\">1-26</span></a></p>\n<h2 id=\"system-architecture\" class=\"group\" data-header=\"true\">System Architecture<button class=\"relative ml-2 cursor-pointer align-baseline text-gray-400 opacity-0 transition-opacity hover:text-blue-400 focus:opacity-100 group-hover:opacity-100\" aria-label=\"Copy link to header\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"1em\" height=\"1em\" fill=\"currentColor\" viewBox=\"0 0 256 256\" class=\"h-4 w-4\"><path d=\"M117.18,188.74a12,12,0,0,1,0,17l-5.12,5.12A58.26,58.26,0,0,1,70.6,228h0A58.62,58.62,0,0,1,29.14,127.92L63.89,93.17a58.64,58.64,0,0,1,98.56,28.11,12,12,0,1,1-23.37,5.44,34.65,34.65,0,0,0-58.22-16.58L46.11,144.89A34.62,34.62,0,0,0,70.57,204h0a34.41,34.41,0,0,0,24.49-10.14l5.11-5.12A12,12,0,0,1,117.18,188.74ZM226.83,45.17a58.65,58.65,0,0,0-82.93,0l-5.11,5.11a12,12,0,0,0,17,17l5.12-5.12a34.63,34.63,0,1,1,49,49L175.1,145.86A34.39,34.39,0,0,1,150.61,156h0a34.63,34.63,0,0,1-33.69-26.72,12,12,0,0,0-23.38,5.44A58.64,58.64,0,0,0,150.56,180h.05a58.28,58.28,0,0,0,41.47-17.17l34.75-34.75a58.62,58.62,0,0,0,0-82.91Z\"></path></svg></button></h2>\n<p>The trader system follows a message-driven architecture with clear separation between data acquisition, strategy execution, and order management. The core design uses Redis Pub/Sub as a message bus to decouple trading logic from the CTP API.</p>\n<h3 id=\"high-level-component-architecture\" class=\"group\" data-header=\"true\">High-Level Component Architecture<button class=\"relative ml-2 cursor-pointer align-baseline text-gray-400 opacity-0 transition-opacity hover:text-blue-400 focus:opacity-100 group-hover:opacity-100\" aria-label=\"Copy link to header\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"1em\" height=\"1em\" fill=\"currentColor\" viewBox=\"0 0 256 256\" class=\"h-4 w-4\"><path d=\"M117.18,188.74a12,12,0,0,1,0,17l-5.12,5.12A58.26,58.26,0,0,1,70.6,228h0A58.62,58.62,0,0,1,29.14,127.92L63.89,93.17a58.64,58.64,0,0,1,98.56,28.11,12,12,0,1,1-23.37,5.44,34.65,34.65,0,0,0-58.22-16.58L46.11,144.89A34.62,34.62,0,0,0,70.57,204h0a34.41,34.41,0,0,0,24.49-10.14l5.11-5.12A12,12,0,0,1,117.18,188.74ZM226.83,45.17a58.65,58.65,0,0,0-82.93,0l-5.11,5.11a12,12,0,0,0,17,17l5.12-5.12a34.63,34.63,0,1,1,49,49L175.1,145.86A34.39,34.39,0,0,1,150.61,156h0a34.63,34.63,0,0,1-33.69-26.72,12,12,0,0,0-23.38,5.44A58.64,58.64,0,0,0,150.56,180h.05a58.28,58.28,0,0,0,41.47-17.17l34.75-34.75a58.62,58.62,0,0,0,0-82.91Z\"></path></svg></button></h3>\n<pre class=\"px-2 py-1.5 has-[code]:rounded-md has-[code]:!bg-[#e5e5e5] has-[div]:bg-transparent has-[div]:!p-0 has-[code]:text-stone-900 dark:has-[code]:!bg-[#242424] has-[code]:dark:text-white [&amp;_code]:block [&amp;_code]:border-none [&amp;_code]:bg-transparent [&amp;_code]:p-0\"><div class=\"group relative cursor-pointer overflow-x-auto rounded-md bg-[#f2f1f0] p-4 transition-colors hover:bg-[#ededed] dark:bg-[#1f1f1f] dark:hover:bg-[#242424]\" type=\"button\" aria-haspopup=\"dialog\" aria-expanded=\"false\" aria-controls=\"radix-_r_3_\" data-state=\"closed\" data-slot=\"dialog-trigger\"><div class=\"flex max-h-[70vh] justify-center\"><svg id=\"mermaid-mr6a3apr9ik\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" class=\"flowchart\" style=\"max-width: 100%; touch-action: none; user-select: none; cursor: grab; min-height: fit-content; max-height: 100%;\" viewBox=\"-0.002963393624042965 0 1003.6895205372481 1046\" role=\"graphics-document document\" aria-roledescription=\"flowchart-v2\" preserveAspectRatio=\"xMidYMid meet\"><style>#mermaid-mr6a3apr9ik{font-family:ui-sans-serif,-apple-system,system-ui,Segoe UI,Helvetica;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#mermaid-mr6a3apr9ik .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#mermaid-mr6a3apr9ik .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#mermaid-mr6a3apr9ik .error-icon{fill:#dddddd;}#mermaid-mr6a3apr9ik .error-text{fill:#222222;stroke:#222222;}#mermaid-mr6a3apr9ik .edge-thickness-normal{stroke-width:1px;}#mermaid-mr6a3apr9ik .edge-thickness-thick{stroke-width:3.5px;}#mermaid-mr6a3apr9ik .edge-pattern-solid{stroke-dasharray:0;}#mermaid-mr6a3apr9ik .edge-thickness-invisible{stroke-width:0;fill:none;}#mermaid-mr6a3apr9ik .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-mr6a3apr9ik .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-mr6a3apr9ik .marker{fill:#999;stroke:#999;}#mermaid-mr6a3apr9ik .marker.cross{stroke:#999;}#mermaid-mr6a3apr9ik svg{font-family:ui-sans-serif,-apple-system,system-ui,Segoe UI,Helvetica;font-size:16px;}#mermaid-mr6a3apr9ik p{margin:0;}#mermaid-mr6a3apr9ik .label{font-family:ui-sans-serif,-apple-system,system-ui,Segoe UI,Helvetica;color:#333;}#mermaid-mr6a3apr9ik .cluster-label text{fill:#444;}#mermaid-mr6a3apr9ik .cluster-label span{color:#444;}#mermaid-mr6a3apr9ik .cluster-label span p{background-color:transparent;}#mermaid-mr6a3apr9ik .label text,#mermaid-mr6a3apr9ik span{fill:#333;color:#333;}#mermaid-mr6a3apr9ik .node rect,#mermaid-mr6a3apr9ik .node circle,#mermaid-mr6a3apr9ik .node ellipse,#mermaid-mr6a3apr9ik .node polygon,#mermaid-mr6a3apr9ik .node path{fill:#ffffff;stroke:#dddddd;stroke-width:1px;}#mermaid-mr6a3apr9ik .rough-node .label text,#mermaid-mr6a3apr9ik .node .label text,#mermaid-mr6a3apr9ik .image-shape .label,#mermaid-mr6a3apr9ik .icon-shape .label{text-anchor:middle;}#mermaid-mr6a3apr9ik .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#mermaid-mr6a3apr9ik .rough-node .label,#mermaid-mr6a3apr9ik .node .label,#mermaid-mr6a3apr9ik .image-shape .label,#mermaid-mr6a3apr9ik .icon-shape .label{text-align:center;}#mermaid-mr6a3apr9ik .node.clickable{cursor:pointer;}#mermaid-mr6a3apr9ik .root .anchor path{fill:#999!important;stroke-width:0;stroke:#999;}#mermaid-mr6a3apr9ik .arrowheadPath{fill:#0b0b0b;}#mermaid-mr6a3apr9ik .edgePath .path{stroke:#999;stroke-width:2.0px;}#mermaid-mr6a3apr9ik .flowchart-link{stroke:#999;fill:none;}#mermaid-mr6a3apr9ik .edgeLabel{background-color:#ffffff;text-align:center;}#mermaid-mr6a3apr9ik .edgeLabel p{background-color:#ffffff;}#mermaid-mr6a3apr9ik .edgeLabel rect{opacity:0.5;background-color:#ffffff;fill:#ffffff;}#mermaid-mr6a3apr9ik .labelBkg{background-color:rgba(255, 255, 255, 0.5);}#mermaid-mr6a3apr9ik .cluster rect{fill:#f8f8f8;stroke:#dddddd;stroke-width:1px;}#mermaid-mr6a3apr9ik .cluster text{fill:#444;}#mermaid-mr6a3apr9ik .cluster span{color:#444;}#mermaid-mr6a3apr9ik div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:ui-sans-serif,-apple-system,system-ui,Segoe UI,Helvetica;font-size:12px;background:#dddddd;border:1px solid hsl(0, 0%, 76.6666666667%);border-radius:2px;pointer-events:none;z-index:100;}#mermaid-mr6a3apr9ik .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#mermaid-mr6a3apr9ik rect.text{fill:none;stroke-width:0;}#mermaid-mr6a3apr9ik .icon-shape,#mermaid-mr6a3apr9ik .image-shape{background-color:#ffffff;text-align:center;}#mermaid-mr6a3apr9ik .icon-shape p,#mermaid-mr6a3apr9ik .image-shape p{background-color:#ffffff;padding:2px;}#mermaid-mr6a3apr9ik .icon-shape rect,#mermaid-mr6a3apr9ik .image-shape rect{opacity:0.5;background-color:#ffffff;fill:#ffffff;}#mermaid-mr6a3apr9ik .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#mermaid-mr6a3apr9ik .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#mermaid-mr6a3apr9ik :root{--mermaid-font-family:\"trebuchet ms\",verdana,arial,sans-serif;}</style><g><marker id=\"mermaid-mr6a3apr9ik_flowchart-v2-pointEnd\" class=\"marker flowchart-v2\" viewBox=\"0 0 10 10\" refX=\"5\" refY=\"5\" markerUnits=\"userSpaceOnUse\" markerWidth=\"8\" markerHeight=\"8\" orient=\"auto\"><path d=\"M 0 0 L 10 5 L 0 10 z\" class=\"arrowMarkerPath\" style=\"stroke-width: 1; stroke-dasharray: 1, 0;\"></path></marker><marker id=\"mermaid-mr6a3apr9ik_flowchart-v2-pointStart\" class=\"marker flowchart-v2\" viewBox=\"0 0 10 10\" refX=\"4.5\" refY=\"5\" markerUnits=\"userSpaceOnUse\" markerWidth=\"8\" markerHeight=\"8\" orient=\"auto\"><path d=\"M 0 5 L 10 10 L 10 0 z\" class=\"arrowMarkerPath\" style=\"stroke-width: 1; stroke-dasharray: 1, 0;\"></path></marker><marker id=\"mermaid-mr6a3apr9ik_flowchart-v2-circleEnd\" class=\"marker flowchart-v2\" viewBox=\"0 0 10 10\" refX=\"11\" refY=\"5\" markerUnits=\"userSpaceOnUse\" markerWidth=\"11\" markerHeight=\"11\" orient=\"auto\"><circle cx=\"5\" cy=\"5\" r=\"5\" class=\"arrowMarkerPath\" style=\"stroke-width: 1; stroke-dasharray: 1, 0;\"></circle></marker><marker id=\"mermaid-mr6a3apr9ik_flowchart-v2-circleStart\" class=\"marker flowchart-v2\" viewBox=\"0 0 10 10\" refX=\"-1\" refY=\"5\" markerUnits=\"userSpaceOnUse\" markerWidth=\"11\" markerHeight=\"11\" orient=\"auto\"><circle cx=\"5\" cy=\"5\" r=\"5\" class=\"arrowMarkerPath\" style=\"stroke-width: 1; stroke-dasharray: 1, 0;\"></circle></marker><marker id=\"mermaid-mr6a3apr9ik_flowchart-v2-crossEnd\" class=\"marker cross flowchart-v2\" viewBox=\"0 0 11 11\" refX=\"12\" refY=\"5.2\" markerUnits=\"userSpaceOnUse\" markerWidth=\"11\" markerHeight=\"11\" orient=\"auto\"><path d=\"M 1,1 l 9,9 M 10,1 l -9,9\" class=\"arrowMarkerPath\" style=\"stroke-width: 2; stroke-dasharray: 1, 0;\"></path></marker><marker id=\"mermaid-mr6a3apr9ik_flowchart-v2-crossStart\" class=\"marker cross flowchart-v2\" viewBox=\"0 0 11 11\" refX=\"-1\" refY=\"5.2\" markerUnits=\"userSpaceOnUse\" markerWidth=\"11\" markerHeight=\"11\" orient=\"auto\"><path d=\"M 1,1 l 9,9 M 10,1 l -9,9\" class=\"arrowMarkerPath\" style=\"stroke-width: 2; stroke-dasharray: 1, 0;\"></path></marker><g class=\"root\"><g class=\"clusters\"><g class=\"cluster\" id=\"subGraph5\" data-look=\"classic\"><rect style=\"\" x=\"16.07421875\" y=\"886\" width=\"600.43359375\" height=\"152\"></rect><g class=\"cluster-label\" transform=\"translate(246.556640625, 886)\"><foreignObject width=\"139.46875\" height=\"24\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"nodeLabel\"><p>External Systems</p></span></div></foreignObject></g></g><g class=\"cluster\" id=\"subGraph4\" data-look=\"classic\"><rect style=\"\" x=\"8\" y=\"210\" width=\"404.87109375\" height=\"400\"></rect><g class=\"cluster-label\" transform=\"translate(144.974609375, 210)\"><foreignObject width=\"130.921875\" height=\"24\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"nodeLabel\"><p>Data Acquisition</p></span></div></foreignObject></g></g><g class=\"cluster\" id=\"subGraph3\" data-look=\"classic\"><rect style=\"\" x=\"668.203125\" y=\"660\" width=\"327.48046875\" height=\"378\"></rect><g class=\"cluster-label\" transform=\"translate(787.990234375, 660)\"><foreignObject width=\"87.90625\" height=\"24\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"nodeLabel\"><p>Data Layer</p></span></div></foreignObject></g></g><g class=\"cluster\" id=\"subGraph2\" data-look=\"classic\"><rect style=\"\" x=\"326.28125\" y=\"660\" width=\"321.921875\" height=\"176\"></rect><g class=\"cluster-label\" transform=\"translate(434.90625, 660)\"><foreignObject width=\"104.671875\" height=\"24\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"nodeLabel\"><p>Message Bus</p></span></div></foreignObject></g></g><g class=\"cluster\" id=\"subGraph1\" data-look=\"classic\"><rect style=\"\" x=\"432.87109375\" y=\"210\" width=\"516.21875\" height=\"400\"></rect><g class=\"cluster-label\" transform=\"translate(610.60546875, 210)\"><foreignObject width=\"160.75\" height=\"24\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"nodeLabel\"><p>Core Trading Engine</p></span></div></foreignObject></g></g><g class=\"cluster\" id=\"subGraph0\" data-look=\"classic\"><rect style=\"\" x=\"531.75390625\" y=\"8\" width=\"289.046875\" height=\"152\"></rect><g class=\"cluster-label\" transform=\"translate(632.58203125, 8)\"><foreignObject width=\"87.390625\" height=\"24\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"nodeLabel\"><p>Entry Point</p></span></div></foreignObject></g></g></g><g class=\"edgePaths\"><path d=\"M676.277,135L676.277,139.167C676.277,143.333,676.277,151.667,676.277,160C676.277,168.333,676.277,176.667,676.277,185C676.277,193.333,676.277,201.667,676.277,209.333C676.277,217,676.277,224,676.277,227.5L676.277,231\" id=\"L_MainPy_TradeStrategy_0\" class=\"edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link\" style=\";\" data-edge=\"true\" data-et=\"edge\" data-id=\"L_MainPy_TradeStrategy_0\" data-points=\"W3sieCI6Njc2LjI3NzM0Mzc1LCJ5IjoxMzV9LHsieCI6Njc2LjI3NzM0Mzc1LCJ5IjoxNjB9LHsieCI6Njc2LjI3NzM0Mzc1LCJ5IjoxODV9LHsieCI6Njc2LjI3NzM0Mzc1LCJ5IjoyMTB9LHsieCI6Njc2LjI3NzM0Mzc1LCJ5IjoyMzV9XQ==\" marker-end=\"url(#mermaid-mr6a3apr9ik_flowchart-v2-pointEnd)\"></path><path d=\"M623.93,385L621.021,389.167C618.113,393.333,612.297,401.667,609.389,409.333C606.48,417,606.48,424,606.48,427.5L606.48,431\" id=\"L_TradeStrategy_BaseModule_0\" class=\"edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link\" style=\";\" data-edge=\"true\" data-et=\"edge\" data-id=\"L_TradeStrategy_BaseModule_0\" data-points=\"W3sieCI6NjIzLjkyOTY4NzUsInkiOjM4NX0seyJ4Ijo2MDYuNDgwNDY4NzUsInkiOjQxMH0seyJ4Ijo2MDYuNDgwNDY4NzUsInkiOjQzNX1d\" marker-end=\"url(#mermaid-mr6a3apr9ik_flowchart-v2-pointEnd)\"></path><path d=\"M606.48,585L606.48,589.167C606.48,593.333,606.48,601.667,586.607,610C566.734,618.333,526.988,626.667,507.115,635C487.242,643.333,487.242,651.667,487.242,659.333C487.242,667,487.242,674,487.242,677.5L487.242,681\" id=\"L_BaseModule_RedisChannels_0\" class=\"edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link\" style=\";\" data-edge=\"true\" data-et=\"edge\" data-id=\"L_BaseModule_RedisChannels_0\" data-points=\"W3sieCI6NjA2LjQ4MDQ2ODc1LCJ5Ijo1ODV9LHsieCI6NjA2LjQ4MDQ2ODc1LCJ5Ijo2MTB9LHsieCI6NDg3LjI0MjE4NzUsInkiOjYzNX0seyJ4Ijo0ODcuMjQyMTg3NSwieSI6NjYwfSx7IngiOjQ4Ny4yNDIxODc1LCJ5Ijo2ODV9XQ==\" marker-end=\"url(#mermaid-mr6a3apr9ik_flowchart-v2-pointEnd)\"></path><path d=\"M487.242,811L487.242,815.167C487.242,819.333,487.242,827.667,487.242,836C487.242,844.333,487.242,852.667,487.242,861C487.242,869.333,487.242,877.667,487.242,885.333C487.242,893,487.242,900,487.242,903.5L487.242,907\" id=\"L_RedisChannels_CTP_0\" class=\"edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link\" style=\";\" data-edge=\"true\" data-et=\"edge\" data-id=\"L_RedisChannels_CTP_0\" data-points=\"W3sieCI6NDg3LjI0MjE4NzUsInkiOjgxMX0seyJ4Ijo0ODcuMjQyMTg3NSwieSI6ODM2fSx7IngiOjQ4Ny4yNDIxODc1LCJ5Ijo4NjF9LHsieCI6NDg3LjI0MjE4NzUsInkiOjg4Nn0seyJ4Ijo0ODcuMjQyMTg3NSwieSI6OTExfV0=\" marker-end=\"url(#mermaid-mr6a3apr9ik_flowchart-v2-pointEnd)\"></path><path d=\"M816.605,381.516L825.921,386.263C835.236,391.011,853.866,400.505,863.181,421.919C872.496,443.333,872.496,476.667,872.496,510C872.496,543.333,872.496,576.667,872.496,597.5C872.496,618.333,872.496,626.667,872.496,635C872.496,643.333,872.496,651.667,870.024,661.391C867.552,671.115,862.608,682.23,860.135,687.788L857.663,693.345\" id=\"L_TradeStrategy_DjangoORM_0\" class=\"edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link\" style=\";\" data-edge=\"true\" data-et=\"edge\" data-id=\"L_TradeStrategy_DjangoORM_0\" data-points=\"W3sieCI6ODE2LjYwNTQ2ODc1LCJ5IjozODEuNTE2MTY0OTk0NDI1OX0seyJ4Ijo4NzIuNDk2MDkzNzUsInkiOjQxMH0seyJ4Ijo4NzIuNDk2MDkzNzUsInkiOjUxMH0seyJ4Ijo4NzIuNDk2MDkzNzUsInkiOjYxMH0seyJ4Ijo4NzIuNDk2MDkzNzUsInkiOjYzNX0seyJ4Ijo4NzIuNDk2MDkzNzUsInkiOjY2MH0seyJ4Ijo4NTYuMDM3NTk3NjU2MjUsInkiOjY5N31d\" marker-end=\"url(#mermaid-mr6a3apr9ik_flowchart-v2-pointEnd)\"></path><path d=\"M833.352,799L833.352,805.167C833.352,811.333,833.352,823.667,833.352,834C833.352,844.333,833.352,852.667,833.352,861C833.352,869.333,833.352,877.667,833.352,889.333C833.352,901,833.352,916,833.352,923.5L833.352,931\" id=\"L_DjangoORM_MySQL_0\" class=\"edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link\" style=\";\" data-edge=\"true\" data-et=\"edge\" data-id=\"L_DjangoORM_MySQL_0\" data-points=\"W3sieCI6ODMzLjM1MTU2MjUsInkiOjc5OX0seyJ4Ijo4MzMuMzUxNTYyNSwieSI6ODM2fSx7IngiOjgzMy4zNTE1NjI1LCJ5Ijo4NjF9LHsieCI6ODMzLjM1MTU2MjUsInkiOjg4Nn0seyJ4Ijo4MzMuMzUxNTYyNSwieSI6OTM1fV0=\" marker-end=\"url(#mermaid-mr6a3apr9ik_flowchart-v2-pointEnd)\"></path><path d=\"M176.473,361L176.473,369.167C176.473,377.333,176.473,393.667,176.473,405.333C176.473,417,176.473,424,176.473,427.5L176.473,431\" id=\"L_FetchData_UtilsInit_0\" class=\"edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link\" style=\";\" data-edge=\"true\" data-et=\"edge\" data-id=\"L_FetchData_UtilsInit_0\" data-points=\"W3sieCI6MTc2LjQ3MjY1NjI1LCJ5IjozNjF9LHsieCI6MTc2LjQ3MjY1NjI1LCJ5Ijo0MTB9LHsieCI6MTc2LjQ3MjY1NjI1LCJ5Ijo0MzV9XQ==\" marker-end=\"url(#mermaid-mr6a3apr9ik_flowchart-v2-pointEnd)\"></path><path d=\"M168.973,585L168.556,589.167C168.139,593.333,167.306,601.667,166.889,610C166.473,618.333,166.473,626.667,166.473,635C166.473,643.333,166.473,651.667,166.473,670.5C166.473,689.333,166.473,718.667,166.473,748C166.473,777.333,166.473,806.667,166.473,825.5C166.473,844.333,166.473,852.667,166.473,861C166.473,869.333,166.473,877.667,166.473,885.333C166.473,893,166.473,900,166.473,903.5L166.473,907\" id=\"L_UtilsInit_Exchanges_0\" class=\"edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link\" style=\";\" data-edge=\"true\" data-et=\"edge\" data-id=\"L_UtilsInit_Exchanges_0\" data-points=\"W3sieCI6MTY4Ljk3MjY1NjI1LCJ5Ijo1ODV9LHsieCI6MTY2LjQ3MjY1NjI1LCJ5Ijo2MTB9LHsieCI6MTY2LjQ3MjY1NjI1LCJ5Ijo2MzV9LHsieCI6MTY2LjQ3MjY1NjI1LCJ5Ijo2NjB9LHsieCI6MTY2LjQ3MjY1NjI1LCJ5Ijo3NDh9LHsieCI6MTY2LjQ3MjY1NjI1LCJ5Ijo4MzZ9LHsieCI6MTY2LjQ3MjY1NjI1LCJ5Ijo4NjF9LHsieCI6MTY2LjQ3MjY1NjI1LCJ5Ijo4ODZ9LHsieCI6MTY2LjQ3MjY1NjI1LCJ5Ijo5MTF9XQ==\" marker-end=\"url(#mermaid-mr6a3apr9ik_flowchart-v2-pointEnd)\"></path><path d=\"M282.372,585L288.255,589.167C294.139,593.333,305.905,601.667,384.643,610C463.38,618.333,609.089,626.667,681.943,635C754.797,643.333,754.797,651.667,759.858,661.503C764.919,671.339,775.04,682.677,780.101,688.347L785.162,694.016\" id=\"L_UtilsInit_DjangoORM_0\" class=\"edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link\" style=\";\" data-edge=\"true\" data-et=\"edge\" data-id=\"L_UtilsInit_DjangoORM_0\" data-points=\"W3sieCI6MjgyLjM3MjA3MDMxMjUsInkiOjU4NX0seyJ4IjozMTcuNjcxODc1LCJ5Ijo2MTB9LHsieCI6NzU0Ljc5Njg3NSwieSI6NjM1fSx7IngiOjc1NC43OTY4NzUsInkiOjY2MH0seyJ4Ijo3ODcuODI1NTUwNDI2MTM2NCwieSI6Njk3fV0=\" marker-end=\"url(#mermaid-mr6a3apr9ik_flowchart-v2-pointEnd)\"></path><path d=\"M565.526,385L559.374,389.167C553.221,393.333,540.915,401.667,498.381,416.165C455.846,430.663,383.083,451.327,346.702,461.658L310.321,471.99\" id=\"L_TradeStrategy_UtilsInit_0\" class=\"edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link\" style=\";\" data-edge=\"true\" data-et=\"edge\" data-id=\"L_TradeStrategy_UtilsInit_0\" data-points=\"W3sieCI6NTY1LjUyNjM2NzE4NzUsInkiOjM4NX0seyJ4Ijo1MjguNjA5Mzc1LCJ5Ijo0MTB9LHsieCI6MzA2LjQ3MjY1NjI1LCJ5Ijo0NzMuMDgyNTIwNzcxNjI4NTR9XQ==\" marker-end=\"url(#mermaid-mr6a3apr9ik_flowchart-v2-pointEnd)\"></path></g><g class=\"edgeLabels\"><g class=\"edgeLabel\"><g class=\"label\" data-id=\"L_MainPy_TradeStrategy_0\" transform=\"translate(0, 0)\"><foreignObject width=\"0\" height=\"0\"><div xmlns=\"http://www.w3.org/1999/xhtml\" class=\"labelBkg\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"edgeLabel\"></span></div></foreignObject></g></g><g class=\"edgeLabel\"><g class=\"label\" data-id=\"L_TradeStrategy_BaseModule_0\" transform=\"translate(0, 0)\"><foreignObject width=\"0\" height=\"0\"><div xmlns=\"http://www.w3.org/1999/xhtml\" class=\"labelBkg\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"edgeLabel\"></span></div></foreignObject></g></g><g class=\"edgeLabel\"><g class=\"label\" data-id=\"L_BaseModule_RedisChannels_0\" transform=\"translate(0, 0)\"><foreignObject width=\"0\" height=\"0\"><div xmlns=\"http://www.w3.org/1999/xhtml\" class=\"labelBkg\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"edgeLabel\"></span></div></foreignObject></g></g><g class=\"edgeLabel\"><g class=\"label\" data-id=\"L_RedisChannels_CTP_0\" transform=\"translate(0, 0)\"><foreignObject width=\"0\" height=\"0\"><div xmlns=\"http://www.w3.org/1999/xhtml\" class=\"labelBkg\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"edgeLabel\"></span></div></foreignObject></g></g><g class=\"edgeLabel\"><g class=\"label\" data-id=\"L_TradeStrategy_DjangoORM_0\" transform=\"translate(0, 0)\"><foreignObject width=\"0\" height=\"0\"><div xmlns=\"http://www.w3.org/1999/xhtml\" class=\"labelBkg\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"edgeLabel\"></span></div></foreignObject></g></g><g class=\"edgeLabel\"><g class=\"label\" data-id=\"L_DjangoORM_MySQL_0\" transform=\"translate(0, 0)\"><foreignObject width=\"0\" height=\"0\"><div xmlns=\"http://www.w3.org/1999/xhtml\" class=\"labelBkg\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"edgeLabel\"></span></div></foreignObject></g></g><g class=\"edgeLabel\"><g class=\"label\" data-id=\"L_FetchData_UtilsInit_0\" transform=\"translate(0, 0)\"><foreignObject width=\"0\" height=\"0\"><div xmlns=\"http://www.w3.org/1999/xhtml\" class=\"labelBkg\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"edgeLabel\"></span></div></foreignObject></g></g><g class=\"edgeLabel\"><g class=\"label\" data-id=\"L_UtilsInit_Exchanges_0\" transform=\"translate(0, 0)\"><foreignObject width=\"0\" height=\"0\"><div xmlns=\"http://www.w3.org/1999/xhtml\" class=\"labelBkg\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"edgeLabel\"></span></div></foreignObject></g></g><g class=\"edgeLabel\"><g class=\"label\" data-id=\"L_UtilsInit_DjangoORM_0\" transform=\"translate(0, 0)\"><foreignObject width=\"0\" height=\"0\"><div xmlns=\"http://www.w3.org/1999/xhtml\" class=\"labelBkg\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"edgeLabel\"></span></div></foreignObject></g></g><g class=\"edgeLabel\"><g class=\"label\" data-id=\"L_TradeStrategy_UtilsInit_0\" transform=\"translate(0, 0)\"><foreignObject width=\"0\" height=\"0\"><div xmlns=\"http://www.w3.org/1999/xhtml\" class=\"labelBkg\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"edgeLabel\"></span></div></foreignObject></g></g></g><g class=\"nodes\"><g class=\"node default\" id=\"flowchart-MainPy-0\" transform=\"translate(676.27734375, 84)\"><rect class=\"basic label-container\" style=\"\" x=\"-109.5234375\" y=\"-51\" width=\"219.046875\" height=\"102\"></rect><g class=\"label\" style=\"\" transform=\"translate(-79.5234375, -36)\"><rect></rect><foreignObject width=\"159.046875\" height=\"72\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"nodeLabel\"><p>trader/main.py<br>Django initialization<br>Strategy launcher</p></span></div></foreignObject></g></g><g class=\"node default\" id=\"flowchart-TradeStrategy-1\" transform=\"translate(676.27734375, 310)\"><rect class=\"basic label-container\" style=\"\" x=\"-140.328125\" y=\"-75\" width=\"280.65625\" height=\"150\"></rect><g class=\"label\" style=\"\" transform=\"translate(-110.328125, -60)\"><rect></rect><foreignObject width=\"220.65625\" height=\"120\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: table; white-space: break-spaces; line-height: 1.5; max-width: 200px; text-align: center; width: 200px;\"><span class=\"nodeLabel\"><p>TradeStrategy<br>trader/strategy/brother2.py<br>Signal processing<br>Order management<br>Position tracking</p></span></div></foreignObject></g></g><g class=\"node default\" id=\"flowchart-BaseModule-2\" transform=\"translate(606.48046875, 510)\"><rect class=\"basic label-container\" style=\"\" x=\"-120.7421875\" y=\"-75\" width=\"241.484375\" height=\"150\"></rect><g class=\"label\" style=\"\" transform=\"translate(-90.7421875, -60)\"><rect></rect><foreignObject width=\"181.484375\" height=\"120\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"nodeLabel\"><p>BaseModule<br>trader/strategy/<strong>init</strong>.py<br>Redis Pub/Sub<br>Cron scheduling<br>Callback system</p></span></div></foreignObject></g></g><g class=\"node default\" id=\"flowchart-RedisChannels-3\" transform=\"translate(487.2421875, 748)\"><rect class=\"basic label-container\" style=\"\" x=\"-125.9609375\" y=\"-63\" width=\"251.921875\" height=\"126\"></rect><g class=\"label\" style=\"\" transform=\"translate(-95.9609375, -48)\"><rect></rect><foreignObject width=\"191.921875\" height=\"96\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"nodeLabel\"><p>Redis Pub/Sub<br>MSG:CTP:REQ:<em><br>MSG:CTP:RSP:TRADE:</em><br>MSG:CTP:RSP:MARKET:*</p></span></div></foreignObject></g></g><g class=\"node default\" id=\"flowchart-DjangoORM-4\" transform=\"translate(833.3515625, 748)\"><rect class=\"basic label-container\" style=\"\" x=\"-96.328125\" y=\"-51\" width=\"192.65625\" height=\"102\"></rect><g class=\"label\" style=\"\" transform=\"translate(-66.328125, -36)\"><rect></rect><foreignObject width=\"132.65625\" height=\"72\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"nodeLabel\"><p>Django ORM<br>panel/models.py<br>8 core models</p></span></div></foreignObject></g></g><g class=\"node default\" id=\"flowchart-MySQL-5\" transform=\"translate(833.3515625, 962)\"><rect class=\"basic label-container\" style=\"\" x=\"-98.1875\" y=\"-27\" width=\"196.375\" height=\"54\"></rect><g class=\"label\" style=\"\" transform=\"translate(-68.1875, -12)\"><rect></rect><foreignObject width=\"136.375\" height=\"24\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"nodeLabel\"><p>MySQL Database</p></span></div></foreignObject></g></g><g class=\"node default\" id=\"flowchart-FetchData-6\" transform=\"translate(176.47265625, 310)\"><rect class=\"basic label-container\" style=\"\" x=\"-131.546875\" y=\"-51\" width=\"263.09375\" height=\"102\"></rect><g class=\"label\" style=\"\" transform=\"translate(-101.546875, -36)\"><rect></rect><foreignObject width=\"203.09375\" height=\"72\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: table; white-space: break-spaces; line-height: 1.5; max-width: 200px; text-align: center; width: 200px;\"><span class=\"nodeLabel\"><p>trader/utils/fetch_data.py<br>Orchestrates daily updates</p></span></div></foreignObject></g></g><g class=\"node default\" id=\"flowchart-UtilsInit-7\" transform=\"translate(176.47265625, 510)\"><rect class=\"basic label-container\" style=\"\" x=\"-130\" y=\"-75\" width=\"260\" height=\"150\"></rect><g class=\"label\" style=\"\" transform=\"translate(-100, -60)\"><rect></rect><foreignObject width=\"200\" height=\"120\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: table; white-space: break-spaces; line-height: 1.5; max-width: 200px; text-align: center; width: 200px;\"><span class=\"nodeLabel\"><p>trader/utils/<strong>init</strong>.py<br>Exchange data fetchers<br>Main contract calculation<br>Technical indicators</p></span></div></foreignObject></g></g><g class=\"node default\" id=\"flowchart-Exchanges-8\" transform=\"translate(166.47265625, 962)\"><rect class=\"basic label-container\" style=\"\" x=\"-115.3984375\" y=\"-51\" width=\"230.796875\" height=\"102\"></rect><g class=\"label\" style=\"\" transform=\"translate(-85.3984375, -36)\"><rect></rect><foreignObject width=\"170.796875\" height=\"72\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"nodeLabel\"><p>5 Chinese Exchanges<br>SHFE, DCE, CZCE<br>CFFEX, GFEX</p></span></div></foreignObject></g></g><g class=\"node default\" id=\"flowchart-CTP-9\" transform=\"translate(487.2421875, 962)\"><rect class=\"basic label-container\" style=\"\" x=\"-94.265625\" y=\"-51\" width=\"188.53125\" height=\"102\"></rect><g class=\"label\" style=\"\" transform=\"translate(-64.265625, -36)\"><rect></rect><foreignObject width=\"128.53125\" height=\"72\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"nodeLabel\"><p>CTP API<br>Order execution<br>Market data</p></span></div></foreignObject></g></g></g></g></g></svg></div><div class=\"absolute right-2 top-2 flex items-center gap-1 opacity-0 transition-opacity group-hover:opacity-100\"><button class=\"cursor-pointer rounded-sm p-1 text-[#333] opacity-70 transition-opacity hover:opacity-100 dark:text-white\" aria-label=\"Zoom in\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"16\" height=\"16\" fill=\"currentColor\" viewBox=\"0 0 256 256\"><path d=\"M224,128a8,8,0,0,1-8,8H136v80a8,8,0,0,1-16,0V136H40a8,8,0,0,1,0-16h80V40a8,8,0,0,1,16,0v80h80A8,8,0,0,1,224,128Z\"></path></svg></button><button class=\"cursor-pointer rounded-sm p-1 text-[#333] opacity-70 transition-opacity hover:opacity-100 dark:text-white\" aria-label=\"Zoom out\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"16\" height=\"16\" fill=\"currentColor\" viewBox=\"0 0 256 256\"><path d=\"M224,128a8,8,0,0,1-8,8H40a8,8,0,0,1,0-16H216A8,8,0,0,1,224,128Z\"></path></svg></button><div class=\"rounded-sm p-1\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"16\" height=\"16\" fill=\"currentColor\" viewBox=\"0 0 256 256\" class=\"text-[#333] dark:text-white\"><path d=\"M216,48V96a8,8,0,0,1-16,0V67.31l-42.34,42.35a8,8,0,0,1-11.32-11.32L188.69,56H160a8,8,0,0,1,0-16h48A8,8,0,0,1,216,48ZM98.34,146.34,56,188.69V160a8,8,0,0,0-16,0v48a8,8,0,0,0,8,8H96a8,8,0,0,0,0-16H67.31l42.35-42.34a8,8,0,0,0-11.32-11.32ZM208,152a8,8,0,0,0-8,8v28.69l-42.34-42.35a8,8,0,0,0-11.32,11.32L188.69,200H160a8,8,0,0,0,0,16h48a8,8,0,0,0,8-8V160A8,8,0,0,0,208,152ZM67.31,56H96a8,8,0,0,0,0-16H48a8,8,0,0,0-8,8V96a8,8,0,0,0,16,0V67.31l42.34,42.35a8,8,0,0,0,11.32-11.32Z\"></path></svg></div></div></div></pre>\n<p><strong>Sources</strong>: <a href=\"https://github.com/timercrack/trader/blob/3307c308/trader/main.py#L1-L50\" target=\"_blank\" rel=\"noopener noreferrer\" class=\"mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75\"><span class=\"flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4]\"><svg class=\"mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block\" fill=\"currentColor\" viewBox=\"0 0 24 24\"><path d=\"M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z\"></path></svg>trader/main.py</span><span class=\"flex flex-shrink-0 items-center rounded-r border-l px-2 py-1.5 border-[#dddddd] bg-[#d8d8d8] text-[#666666] dark:border-[#333333] dark:bg-[#2a2a2a] dark:text-[#888888]\">1-50</span></a> <a href=\"https://github.com/timercrack/trader/blob/3307c308/trader/strategy/brother2.py#L38-L63\" target=\"_blank\" rel=\"noopener noreferrer\" class=\"mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75\"><span class=\"flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4]\"><svg class=\"mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block\" fill=\"currentColor\" viewBox=\"0 0 24 24\"><path d=\"M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z\"></path></svg>trader/strategy/brother2.py</span><span class=\"flex flex-shrink-0 items-center rounded-r border-l px-2 py-1.5 border-[#dddddd] bg-[#d8d8d8] text-[#666666] dark:border-[#333333] dark:bg-[#2a2a2a] dark:text-[#888888]\">38-63</span></a> <a href=\"https://github.com/timercrack/trader/blob/3307c308/trader/strategy/__init__.py#L1-L200\" target=\"_blank\" rel=\"noopener noreferrer\" class=\"mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75\"><span class=\"flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4]\"><svg class=\"mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block\" fill=\"currentColor\" viewBox=\"0 0 24 24\"><path d=\"M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z\"></path></svg>trader/strategy/__init__.py</span><span class=\"flex flex-shrink-0 items-center rounded-r border-l px-2 py-1.5 border-[#dddddd] bg-[#d8d8d8] text-[#666666] dark:border-[#333333] dark:bg-[#2a2a2a] dark:text-[#888888]\">1-200</span></a> <a href=\"https://github.com/timercrack/trader/blob/3307c308/trader/utils/__init__.py#L1-L100\" target=\"_blank\" rel=\"noopener noreferrer\" class=\"mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75\"><span class=\"flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4]\"><svg class=\"mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block\" fill=\"currentColor\" viewBox=\"0 0 24 24\"><path d=\"M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z\"></path></svg>trader/utils/__init__.py</span><span class=\"flex flex-shrink-0 items-center rounded-r border-l px-2 py-1.5 border-[#dddddd] bg-[#d8d8d8] text-[#666666] dark:border-[#333333] dark:bg-[#2a2a2a] dark:text-[#888888]\">1-100</span></a> <a href=\"https://github.com/timercrack/trader/blob/3307c308/panel/models.py#L1-L40\" target=\"_blank\" rel=\"noopener noreferrer\" class=\"mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75\"><span class=\"flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4]\"><svg class=\"mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block\" fill=\"currentColor\" viewBox=\"0 0 24 24\"><path d=\"M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z\"></path></svg>panel/models.py</span><span class=\"flex flex-shrink-0 items-center rounded-r border-l px-2 py-1.5 border-[#dddddd] bg-[#d8d8d8] text-[#666666] dark:border-[#333333] dark:bg-[#2a2a2a] dark:text-[#888888]\">1-40</span></a></p>\n<h3 id=\"component-to-file-mapping\" class=\"group\" data-header=\"true\">Component-to-File Mapping<button class=\"relative ml-2 cursor-pointer align-baseline text-gray-400 opacity-0 transition-opacity hover:text-blue-400 focus:opacity-100 group-hover:opacity-100\" aria-label=\"Copy link to header\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"1em\" height=\"1em\" fill=\"currentColor\" viewBox=\"0 0 256 256\" class=\"h-4 w-4\"><path d=\"M117.18,188.74a12,12,0,0,1,0,17l-5.12,5.12A58.26,58.26,0,0,1,70.6,228h0A58.62,58.62,0,0,1,29.14,127.92L63.89,93.17a58.64,58.64,0,0,1,98.56,28.11,12,12,0,1,1-23.37,5.44,34.65,34.65,0,0,0-58.22-16.58L46.11,144.89A34.62,34.62,0,0,0,70.57,204h0a34.41,34.41,0,0,0,24.49-10.14l5.11-5.12A12,12,0,0,1,117.18,188.74ZM226.83,45.17a58.65,58.65,0,0,0-82.93,0l-5.11,5.11a12,12,0,0,0,17,17l5.12-5.12a34.63,34.63,0,1,1,49,49L175.1,145.86A34.39,34.39,0,0,1,150.61,156h0a34.63,34.63,0,0,1-33.69-26.72,12,12,0,0,0-23.38,5.44A58.64,58.64,0,0,0,150.56,180h.05a58.28,58.28,0,0,0,41.47-17.17l34.75-34.75a58.62,58.62,0,0,0,0-82.91Z\"></path></svg></button></h3>\n<p>The following diagram maps system components to their implementation files, showing the most critical code paths:</p>\n<pre class=\"px-2 py-1.5 has-[code]:rounded-md has-[code]:!bg-[#e5e5e5] has-[div]:bg-transparent has-[div]:!p-0 has-[code]:text-stone-900 dark:has-[code]:!bg-[#242424] has-[code]:dark:text-white [&amp;_code]:block [&amp;_code]:border-none [&amp;_code]:bg-transparent [&amp;_code]:p-0\"><div class=\"group relative cursor-pointer overflow-x-auto rounded-md bg-[#f2f1f0] p-4 transition-colors hover:bg-[#ededed] dark:bg-[#1f1f1f] dark:hover:bg-[#242424]\" type=\"button\" aria-haspopup=\"dialog\" aria-expanded=\"false\" aria-controls=\"radix-_r_6_\" data-state=\"closed\" data-slot=\"dialog-trigger\"><div class=\"flex max-h-[70vh] justify-center\"><svg id=\"mermaid-c4mmcc8xbsu\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" class=\"flowchart\" style=\"max-width: 100%; touch-action: none; user-select: none; cursor: grab; min-height: fit-content; max-height: 100%;\" viewBox=\"-373.54017857142867 0 1535.1428571428573 2388\" role=\"graphics-document document\" aria-roledescription=\"flowchart-v2\" preserveAspectRatio=\"xMidYMid meet\"><style>#mermaid-c4mmcc8xbsu{font-family:ui-sans-serif,-apple-system,system-ui,Segoe UI,Helvetica;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#mermaid-c4mmcc8xbsu .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#mermaid-c4mmcc8xbsu .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#mermaid-c4mmcc8xbsu .error-icon{fill:#dddddd;}#mermaid-c4mmcc8xbsu .error-text{fill:#222222;stroke:#222222;}#mermaid-c4mmcc8xbsu .edge-thickness-normal{stroke-width:1px;}#mermaid-c4mmcc8xbsu .edge-thickness-thick{stroke-width:3.5px;}#mermaid-c4mmcc8xbsu .edge-pattern-solid{stroke-dasharray:0;}#mermaid-c4mmcc8xbsu .edge-thickness-invisible{stroke-width:0;fill:none;}#mermaid-c4mmcc8xbsu .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-c4mmcc8xbsu .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-c4mmcc8xbsu .marker{fill:#999;stroke:#999;}#mermaid-c4mmcc8xbsu .marker.cross{stroke:#999;}#mermaid-c4mmcc8xbsu svg{font-family:ui-sans-serif,-apple-system,system-ui,Segoe UI,Helvetica;font-size:16px;}#mermaid-c4mmcc8xbsu p{margin:0;}#mermaid-c4mmcc8xbsu .label{font-family:ui-sans-serif,-apple-system,system-ui,Segoe UI,Helvetica;color:#333;}#mermaid-c4mmcc8xbsu .cluster-label text{fill:#444;}#mermaid-c4mmcc8xbsu .cluster-label span{color:#444;}#mermaid-c4mmcc8xbsu .cluster-label span p{background-color:transparent;}#mermaid-c4mmcc8xbsu .label text,#mermaid-c4mmcc8xbsu span{fill:#333;color:#333;}#mermaid-c4mmcc8xbsu .node rect,#mermaid-c4mmcc8xbsu .node circle,#mermaid-c4mmcc8xbsu .node ellipse,#mermaid-c4mmcc8xbsu .node polygon,#mermaid-c4mmcc8xbsu .node path{fill:#ffffff;stroke:#dddddd;stroke-width:1px;}#mermaid-c4mmcc8xbsu .rough-node .label text,#mermaid-c4mmcc8xbsu .node .label text,#mermaid-c4mmcc8xbsu .image-shape .label,#mermaid-c4mmcc8xbsu .icon-shape .label{text-anchor:middle;}#mermaid-c4mmcc8xbsu .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#mermaid-c4mmcc8xbsu .rough-node .label,#mermaid-c4mmcc8xbsu .node .label,#mermaid-c4mmcc8xbsu .image-shape .label,#mermaid-c4mmcc8xbsu .icon-shape .label{text-align:center;}#mermaid-c4mmcc8xbsu .node.clickable{cursor:pointer;}#mermaid-c4mmcc8xbsu .root .anchor path{fill:#999!important;stroke-width:0;stroke:#999;}#mermaid-c4mmcc8xbsu .arrowheadPath{fill:#0b0b0b;}#mermaid-c4mmcc8xbsu .edgePath .path{stroke:#999;stroke-width:2.0px;}#mermaid-c4mmcc8xbsu .flowchart-link{stroke:#999;fill:none;}#mermaid-c4mmcc8xbsu .edgeLabel{background-color:#ffffff;text-align:center;}#mermaid-c4mmcc8xbsu .edgeLabel p{background-color:#ffffff;}#mermaid-c4mmcc8xbsu .edgeLabel rect{opacity:0.5;background-color:#ffffff;fill:#ffffff;}#mermaid-c4mmcc8xbsu .labelBkg{background-color:rgba(255, 255, 255, 0.5);}#mermaid-c4mmcc8xbsu .cluster rect{fill:#f8f8f8;stroke:#dddddd;stroke-width:1px;}#mermaid-c4mmcc8xbsu .cluster text{fill:#444;}#mermaid-c4mmcc8xbsu .cluster span{color:#444;}#mermaid-c4mmcc8xbsu div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:ui-sans-serif,-apple-system,system-ui,Segoe UI,Helvetica;font-size:12px;background:#dddddd;border:1px solid hsl(0, 0%, 76.6666666667%);border-radius:2px;pointer-events:none;z-index:100;}#mermaid-c4mmcc8xbsu .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#mermaid-c4mmcc8xbsu rect.text{fill:none;stroke-width:0;}#mermaid-c4mmcc8xbsu .icon-shape,#mermaid-c4mmcc8xbsu .image-shape{background-color:#ffffff;text-align:center;}#mermaid-c4mmcc8xbsu .icon-shape p,#mermaid-c4mmcc8xbsu .image-shape p{background-color:#ffffff;padding:2px;}#mermaid-c4mmcc8xbsu .icon-shape rect,#mermaid-c4mmcc8xbsu .image-shape rect{opacity:0.5;background-color:#ffffff;fill:#ffffff;}#mermaid-c4mmcc8xbsu .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#mermaid-c4mmcc8xbsu .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#mermaid-c4mmcc8xbsu :root{--mermaid-font-family:\"trebuchet ms\",verdana,arial,sans-serif;}</style><g><marker id=\"mermaid-c4mmcc8xbsu_flowchart-v2-pointEnd\" class=\"marker flowchart-v2\" viewBox=\"0 0 10 10\" refX=\"5\" refY=\"5\" markerUnits=\"userSpaceOnUse\" markerWidth=\"8\" markerHeight=\"8\" orient=\"auto\"><path d=\"M 0 0 L 10 5 L 0 10 z\" class=\"arrowMarkerPath\" style=\"stroke-width: 1; stroke-dasharray: 1, 0;\"></path></marker><marker id=\"mermaid-c4mmcc8xbsu_flowchart-v2-pointStart\" class=\"marker flowchart-v2\" viewBox=\"0 0 10 10\" refX=\"4.5\" refY=\"5\" markerUnits=\"userSpaceOnUse\" markerWidth=\"8\" markerHeight=\"8\" orient=\"auto\"><path d=\"M 0 5 L 10 10 L 10 0 z\" class=\"arrowMarkerPath\" style=\"stroke-width: 1; stroke-dasharray: 1, 0;\"></path></marker><marker id=\"mermaid-c4mmcc8xbsu_flowchart-v2-circleEnd\" class=\"marker flowchart-v2\" viewBox=\"0 0 10 10\" refX=\"11\" refY=\"5\" markerUnits=\"userSpaceOnUse\" markerWidth=\"11\" markerHeight=\"11\" orient=\"auto\"><circle cx=\"5\" cy=\"5\" r=\"5\" class=\"arrowMarkerPath\" style=\"stroke-width: 1; stroke-dasharray: 1, 0;\"></circle></marker><marker id=\"mermaid-c4mmcc8xbsu_flowchart-v2-circleStart\" class=\"marker flowchart-v2\" viewBox=\"0 0 10 10\" refX=\"-1\" refY=\"5\" markerUnits=\"userSpaceOnUse\" markerWidth=\"11\" markerHeight=\"11\" orient=\"auto\"><circle cx=\"5\" cy=\"5\" r=\"5\" class=\"arrowMarkerPath\" style=\"stroke-width: 1; stroke-dasharray: 1, 0;\"></circle></marker><marker id=\"mermaid-c4mmcc8xbsu_flowchart-v2-crossEnd\" class=\"marker cross flowchart-v2\" viewBox=\"0 0 11 11\" refX=\"12\" refY=\"5.2\" markerUnits=\"userSpaceOnUse\" markerWidth=\"11\" markerHeight=\"11\" orient=\"auto\"><path d=\"M 1,1 l 9,9 M 10,1 l -9,9\" class=\"arrowMarkerPath\" style=\"stroke-width: 2; stroke-dasharray: 1, 0;\"></path></marker><marker id=\"mermaid-c4mmcc8xbsu_flowchart-v2-crossStart\" class=\"marker cross flowchart-v2\" viewBox=\"0 0 11 11\" refX=\"-1\" refY=\"5.2\" markerUnits=\"userSpaceOnUse\" markerWidth=\"11\" markerHeight=\"11\" orient=\"auto\"><path d=\"M 1,1 l 9,9 M 10,1 l -9,9\" class=\"arrowMarkerPath\" style=\"stroke-width: 2; stroke-dasharray: 1, 0;\"></path></marker><g class=\"root\"><g class=\"clusters\"><g class=\"cluster\" id=\"Configuration\" data-look=\"classic\"><rect style=\"\" x=\"8\" y=\"2048\" width=\"272.6875\" height=\"332\"></rect><g class=\"cluster-label\" transform=\"translate(90.0859375, 2048)\"><foreignObject width=\"108.515625\" height=\"24\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"nodeLabel\"><p>Configuration</p></span></div></foreignObject></g></g><g class=\"cluster\" id=\"Utilities\" data-look=\"classic\"><rect style=\"\" x=\"8\" y=\"1280\" width=\"272.6875\" height=\"748\"></rect><g class=\"cluster-label\" transform=\"translate(114.234375, 1280)\"><foreignObject width=\"60.21875\" height=\"24\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"nodeLabel\"><p>Utilities</p></span></div></foreignObject></g></g><g class=\"cluster\" id=\"subGraph1\" data-look=\"classic\"><rect style=\"\" x=\"8\" y=\"408\" width=\"272.6875\" height=\"852\"></rect><g class=\"cluster-label\" transform=\"translate(94.5078125, 408)\"><foreignObject width=\"99.671875\" height=\"24\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"nodeLabel\"><p>Data Models</p></span></div></foreignObject></g></g><g class=\"cluster\" id=\"subGraph0\" data-look=\"classic\"><rect style=\"\" x=\"8\" y=\"8\" width=\"272.6875\" height=\"380\"></rect><g class=\"cluster-label\" transform=\"translate(63.234375, 8)\"><foreignObject width=\"162.21875\" height=\"24\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"nodeLabel\"><p>Strategy Framework</p></span></div></foreignObject></g></g></g><g class=\"edgePaths\"><path d=\"M252.93,82L257.556,82C262.182,82,271.435,82,293.057,82C314.68,82,348.672,82,383.228,82C417.784,82,452.904,82,470.464,82L488.023,82\" id=\"L_TradeStrategyClass_F1_0\" class=\"edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link\" style=\";\" data-edge=\"true\" data-et=\"edge\" data-id=\"L_TradeStrategyClass_F1_0\" data-points=\"W3sieCI6MjUyLjkyOTY4NzUsInkiOjgyfSx7IngiOjI4MC42ODc1LCJ5Ijo4Mn0seyJ4IjozODIuNjY0MDYyNSwieSI6ODJ9LHsieCI6NDkyLjAyMzQzNzUsInkiOjgyfV0=\" marker-end=\"url(#mermaid-c4mmcc8xbsu_flowchart-v2-pointEnd)\"></path><path d=\"M245.32,198L251.215,198C257.109,198,268.898,198,291.789,198C314.68,198,348.672,198,386.492,198C424.313,198,465.961,198,486.785,198L507.609,198\" id=\"L_BaseModuleClass_F2_0\" class=\"edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link\" style=\";\" data-edge=\"true\" data-et=\"edge\" data-id=\"L_BaseModuleClass_F2_0\" data-points=\"W3sieCI6MjQ1LjMyMDMxMjUsInkiOjE5OH0seyJ4IjoyODAuNjg3NSwieSI6MTk4fSx7IngiOjM4Mi42NjQwNjI1LCJ5IjoxOTh9LHsieCI6NTExLjYwOTM3NSwieSI6MTk4fV0=\" marker-end=\"url(#mermaid-c4mmcc8xbsu_flowchart-v2-pointEnd)\"></path><path d=\"M249.227,314L254.47,314C259.714,314,270.201,314,292.44,314C314.68,314,348.672,314,381.997,314C415.323,314,447.982,314,464.311,314L480.641,314\" id=\"L_CallbackDecorator_F3_0\" class=\"edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link\" style=\";\" data-edge=\"true\" data-et=\"edge\" data-id=\"L_CallbackDecorator_F3_0\" data-points=\"W3sieCI6MjQ5LjIyNjU2MjUsInkiOjMxNH0seyJ4IjoyODAuNjg3NSwieSI6MzE0fSx7IngiOjM4Mi42NjQwNjI1LCJ5IjozMTR9LHsieCI6NDg0LjY0MDYyNSwieSI6MzE0fV0=\" marker-end=\"url(#mermaid-c4mmcc8xbsu_flowchart-v2-pointEnd)\"></path><path d=\"M227.852,470L236.658,470C245.464,470,263.076,470,288.878,470C314.68,470,348.672,470,403.819,525.617C458.965,581.234,535.267,692.468,573.417,748.085L611.568,803.701\" id=\"L_Broker_F4_0\" class=\"edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link\" style=\";\" data-edge=\"true\" data-et=\"edge\" data-id=\"L_Broker_F4_0\" data-points=\"W3sieCI6MjI3Ljg1MTU2MjUsInkiOjQ3MH0seyJ4IjoyODAuNjg3NSwieSI6NDcwfSx7IngiOjM4Mi42NjQwNjI1LCJ5Ijo0NzB9LHsieCI6NjEzLjgzMDc4NjQwMTA5ODksInkiOjgwN31d\" marker-end=\"url(#mermaid-c4mmcc8xbsu_flowchart-v2-pointEnd)\"></path><path d=\"M236.078,574L243.513,574C250.948,574,265.818,574,290.249,574C314.68,574,348.672,574,402.499,612.352C456.327,650.705,529.989,727.41,566.821,765.762L603.652,804.115\" id=\"L_Strategy_F4_0\" class=\"edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link\" style=\";\" data-edge=\"true\" data-et=\"edge\" data-id=\"L_Strategy_F4_0\" data-points=\"W3sieCI6MjM2LjA3ODEyNSwieSI6NTc0fSx7IngiOjI4MC42ODc1LCJ5Ijo1NzR9LHsieCI6MzgyLjY2NDA2MjUsInkiOjU3NH0seyJ4Ijo2MDYuNDIyNDc1OTYxNTM4NSwieSI6ODA3fV0=\" marker-end=\"url(#mermaid-c4mmcc8xbsu_flowchart-v2-pointEnd)\"></path><path d=\"M245.813,678L251.625,678C257.438,678,269.063,678,291.871,678C314.68,678,348.672,678,399.515,699.147C450.357,720.294,518.051,762.587,551.897,783.734L585.744,804.881\" id=\"L_Instrument_F4_0\" class=\"edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link\" style=\";\" data-edge=\"true\" data-et=\"edge\" data-id=\"L_Instrument_F4_0\" data-points=\"W3sieCI6MjQ1LjgxMjUsInkiOjY3OH0seyJ4IjoyODAuNjg3NSwieSI6Njc4fSx7IngiOjM4Mi42NjQwNjI1LCJ5Ijo2Nzh9LHsieCI6NTg5LjEzNjQxODI2OTIzMDcsInkiOjgwN31d\" marker-end=\"url(#mermaid-c4mmcc8xbsu_flowchart-v2-pointEnd)\"></path><path d=\"M226.375,782L235.427,782C244.479,782,262.583,782,288.632,782C314.68,782,348.672,782,390.575,787.187C432.479,792.374,482.293,802.749,507.2,807.936L532.107,813.123\" id=\"L_Signal_F4_0\" class=\"edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link\" style=\";\" data-edge=\"true\" data-et=\"edge\" data-id=\"L_Signal_F4_0\" data-points=\"W3sieCI6MjI2LjM3NSwieSI6NzgyfSx7IngiOjI4MC42ODc1LCJ5Ijo3ODJ9LHsieCI6MzgyLjY2NDA2MjUsInkiOjc4Mn0seyJ4Ijo1MzYuMDIzNDM3NSwieSI6ODEzLjkzODY3MzM0MTY3NzF9XQ==\" marker-end=\"url(#mermaid-c4mmcc8xbsu_flowchart-v2-pointEnd)\"></path><path d=\"M224.531,886L233.891,886C243.25,886,261.969,886,288.324,886C314.68,886,348.672,886,390.575,880.813C432.479,875.626,482.293,865.251,507.2,860.064L532.107,854.877\" id=\"L_Order_F4_0\" class=\"edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link\" style=\";\" data-edge=\"true\" data-et=\"edge\" data-id=\"L_Order_F4_0\" data-points=\"W3sieCI6MjI0LjUzMTI1LCJ5Ijo4ODZ9LHsieCI6MjgwLjY4NzUsInkiOjg4Nn0seyJ4IjozODIuNjY0MDYyNSwieSI6ODg2fSx7IngiOjUzNi4wMjM0Mzc1LCJ5Ijo4NTQuMDYxMzI2NjU4MzIyOX1d\" marker-end=\"url(#mermaid-c4mmcc8xbsu_flowchart-v2-pointEnd)\"></path><path d=\"M223.703,990L233.201,990C242.698,990,261.693,990,288.186,990C314.68,990,348.672,990,399.515,968.853C450.357,947.706,518.051,905.413,551.897,884.266L585.744,863.119\" id=\"L_Trade_F4_0\" class=\"edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link\" style=\";\" data-edge=\"true\" data-et=\"edge\" data-id=\"L_Trade_F4_0\" data-points=\"W3sieCI6MjIzLjcwMzEyNSwieSI6OTkwfSx7IngiOjI4MC42ODc1LCJ5Ijo5OTB9LHsieCI6MzgyLjY2NDA2MjUsInkiOjk5MH0seyJ4Ijo1ODkuMTM2NDE4MjY5MjMwNywieSI6ODYxfV0=\" marker-end=\"url(#mermaid-c4mmcc8xbsu_flowchart-v2-pointEnd)\"></path><path d=\"M235.719,1094L243.214,1094C250.708,1094,265.698,1094,290.189,1094C314.68,1094,348.672,1094,402.499,1055.648C456.327,1017.295,529.989,940.59,566.821,902.238L603.652,863.885\" id=\"L_DailyBar_F4_0\" class=\"edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link\" style=\";\" data-edge=\"true\" data-et=\"edge\" data-id=\"L_DailyBar_F4_0\" data-points=\"W3sieCI6MjM1LjcxODc1LCJ5IjoxMDk0fSx7IngiOjI4MC42ODc1LCJ5IjoxMDk0fSx7IngiOjM4Mi42NjQwNjI1LCJ5IjoxMDk0fSx7IngiOjYwNi40MjI0NzU5NjE1Mzg1LCJ5Ijo4NjF9XQ==\" marker-end=\"url(#mermaid-c4mmcc8xbsu_flowchart-v2-pointEnd)\"></path><path d=\"M234.578,1198L242.263,1198C249.948,1198,265.318,1198,289.999,1198C314.68,1198,348.672,1198,403.819,1142.383C458.965,1086.766,535.267,975.532,573.417,919.915L611.568,864.299\" id=\"L_MainBar_F4_0\" class=\"edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link\" style=\";\" data-edge=\"true\" data-et=\"edge\" data-id=\"L_MainBar_F4_0\" data-points=\"W3sieCI6MjM0LjU3ODEyNSwieSI6MTE5OH0seyJ4IjoyODAuNjg3NSwieSI6MTE5OH0seyJ4IjozODIuNjY0MDYyNSwieSI6MTE5OH0seyJ4Ijo2MTMuODMwNzg2NDAxMDk4OSwieSI6ODYxfV0=\" marker-end=\"url(#mermaid-c4mmcc8xbsu_flowchart-v2-pointEnd)\"></path><path d=\"M252.367,1342L257.087,1342C261.807,1342,271.247,1342,292.964,1342C314.68,1342,348.672,1342,403.265,1388.979C457.858,1435.959,533.051,1529.918,570.648,1576.897L608.245,1623.877\" id=\"L_UpdateFromShfe_F5_0\" class=\"edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link\" style=\";\" data-edge=\"true\" data-et=\"edge\" data-id=\"L_UpdateFromShfe_F5_0\" data-points=\"W3sieCI6MjUyLjM2NzE4NzUsInkiOjEzNDJ9LHsieCI6MjgwLjY4NzUsInkiOjEzNDJ9LHsieCI6MzgyLjY2NDA2MjUsInkiOjEzNDJ9LHsieCI6NjEwLjc0Mzk5MDM4NDYxNTQsInkiOjE2Mjd9XQ==\" marker-end=\"url(#mermaid-c4mmcc8xbsu_flowchart-v2-pointEnd)\"></path><path d=\"M249.789,1446L254.939,1446C260.089,1446,270.388,1446,292.534,1446C314.68,1446,348.672,1446,401.368,1475.74C454.065,1505.48,525.466,1564.96,561.166,1594.7L596.867,1624.44\" id=\"L_UpdateFromDce_F5_0\" class=\"edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link\" style=\";\" data-edge=\"true\" data-et=\"edge\" data-id=\"L_UpdateFromDce_F5_0\" data-points=\"W3sieCI6MjQ5Ljc4OTA2MjUsInkiOjE0NDZ9LHsieCI6MjgwLjY4NzUsInkiOjE0NDZ9LHsieCI6MzgyLjY2NDA2MjUsInkiOjE0NDZ9LHsieCI6NTk5Ljk0MDIwNDMyNjkyMzEsInkiOjE2Mjd9XQ==\" marker-end=\"url(#mermaid-c4mmcc8xbsu_flowchart-v2-pointEnd)\"></path><path d=\"M253.313,1550L257.875,1550C262.438,1550,271.563,1550,293.121,1550C314.68,1550,348.672,1550,395.863,1562.577C443.055,1575.154,503.446,1600.308,533.641,1612.885L563.836,1625.462\" id=\"L_UpdateFromCzce_F5_0\" class=\"edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link\" style=\";\" data-edge=\"true\" data-et=\"edge\" data-id=\"L_UpdateFromCzce_F5_0\" data-points=\"W3sieCI6MjUzLjMxMjUsInkiOjE1NTB9LHsieCI6MjgwLjY4NzUsInkiOjE1NTB9LHsieCI6MzgyLjY2NDA2MjUsInkiOjE1NTB9LHsieCI6NTY3LjUyODg0NjE1Mzg0NjIsInkiOjE2Mjd9XQ==\" marker-end=\"url(#mermaid-c4mmcc8xbsu_flowchart-v2-pointEnd)\"></path><path d=\"M254.82,1654L259.132,1654C263.443,1654,272.065,1654,293.372,1654C314.68,1654,348.672,1654,389.25,1654C429.828,1654,476.992,1654,500.574,1654L524.156,1654\" id=\"L_UpdateFromCffex_F5_0\" class=\"edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link\" style=\";\" data-edge=\"true\" data-et=\"edge\" data-id=\"L_UpdateFromCffex_F5_0\" data-points=\"W3sieCI6MjU0LjgyMDMxMjUsInkiOjE2NTR9LHsieCI6MjgwLjY4NzUsInkiOjE2NTR9LHsieCI6MzgyLjY2NDA2MjUsInkiOjE2NTR9LHsieCI6NTI4LjE1NjI1LCJ5IjoxNjU0fV0=\" marker-end=\"url(#mermaid-c4mmcc8xbsu_flowchart-v2-pointEnd)\"></path><path d=\"M252.805,1758L257.452,1758C262.099,1758,271.393,1758,293.036,1758C314.68,1758,348.672,1758,395.863,1745.423C443.055,1732.846,503.446,1707.692,533.641,1695.115L563.836,1682.538\" id=\"L_UpdateFromGfex_F5_0\" class=\"edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link\" style=\";\" data-edge=\"true\" data-et=\"edge\" data-id=\"L_UpdateFromGfex_F5_0\" data-points=\"W3sieCI6MjUyLjgwNDY4NzUsInkiOjE3NTh9LHsieCI6MjgwLjY4NzUsInkiOjE3NTh9LHsieCI6MzgyLjY2NDA2MjUsInkiOjE3NTh9LHsieCI6NTY3LjUyODg0NjE1Mzg0NjIsInkiOjE2ODF9XQ==\" marker-end=\"url(#mermaid-c4mmcc8xbsu_flowchart-v2-pointEnd)\"></path><path d=\"M239.094,1862L246.026,1862C252.958,1862,266.823,1862,290.751,1862C314.68,1862,348.672,1862,401.368,1832.26C454.065,1802.52,525.466,1743.04,561.166,1713.3L596.867,1683.56\" id=\"L_CalcMainInst_F5_0\" class=\"edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link\" style=\";\" data-edge=\"true\" data-et=\"edge\" data-id=\"L_CalcMainInst_F5_0\" data-points=\"W3sieCI6MjM5LjA5Mzc1LCJ5IjoxODYyfSx7IngiOjI4MC42ODc1LCJ5IjoxODYyfSx7IngiOjM4Mi42NjQwNjI1LCJ5IjoxODYyfSx7IngiOjU5OS45NDAyMDQzMjY5MjMxLCJ5IjoxNjgxfV0=\" marker-end=\"url(#mermaid-c4mmcc8xbsu_flowchart-v2-pointEnd)\"></path><path d=\"M255.688,1966L259.854,1966C264.021,1966,272.354,1966,293.517,1966C314.68,1966,348.672,1966,403.265,1919.021C457.858,1872.041,533.051,1778.082,570.648,1731.103L608.245,1684.123\" id=\"L_CalcHistorySignal_F5_0\" class=\"edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link\" style=\";\" data-edge=\"true\" data-et=\"edge\" data-id=\"L_CalcHistorySignal_F5_0\" data-points=\"W3sieCI6MjU1LjY4NzUsInkiOjE5NjZ9LHsieCI6MjgwLjY4NzUsInkiOjE5NjZ9LHsieCI6MzgyLjY2NDA2MjUsInkiOjE5NjZ9LHsieCI6NjEwLjc0Mzk5MDM4NDYxNTQsInkiOjE2ODF9XQ==\" marker-end=\"url(#mermaid-c4mmcc8xbsu_flowchart-v2-pointEnd)\"></path><path d=\"M210.883,2110L222.517,2110C234.151,2110,257.419,2110,286.049,2110C314.68,2110,348.672,2110,395.526,2110C442.38,2110,502.096,2110,531.954,2110L561.813,2110\" id=\"L_ConfigIni_F6_0\" class=\"edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link\" style=\";\" data-edge=\"true\" data-et=\"edge\" data-id=\"L_ConfigIni_F6_0\" data-points=\"W3sieCI6MjEwLjg4MjgxMjUsInkiOjIxMTB9LHsieCI6MjgwLjY4NzUsInkiOjIxMTB9LHsieCI6MzgyLjY2NDA2MjUsInkiOjIxMTB9LHsieCI6NTY1LjgxMjUsInkiOjIxMTB9XQ==\" marker-end=\"url(#mermaid-c4mmcc8xbsu_flowchart-v2-pointEnd)\"></path><path d=\"M233.195,2214L241.111,2214C249.026,2214,264.857,2214,289.768,2214C314.68,2214,348.672,2214,384.003,2214C419.333,2214,456.003,2214,474.337,2214L492.672,2214\" id=\"L_ReadConfig_F7_0\" class=\"edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link\" style=\";\" data-edge=\"true\" data-et=\"edge\" data-id=\"L_ReadConfig_F7_0\" data-points=\"W3sieCI6MjMzLjE5NTMxMjUsInkiOjIyMTR9LHsieCI6MjgwLjY4NzUsInkiOjIyMTR9LHsieCI6MzgyLjY2NDA2MjUsInkiOjIyMTR9LHsieCI6NDk2LjY3MTg3NSwieSI6MjIxNH1d\" marker-end=\"url(#mermaid-c4mmcc8xbsu_flowchart-v2-pointEnd)\"></path><path d=\"M233.258,2318L241.163,2318C249.068,2318,264.878,2318,289.779,2318C314.68,2318,348.672,2318,391.797,2318C434.922,2318,487.18,2318,513.309,2318L539.438,2318\" id=\"L_Constants_F8_0\" class=\"edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link\" style=\";\" data-edge=\"true\" data-et=\"edge\" data-id=\"L_Constants_F8_0\" data-points=\"W3sieCI6MjMzLjI1NzgxMjUsInkiOjIzMTh9LHsieCI6MjgwLjY4NzUsInkiOjIzMTh9LHsieCI6MzgyLjY2NDA2MjUsInkiOjIzMTh9LHsieCI6NTQzLjQzNzUsInkiOjIzMTh9XQ==\" marker-end=\"url(#mermaid-c4mmcc8xbsu_flowchart-v2-pointEnd)\"></path></g><g class=\"edgeLabels\"><g class=\"edgeLabel\" transform=\"translate(382.6640625, 82)\"><g class=\"label\" data-id=\"L_TradeStrategyClass_F1_0\" transform=\"translate(-72.3125, -12)\"><foreignObject width=\"144.625\" height=\"24\"><div xmlns=\"http://www.w3.org/1999/xhtml\" class=\"labelBkg\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"edgeLabel\"><p>brother2.py:38-63</p></span></div></foreignObject></g></g><g class=\"edgeLabel\" transform=\"translate(382.6640625, 198)\"><g class=\"label\" data-id=\"L_BaseModuleClass_F2_0\" transform=\"translate(-27.3671875, -12)\"><foreignObject width=\"54.734375\" height=\"24\"><div xmlns=\"http://www.w3.org/1999/xhtml\" class=\"labelBkg\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"edgeLabel\"><p><strong>init</strong>.py</p></span></div></foreignObject></g></g><g class=\"edgeLabel\" transform=\"translate(382.6640625, 314)\"><g class=\"label\" data-id=\"L_CallbackDecorator_F3_0\" transform=\"translate(-70.8828125, -12)\"><foreignObject width=\"141.765625\" height=\"24\"><div xmlns=\"http://www.w3.org/1999/xhtml\" class=\"labelBkg\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"edgeLabel\"><p>func_container.py</p></span></div></foreignObject></g></g><g class=\"edgeLabel\" transform=\"translate(382.6640625, 470)\"><g class=\"label\" data-id=\"L_Broker_F4_0\" transform=\"translate(-66.796875, -12)\"><foreignObject width=\"133.59375\" height=\"24\"><div xmlns=\"http://www.w3.org/1999/xhtml\" class=\"labelBkg\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"edgeLabel\"><p>models.py:61-83</p></span></div></foreignObject></g></g><g class=\"edgeLabel\" transform=\"translate(382.6640625, 574)\"><g class=\"label\" data-id=\"L_Strategy_F4_0\" transform=\"translate(-76.9765625, -12)\"><foreignObject width=\"153.953125\" height=\"24\"><div xmlns=\"http://www.w3.org/1999/xhtml\" class=\"labelBkg\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"edgeLabel\"><p>models.py:104-126</p></span></div></foreignObject></g></g><g class=\"edgeLabel\" transform=\"translate(382.6640625, 678)\"><g class=\"label\" data-id=\"L_Instrument_F4_0\" transform=\"translate(-76.9765625, -12)\"><foreignObject width=\"153.953125\" height=\"24\"><div xmlns=\"http://www.w3.org/1999/xhtml\" class=\"labelBkg\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"edgeLabel\"><p>models.py:146-171</p></span></div></foreignObject></g></g><g class=\"edgeLabel\" transform=\"translate(382.6640625, 782)\"><g class=\"label\" data-id=\"L_Signal_F4_0\" transform=\"translate(-76.9765625, -12)\"><foreignObject width=\"153.953125\" height=\"24\"><div xmlns=\"http://www.w3.org/1999/xhtml\" class=\"labelBkg\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"edgeLabel\"><p>models.py:173-192</p></span></div></foreignObject></g></g><g class=\"edgeLabel\" transform=\"translate(382.6640625, 886)\"><g class=\"label\" data-id=\"L_Order_F4_0\" transform=\"translate(-76.9765625, -12)\"><foreignObject width=\"153.953125\" height=\"24\"><div xmlns=\"http://www.w3.org/1999/xhtml\" class=\"labelBkg\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"edgeLabel\"><p>models.py:237-260</p></span></div></foreignObject></g></g><g class=\"edgeLabel\" transform=\"translate(382.6640625, 990)\"><g class=\"label\" data-id=\"L_Trade_F4_0\" transform=\"translate(-76.9765625, -12)\"><foreignObject width=\"153.953125\" height=\"24\"><div xmlns=\"http://www.w3.org/1999/xhtml\" class=\"labelBkg\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"edgeLabel\"><p>models.py:262-289</p></span></div></foreignObject></g></g><g class=\"edgeLabel\" transform=\"translate(382.6640625, 1094)\"><g class=\"label\" data-id=\"L_DailyBar_F4_0\" transform=\"translate(-76.9765625, -12)\"><foreignObject width=\"153.953125\" height=\"24\"><div xmlns=\"http://www.w3.org/1999/xhtml\" class=\"labelBkg\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"edgeLabel\"><p>models.py:216-235</p></span></div></foreignObject></g></g><g class=\"edgeLabel\" transform=\"translate(382.6640625, 1198)\"><g class=\"label\" data-id=\"L_MainBar_F4_0\" transform=\"translate(-76.9765625, -12)\"><foreignObject width=\"153.953125\" height=\"24\"><div xmlns=\"http://www.w3.org/1999/xhtml\" class=\"labelBkg\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"edgeLabel\"><p>models.py:194-214</p></span></div></foreignObject></g></g><g class=\"edgeLabel\" transform=\"translate(382.6640625, 1342)\"><g class=\"label\" data-id=\"L_UpdateFromShfe_F5_0\" transform=\"translate(-62.90625, -12)\"><foreignObject width=\"125.8125\" height=\"24\"><div xmlns=\"http://www.w3.org/1999/xhtml\" class=\"labelBkg\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"edgeLabel\"><p><strong>init</strong>.py:121-174</p></span></div></foreignObject></g></g><g class=\"edgeLabel\" transform=\"translate(382.6640625, 1446)\"><g class=\"label\" data-id=\"L_UpdateFromDce_F5_0\" transform=\"translate(-62.90625, -12)\"><foreignObject width=\"125.8125\" height=\"24\"><div xmlns=\"http://www.w3.org/1999/xhtml\" class=\"labelBkg\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"edgeLabel\"><p><strong>init</strong>.py:220-265</p></span></div></foreignObject></g></g><g class=\"edgeLabel\" transform=\"translate(382.6640625, 1550)\"><g class=\"label\" data-id=\"L_UpdateFromCzce_F5_0\" transform=\"translate(-62.90625, -12)\"><foreignObject width=\"125.8125\" height=\"24\"><div xmlns=\"http://www.w3.org/1999/xhtml\" class=\"labelBkg\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"edgeLabel\"><p><strong>init</strong>.py:177-217</p></span></div></foreignObject></g></g><g class=\"edgeLabel\" transform=\"translate(382.6640625, 1654)\"><g class=\"label\" data-id=\"L_UpdateFromCffex_F5_0\" transform=\"translate(-62.90625, -12)\"><foreignObject width=\"125.8125\" height=\"24\"><div xmlns=\"http://www.w3.org/1999/xhtml\" class=\"labelBkg\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"edgeLabel\"><p><strong>init</strong>.py:296-349</p></span></div></foreignObject></g></g><g class=\"edgeLabel\" transform=\"translate(382.6640625, 1758)\"><g class=\"label\" data-id=\"L_UpdateFromGfex_F5_0\" transform=\"translate(-62.90625, -12)\"><foreignObject width=\"125.8125\" height=\"24\"><div xmlns=\"http://www.w3.org/1999/xhtml\" class=\"labelBkg\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"edgeLabel\"><p><strong>init</strong>.py:268-293</p></span></div></foreignObject></g></g><g class=\"edgeLabel\" transform=\"translate(382.6640625, 1862)\"><g class=\"label\" data-id=\"L_CalcMainInst_F5_0\" transform=\"translate(-62.90625, -12)\"><foreignObject width=\"125.8125\" height=\"24\"><div xmlns=\"http://www.w3.org/1999/xhtml\" class=\"labelBkg\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"edgeLabel\"><p><strong>init</strong>.py:381-421</p></span></div></foreignObject></g></g><g class=\"edgeLabel\" transform=\"translate(382.6640625, 1966)\"><g class=\"label\" data-id=\"L_CalcHistorySignal_F5_0\" transform=\"translate(-62.90625, -12)\"><foreignObject width=\"125.8125\" height=\"24\"><div xmlns=\"http://www.w3.org/1999/xhtml\" class=\"labelBkg\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"edgeLabel\"><p><strong>init</strong>.py:500-600</p></span></div></foreignObject></g></g><g class=\"edgeLabel\" transform=\"translate(382.6640625, 2110)\"><g class=\"label\" data-id=\"L_ConfigIni_F6_0\" transform=\"translate(-36.5390625, -12)\"><foreignObject width=\"73.078125\" height=\"24\"><div xmlns=\"http://www.w3.org/1999/xhtml\" class=\"labelBkg\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"edgeLabel\"><p>config.ini</p></span></div></foreignObject></g></g><g class=\"edgeLabel\" transform=\"translate(382.6640625, 2214)\"><g class=\"label\" data-id=\"L_ReadConfig_F7_0\" transform=\"translate(-58.8515625, -12)\"><foreignObject width=\"117.703125\" height=\"24\"><div xmlns=\"http://www.w3.org/1999/xhtml\" class=\"labelBkg\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"edgeLabel\"><p>read_config.py</p></span></div></foreignObject></g></g><g class=\"edgeLabel\" transform=\"translate(382.6640625, 2318)\"><g class=\"label\" data-id=\"L_Constants_F8_0\" transform=\"translate(-34.0234375, -12)\"><foreignObject width=\"68.046875\" height=\"24\"><div xmlns=\"http://www.w3.org/1999/xhtml\" class=\"labelBkg\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"edgeLabel\"><p>const.py</p></span></div></foreignObject></g></g></g><g class=\"nodes\"><g class=\"node default\" id=\"flowchart-TradeStrategyClass-0\" transform=\"translate(144.34375, 82)\"><rect class=\"basic label-container\" style=\"\" x=\"-108.5859375\" y=\"-39\" width=\"217.171875\" height=\"78\"></rect><g class=\"label\" style=\"\" transform=\"translate(-78.5859375, -24)\"><rect></rect><foreignObject width=\"157.171875\" height=\"48\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"nodeLabel\"><p>TradeStrategy class<br>227.43 importance</p></span></div></foreignObject></g></g><g class=\"node default\" id=\"flowchart-BaseModuleClass-1\" transform=\"translate(144.34375, 198)\"><rect class=\"basic label-container\" style=\"\" x=\"-100.9765625\" y=\"-27\" width=\"201.953125\" height=\"54\"></rect><g class=\"label\" style=\"\" transform=\"translate(-70.9765625, -12)\"><rect></rect><foreignObject width=\"141.953125\" height=\"24\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"nodeLabel\"><p>BaseModule class</p></span></div></foreignObject></g></g><g class=\"node default\" id=\"flowchart-CallbackDecorator-2\" transform=\"translate(144.34375, 314)\"><rect class=\"basic label-container\" style=\"\" x=\"-104.8828125\" y=\"-39\" width=\"209.765625\" height=\"78\"></rect><g class=\"label\" style=\"\" transform=\"translate(-74.8828125, -24)\"><rect></rect><foreignObject width=\"149.765625\" height=\"48\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"nodeLabel\"><p>@RegisterCallback<br>decorator</p></span></div></foreignObject></g></g><g class=\"node default\" id=\"flowchart-Broker-3\" transform=\"translate(144.34375, 470)\"><rect class=\"basic label-container\" style=\"\" x=\"-83.5078125\" y=\"-27\" width=\"167.015625\" height=\"54\"></rect><g class=\"label\" style=\"\" transform=\"translate(-53.5078125, -12)\"><rect></rect><foreignObject width=\"107.015625\" height=\"24\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"nodeLabel\"><p>Broker model</p></span></div></foreignObject></g></g><g class=\"node default\" id=\"flowchart-Strategy-4\" transform=\"translate(144.34375, 574)\"><rect class=\"basic label-container\" style=\"\" x=\"-91.734375\" y=\"-27\" width=\"183.46875\" height=\"54\"></rect><g class=\"label\" style=\"\" transform=\"translate(-61.734375, -12)\"><rect></rect><foreignObject width=\"123.46875\" height=\"24\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"nodeLabel\"><p>Strategy model</p></span></div></foreignObject></g></g><g class=\"node default\" id=\"flowchart-Instrument-5\" transform=\"translate(144.34375, 678)\"><rect class=\"basic label-container\" style=\"\" x=\"-101.46875\" y=\"-27\" width=\"202.9375\" height=\"54\"></rect><g class=\"label\" style=\"\" transform=\"translate(-71.46875, -12)\"><rect></rect><foreignObject width=\"142.9375\" height=\"24\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"nodeLabel\"><p>Instrument model</p></span></div></foreignObject></g></g><g class=\"node default\" id=\"flowchart-Signal-6\" transform=\"translate(144.34375, 782)\"><rect class=\"basic label-container\" style=\"\" x=\"-82.03125\" y=\"-27\" width=\"164.0625\" height=\"54\"></rect><g class=\"label\" style=\"\" transform=\"translate(-52.03125, -12)\"><rect></rect><foreignObject width=\"104.0625\" height=\"24\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"nodeLabel\"><p>Signal model</p></span></div></foreignObject></g></g><g class=\"node default\" id=\"flowchart-Order-7\" transform=\"translate(144.34375, 886)\"><rect class=\"basic label-container\" style=\"\" x=\"-80.1875\" y=\"-27\" width=\"160.375\" height=\"54\"></rect><g class=\"label\" style=\"\" transform=\"translate(-50.1875, -12)\"><rect></rect><foreignObject width=\"100.375\" height=\"24\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"nodeLabel\"><p>Order model</p></span></div></foreignObject></g></g><g class=\"node default\" id=\"flowchart-Trade-8\" transform=\"translate(144.34375, 990)\"><rect class=\"basic label-container\" style=\"\" x=\"-79.359375\" y=\"-27\" width=\"158.71875\" height=\"54\"></rect><g class=\"label\" style=\"\" transform=\"translate(-49.359375, -12)\"><rect></rect><foreignObject width=\"98.71875\" height=\"24\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"nodeLabel\"><p>Trade model</p></span></div></foreignObject></g></g><g class=\"node default\" id=\"flowchart-DailyBar-9\" transform=\"translate(144.34375, 1094)\"><rect class=\"basic label-container\" style=\"\" x=\"-91.375\" y=\"-27\" width=\"182.75\" height=\"54\"></rect><g class=\"label\" style=\"\" transform=\"translate(-61.375, -12)\"><rect></rect><foreignObject width=\"122.75\" height=\"24\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"nodeLabel\"><p>DailyBar model</p></span></div></foreignObject></g></g><g class=\"node default\" id=\"flowchart-MainBar-10\" transform=\"translate(144.34375, 1198)\"><rect class=\"basic label-container\" style=\"\" x=\"-90.234375\" y=\"-27\" width=\"180.46875\" height=\"54\"></rect><g class=\"label\" style=\"\" transform=\"translate(-60.234375, -12)\"><rect></rect><foreignObject width=\"120.46875\" height=\"24\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"nodeLabel\"><p>MainBar model</p></span></div></foreignObject></g></g><g class=\"node default\" id=\"flowchart-UpdateFromShfe-11\" transform=\"translate(144.34375, 1342)\"><rect class=\"basic label-container\" style=\"\" x=\"-108.0234375\" y=\"-27\" width=\"216.046875\" height=\"54\"></rect><g class=\"label\" style=\"\" transform=\"translate(-78.0234375, -12)\"><rect></rect><foreignObject width=\"156.046875\" height=\"24\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"nodeLabel\"><p>update_from_shfe()</p></span></div></foreignObject></g></g><g class=\"node default\" id=\"flowchart-UpdateFromDce-12\" transform=\"translate(144.34375, 1446)\"><rect class=\"basic label-container\" style=\"\" x=\"-105.4453125\" y=\"-27\" width=\"210.890625\" height=\"54\"></rect><g class=\"label\" style=\"\" transform=\"translate(-75.4453125, -12)\"><rect></rect><foreignObject width=\"150.890625\" height=\"24\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"nodeLabel\"><p>update_from_dce()</p></span></div></foreignObject></g></g><g class=\"node default\" id=\"flowchart-UpdateFromCzce-13\" transform=\"translate(144.34375, 1550)\"><rect class=\"basic label-container\" style=\"\" x=\"-108.96875\" y=\"-27\" width=\"217.9375\" height=\"54\"></rect><g class=\"label\" style=\"\" transform=\"translate(-78.96875, -12)\"><rect></rect><foreignObject width=\"157.9375\" height=\"24\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"nodeLabel\"><p>update_from_czce()</p></span></div></foreignObject></g></g><g class=\"node default\" id=\"flowchart-UpdateFromCffex-14\" transform=\"translate(144.34375, 1654)\"><rect class=\"basic label-container\" style=\"\" x=\"-110.4765625\" y=\"-27\" width=\"220.953125\" height=\"54\"></rect><g class=\"label\" style=\"\" transform=\"translate(-80.4765625, -12)\"><rect></rect><foreignObject width=\"160.953125\" height=\"24\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"nodeLabel\"><p>update_from_cffex()</p></span></div></foreignObject></g></g><g class=\"node default\" id=\"flowchart-UpdateFromGfex-15\" transform=\"translate(144.34375, 1758)\"><rect class=\"basic label-container\" style=\"\" x=\"-108.4609375\" y=\"-27\" width=\"216.921875\" height=\"54\"></rect><g class=\"label\" style=\"\" transform=\"translate(-78.4609375, -12)\"><rect></rect><foreignObject width=\"156.921875\" height=\"24\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"nodeLabel\"><p>update_from_gfex()</p></span></div></foreignObject></g></g><g class=\"node default\" id=\"flowchart-CalcMainInst-16\" transform=\"translate(144.34375, 1862)\"><rect class=\"basic label-container\" style=\"\" x=\"-94.75\" y=\"-27\" width=\"189.5\" height=\"54\"></rect><g class=\"label\" style=\"\" transform=\"translate(-64.75, -12)\"><rect></rect><foreignObject width=\"129.5\" height=\"24\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"nodeLabel\"><p>calc_main_inst()</p></span></div></foreignObject></g></g><g class=\"node default\" id=\"flowchart-CalcHistorySignal-17\" transform=\"translate(144.34375, 1966)\"><rect class=\"basic label-container\" style=\"\" x=\"-111.34375\" y=\"-27\" width=\"222.6875\" height=\"54\"></rect><g class=\"label\" style=\"\" transform=\"translate(-81.34375, -12)\"><rect></rect><foreignObject width=\"162.6875\" height=\"24\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"nodeLabel\"><p>calc_history_signal()</p></span></div></foreignObject></g></g><g class=\"node default\" id=\"flowchart-ConfigIni-18\" transform=\"translate(144.34375, 2110)\"><rect class=\"basic label-container\" style=\"\" x=\"-66.5390625\" y=\"-27\" width=\"133.078125\" height=\"54\"></rect><g class=\"label\" style=\"\" transform=\"translate(-36.5390625, -12)\"><rect></rect><foreignObject width=\"73.078125\" height=\"24\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"nodeLabel\"><p>config.ini</p></span></div></foreignObject></g></g><g class=\"node default\" id=\"flowchart-ReadConfig-19\" transform=\"translate(144.34375, 2214)\"><rect class=\"basic label-container\" style=\"\" x=\"-88.8515625\" y=\"-27\" width=\"177.703125\" height=\"54\"></rect><g class=\"label\" style=\"\" transform=\"translate(-58.8515625, -12)\"><rect></rect><foreignObject width=\"117.703125\" height=\"24\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"nodeLabel\"><p>read_config.py</p></span></div></foreignObject></g></g><g class=\"node default\" id=\"flowchart-Constants-20\" transform=\"translate(144.34375, 2318)\"><rect class=\"basic label-container\" style=\"\" x=\"-88.9140625\" y=\"-27\" width=\"177.828125\" height=\"54\"></rect><g class=\"label\" style=\"\" transform=\"translate(-58.9140625, -12)\"><rect></rect><foreignObject width=\"117.828125\" height=\"24\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"nodeLabel\"><p>panel/const.py</p></span></div></foreignObject></g></g><g class=\"node default\" id=\"flowchart-F1-22\" transform=\"translate(632.3515625, 82)\"><rect class=\"basic label-container\" style=\"\" x=\"-140.328125\" y=\"-27\" width=\"280.65625\" height=\"54\"></rect><g class=\"label\" style=\"\" transform=\"translate(-110.328125, -12)\"><rect></rect><foreignObject width=\"220.65625\" height=\"24\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: table; white-space: break-spaces; line-height: 1.5; max-width: 200px; text-align: center; width: 200px;\"><span class=\"nodeLabel\"><p>trader/strategy/brother2.py</p></span></div></foreignObject></g></g><g class=\"node default\" id=\"flowchart-F2-24\" transform=\"translate(632.3515625, 198)\"><rect class=\"basic label-container\" style=\"\" x=\"-120.7421875\" y=\"-27\" width=\"241.484375\" height=\"54\"></rect><g class=\"label\" style=\"\" transform=\"translate(-90.7421875, -12)\"><rect></rect><foreignObject width=\"181.484375\" height=\"24\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"nodeLabel\"><p>trader/strategy/<strong>init</strong>.py</p></span></div></foreignObject></g></g><g class=\"node default\" id=\"flowchart-F3-26\" transform=\"translate(632.3515625, 314)\"><rect class=\"basic label-container\" style=\"\" x=\"-147.7109375\" y=\"-27\" width=\"295.421875\" height=\"54\"></rect><g class=\"label\" style=\"\" transform=\"translate(-117.7109375, -12)\"><rect></rect><foreignObject width=\"235.421875\" height=\"24\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: table; white-space: break-spaces; line-height: 1.5; max-width: 200px; text-align: center; width: 200px;\"><span class=\"nodeLabel\"><p>trader/utils/func_container.py</p></span></div></foreignObject></g></g><g class=\"node default\" id=\"flowchart-F4-28\" transform=\"translate(632.3515625, 834)\"><rect class=\"basic label-container\" style=\"\" x=\"-96.328125\" y=\"-27\" width=\"192.65625\" height=\"54\"></rect><g class=\"label\" style=\"\" transform=\"translate(-66.328125, -12)\"><rect></rect><foreignObject width=\"132.65625\" height=\"24\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"nodeLabel\"><p>panel/models.py</p></span></div></foreignObject></g></g><g class=\"node default\" id=\"flowchart-F5-44\" transform=\"translate(632.3515625, 1654)\"><rect class=\"basic label-container\" style=\"\" x=\"-104.1953125\" y=\"-27\" width=\"208.390625\" height=\"54\"></rect><g class=\"label\" style=\"\" transform=\"translate(-74.1953125, -12)\"><rect></rect><foreignObject width=\"148.390625\" height=\"24\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"nodeLabel\"><p>trader/utils/<strong>init</strong>.py</p></span></div></foreignObject></g></g><g class=\"node default\" id=\"flowchart-F6-58\" transform=\"translate(632.3515625, 2110)\"><rect class=\"basic label-container\" style=\"\" x=\"-66.5390625\" y=\"-27\" width=\"133.078125\" height=\"54\"></rect><g class=\"label\" style=\"\" transform=\"translate(-36.5390625, -12)\"><rect></rect><foreignObject width=\"73.078125\" height=\"24\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"nodeLabel\"><p>config.ini</p></span></div></foreignObject></g></g><g class=\"node default\" id=\"flowchart-F7-60\" transform=\"translate(632.3515625, 2214)\"><rect class=\"basic label-container\" style=\"\" x=\"-135.6796875\" y=\"-27\" width=\"271.359375\" height=\"54\"></rect><g class=\"label\" style=\"\" transform=\"translate(-105.6796875, -12)\"><rect></rect><foreignObject width=\"211.359375\" height=\"24\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: table; white-space: break-spaces; line-height: 1.5; max-width: 200px; text-align: center; width: 200px;\"><span class=\"nodeLabel\"><p>trader/utils/read_config.py</p></span></div></foreignObject></g></g><g class=\"node default\" id=\"flowchart-F8-62\" transform=\"translate(632.3515625, 2318)\"><rect class=\"basic label-container\" style=\"\" x=\"-88.9140625\" y=\"-27\" width=\"177.828125\" height=\"54\"></rect><g class=\"label\" style=\"\" transform=\"translate(-58.9140625, -12)\"><rect></rect><foreignObject width=\"117.828125\" height=\"24\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"nodeLabel\"><p>panel/const.py</p></span></div></foreignObject></g></g></g></g></g></svg></div><div class=\"absolute right-2 top-2 flex items-center gap-1 opacity-0 transition-opacity group-hover:opacity-100\"><button class=\"cursor-pointer rounded-sm p-1 text-[#333] opacity-70 transition-opacity hover:opacity-100 dark:text-white\" aria-label=\"Zoom in\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"16\" height=\"16\" fill=\"currentColor\" viewBox=\"0 0 256 256\"><path d=\"M224,128a8,8,0,0,1-8,8H136v80a8,8,0,0,1-16,0V136H40a8,8,0,0,1,0-16h80V40a8,8,0,0,1,16,0v80h80A8,8,0,0,1,224,128Z\"></path></svg></button><button class=\"cursor-pointer rounded-sm p-1 text-[#333] opacity-70 transition-opacity hover:opacity-100 dark:text-white\" aria-label=\"Zoom out\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"16\" height=\"16\" fill=\"currentColor\" viewBox=\"0 0 256 256\"><path d=\"M224,128a8,8,0,0,1-8,8H40a8,8,0,0,1,0-16H216A8,8,0,0,1,224,128Z\"></path></svg></button><div class=\"rounded-sm p-1\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"16\" height=\"16\" fill=\"currentColor\" viewBox=\"0 0 256 256\" class=\"text-[#333] dark:text-white\"><path d=\"M216,48V96a8,8,0,0,1-16,0V67.31l-42.34,42.35a8,8,0,0,1-11.32-11.32L188.69,56H160a8,8,0,0,1,0-16h48A8,8,0,0,1,216,48ZM98.34,146.34,56,188.69V160a8,8,0,0,0-16,0v48a8,8,0,0,0,8,8H96a8,8,0,0,0,0-16H67.31l42.35-42.34a8,8,0,0,0-11.32-11.32ZM208,152a8,8,0,0,0-8,8v28.69l-42.34-42.35a8,8,0,0,0-11.32,11.32L188.69,200H160a8,8,0,0,0,0,16h48a8,8,0,0,0,8-8V160A8,8,0,0,0,208,152ZM67.31,56H96a8,8,0,0,0,0-16H48a8,8,0,0,0-8,8V96a8,8,0,0,0,16,0V67.31l42.34,42.35a8,8,0,0,0,11.32-11.32Z\"></path></svg></div></div></div></pre>\n<p><strong>Sources</strong>: <a href=\"https://github.com/timercrack/trader/blob/3307c308/trader/strategy/brother2.py#L38-L63\" target=\"_blank\" rel=\"noopener noreferrer\" class=\"mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75\"><span class=\"flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4]\"><svg class=\"mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block\" fill=\"currentColor\" viewBox=\"0 0 24 24\"><path d=\"M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z\"></path></svg>trader/strategy/brother2.py</span><span class=\"flex flex-shrink-0 items-center rounded-r border-l px-2 py-1.5 border-[#dddddd] bg-[#d8d8d8] text-[#666666] dark:border-[#333333] dark:bg-[#2a2a2a] dark:text-[#888888]\">38-63</span></a> <a href=\"https://github.com/timercrack/trader/blob/3307c308/trader/strategy/__init__.py#L1-L100\" target=\"_blank\" rel=\"noopener noreferrer\" class=\"mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75\"><span class=\"flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4]\"><svg class=\"mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block\" fill=\"currentColor\" viewBox=\"0 0 24 24\"><path d=\"M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z\"></path></svg>trader/strategy/__init__.py</span><span class=\"flex flex-shrink-0 items-center rounded-r border-l px-2 py-1.5 border-[#dddddd] bg-[#d8d8d8] text-[#666666] dark:border-[#333333] dark:bg-[#2a2a2a] dark:text-[#888888]\">1-100</span></a> <a href=\"https://github.com/timercrack/trader/blob/3307c308/panel/models.py#L42-L289\" target=\"_blank\" rel=\"noopener noreferrer\" class=\"mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75\"><span class=\"flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4]\"><svg class=\"mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block\" fill=\"currentColor\" viewBox=\"0 0 24 24\"><path d=\"M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z\"></path></svg>panel/models.py</span><span class=\"flex flex-shrink-0 items-center rounded-r border-l px-2 py-1.5 border-[#dddddd] bg-[#d8d8d8] text-[#666666] dark:border-[#333333] dark:bg-[#2a2a2a] dark:text-[#888888]\">42-289</span></a> <a href=\"https://github.com/timercrack/trader/blob/3307c308/trader/utils/__init__.py#L121-L600\" target=\"_blank\" rel=\"noopener noreferrer\" class=\"mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75\"><span class=\"flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4]\"><svg class=\"mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block\" fill=\"currentColor\" viewBox=\"0 0 24 24\"><path d=\"M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z\"></path></svg>trader/utils/__init__.py</span><span class=\"flex flex-shrink-0 items-center rounded-r border-l px-2 py-1.5 border-[#dddddd] bg-[#d8d8d8] text-[#666666] dark:border-[#333333] dark:bg-[#2a2a2a] dark:text-[#888888]\">121-600</span></a> <a href=\"https://github.com/timercrack/trader/blob/3307c308/trader/utils/read_config.py#L1-L50\" target=\"_blank\" rel=\"noopener noreferrer\" class=\"mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75\"><span class=\"flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4]\"><svg class=\"mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block\" fill=\"currentColor\" viewBox=\"0 0 24 24\"><path d=\"M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z\"></path></svg>trader/utils/read_config.py</span><span class=\"flex flex-shrink-0 items-center rounded-r border-l px-2 py-1.5 border-[#dddddd] bg-[#d8d8d8] text-[#666666] dark:border-[#333333] dark:bg-[#2a2a2a] dark:text-[#888888]\">1-50</span></a> <a href=\"https://github.com/timercrack/trader/blob/3307c308/panel/const.py#L1-L100\" target=\"_blank\" rel=\"noopener noreferrer\" class=\"mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75\"><span class=\"flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4]\"><svg class=\"mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block\" fill=\"currentColor\" viewBox=\"0 0 24 24\"><path d=\"M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z\"></path></svg>panel/const.py</span><span class=\"flex flex-shrink-0 items-center rounded-r border-l px-2 py-1.5 border-[#dddddd] bg-[#d8d8d8] text-[#666666] dark:border-[#333333] dark:bg-[#2a2a2a] dark:text-[#888888]\">1-100</span></a></p>\n<h2 id=\"core-components\" class=\"group\" data-header=\"true\">Core Components<button class=\"relative ml-2 cursor-pointer align-baseline text-gray-400 opacity-0 transition-opacity hover:text-blue-400 focus:opacity-100 group-hover:opacity-100\" aria-label=\"Copy link to header\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"1em\" height=\"1em\" fill=\"currentColor\" viewBox=\"0 0 256 256\" class=\"h-4 w-4\"><path d=\"M117.18,188.74a12,12,0,0,1,0,17l-5.12,5.12A58.26,58.26,0,0,1,70.6,228h0A58.62,58.62,0,0,1,29.14,127.92L63.89,93.17a58.64,58.64,0,0,1,98.56,28.11,12,12,0,1,1-23.37,5.44,34.65,34.65,0,0,0-58.22-16.58L46.11,144.89A34.62,34.62,0,0,0,70.57,204h0a34.41,34.41,0,0,0,24.49-10.14l5.11-5.12A12,12,0,0,1,117.18,188.74ZM226.83,45.17a58.65,58.65,0,0,0-82.93,0l-5.11,5.11a12,12,0,0,0,17,17l5.12-5.12a34.63,34.63,0,1,1,49,49L175.1,145.86A34.39,34.39,0,0,1,150.61,156h0a34.63,34.63,0,0,1-33.69-26.72,12,12,0,0,0-23.38,5.44A58.64,58.64,0,0,0,150.56,180h.05a58.28,58.28,0,0,0,41.47-17.17l34.75-34.75a58.62,58.62,0,0,0,0-82.91Z\"></path></svg></button></h2>\n<h3 id=\"trading-strategy-engine\" class=\"group\" data-header=\"true\">Trading Strategy Engine<button class=\"relative ml-2 cursor-pointer align-baseline text-gray-400 opacity-0 transition-opacity hover:text-blue-400 focus:opacity-100 group-hover:opacity-100\" aria-label=\"Copy link to header\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"1em\" height=\"1em\" fill=\"currentColor\" viewBox=\"0 0 256 256\" class=\"h-4 w-4\"><path d=\"M117.18,188.74a12,12,0,0,1,0,17l-5.12,5.12A58.26,58.26,0,0,1,70.6,228h0A58.62,58.62,0,0,1,29.14,127.92L63.89,93.17a58.64,58.64,0,0,1,98.56,28.11,12,12,0,1,1-23.37,5.44,34.65,34.65,0,0,0-58.22-16.58L46.11,144.89A34.62,34.62,0,0,0,70.57,204h0a34.41,34.41,0,0,0,24.49-10.14l5.11-5.12A12,12,0,0,1,117.18,188.74ZM226.83,45.17a58.65,58.65,0,0,0-82.93,0l-5.11,5.11a12,12,0,0,0,17,17l5.12-5.12a34.63,34.63,0,1,1,49,49L175.1,145.86A34.39,34.39,0,0,1,150.61,156h0a34.63,34.63,0,0,1-33.69-26.72,12,12,0,0,0-23.38,5.44A58.64,58.64,0,0,0,150.56,180h.05a58.28,58.28,0,0,0,41.47-17.17l34.75-34.75a58.62,58.62,0,0,0,0-82.91Z\"></path></svg></button></h3>\n<p>The <code class=\"rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30\">TradeStrategy</code> class (<a href=\"https://github.com/timercrack/trader/blob/3307c308/trader/strategy/brother2.py#L38-L1050\" target=\"_blank\" rel=\"noopener noreferrer\" class=\"mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75\"><span class=\"flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4]\"><svg class=\"mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block\" fill=\"currentColor\" viewBox=\"0 0 24 24\"><path d=\"M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z\"></path></svg>trader/strategy/brother2.py</span><span class=\"flex flex-shrink-0 items-center rounded-r border-l px-2 py-1.5 border-[#dddddd] bg-[#d8d8d8] text-[#666666] dark:border-[#333333] dark:bg-[#2a2a2a] dark:text-[#888888]\">38-1050</span></a>) is the heart of the system with an importance score of 227.43. It extends <code class=\"rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30\">BaseModule</code> to provide:</p>\n<ul>\n<li><strong>Signal Processing</strong>: Three scheduled windows (08:55, 09:25, 20:55) for processing different market sessions</li>\n<li><strong>Order Execution</strong>: <code class=\"rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30\">ReqOrderInsert()</code> generates CTP order requests published to Redis</li>\n<li><strong>Position Tracking</strong>: <code class=\"rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30\">refresh_position()</code> synchronizes local state with CTP account data</li>\n<li><strong>Risk Management</strong>: Automatic retry logic for rejected orders and position sizing based on ATR</li>\n</ul>\n<p>Key methods:</p>\n<ul>\n<li><code class=\"rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30\">calc_signal()</code>: Generates trading signals using technical indicators (<a href=\"https://github.com/timercrack/trader/blob/3307c308/trader/strategy/brother2.py#L725-L850\" target=\"_blank\" rel=\"noopener noreferrer\" class=\"mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75\"><span class=\"flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4]\"><svg class=\"mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block\" fill=\"currentColor\" viewBox=\"0 0 24 24\"><path d=\"M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z\"></path></svg>trader/strategy/brother2.py</span><span class=\"flex flex-shrink-0 items-center rounded-r border-l px-2 py-1.5 border-[#dddddd] bg-[#d8d8d8] text-[#666666] dark:border-[#333333] dark:bg-[#2a2a2a] dark:text-[#888888]\">725-850</span></a>)</li>\n<li><code class=\"rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30\">refresh_account()</code>: Updates account balance and margin (<a href=\"https://github.com/timercrack/trader/blob/3307c308/trader/strategy/brother2.py#L86-L112\" target=\"_blank\" rel=\"noopener noreferrer\" class=\"mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75\"><span class=\"flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4]\"><svg class=\"mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block\" fill=\"currentColor\" viewBox=\"0 0 24 24\"><path d=\"M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z\"></path></svg>trader/strategy/brother2.py</span><span class=\"flex flex-shrink-0 items-center rounded-r border-l px-2 py-1.5 border-[#dddddd] bg-[#d8d8d8] text-[#666666] dark:border-[#333333] dark:bg-[#2a2a2a] dark:text-[#888888]\">86-112</span></a>)</li>\n<li><code class=\"rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30\">OnRtnTrade()</code>: Handles trade confirmations from CTP (<a href=\"https://github.com/timercrack/trader/blob/3307c308/trader/strategy/brother2.py#L391-L469\" target=\"_blank\" rel=\"noopener noreferrer\" class=\"mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75\"><span class=\"flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4]\"><svg class=\"mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block\" fill=\"currentColor\" viewBox=\"0 0 24 24\"><path d=\"M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z\"></path></svg>trader/strategy/brother2.py</span><span class=\"flex flex-shrink-0 items-center rounded-r border-l px-2 py-1.5 border-[#dddddd] bg-[#d8d8d8] text-[#666666] dark:border-[#333333] dark:bg-[#2a2a2a] dark:text-[#888888]\">391-469</span></a>)</li>\n<li><code class=\"rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30\">OnRtnOrder()</code>: Processes order status updates (<a href=\"https://github.com/timercrack/trader/blob/3307c308/trader/strategy/brother2.py#L510-L566\" target=\"_blank\" rel=\"noopener noreferrer\" class=\"mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75\"><span class=\"flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4]\"><svg class=\"mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block\" fill=\"currentColor\" viewBox=\"0 0 24 24\"><path d=\"M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z\"></path></svg>trader/strategy/brother2.py</span><span class=\"flex flex-shrink-0 items-center rounded-r border-l px-2 py-1.5 border-[#dddddd] bg-[#d8d8d8] text-[#666666] dark:border-[#333333] dark:bg-[#2a2a2a] dark:text-[#888888]\">510-566</span></a>)</li>\n</ul>\n<p><strong>Sources</strong>: <a href=\"https://github.com/timercrack/trader/blob/3307c308/trader/strategy/brother2.py#L38-L850\" target=\"_blank\" rel=\"noopener noreferrer\" class=\"mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75\"><span class=\"flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4]\"><svg class=\"mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block\" fill=\"currentColor\" viewBox=\"0 0 24 24\"><path d=\"M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z\"></path></svg>trader/strategy/brother2.py</span><span class=\"flex flex-shrink-0 items-center rounded-r border-l px-2 py-1.5 border-[#dddddd] bg-[#d8d8d8] text-[#666666] dark:border-[#333333] dark:bg-[#2a2a2a] dark:text-[#888888]\">38-850</span></a></p>\n<h3 id=\"data-models\" class=\"group\" data-header=\"true\">Data Models<button class=\"relative ml-2 cursor-pointer align-baseline text-gray-400 opacity-0 transition-opacity hover:text-blue-400 focus:opacity-100 group-hover:opacity-100\" aria-label=\"Copy link to header\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"1em\" height=\"1em\" fill=\"currentColor\" viewBox=\"0 0 256 256\" class=\"h-4 w-4\"><path d=\"M117.18,188.74a12,12,0,0,1,0,17l-5.12,5.12A58.26,58.26,0,0,1,70.6,228h0A58.62,58.62,0,0,1,29.14,127.92L63.89,93.17a58.64,58.64,0,0,1,98.56,28.11,12,12,0,1,1-23.37,5.44,34.65,34.65,0,0,0-58.22-16.58L46.11,144.89A34.62,34.62,0,0,0,70.57,204h0a34.41,34.41,0,0,0,24.49-10.14l5.11-5.12A12,12,0,0,1,117.18,188.74ZM226.83,45.17a58.65,58.65,0,0,0-82.93,0l-5.11,5.11a12,12,0,0,0,17,17l5.12-5.12a34.63,34.63,0,1,1,49,49L175.1,145.86A34.39,34.39,0,0,1,150.61,156h0a34.63,34.63,0,0,1-33.69-26.72,12,12,0,0,0-23.38,5.44A58.64,58.64,0,0,0,150.56,180h.05a58.28,58.28,0,0,0,41.47-17.17l34.75-34.75a58.62,58.62,0,0,0,0-82.91Z\"></path></svg></button></h3>\n<p>The system uses Django ORM with eight core models (<a href=\"https://github.com/timercrack/trader/blob/3307c308/panel/models.py#L42-L289\" target=\"_blank\" rel=\"noopener noreferrer\" class=\"mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75\"><span class=\"flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4]\"><svg class=\"mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block\" fill=\"currentColor\" viewBox=\"0 0 24 24\"><path d=\"M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z\"></path></svg>panel/models.py</span><span class=\"flex flex-shrink-0 items-center rounded-r border-l px-2 py-1.5 border-[#dddddd] bg-[#d8d8d8] text-[#666666] dark:border-[#333333] dark:bg-[#2a2a2a] dark:text-[#888888]\">42-289</span></a>):</p>\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n<table><thead><tr><th>Model</th><th>Purpose</th><th>Key Fields</th></tr></thead><tbody><tr><td><code class=\"rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30\">Broker</code></td><td>Trading account credentials</td><td><code class=\"rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30\">cash</code>, <code class=\"rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30\">current</code>, <code class=\"rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30\">pre_balance</code>, <code class=\"rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30\">margin</code></td></tr><tr><td><code class=\"rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30\">Strategy</code></td><td>Trading strategy configuration</td><td><code class=\"rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30\">instruments</code>, <code class=\"rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30\">param_set</code>, <code class=\"rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30\">force_opens</code></td></tr><tr><td><code class=\"rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30\">Instrument</code></td><td>Contract specifications</td><td><code class=\"rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30\">main_code</code>, <code class=\"rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30\">price_tick</code>, <code class=\"rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30\">margin_rate</code>, <code class=\"rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30\">volume_multiple</code></td></tr><tr><td><code class=\"rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30\">Signal</code></td><td>Trading signals</td><td><code class=\"rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30\">type</code>, <code class=\"rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30\">price</code>, <code class=\"rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30\">volume</code>, <code class=\"rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30\">trigger_time</code>, <code class=\"rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30\">processed</code></td></tr><tr><td><code class=\"rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30\">Order</code></td><td>Order records</td><td><code class=\"rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30\">order_ref</code>, <code class=\"rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30\">status</code>, <code class=\"rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30\">direction</code>, <code class=\"rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30\">offset_flag</code></td></tr><tr><td><code class=\"rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30\">Trade</code></td><td>Position tracking</td><td><code class=\"rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30\">shares</code>, <code class=\"rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30\">avg_entry_price</code>, <code class=\"rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30\">profit</code>, <code class=\"rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30\">open_time</code>, <code class=\"rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30\">close_time</code></td></tr><tr><td><code class=\"rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30\">DailyBar</code></td><td>Individual contract OHLC data</td><td><code class=\"rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30\">open</code>, <code class=\"rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30\">high</code>, <code class=\"rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30\">low</code>, <code class=\"rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30\">close</code>, <code class=\"rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30\">volume</code>, <code class=\"rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30\">open_interest</code></td></tr><tr><td><code class=\"rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30\">MainBar</code></td><td>Continuous contract series</td><td><code class=\"rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30\">code</code>, <code class=\"rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30\">basis</code> (rollover adjustment)</td></tr></tbody></table>\n<p><strong>Sources</strong>: <a href=\"https://github.com/timercrack/trader/blob/3307c308/panel/models.py#L61-L289\" target=\"_blank\" rel=\"noopener noreferrer\" class=\"mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75\"><span class=\"flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4]\"><svg class=\"mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block\" fill=\"currentColor\" viewBox=\"0 0 24 24\"><path d=\"M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z\"></path></svg>panel/models.py</span><span class=\"flex flex-shrink-0 items-center rounded-r border-l px-2 py-1.5 border-[#dddddd] bg-[#d8d8d8] text-[#666666] dark:border-[#333333] dark:bg-[#2a2a2a] dark:text-[#888888]\">61-289</span></a></p>\n<h3 id=\"message-bus-architecture\" class=\"group\" data-header=\"true\">Message Bus Architecture<button class=\"relative ml-2 cursor-pointer align-baseline text-gray-400 opacity-0 transition-opacity hover:text-blue-400 focus:opacity-100 group-hover:opacity-100\" aria-label=\"Copy link to header\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"1em\" height=\"1em\" fill=\"currentColor\" viewBox=\"0 0 256 256\" class=\"h-4 w-4\"><path d=\"M117.18,188.74a12,12,0,0,1,0,17l-5.12,5.12A58.26,58.26,0,0,1,70.6,228h0A58.62,58.62,0,0,1,29.14,127.92L63.89,93.17a58.64,58.64,0,0,1,98.56,28.11,12,12,0,1,1-23.37,5.44,34.65,34.65,0,0,0-58.22-16.58L46.11,144.89A34.62,34.62,0,0,0,70.57,204h0a34.41,34.41,0,0,0,24.49-10.14l5.11-5.12A12,12,0,0,1,117.18,188.74ZM226.83,45.17a58.65,58.65,0,0,0-82.93,0l-5.11,5.11a12,12,0,0,0,17,17l5.12-5.12a34.63,34.63,0,1,1,49,49L175.1,145.86A34.39,34.39,0,0,1,150.61,156h0a34.63,34.63,0,0,1-33.69-26.72,12,12,0,0,0-23.38,5.44A58.64,58.64,0,0,0,150.56,180h.05a58.28,58.28,0,0,0,41.47-17.17l34.75-34.75a58.62,58.62,0,0,0,0-82.91Z\"></path></svg></button></h3>\n<p>Redis Pub/Sub channels decouple the trading strategy from the CTP API:</p>\n<pre class=\"px-2 py-1.5 has-[code]:rounded-md has-[code]:!bg-[#e5e5e5] has-[div]:bg-transparent has-[div]:!p-0 has-[code]:text-stone-900 dark:has-[code]:!bg-[#242424] has-[code]:dark:text-white [&amp;_code]:block [&amp;_code]:border-none [&amp;_code]:bg-transparent [&amp;_code]:p-0\"><div class=\"group relative cursor-pointer overflow-x-auto rounded-md bg-[#f2f1f0] p-4 transition-colors hover:bg-[#ededed] dark:bg-[#1f1f1f] dark:hover:bg-[#242424]\" type=\"button\" aria-haspopup=\"dialog\" aria-expanded=\"false\" aria-controls=\"radix-_r_9_\" data-state=\"closed\" data-slot=\"dialog-trigger\"><div class=\"flex max-h-[70vh] justify-center\"><svg id=\"mermaid-x6f8ktgtv8c\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" class=\"flowchart\" style=\"max-width: 100%; touch-action: none; user-select: none; cursor: grab; min-height: fit-content; max-height: 100%;\" viewBox=\"-0.01212346164857081 0 1941.3211219232971 1012\" role=\"graphics-document document\" aria-roledescription=\"flowchart-v2\" preserveAspectRatio=\"xMidYMid meet\"><style>#mermaid-x6f8ktgtv8c{font-family:ui-sans-serif,-apple-system,system-ui,Segoe UI,Helvetica;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#mermaid-x6f8ktgtv8c .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#mermaid-x6f8ktgtv8c .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#mermaid-x6f8ktgtv8c .error-icon{fill:#dddddd;}#mermaid-x6f8ktgtv8c .error-text{fill:#222222;stroke:#222222;}#mermaid-x6f8ktgtv8c .edge-thickness-normal{stroke-width:1px;}#mermaid-x6f8ktgtv8c .edge-thickness-thick{stroke-width:3.5px;}#mermaid-x6f8ktgtv8c .edge-pattern-solid{stroke-dasharray:0;}#mermaid-x6f8ktgtv8c .edge-thickness-invisible{stroke-width:0;fill:none;}#mermaid-x6f8ktgtv8c .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-x6f8ktgtv8c .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-x6f8ktgtv8c .marker{fill:#999;stroke:#999;}#mermaid-x6f8ktgtv8c .marker.cross{stroke:#999;}#mermaid-x6f8ktgtv8c svg{font-family:ui-sans-serif,-apple-system,system-ui,Segoe UI,Helvetica;font-size:16px;}#mermaid-x6f8ktgtv8c p{margin:0;}#mermaid-x6f8ktgtv8c .label{font-family:ui-sans-serif,-apple-system,system-ui,Segoe UI,Helvetica;color:#333;}#mermaid-x6f8ktgtv8c .cluster-label text{fill:#444;}#mermaid-x6f8ktgtv8c .cluster-label span{color:#444;}#mermaid-x6f8ktgtv8c .cluster-label span p{background-color:transparent;}#mermaid-x6f8ktgtv8c .label text,#mermaid-x6f8ktgtv8c span{fill:#333;color:#333;}#mermaid-x6f8ktgtv8c .node rect,#mermaid-x6f8ktgtv8c .node circle,#mermaid-x6f8ktgtv8c .node ellipse,#mermaid-x6f8ktgtv8c .node polygon,#mermaid-x6f8ktgtv8c .node path{fill:#ffffff;stroke:#dddddd;stroke-width:1px;}#mermaid-x6f8ktgtv8c .rough-node .label text,#mermaid-x6f8ktgtv8c .node .label text,#mermaid-x6f8ktgtv8c .image-shape .label,#mermaid-x6f8ktgtv8c .icon-shape .label{text-anchor:middle;}#mermaid-x6f8ktgtv8c .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#mermaid-x6f8ktgtv8c .rough-node .label,#mermaid-x6f8ktgtv8c .node .label,#mermaid-x6f8ktgtv8c .image-shape .label,#mermaid-x6f8ktgtv8c .icon-shape .label{text-align:center;}#mermaid-x6f8ktgtv8c .node.clickable{cursor:pointer;}#mermaid-x6f8ktgtv8c .root .anchor path{fill:#999!important;stroke-width:0;stroke:#999;}#mermaid-x6f8ktgtv8c .arrowheadPath{fill:#0b0b0b;}#mermaid-x6f8ktgtv8c .edgePath .path{stroke:#999;stroke-width:2.0px;}#mermaid-x6f8ktgtv8c .flowchart-link{stroke:#999;fill:none;}#mermaid-x6f8ktgtv8c .edgeLabel{background-color:#ffffff;text-align:center;}#mermaid-x6f8ktgtv8c .edgeLabel p{background-color:#ffffff;}#mermaid-x6f8ktgtv8c .edgeLabel rect{opacity:0.5;background-color:#ffffff;fill:#ffffff;}#mermaid-x6f8ktgtv8c .labelBkg{background-color:rgba(255, 255, 255, 0.5);}#mermaid-x6f8ktgtv8c .cluster rect{fill:#f8f8f8;stroke:#dddddd;stroke-width:1px;}#mermaid-x6f8ktgtv8c .cluster text{fill:#444;}#mermaid-x6f8ktgtv8c .cluster span{color:#444;}#mermaid-x6f8ktgtv8c div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:ui-sans-serif,-apple-system,system-ui,Segoe UI,Helvetica;font-size:12px;background:#dddddd;border:1px solid hsl(0, 0%, 76.6666666667%);border-radius:2px;pointer-events:none;z-index:100;}#mermaid-x6f8ktgtv8c .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#mermaid-x6f8ktgtv8c rect.text{fill:none;stroke-width:0;}#mermaid-x6f8ktgtv8c .icon-shape,#mermaid-x6f8ktgtv8c .image-shape{background-color:#ffffff;text-align:center;}#mermaid-x6f8ktgtv8c .icon-shape p,#mermaid-x6f8ktgtv8c .image-shape p{background-color:#ffffff;padding:2px;}#mermaid-x6f8ktgtv8c .icon-shape rect,#mermaid-x6f8ktgtv8c .image-shape rect{opacity:0.5;background-color:#ffffff;fill:#ffffff;}#mermaid-x6f8ktgtv8c .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#mermaid-x6f8ktgtv8c .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#mermaid-x6f8ktgtv8c :root{--mermaid-font-family:\"trebuchet ms\",verdana,arial,sans-serif;}</style><g><marker id=\"mermaid-x6f8ktgtv8c_flowchart-v2-pointEnd\" class=\"marker flowchart-v2\" viewBox=\"0 0 10 10\" refX=\"5\" refY=\"5\" markerUnits=\"userSpaceOnUse\" markerWidth=\"8\" markerHeight=\"8\" orient=\"auto\"><path d=\"M 0 0 L 10 5 L 0 10 z\" class=\"arrowMarkerPath\" style=\"stroke-width: 1; stroke-dasharray: 1, 0;\"></path></marker><marker id=\"mermaid-x6f8ktgtv8c_flowchart-v2-pointStart\" class=\"marker flowchart-v2\" viewBox=\"0 0 10 10\" refX=\"4.5\" refY=\"5\" markerUnits=\"userSpaceOnUse\" markerWidth=\"8\" markerHeight=\"8\" orient=\"auto\"><path d=\"M 0 5 L 10 10 L 10 0 z\" class=\"arrowMarkerPath\" style=\"stroke-width: 1; stroke-dasharray: 1, 0;\"></path></marker><marker id=\"mermaid-x6f8ktgtv8c_flowchart-v2-circleEnd\" class=\"marker flowchart-v2\" viewBox=\"0 0 10 10\" refX=\"11\" refY=\"5\" markerUnits=\"userSpaceOnUse\" markerWidth=\"11\" markerHeight=\"11\" orient=\"auto\"><circle cx=\"5\" cy=\"5\" r=\"5\" class=\"arrowMarkerPath\" style=\"stroke-width: 1; stroke-dasharray: 1, 0;\"></circle></marker><marker id=\"mermaid-x6f8ktgtv8c_flowchart-v2-circleStart\" class=\"marker flowchart-v2\" viewBox=\"0 0 10 10\" refX=\"-1\" refY=\"5\" markerUnits=\"userSpaceOnUse\" markerWidth=\"11\" markerHeight=\"11\" orient=\"auto\"><circle cx=\"5\" cy=\"5\" r=\"5\" class=\"arrowMarkerPath\" style=\"stroke-width: 1; stroke-dasharray: 1, 0;\"></circle></marker><marker id=\"mermaid-x6f8ktgtv8c_flowchart-v2-crossEnd\" class=\"marker cross flowchart-v2\" viewBox=\"0 0 11 11\" refX=\"12\" refY=\"5.2\" markerUnits=\"userSpaceOnUse\" markerWidth=\"11\" markerHeight=\"11\" orient=\"auto\"><path d=\"M 1,1 l 9,9 M 10,1 l -9,9\" class=\"arrowMarkerPath\" style=\"stroke-width: 2; stroke-dasharray: 1, 0;\"></path></marker><marker id=\"mermaid-x6f8ktgtv8c_flowchart-v2-crossStart\" class=\"marker cross flowchart-v2\" viewBox=\"0 0 11 11\" refX=\"-1\" refY=\"5.2\" markerUnits=\"userSpaceOnUse\" markerWidth=\"11\" markerHeight=\"11\" orient=\"auto\"><path d=\"M 1,1 l 9,9 M 10,1 l -9,9\" class=\"arrowMarkerPath\" style=\"stroke-width: 2; stroke-dasharray: 1, 0;\"></path></marker><g class=\"root\"><g class=\"clusters\"><g class=\"cluster\" id=\"subGraph2\" data-look=\"classic\"><rect style=\"\" x=\"744.234375\" y=\"8\" width=\"249.03125\" height=\"148\"></rect><g class=\"cluster-label\" transform=\"translate(815.5703125, 8)\"><foreignObject width=\"106.359375\" height=\"24\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"nodeLabel\"><p>CTP Gateway</p></span></div></foreignObject></g></g><g class=\"cluster\" id=\"subGraph1\" data-look=\"classic\"><rect style=\"\" x=\"397.234375\" y=\"176\" width=\"1069.96875\" height=\"404\"></rect><g class=\"cluster-label\" transform=\"translate(871.0703125, 176)\"><foreignObject width=\"122.296875\" height=\"24\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"nodeLabel\"><p>Redis Channels</p></span></div></foreignObject></g></g><g class=\"cluster\" id=\"TradeStrategy\" data-look=\"classic\"><rect style=\"\" x=\"8\" y=\"600\" width=\"1925.296875\" height=\"404\"></rect><g class=\"cluster-label\" transform=\"translate(914.46875, 600)\"><foreignObject width=\"112.359375\" height=\"24\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"nodeLabel\"><p>TradeStrategy</p></span></div></foreignObject></g></g></g><g class=\"edgePaths\"><path d=\"M290.203,802L299.122,802C308.042,802,325.88,802,343.719,802C361.557,802,379.396,802,406.548,738.474C433.7,674.948,470.166,547.897,488.399,484.371L506.632,420.845\" id=\"L_ReqOrderInsert_REQ_0\" class=\"edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link\" style=\";\" data-edge=\"true\" data-et=\"edge\" data-id=\"L_ReqOrderInsert_REQ_0\" data-points=\"W3sieCI6MjkwLjIwMzEyNSwieSI6ODAyfSx7IngiOjM0My43MTg3NSwieSI6ODAyfSx7IngiOjM5Ny4yMzQzNzUsInkiOjgwMn0seyJ4Ijo1MDcuNzM2MDE0ODg3OTcxNywieSI6NDE3fV0=\" marker-end=\"url(#mermaid-x6f8ktgtv8c_flowchart-v2-pointEnd)\"></path><path d=\"M615.625,378L626.342,378C637.06,378,658.495,378,679.93,378C701.365,378,722.799,378,751.277,335.781C779.754,293.562,815.274,209.125,833.033,166.906L850.793,124.687\" id=\"L_REQ_CTP_0\" class=\"edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link\" style=\";\" data-edge=\"true\" data-et=\"edge\" data-id=\"L_REQ_CTP_0\" data-points=\"W3sieCI6NjE1LjYyNSwieSI6Mzc4fSx7IngiOjY3OS45Mjk2ODc1LCJ5IjozNzh9LHsieCI6NzQ0LjIzNDM3NSwieSI6Mzc4fSx7IngiOjg1Mi4zNDQyMjUwODQ0NTk1LCJ5IjoxMjF9XQ==\" marker-end=\"url(#mermaid-x6f8ktgtv8c_flowchart-v2-pointEnd)\"></path><path d=\"M968.266,60.421L972.432,59.518C976.599,58.614,984.932,56.807,998.018,88.404C1011.104,120,1028.943,185,1054.154,217.5C1079.365,250,1111.948,250,1128.24,250L1144.531,250\" id=\"L_CTP_TRADE_RSP_0\" class=\"edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link\" style=\";\" data-edge=\"true\" data-et=\"edge\" data-id=\"L_CTP_TRADE_RSP_0\" data-points=\"W3sieCI6OTY4LjI2NTYyNSwieSI6NjAuNDIxMDA2Mzk5Nzk5MjI1fSx7IngiOjk5My4yNjU2MjUsInkiOjU1fSx7IngiOjEwNDYuNzgxMjUsInkiOjI1MH0seyJ4IjoxMTQ4LjUzMTI1LCJ5IjoyNTB9XQ==\" marker-end=\"url(#mermaid-x6f8ktgtv8c_flowchart-v2-pointEnd)\"></path><path d=\"M968.266,82L972.432,82C976.599,82,984.932,82,998.018,131.333C1011.104,180.667,1028.943,279.333,1046.115,328.667C1063.286,378,1079.792,378,1088.044,378L1096.297,378\" id=\"L_CTP_ORDER_RSP_0\" class=\"edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link\" style=\";\" data-edge=\"true\" data-et=\"edge\" data-id=\"L_CTP_ORDER_RSP_0\" data-points=\"W3sieCI6OTY4LjI2NTYyNSwieSI6ODJ9LHsieCI6OTkzLjI2NTYyNSwieSI6ODJ9LHsieCI6MTA0Ni43ODEyNSwieSI6Mzc4fSx7IngiOjExMDAuMjk2ODc1LCJ5IjozNzh9XQ==\" marker-end=\"url(#mermaid-x6f8ktgtv8c_flowchart-v2-pointEnd)\"></path><path d=\"M968.266,111.571L972.432,112.809C976.599,114.047,984.932,116.524,998.018,182.262C1011.104,248,1028.943,377,1047.77,441.5C1066.596,506,1086.411,506,1096.319,506L1106.227,506\" id=\"L_CTP_QRY_RSP_0\" class=\"edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link\" style=\";\" data-edge=\"true\" data-et=\"edge\" data-id=\"L_CTP_QRY_RSP_0\" data-points=\"W3sieCI6OTY4LjI2NTYyNSwieSI6MTExLjU3MTIxMzQ1MjEyN30seyJ4Ijo5OTMuMjY1NjI1LCJ5IjoxMTl9LHsieCI6MTA0Ni43ODEyNSwieSI6NTA2fSx7IngiOjExMTAuMjI2NTYyNSwieSI6NTA2fV0=\" marker-end=\"url(#mermaid-x6f8ktgtv8c_flowchart-v2-pointEnd)\"></path><path d=\"M1393.969,250L1406.174,250C1418.38,250,1442.792,250,1470.784,320.667C1498.776,391.333,1530.349,532.667,1564.746,603.333C1599.143,674,1636.365,674,1654.975,674L1673.586,674\" id=\"L_TRADE_RSP_OnRtnTradeCallback_0\" class=\"edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link\" style=\";\" data-edge=\"true\" data-et=\"edge\" data-id=\"L_TRADE_RSP_OnRtnTradeCallback_0\" data-points=\"W3sieCI6MTM5My45Njg3NSwieSI6MjUwfSx7IngiOjE0NjcuMjAzMTI1LCJ5IjoyNTB9LHsieCI6MTU2MS45MjE4NzUsInkiOjY3NH0seyJ4IjoxNjc3LjU4NTkzNzUsInkiOjY3NH1d\" marker-end=\"url(#mermaid-x6f8ktgtv8c_flowchart-v2-pointEnd)\"></path><path d=\"M1442.203,378L1446.37,378C1450.536,378,1458.87,378,1478.823,448.667C1498.776,519.333,1530.349,660.667,1564.746,731.333C1599.143,802,1636.365,802,1654.975,802L1673.586,802\" id=\"L_ORDER_RSP_OnRtnOrderCallback_0\" class=\"edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link\" style=\";\" data-edge=\"true\" data-et=\"edge\" data-id=\"L_ORDER_RSP_OnRtnOrderCallback_0\" data-points=\"W3sieCI6MTQ0Mi4yMDMxMjUsInkiOjM3OH0seyJ4IjoxNDY3LjIwMzEyNSwieSI6Mzc4fSx7IngiOjE1NjEuOTIxODc1LCJ5Ijo4MDJ9LHsieCI6MTY3Ny41ODU5Mzc1LCJ5Ijo4MDJ9XQ==\" marker-end=\"url(#mermaid-x6f8ktgtv8c_flowchart-v2-pointEnd)\"></path><path d=\"M1432.273,506L1438.095,506C1443.917,506,1455.56,506,1477.168,576.667C1498.776,647.333,1530.349,788.667,1561.255,859.333C1592.161,930,1622.401,930,1637.521,930L1652.641,930\" id=\"L_QRY_RSP_QueryMethod_0\" class=\"edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link\" style=\";\" data-edge=\"true\" data-et=\"edge\" data-id=\"L_QRY_RSP_QueryMethod_0\" data-points=\"W3sieCI6MTQzMi4yNzM0Mzc1LCJ5Ijo1MDZ9LHsieCI6MTQ2Ny4yMDMxMjUsInkiOjUwNn0seyJ4IjoxNTYxLjkyMTg3NSwieSI6OTMwfSx7IngiOjE2NTYuNjQwNjI1LCJ5Ijo5MzB9XQ==\" marker-end=\"url(#mermaid-x6f8ktgtv8c_flowchart-v2-pointEnd)\"></path></g><g class=\"edgeLabels\"><g class=\"edgeLabel\" transform=\"translate(343.71875, 802)\"><g class=\"label\" data-id=\"L_ReqOrderInsert_REQ_0\" transform=\"translate(-28.515625, -12)\"><foreignObject width=\"57.03125\" height=\"24\"><div xmlns=\"http://www.w3.org/1999/xhtml\" class=\"labelBkg\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"edgeLabel\"><p>Publish</p></span></div></foreignObject></g></g><g class=\"edgeLabel\" transform=\"translate(679.9296875, 378)\"><g class=\"label\" data-id=\"L_REQ_CTP_0\" transform=\"translate(-39.3046875, -12)\"><foreignObject width=\"78.609375\" height=\"24\"><div xmlns=\"http://www.w3.org/1999/xhtml\" class=\"labelBkg\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"edgeLabel\"><p>Subscribe</p></span></div></foreignObject></g></g><g class=\"edgeLabel\" transform=\"translate(1046.78125, 250)\"><g class=\"label\" data-id=\"L_CTP_TRADE_RSP_0\" transform=\"translate(-28.515625, -12)\"><foreignObject width=\"57.03125\" height=\"24\"><div xmlns=\"http://www.w3.org/1999/xhtml\" class=\"labelBkg\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"edgeLabel\"><p>Publish</p></span></div></foreignObject></g></g><g class=\"edgeLabel\" transform=\"translate(1046.78125, 378)\"><g class=\"label\" data-id=\"L_CTP_ORDER_RSP_0\" transform=\"translate(-28.515625, -12)\"><foreignObject width=\"57.03125\" height=\"24\"><div xmlns=\"http://www.w3.org/1999/xhtml\" class=\"labelBkg\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"edgeLabel\"><p>Publish</p></span></div></foreignObject></g></g><g class=\"edgeLabel\" transform=\"translate(1046.78125, 506)\"><g class=\"label\" data-id=\"L_CTP_QRY_RSP_0\" transform=\"translate(-28.515625, -12)\"><foreignObject width=\"57.03125\" height=\"24\"><div xmlns=\"http://www.w3.org/1999/xhtml\" class=\"labelBkg\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"edgeLabel\"><p>Publish</p></span></div></foreignObject></g></g><g class=\"edgeLabel\" transform=\"translate(1561.921875, 674)\"><g class=\"label\" data-id=\"L_TRADE_RSP_OnRtnTradeCallback_0\" transform=\"translate(-69.71875, -12)\"><foreignObject width=\"139.4375\" height=\"24\"><div xmlns=\"http://www.w3.org/1999/xhtml\" class=\"labelBkg\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"edgeLabel\"><p>Pattern subscribe</p></span></div></foreignObject></g></g><g class=\"edgeLabel\" transform=\"translate(1561.921875, 802)\"><g class=\"label\" data-id=\"L_ORDER_RSP_OnRtnOrderCallback_0\" transform=\"translate(-69.71875, -12)\"><foreignObject width=\"139.4375\" height=\"24\"><div xmlns=\"http://www.w3.org/1999/xhtml\" class=\"labelBkg\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"edgeLabel\"><p>Pattern subscribe</p></span></div></foreignObject></g></g><g class=\"edgeLabel\" transform=\"translate(1561.921875, 930)\"><g class=\"label\" data-id=\"L_QRY_RSP_QueryMethod_0\" transform=\"translate(-60.5859375, -12)\"><foreignObject width=\"121.171875\" height=\"24\"><div xmlns=\"http://www.w3.org/1999/xhtml\" class=\"labelBkg\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"edgeLabel\"><p>await response</p></span></div></foreignObject></g></g></g><g class=\"nodes\"><g class=\"node default\" id=\"flowchart-ReqOrderInsert-0\" transform=\"translate(161.6015625, 802)\"><rect class=\"basic label-container\" style=\"\" x=\"-128.6015625\" y=\"-39\" width=\"257.203125\" height=\"78\"></rect><g class=\"label\" style=\"\" transform=\"translate(-98.6015625, -24)\"><rect></rect><foreignObject width=\"197.203125\" height=\"48\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"nodeLabel\"><p>ReqOrderInsert()<br>Publishes order requests</p></span></div></foreignObject></g></g><g class=\"node default\" id=\"flowchart-OnRtnTradeCallback-1\" transform=\"translate(1782.46875, 674)\"><rect class=\"basic label-container\" style=\"\" x=\"-104.8828125\" y=\"-39\" width=\"209.765625\" height=\"78\"></rect><g class=\"label\" style=\"\" transform=\"translate(-74.8828125, -24)\"><rect></rect><foreignObject width=\"149.765625\" height=\"48\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"nodeLabel\"><p>OnRtnTrade()<br>@RegisterCallback</p></span></div></foreignObject></g></g><g class=\"node default\" id=\"flowchart-OnRtnOrderCallback-2\" transform=\"translate(1782.46875, 802)\"><rect class=\"basic label-container\" style=\"\" x=\"-104.8828125\" y=\"-39\" width=\"209.765625\" height=\"78\"></rect><g class=\"label\" style=\"\" transform=\"translate(-74.8828125, -24)\"><rect></rect><foreignObject width=\"149.765625\" height=\"48\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"nodeLabel\"><p>OnRtnOrder()<br>@RegisterCallback</p></span></div></foreignObject></g></g><g class=\"node default\" id=\"flowchart-QueryMethod-3\" transform=\"translate(1782.46875, 930)\"><rect class=\"basic label-container\" style=\"\" x=\"-125.828125\" y=\"-39\" width=\"251.65625\" height=\"78\"></rect><g class=\"label\" style=\"\" transform=\"translate(-95.828125, -24)\"><rect></rect><foreignObject width=\"191.65625\" height=\"48\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"nodeLabel\"><p>query()<br>Async request/response</p></span></div></foreignObject></g></g><g class=\"node default\" id=\"flowchart-REQ-4\" transform=\"translate(518.9296875, 378)\"><rect class=\"basic label-container\" style=\"\" x=\"-96.6953125\" y=\"-39\" width=\"193.390625\" height=\"78\"></rect><g class=\"label\" style=\"\" transform=\"translate(-66.6953125, -24)\"><rect></rect><foreignObject width=\"133.390625\" height=\"48\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"nodeLabel\"><p>MSG:CTP:REQ:*<br>Request channel</p></span></div></foreignObject></g></g><g class=\"node default\" id=\"flowchart-TRADE_RSP-5\" transform=\"translate(1271.25, 250)\"><rect class=\"basic label-container\" style=\"\" x=\"-122.71875\" y=\"-39\" width=\"245.4375\" height=\"78\"></rect><g class=\"label\" style=\"\" transform=\"translate(-92.71875, -24)\"><rect></rect><foreignObject width=\"185.4375\" height=\"48\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"nodeLabel\"><p>MSG:CTP:RSP:TRADE:*<br>Trade response pattern</p></span></div></foreignObject></g></g><g class=\"node default\" id=\"flowchart-ORDER_RSP-6\" transform=\"translate(1271.25, 378)\"><rect class=\"basic label-container\" style=\"\" x=\"-170.953125\" y=\"-39\" width=\"341.90625\" height=\"78\"></rect><g class=\"label\" style=\"\" transform=\"translate(-140.953125, -24)\"><rect></rect><foreignObject width=\"281.90625\" height=\"48\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: table; white-space: break-spaces; line-height: 1.5; max-width: 200px; text-align: center; width: 200px;\"><span class=\"nodeLabel\"><p>MSG:CTP:RSP:TRADE:OnRtnOrder:*<br>Order response pattern</p></span></div></foreignObject></g></g><g class=\"node default\" id=\"flowchart-QRY_RSP-7\" transform=\"translate(1271.25, 506)\"><rect class=\"basic label-container\" style=\"\" x=\"-161.0234375\" y=\"-39\" width=\"322.046875\" height=\"78\"></rect><g class=\"label\" style=\"\" transform=\"translate(-131.0234375, -24)\"><rect></rect><foreignObject width=\"262.046875\" height=\"48\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: table; white-space: break-spaces; line-height: 1.5; max-width: 200px; text-align: center; width: 200px;\"><span class=\"nodeLabel\"><p>MSG:CTP:RSP:TRADE:OnRspQry*<br>Query response pattern</p></span></div></foreignObject></g></g><g class=\"node default\" id=\"flowchart-CTP-8\" transform=\"translate(868.75, 82)\"><rect class=\"basic label-container\" style=\"\" x=\"-99.515625\" y=\"-39\" width=\"199.03125\" height=\"78\"></rect><g class=\"label\" style=\"\" transform=\"translate(-69.515625, -24)\"><rect></rect><foreignObject width=\"139.03125\" height=\"48\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"nodeLabel\"><p>CTP API Handler<br>Separate process</p></span></div></foreignObject></g></g></g></g></g></svg></div><div class=\"absolute right-2 top-2 flex items-center gap-1 opacity-0 transition-opacity group-hover:opacity-100\"><button class=\"cursor-pointer rounded-sm p-1 text-[#333] opacity-70 transition-opacity hover:opacity-100 dark:text-white\" aria-label=\"Zoom in\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"16\" height=\"16\" fill=\"currentColor\" viewBox=\"0 0 256 256\"><path d=\"M224,128a8,8,0,0,1-8,8H136v80a8,8,0,0,1-16,0V136H40a8,8,0,0,1,0-16h80V40a8,8,0,0,1,16,0v80h80A8,8,0,0,1,224,128Z\"></path></svg></button><button class=\"cursor-pointer rounded-sm p-1 text-[#333] opacity-70 transition-opacity hover:opacity-100 dark:text-white\" aria-label=\"Zoom out\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"16\" height=\"16\" fill=\"currentColor\" viewBox=\"0 0 256 256\"><path d=\"M224,128a8,8,0,0,1-8,8H40a8,8,0,0,1,0-16H216A8,8,0,0,1,224,128Z\"></path></svg></button><div class=\"rounded-sm p-1\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"16\" height=\"16\" fill=\"currentColor\" viewBox=\"0 0 256 256\" class=\"text-[#333] dark:text-white\"><path d=\"M216,48V96a8,8,0,0,1-16,0V67.31l-42.34,42.35a8,8,0,0,1-11.32-11.32L188.69,56H160a8,8,0,0,1,0-16h48A8,8,0,0,1,216,48ZM98.34,146.34,56,188.69V160a8,8,0,0,0-16,0v48a8,8,0,0,0,8,8H96a8,8,0,0,0,0-16H67.31l42.35-42.34a8,8,0,0,0-11.32-11.32ZM208,152a8,8,0,0,0-8,8v28.69l-42.34-42.35a8,8,0,0,0-11.32,11.32L188.69,200H160a8,8,0,0,0,0,16h48a8,8,0,0,0,8-8V160A8,8,0,0,0,208,152ZM67.31,56H96a8,8,0,0,0,0-16H48a8,8,0,0,0-8,8V96a8,8,0,0,0,16,0V67.31l42.34,42.35a8,8,0,0,0,11.32-11.32Z\"></path></svg></div></div></div></pre>\n<p><strong>Sources</strong>: <a href=\"https://github.com/timercrack/trader/blob/3307c308/trader/strategy/brother2.py#L301-L343\" target=\"_blank\" rel=\"noopener noreferrer\" class=\"mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75\"><span class=\"flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4]\"><svg class=\"mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block\" fill=\"currentColor\" viewBox=\"0 0 24 24\"><path d=\"M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z\"></path></svg>trader/strategy/brother2.py</span><span class=\"flex flex-shrink-0 items-center rounded-r border-l px-2 py-1.5 border-[#dddddd] bg-[#d8d8d8] text-[#666666] dark:border-[#333333] dark:bg-[#2a2a2a] dark:text-[#888888]\">301-343</span></a> <a href=\"https://github.com/timercrack/trader/blob/3307c308/trader/strategy/brother2.py#L391-L469\" target=\"_blank\" rel=\"noopener noreferrer\" class=\"mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75\"><span class=\"flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4]\"><svg class=\"mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block\" fill=\"currentColor\" viewBox=\"0 0 24 24\"><path d=\"M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z\"></path></svg>trader/strategy/brother2.py</span><span class=\"flex flex-shrink-0 items-center rounded-r border-l px-2 py-1.5 border-[#dddddd] bg-[#d8d8d8] text-[#666666] dark:border-[#333333] dark:bg-[#2a2a2a] dark:text-[#888888]\">391-469</span></a> <a href=\"https://github.com/timercrack/trader/blob/3307c308/trader/strategy/brother2.py#L510-L566\" target=\"_blank\" rel=\"noopener noreferrer\" class=\"mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75\"><span class=\"flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4]\"><svg class=\"mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block\" fill=\"currentColor\" viewBox=\"0 0 24 24\"><path d=\"M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z\"></path></svg>trader/strategy/brother2.py</span><span class=\"flex flex-shrink-0 items-center rounded-r border-l px-2 py-1.5 border-[#dddddd] bg-[#d8d8d8] text-[#666666] dark:border-[#333333] dark:bg-[#2a2a2a] dark:text-[#888888]\">510-566</span></a> <a href=\"https://github.com/timercrack/trader/blob/3307c308/trader/strategy/brother2.py#L236-L257\" target=\"_blank\" rel=\"noopener noreferrer\" class=\"mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75\"><span class=\"flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4]\"><svg class=\"mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block\" fill=\"currentColor\" viewBox=\"0 0 24 24\"><path d=\"M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z\"></path></svg>trader/strategy/brother2.py</span><span class=\"flex flex-shrink-0 items-center rounded-r border-l px-2 py-1.5 border-[#dddddd] bg-[#d8d8d8] text-[#666666] dark:border-[#333333] dark:bg-[#2a2a2a] dark:text-[#888888]\">236-257</span></a></p>\n<h3 id=\"data-acquisition-pipeline\" class=\"group\" data-header=\"true\">Data Acquisition Pipeline<button class=\"relative ml-2 cursor-pointer align-baseline text-gray-400 opacity-0 transition-opacity hover:text-blue-400 focus:opacity-100 group-hover:opacity-100\" aria-label=\"Copy link to header\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"1em\" height=\"1em\" fill=\"currentColor\" viewBox=\"0 0 256 256\" class=\"h-4 w-4\"><path d=\"M117.18,188.74a12,12,0,0,1,0,17l-5.12,5.12A58.26,58.26,0,0,1,70.6,228h0A58.62,58.62,0,0,1,29.14,127.92L63.89,93.17a58.64,58.64,0,0,1,98.56,28.11,12,12,0,1,1-23.37,5.44,34.65,34.65,0,0,0-58.22-16.58L46.11,144.89A34.62,34.62,0,0,0,70.57,204h0a34.41,34.41,0,0,0,24.49-10.14l5.11-5.12A12,12,0,0,1,117.18,188.74ZM226.83,45.17a58.65,58.65,0,0,0-82.93,0l-5.11,5.11a12,12,0,0,0,17,17l5.12-5.12a34.63,34.63,0,1,1,49,49L175.1,145.86A34.39,34.39,0,0,1,150.61,156h0a34.63,34.63,0,0,1-33.69-26.72,12,12,0,0,0-23.38,5.44A58.64,58.64,0,0,0,150.56,180h.05a58.28,58.28,0,0,0,41.47-17.17l34.75-34.75a58.62,58.62,0,0,0,0-82.91Z\"></path></svg></button></h3>\n<p>The <code class=\"rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30\">trader/utils/__init__.py</code> module (importance: 76.12) provides functions to fetch and process market data:</p>\n<ol>\n<li>\n<p><strong>Exchange Data Fetchers</strong>: Five async functions fetch daily OHLC data:</p>\n<ul>\n<li><code class=\"rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30\">update_from_shfe()</code>: Shanghai Futures Exchange (<a href=\"https://github.com/timercrack/trader/blob/3307c308/trader/utils/__init__.py#L121-L174\" target=\"_blank\" rel=\"noopener noreferrer\" class=\"mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75\"><span class=\"flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4]\"><svg class=\"mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block\" fill=\"currentColor\" viewBox=\"0 0 24 24\"><path d=\"M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z\"></path></svg>trader/utils/__init__.py</span><span class=\"flex flex-shrink-0 items-center rounded-r border-l px-2 py-1.5 border-[#dddddd] bg-[#d8d8d8] text-[#666666] dark:border-[#333333] dark:bg-[#2a2a2a] dark:text-[#888888]\">121-174</span></a>)</li>\n<li><code class=\"rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30\">update_from_dce()</code>: Dalian Commodity Exchange (<a href=\"https://github.com/timercrack/trader/blob/3307c308/trader/utils/__init__.py#L220-L265\" target=\"_blank\" rel=\"noopener noreferrer\" class=\"mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75\"><span class=\"flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4]\"><svg class=\"mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block\" fill=\"currentColor\" viewBox=\"0 0 24 24\"><path d=\"M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z\"></path></svg>trader/utils/__init__.py</span><span class=\"flex flex-shrink-0 items-center rounded-r border-l px-2 py-1.5 border-[#dddddd] bg-[#d8d8d8] text-[#666666] dark:border-[#333333] dark:bg-[#2a2a2a] dark:text-[#888888]\">220-265</span></a>)</li>\n<li><code class=\"rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30\">update_from_czce()</code>: Zhengzhou Commodity Exchange (<a href=\"https://github.com/timercrack/trader/blob/3307c308/trader/utils/__init__.py#L177-L217\" target=\"_blank\" rel=\"noopener noreferrer\" class=\"mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75\"><span class=\"flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4]\"><svg class=\"mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block\" fill=\"currentColor\" viewBox=\"0 0 24 24\"><path d=\"M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z\"></path></svg>trader/utils/__init__.py</span><span class=\"flex flex-shrink-0 items-center rounded-r border-l px-2 py-1.5 border-[#dddddd] bg-[#d8d8d8] text-[#666666] dark:border-[#333333] dark:bg-[#2a2a2a] dark:text-[#888888]\">177-217</span></a>)</li>\n<li><code class=\"rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30\">update_from_cffex()</code>: China Financial Futures Exchange (<a href=\"https://github.com/timercrack/trader/blob/3307c308/trader/utils/__init__.py#L296-L349\" target=\"_blank\" rel=\"noopener noreferrer\" class=\"mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75\"><span class=\"flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4]\"><svg class=\"mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block\" fill=\"currentColor\" viewBox=\"0 0 24 24\"><path d=\"M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z\"></path></svg>trader/utils/__init__.py</span><span class=\"flex flex-shrink-0 items-center rounded-r border-l px-2 py-1.5 border-[#dddddd] bg-[#d8d8d8] text-[#666666] dark:border-[#333333] dark:bg-[#2a2a2a] dark:text-[#888888]\">296-349</span></a>)</li>\n<li><code class=\"rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30\">update_from_gfex()</code>: Guangzhou Futures Exchange (<a href=\"https://github.com/timercrack/trader/blob/3307c308/trader/utils/__init__.py#L268-L293\" target=\"_blank\" rel=\"noopener noreferrer\" class=\"mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75\"><span class=\"flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4]\"><svg class=\"mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block\" fill=\"currentColor\" viewBox=\"0 0 24 24\"><path d=\"M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z\"></path></svg>trader/utils/__init__.py</span><span class=\"flex flex-shrink-0 items-center rounded-r border-l px-2 py-1.5 border-[#dddddd] bg-[#d8d8d8] text-[#666666] dark:border-[#333333] dark:bg-[#2a2a2a] dark:text-[#888888]\">268-293</span></a>)</li>\n</ul>\n</li>\n<li>\n<p><strong>Main Contract Calculation</strong>: <code class=\"rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30\">calc_main_inst()</code> identifies the main contract based on volume and open interest thresholds (<a href=\"https://github.com/timercrack/trader/blob/3307c308/trader/utils/__init__.py#L381-L421\" target=\"_blank\" rel=\"noopener noreferrer\" class=\"mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75\"><span class=\"flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4]\"><svg class=\"mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block\" fill=\"currentColor\" viewBox=\"0 0 24 24\"><path d=\"M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z\"></path></svg>trader/utils/__init__.py</span><span class=\"flex flex-shrink-0 items-center rounded-r border-l px-2 py-1.5 border-[#dddddd] bg-[#d8d8d8] text-[#666666] dark:border-[#333333] dark:bg-[#2a2a2a] dark:text-[#888888]\">381-421</span></a>)</p>\n</li>\n<li>\n<p><strong>Rollover Handling</strong>: <code class=\"rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30\">handle_rollover()</code> applies basis adjustments to maintain continuous price series (<a href=\"https://github.com/timercrack/trader/blob/3307c308/trader/utils/__init__.py#L365-L379\" target=\"_blank\" rel=\"noopener noreferrer\" class=\"mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75\"><span class=\"flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4]\"><svg class=\"mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block\" fill=\"currentColor\" viewBox=\"0 0 24 24\"><path d=\"M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z\"></path></svg>trader/utils/__init__.py</span><span class=\"flex flex-shrink-0 items-center rounded-r border-l px-2 py-1.5 border-[#dddddd] bg-[#d8d8d8] text-[#666666] dark:border-[#333333] dark:bg-[#2a2a2a] dark:text-[#888888]\">365-379</span></a>)</p>\n</li>\n<li>\n<p><strong>Technical Analysis</strong>: Uses TA-Lib for ATR, SMA, and breakout level calculations</p>\n</li>\n</ol>\n<p><strong>Sources</strong>: <a href=\"https://github.com/timercrack/trader/blob/3307c308/trader/utils/__init__.py#L121-L421\" target=\"_blank\" rel=\"noopener noreferrer\" class=\"mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75\"><span class=\"flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4]\"><svg class=\"mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block\" fill=\"currentColor\" viewBox=\"0 0 24 24\"><path d=\"M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z\"></path></svg>trader/utils/__init__.py</span><span class=\"flex flex-shrink-0 items-center rounded-r border-l px-2 py-1.5 border-[#dddddd] bg-[#d8d8d8] text-[#666666] dark:border-[#333333] dark:bg-[#2a2a2a] dark:text-[#888888]\">121-421</span></a></p>\n<h2 id=\"technology-stack\" class=\"group\" data-header=\"true\">Technology Stack<button class=\"relative ml-2 cursor-pointer align-baseline text-gray-400 opacity-0 transition-opacity hover:text-blue-400 focus:opacity-100 group-hover:opacity-100\" aria-label=\"Copy link to header\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"1em\" height=\"1em\" fill=\"currentColor\" viewBox=\"0 0 256 256\" class=\"h-4 w-4\"><path d=\"M117.18,188.74a12,12,0,0,1,0,17l-5.12,5.12A58.26,58.26,0,0,1,70.6,228h0A58.62,58.62,0,0,1,29.14,127.92L63.89,93.17a58.64,58.64,0,0,1,98.56,28.11,12,12,0,1,1-23.37,5.44,34.65,34.65,0,0,0-58.22-16.58L46.11,144.89A34.62,34.62,0,0,0,70.57,204h0a34.41,34.41,0,0,0,24.49-10.14l5.11-5.12A12,12,0,0,1,117.18,188.74ZM226.83,45.17a58.65,58.65,0,0,0-82.93,0l-5.11,5.11a12,12,0,0,0,17,17l5.12-5.12a34.63,34.63,0,1,1,49,49L175.1,145.86A34.39,34.39,0,0,1,150.61,156h0a34.63,34.63,0,0,1-33.69-26.72,12,12,0,0,0-23.38,5.44A58.64,58.64,0,0,0,150.56,180h.05a58.28,58.28,0,0,0,41.47-17.17l34.75-34.75a58.62,58.62,0,0,0,0-82.91Z\"></path></svg></button></h2>\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n<table><thead><tr><th>Component</th><th>Technology</th><th>Purpose</th></tr></thead><tbody><tr><td><strong>Backend Framework</strong></td><td>Django 4.x</td><td>ORM, admin interface, model layer</td></tr><tr><td><strong>Database</strong></td><td>MySQL</td><td>Persistent storage for all trading data</td></tr><tr><td><strong>Message Bus</strong></td><td>Redis</td><td>Pub/Sub for CTP API communication</td></tr><tr><td><strong>Technical Analysis</strong></td><td>TA-Lib</td><td>ATR, SMA, RSI, MACD indicators</td></tr><tr><td><strong>Async I/O</strong></td><td>aiohttp, aioredis</td><td>Non-blocking network operations</td></tr><tr><td><strong>Task Scheduling</strong></td><td>croniter</td><td>Cron-style scheduled tasks</td></tr><tr><td><strong>Data Processing</strong></td><td>pandas, numpy</td><td>Time series analysis</td></tr><tr><td><strong>JSON Handling</strong></td><td>ujson</td><td>High-performance JSON parsing</td></tr></tbody></table>\n<p><strong>Sources</strong>: <a href=\"https://github.com/timercrack/trader/blob/3307c308/trader/strategy/brother2.py#L16-L32\" target=\"_blank\" rel=\"noopener noreferrer\" class=\"mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75\"><span class=\"flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4]\"><svg class=\"mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block\" fill=\"currentColor\" viewBox=\"0 0 24 24\"><path d=\"M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z\"></path></svg>trader/strategy/brother2.py</span><span class=\"flex flex-shrink-0 items-center rounded-r border-l px-2 py-1.5 border-[#dddddd] bg-[#d8d8d8] text-[#666666] dark:border-[#333333] dark:bg-[#2a2a2a] dark:text-[#888888]\">16-32</span></a> <a href=\"https://github.com/timercrack/trader/blob/3307c308/trader/utils/__init__.py#L16-L40\" target=\"_blank\" rel=\"noopener noreferrer\" class=\"mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75\"><span class=\"flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4]\"><svg class=\"mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block\" fill=\"currentColor\" viewBox=\"0 0 24 24\"><path d=\"M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z\"></path></svg>trader/utils/__init__.py</span><span class=\"flex flex-shrink-0 items-center rounded-r border-l px-2 py-1.5 border-[#dddddd] bg-[#d8d8d8] text-[#666666] dark:border-[#333333] dark:bg-[#2a2a2a] dark:text-[#888888]\">16-40</span></a></p>\n<h2 id=\"trading-workflow-overview\" class=\"group\" data-header=\"true\">Trading Workflow Overview<button class=\"relative ml-2 cursor-pointer align-baseline text-gray-400 opacity-0 transition-opacity hover:text-blue-400 focus:opacity-100 group-hover:opacity-100\" aria-label=\"Copy link to header\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"1em\" height=\"1em\" fill=\"currentColor\" viewBox=\"0 0 256 256\" class=\"h-4 w-4\"><path d=\"M117.18,188.74a12,12,0,0,1,0,17l-5.12,5.12A58.26,58.26,0,0,1,70.6,228h0A58.62,58.62,0,0,1,29.14,127.92L63.89,93.17a58.64,58.64,0,0,1,98.56,28.11,12,12,0,1,1-23.37,5.44,34.65,34.65,0,0,0-58.22-16.58L46.11,144.89A34.62,34.62,0,0,0,70.57,204h0a34.41,34.41,0,0,0,24.49-10.14l5.11-5.12A12,12,0,0,1,117.18,188.74ZM226.83,45.17a58.65,58.65,0,0,0-82.93,0l-5.11,5.11a12,12,0,0,0,17,17l5.12-5.12a34.63,34.63,0,1,1,49,49L175.1,145.86A34.39,34.39,0,0,1,150.61,156h0a34.63,34.63,0,0,1-33.69-26.72,12,12,0,0,0-23.38,5.44A58.64,58.64,0,0,0,150.56,180h.05a58.28,58.28,0,0,0,41.47-17.17l34.75-34.75a58.62,58.62,0,0,0,0-82.91Z\"></path></svg></button></h2>\n<p>The daily trading cycle follows this sequence:</p>\n<pre class=\"px-2 py-1.5 has-[code]:rounded-md has-[code]:!bg-[#e5e5e5] has-[div]:bg-transparent has-[div]:!p-0 has-[code]:text-stone-900 dark:has-[code]:!bg-[#242424] has-[code]:dark:text-white [&amp;_code]:block [&amp;_code]:border-none [&amp;_code]:bg-transparent [&amp;_code]:p-0\"><div class=\"group relative cursor-pointer overflow-x-auto rounded-md bg-[#f2f1f0] p-4 transition-colors hover:bg-[#ededed] dark:bg-[#1f1f1f] dark:hover:bg-[#242424]\" type=\"button\" aria-haspopup=\"dialog\" aria-expanded=\"false\" aria-controls=\"radix-_r_c_\" data-state=\"closed\" data-slot=\"dialog-trigger\"><div class=\"flex max-h-[70vh] justify-center\"><svg id=\"mermaid-st9z5lq3kxl\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" style=\"max-width: 100%; touch-action: none; user-select: none; cursor: grab; min-height: fit-content; max-height: 100%;\" viewBox=\"-90.5 -10 1314 2044\" role=\"graphics-document document\" aria-roledescription=\"sequence\" preserveAspectRatio=\"xMidYMid meet\"><g><rect x=\"983\" y=\"1958\" fill=\"#eaeaea\" stroke=\"#666\" width=\"150\" height=\"65\" name=\"CTP\" rx=\"3\" ry=\"3\" class=\"actor actor-bottom\"></rect><text x=\"1058\" y=\"1990.5\" dominant-baseline=\"central\" alignment-baseline=\"central\" class=\"actor actor-box\" style=\"text-anchor: middle; font-size: 16px; font-weight: 400;\"><tspan x=\"1058\" dy=\"0\">\"CTP API\"</tspan></text></g><g><rect x=\"759\" y=\"1958\" fill=\"#eaeaea\" stroke=\"#666\" width=\"150\" height=\"65\" name=\"Redis\" rx=\"3\" ry=\"3\" class=\"actor actor-bottom\"></rect><text x=\"834\" y=\"1990.5\" dominant-baseline=\"central\" alignment-baseline=\"central\" class=\"actor actor-box\" style=\"text-anchor: middle; font-size: 16px; font-weight: 400;\"><tspan x=\"834\" dy=\"0\">\"Redis Pub/Sub\"</tspan></text></g><g><rect x=\"559\" y=\"1958\" fill=\"#eaeaea\" stroke=\"#666\" width=\"150\" height=\"65\" name=\"DB\" rx=\"3\" ry=\"3\" class=\"actor actor-bottom\"></rect><text x=\"634\" y=\"1990.5\" dominant-baseline=\"central\" alignment-baseline=\"central\" class=\"actor actor-box\" style=\"text-anchor: middle; font-size: 16px; font-weight: 400;\"><tspan x=\"634\" dy=\"0\">\"Django ORM\"</tspan></text></g><g><rect x=\"218\" y=\"1958\" fill=\"#eaeaea\" stroke=\"#666\" width=\"150\" height=\"65\" name=\"Strategy\" rx=\"3\" ry=\"3\" class=\"actor actor-bottom\"></rect><text x=\"293\" y=\"1990.5\" dominant-baseline=\"central\" alignment-baseline=\"central\" class=\"actor actor-box\" style=\"text-anchor: middle; font-size: 16px; font-weight: 400;\"><tspan x=\"293\" dy=\"0\">\"TradeStrategy\"</tspan></text></g><g><rect x=\"0\" y=\"1958\" fill=\"#eaeaea\" stroke=\"#666\" width=\"150\" height=\"65\" name=\"Cron\" rx=\"3\" ry=\"3\" class=\"actor actor-bottom\"></rect><text x=\"75\" y=\"1990.5\" dominant-baseline=\"central\" alignment-baseline=\"central\" class=\"actor actor-box\" style=\"text-anchor: middle; font-size: 16px; font-weight: 400;\"><tspan x=\"75\" dy=\"-8\">\"Scheduled Tasks</tspan></text><text x=\"75\" y=\"1990.5\" dominant-baseline=\"central\" alignment-baseline=\"central\" class=\"actor actor-box\" style=\"text-anchor: middle; font-size: 16px; font-weight: 400;\"><tspan x=\"75\" dy=\"8\">(croniter)\"</tspan></text></g><g><line id=\"actor4\" x1=\"1058\" y1=\"65\" x2=\"1058\" y2=\"1958\" class=\"actor-line 200\" stroke-width=\"0.5px\" stroke=\"#999\" name=\"CTP\"></line><g id=\"root-4\"><rect x=\"983\" y=\"0\" fill=\"#eaeaea\" stroke=\"#666\" width=\"150\" height=\"65\" name=\"CTP\" rx=\"3\" ry=\"3\" class=\"actor actor-top\"></rect><text x=\"1058\" y=\"32.5\" dominant-baseline=\"central\" alignment-baseline=\"central\" class=\"actor actor-box\" style=\"text-anchor: middle; font-size: 16px; font-weight: 400;\"><tspan x=\"1058\" dy=\"0\">\"CTP API\"</tspan></text></g></g><g><line id=\"actor3\" x1=\"834\" y1=\"65\" x2=\"834\" y2=\"1958\" class=\"actor-line 200\" stroke-width=\"0.5px\" stroke=\"#999\" name=\"Redis\"></line><g id=\"root-3\"><rect x=\"759\" y=\"0\" fill=\"#eaeaea\" stroke=\"#666\" width=\"150\" height=\"65\" name=\"Redis\" rx=\"3\" ry=\"3\" class=\"actor actor-top\"></rect><text x=\"834\" y=\"32.5\" dominant-baseline=\"central\" alignment-baseline=\"central\" class=\"actor actor-box\" style=\"text-anchor: middle; font-size: 16px; font-weight: 400;\"><tspan x=\"834\" dy=\"0\">\"Redis Pub/Sub\"</tspan></text></g></g><g><line id=\"actor2\" x1=\"634\" y1=\"65\" x2=\"634\" y2=\"1958\" class=\"actor-line 200\" stroke-width=\"0.5px\" stroke=\"#999\" name=\"DB\"></line><g id=\"root-2\"><rect x=\"559\" y=\"0\" fill=\"#eaeaea\" stroke=\"#666\" width=\"150\" height=\"65\" name=\"DB\" rx=\"3\" ry=\"3\" class=\"actor actor-top\"></rect><text x=\"634\" y=\"32.5\" dominant-baseline=\"central\" alignment-baseline=\"central\" class=\"actor actor-box\" style=\"text-anchor: middle; font-size: 16px; font-weight: 400;\"><tspan x=\"634\" dy=\"0\">\"Django ORM\"</tspan></text></g></g><g><line id=\"actor1\" x1=\"293\" y1=\"65\" x2=\"293\" y2=\"1958\" class=\"actor-line 200\" stroke-width=\"0.5px\" stroke=\"#999\" name=\"Strategy\"></line><g id=\"root-1\"><rect x=\"218\" y=\"0\" fill=\"#eaeaea\" stroke=\"#666\" width=\"150\" height=\"65\" name=\"Strategy\" rx=\"3\" ry=\"3\" class=\"actor actor-top\"></rect><text x=\"293\" y=\"32.5\" dominant-baseline=\"central\" alignment-baseline=\"central\" class=\"actor actor-box\" style=\"text-anchor: middle; font-size: 16px; font-weight: 400;\"><tspan x=\"293\" dy=\"0\">\"TradeStrategy\"</tspan></text></g></g><g><line id=\"actor0\" x1=\"75\" y1=\"65\" x2=\"75\" y2=\"1958\" class=\"actor-line 200\" stroke-width=\"0.5px\" stroke=\"#999\" name=\"Cron\"></line><g id=\"root-0\"><rect x=\"0\" y=\"0\" fill=\"#eaeaea\" stroke=\"#666\" width=\"150\" height=\"65\" name=\"Cron\" rx=\"3\" ry=\"3\" class=\"actor actor-top\"></rect><text x=\"75\" y=\"32.5\" dominant-baseline=\"central\" alignment-baseline=\"central\" class=\"actor actor-box\" style=\"text-anchor: middle; font-size: 16px; font-weight: 400;\"><tspan x=\"75\" dy=\"-8\">\"Scheduled Tasks</tspan></text><text x=\"75\" y=\"32.5\" dominant-baseline=\"central\" alignment-baseline=\"central\" class=\"actor actor-box\" style=\"text-anchor: middle; font-size: 16px; font-weight: 400;\"><tspan x=\"75\" dy=\"8\">(croniter)\"</tspan></text></g></g><style>#mermaid-st9z5lq3kxl{font-family:ui-sans-serif,-apple-system,system-ui,Segoe UI,Helvetica;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#mermaid-st9z5lq3kxl .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#mermaid-st9z5lq3kxl .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#mermaid-st9z5lq3kxl .error-icon{fill:#dddddd;}#mermaid-st9z5lq3kxl .error-text{fill:#222222;stroke:#222222;}#mermaid-st9z5lq3kxl .edge-thickness-normal{stroke-width:1px;}#mermaid-st9z5lq3kxl .edge-thickness-thick{stroke-width:3.5px;}#mermaid-st9z5lq3kxl .edge-pattern-solid{stroke-dasharray:0;}#mermaid-st9z5lq3kxl .edge-thickness-invisible{stroke-width:0;fill:none;}#mermaid-st9z5lq3kxl .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-st9z5lq3kxl .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-st9z5lq3kxl .marker{fill:#999;stroke:#999;}#mermaid-st9z5lq3kxl .marker.cross{stroke:#999;}#mermaid-st9z5lq3kxl svg{font-family:ui-sans-serif,-apple-system,system-ui,Segoe UI,Helvetica;font-size:16px;}#mermaid-st9z5lq3kxl p{margin:0;}#mermaid-st9z5lq3kxl .actor{stroke:#cccccc;fill:#ffffff;}#mermaid-st9z5lq3kxl text.actor&gt;tspan{fill:#333;stroke:none;}#mermaid-st9z5lq3kxl .actor-line{stroke:#cccccc;}#mermaid-st9z5lq3kxl .innerArc{stroke-width:1.5;stroke-dasharray:none;}#mermaid-st9z5lq3kxl .messageLine0{stroke-width:1.5;stroke-dasharray:none;stroke:#999999;}#mermaid-st9z5lq3kxl .messageLine1{stroke-width:1.5;stroke-dasharray:2,2;stroke:#999999;}#mermaid-st9z5lq3kxl #arrowhead path{fill:#999999;stroke:#999999;}#mermaid-st9z5lq3kxl .sequenceNumber{fill:#666666;}#mermaid-st9z5lq3kxl #sequencenumber{fill:#999999;}#mermaid-st9z5lq3kxl #crosshead path{fill:#999999;stroke:#999999;}#mermaid-st9z5lq3kxl .messageText{fill:#333333;stroke:none;}#mermaid-st9z5lq3kxl .labelBox{stroke:#dddddd;fill:#ffffff;}#mermaid-st9z5lq3kxl .labelText,#mermaid-st9z5lq3kxl .labelText&gt;tspan{fill:#333;stroke:none;}#mermaid-st9z5lq3kxl .loopText,#mermaid-st9z5lq3kxl .loopText&gt;tspan{fill:#333;stroke:none;}#mermaid-st9z5lq3kxl .loopLine{stroke-width:2px;stroke-dasharray:2,2;stroke:#dddddd;fill:#dddddd;}#mermaid-st9z5lq3kxl .note{stroke:#e6d280;fill:#fff5ad;}#mermaid-st9z5lq3kxl .noteText,#mermaid-st9z5lq3kxl .noteText&gt;tspan{fill:#333;stroke:none;}#mermaid-st9z5lq3kxl .activation0{fill:hsl(-120, 0%, 91.7647058824%);stroke:hsl(-120, 0%, 81.7647058824%);}#mermaid-st9z5lq3kxl .activation1{fill:hsl(-120, 0%, 91.7647058824%);stroke:hsl(-120, 0%, 81.7647058824%);}#mermaid-st9z5lq3kxl .activation2{fill:hsl(-120, 0%, 91.7647058824%);stroke:hsl(-120, 0%, 81.7647058824%);}#mermaid-st9z5lq3kxl .actorPopupMenu{position:absolute;}#mermaid-st9z5lq3kxl .actorPopupMenuPanel{position:absolute;fill:#ffffff;box-shadow:0px 8px 16px 0px rgba(0,0,0,0.2);filter:drop-shadow(3px 5px 2px rgb(0 0 0 / 0.4));}#mermaid-st9z5lq3kxl .actor-man line{stroke:#cccccc;fill:#ffffff;}#mermaid-st9z5lq3kxl .actor-man circle,#mermaid-st9z5lq3kxl line{stroke:#cccccc;fill:#ffffff;stroke-width:2px;}#mermaid-st9z5lq3kxl :root{--mermaid-font-family:\"trebuchet ms\",verdana,arial,sans-serif;}</style><g></g><defs><symbol id=\"computer\" width=\"24\" height=\"24\"><path transform=\"scale(.5)\" d=\"M2 2v13h20v-13h-20zm18 11h-16v-9h16v9zm-10.228 6l.466-1h3.524l.467 1h-4.457zm14.228 3h-24l2-6h2.104l-1.33 4h18.45l-1.297-4h2.073l2 6zm-5-10h-14v-7h14v7z\"></path></symbol></defs><defs><symbol id=\"database\" fill-rule=\"evenodd\" clip-rule=\"evenodd\"><path transform=\"scale(.5)\" d=\"M12.258.001l.256.004.255.005.253.008.251.01.249.012.247.015.246.016.242.019.241.02.239.023.236.024.233.027.231.028.229.031.225.032.223.034.22.036.217.038.214.04.211.041.208.043.205.045.201.046.198.048.194.05.191.051.187.053.183.054.18.056.175.057.172.059.168.06.163.061.16.063.155.064.15.066.074.033.073.033.071.034.07.034.069.035.068.035.067.035.066.035.064.036.064.036.062.036.06.036.06.037.058.037.058.037.055.038.055.038.053.038.052.038.051.039.05.039.048.039.047.039.045.04.044.04.043.04.041.04.04.041.039.041.037.041.036.041.034.041.033.042.032.042.03.042.029.042.027.042.026.043.024.043.023.043.021.043.02.043.018.044.017.043.015.044.013.044.012.044.011.045.009.044.007.045.006.045.004.045.002.045.001.045v17l-.001.045-.002.045-.004.045-.006.045-.007.045-.009.044-.011.045-.012.044-.013.044-.015.044-.017.043-.018.044-.02.043-.021.043-.023.043-.024.043-.026.043-.027.042-.029.042-.03.042-.032.042-.033.042-.034.041-.036.041-.037.041-.039.041-.04.041-.041.04-.043.04-.044.04-.045.04-.047.039-.048.039-.05.039-.051.039-.052.038-.053.038-.055.038-.055.038-.058.037-.058.037-.06.037-.06.036-.062.036-.064.036-.064.036-.066.035-.067.035-.068.035-.069.035-.07.034-.071.034-.073.033-.074.033-.15.066-.155.064-.16.063-.163.061-.168.06-.172.059-.175.057-.18.056-.183.054-.187.053-.191.051-.194.05-.198.048-.201.046-.205.045-.208.043-.211.041-.214.04-.217.038-.22.036-.223.034-.225.032-.229.031-.231.028-.233.027-.236.024-.239.023-.241.02-.242.019-.246.016-.247.015-.249.012-.251.01-.253.008-.255.005-.256.004-.258.001-.258-.001-.256-.004-.255-.005-.253-.008-.251-.01-.249-.012-.247-.015-.245-.016-.243-.019-.241-.02-.238-.023-.236-.024-.234-.027-.231-.028-.228-.031-.226-.032-.223-.034-.22-.036-.217-.038-.214-.04-.211-.041-.208-.043-.204-.045-.201-.046-.198-.048-.195-.05-.19-.051-.187-.053-.184-.054-.179-.056-.176-.057-.172-.059-.167-.06-.164-.061-.159-.063-.155-.064-.151-.066-.074-.033-.072-.033-.072-.034-.07-.034-.069-.035-.068-.035-.067-.035-.066-.035-.064-.036-.063-.036-.062-.036-.061-.036-.06-.037-.058-.037-.057-.037-.056-.038-.055-.038-.053-.038-.052-.038-.051-.039-.049-.039-.049-.039-.046-.039-.046-.04-.044-.04-.043-.04-.041-.04-.04-.041-.039-.041-.037-.041-.036-.041-.034-.041-.033-.042-.032-.042-.03-.042-.029-.042-.027-.042-.026-.043-.024-.043-.023-.043-.021-.043-.02-.043-.018-.044-.017-.043-.015-.044-.013-.044-.012-.044-.011-.045-.009-.044-.007-.045-.006-.045-.004-.045-.002-.045-.001-.045v-17l.001-.045.002-.045.004-.045.006-.045.007-.045.009-.044.011-.045.012-.044.013-.044.015-.044.017-.043.018-.044.02-.043.021-.043.023-.043.024-.043.026-.043.027-.042.029-.042.03-.042.032-.042.033-.042.034-.041.036-.041.037-.041.039-.041.04-.041.041-.04.043-.04.044-.04.046-.04.046-.039.049-.039.049-.039.051-.039.052-.038.053-.038.055-.038.056-.038.057-.037.058-.037.06-.037.061-.036.062-.036.063-.036.064-.036.066-.035.067-.035.068-.035.069-.035.07-.034.072-.034.072-.033.074-.033.151-.066.155-.064.159-.063.164-.061.167-.06.172-.059.176-.057.179-.056.184-.054.187-.053.19-.051.195-.05.198-.048.201-.046.204-.045.208-.043.211-.041.214-.04.217-.038.22-.036.223-.034.226-.032.228-.031.231-.028.234-.027.236-.024.238-.023.241-.02.243-.019.245-.016.247-.015.249-.012.251-.01.253-.008.255-.005.256-.004.258-.001.258.001zm-9.258 20.499v.01l.001.021.003.021.004.022.005.021.006.022.007.022.009.023.01.022.011.023.012.023.013.023.015.023.016.024.017.023.018.024.019.024.021.024.022.025.023.024.024.025.052.049.056.05.061.051.066.051.07.051.075.051.079.052.084.052.088.052.092.052.097.052.102.051.105.052.11.052.114.051.119.051.123.051.127.05.131.05.135.05.139.048.144.049.147.047.152.047.155.047.16.045.163.045.167.043.171.043.176.041.178.041.183.039.187.039.19.037.194.035.197.035.202.033.204.031.209.03.212.029.216.027.219.025.222.024.226.021.23.02.233.018.236.016.24.015.243.012.246.01.249.008.253.005.256.004.259.001.26-.001.257-.004.254-.005.25-.008.247-.011.244-.012.241-.014.237-.016.233-.018.231-.021.226-.021.224-.024.22-.026.216-.027.212-.028.21-.031.205-.031.202-.034.198-.034.194-.036.191-.037.187-.039.183-.04.179-.04.175-.042.172-.043.168-.044.163-.045.16-.046.155-.046.152-.047.148-.048.143-.049.139-.049.136-.05.131-.05.126-.05.123-.051.118-.052.114-.051.11-.052.106-.052.101-.052.096-.052.092-.052.088-.053.083-.051.079-.052.074-.052.07-.051.065-.051.06-.051.056-.05.051-.05.023-.024.023-.025.021-.024.02-.024.019-.024.018-.024.017-.024.015-.023.014-.024.013-.023.012-.023.01-.023.01-.022.008-.022.006-.022.006-.022.004-.022.004-.021.001-.021.001-.021v-4.127l-.077.055-.08.053-.083.054-.085.053-.087.052-.09.052-.093.051-.095.05-.097.05-.1.049-.102.049-.105.048-.106.047-.109.047-.111.046-.114.045-.115.045-.118.044-.12.043-.122.042-.124.042-.126.041-.128.04-.13.04-.132.038-.134.038-.135.037-.138.037-.139.035-.142.035-.143.034-.144.033-.147.032-.148.031-.15.03-.151.03-.153.029-.154.027-.156.027-.158.026-.159.025-.161.024-.162.023-.163.022-.165.021-.166.02-.167.019-.169.018-.169.017-.171.016-.173.015-.173.014-.175.013-.175.012-.177.011-.178.01-.179.008-.179.008-.181.006-.182.005-.182.004-.184.003-.184.002h-.37l-.184-.002-.184-.003-.182-.004-.182-.005-.181-.006-.179-.008-.179-.008-.178-.01-.176-.011-.176-.012-.175-.013-.173-.014-.172-.015-.171-.016-.17-.017-.169-.018-.167-.019-.166-.02-.165-.021-.163-.022-.162-.023-.161-.024-.159-.025-.157-.026-.156-.027-.155-.027-.153-.029-.151-.03-.15-.03-.148-.031-.146-.032-.145-.033-.143-.034-.141-.035-.14-.035-.137-.037-.136-.037-.134-.038-.132-.038-.13-.04-.128-.04-.126-.041-.124-.042-.122-.042-.12-.044-.117-.043-.116-.045-.113-.045-.112-.046-.109-.047-.106-.047-.105-.048-.102-.049-.1-.049-.097-.05-.095-.05-.093-.052-.09-.051-.087-.052-.085-.053-.083-.054-.08-.054-.077-.054v4.127zm0-5.654v.011l.001.021.003.021.004.021.005.022.006.022.007.022.009.022.01.022.011.023.012.023.013.023.015.024.016.023.017.024.018.024.019.024.021.024.022.024.023.025.024.024.052.05.056.05.061.05.066.051.07.051.075.052.079.051.084.052.088.052.092.052.097.052.102.052.105.052.11.051.114.051.119.052.123.05.127.051.131.05.135.049.139.049.144.048.147.048.152.047.155.046.16.045.163.045.167.044.171.042.176.042.178.04.183.04.187.038.19.037.194.036.197.034.202.033.204.032.209.03.212.028.216.027.219.025.222.024.226.022.23.02.233.018.236.016.24.014.243.012.246.01.249.008.253.006.256.003.259.001.26-.001.257-.003.254-.006.25-.008.247-.01.244-.012.241-.015.237-.016.233-.018.231-.02.226-.022.224-.024.22-.025.216-.027.212-.029.21-.03.205-.032.202-.033.198-.035.194-.036.191-.037.187-.039.183-.039.179-.041.175-.042.172-.043.168-.044.163-.045.16-.045.155-.047.152-.047.148-.048.143-.048.139-.05.136-.049.131-.05.126-.051.123-.051.118-.051.114-.052.11-.052.106-.052.101-.052.096-.052.092-.052.088-.052.083-.052.079-.052.074-.051.07-.052.065-.051.06-.05.056-.051.051-.049.023-.025.023-.024.021-.025.02-.024.019-.024.018-.024.017-.024.015-.023.014-.023.013-.024.012-.022.01-.023.01-.023.008-.022.006-.022.006-.022.004-.021.004-.022.001-.021.001-.021v-4.139l-.077.054-.08.054-.083.054-.085.052-.087.053-.09.051-.093.051-.095.051-.097.05-.1.049-.102.049-.105.048-.106.047-.109.047-.111.046-.114.045-.115.044-.118.044-.12.044-.122.042-.124.042-.126.041-.128.04-.13.039-.132.039-.134.038-.135.037-.138.036-.139.036-.142.035-.143.033-.144.033-.147.033-.148.031-.15.03-.151.03-.153.028-.154.028-.156.027-.158.026-.159.025-.161.024-.162.023-.163.022-.165.021-.166.02-.167.019-.169.018-.169.017-.171.016-.173.015-.173.014-.175.013-.175.012-.177.011-.178.009-.179.009-.179.007-.181.007-.182.005-.182.004-.184.003-.184.002h-.37l-.184-.002-.184-.003-.182-.004-.182-.005-.181-.007-.179-.007-.179-.009-.178-.009-.176-.011-.176-.012-.175-.013-.173-.014-.172-.015-.171-.016-.17-.017-.169-.018-.167-.019-.166-.02-.165-.021-.163-.022-.162-.023-.161-.024-.159-.025-.157-.026-.156-.027-.155-.028-.153-.028-.151-.03-.15-.03-.148-.031-.146-.033-.145-.033-.143-.033-.141-.035-.14-.036-.137-.036-.136-.037-.134-.038-.132-.039-.13-.039-.128-.04-.126-.041-.124-.042-.122-.043-.12-.043-.117-.044-.116-.044-.113-.046-.112-.046-.109-.046-.106-.047-.105-.048-.102-.049-.1-.049-.097-.05-.095-.051-.093-.051-.09-.051-.087-.053-.085-.052-.083-.054-.08-.054-.077-.054v4.139zm0-5.666v.011l.001.02.003.022.004.021.005.022.006.021.007.022.009.023.01.022.011.023.012.023.013.023.015.023.016.024.017.024.018.023.019.024.021.025.022.024.023.024.024.025.052.05.056.05.061.05.066.051.07.051.075.052.079.051.084.052.088.052.092.052.097.052.102.052.105.051.11.052.114.051.119.051.123.051.127.05.131.05.135.05.139.049.144.048.147.048.152.047.155.046.16.045.163.045.167.043.171.043.176.042.178.04.183.04.187.038.19.037.194.036.197.034.202.033.204.032.209.03.212.028.216.027.219.025.222.024.226.021.23.02.233.018.236.017.24.014.243.012.246.01.249.008.253.006.256.003.259.001.26-.001.257-.003.254-.006.25-.008.247-.01.244-.013.241-.014.237-.016.233-.018.231-.02.226-.022.224-.024.22-.025.216-.027.212-.029.21-.03.205-.032.202-.033.198-.035.194-.036.191-.037.187-.039.183-.039.179-.041.175-.042.172-.043.168-.044.163-.045.16-.045.155-.047.152-.047.148-.048.143-.049.139-.049.136-.049.131-.051.126-.05.123-.051.118-.052.114-.051.11-.052.106-.052.101-.052.096-.052.092-.052.088-.052.083-.052.079-.052.074-.052.07-.051.065-.051.06-.051.056-.05.051-.049.023-.025.023-.025.021-.024.02-.024.019-.024.018-.024.017-.024.015-.023.014-.024.013-.023.012-.023.01-.022.01-.023.008-.022.006-.022.006-.022.004-.022.004-.021.001-.021.001-.021v-4.153l-.077.054-.08.054-.083.053-.085.053-.087.053-.09.051-.093.051-.095.051-.097.05-.1.049-.102.048-.105.048-.106.048-.109.046-.111.046-.114.046-.115.044-.118.044-.12.043-.122.043-.124.042-.126.041-.128.04-.13.039-.132.039-.134.038-.135.037-.138.036-.139.036-.142.034-.143.034-.144.033-.147.032-.148.032-.15.03-.151.03-.153.028-.154.028-.156.027-.158.026-.159.024-.161.024-.162.023-.163.023-.165.021-.166.02-.167.019-.169.018-.169.017-.171.016-.173.015-.173.014-.175.013-.175.012-.177.01-.178.01-.179.009-.179.007-.181.006-.182.006-.182.004-.184.003-.184.001-.185.001-.185-.001-.184-.001-.184-.003-.182-.004-.182-.006-.181-.006-.179-.007-.179-.009-.178-.01-.176-.01-.176-.012-.175-.013-.173-.014-.172-.015-.171-.016-.17-.017-.169-.018-.167-.019-.166-.02-.165-.021-.163-.023-.162-.023-.161-.024-.159-.024-.157-.026-.156-.027-.155-.028-.153-.028-.151-.03-.15-.03-.148-.032-.146-.032-.145-.033-.143-.034-.141-.034-.14-.036-.137-.036-.136-.037-.134-.038-.132-.039-.13-.039-.128-.041-.126-.041-.124-.041-.122-.043-.12-.043-.117-.044-.116-.044-.113-.046-.112-.046-.109-.046-.106-.048-.105-.048-.102-.048-.1-.05-.097-.049-.095-.051-.093-.051-.09-.052-.087-.052-.085-.053-.083-.053-.08-.054-.077-.054v4.153zm8.74-8.179l-.257.004-.254.005-.25.008-.247.011-.244.012-.241.014-.237.016-.233.018-.231.021-.226.022-.224.023-.22.026-.216.027-.212.028-.21.031-.205.032-.202.033-.198.034-.194.036-.191.038-.187.038-.183.04-.179.041-.175.042-.172.043-.168.043-.163.045-.16.046-.155.046-.152.048-.148.048-.143.048-.139.049-.136.05-.131.05-.126.051-.123.051-.118.051-.114.052-.11.052-.106.052-.101.052-.096.052-.092.052-.088.052-.083.052-.079.052-.074.051-.07.052-.065.051-.06.05-.056.05-.051.05-.023.025-.023.024-.021.024-.02.025-.019.024-.018.024-.017.023-.015.024-.014.023-.013.023-.012.023-.01.023-.01.022-.008.022-.006.023-.006.021-.004.022-.004.021-.001.021-.001.021.001.021.001.021.004.021.004.022.006.021.006.023.008.022.01.022.01.023.012.023.013.023.014.023.015.024.017.023.018.024.019.024.02.025.021.024.023.024.023.025.051.05.056.05.06.05.065.051.07.052.074.051.079.052.083.052.088.052.092.052.096.052.101.052.106.052.11.052.114.052.118.051.123.051.126.051.131.05.136.05.139.049.143.048.148.048.152.048.155.046.16.046.163.045.168.043.172.043.175.042.179.041.183.04.187.038.191.038.194.036.198.034.202.033.205.032.21.031.212.028.216.027.22.026.224.023.226.022.231.021.233.018.237.016.241.014.244.012.247.011.25.008.254.005.257.004.26.001.26-.001.257-.004.254-.005.25-.008.247-.011.244-.012.241-.014.237-.016.233-.018.231-.021.226-.022.224-.023.22-.026.216-.027.212-.028.21-.031.205-.032.202-.033.198-.034.194-.036.191-.038.187-.038.183-.04.179-.041.175-.042.172-.043.168-.043.163-.045.16-.046.155-.046.152-.048.148-.048.143-.048.139-.049.136-.05.131-.05.126-.051.123-.051.118-.051.114-.052.11-.052.106-.052.101-.052.096-.052.092-.052.088-.052.083-.052.079-.052.074-.051.07-.052.065-.051.06-.05.056-.05.051-.05.023-.025.023-.024.021-.024.02-.025.019-.024.018-.024.017-.023.015-.024.014-.023.013-.023.012-.023.01-.023.01-.022.008-.022.006-.023.006-.021.004-.022.004-.021.001-.021.001-.021-.001-.021-.001-.021-.004-.021-.004-.022-.006-.021-.006-.023-.008-.022-.01-.022-.01-.023-.012-.023-.013-.023-.014-.023-.015-.024-.017-.023-.018-.024-.019-.024-.02-.025-.021-.024-.023-.024-.023-.025-.051-.05-.056-.05-.06-.05-.065-.051-.07-.052-.074-.051-.079-.052-.083-.052-.088-.052-.092-.052-.096-.052-.101-.052-.106-.052-.11-.052-.114-.052-.118-.051-.123-.051-.126-.051-.131-.05-.136-.05-.139-.049-.143-.048-.148-.048-.152-.048-.155-.046-.16-.046-.163-.045-.168-.043-.172-.043-.175-.042-.179-.041-.183-.04-.187-.038-.191-.038-.194-.036-.198-.034-.202-.033-.205-.032-.21-.031-.212-.028-.216-.027-.22-.026-.224-.023-.226-.022-.231-.021-.233-.018-.237-.016-.241-.014-.244-.012-.247-.011-.25-.008-.254-.005-.257-.004-.26-.001-.26.001z\"></path></symbol></defs><defs><symbol id=\"clock\" width=\"24\" height=\"24\"><path transform=\"scale(.5)\" d=\"M12 2c5.514 0 10 4.486 10 10s-4.486 10-10 10-10-4.486-10-10 4.486-10 10-10zm0-2c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm5.848 12.459c.202.038.202.333.001.372-1.907.361-6.045 1.111-6.547 1.111-.719 0-1.301-.582-1.301-1.301 0-.512.77-5.447 1.125-7.445.034-.192.312-.181.343.014l.985 6.238 5.394 1.011z\"></path></symbol></defs><defs><marker id=\"arrowhead\" refX=\"7.9\" refY=\"5\" markerUnits=\"userSpaceOnUse\" markerWidth=\"12\" markerHeight=\"12\" orient=\"auto-start-reverse\"><path d=\"M -1 0 L 10 5 L 0 10 z\"></path></marker></defs><defs><marker id=\"crosshead\" markerWidth=\"15\" markerHeight=\"8\" orient=\"auto\" refX=\"4\" refY=\"4.5\"><path fill=\"none\" stroke=\"#000000\" stroke-width=\"1pt\" d=\"M 1,2 L 6,7 M 6,2 L 1,7\" style=\"stroke-dasharray: 0, 0;\"></path></marker></defs><defs><marker id=\"filled-head\" refX=\"15.5\" refY=\"7\" markerWidth=\"20\" markerHeight=\"28\" orient=\"auto\"><path d=\"M 18,7 L9,13 L14,7 L9,1 Z\"></path></marker></defs><defs><marker id=\"sequencenumber\" refX=\"15\" refY=\"15\" markerWidth=\"60\" markerHeight=\"40\" orient=\"auto\"><circle cx=\"15\" cy=\"15\" r=\"6\"></circle></marker></defs><g><rect x=\"50\" y=\"75\" fill=\"#EDF2AE\" stroke=\"#666\" width=\"268\" height=\"39\" class=\"note\"></rect><text x=\"184\" y=\"80\" text-anchor=\"middle\" dominant-baseline=\"middle\" alignment-baseline=\"middle\" class=\"noteText\" dy=\"1em\" style=\"font-size: 16px; font-weight: 400;\"><tspan x=\"184\">17:00 - Data Collection</tspan></text></g><g><rect x=\"50\" y=\"578\" fill=\"#EDF2AE\" stroke=\"#666\" width=\"268\" height=\"39\" class=\"note\"></rect><text x=\"184\" y=\"583\" text-anchor=\"middle\" dominant-baseline=\"middle\" alignment-baseline=\"middle\" class=\"noteText\" dy=\"1em\" style=\"font-size: 16px; font-weight: 400;\"><tspan x=\"184\">08:55 - Day Session Signal Processing</tspan></text></g><g><rect x=\"268\" y=\"969\" fill=\"#EDF2AE\" stroke=\"#666\" width=\"815\" height=\"39\" class=\"note\"></rect><text x=\"676\" y=\"974\" text-anchor=\"middle\" dominant-baseline=\"middle\" alignment-baseline=\"middle\" class=\"noteText\" dy=\"1em\" style=\"font-size: 16px; font-weight: 400;\"><tspan x=\"676\">Order Execution</tspan></text></g><g><rect x=\"50\" y=\"1330\" fill=\"#EDF2AE\" stroke=\"#666\" width=\"268\" height=\"39\" class=\"note\"></rect><text x=\"184\" y=\"1335\" text-anchor=\"middle\" dominant-baseline=\"middle\" alignment-baseline=\"middle\" class=\"noteText\" dy=\"1em\" style=\"font-size: 16px; font-weight: 400;\"><tspan x=\"184\">15:20 - Market Close</tspan></text></g><g><rect x=\"50\" y=\"1743\" fill=\"#EDF2AE\" stroke=\"#666\" width=\"268\" height=\"39\" class=\"note\"></rect><text x=\"184\" y=\"1748\" text-anchor=\"middle\" dominant-baseline=\"middle\" alignment-baseline=\"middle\" class=\"noteText\" dy=\"1em\" style=\"font-size: 16px; font-weight: 400;\"><tspan x=\"184\">15:30 - Performance Update</tspan></text></g><text x=\"183\" y=\"129\" text-anchor=\"middle\" dominant-baseline=\"middle\" alignment-baseline=\"middle\" class=\"messageText\" dy=\"1em\" style=\"font-size: 16px; font-weight: 400;\">collect_quote()</text><line x1=\"76\" y1=\"166\" x2=\"289\" y2=\"166\" class=\"messageLine0\" stroke-width=\"2\" stroke=\"none\" marker-end=\"url(#arrowhead)\" style=\"fill: none;\"></line><text x=\"294\" y=\"181\" text-anchor=\"middle\" dominant-baseline=\"middle\" alignment-baseline=\"middle\" class=\"messageText\" dy=\"1em\" style=\"font-size: 16px; font-weight: 400;\">Fetch from 5 exchanges</text><path d=\"M 294,218 C 354,208 354,248 294,238\" class=\"messageLine0\" stroke-width=\"2\" stroke=\"none\" marker-end=\"url(#arrowhead)\" style=\"fill: none;\"></path><text x=\"462\" y=\"263\" text-anchor=\"middle\" dominant-baseline=\"middle\" alignment-baseline=\"middle\" class=\"messageText\" dy=\"1em\" style=\"font-size: 16px; font-weight: 400;\">Store DailyBar records</text><line x1=\"294\" y1=\"300\" x2=\"630\" y2=\"300\" class=\"messageLine0\" stroke-width=\"2\" stroke=\"none\" marker-end=\"url(#arrowhead)\" style=\"fill: none;\"></line><text x=\"294\" y=\"315\" text-anchor=\"middle\" dominant-baseline=\"middle\" alignment-baseline=\"middle\" class=\"messageText\" dy=\"1em\" style=\"font-size: 16px; font-weight: 400;\">calc_main_inst()</text><path d=\"M 294,352 C 354,342 354,382 294,372\" class=\"messageLine0\" stroke-width=\"2\" stroke=\"none\" marker-end=\"url(#arrowhead)\" style=\"fill: none;\"></path><text x=\"462\" y=\"397\" text-anchor=\"middle\" dominant-baseline=\"middle\" alignment-baseline=\"middle\" class=\"messageText\" dy=\"1em\" style=\"font-size: 16px; font-weight: 400;\">Update MainBar with rollover</text><line x1=\"294\" y1=\"434\" x2=\"630\" y2=\"434\" class=\"messageLine0\" stroke-width=\"2\" stroke=\"none\" marker-end=\"url(#arrowhead)\" style=\"fill: none;\"></line><text x=\"294\" y=\"449\" text-anchor=\"middle\" dominant-baseline=\"middle\" alignment-baseline=\"middle\" class=\"messageText\" dy=\"1em\" style=\"font-size: 16px; font-weight: 400;\">calc_signal()</text><path d=\"M 294,486 C 354,476 354,516 294,506\" class=\"messageLine0\" stroke-width=\"2\" stroke=\"none\" marker-end=\"url(#arrowhead)\" style=\"fill: none;\"></path><text x=\"462\" y=\"531\" text-anchor=\"middle\" dominant-baseline=\"middle\" alignment-baseline=\"middle\" class=\"messageText\" dy=\"1em\" style=\"font-size: 16px; font-weight: 400;\">Create Signal records</text><line x1=\"294\" y1=\"568\" x2=\"630\" y2=\"568\" class=\"messageLine0\" stroke-width=\"2\" stroke=\"none\" marker-end=\"url(#arrowhead)\" style=\"fill: none;\"></line><text x=\"183\" y=\"632\" text-anchor=\"middle\" dominant-baseline=\"middle\" alignment-baseline=\"middle\" class=\"messageText\" dy=\"1em\" style=\"font-size: 16px; font-weight: 400;\">processing_signal1()</text><line x1=\"76\" y1=\"669\" x2=\"289\" y2=\"669\" class=\"messageLine0\" stroke-width=\"2\" stroke=\"none\" marker-end=\"url(#arrowhead)\" style=\"fill: none;\"></line><text x=\"462\" y=\"684\" text-anchor=\"middle\" dominant-baseline=\"middle\" alignment-baseline=\"middle\" class=\"messageText\" dy=\"1em\" style=\"font-size: 16px; font-weight: 400;\">Query unprocessed Signals</text><line x1=\"294\" y1=\"721\" x2=\"630\" y2=\"721\" class=\"messageLine0\" stroke-width=\"2\" stroke=\"none\" marker-end=\"url(#arrowhead)\" style=\"fill: none;\"></line><text x=\"465\" y=\"736\" text-anchor=\"middle\" dominant-baseline=\"middle\" alignment-baseline=\"middle\" class=\"messageText\" dy=\"1em\" style=\"font-size: 16px; font-weight: 400;\">Signal list</text><line x1=\"633\" y1=\"773\" x2=\"297\" y2=\"773\" class=\"messageLine1\" stroke-width=\"2\" stroke=\"none\" marker-end=\"url(#arrowhead)\" style=\"stroke-dasharray: 3, 3; fill: none;\"></line><text x=\"294\" y=\"788\" text-anchor=\"middle\" dominant-baseline=\"middle\" alignment-baseline=\"middle\" class=\"messageText\" dy=\"1em\" style=\"font-size: 16px; font-weight: 400;\">ReqOrderInsert(signal)</text><path d=\"M 294,825 C 354,815 354,855 294,845\" class=\"messageLine0\" stroke-width=\"2\" stroke=\"none\" marker-end=\"url(#arrowhead)\" style=\"fill: none;\"></path><text x=\"562\" y=\"870\" text-anchor=\"middle\" dominant-baseline=\"middle\" alignment-baseline=\"middle\" class=\"messageText\" dy=\"1em\" style=\"font-size: 16px; font-weight: 400;\">Publish order request</text><line x1=\"294\" y1=\"907\" x2=\"830\" y2=\"907\" class=\"messageLine0\" stroke-width=\"2\" stroke=\"none\" marker-end=\"url(#arrowhead)\" style=\"fill: none;\"></line><text x=\"945\" y=\"922\" text-anchor=\"middle\" dominant-baseline=\"middle\" alignment-baseline=\"middle\" class=\"messageText\" dy=\"1em\" style=\"font-size: 16px; font-weight: 400;\">Forward to exchange</text><line x1=\"835\" y1=\"959\" x2=\"1054\" y2=\"959\" class=\"messageLine0\" stroke-width=\"2\" stroke=\"none\" marker-end=\"url(#arrowhead)\" style=\"fill: none;\"></line><text x=\"948\" y=\"1023\" text-anchor=\"middle\" dominant-baseline=\"middle\" alignment-baseline=\"middle\" class=\"messageText\" dy=\"1em\" style=\"font-size: 16px; font-weight: 400;\">OnRtnOrder (status)</text><line x1=\"1057\" y1=\"1060\" x2=\"838\" y2=\"1060\" class=\"messageLine1\" stroke-width=\"2\" stroke=\"none\" marker-end=\"url(#arrowhead)\" style=\"stroke-dasharray: 3, 3; fill: none;\"></line><text x=\"565\" y=\"1075\" text-anchor=\"middle\" dominant-baseline=\"middle\" alignment-baseline=\"middle\" class=\"messageText\" dy=\"1em\" style=\"font-size: 16px; font-weight: 400;\">Order confirmation</text><line x1=\"833\" y1=\"1112\" x2=\"297\" y2=\"1112\" class=\"messageLine1\" stroke-width=\"2\" stroke=\"none\" marker-end=\"url(#arrowhead)\" style=\"stroke-dasharray: 3, 3; fill: none;\"></line><text x=\"462\" y=\"1127\" text-anchor=\"middle\" dominant-baseline=\"middle\" alignment-baseline=\"middle\" class=\"messageText\" dy=\"1em\" style=\"font-size: 16px; font-weight: 400;\">Create/Update Order</text><line x1=\"294\" y1=\"1164\" x2=\"630\" y2=\"1164\" class=\"messageLine0\" stroke-width=\"2\" stroke=\"none\" marker-end=\"url(#arrowhead)\" style=\"fill: none;\"></line><text x=\"948\" y=\"1179\" text-anchor=\"middle\" dominant-baseline=\"middle\" alignment-baseline=\"middle\" class=\"messageText\" dy=\"1em\" style=\"font-size: 16px; font-weight: 400;\">OnRtnTrade (fill)</text><line x1=\"1057\" y1=\"1216\" x2=\"838\" y2=\"1216\" class=\"messageLine1\" stroke-width=\"2\" stroke=\"none\" marker-end=\"url(#arrowhead)\" style=\"stroke-dasharray: 3, 3; fill: none;\"></line><text x=\"565\" y=\"1231\" text-anchor=\"middle\" dominant-baseline=\"middle\" alignment-baseline=\"middle\" class=\"messageText\" dy=\"1em\" style=\"font-size: 16px; font-weight: 400;\">Trade confirmation</text><line x1=\"833\" y1=\"1268\" x2=\"297\" y2=\"1268\" class=\"messageLine1\" stroke-width=\"2\" stroke=\"none\" marker-end=\"url(#arrowhead)\" style=\"stroke-dasharray: 3, 3; fill: none;\"></line><text x=\"462\" y=\"1283\" text-anchor=\"middle\" dominant-baseline=\"middle\" alignment-baseline=\"middle\" class=\"messageText\" dy=\"1em\" style=\"font-size: 16px; font-weight: 400;\">Update Trade, mark Signal.processed</text><line x1=\"294\" y1=\"1320\" x2=\"630\" y2=\"1320\" class=\"messageLine0\" stroke-width=\"2\" stroke=\"none\" marker-end=\"url(#arrowhead)\" style=\"fill: none;\"></line><text x=\"183\" y=\"1384\" text-anchor=\"middle\" dominant-baseline=\"middle\" alignment-baseline=\"middle\" class=\"messageText\" dy=\"1em\" style=\"font-size: 16px; font-weight: 400;\">refresh_all()</text><line x1=\"76\" y1=\"1421\" x2=\"289\" y2=\"1421\" class=\"messageLine0\" stroke-width=\"2\" stroke=\"none\" marker-end=\"url(#arrowhead)\" style=\"fill: none;\"></line><text x=\"674\" y=\"1436\" text-anchor=\"middle\" dominant-baseline=\"middle\" alignment-baseline=\"middle\" class=\"messageText\" dy=\"1em\" style=\"font-size: 16px; font-weight: 400;\">Query account via Redis</text><line x1=\"294\" y1=\"1473\" x2=\"1054\" y2=\"1473\" class=\"messageLine0\" stroke-width=\"2\" stroke=\"none\" marker-end=\"url(#arrowhead)\" style=\"fill: none;\"></line><text x=\"677\" y=\"1488\" text-anchor=\"middle\" dominant-baseline=\"middle\" alignment-baseline=\"middle\" class=\"messageText\" dy=\"1em\" style=\"font-size: 16px; font-weight: 400;\">Account data</text><line x1=\"1057\" y1=\"1525\" x2=\"297\" y2=\"1525\" class=\"messageLine1\" stroke-width=\"2\" stroke=\"none\" marker-end=\"url(#arrowhead)\" style=\"stroke-dasharray: 3, 3; fill: none;\"></line><text x=\"462\" y=\"1540\" text-anchor=\"middle\" dominant-baseline=\"middle\" alignment-baseline=\"middle\" class=\"messageText\" dy=\"1em\" style=\"font-size: 16px; font-weight: 400;\">Update Broker</text><line x1=\"294\" y1=\"1577\" x2=\"630\" y2=\"1577\" class=\"messageLine0\" stroke-width=\"2\" stroke=\"none\" marker-end=\"url(#arrowhead)\" style=\"fill: none;\"></line><text x=\"674\" y=\"1592\" text-anchor=\"middle\" dominant-baseline=\"middle\" alignment-baseline=\"middle\" class=\"messageText\" dy=\"1em\" style=\"font-size: 16px; font-weight: 400;\">Query positions via Redis</text><line x1=\"294\" y1=\"1629\" x2=\"1054\" y2=\"1629\" class=\"messageLine0\" stroke-width=\"2\" stroke=\"none\" marker-end=\"url(#arrowhead)\" style=\"fill: none;\"></line><text x=\"677\" y=\"1644\" text-anchor=\"middle\" dominant-baseline=\"middle\" alignment-baseline=\"middle\" class=\"messageText\" dy=\"1em\" style=\"font-size: 16px; font-weight: 400;\">Position list</text><line x1=\"1057\" y1=\"1681\" x2=\"297\" y2=\"1681\" class=\"messageLine1\" stroke-width=\"2\" stroke=\"none\" marker-end=\"url(#arrowhead)\" style=\"stroke-dasharray: 3, 3; fill: none;\"></line><text x=\"462\" y=\"1696\" text-anchor=\"middle\" dominant-baseline=\"middle\" alignment-baseline=\"middle\" class=\"messageText\" dy=\"1em\" style=\"font-size: 16px; font-weight: 400;\">Update Trade records</text><line x1=\"294\" y1=\"1733\" x2=\"630\" y2=\"1733\" class=\"messageLine0\" stroke-width=\"2\" stroke=\"none\" marker-end=\"url(#arrowhead)\" style=\"fill: none;\"></line><text x=\"183\" y=\"1797\" text-anchor=\"middle\" dominant-baseline=\"middle\" alignment-baseline=\"middle\" class=\"messageText\" dy=\"1em\" style=\"font-size: 16px; font-weight: 400;\">update_equity()</text><line x1=\"76\" y1=\"1834\" x2=\"289\" y2=\"1834\" class=\"messageLine0\" stroke-width=\"2\" stroke=\"none\" marker-end=\"url(#arrowhead)\" style=\"fill: none;\"></line><text x=\"462\" y=\"1849\" text-anchor=\"middle\" dominant-baseline=\"middle\" alignment-baseline=\"middle\" class=\"messageText\" dy=\"1em\" style=\"font-size: 16px; font-weight: 400;\">Calculate NAV, equity</text><line x1=\"294\" y1=\"1886\" x2=\"630\" y2=\"1886\" class=\"messageLine0\" stroke-width=\"2\" stroke=\"none\" marker-end=\"url(#arrowhead)\" style=\"fill: none;\"></line><text x=\"462\" y=\"1901\" text-anchor=\"middle\" dominant-baseline=\"middle\" alignment-baseline=\"middle\" class=\"messageText\" dy=\"1em\" style=\"font-size: 16px; font-weight: 400;\">Create Performance record</text><line x1=\"294\" y1=\"1938\" x2=\"630\" y2=\"1938\" class=\"messageLine0\" stroke-width=\"2\" stroke=\"none\" marker-end=\"url(#arrowhead)\" style=\"fill: none;\"></line></svg></div><div class=\"absolute right-2 top-2 flex items-center gap-1 opacity-0 transition-opacity group-hover:opacity-100\"><button class=\"cursor-pointer rounded-sm p-1 text-[#333] opacity-70 transition-opacity hover:opacity-100 dark:text-white\" aria-label=\"Zoom in\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"16\" height=\"16\" fill=\"currentColor\" viewBox=\"0 0 256 256\"><path d=\"M224,128a8,8,0,0,1-8,8H136v80a8,8,0,0,1-16,0V136H40a8,8,0,0,1,0-16h80V40a8,8,0,0,1,16,0v80h80A8,8,0,0,1,224,128Z\"></path></svg></button><button class=\"cursor-pointer rounded-sm p-1 text-[#333] opacity-70 transition-opacity hover:opacity-100 dark:text-white\" aria-label=\"Zoom out\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"16\" height=\"16\" fill=\"currentColor\" viewBox=\"0 0 256 256\"><path d=\"M224,128a8,8,0,0,1-8,8H40a8,8,0,0,1,0-16H216A8,8,0,0,1,224,128Z\"></path></svg></button><div class=\"rounded-sm p-1\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"16\" height=\"16\" fill=\"currentColor\" viewBox=\"0 0 256 256\" class=\"text-[#333] dark:text-white\"><path d=\"M216,48V96a8,8,0,0,1-16,0V67.31l-42.34,42.35a8,8,0,0,1-11.32-11.32L188.69,56H160a8,8,0,0,1,0-16h48A8,8,0,0,1,216,48ZM98.34,146.34,56,188.69V160a8,8,0,0,0-16,0v48a8,8,0,0,0,8,8H96a8,8,0,0,0,0-16H67.31l42.35-42.34a8,8,0,0,0-11.32-11.32ZM208,152a8,8,0,0,0-8,8v28.69l-42.34-42.35a8,8,0,0,0-11.32,11.32L188.69,200H160a8,8,0,0,0,0,16h48a8,8,0,0,0,8-8V160A8,8,0,0,0,208,152ZM67.31,56H96a8,8,0,0,0,0-16H48a8,8,0,0,0-8,8V96a8,8,0,0,0,16,0V67.31l42.34,42.35a8,8,0,0,0,11.32-11.32Z\"></path></svg></div></div></div></pre>\n<p><strong>Sources</strong>: <a href=\"https://github.com/timercrack/trader/blob/3307c308/trader/strategy/brother2.py#L568-L703\" target=\"_blank\" rel=\"noopener noreferrer\" class=\"mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75\"><span class=\"flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4]\"><svg class=\"mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block\" fill=\"currentColor\" viewBox=\"0 0 24 24\"><path d=\"M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z\"></path></svg>trader/strategy/brother2.py</span><span class=\"flex flex-shrink-0 items-center rounded-r border-l px-2 py-1.5 border-[#dddddd] bg-[#d8d8d8] text-[#666666] dark:border-[#333333] dark:bg-[#2a2a2a] dark:text-[#888888]\">568-703</span></a> <a href=\"https://github.com/timercrack/trader/blob/3307c308/trader/strategy/brother2.py#L684-L723\" target=\"_blank\" rel=\"noopener noreferrer\" class=\"mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75\"><span class=\"flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4]\"><svg class=\"mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block\" fill=\"currentColor\" viewBox=\"0 0 24 24\"><path d=\"M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z\"></path></svg>trader/strategy/brother2.py</span><span class=\"flex flex-shrink-0 items-center rounded-r border-l px-2 py-1.5 border-[#dddddd] bg-[#d8d8d8] text-[#666666] dark:border-[#333333] dark:bg-[#2a2a2a] dark:text-[#888888]\">684-723</span></a> <a href=\"https://github.com/timercrack/trader/blob/3307c308/trader/strategy/brother2.py#L572-L643\" target=\"_blank\" rel=\"noopener noreferrer\" class=\"mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75\"><span class=\"flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4]\"><svg class=\"mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block\" fill=\"currentColor\" viewBox=\"0 0 24 24\"><path d=\"M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z\"></path></svg>trader/strategy/brother2.py</span><span class=\"flex flex-shrink-0 items-center rounded-r border-l px-2 py-1.5 border-[#dddddd] bg-[#d8d8d8] text-[#666666] dark:border-[#333333] dark:bg-[#2a2a2a] dark:text-[#888888]\">572-643</span></a> <a href=\"https://github.com/timercrack/trader/blob/3307c308/trader/strategy/brother2.py#L644-L683\" target=\"_blank\" rel=\"noopener noreferrer\" class=\"mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75\"><span class=\"flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4]\"><svg class=\"mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block\" fill=\"currentColor\" viewBox=\"0 0 24 24\"><path d=\"M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z\"></path></svg>trader/strategy/brother2.py</span><span class=\"flex flex-shrink-0 items-center rounded-r border-l px-2 py-1.5 border-[#dddddd] bg-[#d8d8d8] text-[#666666] dark:border-[#333333] dark:bg-[#2a2a2a] dark:text-[#888888]\">644-683</span></a></p>\n<h2 id=\"key-design-patterns\" class=\"group\" data-header=\"true\">Key Design Patterns<button class=\"relative ml-2 cursor-pointer align-baseline text-gray-400 opacity-0 transition-opacity hover:text-blue-400 focus:opacity-100 group-hover:opacity-100\" aria-label=\"Copy link to header\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"1em\" height=\"1em\" fill=\"currentColor\" viewBox=\"0 0 256 256\" class=\"h-4 w-4\"><path d=\"M117.18,188.74a12,12,0,0,1,0,17l-5.12,5.12A58.26,58.26,0,0,1,70.6,228h0A58.62,58.62,0,0,1,29.14,127.92L63.89,93.17a58.64,58.64,0,0,1,98.56,28.11,12,12,0,1,1-23.37,5.44,34.65,34.65,0,0,0-58.22-16.58L46.11,144.89A34.62,34.62,0,0,0,70.57,204h0a34.41,34.41,0,0,0,24.49-10.14l5.11-5.12A12,12,0,0,1,117.18,188.74ZM226.83,45.17a58.65,58.65,0,0,0-82.93,0l-5.11,5.11a12,12,0,0,0,17,17l5.12-5.12a34.63,34.63,0,1,1,49,49L175.1,145.86A34.39,34.39,0,0,1,150.61,156h0a34.63,34.63,0,0,1-33.69-26.72,12,12,0,0,0-23.38,5.44A58.64,58.64,0,0,0,150.56,180h.05a58.28,58.28,0,0,0,41.47-17.17l34.75-34.75a58.62,58.62,0,0,0,0-82.91Z\"></path></svg></button></h2>\n<h3 id=\"1-callback-based-event-handling\" class=\"group\" data-header=\"true\">1. Callback-Based Event Handling<button class=\"relative ml-2 cursor-pointer align-baseline text-gray-400 opacity-0 transition-opacity hover:text-blue-400 focus:opacity-100 group-hover:opacity-100\" aria-label=\"Copy link to header\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"1em\" height=\"1em\" fill=\"currentColor\" viewBox=\"0 0 256 256\" class=\"h-4 w-4\"><path d=\"M117.18,188.74a12,12,0,0,1,0,17l-5.12,5.12A58.26,58.26,0,0,1,70.6,228h0A58.62,58.62,0,0,1,29.14,127.92L63.89,93.17a58.64,58.64,0,0,1,98.56,28.11,12,12,0,1,1-23.37,5.44,34.65,34.65,0,0,0-58.22-16.58L46.11,144.89A34.62,34.62,0,0,0,70.57,204h0a34.41,34.41,0,0,0,24.49-10.14l5.11-5.12A12,12,0,0,1,117.18,188.74ZM226.83,45.17a58.65,58.65,0,0,0-82.93,0l-5.11,5.11a12,12,0,0,0,17,17l5.12-5.12a34.63,34.63,0,1,1,49,49L175.1,145.86A34.39,34.39,0,0,1,150.61,156h0a34.63,34.63,0,0,1-33.69-26.72,12,12,0,0,0-23.38,5.44A58.64,58.64,0,0,0,150.56,180h.05a58.28,58.28,0,0,0,41.47-17.17l34.75-34.75a58.62,58.62,0,0,0,0-82.91Z\"></path></svg></button></h3>\n<p>The <code class=\"rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30\">@RegisterCallback</code> decorator (<a href=\"https://github.com/timercrack/trader/blob/3307c308/trader/utils/func_container.py\" target=\"_blank\" rel=\"noopener noreferrer\" class=\"mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75\"><span class=\"flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4] rounded-r\"><svg class=\"mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block\" fill=\"currentColor\" viewBox=\"0 0 24 24\"><path d=\"M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z\"></path></svg>trader/utils/func_container.py</span></a>) enables declarative event routing:</p>\n<pre class=\"px-2 py-1.5 has-[code]:rounded-md has-[code]:!bg-[#e5e5e5] has-[div]:bg-transparent has-[div]:!p-0 has-[code]:text-stone-900 dark:has-[code]:!bg-[#242424] has-[code]:dark:text-white [&amp;_code]:block [&amp;_code]:border-none [&amp;_code]:bg-transparent [&amp;_code]:p-0\"><pre style=\"display: block; overflow-x: auto; padding: 6px 8px; color: rgb(51, 51, 51); background: transparent; margin: 0px; width: 100%;\"><code style=\"white-space: pre; font-size: 12px;\"><span style=\"color: rgb(153, 153, 153); font-weight: bold;\">@RegisterCallback(</span><span class=\"hljs-params\" style=\"color: rgb(153, 153, 153); font-weight: bold;\">channel=</span><span class=\"hljs-params\" style=\"color: rgb(221, 17, 68); font-weight: bold;\">'MSG:CTP:RSP:TRADE:OnRtnTrade:*'</span><span style=\"color: rgb(153, 153, 153); font-weight: bold;\">)</span><span>\n</span><span></span><span style=\"color: rgb(51, 51, 51); font-weight: bold;\">async</span><span> </span><span class=\"hljs-function\" style=\"color: rgb(51, 51, 51); font-weight: bold;\">def</span><span class=\"hljs-function\"> </span><span class=\"hljs-function\" style=\"color: rgb(153, 0, 0); font-weight: bold;\">OnRtnTrade</span><span class=\"hljs-function\">(</span><span class=\"hljs-function hljs-params\">self, channel, trade: </span><span class=\"hljs-function hljs-params\" style=\"color: rgb(0, 134, 179);\">dict</span><span class=\"hljs-function\">):</span><span>\n</span><span>    </span><span style=\"color: rgb(153, 153, 136); font-style: italic;\"># Process trade confirmation</span></code></pre></pre>\n<p><strong>Sources</strong>: <a href=\"https://github.com/timercrack/trader/blob/3307c308/trader/strategy/brother2.py#L391-L469\" target=\"_blank\" rel=\"noopener noreferrer\" class=\"mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75\"><span class=\"flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4]\"><svg class=\"mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block\" fill=\"currentColor\" viewBox=\"0 0 24 24\"><path d=\"M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z\"></path></svg>trader/strategy/brother2.py</span><span class=\"flex flex-shrink-0 items-center rounded-r border-l px-2 py-1.5 border-[#dddddd] bg-[#d8d8d8] text-[#666666] dark:border-[#333333] dark:bg-[#2a2a2a] dark:text-[#888888]\">391-469</span></a></p>\n<h3 id=\"2-scheduled-task-execution\" class=\"group\" data-header=\"true\">2. Scheduled Task Execution<button class=\"relative ml-2 cursor-pointer align-baseline text-gray-400 opacity-0 transition-opacity hover:text-blue-400 focus:opacity-100 group-hover:opacity-100\" aria-label=\"Copy link to header\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"1em\" height=\"1em\" fill=\"currentColor\" viewBox=\"0 0 256 256\" class=\"h-4 w-4\"><path d=\"M117.18,188.74a12,12,0,0,1,0,17l-5.12,5.12A58.26,58.26,0,0,1,70.6,228h0A58.62,58.62,0,0,1,29.14,127.92L63.89,93.17a58.64,58.64,0,0,1,98.56,28.11,12,12,0,1,1-23.37,5.44,34.65,34.65,0,0,0-58.22-16.58L46.11,144.89A34.62,34.62,0,0,0,70.57,204h0a34.41,34.41,0,0,0,24.49-10.14l5.11-5.12A12,12,0,0,1,117.18,188.74ZM226.83,45.17a58.65,58.65,0,0,0-82.93,0l-5.11,5.11a12,12,0,0,0,17,17l5.12-5.12a34.63,34.63,0,1,1,49,49L175.1,145.86A34.39,34.39,0,0,1,150.61,156h0a34.63,34.63,0,0,1-33.69-26.72,12,12,0,0,0-23.38,5.44A58.64,58.64,0,0,0,150.56,180h.05a58.28,58.28,0,0,0,41.47-17.17l34.75-34.75a58.62,58.62,0,0,0,0-82.91Z\"></path></svg></button></h3>\n<p>Cron expressions define recurring tasks:</p>\n<pre class=\"px-2 py-1.5 has-[code]:rounded-md has-[code]:!bg-[#e5e5e5] has-[div]:bg-transparent has-[div]:!p-0 has-[code]:text-stone-900 dark:has-[code]:!bg-[#242424] has-[code]:dark:text-white [&amp;_code]:block [&amp;_code]:border-none [&amp;_code]:bg-transparent [&amp;_code]:p-0\"><pre style=\"display: block; overflow-x: auto; padding: 6px 8px; color: rgb(51, 51, 51); background: transparent; margin: 0px; width: 100%;\"><code style=\"white-space: pre; font-size: 12px;\"><span style=\"color: rgb(153, 153, 153); font-weight: bold;\">@RegisterCallback(</span><span class=\"hljs-params\" style=\"color: rgb(153, 153, 153); font-weight: bold;\">crontab=</span><span class=\"hljs-params\" style=\"color: rgb(221, 17, 68); font-weight: bold;\">'20 15 * * *'</span><span style=\"color: rgb(153, 153, 153); font-weight: bold;\">)</span><span>\n</span><span></span><span style=\"color: rgb(51, 51, 51); font-weight: bold;\">async</span><span> </span><span class=\"hljs-function\" style=\"color: rgb(51, 51, 51); font-weight: bold;\">def</span><span class=\"hljs-function\"> </span><span class=\"hljs-function\" style=\"color: rgb(153, 0, 0); font-weight: bold;\">refresh_all</span><span class=\"hljs-function\">(</span><span class=\"hljs-function hljs-params\">self</span><span class=\"hljs-function\">):</span><span>\n</span><span>    </span><span style=\"color: rgb(153, 153, 136); font-style: italic;\"># Daily account refresh at 15:20</span></code></pre></pre>\n<p><strong>Sources</strong>: <a href=\"https://github.com/timercrack/trader/blob/3307c308/trader/strategy/brother2.py#L644-L654\" target=\"_blank\" rel=\"noopener noreferrer\" class=\"mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75\"><span class=\"flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4]\"><svg class=\"mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block\" fill=\"currentColor\" viewBox=\"0 0 24 24\"><path d=\"M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z\"></path></svg>trader/strategy/brother2.py</span><span class=\"flex flex-shrink-0 items-center rounded-r border-l px-2 py-1.5 border-[#dddddd] bg-[#d8d8d8] text-[#666666] dark:border-[#333333] dark:bg-[#2a2a2a] dark:text-[#888888]\">644-654</span></a></p>\n<h3 id=\"3-asynchronous-requestresponse\" class=\"group\" data-header=\"true\">3. Asynchronous Request/Response<button class=\"relative ml-2 cursor-pointer align-baseline text-gray-400 opacity-0 transition-opacity hover:text-blue-400 focus:opacity-100 group-hover:opacity-100\" aria-label=\"Copy link to header\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"1em\" height=\"1em\" fill=\"currentColor\" viewBox=\"0 0 256 256\" class=\"h-4 w-4\"><path d=\"M117.18,188.74a12,12,0,0,1,0,17l-5.12,5.12A58.26,58.26,0,0,1,70.6,228h0A58.62,58.62,0,0,1,29.14,127.92L63.89,93.17a58.64,58.64,0,0,1,98.56,28.11,12,12,0,1,1-23.37,5.44,34.65,34.65,0,0,0-58.22-16.58L46.11,144.89A34.62,34.62,0,0,0,70.57,204h0a34.41,34.41,0,0,0,24.49-10.14l5.11-5.12A12,12,0,0,1,117.18,188.74ZM226.83,45.17a58.65,58.65,0,0,0-82.93,0l-5.11,5.11a12,12,0,0,0,17,17l5.12-5.12a34.63,34.63,0,1,1,49,49L175.1,145.86A34.39,34.39,0,0,1,150.61,156h0a34.63,34.63,0,0,1-33.69-26.72,12,12,0,0,0-23.38,5.44A58.64,58.64,0,0,0,150.56,180h.05a58.28,58.28,0,0,0,41.47-17.17l34.75-34.75a58.62,58.62,0,0,0,0-82.91Z\"></path></svg></button></h3>\n<p>The <code class=\"rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30\">query()</code> method implements timeout-based async queries to CTP:</p>\n<pre class=\"px-2 py-1.5 has-[code]:rounded-md has-[code]:!bg-[#e5e5e5] has-[div]:bg-transparent has-[div]:!p-0 has-[code]:text-stone-900 dark:has-[code]:!bg-[#242424] has-[code]:dark:text-white [&amp;_code]:block [&amp;_code]:border-none [&amp;_code]:bg-transparent [&amp;_code]:p-0\"><pre style=\"display: block; overflow-x: auto; padding: 6px 8px; color: rgb(51, 51, 51); background: transparent; margin: 0px; width: 100%;\"><code style=\"white-space: pre; font-size: 12px;\"><span style=\"color: rgb(51, 51, 51); font-weight: bold;\">async</span><span> </span><span class=\"hljs-function\" style=\"color: rgb(51, 51, 51); font-weight: bold;\">def</span><span class=\"hljs-function\"> </span><span class=\"hljs-function\" style=\"color: rgb(153, 0, 0); font-weight: bold;\">query</span><span class=\"hljs-function\">(</span><span class=\"hljs-function hljs-params\">self, query_type: </span><span class=\"hljs-function hljs-params\" style=\"color: rgb(0, 134, 179);\">str</span><span class=\"hljs-function hljs-params\">, **kwargs</span><span class=\"hljs-function\">):</span><span>\n</span><span>    </span><span style=\"color: rgb(153, 153, 136); font-style: italic;\"># Subscribe to response channel</span><span>\n</span><span>    </span><span style=\"color: rgb(153, 153, 136); font-style: italic;\"># Publish request</span><span>\n</span><span>    </span><span style=\"color: rgb(153, 153, 136); font-style: italic;\"># Wait for response with timeout</span><span>\n</span><span>    </span><span style=\"color: rgb(153, 153, 136); font-style: italic;\"># Return result</span></code></pre></pre>\n<p><strong>Sources</strong>: <a href=\"https://github.com/timercrack/trader/blob/3307c308/trader/strategy/brother2.py#L236-L257\" target=\"_blank\" rel=\"noopener noreferrer\" class=\"mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75\"><span class=\"flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4]\"><svg class=\"mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block\" fill=\"currentColor\" viewBox=\"0 0 24 24\"><path d=\"M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z\"></path></svg>trader/strategy/brother2.py</span><span class=\"flex flex-shrink-0 items-center rounded-r border-l px-2 py-1.5 border-[#dddddd] bg-[#d8d8d8] text-[#666666] dark:border-[#333333] dark:bg-[#2a2a2a] dark:text-[#888888]\">236-257</span></a></p>\n<h3 id=\"4-state-synchronization\" class=\"group\" data-header=\"true\">4. State Synchronization<button class=\"relative ml-2 cursor-pointer align-baseline text-gray-400 opacity-0 transition-opacity hover:text-blue-400 focus:opacity-100 group-hover:opacity-100\" aria-label=\"Copy link to header\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"1em\" height=\"1em\" fill=\"currentColor\" viewBox=\"0 0 256 256\" class=\"h-4 w-4\"><path d=\"M117.18,188.74a12,12,0,0,1,0,17l-5.12,5.12A58.26,58.26,0,0,1,70.6,228h0A58.62,58.62,0,0,1,29.14,127.92L63.89,93.17a58.64,58.64,0,0,1,98.56,28.11,12,12,0,1,1-23.37,5.44,34.65,34.65,0,0,0-58.22-16.58L46.11,144.89A34.62,34.62,0,0,0,70.57,204h0a34.41,34.41,0,0,0,24.49-10.14l5.11-5.12A12,12,0,0,1,117.18,188.74ZM226.83,45.17a58.65,58.65,0,0,0-82.93,0l-5.11,5.11a12,12,0,0,0,17,17l5.12-5.12a34.63,34.63,0,1,1,49,49L175.1,145.86A34.39,34.39,0,0,1,150.61,156h0a34.63,34.63,0,0,1-33.69-26.72,12,12,0,0,0-23.38,5.44A58.64,58.64,0,0,0,150.56,180h.05a58.28,58.28,0,0,0,41.47-17.17l34.75-34.75a58.62,58.62,0,0,0,0-82.91Z\"></path></svg></button></h3>\n<p>The system maintains consistency between local database state and CTP account state through periodic refresh operations at market close.</p>\n<p><strong>Sources</strong>: <a href=\"https://github.com/timercrack/trader/blob/3307c308/trader/strategy/brother2.py#L86-L154\" target=\"_blank\" rel=\"noopener noreferrer\" class=\"mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75\"><span class=\"flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4]\"><svg class=\"mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block\" fill=\"currentColor\" viewBox=\"0 0 24 24\"><path d=\"M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z\"></path></svg>trader/strategy/brother2.py</span><span class=\"flex flex-shrink-0 items-center rounded-r border-l px-2 py-1.5 border-[#dddddd] bg-[#d8d8d8] text-[#666666] dark:border-[#333333] dark:bg-[#2a2a2a] dark:text-[#888888]\">86-154</span></a></p>\n<h2 id=\"next-steps\" class=\"group\" data-header=\"true\">Next Steps<button class=\"relative ml-2 cursor-pointer align-baseline text-gray-400 opacity-0 transition-opacity hover:text-blue-400 focus:opacity-100 group-hover:opacity-100\" aria-label=\"Copy link to header\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"1em\" height=\"1em\" fill=\"currentColor\" viewBox=\"0 0 256 256\" class=\"h-4 w-4\"><path d=\"M117.18,188.74a12,12,0,0,1,0,17l-5.12,5.12A58.26,58.26,0,0,1,70.6,228h0A58.62,58.62,0,0,1,29.14,127.92L63.89,93.17a58.64,58.64,0,0,1,98.56,28.11,12,12,0,1,1-23.37,5.44,34.65,34.65,0,0,0-58.22-16.58L46.11,144.89A34.62,34.62,0,0,0,70.57,204h0a34.41,34.41,0,0,0,24.49-10.14l5.11-5.12A12,12,0,0,1,117.18,188.74ZM226.83,45.17a58.65,58.65,0,0,0-82.93,0l-5.11,5.11a12,12,0,0,0,17,17l5.12-5.12a34.63,34.63,0,1,1,49,49L175.1,145.86A34.39,34.39,0,0,1,150.61,156h0a34.63,34.63,0,0,1-33.69-26.72,12,12,0,0,0-23.38,5.44A58.64,58.64,0,0,0,150.56,180h.05a58.28,58.28,0,0,0,41.47-17.17l34.75-34.75a58.62,58.62,0,0,0,0-82.91Z\"></path></svg></button></h2>\n<p>For detailed information on specific subsystems:</p>\n<ul>\n<li><a href=\"/timercrack/trader/2-getting-started\" class=\"text-neutral-300 hover:text-neutral-200 hover:underline\">Installation and Configuration</a></li>\n<li><a href=\"/timercrack/trader/3-architecture\" class=\"text-neutral-300 hover:text-neutral-200 hover:underline\">System Architecture Details</a></li>\n<li><a href=\"/timercrack/trader/4-trading-strategy-system\" class=\"text-neutral-300 hover:text-neutral-200 hover:underline\">Trading Strategy Implementation</a></li>\n<li><a href=\"/timercrack/trader/5-data-management\" class=\"text-neutral-300 hover:text-neutral-200 hover:underline\">Data Models and Processing</a></li>\n<li><a href=\"/timercrack/trader/6-ctp-api-integration\" class=\"text-neutral-300 hover:text-neutral-200 hover:underline\">CTP API Integration</a></li>\n</ul></div></div></div></div></div></div><div class=\"hidden overflow-hidden transition-[border-radius] xl:sticky xl:right-0 xl:top-20 xl:block xl:h-[calc(100vh-82px)] xl:w-64 xl:flex-shrink-0 2xl:w-72\" style=\"scrollbar-width:none\"><div class=\"flex max-h-full w-full flex-shrink-0 flex-col py-6 pt-0 text-sm lg:pb-4 lg:pt-8 xl:w-64 2xl:w-72\" style=\"scrollbar-color:var(--color-night) transparent\"><div><div class=\"relative mx-4 my-4 rounded-md border border-neutral-200 bg-neutral-100 p-3 text-sm text-neutral-600 dark:border-neutral-800 dark:bg-neutral-900 dark:text-neutral-400\"><button class=\"absolute right-2 top-2 rounded-sm p-1 opacity-70 transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-neutral-400 focus:ring-offset-2\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"1em\" height=\"1em\" fill=\"currentColor\" viewBox=\"0 0 256 256\" class=\"h-4 w-4\"><path d=\"M205.66,194.34a8,8,0,0,1-11.32,11.32L128,139.31,61.66,205.66a8,8,0,0,1-11.32-11.32L116.69,128,50.34,61.66A8,8,0,0,1,61.66,50.34L128,116.69l66.34-66.35a8,8,0,0,1,11.32,11.32L139.31,128Z\"></path></svg><span class=\"sr-only\">Dismiss</span></button><p class=\"text-sm font-medium\">Refresh this wiki</p><button class=\"mt-2 flex items-center gap-1 rounded-md bg-neutral-200 px-2 py-1 text-sm font-medium text-neutral-700 transition-colors hover:bg-neutral-300 dark:bg-neutral-800 dark:text-neutral-300 dark:hover:bg-neutral-700\">Enter email to refresh</button></div></div><h3 class=\"px-4 pb-5 text-lg font-medium leading-none\">On this page</h3><ul style=\"scrollbar-width:none\" class=\"min-h-0 flex-1 space-y-3 overflow-y-auto p-4 pt-0\"><li class=\"\"><a href=\"#overview\" class=\"hover:text-primary pr-1 transition-all text-primary font-medium\">Overview</a></li><li class=\"ml-3\"><a href=\"#purpose-and-scope\" class=\"hover:text-primary pr-1 font-normal transition-all text-secondary\">Purpose and Scope</a></li><li class=\"ml-3\"><a href=\"#system-architecture\" class=\"hover:text-primary pr-1 font-normal transition-all text-secondary\">System Architecture</a></li><li class=\"ml-6\"><a href=\"#high-level-component-architecture\" class=\"hover:text-primary pr-1 font-normal transition-all text-secondary\">High-Level Component Architecture</a></li><li class=\"ml-6\"><a href=\"#component-to-file-mapping\" class=\"hover:text-primary pr-1 font-normal transition-all text-secondary\">Component-to-File Mapping</a></li><li class=\"ml-3\"><a href=\"#core-components\" class=\"hover:text-primary pr-1 font-normal transition-all text-secondary\">Core Components</a></li><li class=\"ml-6\"><a href=\"#trading-strategy-engine\" class=\"hover:text-primary pr-1 font-normal transition-all text-secondary\">Trading Strategy Engine</a></li><li class=\"ml-6\"><a href=\"#data-models\" class=\"hover:text-primary pr-1 font-normal transition-all text-secondary\">Data Models</a></li><li class=\"ml-6\"><a href=\"#message-bus-architecture\" class=\"hover:text-primary pr-1 font-normal transition-all text-secondary\">Message Bus Architecture</a></li><li class=\"ml-6\"><a href=\"#data-acquisition-pipeline\" class=\"hover:text-primary pr-1 font-normal transition-all text-secondary\">Data Acquisition Pipeline</a></li><li class=\"ml-3\"><a href=\"#technology-stack\" class=\"hover:text-primary pr-1 font-normal transition-all text-secondary\">Technology Stack</a></li><li class=\"ml-3\"><a href=\"#trading-workflow-overview\" class=\"hover:text-primary pr-1 font-normal transition-all text-secondary\">Trading Workflow Overview</a></li><li class=\"ml-3\"><a href=\"#key-design-patterns\" class=\"hover:text-primary pr-1 font-normal transition-all text-secondary\">Key Design Patterns</a></li><li class=\"ml-6\"><a href=\"#1-callback-based-event-handling\" class=\"hover:text-primary pr-1 font-normal transition-all text-secondary\">1. Callback-Based Event Handling</a></li><li class=\"ml-6\"><a href=\"#2-scheduled-task-execution\" class=\"hover:text-primary pr-1 font-normal transition-all text-secondary\">2. Scheduled Task Execution</a></li><li class=\"ml-6\"><a href=\"#3-asynchronous-requestresponse\" class=\"hover:text-primary pr-1 font-normal transition-all text-secondary\">3. Asynchronous Request/Response</a></li><li class=\"ml-6\"><a href=\"#4-state-synchronization\" class=\"hover:text-primary pr-1 font-normal transition-all text-secondary\">4. State Synchronization</a></li><li class=\"ml-3\"><a href=\"#next-steps\" class=\"hover:text-primary pr-1 font-normal transition-all text-secondary\">Next Steps</a></li></ul></div></div><div class=\"pointer-events-none fixed bottom-2 left-2 right-2 mt-2 md:bottom-4 md:left-0 md:right-0\"><div class=\"z-10 mx-auto max-w-3xl\"><form class=\"z-20 w-full rounded-md backdrop-blur-md transition-shadow [pointer-events:all] focus-within:ring-[.5px] focus-within:ring-indigo-300/40 bg-component/70 border border-indigo-300/20 shadow-lg shadow-indigo-500/20 [backdrop-filter:blur(8px)]\"><div class=\"\"><div class=\"relative text-base font-normal\"><div class=\"relative px-3 pt-3\"><div class=\"pointer-events-none absolute left-3 right-3 top-3 ml-px flex w-full overflow-hidden text-base\" aria-hidden=\"true\"><div class=\"flex items-center gap-1 overflow-hidden text-wrap opacity-60\">Ask Devin about timercrack/trader</div></div><textarea data-deepwiki-input=\"question\" placeholder=\"\" rows=\"2\" class=\"w-full resize-none rounded-none bg-transparent text-white focus:outline-none text-base\"></textarea></div></div></div><div class=\"dark:border-border flex h-12 items-center justify-between border-t-[0.5px] border-[#c0c0c0] p-3 pl-1.5\"><div class=\"flex items-center text-sm gap-4\"><button data-slot=\"button\" class=\"font-medium disabled:pointer-events-none disabled:opacity-50 shrink-0 focus-visible:border-ring aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive dark:hover:bg-accent/50 has-[&gt;svg]:px-3 data-[placeholder]:text-muted-foreground [&amp;_svg:not([class*='text-'])]:text-muted-foreground focus-visible:ring-ring/50 hover:bg-accent hover:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground flex h-9 w-fit cursor-pointer items-center justify-between gap-2 whitespace-nowrap rounded-md bg-transparent px-3 py-2 text-sm text-neutral-700 outline-none transition-all focus-visible:ring-[3px] dark:text-neutral-400 [&amp;_svg:not([class*='size-'])]:size-4 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0\" data-selected=\"true\" type=\"button\" id=\"radix-_r_0_\" aria-haspopup=\"menu\" aria-expanded=\"false\" data-state=\"closed\"><div class=\"flex items-center gap-2\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"1em\" height=\"1em\" fill=\"currentColor\" viewBox=\"0 0 256 256\" class=\"size-4 text-current\"><path d=\"M213.85,125.46l-112,120a8,8,0,0,1-13.69-7l14.66-73.33L45.19,143.49a8,8,0,0,1-3-13l112-120a8,8,0,0,1,13.69,7L153.18,90.9l57.63,21.61a8,8,0,0,1,3,12.95Z\"></path></svg><span>Fast</span></div><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"1em\" height=\"1em\" fill=\"currentColor\" viewBox=\"0 0 256 256\" class=\"size-4 text-current opacity-50\"><path d=\"M213.66,101.66l-80,80a8,8,0,0,1-11.32,0l-80-80A8,8,0,0,1,53.66,90.34L128,164.69l74.34-74.35a8,8,0,0,1,11.32,11.32Z\"></path></svg></button></div><div class=\"flex items-center gap-2\"><button class=\"rounded-full bg-[#e0e0e0] p-1 text-neutral-400 transition-colors dark:bg-neutral-700\" disabled=\"\" data-state=\"closed\" data-slot=\"tooltip-trigger\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"18\" height=\"18\" fill=\"currentColor\" viewBox=\"0 0 256 256\"><path d=\"M221.66,133.66l-72,72a8,8,0,0,1-11.32-11.32L196.69,136H40a8,8,0,0,1,0-16H196.69L138.34,61.66a8,8,0,0,1,11.32-11.32l72,72A8,8,0,0,1,221.66,133.66Z\"></path></svg></button></div></div></form></div></div></div></div></div><!--$--><!--/$--><!--/$--></div><!--/$--><script>requestAnimationFrame(function(){$RT=performance.now()});</script><script src=\"/_next/static/chunks/webpack-5400bf868d87f903.js?dpl=dpl_3mLkJC9WsEUqB2wKLhtmuPqhxVgT\" id=\"_R_\" async=\"\"></script><script>$RB=[];$RV=function(a){$RT=performance.now();for(var b=0;b<a.length;b+=2){var c=a[b],e=a[b+1];null!==e.parentNode&&e.parentNode.removeChild(e);var f=c.parentNode;if(f){var g=c.previousSibling,h=0;do{if(c&&8===c.nodeType){var d=c.data;if(\"/$\"===d||\"/&\"===d)if(0===h)break;else h--;else\"$\"!==d&&\"$?\"!==d&&\"$~\"!==d&&\"$!\"!==d&&\"&\"!==d||h++}d=c.nextSibling;f.removeChild(c);c=d}while(c);for(;e.firstChild;)f.insertBefore(e.firstChild,c);g.data=\"$\";g._reactRetry&&requestAnimationFrame(g._reactRetry)}}a.length=0};\n$RC=function(a,b){if(b=document.getElementById(b))(a=document.getElementById(a))?(a.previousSibling.data=\"$~\",$RB.push(a,b),2===$RB.length&&(\"number\"!==typeof $RT?requestAnimationFrame($RV.bind(null,$RB)):(a=performance.now(),setTimeout($RV.bind(null,$RB),2300>a&&2E3<a?2300-a:$RT+300-a)))):b.parentNode.removeChild(b)};$RC(\"B:0\",\"S:0\")</script><script>$RC(\"B:1\",\"S:1\")</script><script>(self.__next_f=self.__next_f||[]).push([0])</script><script>self.__next_f.push([1,\"1:\\\"$Sreact.fragment\\\"\\n\"])</script><script>self.__next_f.push([1,\"2:I[49138,[\\\"9453\\\",\\\"static/chunks/b1298b8d-5cac6cd7c8e952ff.js?dpl=dpl_3mLkJC9WsEUqB2wKLhtmuPqhxVgT\\\",\\\"8970\\\",\\\"static/chunks/378e5a93-860e027c5a5e0c0d.js?dpl=dpl_3mLkJC9WsEUqB2wKLhtmuPqhxVgT\\\",\\\"1585\\\",\\\"static/chunks/f7f68e2d-d8bf979db5ff4e9d.js?dpl=dpl_3mLkJC9WsEUqB2wKLhtmuPqhxVgT\\\",\\\"7963\\\",\\\"static/chunks/7963-2c20578d72f6c7cc.js?dpl=dpl_3mLkJC9WsEUqB2wKLhtmuPqhxVgT\\\",\\\"1265\\\",\\\"static/chunks/1265-fa8a95d3842768f5.js?dpl=dpl_3mLkJC9WsEUqB2wKLhtmuPqhxVgT\\\",\\\"9885\\\",\\\"static/chunks/9885-b57089f03806c3b8.js?dpl=dpl_3mLkJC9WsEUqB2wKLhtmuPqhxVgT\\\",\\\"659\\\",\\\"static/chunks/659-ee9e1e775e30dcef.js?dpl=dpl_3mLkJC9WsEUqB2wKLhtmuPqhxVgT\\\",\\\"7177\\\",\\\"static/chunks/app/layout-0537c2076823e553.js?dpl=dpl_3mLkJC9WsEUqB2wKLhtmuPqhxVgT\\\"],\\\"RootProvider\\\"]\\n\"])</script><script>self.__next_f.push([1,\"3:I[85341,[],\\\"\\\"]\\n4:I[90025,[],\\\"\\\"]\\n7:I[41012,[],\\\"ClientPageRoot\\\"]\\n\"])</script><script>self.__next_f.push([1,\"8:I[57456,[\\\"9453\\\",\\\"static/chunks/b1298b8d-5cac6cd7c8e952ff.js?dpl=dpl_3mLkJC9WsEUqB2wKLhtmuPqhxVgT\\\",\\\"8970\\\",\\\"static/chunks/378e5a93-860e027c5a5e0c0d.js?dpl=dpl_3mLkJC9WsEUqB2wKLhtmuPqhxVgT\\\",\\\"1585\\\",\\\"static/chunks/f7f68e2d-d8bf979db5ff4e9d.js?dpl=dpl_3mLkJC9WsEUqB2wKLhtmuPqhxVgT\\\",\\\"4129\\\",\\\"static/chunks/7bf36345-1ac10ec2f0e0c88f.js?dpl=dpl_3mLkJC9WsEUqB2wKLhtmuPqhxVgT\\\",\\\"2545\\\",\\\"static/chunks/c16f53c3-b390b6f98a69dcec.js?dpl=dpl_3mLkJC9WsEUqB2wKLhtmuPqhxVgT\\\",\\\"7963\\\",\\\"static/chunks/7963-2c20578d72f6c7cc.js?dpl=dpl_3mLkJC9WsEUqB2wKLhtmuPqhxVgT\\\",\\\"1265\\\",\\\"static/chunks/1265-fa8a95d3842768f5.js?dpl=dpl_3mLkJC9WsEUqB2wKLhtmuPqhxVgT\\\",\\\"2602\\\",\\\"static/chunks/2602-735d398a11941702.js?dpl=dpl_3mLkJC9WsEUqB2wKLhtmuPqhxVgT\\\",\\\"9885\\\",\\\"static/chunks/9885-b57089f03806c3b8.js?dpl=dpl_3mLkJC9WsEUqB2wKLhtmuPqhxVgT\\\",\\\"4336\\\",\\\"static/chunks/4336-624d5ae6f4cc1cc7.js?dpl=dpl_3mLkJC9WsEUqB2wKLhtmuPqhxVgT\\\",\\\"659\\\",\\\"static/chunks/659-ee9e1e775e30dcef.js?dpl=dpl_3mLkJC9WsEUqB2wKLhtmuPqhxVgT\\\",\\\"8461\\\",\\\"static/chunks/8461-369a9f0c48ea2626.js?dpl=dpl_3mLkJC9WsEUqB2wKLhtmuPqhxVgT\\\",\\\"7198\\\",\\\"static/chunks/7198-985a49f2b6072d25.js?dpl=dpl_3mLkJC9WsEUqB2wKLhtmuPqhxVgT\\\",\\\"6230\\\",\\\"static/chunks/6230-12a4ab40267b069f.js?dpl=dpl_3mLkJC9WsEUqB2wKLhtmuPqhxVgT\\\",\\\"4429\\\",\\\"static/chunks/4429-92c77bf2d3e82e1c.js?dpl=dpl_3mLkJC9WsEUqB2wKLhtmuPqhxVgT\\\",\\\"9976\\\",\\\"static/chunks/9976-726fc148e3fe0730.js?dpl=dpl_3mLkJC9WsEUqB2wKLhtmuPqhxVgT\\\",\\\"1481\\\",\\\"static/chunks/1481-e8a771bf9a2ec0bd.js?dpl=dpl_3mLkJC9WsEUqB2wKLhtmuPqhxVgT\\\",\\\"3285\\\",\\\"static/chunks/app/%5Borg%5D/%5Brepo%5D/%5B%5B...wikiRoutes%5D%5D/page-82e5155a284526b9.js?dpl=dpl_3mLkJC9WsEUqB2wKLhtmuPqhxVgT\\\"],\\\"default\\\"]\\n\"])</script><script>self.__next_f.push([1,\"b:I[15104,[],\\\"OutletBoundary\\\"]\\nd:I[94777,[],\\\"AsyncMetadataOutlet\\\"]\\nf:I[15104,[],\\\"ViewportBoundary\\\"]\\n11:I[15104,[],\\\"MetadataBoundary\\\"]\\n12:\\\"$Sreact.suspense\\\"\\n14:I[34431,[],\\\"\\\"]\\n:HL[\\\"/_next/static/media/4cf2300e9c8272f7-s.p.woff2\\\",\\\"font\\\",{\\\"crossOrigin\\\":\\\"\\\",\\\"type\\\":\\\"font/woff2\\\"}]\\n:HL[\\\"/_next/static/media/93f479601ee12b01-s.p.woff2\\\",\\\"font\\\",{\\\"crossOrigin\\\":\\\"\\\",\\\"type\\\":\\\"font/woff2\\\"}]\\n:HL[\\\"/_next/static/css/de70bee13400563f.css?dpl=dpl_3mLkJC9WsEUqB2wKLhtmuPqhxVgT\\\",\\\"style\\\"]\\n:HL[\\\"/_next/static/css/b54d92a85d180acc.css?dpl=dpl_3mLkJC9WsEUqB2wKLhtmuPqhxVgT\\\",\\\"style\\\"]\\n\"])</script><script>self.__next_f.push([1,\"0:{\\\"P\\\":null,\\\"b\\\":\\\"poxUbsYLot1iOItOq5DSC\\\",\\\"p\\\":\\\"\\\",\\\"c\\\":[\\\"\\\",\\\"timercrack\\\",\\\"trader\\\",\\\"\\\"],\\\"i\\\":false,\\\"f\\\":[[[\\\"\\\",{\\\"children\\\":[[\\\"org\\\",\\\"timercrack\\\",\\\"d\\\"],{\\\"children\\\":[[\\\"repo\\\",\\\"trader\\\",\\\"d\\\"],{\\\"children\\\":[[\\\"wikiRoutes\\\",\\\"\\\",\\\"oc\\\"],{\\\"children\\\":[\\\"__PAGE__\\\",{}]}]}]}]},\\\"$undefined\\\",\\\"$undefined\\\",true],[\\\"\\\",[\\\"$\\\",\\\"$1\\\",\\\"c\\\",{\\\"children\\\":[[[\\\"$\\\",\\\"link\\\",\\\"0\\\",{\\\"rel\\\":\\\"stylesheet\\\",\\\"href\\\":\\\"/_next/static/css/de70bee13400563f.css?dpl=dpl_3mLkJC9WsEUqB2wKLhtmuPqhxVgT\\\",\\\"precedence\\\":\\\"next\\\",\\\"crossOrigin\\\":\\\"$undefined\\\",\\\"nonce\\\":\\\"$undefined\\\"}],[\\\"$\\\",\\\"link\\\",\\\"1\\\",{\\\"rel\\\":\\\"stylesheet\\\",\\\"href\\\":\\\"/_next/static/css/b54d92a85d180acc.css?dpl=dpl_3mLkJC9WsEUqB2wKLhtmuPqhxVgT\\\",\\\"precedence\\\":\\\"next\\\",\\\"crossOrigin\\\":\\\"$undefined\\\",\\\"nonce\\\":\\\"$undefined\\\"}]],[\\\"$\\\",\\\"html\\\",null,{\\\"lang\\\":\\\"en\\\",\\\"suppressHydrationWarning\\\":true,\\\"children\\\":[[\\\"$\\\",\\\"head\\\",null,{}],[\\\"$\\\",\\\"body\\\",null,{\\\"className\\\":\\\"__variable_188709 font-geist-sans relative min-h-screen __variable_9a8899 bg-background antialiased\\\",\\\"children\\\":[\\\"$\\\",\\\"$L2\\\",null,{\\\"children\\\":[\\\"$\\\",\\\"$L3\\\",null,{\\\"parallelRouterKey\\\":\\\"children\\\",\\\"error\\\":\\\"$undefined\\\",\\\"errorStyles\\\":\\\"$undefined\\\",\\\"errorScripts\\\":\\\"$undefined\\\",\\\"template\\\":[\\\"$\\\",\\\"$L4\\\",null,{}],\\\"templateStyles\\\":\\\"$undefined\\\",\\\"templateScripts\\\":\\\"$undefined\\\",\\\"notFound\\\":[[[\\\"$\\\",\\\"title\\\",null,{\\\"children\\\":\\\"404: This page could not be found.\\\"}],[\\\"$\\\",\\\"div\\\",null,{\\\"style\\\":{\\\"fontFamily\\\":\\\"system-ui,\\\\\\\"Segoe UI\\\\\\\",Roboto,Helvetica,Arial,sans-serif,\\\\\\\"Apple Color Emoji\\\\\\\",\\\\\\\"Segoe UI Emoji\\\\\\\"\\\",\\\"height\\\":\\\"100vh\\\",\\\"textAlign\\\":\\\"center\\\",\\\"display\\\":\\\"flex\\\",\\\"flexDirection\\\":\\\"column\\\",\\\"alignItems\\\":\\\"center\\\",\\\"justifyContent\\\":\\\"center\\\"},\\\"children\\\":[\\\"$\\\",\\\"div\\\",null,{\\\"children\\\":[[\\\"$\\\",\\\"style\\\",null,{\\\"dangerouslySetInnerHTML\\\":{\\\"__html\\\":\\\"body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}\\\"}}],[\\\"$\\\",\\\"h1\\\",null,{\\\"className\\\":\\\"next-error-h1\\\",\\\"style\\\":{\\\"display\\\":\\\"inline-block\\\",\\\"margin\\\":\\\"0 20px 0 0\\\",\\\"padding\\\":\\\"0 23px 0 0\\\",\\\"fontSize\\\":24,\\\"fontWeight\\\":500,\\\"verticalAlign\\\":\\\"top\\\",\\\"lineHeight\\\":\\\"49px\\\"},\\\"children\\\":404}],[\\\"$\\\",\\\"div\\\",null,{\\\"style\\\":{\\\"display\\\":\\\"inline-block\\\"},\\\"children\\\":[\\\"$\\\",\\\"h2\\\",null,{\\\"style\\\":{\\\"fontSize\\\":14,\\\"fontWeight\\\":400,\\\"lineHeight\\\":\\\"49px\\\",\\\"margin\\\":0},\\\"children\\\":\\\"This page could not be found.\\\"}]}]]}]}]],[]],\\\"forbidden\\\":\\\"$undefined\\\",\\\"unauthorized\\\":\\\"$undefined\\\"}]}]}]]}]]}],{\\\"children\\\":[[\\\"org\\\",\\\"timercrack\\\",\\\"d\\\"],[\\\"$\\\",\\\"$1\\\",\\\"c\\\",{\\\"children\\\":[null,[\\\"$\\\",\\\"$L3\\\",null,{\\\"parallelRouterKey\\\":\\\"children\\\",\\\"error\\\":\\\"$undefined\\\",\\\"errorStyles\\\":\\\"$undefined\\\",\\\"errorScripts\\\":\\\"$undefined\\\",\\\"template\\\":[\\\"$\\\",\\\"$L4\\\",null,{}],\\\"templateStyles\\\":\\\"$undefined\\\",\\\"templateScripts\\\":\\\"$undefined\\\",\\\"notFound\\\":\\\"$undefined\\\",\\\"forbidden\\\":\\\"$undefined\\\",\\\"unauthorized\\\":\\\"$undefined\\\"}]]}],{\\\"children\\\":[[\\\"repo\\\",\\\"trader\\\",\\\"d\\\"],[\\\"$\\\",\\\"$1\\\",\\\"c\\\",{\\\"children\\\":[null,\\\"$L5\\\"]}],{\\\"children\\\":[[\\\"wikiRoutes\\\",\\\"\\\",\\\"oc\\\"],[\\\"$\\\",\\\"$1\\\",\\\"c\\\",{\\\"children\\\":[null,\\\"$L6\\\"]}],{\\\"children\\\":[\\\"__PAGE__\\\",[\\\"$\\\",\\\"$1\\\",\\\"c\\\",{\\\"children\\\":[[\\\"$\\\",\\\"$L7\\\",null,{\\\"Component\\\":\\\"$8\\\",\\\"searchParams\\\":{},\\\"params\\\":{\\\"org\\\":\\\"timercrack\\\",\\\"repo\\\":\\\"trader\\\"},\\\"promises\\\":[\\\"$@9\\\",\\\"$@a\\\"]}],null,[\\\"$\\\",\\\"$Lb\\\",null,{\\\"children\\\":[\\\"$Lc\\\",[\\\"$\\\",\\\"$Ld\\\",null,{\\\"promise\\\":\\\"$@e\\\"}]]}]]}],{},null,false]},null,false]},null,false]},null,false]},null,false],[\\\"$\\\",\\\"$1\\\",\\\"h\\\",{\\\"children\\\":[null,[[\\\"$\\\",\\\"$Lf\\\",null,{\\\"children\\\":\\\"$L10\\\"}],[\\\"$\\\",\\\"meta\\\",null,{\\\"name\\\":\\\"next-size-adjust\\\",\\\"content\\\":\\\"\\\"}]],[\\\"$\\\",\\\"$L11\\\",null,{\\\"children\\\":[\\\"$\\\",\\\"div\\\",null,{\\\"hidden\\\":true,\\\"children\\\":[\\\"$\\\",\\\"$12\\\",null,{\\\"fallback\\\":null,\\\"children\\\":\\\"$L13\\\"}]}]}]]}],false]],\\\"m\\\":\\\"$undefined\\\",\\\"G\\\":[\\\"$14\\\",[]],\\\"s\\\":false,\\\"S\\\":true}\\n\"])</script><script>self.__next_f.push([1,\"9:{}\\na:\\\"$0:f:0:1:2:children:2:children:2:children:2:children:1:props:children:0:props:params\\\"\\n\"])</script><script>self.__next_f.push([1,\"10:[[\\\"$\\\",\\\"meta\\\",\\\"0\\\",{\\\"charSet\\\":\\\"utf-8\\\"}],[\\\"$\\\",\\\"meta\\\",\\\"1\\\",{\\\"name\\\":\\\"viewport\\\",\\\"content\\\":\\\"width=device-width, initial-scale=1\\\"}]]\\nc:null\\n\"])</script><script>self.__next_f.push([1,\"15:I[13550,[\\\"9453\\\",\\\"static/chunks/b1298b8d-5cac6cd7c8e952ff.js?dpl=dpl_3mLkJC9WsEUqB2wKLhtmuPqhxVgT\\\",\\\"8970\\\",\\\"static/chunks/378e5a93-860e027c5a5e0c0d.js?dpl=dpl_3mLkJC9WsEUqB2wKLhtmuPqhxVgT\\\",\\\"1585\\\",\\\"static/chunks/f7f68e2d-d8bf979db5ff4e9d.js?dpl=dpl_3mLkJC9WsEUqB2wKLhtmuPqhxVgT\\\",\\\"7963\\\",\\\"static/chunks/7963-2c20578d72f6c7cc.js?dpl=dpl_3mLkJC9WsEUqB2wKLhtmuPqhxVgT\\\",\\\"1265\\\",\\\"static/chunks/1265-fa8a95d3842768f5.js?dpl=dpl_3mLkJC9WsEUqB2wKLhtmuPqhxVgT\\\",\\\"2602\\\",\\\"static/chunks/2602-735d398a11941702.js?dpl=dpl_3mLkJC9WsEUqB2wKLhtmuPqhxVgT\\\",\\\"4336\\\",\\\"static/chunks/4336-624d5ae6f4cc1cc7.js?dpl=dpl_3mLkJC9WsEUqB2wKLhtmuPqhxVgT\\\",\\\"25\\\",\\\"static/chunks/25-9f305b682cea7558.js?dpl=dpl_3mLkJC9WsEUqB2wKLhtmuPqhxVgT\\\",\\\"7391\\\",\\\"static/chunks/7391-db08a263f1c857d8.js?dpl=dpl_3mLkJC9WsEUqB2wKLhtmuPqhxVgT\\\",\\\"2512\\\",\\\"static/chunks/2512-fc2ad2e11d161d20.js?dpl=dpl_3mLkJC9WsEUqB2wKLhtmuPqhxVgT\\\",\\\"6375\\\",\\\"static/chunks/6375-6b1e677037ddc4d1.js?dpl=dpl_3mLkJC9WsEUqB2wKLhtmuPqhxVgT\\\",\\\"9437\\\",\\\"static/chunks/9437-00f165dda9ad3a42.js?dpl=dpl_3mLkJC9WsEUqB2wKLhtmuPqhxVgT\\\",\\\"2933\\\",\\\"static/chunks/app/%5Borg%5D/%5Brepo%5D/layout-1d48b1e2f124e49f.js?dpl=dpl_3mLkJC9WsEUqB2wKLhtmuPqhxVgT\\\"],\\\"HeaderWrapperWithSuspense\\\"]\\n\"])</script><script>self.__next_f.push([1,\"16:I[82188,[\\\"9453\\\",\\\"static/chunks/b1298b8d-5cac6cd7c8e952ff.js?dpl=dpl_3mLkJC9WsEUqB2wKLhtmuPqhxVgT\\\",\\\"8970\\\",\\\"static/chunks/378e5a93-860e027c5a5e0c0d.js?dpl=dpl_3mLkJC9WsEUqB2wKLhtmuPqhxVgT\\\",\\\"1585\\\",\\\"static/chunks/f7f68e2d-d8bf979db5ff4e9d.js?dpl=dpl_3mLkJC9WsEUqB2wKLhtmuPqhxVgT\\\",\\\"7963\\\",\\\"static/chunks/7963-2c20578d72f6c7cc.js?dpl=dpl_3mLkJC9WsEUqB2wKLhtmuPqhxVgT\\\",\\\"1265\\\",\\\"static/chunks/1265-fa8a95d3842768f5.js?dpl=dpl_3mLkJC9WsEUqB2wKLhtmuPqhxVgT\\\",\\\"2602\\\",\\\"static/chunks/2602-735d398a11941702.js?dpl=dpl_3mLkJC9WsEUqB2wKLhtmuPqhxVgT\\\",\\\"4336\\\",\\\"static/chunks/4336-624d5ae6f4cc1cc7.js?dpl=dpl_3mLkJC9WsEUqB2wKLhtmuPqhxVgT\\\",\\\"25\\\",\\\"static/chunks/25-9f305b682cea7558.js?dpl=dpl_3mLkJC9WsEUqB2wKLhtmuPqhxVgT\\\",\\\"7391\\\",\\\"static/chunks/7391-db08a263f1c857d8.js?dpl=dpl_3mLkJC9WsEUqB2wKLhtmuPqhxVgT\\\",\\\"2512\\\",\\\"static/chunks/2512-fc2ad2e11d161d20.js?dpl=dpl_3mLkJC9WsEUqB2wKLhtmuPqhxVgT\\\",\\\"6375\\\",\\\"static/chunks/6375-6b1e677037ddc4d1.js?dpl=dpl_3mLkJC9WsEUqB2wKLhtmuPqhxVgT\\\",\\\"9437\\\",\\\"static/chunks/9437-00f165dda9ad3a42.js?dpl=dpl_3mLkJC9WsEUqB2wKLhtmuPqhxVgT\\\",\\\"2933\\\",\\\"static/chunks/app/%5Borg%5D/%5Brepo%5D/layout-1d48b1e2f124e49f.js?dpl=dpl_3mLkJC9WsEUqB2wKLhtmuPqhxVgT\\\"],\\\"WikiContextProvider\\\"]\\n\"])</script><script>self.__next_f.push([1,\"17:T3967,\"])</script><script>self.__next_f.push([1,\"# Overview\\n\\n\\u003cdetails\\u003e\\n\\u003csummary\\u003eRelevant source files\\u003c/summary\\u003e\\n\\nThe following files were used as context for generating this wiki page:\\n\\n- [README.rst](README.rst)\\n- [panel/models.py](panel/models.py)\\n- [trader/strategy/brother2.py](trader/strategy/brother2.py)\\n- [trader/utils/__init__.py](trader/utils/__init__.py)\\n\\n\\u003c/details\\u003e\\n\\n\\n\\nThis page provides a high-level introduction to the trader system, explaining its purpose, architecture, and major components. For detailed information on specific subsystems, see: [Getting Started](#2), [Architecture](#3), [Trading Strategy System](#4), [Data Management](#5), and [CTP API Integration](#6).\\n\\n## Purpose and Scope\\n\\nThe trader system is an automated futures trading platform designed for Chinese commodity exchanges. It provides a complete solution for:\\n\\n- **Market Data Acquisition**: Daily data fetching from five Chinese exchanges (SHFE, DCE, CZCE, CFFEX, GFEX)\\n- **Signal Generation**: Technical analysis-based trading signals using ATR, SMA, and breakout detection\\n- **Order Execution**: Automated order placement through the CTP (China Futures Trading Platform) API\\n- **Position Management**: Real-time tracking of positions, P\\u0026L, and risk metrics\\n- **Performance Analytics**: Daily NAV calculation and equity curve tracking\\n\\nThe system operates entirely in Python using Django for data persistence and Redis for asynchronous message-based communication with the CTP trading API.\\n\\n**Sources**: [trader/strategy/brother2.py:1-40](), [README.rst:1-26]()\\n\\n## System Architecture\\n\\nThe trader system follows a message-driven architecture with clear separation between data acquisition, strategy execution, and order management. The core design uses Redis Pub/Sub as a message bus to decouple trading logic from the CTP API.\\n\\n### High-Level Component Architecture\\n\\n```mermaid\\ngraph TB\\n    subgraph \\\"Entry Point\\\"\\n        MainPy[\\\"trader/main.py\\u003cbr/\\u003eDjango initialization\\u003cbr/\\u003eStrategy launcher\\\"]\\n    end\\n    \\n    subgraph \\\"Core Trading Engine\\\"\\n        TradeStrategy[\\\"TradeStrategy\\u003cbr/\\u003etrader/strategy/brother2.py\\u003cbr/\\u003eSignal processing\\u003cbr/\\u003eOrder management\\u003cbr/\\u003ePosition tracking\\\"]\\n        BaseModule[\\\"BaseModule\\u003cbr/\\u003etrader/strategy/__init__.py\\u003cbr/\\u003eRedis Pub/Sub\\u003cbr/\\u003eCron scheduling\\u003cbr/\\u003eCallback system\\\"]\\n    end\\n    \\n    subgraph \\\"Message Bus\\\"\\n        RedisChannels[\\\"Redis Pub/Sub\\u003cbr/\\u003eMSG:CTP:REQ:*\\u003cbr/\\u003eMSG:CTP:RSP:TRADE:*\\u003cbr/\\u003eMSG:CTP:RSP:MARKET:*\\\"]\\n    end\\n    \\n    subgraph \\\"Data Layer\\\"\\n        DjangoORM[\\\"Django ORM\\u003cbr/\\u003epanel/models.py\\u003cbr/\\u003e8 core models\\\"]\\n        MySQL[\\\"MySQL Database\\\"]\\n    end\\n    \\n    subgraph \\\"Data Acquisition\\\"\\n        FetchData[\\\"trader/utils/fetch_data.py\\u003cbr/\\u003eOrchestrates daily updates\\\"]\\n        UtilsInit[\\\"trader/utils/__init__.py\\u003cbr/\\u003eExchange data fetchers\\u003cbr/\\u003eMain contract calculation\\u003cbr/\\u003eTechnical indicators\\\"]\\n    end\\n    \\n    subgraph \\\"External Systems\\\"\\n        Exchanges[\\\"5 Chinese Exchanges\\u003cbr/\\u003eSHFE, DCE, CZCE\\u003cbr/\\u003eCFFEX, GFEX\\\"]\\n        CTP[\\\"CTP API\\u003cbr/\\u003eOrder execution\\u003cbr/\\u003eMarket data\\\"]\\n    end\\n    \\n    MainPy --\\u003e TradeStrategy\\n    TradeStrategy --\\u003e BaseModule\\n    BaseModule --\\u003e RedisChannels\\n    RedisChannels --\\u003e CTP\\n    \\n    TradeStrategy --\\u003e DjangoORM\\n    DjangoORM --\\u003e MySQL\\n    \\n    FetchData --\\u003e UtilsInit\\n    UtilsInit --\\u003e Exchanges\\n    UtilsInit --\\u003e DjangoORM\\n    \\n    TradeStrategy --\\u003e UtilsInit\\n```\\n\\n**Sources**: [trader/main.py:1-50](), [trader/strategy/brother2.py:38-63](), [trader/strategy/__init__.py:1-200](), [trader/utils/__init__.py:1-100](), [panel/models.py:1-40]()\\n\\n### Component-to-File Mapping\\n\\nThe following diagram maps system components to their implementation files, showing the most critical code paths:\\n\\n```mermaid\\ngraph LR\\n    subgraph \\\"Strategy Framework\\\"\\n        TradeStrategyClass[\\\"TradeStrategy class\\u003cbr/\\u003e227.43 importance\\\"]\\n        BaseModuleClass[\\\"BaseModule class\\\"]\\n        CallbackDecorator[\\\"@RegisterCallback\\u003cbr/\\u003edecorator\\\"]\\n    end\\n    \\n    subgraph \\\"Data Models\\\"\\n        Broker[\\\"Broker model\\\"]\\n        Strategy[\\\"Strategy model\\\"]\\n        Instrument[\\\"Instrument model\\\"]\\n        Signal[\\\"Signal model\\\"]\\n        Order[\\\"Order model\\\"]\\n        Trade[\\\"Trade model\\\"]\\n        DailyBar[\\\"DailyBar model\\\"]\\n        MainBar[\\\"MainBar model\\\"]\\n    end\\n    \\n    subgraph \\\"Utilities\\\"\\n        UpdateFromShfe[\\\"update_from_shfe()\\\"]\\n        UpdateFromDce[\\\"update_from_dce()\\\"]\\n        UpdateFromCzce[\\\"update_from_czce()\\\"]\\n        UpdateFromCffex[\\\"update_from_cffex()\\\"]\\n        UpdateFromGfex[\\\"update_from_gfex()\\\"]\\n        CalcMainInst[\\\"calc_main_inst()\\\"]\\n        CalcHistorySignal[\\\"calc_history_signal()\\\"]\\n    end\\n    \\n    subgraph \\\"Configuration\\\"\\n        ConfigIni[\\\"config.ini\\\"]\\n        ReadConfig[\\\"read_config.py\\\"]\\n        Constants[\\\"panel/const.py\\\"]\\n    end\\n    \\n    TradeStrategyClass -.-\\u003e|\\\"brother2.py:38-63\\\"| F1[\\\"trader/strategy/brother2.py\\\"]\\n    BaseModuleClass -.-\\u003e|\\\"__init__.py\\\"| F2[\\\"trader/strategy/__init__.py\\\"]\\n    CallbackDecorator -.-\\u003e|\\\"func_container.py\\\"| F3[\\\"trader/utils/func_container.py\\\"]\\n    \\n    Broker -.-\\u003e|\\\"models.py:61-83\\\"| F4[\\\"panel/models.py\\\"]\\n    Strategy -.-\\u003e|\\\"models.py:104-126\\\"| F4\\n    Instrument -.-\\u003e|\\\"models.py:146-171\\\"| F4\\n    Signal -.-\\u003e|\\\"models.py:173-192\\\"| F4\\n    Order -.-\\u003e|\\\"models.py:237-260\\\"| F4\\n    Trade -.-\\u003e|\\\"models.py:262-289\\\"| F4\\n    DailyBar -.-\\u003e|\\\"models.py:216-235\\\"| F4\\n    MainBar -.-\\u003e|\\\"models.py:194-214\\\"| F4\\n    \\n    UpdateFromShfe -.-\\u003e|\\\"__init__.py:121-174\\\"| F5[\\\"trader/utils/__init__.py\\\"]\\n    UpdateFromDce -.-\\u003e|\\\"__init__.py:220-265\\\"| F5\\n    UpdateFromCzce -.-\\u003e|\\\"__init__.py:177-217\\\"| F5\\n    UpdateFromCffex -.-\\u003e|\\\"__init__.py:296-349\\\"| F5\\n    UpdateFromGfex -.-\\u003e|\\\"__init__.py:268-293\\\"| F5\\n    CalcMainInst -.-\\u003e|\\\"__init__.py:381-421\\\"| F5\\n    CalcHistorySignal -.-\\u003e|\\\"__init__.py:500-600\\\"| F5\\n    \\n    ConfigIni -.-\\u003e|\\\"config.ini\\\"| F6[\\\"config.ini\\\"]\\n    ReadConfig -.-\\u003e|\\\"read_config.py\\\"| F7[\\\"trader/utils/read_config.py\\\"]\\n    Constants -.-\\u003e|\\\"const.py\\\"| F8[\\\"panel/const.py\\\"]\\n```\\n\\n**Sources**: [trader/strategy/brother2.py:38-63](), [trader/strategy/__init__.py:1-100](), [panel/models.py:42-289](), [trader/utils/__init__.py:121-600](), [trader/utils/read_config.py:1-50](), [panel/const.py:1-100]()\\n\\n## Core Components\\n\\n### Trading Strategy Engine\\n\\nThe `TradeStrategy` class ([trader/strategy/brother2.py:38-1050]()) is the heart of the system with an importance score of 227.43. It extends `BaseModule` to provide:\\n\\n- **Signal Processing**: Three scheduled windows (08:55, 09:25, 20:55) for processing different market sessions\\n- **Order Execution**: `ReqOrderInsert()` generates CTP order requests published to Redis\\n- **Position Tracking**: `refresh_position()` synchronizes local state with CTP account data\\n- **Risk Management**: Automatic retry logic for rejected orders and position sizing based on ATR\\n\\nKey methods:\\n- `calc_signal()`: Generates trading signals using technical indicators ([trader/strategy/brother2.py:725-850]())\\n- `refresh_account()`: Updates account balance and margin ([trader/strategy/brother2.py:86-112]())\\n- `OnRtnTrade()`: Handles trade confirmations from CTP ([trader/strategy/brother2.py:391-469]())\\n- `OnRtnOrder()`: Processes order status updates ([trader/strategy/brother2.py:510-566]())\\n\\n**Sources**: [trader/strategy/brother2.py:38-850]()\\n\\n### Data Models\\n\\nThe system uses Django ORM with eight core models ([panel/models.py:42-289]()):\\n\\n| Model | Purpose | Key Fields |\\n|-------|---------|------------|\\n| `Broker` | Trading account credentials | `cash`, `current`, `pre_balance`, `margin` |\\n| `Strategy` | Trading strategy configuration | `instruments`, `param_set`, `force_opens` |\\n| `Instrument` | Contract specifications | `main_code`, `price_tick`, `margin_rate`, `volume_multiple` |\\n| `Signal` | Trading signals | `type`, `price`, `volume`, `trigger_time`, `processed` |\\n| `Order` | Order records | `order_ref`, `status`, `direction`, `offset_flag` |\\n| `Trade` | Position tracking | `shares`, `avg_entry_price`, `profit`, `open_time`, `close_time` |\\n| `DailyBar` | Individual contract OHLC data | `open`, `high`, `low`, `close`, `volume`, `open_interest` |\\n| `MainBar` | Continuous contract series | `code`, `basis` (rollover adjustment) |\\n\\n**Sources**: [panel/models.py:61-289]()\\n\\n### Message Bus Architecture\\n\\nRedis Pub/Sub channels decouple the trading strategy from the CTP API:\\n\\n```mermaid\\ngraph LR\\n    subgraph \\\"TradeStrategy\\\"\\n        ReqOrderInsert[\\\"ReqOrderInsert()\\u003cbr/\\u003ePublishes order requests\\\"]\\n        OnRtnTradeCallback[\\\"OnRtnTrade()\\u003cbr/\\u003e@RegisterCallback\\\"]\\n        OnRtnOrderCallback[\\\"OnRtnOrder()\\u003cbr/\\u003e@RegisterCallback\\\"]\\n        QueryMethod[\\\"query()\\u003cbr/\\u003eAsync request/response\\\"]\\n    end\\n    \\n    subgraph \\\"Redis Channels\\\"\\n        REQ[\\\"MSG:CTP:REQ:*\\u003cbr/\\u003eRequest channel\\\"]\\n        TRADE_RSP[\\\"MSG:CTP:RSP:TRADE:*\\u003cbr/\\u003eTrade response pattern\\\"]\\n        ORDER_RSP[\\\"MSG:CTP:RSP:TRADE:OnRtnOrder:*\\u003cbr/\\u003eOrder response pattern\\\"]\\n        QRY_RSP[\\\"MSG:CTP:RSP:TRADE:OnRspQry*\\u003cbr/\\u003eQuery response pattern\\\"]\\n    end\\n    \\n    subgraph \\\"CTP Gateway\\\"\\n        CTP[\\\"CTP API Handler\\u003cbr/\\u003eSeparate process\\\"]\\n    end\\n    \\n    ReqOrderInsert --\\u003e|\\\"Publish\\\"| REQ\\n    REQ --\\u003e|\\\"Subscribe\\\"| CTP\\n    \\n    CTP --\\u003e|\\\"Publish\\\"| TRADE_RSP\\n    CTP --\\u003e|\\\"Publish\\\"| ORDER_RSP\\n    CTP --\\u003e|\\\"Publish\\\"| QRY_RSP\\n    \\n    TRADE_RSP --\\u003e|\\\"Pattern subscribe\\\"| OnRtnTradeCallback\\n    ORDER_RSP --\\u003e|\\\"Pattern subscribe\\\"| OnRtnOrderCallback\\n    QRY_RSP --\\u003e|\\\"await response\\\"| QueryMethod\\n```\\n\\n**Sources**: [trader/strategy/brother2.py:301-343](), [trader/strategy/brother2.py:391-469](), [trader/strategy/brother2.py:510-566](), [trader/strategy/brother2.py:236-257]()\\n\\n### Data Acquisition Pipeline\\n\\nThe `trader/utils/__init__.py` module (importance: 76.12) provides functions to fetch and process market data:\\n\\n1. **Exchange Data Fetchers**: Five async functions fetch daily OHLC data:\\n   - `update_from_shfe()`: Shanghai Futures Exchange ([trader/utils/__init__.py:121-174]())\\n   - `update_from_dce()`: Dalian Commodity Exchange ([trader/utils/__init__.py:220-265]())\\n   - `update_from_czce()`: Zhengzhou Commodity Exchange ([trader/utils/__init__.py:177-217]())\\n   - `update_from_cffex()`: China Financial Futures Exchange ([trader/utils/__init__.py:296-349]())\\n   - `update_from_gfex()`: Guangzhou Futures Exchange ([trader/utils/__init__.py:268-293]())\\n\\n2. **Main Contract Calculation**: `calc_main_inst()` identifies the main contract based on volume and open interest thresholds ([trader/utils/__init__.py:381-421]())\\n\\n3. **Rollover Handling**: `handle_rollover()` applies basis adjustments to maintain continuous price series ([trader/utils/__init__.py:365-379]())\\n\\n4. **Technical Analysis**: Uses TA-Lib for ATR, SMA, and breakout level calculations\\n\\n**Sources**: [trader/utils/__init__.py:121-421]()\\n\\n## Technology Stack\\n\\n| Component | Technology | Purpose |\\n|-----------|-----------|---------|\\n| **Backend Framework** | Django 4.x | ORM, admin interface, model layer |\\n| **Database** | MySQL | Persistent storage for all trading data |\\n| **Message Bus** | Redis | Pub/Sub for CTP API communication |\\n| **Technical Analysis** | TA-Lib | ATR, SMA, RSI, MACD indicators |\\n| **Async I/O** | aiohttp, aioredis | Non-blocking network operations |\\n| **Task Scheduling** | croniter | Cron-style scheduled tasks |\\n| **Data Processing** | pandas, numpy | Time series analysis |\\n| **JSON Handling** | ujson | High-performance JSON parsing |\\n\\n**Sources**: [trader/strategy/brother2.py:16-32](), [trader/utils/__init__.py:16-40]()\\n\\n## Trading Workflow Overview\\n\\nThe daily trading cycle follows this sequence:\\n\\n```mermaid\\nsequenceDiagram\\n    participant Cron as \\\"Scheduled Tasks\\u003cbr/\\u003e(croniter)\\\"\\n    participant Strategy as \\\"TradeStrategy\\\"\\n    participant DB as \\\"Django ORM\\\"\\n    participant Redis as \\\"Redis Pub/Sub\\\"\\n    participant CTP as \\\"CTP API\\\"\\n    \\n    Note over Cron,Strategy: 17:00 - Data Collection\\n    Cron-\\u003e\\u003eStrategy: collect_quote()\\n    Strategy-\\u003e\\u003eStrategy: Fetch from 5 exchanges\\n    Strategy-\\u003e\\u003eDB: Store DailyBar records\\n    Strategy-\\u003e\\u003eStrategy: calc_main_inst()\\n    Strategy-\\u003e\\u003eDB: Update MainBar with rollover\\n    Strategy-\\u003e\\u003eStrategy: calc_signal()\\n    Strategy-\\u003e\\u003eDB: Create Signal records\\n    \\n    Note over Cron,Strategy: 08:55 - Day Session Signal Processing\\n    Cron-\\u003e\\u003eStrategy: processing_signal1()\\n    Strategy-\\u003e\\u003eDB: Query unprocessed Signals\\n    DB--\\u003e\\u003eStrategy: Signal list\\n    Strategy-\\u003e\\u003eStrategy: ReqOrderInsert(signal)\\n    Strategy-\\u003e\\u003eRedis: Publish order request\\n    Redis-\\u003e\\u003eCTP: Forward to exchange\\n    \\n    Note over CTP,Strategy: Order Execution\\n    CTP--\\u003e\\u003eRedis: OnRtnOrder (status)\\n    Redis--\\u003e\\u003eStrategy: Order confirmation\\n    Strategy-\\u003e\\u003eDB: Create/Update Order\\n    CTP--\\u003e\\u003eRedis: OnRtnTrade (fill)\\n    Redis--\\u003e\\u003eStrategy: Trade confirmation\\n    Strategy-\\u003e\\u003eDB: Update Trade, mark Signal.processed\\n    \\n    Note over Cron,Strategy: 15:20 - Market Close\\n    Cron-\\u003e\\u003eStrategy: refresh_all()\\n    Strategy-\\u003e\\u003eCTP: Query account via Redis\\n    CTP--\\u003e\\u003eStrategy: Account data\\n    Strategy-\\u003e\\u003eDB: Update Broker\\n    Strategy-\\u003e\\u003eCTP: Query positions via Redis\\n    CTP--\\u003e\\u003eStrategy: Position list\\n    Strategy-\\u003e\\u003eDB: Update Trade records\\n    \\n    Note over Cron,Strategy: 15:30 - Performance Update\\n    Cron-\\u003e\\u003eStrategy: update_equity()\\n    Strategy-\\u003e\\u003eDB: Calculate NAV, equity\\n    Strategy-\\u003e\\u003eDB: Create Performance record\\n```\\n\\n**Sources**: [trader/strategy/brother2.py:568-703](), [trader/strategy/brother2.py:684-723](), [trader/strategy/brother2.py:572-643](), [trader/strategy/brother2.py:644-683]()\\n\\n## Key Design Patterns\\n\\n### 1. Callback-Based Event Handling\\n\\nThe `@RegisterCallback` decorator ([trader/utils/func_container.py]()) enables declarative event routing:\\n\\n```python\\n@RegisterCallback(channel='MSG:CTP:RSP:TRADE:OnRtnTrade:*')\\nasync def OnRtnTrade(self, channel, trade: dict):\\n    # Process trade confirmation\\n```\\n\\n**Sources**: [trader/strategy/brother2.py:391-469]()\\n\\n### 2. Scheduled Task Execution\\n\\nCron expressions define recurring tasks:\\n\\n```python\\n@RegisterCallback(crontab='20 15 * * *')\\nasync def refresh_all(self):\\n    # Daily account refresh at 15:20\\n```\\n\\n**Sources**: [trader/strategy/brother2.py:644-654]()\\n\\n### 3. Asynchronous Request/Response\\n\\nThe `query()` method implements timeout-based async queries to CTP:\\n\\n```python\\nasync def query(self, query_type: str, **kwargs):\\n    # Subscribe to response channel\\n    # Publish request\\n    # Wait for response with timeout\\n    # Return result\\n```\\n\\n**Sources**: [trader/strategy/brother2.py:236-257]()\\n\\n### 4. State Synchronization\\n\\nThe system maintains consistency between local database state and CTP account state through periodic refresh operations at market close.\\n\\n**Sources**: [trader/strategy/brother2.py:86-154]()\\n\\n## Next Steps\\n\\nFor detailed information on specific subsystems:\\n- [Installation and Configuration](#2)\\n- [System Architecture Details](#3)\\n- [Trading Strategy Implementation](#4)\\n- [Data Models and Processing](#5)\\n- [CTP API Integration](#6)\"])</script><script>self.__next_f.push([1,\"18:T3210,\"])</script><script>self.__next_f.push([1,\"# Getting Started\\n\\n\\u003cdetails\\u003e\\n\\u003csummary\\u003eRelevant source files\\u003c/summary\\u003e\\n\\nThe following files were used as context for generating this wiki page:\\n\\n- [README.rst](README.rst)\\n- [requirements.txt](requirements.txt)\\n- [trader/main.py](trader/main.py)\\n- [trader/utils/read_config.py](trader/utils/read_config.py)\\n\\n\\u003c/details\\u003e\\n\\n\\n\\nThis page provides an overview of the steps required to install, configure, and run the trader automated futures trading system. The trader system is a production-grade platform that connects to the China Futures Trading Platform (CTP) API to execute automated trading strategies on Chinese commodity exchanges.\\n\\nThis page covers the essential workflow from installation to running your first strategy. For detailed instructions on each step, see:\\n- [Installation](#2.1) - Dependencies and package setup\\n- [Configuration](#2.2) - config.ini structure and system configuration\\n- [Running the System](#2.3) - Starting the trader and monitoring execution\\n\\nFor information about developing custom strategies, see [Creating Custom Strategies](#8.3). For architecture details, see [System Components](#3.1).\\n\\n## Prerequisites\\n\\nBefore starting, ensure you have access to the following system components and credentials:\\n\\n```mermaid\\ngraph TB\\n    subgraph \\\"Required Software\\\"\\n        Python[\\\"Python 3.x\\\"]\\n        MySQL[\\\"MySQL Database\\\"]\\n        Redis[\\\"Redis Server\\\"]\\n        TALib[\\\"TA-Lib C Library\\\"]\\n    end\\n    \\n    subgraph \\\"Configuration Requirements\\\"\\n        CTPCreds[\\\"CTP API Credentials\\u003cbr/\\u003eBrokerID, UserID, Password\\\"]\\n        DBCreds[\\\"MySQL Credentials\\u003cbr/\\u003ehost, port, user, password\\\"]\\n        RedisConfig[\\\"Redis Configuration\\u003cbr/\\u003ehost, port, db\\\"]\\n    end\\n    \\n    subgraph \\\"Exchange Access\\\"\\n        Exchanges[\\\"Market Data Access\\u003cbr/\\u003eSHFE, DCE, CZCE, CFFEX, GFEX\\\"]\\n    end\\n    \\n    subgraph \\\"Django Dashboard\\\"\\n        Dashboard[\\\"dashboard project\\u003cbr/\\u003eDjango ORM models\\\"]\\n    end\\n    \\n    Python --\\u003e TALib\\n    MySQL --\\u003e DBCreds\\n    Redis --\\u003e RedisConfig\\n    CTPCreds --\\u003e Exchanges\\n    Dashboard --\\u003e MySQL\\n    \\n    style Python fill:#f9f9f9\\n    style MySQL fill:#f9f9f9\\n    style Redis fill:#f9f9f9\\n    style TALib fill:#f9f9f9\\n```\\n\\n**Sources:** [requirements.txt:1-25](), [README.rst:7-20](), [trader/utils/read_config.py:23-60]()\\n\\n## Installation Workflow\\n\\nThe trader system requires several dependencies to be installed in a specific order. The most critical dependency is the TA-Lib C library, which must be installed before the Python packages.\\n\\n| Step | Component | Installation Method | Notes |\\n|------|-----------|-------------------|-------|\\n| 1 | TA-Lib C Library | System package manager | Required for technical indicators |\\n| 2 | MySQL Server | System package manager | Configure timeouts (see below) |\\n| 3 | Redis Server | System package manager | Used as message broker |\\n| 4 | Python Packages | `pip install -r requirements.txt` | Includes Django, aiohttp, TA-Lib |\\n| 5 | Django Dashboard | Clone from repository | Models defined in `panel/models.py` |\\n| 6 | Configuration File | Auto-generated on first run | Located at `{user_config_dir}/config.ini` |\\n\\n### MySQL Configuration\\n\\nThe system requires MySQL to be configured with extended timeout values to handle long-running connections. Add the following to `/etc/my.cnf.d/server.cnf`:\\n\\n```ini\\n[mysqld]\\nwait_timeout=31536000\\ninteractive_timeout=31536000\\n```\\n\\n**Sources:** [README.rst:10-20](), [requirements.txt:1-25](), [trader/utils/read_config.py:62-69]()\\n\\n## System Initialization Flow\\n\\nThe following diagram shows the initialization sequence when starting the trader system, mapping to actual code entities:\\n\\n```mermaid\\nsequenceDiagram\\n    participant User\\n    participant main[\\\"trader/main.py\\\"]\\n    participant Django[\\\"django.setup()\\\"]\\n    participant config[\\\"read_config.py\\\"]\\n    participant Logger[\\\"logging handlers\\\"]\\n    participant Redis[\\\"Redis client\\\"]\\n    participant Strategy[\\\"TradeStrategy\\\"]\\n    \\n    User-\\u003e\\u003emain: python trader/main.py\\n    \\n    rect rgb(250, 250, 250)\\n        Note over main,Django: Django Environment Setup\\n        main-\\u003e\\u003emain: sys.path.append(dashboard)\\n        main-\\u003e\\u003emain: os.environ DJANGO_SETTINGS_MODULE\\n        main-\\u003e\\u003eDjango: django.setup()\\n        Django--\\u003e\\u003emain: ORM ready\\n    end\\n    \\n    rect rgb(250, 250, 250)\\n        Note over main,config: Configuration Loading\\n        main-\\u003e\\u003econfig: import config_file, config\\n        config-\\u003e\\u003econfig: Read config.ini\\n        config-\\u003e\\u003econfig: Parse error.xml for CTP errors\\n        config--\\u003e\\u003emain: Configuration loaded\\n    end\\n    \\n    rect rgb(250, 250, 250)\\n        Note over main,Logger: Logging Setup\\n        main-\\u003e\\u003eLogger: Create RotatingFileHandler\\n        main-\\u003e\\u003eLogger: Create StreamHandler\\n        main-\\u003e\\u003eRedis: Create RedislHandler\\n        Redis--\\u003e\\u003eLogger: Publish to MSG:LOG:WEIXIN\\n        main-\\u003e\\u003eLogger: Set formatters and levels\\n    end\\n    \\n    rect rgb(250, 250, 250)\\n        Note over main,Strategy: Strategy Initialization\\n        main-\\u003e\\u003emain: Write PID file\\n        main-\\u003e\\u003eStrategy: TradeStrategy(name='2.2')\\n        Strategy-\\u003e\\u003eStrategy: Initialize BaseModule\\n        main-\\u003e\\u003eStrategy: run()\\n        Strategy--\\u003e\\u003eStrategy: Start event loop\\n    end\\n```\\n\\n**Sources:** [trader/main.py:16-77](), [trader/utils/read_config.py:62-79]()\\n\\n## Configuration File Structure\\n\\nOn first run, the system auto-generates a configuration file at `{user_config_dir}/trader/config.ini`. The `user_config_dir` is determined by the `appdirs` library and varies by platform:\\n\\n- **Linux:** `~/.config/trader/config.ini`\\n- **macOS:** `~/Library/Application Support/trader/config.ini`\\n- **Windows:** `%LOCALAPPDATA%\\\\trader\\\\config.ini`\\n\\nThe configuration file contains the following sections:\\n\\n```mermaid\\ngraph LR\\n    subgraph \\\"config.ini sections\\\"\\n        MSG[\\\"MSG_CHANNEL\\u003cbr/\\u003eRedis pub/sub patterns\\\"]\\n        TRADE[\\\"TRADE\\u003cbr/\\u003ecommand_timeout\\u003cbr/\\u003eignore_inst list\\\"]\\n        REDIS[\\\"REDIS\\u003cbr/\\u003ehost, port, db\\\"]\\n        MYSQL[\\\"MYSQL\\u003cbr/\\u003ehost, port, db\\u003cbr/\\u003euser, password\\\"]\\n        LOG[\\\"LOG\\u003cbr/\\u003elevel, format\\u003cbr/\\u003eweixin_format\\\"]\\n        APIs[\\\"QuantDL\\u003cbr/\\u003eTushare\\u003cbr/\\u003eAPI tokens\\\"]\\n    end\\n    \\n    subgraph \\\"Used by Components\\\"\\n        TradeStrategy[\\\"TradeStrategy\\u003cbr/\\u003ebrother2.py\\\"]\\n        BaseModule[\\\"BaseModule\\u003cbr/\\u003e__init__.py\\\"]\\n        Logging[\\\"Logging Handlers\\u003cbr/\\u003emain.py\\\"]\\n        DataFetch[\\\"fetch_data.py\\u003cbr/\\u003eExchange APIs\\\"]\\n    end\\n    \\n    MSG --\\u003e TradeStrategy\\n    MSG --\\u003e BaseModule\\n    TRADE --\\u003e TradeStrategy\\n    REDIS --\\u003e BaseModule\\n    REDIS --\\u003e Logging\\n    MYSQL --\\u003e TradeStrategy\\n    LOG --\\u003e Logging\\n    APIs --\\u003e DataFetch\\n```\\n\\n**Sources:** [trader/utils/read_config.py:23-72](), [trader/main.py:38-60]()\\n\\n## Key Entry Points and Components\\n\\nThe trader system consists of several key components that you'll interact with:\\n\\n### Main Entry Point: `trader/main.py`\\n\\nThe `main.py` file is the system entry point. It performs the following initialization steps:\\n\\n1. **Django Setup** [trader/main.py:19-27](): Configures `sys.path` to locate the Django dashboard project and calls `django.setup()` to initialize the ORM\\n2. **Logging Configuration** [trader/main.py:49-65](): Creates three log handlers:\\n   - `RotatingFileHandler` - writes to `{user_log_dir}/trader.log`\\n   - `StreamHandler` - console output\\n   - `RedislHandler` - publishes to Redis channel for WeChat notifications\\n3. **PID File Management** [trader/main.py:67-72](): Writes process ID to `{user_cache_dir}/trader.pid`\\n4. **Strategy Instantiation** [trader/main.py:77](): Creates `TradeStrategy(name='2.2')` and calls `run()`\\n\\n### Core Trading Engine: `TradeStrategy`\\n\\nThe `TradeStrategy` class (located in `trader/strategy/brother2.py`) is the main trading engine. It extends `BaseModule` which provides:\\n\\n- Redis Pub/Sub integration for CTP API communication\\n- Cron-based task scheduling using `croniter`\\n- Callback registration system via `@RegisterCallback` decorator\\n\\n### Configuration Manager: `read_config.py`\\n\\nThe [trader/utils/read_config.py]() module provides:\\n\\n- `config`: A `ConfigParser` instance with all settings loaded\\n- `config_file`: Path to the configuration file\\n- `app_dir`: An `AppDirs` instance for platform-specific directories\\n- `ctp_errors`: Dictionary mapping CTP error codes to Chinese error messages from `error.xml`\\n\\n**Sources:** [trader/main.py:1-78](), [trader/utils/read_config.py:1-79]()\\n\\n## Dependency Overview\\n\\nThe system requires the following Python packages:\\n\\n```mermaid\\ngraph TB\\n    subgraph \\\"Async I/O\\\"\\n        aiohttp[\\\"aiohttp[speedups]\\u003cbr/\\u003eHTTP client\\\"]\\n        aioredis[\\\"aioredis[hiredis]\\u003cbr/\\u003eAsync Redis client\\\"]\\n        redis[\\\"redis\\u003cbr/\\u003eSync Redis client\\\"]\\n    end\\n    \\n    subgraph \\\"Data Processing\\\"\\n        numpy[\\\"numpy\\u003cbr/\\u003eNumerical arrays\\\"]\\n        pandas[\\\"pandas\\u003cbr/\\u003eDataFrames\\\"]\\n        talib[\\\"TA-Lib\\u003cbr/\\u003eTechnical indicators\\\"]\\n    end\\n    \\n    subgraph \\\"Web Framework\\\"\\n        django[\\\"django\\u003cbr/\\u003eORM and admin\\\"]\\n        djangoredis[\\\"django-redis\\u003cbr/\\u003eCache backend\\\"]\\n        mysqlclient[\\\"mysqlclient\\u003cbr/\\u003eMySQL driver\\\"]\\n    end\\n    \\n    subgraph \\\"Utilities\\\"\\n        croniter[\\\"croniter\\u003cbr/\\u003eCron scheduling\\\"]\\n        appdirs[\\\"appdirs\\u003cbr/\\u003eConfig directories\\\"]\\n        ujson[\\\"ujson\\u003cbr/\\u003eFast JSON\\\"]\\n        bs4[\\\"beautifulsoup4\\u003cbr/\\u003eHTML parsing\\\"]\\n    end\\n    \\n    subgraph \\\"Used By\\\"\\n        BaseModule[\\\"BaseModule\\u003cbr/\\u003estrategy/__init__.py\\\"]\\n        TradeStrategy[\\\"TradeStrategy\\u003cbr/\\u003estrategy/brother2.py\\\"]\\n        FetchData[\\\"fetch_data.py\\u003cbr/\\u003eutils/\\\"]\\n        Utils[\\\"utils/__init__.py\\u003cbr/\\u003eIndicators\\\"]\\n    end\\n    \\n    aiohttp --\\u003e BaseModule\\n    aioredis --\\u003e BaseModule\\n    redis --\\u003e TradeStrategy\\n    croniter --\\u003e BaseModule\\n    \\n    django --\\u003e TradeStrategy\\n    djangoredis --\\u003e TradeStrategy\\n    mysqlclient --\\u003e TradeStrategy\\n    \\n    numpy --\\u003e Utils\\n    pandas --\\u003e Utils\\n    talib --\\u003e Utils\\n    \\n    bs4 --\\u003e FetchData\\n    ujson --\\u003e BaseModule\\n```\\n\\n**Sources:** [requirements.txt:1-25]()\\n\\n## Platform-Specific Setup\\n\\nThe system includes platform-specific path configuration in [trader/main.py:19-24]():\\n\\n| Platform | Dashboard Path | Purpose |\\n|----------|---------------|---------|\\n| `darwin` (macOS) | `/Users/jeffchen/Documents/gitdir/dashboard` | Development path |\\n| `win32` (Windows) | `D:\\\\github\\\\dashboard` | Development path |\\n| Linux | `/root/gitee/dashboard` | Production path |\\n\\nYou will need to modify these paths to match your local setup. The dashboard project contains the Django models defined in `panel/models.py` that the trader system uses for data persistence.\\n\\n**Sources:** [trader/main.py:19-24]()\\n\\n## Startup Checklist\\n\\nBefore running the trader system for the first time, ensure:\\n\\n1.  **MySQL server is running** with timeout configuration applied\\n2.  **Redis server is running** on the configured host and port\\n3.  **TA-Lib C library is installed** system-wide\\n4.  **Python dependencies are installed** via `pip install -r requirements.txt`\\n5.  **Django dashboard project is accessible** at the configured path\\n6.  **Configuration file exists** at `{user_config_dir}/trader/config.ini`\\n7.  **CTP API credentials are configured** in the Django admin panel (Broker model)\\n8.  **Exchange instruments are populated** in the database (Instrument model)\\n\\n**Sources:** [README.rst:7-20](), [trader/main.py:19-27]()\\n\\n## Running the System\\n\\nOnce all prerequisites are met, start the trading system:\\n\\n```bash\\npython trader/main.py\\n```\\n\\nThe system will:\\n\\n1. Print initialization messages including config file path and log directory\\n2. Write PID file to `{user_cache_dir}/trader.pid`\\n3. Print \\\"Big Brother is watching you!\\\" to indicate successful startup\\n4. Initialize the `TradeStrategy` instance with name \\\"2.2\\\"\\n5. Start the event loop and begin executing scheduled tasks\\n\\n**Console Output Example:**\\n```\\nBig Brother is watching you!\\nused config file: /home/user/.config/trader/config.ini\\nlog stored in: /home/user/.local/share/trader\\npid file: /home/user/.cache/trader/trader.pid\\n```\\n\\nFor detailed information on monitoring the running system, see [Running the System](#2.3). For information on the scheduled task execution flow, see [Scheduled Tasks](#4.6).\\n\\n**Sources:** [trader/main.py:67-77]()\\n\\n## Next Steps\\n\\nAfter successfully starting the system:\\n\\n1. **Monitor logs** - Check `{user_log_dir}/trader.log` for system activity\\n2. **Configure strategies** - Use Django admin to configure Strategy instances\\n3. **Verify data acquisition** - Ensure daily market data is being fetched from exchanges\\n4. **Test signal generation** - Verify that trading signals are being calculated correctly\\n5. **Review scheduled tasks** - Understand when signals are processed and orders are executed\\n\\nFor detailed configuration options, proceed to [Configuration](#2.2). To understand the scheduled execution flow, see [Scheduled Tasks](#4.6). To learn about the trading strategy logic, see [TradeStrategy Class](#4.1).\\n\\n**Sources:** [trader/main.py:1-78](), [trader/utils/read_config.py:1-79]()\"])</script><script>self.__next_f.push([1,\"19:T413a,\"])</script><script>self.__next_f.push([1,\"# Installation\\n\\n\\u003cdetails\\u003e\\n\\u003csummary\\u003eRelevant source files\\u003c/summary\\u003e\\n\\nThe following files were used as context for generating this wiki page:\\n\\n- [README.rst](README.rst)\\n- [requirements.txt](requirements.txt)\\n\\n\\u003c/details\\u003e\\n\\n\\n\\nThis page provides detailed instructions for installing the trader system and all required dependencies. The trader system is a Python-based automated trading platform that requires several external components including TA-Lib, MySQL, Redis, and various Python packages.\\n\\nFor information about configuring the installed system, see [Configuration](#2.2). For instructions on running the system after installation, see [Running the System](#2.3).\\n\\n---\\n\\n## Prerequisites\\n\\nThe trader system has specific requirements that must be met before installation:\\n\\n| Requirement | Version/Details | Purpose |\\n|------------|-----------------|---------|\\n| Operating System | Linux (recommended) | System assumes Linux paths and services |\\n| Python | 3.7+ | Core runtime environment |\\n| MySQL | 5.7+ or 8.0+ | Primary data storage for Django ORM |\\n| Redis | 5.0+ | Message bus and caching layer |\\n| TA-Lib C Library | Latest stable | Technical analysis calculations |\\n| pip | Latest | Python package manager |\\n\\n**Sources:** [requirements.txt:1-25](), [README.rst:1-26]()\\n\\n---\\n\\n## Installation Overview\\n\\nThe installation process follows a specific dependency chain where certain components must be installed before others.\\n\\n```mermaid\\ngraph TB\\n    Start[\\\"Installation Start\\\"]\\n    \\n    SysDeps[\\\"System Dependencies\\u003cbr/\\u003e(MySQL, Redis, build tools)\\\"]\\n    TALib[\\\"TA-Lib C Library\\u003cbr/\\u003e(Pre-compiled binary)\\\"]\\n    PythonEnv[\\\"Python Environment\\u003cbr/\\u003e(venv/virtualenv)\\\"]\\n    PipInstall[\\\"pip install -r requirements.txt\\\"]\\n    MySQLConfig[\\\"MySQL Configuration\\u003cbr/\\u003e(/etc/my.cnf.d/server.cnf)\\\"]\\n    DBSetup[\\\"Django Database Setup\\u003cbr/\\u003e(migrate, createcachetable)\\\"]\\n    Verify[\\\"Verification\\\"]\\n    \\n    Start --\\u003e SysDeps\\n    SysDeps --\\u003e TALib\\n    TALib --\\u003e PythonEnv\\n    PythonEnv --\\u003e PipInstall\\n    PipInstall --\\u003e MySQLConfig\\n    MySQLConfig --\\u003e DBSetup\\n    DBSetup --\\u003e Verify\\n    \\n    note1[\\\"MySQL and Redis services\\u003cbr/\\u003emust be running\\\"]\\n    note2[\\\"TA-Lib C library MUST be\\u003cbr/\\u003einstalled before pip packages\\\"]\\n    note3[\\\"Django requires mysqlclient\\u003cbr/\\u003eto connect to MySQL\\\"]\\n    \\n    SysDeps -.-\\u003e note1\\n    TALib -.-\\u003e note2\\n    PipInstall -.-\\u003e note3\\n```\\n\\n**Installation Flow Diagram**: Shows the required installation sequence and critical dependencies.\\n\\n**Sources:** [README.rst:7-20](), [requirements.txt:1-25]()\\n\\n---\\n\\n## Step 1: Install System Dependencies\\n\\n### MySQL Server\\n\\nInstall MySQL server and client libraries:\\n\\n**Red Hat/CentOS/Fedora:**\\n```bash\\nsudo yum install mysql-server mysql-devel\\nsudo systemctl start mysqld\\nsudo systemctl enable mysqld\\n```\\n\\n**Debian/Ubuntu:**\\n```bash\\nsudo apt-get update\\nsudo apt-get install mysql-server libmysqlclient-dev\\nsudo systemctl start mysql\\nsudo systemctl enable mysql\\n```\\n\\nAfter installation, secure the MySQL installation:\\n```bash\\nsudo mysql_secure_installation\\n```\\n\\nCreate a database and user for the trader system:\\n```bash\\nmysql -u root -p\\n```\\n```sql\\nCREATE DATABASE trader CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;\\nCREATE USER 'trader'@'localhost' IDENTIFIED BY 'your_password';\\nGRANT ALL PRIVILEGES ON trader.* TO 'trader'@'localhost';\\nFLUSH PRIVILEGES;\\n```\\n\\n### Redis Server\\n\\nInstall Redis server:\\n\\n**Red Hat/CentOS/Fedora:**\\n```bash\\nsudo yum install redis\\nsudo systemctl start redis\\nsudo systemctl enable redis\\n```\\n\\n**Debian/Ubuntu:**\\n```bash\\nsudo apt-get install redis-server\\nsudo systemctl start redis-server\\nsudo systemctl enable redis-server\\n```\\n\\nVerify Redis is running:\\n```bash\\nredis-cli ping\\n# Expected output: PONG\\n```\\n\\n### Build Tools\\n\\nInstall build tools required for compiling Python packages:\\n\\n**Red Hat/CentOS/Fedora:**\\n```bash\\nsudo yum groupinstall \\\"Development Tools\\\"\\nsudo yum install python3-devel\\n```\\n\\n**Debian/Ubuntu:**\\n```bash\\nsudo apt-get install build-essential python3-dev\\n```\\n\\n**Sources:** [requirements.txt:3,6,15,17]()\\n\\n---\\n\\n## Step 2: Install TA-Lib C Library\\n\\nThe TA-Lib Python package (`TA-Lib` in [requirements.txt:12]()) requires the TA-Lib C library to be installed first. This is the most critical pre-installation step.\\n\\n### Download and Compile TA-Lib\\n\\n```bash\\n# Download TA-Lib source\\nwget http://prdownloads.sourceforge.net/ta-lib/ta-lib-0.4.0-src.tar.gz\\n\\n# Extract and compile\\ntar -xzf ta-lib-0.4.0-src.tar.gz\\ncd ta-lib/\\n./configure --prefix=/usr\\nmake\\nsudo make install\\n\\n# Update library cache\\nsudo ldconfig\\n```\\n\\n### Verify Installation\\n\\nCheck that the TA-Lib library is installed:\\n\\n```bash\\n# Check library files\\nls -l /usr/lib/libta_lib.*\\n\\n# Expected output:\\n# /usr/lib/libta_lib.a\\n# /usr/lib/libta_lib.la\\n# /usr/lib/libta_lib.so -\\u003e libta_lib.so.0.0.0\\n# /usr/lib/libta_lib.so.0 -\\u003e libta_lib.so.0.0.0\\n# /usr/lib/libta_lib.so.0.0.0\\n```\\n\\n**Important:** The Python `TA-Lib` package will fail to install if the C library is not present.\\n\\n**Sources:** [README.rst:10](), [requirements.txt:12]()\\n\\n---\\n\\n## Step 3: Python Environment Setup\\n\\n### Create Virtual Environment\\n\\nIt is recommended to use a virtual environment to isolate the trader system's dependencies:\\n\\n```bash\\n# Navigate to the trader repository\\ncd /path/to/trader\\n\\n# Create virtual environment\\npython3 -m venv venv\\n\\n# Activate virtual environment\\nsource venv/bin/activate\\n```\\n\\n### Install Python Dependencies\\n\\nInstall all required Python packages from `requirements.txt`:\\n\\n```bash\\npip install --upgrade pip\\npip install -r requirements.txt\\n```\\n\\n### Dependency Installation Sequence\\n\\nThe `requirements.txt` contains packages in a specific order. Key dependencies include:\\n\\n```mermaid\\ngraph LR\\n    subgraph \\\"Core Framework\\\"\\n        django[\\\"django\\u003cbr/\\u003e(Web framework \\u0026 ORM)\\\"]\\n        mysqlclient[\\\"mysqlclient\\u003cbr/\\u003e(MySQL driver)\\\"]\\n        djangoredis[\\\"django-redis\\u003cbr/\\u003e(Cache backend)\\\"]\\n        djangochoices[\\\"django-choices\\u003cbr/\\u003e(Model enumerations)\\\"]\\n    end\\n    \\n    subgraph \\\"Async I/O\\\"\\n        aiohttp[\\\"aiohttp[speedups]\\u003cbr/\\u003e(Async HTTP client)\\\"]\\n        aioredis[\\\"aioredis[hiredis]\\u003cbr/\\u003e(Async Redis client)\\\"]\\n        redis[\\\"redis\\u003cbr/\\u003e(Sync Redis client)\\\"]\\n    end\\n    \\n    subgraph \\\"Data Processing\\\"\\n        numpy[\\\"numpy\\u003cbr/\\u003e(Numerical arrays)\\\"]\\n        pandas[\\\"pandas\\u003cbr/\\u003e(Data structures)\\\"]\\n        talib[\\\"TA-Lib\\u003cbr/\\u003e(Technical analysis)\\\"]\\n    end\\n    \\n    subgraph \\\"Utilities\\\"\\n        croniter[\\\"croniter\\u003cbr/\\u003e(Cron scheduling)\\\"]\\n        beautifulsoup4[\\\"beautifulsoup4\\u003cbr/\\u003e(HTML parsing)\\\"]\\n        lxml[\\\"lxml\\u003cbr/\\u003e(XML parsing)\\\"]\\n        requests[\\\"requests\\u003cbr/\\u003e(HTTP client)\\\"]\\n        ujson[\\\"ujson\\u003cbr/\\u003e(Fast JSON)\\\"]\\n    end\\n    \\n    subgraph \\\"Testing \\u0026 Monitoring\\\"\\n        asynctest[\\\"asynctest\\u003cbr/\\u003e(Async unit tests)\\\"]\\n        tqdm[\\\"tqdm\\u003cbr/\\u003e(Progress bars)\\\"]\\n    end\\n    \\n    django --\\u003e mysqlclient\\n    django --\\u003e djangoredis\\n    djangoredis --\\u003e redis\\n    talib --\\u003e numpy\\n    pandas --\\u003e numpy\\n```\\n\\n**Dependency Groups Diagram**: Major Python packages organized by function within the trader system.\\n\\n**Sources:** [requirements.txt:1-25]()\\n\\n### Key Dependencies Explained\\n\\n| Package | Purpose in Trader System | Required By |\\n|---------|--------------------------|-------------|\\n| `aiohttp[speedups]` | Async HTTP client for exchange data fetching | [trader/utils/fetch_data.py]() |\\n| `aioredis[hiredis]` | Async Redis client for message bus | [trader/strategy/\\\\_\\\\_init\\\\_\\\\_.py]() BaseModule |\\n| `redis` | Sync Redis operations | Django cache backend |\\n| `django` | ORM and admin interface | [panel/models.py]() data layer |\\n| `mysqlclient` | MySQL database driver | Django MySQL backend |\\n| `TA-Lib` | Technical indicators (ATR, SMA, RSI, MACD) | [trader/utils/\\\\_\\\\_init\\\\_\\\\_.py]() signal calculations |\\n| `croniter` | Cron expression parsing | BaseModule scheduling system |\\n| `pandas` | DataFrame operations for market data | Data processing pipeline |\\n| `numpy` | Numerical operations | TA-Lib and pandas |\\n\\n**Sources:** [requirements.txt:1-25]()\\n\\n---\\n\\n## Step 4: MySQL Configuration\\n\\nThe trader system requires specific MySQL timeout configurations to maintain long-lived database connections.\\n\\n### Modify MySQL Configuration\\n\\nEdit the MySQL server configuration file:\\n\\n**Configuration File Location:**\\n- Red Hat/CentOS/Fedora: `/etc/my.cnf.d/server.cnf`\\n- Debian/Ubuntu: `/etc/mysql/mysql.conf.d/mysqld.cnf`\\n\\nAdd the following configuration under the `[mysqld]` section:\\n\\n```ini\\n[mysqld]\\nwait_timeout=31536000\\ninteractive_timeout=31536000\\n```\\n\\n**Configuration Values:**\\n- `wait_timeout`: Number of seconds the server waits for activity on a non-interactive connection before closing it (31536000 = 1 year)\\n- `interactive_timeout`: Similar to `wait_timeout`, but for interactive connections\\n\\n### Restart MySQL Service\\n\\nApply the configuration by restarting MySQL:\\n\\n```bash\\n# Red Hat/CentOS/Fedora\\nsudo systemctl restart mysqld\\n\\n# Debian/Ubuntu\\nsudo systemctl restart mysql\\n```\\n\\n### Verify Configuration\\n\\nCheck that the new timeout values are active:\\n\\n```bash\\nmysql -u root -p -e \\\"SHOW VARIABLES LIKE '%timeout%';\\\"\\n```\\n\\nExpected output should include:\\n```\\n+----------------------------+----------+\\n| Variable_name              | Value    |\\n+----------------------------+----------+\\n| interactive_timeout        | 31536000 |\\n| wait_timeout               | 31536000 |\\n+----------------------------+----------+\\n```\\n\\n**Why These Settings?** The trader system maintains persistent database connections for real-time trading operations. Default MySQL timeouts (8 hours) would cause connection drops during overnight or weekend periods when markets are closed.\\n\\n**Sources:** [README.rst:12-20]()\\n\\n---\\n\\n## Step 5: Django Database Setup\\n\\nAfter installing dependencies and configuring MySQL, initialize the Django database.\\n\\n### Set Django Settings Module\\n\\nThe trader system uses Django for ORM. Set the Django settings module environment variable:\\n\\n```bash\\nexport DJANGO_SETTINGS_MODULE=panel.settings\\n```\\n\\nAdd this to your shell profile (`.bashrc`, `.bash_profile`, or `.zshrc`) for persistence:\\n\\n```bash\\necho 'export DJANGO_SETTINGS_MODULE=panel.settings' \\u003e\\u003e ~/.bashrc\\nsource ~/.bashrc\\n```\\n\\n### Create Database Tables\\n\\nRun Django migrations to create all necessary tables:\\n\\n```bash\\n# Navigate to project directory\\ncd /path/to/trader\\n\\n# Activate virtual environment\\nsource venv/bin/activate\\n\\n# Run migrations\\npython manage.py migrate\\n```\\n\\nExpected output:\\n```\\nOperations to perform:\\n  Apply all migrations: admin, auth, contenttypes, panel, sessions\\nRunning migrations:\\n  Applying contenttypes.0001_initial... OK\\n  Applying auth.0001_initial... OK\\n  Applying panel.0001_initial... OK\\n  ...\\n```\\n\\n### Create Django Cache Table\\n\\nThe trader system uses Django's cache framework with database backend:\\n\\n```bash\\npython manage.py createcachetable\\n```\\n\\n### Create Admin Superuser (Optional)\\n\\nTo access the Django admin interface:\\n\\n```bash\\npython manage.py createsuperuser\\n```\\n\\nFollow the prompts to create an admin account.\\n\\n**Sources:** [requirements.txt:6,15]()\\n\\n---\\n\\n## Step 6: Redis Configuration\\n\\nWhile Redis works out-of-the-box, verify it's accessible and optionally configure persistence.\\n\\n### Test Redis Connection\\n\\n```bash\\npython3 \\u003c\\u003c EOF\\nimport redis\\nr = redis.Redis(host='localhost', port=6379, db=0)\\nr.ping()\\nprint(\\\"Redis connection successful\\\")\\nEOF\\n```\\n\\n### Optional: Configure Redis Persistence\\n\\nFor production environments, enable Redis persistence by editing `/etc/redis/redis.conf`:\\n\\n```conf\\n# Enable RDB snapshots\\nsave 900 1\\nsave 300 10\\nsave 60 10000\\n\\n# Enable AOF (Append Only File)\\nappendonly yes\\nappendfilename \\\"appendonly.aof\\\"\\n```\\n\\nRestart Redis after configuration changes:\\n\\n```bash\\nsudo systemctl restart redis\\n```\\n\\n**Sources:** [requirements.txt:3,4,15]()\\n\\n---\\n\\n## Step 7: Verification\\n\\nVerify all components are properly installed.\\n\\n### System Dependencies Check\\n\\n```bash\\n# Check MySQL\\nmysql --version\\nsystemctl status mysqld | grep Active\\n\\n# Check Redis\\nredis-cli --version\\nredis-cli ping\\n\\n# Check TA-Lib\\nls -l /usr/lib/libta_lib.so\\n```\\n\\n### Python Environment Check\\n\\nCreate a verification script `verify_install.py`:\\n\\n```python\\n#!/usr/bin/env python3\\nimport sys\\n\\ndef check_import(module_name):\\n    try:\\n        __import__(module_name)\\n        print(f\\\" {module_name}\\\")\\n        return True\\n    except ImportError as e:\\n        print(f\\\" {module_name}: {e}\\\")\\n        return False\\n\\nprint(\\\"Checking Python packages...\\\")\\npackages = [\\n    'django',\\n    'redis',\\n    'aioredis',\\n    'aiohttp',\\n    'talib',\\n    'pandas',\\n    'numpy',\\n    'bs4',  # beautifulsoup4\\n    'croniter',\\n    'MySQLdb',  # mysqlclient\\n]\\n\\nsuccess = all(check_import(pkg) for pkg in packages)\\nsys.exit(0 if success else 1)\\n```\\n\\nRun the verification:\\n\\n```bash\\nsource venv/bin/activate\\npython verify_install.py\\n```\\n\\n### Django Configuration Check\\n\\nVerify Django can connect to the database:\\n\\n```bash\\npython manage.py check\\n```\\n\\nExpected output:\\n```\\nSystem check identified no issues (0 silenced).\\n```\\n\\n### Test TA-Lib Functions\\n\\nVerify TA-Lib is working correctly:\\n\\n```python\\nimport talib\\nimport numpy as np\\n\\n# Generate sample data\\nclose_prices = np.random.random(100)\\n\\n# Calculate SMA\\nsma = talib.SMA(close_prices, timeperiod=20)\\nprint(f\\\"TA-Lib SMA calculation successful: {sma[-1]:.4f}\\\")\\n\\n# Calculate ATR (requires high, low, close)\\nhigh = close_prices * 1.02\\nlow = close_prices * 0.98\\natr = talib.ATR(high, low, close_prices, timeperiod=14)\\nprint(f\\\"TA-Lib ATR calculation successful: {atr[-1]:.4f}\\\")\\n```\\n\\n**Sources:** [requirements.txt:12](), [trader/utils/\\\\_\\\\_init\\\\_\\\\_.py]()\\n\\n---\\n\\n## Installation Component Map\\n\\nThis diagram shows how installed components relate to the trader system's major modules:\\n\\n```mermaid\\ngraph TB\\n    subgraph \\\"Installed System Dependencies\\\"\\n        MySQL[\\\"MySQL Server\\u003cbr/\\u003e(Database storage)\\\"]\\n        Redis[\\\"Redis Server\\u003cbr/\\u003e(Message bus \\u0026 cache)\\\"]\\n        TALibC[\\\"TA-Lib C Library\\u003cbr/\\u003e(libta_lib.so)\\\"]\\n    end\\n    \\n    subgraph \\\"Python Packages\\\"\\n        django[\\\"django\\\"]\\n        mysqlclient[\\\"mysqlclient\\\"]\\n        redispkg[\\\"redis + aioredis\\\"]\\n        talibpy[\\\"TA-Lib Python\\\"]\\n        aiohttp[\\\"aiohttp\\\"]\\n        pandas[\\\"pandas + numpy\\\"]\\n        croniter[\\\"croniter\\\"]\\n    end\\n    \\n    subgraph \\\"Trader System Components\\\"\\n        models[\\\"panel/models.py\\u003cbr/\\u003e(Broker, Strategy, etc.)\\\"]\\n        utils[\\\"trader/utils/__init__.py\\u003cbr/\\u003e(calc functions)\\\"]\\n        fetchdata[\\\"trader/utils/fetch_data.py\\u003cbr/\\u003e(exchange data)\\\"]\\n        basemodule[\\\"trader/strategy/__init__.py\\u003cbr/\\u003e(BaseModule)\\\"]\\n        tradestrategy[\\\"trader/strategy/brother2.py\\u003cbr/\\u003e(TradeStrategy)\\\"]\\n        main[\\\"trader/main.py\\u003cbr/\\u003e(Entry point)\\\"]\\n    end\\n    \\n    MySQL --\\u003e mysqlclient\\n    mysqlclient --\\u003e django\\n    django --\\u003e models\\n    \\n    Redis --\\u003e redispkg\\n    redispkg --\\u003e basemodule\\n    \\n    TALibC --\\u003e talibpy\\n    talibpy --\\u003e utils\\n    \\n    aiohttp --\\u003e fetchdata\\n    pandas --\\u003e utils\\n    croniter --\\u003e basemodule\\n    \\n    models --\\u003e tradestrategy\\n    utils --\\u003e tradestrategy\\n    fetchdata --\\u003e utils\\n    basemodule --\\u003e tradestrategy\\n    tradestrategy --\\u003e main\\n```\\n\\n**Component Dependencies Diagram**: Shows how installed system dependencies and Python packages map to specific trader system modules.\\n\\n**Sources:** [requirements.txt:1-25](), [README.rst:1-26]()\\n\\n---\\n\\n## Troubleshooting\\n\\n### TA-Lib Installation Fails\\n\\n**Error:** `error: command 'gcc' failed with exit status 1`\\n\\n**Solution:** Install build tools and ensure TA-Lib C library is present:\\n```bash\\nsudo yum groupinstall \\\"Development Tools\\\"  # Red Hat\\nsudo apt-get install build-essential        # Debian\\nsudo ldconfig\\n```\\n\\n### mysqlclient Installation Fails\\n\\n**Error:** `EnvironmentError: mysql_config not found`\\n\\n**Solution:** Install MySQL development headers:\\n```bash\\nsudo yum install mysql-devel     # Red Hat\\nsudo apt-get install libmysqlclient-dev  # Debian\\n```\\n\\n### Django Cannot Connect to MySQL\\n\\n**Error:** `django.db.utils.OperationalError: (2002, \\\"Can't connect to local MySQL server\\\")`\\n\\n**Solution:** Verify MySQL is running and credentials in `config.ini` are correct (see [Configuration](#2.2)):\\n```bash\\nsystemctl status mysqld\\nmysql -u trader -p\\n```\\n\\n### Redis Connection Refused\\n\\n**Error:** `redis.exceptions.ConnectionError: Error 111 connecting to localhost:6379`\\n\\n**Solution:** Verify Redis is running:\\n```bash\\nsystemctl status redis\\nsudo systemctl start redis\\n```\\n\\n**Sources:** [requirements.txt:6,12,17]()\\n\\n---\\n\\n## Next Steps\\n\\nAfter completing installation:\\n\\n1. **Configure the System**: See [Configuration](#2.2) for setting up `config.ini`, CTP API credentials, and Redis channel configuration\\n2. **Run the System**: See [Running the System](#2.3) for starting the trading system and understanding the execution flow\\n3. **Verify Data Acquisition**: Test exchange data fetching as documented in [Exchange Data Acquisition](#5.2)\\n\\n**Sources:** [README.rst:1-26](), [requirements.txt:1-25]()\"])</script><script>self.__next_f.push([1,\"1a:T418d,\"])</script><script>self.__next_f.push([1,\"# Configuration\\n\\n\\u003cdetails\\u003e\\n\\u003csummary\\u003eRelevant source files\\u003c/summary\\u003e\\n\\nThe following files were used as context for generating this wiki page:\\n\\n- [panel/const.py](panel/const.py)\\n- [trader/utils/error.xml](trader/utils/error.xml)\\n- [trader/utils/read_config.py](trader/utils/read_config.py)\\n\\n\\u003c/details\\u003e\\n\\n\\n\\nThis page documents the configuration system for the trader platform, including the structure of `config.ini`, Redis and MySQL connection parameters, CTP API integration settings, and the CTP error code mapping mechanism. For information about running the configured system, see [Running the System](#2.3). For a complete reference of all configuration options, see [Configuration File Format](#7.1).\\n\\n## Overview\\n\\nThe trader system uses a centralized configuration approach with an INI-format file located at the user's config directory. Configuration is loaded at application startup by [trader/utils/read_config.py]() and made available to all components through the `config` module-level object.\\n\\n**Key Configuration Responsibilities:**\\n- Redis Pub/Sub channel patterns for CTP communication\\n- Database connection parameters (MySQL)\\n- Trading constraints and timeouts\\n- External API credentials (QuantDL, Tushare)\\n- Logging configuration\\n- CTP error code definitions\\n\\nSources: [trader/utils/read_config.py:1-79]()\\n\\n## Configuration File Location\\n\\nThe configuration file is automatically created on first run using the `appdirs` library to determine the platform-specific user config directory:\\n\\n```python\\napp_dir = AppDirs('trader')\\nconfig_file = os.path.join(app_dir.user_config_dir, 'config.ini')\\n```\\n\\n**Platform-specific locations:**\\n- **Linux**: `~/.config/trader/config.ini`\\n- **Windows**: `C:\\\\Users\\\\\\u003cusername\\u003e\\\\AppData\\\\Local\\\\trader\\\\config.ini`\\n- **macOS**: `~/Library/Application Support/trader/config.ini`\\n\\nIf the file does not exist, it is created with default values from the `config_example` template.\\n\\nSources: [trader/utils/read_config.py:62-69]()\\n\\n## Configuration File Structure\\n\\n### MSG_CHANNEL Section\\n\\nThis section defines the Redis Pub/Sub channel patterns used for communication between the trading strategy and the CTP API gateway process. These patterns implement a request-response architecture.\\n\\n```ini\\n[MSG_CHANNEL]\\nrequest_pattern = MSG:CTP:REQ:*\\nrequest_format = MSG:CTP:REQ:{}\\ntrade_response_prefix = MSG:CTP:RSP:TRADE:\\ntrade_response_format = MSG:CTP:RSP:TRADE:{}:{}\\nmarket_response_prefix = MSG:CTP:RSP:MARKET:\\nmarket_response_format = MSG:CTP:RSP:MARKET:{}:{}\\nweixin_log = MSG:LOG:WEIXIN\\n```\\n\\n**Parameter Details:**\\n\\n| Parameter | Purpose | Format Variables |\\n|-----------|---------|------------------|\\n| `request_pattern` | Pattern for subscribing to all CTP request channels | N/A (wildcard subscription) |\\n| `request_format` | Template for publishing CTP requests | `{broker_id}` |\\n| `trade_response_prefix` | Prefix for filtering trade responses | N/A |\\n| `trade_response_format` | Template for trade response channels | `{broker_id}`, `{order_ref}` |\\n| `market_response_prefix` | Prefix for filtering market data | N/A |\\n| `market_response_format` | Template for market data channels | `{broker_id}`, `{instrument_id}` |\\n| `weixin_log` | Channel for WeChat notification integration | N/A |\\n\\nSources: [trader/utils/read_config.py:24-31]()\\n\\n### TRADE Section\\n\\nControls trading behavior and constraints:\\n\\n```ini\\n[TRADE]\\ncommand_timeout = 5\\nignore_inst = WH,bb,JR,RI,RS,LR,PM,im\\n```\\n\\n**Parameter Details:**\\n\\n| Parameter | Type | Purpose |\\n|-----------|------|---------|\\n| `command_timeout` | Integer (seconds) | Maximum wait time for CTP command responses |\\n| `ignore_inst` | Comma-separated strings | Instrument codes to exclude from trading (e.g., low-liquidity contracts) |\\n\\nSources: [trader/utils/read_config.py:33-35]()\\n\\n### REDIS Section\\n\\nConnection parameters for the Redis message bus and cache:\\n\\n```ini\\n[REDIS]\\nhost = 127.0.0.1\\nport = 6379\\ndb = 0\\nencoding = utf-8\\n```\\n\\n**Parameter Details:**\\n\\n| Parameter | Type | Default | Purpose |\\n|-----------|------|---------|---------|\\n| `host` | String | 127.0.0.1 | Redis server hostname or IP address |\\n| `port` | Integer | 6379 | Redis server port |\\n| `db` | Integer | 0 | Redis database number (0-15) |\\n| `encoding` | String | utf-8 | Character encoding for Redis operations |\\n\\nSources: [trader/utils/read_config.py:37-42]()\\n\\n### MYSQL Section\\n\\nDatabase connection parameters for Django ORM:\\n\\n```ini\\n[MYSQL]\\nhost = 127.0.0.1\\nport = 3306\\ndb = QuantDB\\nuser = quant\\npassword = 123456\\n```\\n\\n**Parameter Details:**\\n\\n| Parameter | Type | Purpose |\\n|-----------|------|---------|\\n| `host` | String | MySQL server hostname or IP address |\\n| `port` | Integer | MySQL server port |\\n| `db` | String | Database name containing trader models |\\n| `user` | String | Database user with read/write privileges |\\n| `password` | String | Database user password |\\n\\n**Note:** The database must be created before running the system. Django migrations will create the necessary tables automatically.\\n\\nSources: [trader/utils/read_config.py:44-49]()\\n\\n### External API Sections\\n\\nConfiguration for external data providers:\\n\\n```ini\\n[QuantDL]\\napi_key = 123456\\n\\n[Tushare]\\ntoken = 123456\\n```\\n\\n**QuantDL**: Used for historical market data retrieval (if implemented).\\n**Tushare**: Chinese financial data API for additional market data sources.\\n\\nSources: [trader/utils/read_config.py:51-55]()\\n\\n### LOG Section\\n\\nLogging configuration for system-wide and WeChat notifications:\\n\\n```ini\\n[LOG]\\nlevel = DEBUG\\nformat = %(asctime)s %(name)s [%(levelname)s] %(message)s\\nweixin_format = [%(levelname)s] %(message)s\\n```\\n\\n**Parameter Details:**\\n\\n| Parameter | Type | Purpose |\\n|-----------|------|---------|\\n| `level` | String | Logging level: DEBUG, INFO, WARNING, ERROR, CRITICAL |\\n| `format` | String | Python logging format string for console/file logs |\\n| `weixin_format` | String | Simplified format for WeChat notifications |\\n\\nSources: [trader/utils/read_config.py:57-60]()\\n\\n## Configuration Loading Mechanism\\n\\nThe following diagram illustrates how configuration is loaded and distributed to system components:\\n\\n```mermaid\\nflowchart TD\\n    AppStart[\\\"Application Startup\\u003cbr/\\u003e(trader/main.py)\\\"]\\n    ImportConfig[\\\"Import trader.utils.read_config\\\"]\\n    \\n    CheckFile{\\\"config.ini\\u003cbr/\\u003eexists?\\\"}\\n    CreateFile[\\\"Create config.ini from\\u003cbr/\\u003econfig_example template\\\"]\\n    LoadConfig[\\\"ConfigParser reads\\u003cbr/\\u003econfig.ini\\\"]\\n    \\n    ConfigObj[\\\"config (module-level object)\\u003cbr/\\u003eConfigParser instance\\\"]\\n    \\n    LoadErrors[\\\"Load error.xml\\u003cbr/\\u003eCTP error definitions\\\"]\\n    ErrorDict[\\\"ctp_errors dictionary\\u003cbr/\\u003e{error_code: message}\\\"]\\n    \\n    subgraph \\\"Consuming Components\\\"\\n        BaseModule[\\\"BaseModule\\u003cbr/\\u003e(Redis connection)\\\"]\\n        TradeStrategy[\\\"TradeStrategy\\u003cbr/\\u003e(channel patterns)\\\"]\\n        DjangoSettings[\\\"Django settings.py\\u003cbr/\\u003e(MySQL connection)\\\"]\\n        Logger[\\\"my_logger.py\\u003cbr/\\u003e(log level \\u0026 format)\\\"]\\n    end\\n    \\n    AppStart --\\u003e ImportConfig\\n    ImportConfig --\\u003e CheckFile\\n    CheckFile --\\u003e|No| CreateFile\\n    CheckFile --\\u003e|Yes| LoadConfig\\n    CreateFile --\\u003e LoadConfig\\n    \\n    LoadConfig --\\u003e ConfigObj\\n    ImportConfig --\\u003e LoadErrors\\n    LoadErrors --\\u003e ErrorDict\\n    \\n    ConfigObj --\\u003e BaseModule\\n    ConfigObj --\\u003e TradeStrategy\\n    ConfigObj --\\u003e DjangoSettings\\n    ConfigObj --\\u003e Logger\\n    \\n    ErrorDict --\\u003e TradeStrategy\\n```\\n\\n**Loading Process:**\\n\\n1. **File Discovery**: On import, `read_config.py` uses `AppDirs` to determine the platform-specific config directory\\n2. **File Creation**: If `config.ini` doesn't exist, it's created with defaults from `config_example` ([trader/utils/read_config.py:64-69]())\\n3. **Parsing**: `ConfigParser` with `interpolation=None` reads the INI file ([trader/utils/read_config.py:71-72]())\\n4. **Error Codes**: CTP error definitions are loaded from `error.xml` into the `ctp_errors` dictionary ([trader/utils/read_config.py:74-78]())\\n5. **Distribution**: Components import the `config` object and access sections as needed\\n\\nSources: [trader/utils/read_config.py:16-79]()\\n\\n## CTP Error Code Mapping\\n\\nThe system loads CTP API error codes from `error.xml` to provide human-readable error messages. This XML file contains error definitions from the China Futures Trading Platform API.\\n\\n### Error XML Structure\\n\\n```xml\\n\\u003cerror id=\\\"NONE\\\" value=\\\"0\\\" prompt=\\\"CTP:\\\"/\\u003e\\n\\u003cerror id=\\\"INVALID_LOGIN\\\" value=\\\"3\\\" prompt=\\\"CTP:\\\"/\\u003e\\n\\u003cerror id=\\\"INSUFFICIENT_MONEY\\\" value=\\\"31\\\" prompt=\\\"CTP:\\\"/\\u003e\\n```\\n\\nEach error entry has:\\n- **id**: Symbolic name for the error\\n- **value**: Numeric error code returned by CTP API\\n- **prompt**: Human-readable Chinese message\\n\\n### Error Categories\\n\\nThe error.xml file defines several categories of errors:\\n\\n| Category | Error Code Range | Examples |\\n|----------|------------------|----------|\\n| **General CTP Errors** | 0-100 | Login failures, permissions, order rejections |\\n| **Disaster Recovery** | 101-115 | DR system-specific errors |\\n| **Password \\u0026 Auth** | 131-150 | Weak passwords, expired passwords, IP blacklist |\\n| **Bank Transfer** | 1000-1043 | Bank-futures transfer system errors |\\n| **Futures-Bank Exchange** | 2000-2070 | Currency exchange operations |\\n| **FX Exchange** | 3001-3039 | Foreign exchange operations |\\n| **Options \\u0026 Advanced** | 3041-4104 | Options hedging, quotes, SSL errors |\\n\\n### Error Code Access Pattern\\n\\nComponents access error messages through the `ctp_errors` dictionary:\\n\\n```python\\nfrom trader.utils.read_config import ctp_errors\\n\\nerror_code = 31\\nerror_message = ctp_errors.get(error_code, f\\\"Unknown error: {error_code}\\\")\\n# Returns: \\\"CTP:\\\" (Insufficient funds)\\n```\\n\\nSources: [trader/utils/read_config.py:74-78](), [trader/utils/error.xml:1-266]()\\n\\n## Configuration in System Architecture\\n\\nThe following diagram shows how configuration settings propagate through the system:\\n\\n```mermaid\\ngraph TB\\n    subgraph \\\"Configuration Layer\\\"\\n        ConfigINI[\\\"config.ini\\u003cbr/\\u003e(User config dir)\\\"]\\n        ErrorXML[\\\"error.xml\\u003cbr/\\u003e(trader/utils/)\\\"]\\n        ReadConfig[\\\"read_config.py\\u003cbr/\\u003econfig object\\u003cbr/\\u003ectp_errors dict\\\"]\\n    end\\n    \\n    subgraph \\\"MSG_CHANNEL Configuration\\\"\\n        ReqPattern[\\\"request_pattern\\u003cbr/\\u003eMSG:CTP:REQ:*\\\"]\\n        TradeRsp[\\\"trade_response_format\\u003cbr/\\u003eMSG:CTP:RSP:TRADE:{broker}:{order_ref}\\\"]\\n        MarketRsp[\\\"market_response_format\\u003cbr/\\u003eMSG:CTP:RSP:MARKET:{broker}:{inst}\\\"]\\n        WeixinLog[\\\"weixin_log\\u003cbr/\\u003eMSG:LOG:WEIXIN\\\"]\\n    end\\n    \\n    subgraph \\\"Infrastructure Configuration\\\"\\n        RedisConn[\\\"REDIS Section\\u003cbr/\\u003ehost, port, db\\\"]\\n        MySQLConn[\\\"MYSQL Section\\u003cbr/\\u003ehost, port, db, user, password\\\"]\\n    end\\n    \\n    subgraph \\\"Trading Configuration\\\"\\n        TradeParams[\\\"TRADE Section\\u003cbr/\\u003ecommand_timeout\\u003cbr/\\u003eignore_inst\\\"]\\n        LogConfig[\\\"LOG Section\\u003cbr/\\u003elevel, format\\\"]\\n    end\\n    \\n    subgraph \\\"Core Components\\\"\\n        BaseModuleClass[\\\"BaseModule.__init__()\\u003cbr/\\u003eRedis connection pool\\\"]\\n        TradeStrategyClass[\\\"TradeStrategy\\u003cbr/\\u003eChannel subscriptions\\u003cbr/\\u003eOrder execution\\\"]\\n        DjangoORM[\\\"Django ORM\\u003cbr/\\u003eDatabase models\\\"]\\n        LoggerModule[\\\"my_logger.py\\u003cbr/\\u003eLogging setup\\\"]\\n    end\\n    \\n    ConfigINI --\\u003e ReadConfig\\n    ErrorXML --\\u003e ReadConfig\\n    \\n    ReadConfig --\\u003e ReqPattern\\n    ReadConfig --\\u003e TradeRsp\\n    ReadConfig --\\u003e MarketRsp\\n    ReadConfig --\\u003e WeixinLog\\n    ReadConfig --\\u003e RedisConn\\n    ReadConfig --\\u003e MySQLConn\\n    ReadConfig --\\u003e TradeParams\\n    ReadConfig --\\u003e LogConfig\\n    \\n    ReqPattern --\\u003e BaseModuleClass\\n    TradeRsp --\\u003e TradeStrategyClass\\n    MarketRsp --\\u003e TradeStrategyClass\\n    WeixinLog --\\u003e LoggerModule\\n    \\n    RedisConn --\\u003e BaseModuleClass\\n    MySQLConn --\\u003e DjangoORM\\n    TradeParams --\\u003e TradeStrategyClass\\n    LogConfig --\\u003e LoggerModule\\n    \\n    BaseModuleClass --\\u003e TradeStrategyClass\\n```\\n\\n**Configuration Flow:**\\n\\n1. **MSG_CHANNEL** settings define Redis Pub/Sub channel patterns used by `BaseModule` for subscribing and `TradeStrategy` for publishing\\n2. **REDIS** parameters establish the connection pool in `BaseModule.__init__()`\\n3. **MYSQL** settings configure Django's database backend (typically in Django settings)\\n4. **TRADE** parameters control `TradeStrategy` behavior (timeouts, instrument filters)\\n5. **LOG** settings initialize the logging system across all components\\n\\nSources: [trader/utils/read_config.py:23-60]()\\n\\n## Constants and Enumerations\\n\\nWhile not stored in `config.ini`, the `panel/const.py` file defines system-wide constants that are integral to configuration-dependent behavior. These enumerations ensure type safety and consistency across the codebase.\\n\\n### Core Enumerations\\n\\n```python\\n# Contract and Exchange Types\\nclass ContractType(DjangoChoices):\\n    STOCK = C(label='')\\n    FUTURE = C(label='')\\n    OPTION = C(label='')\\n\\nclass ExchangeType(DjangoChoices):\\n    SHFE = C(value='SHFE', label='')\\n    DCE = C(value='DCE', label='')\\n    CZCE = C(value='CZCE', label='')\\n    CFFEX = C(value='CFFEX', label='')\\n    INE = C(value='INE', label='')\\n    GFEX = C(value='GFEX', label='')\\n```\\n\\n### CTP Order Enumerations\\n\\n```python\\n# Direction and Position Operations\\nclass DirectionType(DjangoChoices):\\n    LONG = C(label='', value=b'0'[0])\\n    SHORT = C(label='', value=b'1'[0])\\n\\nclass OffsetFlag(DjangoChoices):\\n    Open = C(label='', value=b'0'[0])\\n    Close = C(label='', value=b'1'[0])\\n    CloseToday = C(label='', value=b'3'[0])\\n    CloseYesterday = C(label='', value=b'4'[0])\\n\\nclass OrderStatus(DjangoChoices):\\n    AllTraded = C(value=b'0'[0], label='')\\n    PartTradedQueueing = C(value=b'1'[0], label='')\\n    NoTradeQueueing = C(value=b'3'[0], label='')\\n    Canceled = C(value=b'5'[0], label='')\\n```\\n\\n### Trading Signal Types\\n\\n```python\\nclass SignalType(DjangoChoices):\\n    ROLL_CLOSE = C(label='')\\n    ROLL_OPEN = C(label='')\\n    BUY = C(label='')\\n    SELL_SHORT = C(label='')\\n    SELL = C(label='')\\n    BUY_COVER = C(label='')\\n```\\n\\nThese constants map directly to CTP API values and are used throughout the system for order construction, signal generation, and status tracking.\\n\\nSources: [panel/const.py:19-178]()\\n\\n## Configuration Access Patterns\\n\\n### Accessing Configuration Values\\n\\nComponents access configuration through the module-level `config` object:\\n\\n```python\\nfrom trader.utils.read_config import config\\n\\n# Access Redis settings\\nredis_host = config.get('REDIS', 'host')\\nredis_port = config.getint('REDIS', 'port')\\nredis_db = config.getint('REDIS', 'db')\\n\\n# Access message channel patterns\\nrequest_format = config.get('MSG_CHANNEL', 'request_format')\\ntrade_response_prefix = config.get('MSG_CHANNEL', 'trade_response_prefix')\\n\\n# Access trading parameters\\ncommand_timeout = config.getint('TRADE', 'command_timeout')\\nignore_instruments = config.get('TRADE', 'ignore_inst').split(',')\\n```\\n\\n### Type-Safe Access Methods\\n\\n`ConfigParser` provides type-specific methods:\\n- `get(section, key)`  Returns string\\n- `getint(section, key)`  Returns integer\\n- `getfloat(section, key)`  Returns float\\n- `getboolean(section, key)`  Returns boolean\\n\\nSources: [trader/utils/read_config.py:71-72]()\\n\\n## Best Practices\\n\\n### Security Considerations\\n\\n1. **Password Storage**: MySQL passwords are stored in plain text in `config.ini`. Ensure file permissions restrict access:\\n   ```bash\\n   chmod 600 ~/.config/trader/config.ini\\n   ```\\n\\n2. **API Keys**: Store QuantDL and Tushare tokens securely. Never commit `config.ini` to version control.\\n\\n3. **Redis Access**: If Redis is accessible over the network, use Redis AUTH or configure firewall rules.\\n\\n### Production Configuration\\n\\nFor production deployments:\\n\\n1. **Logging Level**: Set `level = INFO` or `WARNING` to reduce log volume\\n2. **Command Timeout**: Increase `command_timeout` if experiencing network latency\\n3. **Instrument Filters**: Populate `ignore_inst` with illiquid contracts to avoid execution issues\\n4. **Database Pooling**: Consider connection pooling for high-frequency strategies\\n\\n### Configuration Validation\\n\\nThe system does not perform automatic validation of configuration values. Invalid settings may cause runtime errors:\\n\\n- **Missing sections**: Will raise `configparser.NoSectionError`\\n- **Invalid types**: Will raise `ValueError` (e.g., non-integer for port)\\n- **Invalid Redis/MySQL parameters**: Will cause connection failures at runtime\\n\\nSources: [trader/utils/read_config.py:71-72]()\\n\\n## Related Configuration\\n\\n- For complete configuration reference, see [Configuration File Format](#7.1)\\n- For constants used in trading logic, see [Constants and Enumerations](#7.2)\\n- For CTP API integration details, see [CTP API Integration](#6)\\n- For Redis message patterns, see [Message Bus and Communication](#3.3)\\n\\nSources: [trader/utils/read_config.py:1-79](), [panel/const.py:1-178](), [trader/utils/error.xml:1-266]()\"])</script><script>self.__next_f.push([1,\"1b:T41e2,\"])</script><script>self.__next_f.push([1,\"# Running the System\\n\\n\\u003cdetails\\u003e\\n\\u003csummary\\u003eRelevant source files\\u003c/summary\\u003e\\n\\nThe following files were used as context for generating this wiki page:\\n\\n- [trader/main.py](trader/main.py)\\n- [trader/strategy/brother2.py](trader/strategy/brother2.py)\\n- [trader/utils/my_logger.py](trader/utils/my_logger.py)\\n\\n\\u003c/details\\u003e\\n\\n\\n\\nThis page explains how to start the trading system, understand its execution flow, and monitor its operation. It covers the startup sequence, scheduled task execution, and system monitoring. For information about installing dependencies, see [Installation](#2.1). For information about configuring the system before first run, see [Configuration](#2.2).\\n\\n## Starting the Trading System\\n\\nThe system is started by executing the main entry point script:\\n\\n```bash\\npython trader/main.py\\n```\\n\\nThis command initializes the entire trading system, including Django ORM, logging infrastructure, and the core `TradeStrategy` engine.\\n\\n### Entry Point Structure\\n\\nThe [trader/main.py](trader/main.py:1-78)() file performs the following initialization steps:\\n\\n| Step | Action | Code Reference |\\n|------|--------|----------------|\\n| 1 | Set up Python path for Django dashboard | [trader/main.py:19-24]() |\\n| 2 | Configure Django environment | [trader/main.py:25-27]() |\\n| 3 | Initialize logging handlers | [trader/main.py:49-65]() |\\n| 4 | Create PID file | [trader/main.py:67-72]() |\\n| 5 | Launch TradeStrategy instance | [trader/main.py:77]() |\\n\\nThe system uses a three-tier logging architecture:\\n\\n```mermaid\\ngraph TB\\n    Logger[\\\"Python Logger\\\"]\\n    \\n    subgraph \\\"Logging Handlers\\\"\\n        FileHandler[\\\"RotatingFileHandler\\u003cbr/\\u003etrader.log\\u003cbr/\\u003eMax 1MB, 1 backup\\\"]\\n        ConsoleHandler[\\\"StreamHandler\\u003cbr/\\u003eConsole output\\u003cbr/\\u003eDEBUG level\\\"]\\n        RedisHandler[\\\"RedislHandler\\u003cbr/\\u003eWeChat notifications\\u003cbr/\\u003eINFO level\\\"]\\n    end\\n    \\n    LogFile[\\\"Log File\\u003cbr/\\u003euser_log_dir/trader.log\\\"]\\n    Console[\\\"Terminal Output\\\"]\\n    RedisChannel[\\\"Redis Channel\\u003cbr/\\u003eMSG:LOG:WEIXIN\\\"]\\n    WeChatService[\\\"WeChat Notification Service\\\"]\\n    \\n    Logger --\\u003e FileHandler\\n    Logger --\\u003e ConsoleHandler\\n    Logger --\\u003e RedisHandler\\n    \\n    FileHandler --\\u003e LogFile\\n    ConsoleHandler --\\u003e Console\\n    RedisHandler --\\u003e RedisChannel\\n    RedisChannel --\\u003e WeChatService\\n```\\n\\n**Sources:** [trader/main.py:35-65]()\\n\\n### TradeStrategy Initialization\\n\\nThe system creates a `TradeStrategy` instance with the strategy name '2.2':\\n\\n```python\\nTradeStrategy(name='2.2').run()\\n```\\n\\nThis name must match a `Strategy` object in the database, which links to:\\n- A `Broker` (account credentials and state)\\n- A collection of `Instrument` objects (tradable products)\\n- Strategy parameters (BreakPeriod, AtrPeriod, Risk, etc.)\\n\\n**Sources:** [trader/main.py:77](), [trader/strategy/brother2.py:38-46]()\\n\\n## Startup Sequence\\n\\nWhen `TradeStrategy.start()` is invoked, the system performs several initialization and cleanup operations:\\n\\n```mermaid\\nsequenceDiagram\\n    participant Main as main.py\\n    participant TS as TradeStrategy\\n    participant Redis as Redis\\n    participant CTP as CTP API\\n    participant DB as Django ORM\\n    \\n    Main-\\u003e\\u003eTS: TradeStrategy(name='2.2')\\n    activate TS\\n    TS-\\u003e\\u003eTS: Load strategy from DB\\n    TS-\\u003e\\u003eTS: Load broker configuration\\n    TS-\\u003e\\u003eTS: Initialize instance variables\\n    \\n    Main-\\u003e\\u003eTS: run()\\n    TS-\\u003e\\u003eTS: start()\\n    \\n    TS-\\u003e\\u003eTS: install() - Register callbacks\\n    Note over TS: Registers @RegisterCallback\\u003cbr/\\u003edecorated methods\\n    \\n    TS-\\u003e\\u003eRedis: SET HEARTBEAT:TRADER 1 EX 61\\n    Note over Redis: Heartbeat expires after 61s\\u003cbr/\\u003eif not renewed\\n    \\n    alt Trading Hours (820-1550 or 2010-2359)\\n        TS-\\u003e\\u003eTS: refresh_account()\\n        TS-\\u003e\\u003eCTP: Query TradingAccount\\n        CTP--\\u003e\\u003eTS: Balance, margin, cash data\\n        TS-\\u003e\\u003eDB: Update Broker model\\n        \\n        TS-\\u003e\\u003eCTP: Query Order\\n        CTP--\\u003e\\u003eTS: Outstanding orders\\n        \\n        loop For each unfilled order\\n            TS-\\u003e\\u003eCTP: Cancel order (ReqOrderAction)\\n            TS-\\u003e\\u003eDB: Log cancellation\\n        end\\n        \\n        loop For each filled order\\n            TS-\\u003e\\u003eDB: save_order()\\n        end\\n        \\n        TS-\\u003e\\u003eTS: refresh_position()\\n        TS-\\u003e\\u003eCTP: Query InvestorPositionDetail\\n        CTP--\\u003e\\u003eTS: Position details\\n        TS-\\u003e\\u003eDB: Update Trade records\\n    end\\n    \\n    deactivate TS\\n```\\n\\n### Startup Logic Details\\n\\nThe [trader/strategy/brother2.py:64-84]() `start()` method:\\n\\n1. **Registers Callbacks**: Calls `install()` to register all methods decorated with `@RegisterCallback`\\n2. **Sets Heartbeat**: Writes `HEARTBEAT:TRADER` key to Redis with 61-second expiration\\n3. **Checks Trading Hours**: Validates current time is during active trading sessions\\n4. **Account Refresh**: Queries CTP for current account balance, margin, and cash\\n5. **Order Cleanup**: Cancels any outstanding orders from previous sessions\\n6. **Position Sync**: Queries CTP for current positions and updates database\\n\\n**Important Notes:**\\n- The system only queries CTP during trading hours (weekdays 8:20-15:50 or 20:10-23:59)\\n- Outstanding orders are automatically cancelled to prevent stale orders from executing\\n- The heartbeat mechanism allows external monitoring to detect if the process has died\\n\\n**Sources:** [trader/strategy/brother2.py:64-84](), [trader/strategy/brother2.py:86-112](), [trader/strategy/brother2.py:114-154]()\\n\\n## Daily Execution Flow\\n\\nThe `TradeStrategy` class uses cron-based scheduling to execute tasks at specific times throughout the trading day. These tasks are registered using the `@RegisterCallback(crontab='...')` decorator.\\n\\n### Trading Day Schedule\\n\\n```mermaid\\ngantt\\n    title Daily Trading System Schedule\\n    dateFormat HH:mm\\n    axisFormat %H:%M\\n    \\n    section Pre-Market\\n    Processing Signal 1 (Day)      :08:55, 5m\\n    Check Signal 1                 :09:01, 1m\\n    Processing Signal 2 (CFFEX)    :09:25, 5m\\n    Check Signal 2                 :09:31, 1m\\n    \\n    section Day Trading\\n    Day Session                    :09:00, 150m\\n    \\n    section Post-Market\\n    Refresh All Data               :15:20, 10m\\n    Update Equity                  :15:30, 5m\\n    Collect Quote \\u0026 Calculate      :17:00, 30m\\n    \\n    section Night Pre-Market\\n    Processing Signal 3 (Night)    :20:55, 5m\\n    Check Signal 3                 :21:01, 1m\\n    \\n    section Night Trading\\n    Night Session                  :21:00, 150m\\n```\\n\\n### Scheduled Task Reference\\n\\n| Time | Function | Purpose | Code Reference |\\n|------|----------|---------|----------------|\\n| Every minute | `heartbeat()` | Renew Redis heartbeat key | [trader/strategy/brother2.py:568-570]() |\\n| 08:55 | `processing_signal1()` | Process day session signals (non-CFFEX) | [trader/strategy/brother2.py:572-585]() |\\n| 09:01 | `check_signal1_processed()` | Verify day signals were processed | [trader/strategy/brother2.py:587-596]() |\\n| 09:25 | `processing_signal2()` | Process CFFEX (stock index) signals | [trader/strategy/brother2.py:598-608]() |\\n| 09:31 | `check_signal2_processed()` | Verify CFFEX signals were processed | [trader/strategy/brother2.py:610-619]() |\\n| 15:20 | `refresh_all()` | Update account, positions, instruments | [trader/strategy/brother2.py:644-654]() |\\n| 15:30 | `update_equity()` | Calculate daily NAV and performance | [trader/strategy/brother2.py:656-682]() |\\n| 17:00 | `collect_quote()` | Fetch exchange data and calculate signals | [trader/strategy/brother2.py:684-703]() |\\n| 20:55 | `processing_signal3()` | Process night session signals | [trader/strategy/brother2.py:621-631]() |\\n| 21:01 | `check_signal3_processed()` | Verify night signals were processed | [trader/strategy/brother2.py:633-642]() |\\n\\n**Sources:** [trader/strategy/brother2.py:568-703]()\\n\\n### Signal Processing Flow\\n\\nThe system processes trading signals in three windows corresponding to different market sessions:\\n\\n```mermaid\\nflowchart TD\\n    Start[\\\"Scheduled Time Trigger\\\"]\\n    CheckTrading{\\\"is_trading_day()\\\"}\\n    QuerySignals[\\\"Query Signal.objects.filter(\\u003cbr/\\u003eprocessed=False)\\\"]\\n    \\n    subgraph \\\"For Each Signal\\\"\\n        LoadSignal[\\\"Load Signal from DB\\\"]\\n        ReqOrderInsert[\\\"ReqOrderInsert(signal)\\\"]\\n        PublishRedis[\\\"Publish to Redis\\u003cbr/\\u003eMSG:CTP:REQ:ReqOrderInsert\\\"]\\n        \\n        CTPResponse[\\\"CTP API Processes Order\\\"]\\n        OnRtnOrder[\\\"OnRtnOrder callback\\u003cbr/\\u003eOrder status update\\\"]\\n        SaveOrder[\\\"save_order()\\u003cbr/\\u003eCreate Order record\\\"]\\n        \\n        OnRtnTrade[\\\"OnRtnTrade callback\\u003cbr/\\u003eTrade execution\\\"]\\n        UpdateTrade[\\\"Update Trade record\\u003cbr/\\u003eCalculate P\\u0026L\\\"]\\n        MarkProcessed[\\\"signal.processed = True\\\"]\\n    end\\n    \\n    Start --\\u003e CheckTrading\\n    CheckTrading --\\u003e|False| End[\\\"Skip - Not Trading Day\\\"]\\n    CheckTrading --\\u003e|True| QuerySignals\\n    QuerySignals --\\u003e LoadSignal\\n    LoadSignal --\\u003e ReqOrderInsert\\n    ReqOrderInsert --\\u003e PublishRedis\\n    PublishRedis --\\u003e CTPResponse\\n    CTPResponse --\\u003e OnRtnOrder\\n    OnRtnOrder --\\u003e SaveOrder\\n    SaveOrder --\\u003e OnRtnTrade\\n    OnRtnTrade --\\u003e UpdateTrade\\n    UpdateTrade --\\u003e MarkProcessed\\n    MarkProcessed --\\u003e End\\n```\\n\\n**Processing Windows:**\\n\\n1. **08:55 - Day Session (processing_signal1)**: Processes signals for commodities with day-only trading (excludes CFFEX)\\n2. **09:25 - CFFEX Session (processing_signal2)**: Processes signals for stock index futures and treasury bond futures\\n3. **20:55 - Night Session (processing_signal3)**: Processes signals for commodities with night trading\\n\\nEach processing window:\\n- Checks if the current day is a trading day\\n- Queries unprocessed signals from the database\\n- Sends order requests to CTP API via Redis\\n- Waits for asynchronous callbacks to confirm execution\\n\\n**Sources:** [trader/strategy/brother2.py:572-642](), [trader/strategy/brother2.py:301-343](), [trader/strategy/brother2.py:391-469](), [trader/strategy/brother2.py:510-566]()\\n\\n### Evening Calculation Workflow\\n\\nAt 17:00, the system performs post-market analysis:\\n\\n```mermaid\\nflowchart LR\\n    Trigger[\\\"17:00 Cron Trigger\\\"]\\n    \\n    subgraph \\\"Data Collection\\\"\\n        SHFE[\\\"update_from_shfe()\\\"]\\n        DCE[\\\"update_from_dce()\\\"]\\n        CZCE[\\\"update_from_czce()\\\"]\\n        CFFEX[\\\"update_from_cffex()\\\"]\\n        GFEX[\\\"update_from_gfex()\\\"]\\n        Contracts[\\\"get_contracts_argument()\\\"]\\n    end\\n    \\n    subgraph \\\"Signal Calculation\\\"\\n        CalcMain[\\\"calc_main_inst()\\u003cbr/\\u003eIdentify main contracts\\\"]\\n        CalcSignal[\\\"calc_signal()\\u003cbr/\\u003eGenerate trading signals\\\"]\\n        \\n        subgraph \\\"Technical Analysis\\\"\\n            LoadBars[\\\"Load MainBar history\\\"]\\n            CalcATR[\\\"Calculate ATR\\\"]\\n            CalcSMA[\\\"Calculate SMA trends\\\"]\\n            CalcBreakout[\\\"Calculate breakout levels\\\"]\\n        end\\n        \\n        CheckPosition{\\\"Existing\\u003cbr/\\u003ePosition?\\\"}\\n        StopLoss[\\\"Check stop-loss conditions\\\"]\\n        Rollover[\\\"Check rollover needs\\\"]\\n        NewSignal[\\\"Generate open signals\\\"]\\n        \\n        SaveSignal[\\\"Save Signal to DB\\\"]\\n    end\\n    \\n    Trigger --\\u003e SHFE \\u0026 DCE \\u0026 CZCE \\u0026 CFFEX \\u0026 GFEX \\u0026 Contracts\\n    SHFE \\u0026 DCE \\u0026 CZCE \\u0026 CFFEX \\u0026 GFEX \\u0026 Contracts --\\u003e CalcMain\\n    CalcMain --\\u003e CalcSignal\\n    \\n    CalcSignal --\\u003e LoadBars\\n    LoadBars --\\u003e CalcATR\\n    CalcATR --\\u003e CalcSMA\\n    CalcSMA --\\u003e CalcBreakout\\n    CalcBreakout --\\u003e CheckPosition\\n    \\n    CheckPosition --\\u003e|Yes| StopLoss\\n    CheckPosition --\\u003e|Yes| Rollover\\n    CheckPosition --\\u003e|No| NewSignal\\n    \\n    StopLoss --\\u003e SaveSignal\\n    Rollover --\\u003e SaveSignal\\n    NewSignal --\\u003e SaveSignal\\n```\\n\\nThe `collect_quote()` method orchestrates asynchronous data fetching from all five exchanges, then triggers the `calculate()` method which:\\n\\n1. **Generates Main Contracts**: Calls `calc_main_inst()` to identify the most liquid contract for each product\\n2. **Calculates Signals**: For each instrument, calls `calc_signal()` to analyze technical indicators\\n3. **Evaluates Positions**: Checks existing positions for stop-loss and rollover conditions\\n4. **Generates New Signals**: Creates BUY/SELL_SHORT signals when breakout conditions are met\\n\\n**Sources:** [trader/strategy/brother2.py:684-723](), [trader/strategy/brother2.py:725-870]()\\n\\n## Monitoring the System\\n\\n### Log Files\\n\\nThe system maintains rotating log files in the user log directory:\\n\\n| Log Type | Location | Description |\\n|----------|----------|-------------|\\n| Main Log | `{user_log_dir}/trader.log` | All system activity (max 1MB, 1 backup) |\\n| Format | Configured in `config.ini` | Timestamp, logger name, level, message |\\n\\nExample log format:\\n```\\n2024-01-15 08:55:23,456 CTPApi [INFO] ..\\n2024-01-15 08:55:24,789 CTPApi [INFO] : rb BUY 2 : 3850.0\\n2024-01-15 09:00:15,234 CTPApi [INFO] : SHFE.rb2405 2 :3848.0\\n```\\n\\n**Sources:** [trader/main.py:49-53]()\\n\\n### Redis Heartbeat Monitoring\\n\\nThe system publishes a heartbeat key to Redis every minute:\\n\\n```\\nKey: HEARTBEAT:TRADER\\nValue: 1\\nTTL: 301 seconds\\n```\\n\\nExternal monitoring tools can check this key to verify the system is running:\\n\\n```bash\\n# Check if system is alive\\nredis-cli GET HEARTBEAT:TRADER\\n\\n# Monitor heartbeat expiration\\nredis-cli TTL HEARTBEAT:TRADER\\n```\\n\\nIf the heartbeat key expires, the trading system has stopped or crashed.\\n\\n**Sources:** [trader/strategy/brother2.py:66](), [trader/strategy/brother2.py:568-570]()\\n\\n### PID File\\n\\nThe system creates a PID file on startup:\\n\\n```\\nLocation: {user_cache_dir}/trader.pid\\nContents: Process ID (integer)\\n```\\n\\nThis file can be used to:\\n- Check if the system is running\\n- Send signals to the process\\n- Prevent multiple instances from running\\n\\n```bash\\n# Check if process is running\\ncat /path/to/trader.pid\\nps -p $(cat /path/to/trader.pid)\\n\\n# Send SIGTERM to gracefully stop\\nkill $(cat /path/to/trader.pid)\\n```\\n\\n**Sources:** [trader/main.py:67-72]()\\n\\n### WeChat Notifications\\n\\nThe system sends high-priority log messages to WeChat via Redis:\\n\\n```mermaid\\ngraph LR\\n    Logger[\\\"Python Logger\\u003cbr/\\u003eINFO level and above\\\"]\\n    RedisHandler[\\\"RedislHandler\\\"]\\n    RedisChannel[\\\"Redis Channel\\u003cbr/\\u003eMSG:LOG:WEIXIN\\\"]\\n    WeChatService[\\\"WeChat Service\\u003cbr/\\u003e(External)\\\"]\\n    Mobile[\\\"Mobile Notification\\\"]\\n    \\n    Logger --\\u003e RedisHandler\\n    RedisHandler --\\u003e RedisChannel\\n    RedisChannel --\\u003e WeChatService\\n    WeChatService --\\u003e Mobile\\n```\\n\\nImportant events sent to WeChat include:\\n- New signals generated\\n- Orders executed\\n- Stop-loss triggers\\n- System errors and warnings\\n- Daily performance updates\\n\\n**Sources:** [trader/main.py:58-60]()\\n\\n### Real-Time Market Data\\n\\nThe system subscribes to market data updates via Redis channels:\\n\\n```\\nChannel Pattern: MSG:CTP:RSP:MARKET:OnRtnDepthMarketData:*\\n```\\n\\nThe `OnRtnDepthMarketData` callback receives tick updates for subscribed instruments:\\n\\n```python\\n@RegisterCallback(channel='MSG:CTP:RSP:MARKET:OnRtnDepthMarketData:*')\\nasync def OnRtnDepthMarketData(self, channel, tick: dict):\\n    # Process real-time tick data\\n    inst = channel.split(':')[-1]\\n    tick['UpdateTime'] = datetime.datetime.strptime(tick['UpdateTime'], \\\"%Y%m%d %H:%M:%S:%f\\\")\\n```\\n\\n**Sources:** [trader/strategy/brother2.py:373-380]()\\n\\n## Stopping the System\\n\\n### Graceful Shutdown\\n\\nTo stop the trading system gracefully:\\n\\n1. **Send SIGTERM signal**:\\n   ```bash\\n   kill $(cat /path/to/trader.pid)\\n   ```\\n\\n2. **Wait for cleanup**: The system should:\\n   - Cancel any outstanding orders (if during trading hours)\\n   - Save current state to database\\n   - Close Redis connections\\n   - Flush log buffers\\n\\n### Force Stop\\n\\nIf the system is unresponsive:\\n\\n```bash\\nkill -9 $(cat /path/to/trader.pid)\\n```\\n\\n**Warning**: Force stopping may leave orders active in the market. Always verify order status after a forced stop.\\n\\n### Post-Shutdown Verification\\n\\nAfter stopping the system, verify:\\n\\n1. **No active orders**: Check CTP API or database for unfilled orders\\n2. **Heartbeat expired**: `redis-cli GET HEARTBEAT:TRADER` should return null\\n3. **Process terminated**: `ps -p $(cat /path/to/trader.pid)` should show no process\\n\\n### Emergency Scenarios\\n\\nIn case of system issues during trading hours:\\n\\n1. **Critical Bug**: Force stop the system and manually close positions via trading platform\\n2. **Network Outage**: System will attempt to reconnect; monitor logs for connectivity\\n3. **Exchange Halt**: System will skip signal processing but continue monitoring\\n4. **Data Source Failure**: The `collect_quote()` method retries failed tasks after 10 minutes\\n\\n**Sources:** [trader/strategy/brother2.py:684-703]()\\n\\n## System State on Restart\\n\\nWhen restarting the system:\\n\\n1. **Position Sync**: The `start()` method queries CTP for current positions and updates the database\\n2. **Order Cleanup**: Outstanding orders are cancelled automatically\\n3. **Signal State**: Unprocessed signals remain in the database and will be executed in the next processing window\\n4. **Performance Continuity**: Daily performance records are maintained across restarts\\n\\nThe system is designed to be restart-safe during non-trading hours. Restarting during trading hours will cause a brief interruption in order processing.\\n\\n**Sources:** [trader/strategy/brother2.py:64-84]()\"])</script><script>self.__next_f.push([1,\"1c:T48ef,\"])</script><script>self.__next_f.push([1,\"# Architecture\\n\\n\\u003cdetails\\u003e\\n\\u003csummary\\u003eRelevant source files\\u003c/summary\\u003e\\n\\nThe following files were used as context for generating this wiki page:\\n\\n- [panel/models.py](panel/models.py)\\n- [trader/strategy/__init__.py](trader/strategy/__init__.py)\\n- [trader/strategy/brother2.py](trader/strategy/brother2.py)\\n- [trader/utils/__init__.py](trader/utils/__init__.py)\\n\\n\\u003c/details\\u003e\\n\\n\\n\\nThis document provides a high-level overview of the trader system architecture, describing the major components and how they interact. It focuses on the structural organization and communication patterns that enable automated futures trading on Chinese commodity exchanges.\\n\\nFor detailed information about specific components, see [System Components](#3.1). For data processing workflows, see [Data Flow Pipeline](#3.2). For Redis communication patterns, see [Message Bus and Communication](#3.3).\\n\\n## Overview\\n\\nThe trader system follows a **message-driven, event-oriented architecture** with clear separation between data acquisition, strategy execution, and order management. The system is built on five major layers that work together to provide automated trading capabilities:\\n\\n```mermaid\\ngraph TB\\n    subgraph \\\"Layer 1: External Systems\\\"\\n        Exchanges[\\\"Five Exchanges\\u003cbr/\\u003eSHFE, DCE, CZCE, CFFEX, GFEX\\\"]\\n        CTP[\\\"CTP API\\u003cbr/\\u003eOrder Execution Gateway\\\"]\\n    end\\n    \\n    subgraph \\\"Layer 2: Data Acquisition\\\"\\n        FetchData[\\\"trader.utils.fetch_data\\u003cbr/\\u003eorchestration\\\"]\\n        UpdateFuncs[\\\"update_from_shfe()\\u003cbr/\\u003eupdate_from_dce()\\u003cbr/\\u003eupdate_from_czce()\\u003cbr/\\u003eupdate_from_cffex()\\u003cbr/\\u003eupdate_from_gfex()\\\"]\\n    end\\n    \\n    subgraph \\\"Layer 3: Core Trading System\\\"\\n        TradeStrategy[\\\"TradeStrategy\\u003cbr/\\u003etrader.strategy.brother2\\\"]\\n        BaseModule[\\\"BaseModule\\u003cbr/\\u003etrader.strategy.__init__\\\"]\\n    end\\n    \\n    subgraph \\\"Layer 4: Message Bus\\\"\\n        Redis[\\\"Redis Pub/Sub\\u003cbr/\\u003eMSG:CTP:REQ:*\\u003cbr/\\u003eMSG:CTP:RSP:TRADE:*\\u003cbr/\\u003eMSG:CTP:RSP:MARKET:*\\\"]\\n    end\\n    \\n    subgraph \\\"Layer 5: Data Persistence\\\"\\n        Django[\\\"Django ORM\\\"]\\n        Models[\\\"panel.models\\u003cbr/\\u003eBroker, Strategy, Instrument\\u003cbr/\\u003eSignal, Order, Trade\\u003cbr/\\u003eDailyBar, MainBar, Performance\\\"]\\n        MySQL[\\\"MySQL Database\\\"]\\n    end\\n    \\n    Exchanges --\\u003e|\\\"HTTP/JSON/XML\\\"| UpdateFuncs\\n    UpdateFuncs --\\u003e|\\\"Daily OHLC data\\\"| Django\\n    \\n    BaseModule -.-\\u003e|\\\"extends\\\"| TradeStrategy\\n    TradeStrategy \\u003c--\\u003e|\\\"pub/sub\\\"| Redis\\n    Redis \\u003c--\\u003e|\\\"API commands\\\"| CTP\\n    \\n    TradeStrategy --\\u003e Django\\n    Django --\\u003e Models\\n    Models --\\u003e MySQL\\n    \\n    FetchData --\\u003e|\\\"async gather\\\"| UpdateFuncs\\n```\\n\\n**Sources:** [trader/strategy/brother2.py:1-38](), [trader/strategy/__init__.py:36-57](), [trader/utils/__init__.py:121-349](), [panel/models.py:1-289]()\\n\\n## Architectural Principles\\n\\nThe system design follows these core principles:\\n\\n| Principle | Implementation | Benefit |\\n|-----------|---------------|---------|\\n| **Asynchronous I/O** | `asyncio` event loops throughout | Non-blocking operations for data fetching and order execution |\\n| **Message-Driven** | Redis Pub/Sub channels for all CTP communication | Decouples strategy logic from API implementation |\\n| **Event-Oriented** | `@RegisterCallback` decorator with cron and channel triggers | Declarative scheduling and event handling |\\n| **Separation of Concerns** | Distinct layers for data, strategy, and execution | Independent testing and maintenance |\\n| **Data Persistence** | Django ORM abstraction | Database-agnostic design with migration support |\\n\\n**Sources:** [trader/strategy/__init__.py:36-140](), [trader/utils/func_container.py]()\\n\\n## Layer 1: External Systems Integration\\n\\nThe system integrates with five Chinese commodity exchanges and the CTP trading platform:\\n\\n```mermaid\\ngraph LR\\n    subgraph \\\"Exchange APIs\\\"\\n        SHFE[\\\"SHFE\\u003cbr/\\u003ewww.shfe.com.cn\\u003cbr/\\u003eJSON format\\\"]\\n        DCE[\\\"DCE\\u003cbr/\\u003ewww.dce.com.cn\\u003cbr/\\u003eTXT format\\\"]\\n        CZCE[\\\"CZCE\\u003cbr/\\u003ewww.czce.com.cn\\u003cbr/\\u003eTXT format\\\"]\\n        CFFEX[\\\"CFFEX\\u003cbr/\\u003ewww.cffex.com.cn\\u003cbr/\\u003eXML format\\\"]\\n        GFEX[\\\"GFEX\\u003cbr/\\u003ewww.gfex.com.cn\\u003cbr/\\u003eJSON format\\\"]\\n    end\\n    \\n    subgraph \\\"Acquisition Layer\\\"\\n        UpdateSHFE[\\\"update_from_shfe()\\\"]\\n        UpdateDCE[\\\"update_from_dce()\\\"]\\n        UpdateCZCE[\\\"update_from_czce()\\\"]\\n        UpdateCFFEX[\\\"update_from_cffex()\\\"]\\n        UpdateGFEX[\\\"update_from_gfex()\\\"]\\n    end\\n    \\n    subgraph \\\"Storage\\\"\\n        DailyBar[\\\"DailyBar model\\u003cbr/\\u003epanel.models:216-234\\\"]\\n    end\\n    \\n    SHFE --\\u003e|\\\"HTTP GET\\\"| UpdateSHFE\\n    DCE --\\u003e|\\\"HTTP POST\\\"| UpdateDCE\\n    CZCE --\\u003e|\\\"HTTP GET\\\"| UpdateCZCE\\n    CFFEX --\\u003e|\\\"HTTP GET\\\"| UpdateCFFEX\\n    GFEX --\\u003e|\\\"HTTP POST\\\"| UpdateGFEX\\n    \\n    UpdateSHFE --\\u003e DailyBar\\n    UpdateDCE --\\u003e DailyBar\\n    UpdateCZCE --\\u003e DailyBar\\n    UpdateCFFEX --\\u003e DailyBar\\n    UpdateGFEX --\\u003e DailyBar\\n    \\n    subgraph \\\"CTP Gateway\\\"\\n        CTP[\\\"CTP API\\u003cbr/\\u003eExternal Process\\\"]\\n        RedisChannels[\\\"Redis Channels\\u003cbr/\\u003eRequest/Response\\\"]\\n    end\\n    \\n    TradeStrategy[\\\"TradeStrategy\\u003cbr/\\u003etrader.strategy.brother2\\\"]\\n    \\n    TradeStrategy \\u003c--\\u003e|\\\"ReqOrderInsert\\u003cbr/\\u003eReqOrderAction\\u003cbr/\\u003eReqQryAccount\\\"| RedisChannels\\n    RedisChannels \\u003c--\\u003e|\\\"OnRtnOrder\\u003cbr/\\u003eOnRtnTrade\\u003cbr/\\u003eOnRtnDepthMarketData\\\"| CTP\\n```\\n\\nEach exchange provides daily market data in different formats (JSON, XML, TXT), which the acquisition layer normalizes into the `DailyBar` model. The CTP gateway operates as a separate process, communicating via Redis.\\n\\n**Sources:** [trader/utils/__init__.py:121-349](), [trader/strategy/brother2.py:220-299](), [panel/models.py:216-234]()\\n\\n## Layer 2: Core Trading Framework\\n\\nThe trading system is built on an inheritance hierarchy that provides scheduling and event handling:\\n\\n```mermaid\\ngraph TB\\n    CallbackFunctionContainer[\\\"CallbackFunctionContainer\\u003cbr/\\u003etrader.utils.func_container\\u003cbr/\\u003eDecorator-based callback registration\\\"]\\n    \\n    BaseModule[\\\"BaseModule\\u003cbr/\\u003etrader.strategy.__init__:36-140\\u003cbr/\\u003eRedis integration\\u003cbr/\\u003eCron scheduling\\u003cbr/\\u003eEvent loop management\\\"]\\n    \\n    TradeStrategy[\\\"TradeStrategy\\u003cbr/\\u003etrader.strategy.brother2:38-1089\\u003cbr/\\u003eTrading logic\\u003cbr/\\u003eSignal generation\\u003cbr/\\u003eOrder management\\u003cbr/\\u003eRisk controls\\\"]\\n    \\n    CallbackFunctionContainer -.-\\u003e|\\\"extends\\\"| BaseModule\\n    BaseModule -.-\\u003e|\\\"extends\\\"| TradeStrategy\\n    \\n    subgraph \\\"Key BaseModule Features\\\"\\n        RedisClient[\\\"self.redis_client\\u003cbr/\\u003eaioredis async client\\\"]\\n        RawRedis[\\\"self.raw_redis\\u003cbr/\\u003eredis sync client\\\"]\\n        IOLoop[\\\"self.io_loop\\u003cbr/\\u003easyncio event loop\\\"]\\n        ChannelRouter[\\\"self.channel_router\\u003cbr/\\u003epattern -\\u003e callback\\\"]\\n        CrontabRouter[\\\"self.crontab_router\\u003cbr/\\u003ecron -\\u003e callback\\\"]\\n    end\\n    \\n    BaseModule --\\u003e RedisClient\\n    BaseModule --\\u003e RawRedis\\n    BaseModule --\\u003e IOLoop\\n    BaseModule --\\u003e ChannelRouter\\n    BaseModule --\\u003e CrontabRouter\\n```\\n\\nThe `BaseModule` class provides the infrastructure for event-driven programming:\\n\\n- **Redis Integration**: Both async (`aioredis`) and sync (`redis`) clients\\n- **Cron Scheduling**: Uses `croniter` to schedule tasks at specific times\\n- **Pattern Matching**: Subscribes to Redis channels using glob patterns\\n- **Event Loop**: Manages the `asyncio` event loop for all async operations\\n\\n**Sources:** [trader/strategy/__init__.py:36-140](), [trader/strategy/brother2.py:38-63](), [trader/utils/func_container.py]()\\n\\n## Layer 3: Data Models\\n\\nThe Django ORM provides eight core models that represent the system's domain:\\n\\n```mermaid\\ngraph TB\\n    subgraph \\\"Account Management\\\"\\n        Broker[\\\"Broker\\u003cbr/\\u003epanel.models:61-82\\u003cbr/\\u003eTrading account credentials\\u003cbr/\\u003eBalance and margin tracking\\\"]\\n        Performance[\\\"Performance\\u003cbr/\\u003epanel.models:85-101\\u003cbr/\\u003eDaily NAV calculation\\u003cbr/\\u003eEquity tracking\\\"]\\n    end\\n    \\n    subgraph \\\"Strategy Configuration\\\"\\n        Strategy[\\\"Strategy\\u003cbr/\\u003epanel.models:104-125\\u003cbr/\\u003eLinks broker to instruments\\u003cbr/\\u003eHolds parameters\\\"]\\n        Param[\\\"Param\\u003cbr/\\u003epanel.models:128-143\\u003cbr/\\u003eStrategy parameters\\u003cbr/\\u003eBreakPeriod, AtrPeriod, etc.\\\"]\\n    end\\n    \\n    subgraph \\\"Instrument Data\\\"\\n        Instrument[\\\"Instrument\\u003cbr/\\u003epanel.models:146-170\\u003cbr/\\u003eContract specifications\\u003cbr/\\u003eMargin rates, fees, ticks\\\"]\\n        DailyBar[\\\"DailyBar\\u003cbr/\\u003epanel.models:216-234\\u003cbr/\\u003eIndividual contract OHLC\\u003cbr/\\u003eDaily time series\\\"]\\n        MainBar[\\\"MainBar\\u003cbr/\\u003epanel.models:194-213\\u003cbr/\\u003eContinuous contract OHLC\\u003cbr/\\u003eRollover adjustments\\\"]\\n    end\\n    \\n    subgraph \\\"Trading Activity\\\"\\n        Signal[\\\"Signal\\u003cbr/\\u003epanel.models:173-191\\u003cbr/\\u003eBUY, SELL, ROLL signals\\u003cbr/\\u003eGenerated by strategy\\\"]\\n        Order[\\\"Order\\u003cbr/\\u003epanel.models:237-259\\u003cbr/\\u003eCTP order tracking\\u003cbr/\\u003eStatus updates\\\"]\\n        Trade[\\\"Trade\\u003cbr/\\u003epanel.models:262-288\\u003cbr/\\u003ePosition tracking\\u003cbr/\\u003eP\\u0026L calculation\\\"]\\n    end\\n    \\n    Broker --\\u003e|\\\"1:N\\\"| Performance\\n    Broker --\\u003e|\\\"1:N\\\"| Strategy\\n    Strategy --\\u003e|\\\"M:N\\\"| Instrument\\n    Strategy --\\u003e|\\\"1:N\\\"| Param\\n    Strategy --\\u003e|\\\"1:N\\\"| Signal\\n    \\n    Instrument --\\u003e|\\\"1:N\\\"| DailyBar\\n    Instrument --\\u003e|\\\"1:N\\\"| MainBar\\n    Instrument --\\u003e|\\\"1:N\\\"| Signal\\n    \\n    Signal --\\u003e|\\\"1:1\\\"| Order\\n    Order --\\u003e|\\\"1:1\\\"| Trade\\n    \\n    Broker --\\u003e|\\\"1:N\\\"| Order\\n    Broker --\\u003e|\\\"1:N\\\"| Trade\\n```\\n\\nThe models are organized into four functional groups:\\n\\n1. **Account Management**: `Broker` holds credentials and tracks account balances. `Performance` records daily equity snapshots for NAV calculation.\\n\\n2. **Strategy Configuration**: `Strategy` connects a broker to a set of instruments and holds trading parameters via the `Param` model.\\n\\n3. **Instrument Data**: `Instrument` stores contract specifications. `DailyBar` holds individual contract data, while `MainBar` maintains continuous time series with rollover adjustments.\\n\\n4. **Trading Activity**: `Signal` records trading decisions. `Order` tracks CTP order status. `Trade` maintains position records and P\\u0026L.\\n\\n**Sources:** [panel/models.py:42-288]()\\n\\n## Layer 4: Message Bus Architecture\\n\\nRedis serves as the central message bus using a publish/subscribe pattern:\\n\\n```mermaid\\ngraph LR\\n    subgraph \\\"Trading Strategy\\\"\\n        TS[\\\"TradeStrategy instance\\u003cbr/\\u003etrader.strategy.brother2\\\"]\\n    end\\n    \\n    subgraph \\\"Redis Pub/Sub Channels\\\"\\n        REQ[\\\"Request Channel\\u003cbr/\\u003eMSG:CTP:REQ:*\\u003cbr/\\u003eReqOrderInsert\\u003cbr/\\u003eReqOrderAction\\u003cbr/\\u003eReqQryAccount\\\"]\\n        \\n        TRADE_RSP[\\\"Trade Response\\u003cbr/\\u003eMSG:CTP:RSP:TRADE:*\\u003cbr/\\u003eOnRtnOrder\\u003cbr/\\u003eOnRtnTrade\\u003cbr/\\u003eOnRspQryOrder\\\"]\\n        \\n        MARKET_RSP[\\\"Market Response\\u003cbr/\\u003eMSG:CTP:RSP:MARKET:*\\u003cbr/\\u003eOnRtnDepthMarketData\\u003cbr/\\u003eOnRspSubMarketData\\\"]\\n    end\\n    \\n    subgraph \\\"CTP Gateway\\\"\\n        CTP[\\\"CTP API Handler\\u003cbr/\\u003eSeparate Process\\\"]\\n    end\\n    \\n    TS --\\u003e|\\\"publish\\\"| REQ\\n    REQ -.-\\u003e|\\\"subscribe\\\"| CTP\\n    \\n    CTP --\\u003e|\\\"publish\\\"| TRADE_RSP\\n    CTP --\\u003e|\\\"publish\\\"| MARKET_RSP\\n    \\n    TRADE_RSP -.-\\u003e|\\\"psubscribe pattern\\\"| TS\\n    MARKET_RSP -.-\\u003e|\\\"psubscribe pattern\\\"| TS\\n```\\n\\nChannel naming convention from configuration:\\n\\n| Channel Type | Format | Example | Purpose |\\n|--------------|--------|---------|---------|\\n| Request | `MSG:CTP:REQ:*` | `MSG:CTP:REQ:ReqOrderInsert` | Commands sent to CTP |\\n| Trade Response | `MSG:CTP:RSP:TRADE:*` | `MSG:CTP:RSP:TRADE:OnRtnOrder:1234567` | Order status updates |\\n| Market Response | `MSG:CTP:RSP:MARKET:*` | `MSG:CTP:RSP:MARKET:OnRtnDepthMarketData:rb2401` | Real-time tick data |\\n\\nThe strategy uses pattern subscriptions (`psubscribe`) to receive all messages matching a pattern, enabling message routing by `OrderRef` or instrument code.\\n\\n**Sources:** [trader/strategy/brother2.py:41-43](), [trader/strategy/__init__.py:80-121](), [trader/utils/read_config.py]()\\n\\n## Layer 5: Scheduled Tasks\\n\\nThe system operates on a schedule defined by cron expressions:\\n\\n```mermaid\\ngraph TB\\n    subgraph \\\"Daily Schedule\\\"\\n        Morning855[\\\"08:55\\u003cbr/\\u003eprocessing_signal1()\\u003cbr/\\u003eDay session signals\\u003cbr/\\u003eNon-CFFEX instruments\\\"]\\n        \\n        Morning925[\\\"09:25\\u003cbr/\\u003eprocessing_signal2()\\u003cbr/\\u003eStock index signals\\u003cbr/\\u003eCFFEX instruments\\\"]\\n        \\n        Evening1520[\\\"15:20\\u003cbr/\\u003erefresh_all()\\u003cbr/\\u003eAccount refresh\\u003cbr/\\u003ePosition sync\\\"]\\n        \\n        Evening1530[\\\"15:30\\u003cbr/\\u003eupdate_equity()\\u003cbr/\\u003ePerformance calculation\\u003cbr/\\u003eNAV update\\\"]\\n        \\n        Evening1700[\\\"17:00\\u003cbr/\\u003ecollect_quote()\\u003cbr/\\u003eExchange data fetch\\u003cbr/\\u003ecalc_signal() for all instruments\\\"]\\n        \\n        Night2055[\\\"20:55\\u003cbr/\\u003eprocessing_signal3()\\u003cbr/\\u003eNight session signals\\u003cbr/\\u003eNight-traded instruments\\\"]\\n    end\\n    \\n    subgraph \\\"Continuous\\\"\\n        Heartbeat[\\\"*/1 * * * *\\u003cbr/\\u003eheartbeat()\\u003cbr/\\u003eHEARTBEAT:TRADER key\\u003cbr/\\u003e301 second expiry\\\"]\\n    end\\n    \\n    Morning855 --\\u003e Morning925\\n    Morning925 --\\u003e Evening1520\\n    Evening1520 --\\u003e Evening1530\\n    Evening1530 --\\u003e Evening1700\\n    Evening1700 --\\u003e Night2055\\n```\\n\\nEach scheduled task uses the `@RegisterCallback(crontab='...')` decorator:\\n\\n| Time | Function | Purpose |\\n|------|----------|---------|\\n| 08:55 | `processing_signal1()` | Process day session signals (excludes CFFEX) |\\n| 09:25 | `processing_signal2()` | Process stock index and bond signals (CFFEX only) |\\n| 15:20 | `refresh_all()` | Query CTP for account balance, positions, and contracts |\\n| 15:30 | `update_equity()` | Calculate daily performance and NAV |\\n| 17:00 | `collect_quote()` | Fetch daily data from all exchanges and generate signals |\\n| 20:55 | `processing_signal3()` | Process night session signals |\\n| Every minute | `heartbeat()` | Set Redis key to monitor system health |\\n\\n**Sources:** [trader/strategy/brother2.py:568-703]()\\n\\n## Signal Generation and Order Execution Flow\\n\\nThe complete lifecycle from data to execution:\\n\\n```mermaid\\nsequenceDiagram\\n    participant Exchanges as \\\"5 Exchanges\\\"\\n    participant Fetch as \\\"collect_quote()\\u003cbr/\\u003e17:00 daily\\\"\\n    participant Calc as \\\"calculate()\\u003cbr/\\u003ecalc_signal()\\\"\\n    participant DB as \\\"Django ORM\\\"\\n    participant Process as \\\"processing_signal*()\\u003cbr/\\u003e08:55, 09:25, 20:55\\\"\\n    participant Redis as \\\"Redis Pub/Sub\\\"\\n    participant CTP as \\\"CTP Gateway\\\"\\n    \\n    Exchanges-\\u003e\\u003eFetch: Daily OHLC data\\u003cbr/\\u003eHTTP requests\\n    Fetch-\\u003e\\u003eDB: Store DailyBar records\\n    Fetch-\\u003e\\u003eCalc: Trigger calculation\\n    \\n    Calc-\\u003e\\u003eDB: Read MainBar history\\u003cbr/\\u003eCalculate ATR, SMA\\n    Calc-\\u003e\\u003eDB: Write Signal records\\u003cbr/\\u003eBUY, SELL, ROLL\\n    \\n    Note over Process: Next trading session\\n    \\n    Process-\\u003e\\u003eDB: Query unprocessed Signals\\n    DB--\\u003e\\u003eProcess: Signal list\\n    \\n    loop For each Signal\\n        Process-\\u003e\\u003eRedis: Publish ReqOrderInsert\\u003cbr/\\u003eMSG:CTP:REQ:*\\n        Redis-\\u003e\\u003eCTP: Forward order request\\n        CTP--\\u003e\\u003eRedis: OnRtnOrder (status)\\n        Redis--\\u003e\\u003eProcess: Order confirmation\\n        Process-\\u003e\\u003eDB: Create/Update Order\\n        \\n        alt Trade Filled\\n            CTP--\\u003e\\u003eRedis: OnRtnTrade\\n            Redis--\\u003e\\u003eProcess: Trade notification\\n            Process-\\u003e\\u003eDB: Update Trade record\\u003cbr/\\u003eCalculate P\\u0026L\\n            Process-\\u003e\\u003eDB: Mark Signal.processed=True\\n        end\\n    end\\n```\\n\\nThe flow separates **signal generation** (evening after market close) from **order execution** (pre-market sessions), allowing manual review and intervention.\\n\\n**Sources:** [trader/strategy/brother2.py:684-723](), [trader/strategy/brother2.py:572-642](), [trader/strategy/brother2.py:301-470]()\\n\\n## Technical Analysis Integration\\n\\nTechnical indicators are calculated using TA-Lib and custom implementations:\\n\\n```mermaid\\ngraph LR\\n    subgraph \\\"Data Source\\\"\\n        MainBar[\\\"MainBar.objects.filter()\\u003cbr/\\u003eHistorical OHLC\\\"]\\n    end\\n    \\n    subgraph \\\"Indicator Calculation\\\"\\n        ATR[\\\"ATR\\u003cbr/\\u003etalib.ATR()\\u003cbr/\\u003eVolatility measure\\\"]\\n        SMA[\\\"SMA\\u003cbr/\\u003eManual calculation\\u003cbr/\\u003eShort/Long trends\\\"]\\n        Breakout[\\\"Breakout Levels\\u003cbr/\\u003erolling().max/min()\\u003cbr/\\u003eHigh/Low lines\\\"]\\n    end\\n    \\n    subgraph \\\"Signal Logic\\\"\\n        BuyCondition[\\\"BUY:\\u003cbr/\\u003eshort_trend \\u003e long_trend\\u003cbr/\\u003eAND close \\u003e= high_line\\\"]\\n        SellCondition[\\\"SELL:\\u003cbr/\\u003eshort_trend \\u003c long_trend\\u003cbr/\\u003eAND close \\u003c= low_line\\\"]\\n        StopLoss[\\\"Stop Loss:\\u003cbr/\\u003eprice \\u003c= high - ATR * stop_n\\u003cbr/\\u003eprice \\u003e= low + ATR * stop_n\\\"]\\n    end\\n    \\n    MainBar --\\u003e ATR\\n    MainBar --\\u003e SMA\\n    MainBar --\\u003e Breakout\\n    \\n    ATR --\\u003e StopLoss\\n    SMA --\\u003e BuyCondition\\n    SMA --\\u003e SellCondition\\n    Breakout --\\u003e BuyCondition\\n    Breakout --\\u003e SellCondition\\n```\\n\\nThe `calc_signal()` method at [trader/strategy/brother2.py:725-855]() implements a trend-following strategy:\\n\\n1. **ATR (Average True Range)**: Measures volatility for position sizing and stop-loss calculation\\n2. **SMA (Simple Moving Average)**: Manually calculated for short-term and long-term trends\\n3. **Breakout Levels**: Rolling maximum/minimum over `BreakPeriod` for entry signals\\n4. **Stop Loss**: ATR-based trailing stops to limit losses\\n\\nStrategy parameters are stored in the `Param` model and retrieved at runtime.\\n\\n**Sources:** [trader/strategy/brother2.py:725-855](), [trader/utils/__init__.py:500-601](), [panel/models.py:128-143]()\\n\\n## Configuration Management\\n\\nSystem configuration is centralized in `config.ini`:\\n\\n| Section | Key Parameters | Used By |\\n|---------|---------------|---------|\\n| `MSG_CHANNEL` | `request_format`, `trade_response_format`, `market_response_format` | `TradeStrategy` for Redis channel patterns |\\n| `REDIS` | `host`, `port`, `db` | `BaseModule` for connection setup |\\n| `MYSQL` | `host`, `user`, `password`, `database` | Django settings |\\n| `TRADE` | `ignore_inst`, `command_timeout` | Data acquisition and order management |\\n| `LOG` | Log file paths and levels | System-wide logging |\\n\\nConfiguration is loaded via `trader.utils.read_config.config`, a `ConfigParser` instance that provides fallback defaults.\\n\\n**Sources:** [trader/utils/read_config.py](), [trader/strategy/brother2.py:41-44](), [trader/strategy/__init__.py:41-47]()\\n\\n## Error Handling and Recovery\\n\\nThe system implements multiple layers of error handling:\\n\\n1. **CTP Error Mapping**: The `error.xml` file maps CTP error codes to human-readable messages\\n2. **Order Rejection Handling**: `OnRtnOrder()` at [trader/strategy/brother2.py:510-566]() automatically adjusts price and resubmits orders rejected due to price limits\\n3. **Query Timeouts**: All CTP queries use `asyncio.wait_for()` with configurable timeout\\n4. **Position Reconciliation**: Daily position refresh at market close verifies CTP state matches database records\\n5. **Heartbeat Monitoring**: Redis key `HEARTBEAT:TRADER` expires every 301 seconds to detect system failures\\n\\n**Sources:** [trader/strategy/brother2.py:510-566](), [trader/strategy/brother2.py:86-154](), [trader/strategy/brother2.py:568-570](), [trader/utils/read_config.py]()\\n\\n## Summary\\n\\nThe trader system architecture achieves:\\n\\n- **Asynchronous scalability** through `asyncio` and Redis message passing\\n- **Clear separation of concerns** across five distinct layers\\n- **Flexible scheduling** via cron expressions and event callbacks\\n- **Robust error handling** with automatic recovery mechanisms\\n- **Data integrity** through Django ORM transaction management\\n\\nFor implementation details on each layer, see the child pages [System Components](#3.1), [Data Flow Pipeline](#3.2), and [Message Bus and Communication](#3.3).\"])</script><script>self.__next_f.push([1,\"1d:T560b,\"])</script><script>self.__next_f.push([1,\"# System Components\\n\\n\\u003cdetails\\u003e\\n\\u003csummary\\u003eRelevant source files\\u003c/summary\\u003e\\n\\nThe following files were used as context for generating this wiki page:\\n\\n- [panel/models.py](panel/models.py)\\n- [trader/strategy/__init__.py](trader/strategy/__init__.py)\\n- [trader/strategy/brother2.py](trader/strategy/brother2.py)\\n- [trader/utils/__init__.py](trader/utils/__init__.py)\\n\\n\\u003c/details\\u003e\\n\\n\\n\\nThis page provides a detailed breakdown of the major system components that comprise the automated futures trading platform. It describes the architectural building blocks, their responsibilities, and how they interact to form a cohesive trading system.\\n\\n**Scope**: This page focuses on the structural components and their static relationships. For information about how data flows through these components, see [Data Flow Pipeline](#3.2). For details on the Redis message bus and communication protocols, see [Message Bus and Communication](#3.3).\\n\\n## Component Overview\\n\\nThe system is organized into five primary layers, each containing specific components with well-defined responsibilities:\\n\\n```mermaid\\ngraph TB\\n    subgraph \\\"Entry Point\\\"\\n        Main[\\\"trader/main.py\\u003cbr/\\u003eSystem Initialization\\\"]\\n    end\\n    \\n    subgraph \\\"Strategy Layer\\\"\\n        TradeStrategy[\\\"TradeStrategy\\u003cbr/\\u003etrader/strategy/brother2.py\\u003cbr/\\u003eCore Trading Logic\\\"]\\n        BaseModule[\\\"BaseModule\\u003cbr/\\u003etrader/strategy/__init__.py\\u003cbr/\\u003eFramework Infrastructure\\\"]\\n    end\\n    \\n    subgraph \\\"Data Acquisition\\\"\\n        FetchData[\\\"fetch_data.py\\u003cbr/\\u003eDaily Data Orchestration\\\"]\\n        UpdateSHFE[\\\"update_from_shfe()\\\"]\\n        UpdateDCE[\\\"update_from_dce()\\\"]\\n        UpdateCZCE[\\\"update_from_czce()\\\"]\\n        UpdateCFFEX[\\\"update_from_cffex()\\\"]\\n        UpdateGFEX[\\\"update_from_gfex()\\\"]\\n        CalcMain[\\\"calc_main_inst()\\\"]\\n        CalcSignal[\\\"calc_history_signal()\\\"]\\n    end\\n    \\n    subgraph \\\"Utilities\\\"\\n        ReadConfig[\\\"read_config.py\\u003cbr/\\u003eConfiguration Loader\\\"]\\n        UtilsInit[\\\"trader/utils/__init__.py\\u003cbr/\\u003eData Processing Functions\\\"]\\n    end\\n    \\n    subgraph \\\"Data Layer\\\"\\n        Models[\\\"panel/models.py\\u003cbr/\\u003eDjango ORM Models\\\"]\\n        Constants[\\\"panel/const.py\\u003cbr/\\u003eSystem Constants\\\"]\\n    end\\n    \\n    subgraph \\\"Message Bus\\\"\\n        Redis[\\\"Redis\\u003cbr/\\u003ePub/Sub + Cache\\\"]\\n        AioRedis[\\\"aioredis.Redis\\u003cbr/\\u003eAsync Client\\\"]\\n        RawRedis[\\\"redis.StrictRedis\\u003cbr/\\u003eSync Client\\\"]\\n    end\\n    \\n    Main --\\u003e TradeStrategy\\n    TradeStrategy --\\u003e BaseModule\\n    BaseModule --\\u003e AioRedis\\n    BaseModule --\\u003e RawRedis\\n    TradeStrategy --\\u003e UtilsInit\\n    TradeStrategy --\\u003e Models\\n    TradeStrategy --\\u003e ReadConfig\\n    \\n    FetchData --\\u003e UpdateSHFE\\n    FetchData --\\u003e UpdateDCE\\n    FetchData --\\u003e UpdateCZCE\\n    FetchData --\\u003e UpdateCFFEX\\n    FetchData --\\u003e UpdateGFEX\\n    \\n    UtilsInit --\\u003e UpdateSHFE\\n    UtilsInit --\\u003e UpdateDCE\\n    UtilsInit --\\u003e UpdateCZCE\\n    UtilsInit --\\u003e UpdateCFFEX\\n    UtilsInit --\\u003e UpdateGFEX\\n    UtilsInit --\\u003e CalcMain\\n    UtilsInit --\\u003e CalcSignal\\n    \\n    AioRedis --\\u003e Redis\\n    RawRedis --\\u003e Redis\\n    Models --\\u003e Constants\\n```\\n\\n**Component Layer Diagram**\\n\\nSources: [trader/main.py](), [trader/strategy/brother2.py:1-100](), [trader/strategy/__init__.py:1-50](), [trader/utils/__init__.py:1-100](), [panel/models.py:1-50]()\\n\\n## Strategy Layer Components\\n\\nThe strategy layer contains the core trading logic and framework infrastructure.\\n\\n### TradeStrategy Class\\n\\n**Location**: [trader/strategy/brother2.py:38-862]()\\n\\n`TradeStrategy` is the most important component in the system (importance score: 227.43) and implements the primary trading logic. It extends `BaseModule` to inherit Redis integration and callback management capabilities.\\n\\n**Key Responsibilities**:\\n\\n| Responsibility | Methods | Description |\\n|----------------|---------|-------------|\\n| Account Management | `refresh_account()` [86-112](), `refresh_position()` [114-154](), `refresh_instrument()` [156-205]() | Synchronize broker account state, positions, and instrument details from CTP |\\n| Signal Processing | `calc_signal()` [725-862]() | Calculate trading signals using technical indicators (ATR, SMA, breakout) |\\n| Order Execution | `ReqOrderInsert()` [301-343](), `cancel_order()` [345-371]() | Submit and cancel orders via Redis message bus |\\n| Query Operations | `query()` [236-257](), `SubscribeMarketData()` [259-278]() | Request data from CTP API via Redis request-response pattern |\\n| Event Handling | `OnRtnTrade()` [392-469](), `OnRtnOrder()` [511-566](), `OnRtnDepthMarketData()` [374-380]() | Process trade confirmations, order status updates, and market data ticks |\\n| Scheduled Tasks | `processing_signal1/2/3()` [573-642](), `refresh_all()` [645-654](), `collect_quote()` [685-703]() | Cron-triggered functions for signal processing and data collection |\\n\\n**State Management**:\\n\\nThe class maintains several critical state variables initialized in `__init__()` [39-62]():\\n\\n- `__strategy`: Reference to `Strategy` model instance\\n- `__broker`: Reference to `Broker` model instance  \\n- `__current`, `__pre_balance`, `__cash`, `__margin`: Account equity metrics\\n- `__cur_pos`: Dictionary of current positions by instrument ID\\n- `__shares`: Position details by instrument\\n- `__trading_day`, `__last_trading_day`: Trading calendar dates from Redis\\n\\nSources: [trader/strategy/brother2.py:38-862]()\\n\\n### BaseModule Framework\\n\\n**Location**: [trader/strategy/__init__.py:36-140]()\\n\\n`BaseModule` is an abstract base class that provides infrastructure for Redis-based event-driven programming and cron-based scheduling. All trading strategies must extend this class.\\n\\n**Key Features**:\\n\\n```mermaid\\ngraph LR\\n    BaseModule[\\\"BaseModule\\u003cbr/\\u003eAbstract Class\\\"]\\n    CallbackContainer[\\\"CallbackFunctionContainer\\u003cbr/\\u003eDecorator Support\\\"]\\n    RedisAsync[\\\"aioredis.Redis\\u003cbr/\\u003eself.redis_client\\\"]\\n    RedisSync[\\\"redis.StrictRedis\\u003cbr/\\u003eself.raw_redis\\\"]\\n    CronRouter[\\\"self.crontab_router\\u003cbr/\\u003eCron Schedule Manager\\\"]\\n    ChannelRouter[\\\"self.channel_router\\u003cbr/\\u003eChannel Subscription Manager\\\"]\\n    \\n    BaseModule --\\u003e CallbackContainer\\n    BaseModule --\\u003e RedisAsync\\n    BaseModule --\\u003e RedisSync\\n    BaseModule --\\u003e CronRouter\\n    BaseModule --\\u003e ChannelRouter\\n```\\n\\n**BaseModule Component Diagram**\\n\\n**Redis Client Management** [37-48]():\\n- `self.redis_client`: Async Redis client (`aioredis.Redis`) for Pub/Sub operations\\n- `self.raw_redis`: Synchronous Redis client (`redis.StrictRedis`) for blocking operations\\n- `self.sub_client`: Pub/Sub subscription client\\n\\n**Callback Registration** [58-78]():\\n- `_register_callback()` [58-70](): Scans methods decorated with `@RegisterCallback` and registers them\\n- Supports two callback types:\\n  - `crontab`: Time-based triggers using cron expressions\\n  - `channel`: Redis Pub/Sub channel patterns\\n\\n**Lifecycle Management**:\\n\\n| Method | Line Range | Purpose |\\n|--------|------------|---------|\\n| `install()` | [80-93]() | Subscribe to channels, start cron scheduler, initialize event loop tasks |\\n| `uninstall()` | [95-108]() | Unsubscribe from channels, cancel scheduled tasks, cleanup |\\n| `_msg_reader()` | [110-121]() | Async generator that listens to Redis Pub/Sub messages and routes to handlers |\\n| `_call_next()` | [74-78]() | Schedule and execute cron-triggered callbacks |\\n| `run()` | [129-139]() | Main event loop entry point |\\n\\nSources: [trader/strategy/__init__.py:36-140]()\\n\\n## Data Acquisition Layer\\n\\nThe data acquisition layer is responsible for fetching daily market data from five Chinese commodity exchanges and processing it for storage.\\n\\n**Location**: [trader/utils/__init__.py:121-796]()\\n\\n### Exchange Update Functions\\n\\nEach exchange has a dedicated async function that handles its specific data format:\\n\\n```mermaid\\ngraph TB\\n    FetchData[\\\"fetch_data.py\\u003cbr/\\u003eOrchestration\\\"]\\n    \\n    SHFE[\\\"update_from_shfe()\\u003cbr/\\u003eLines 121-174\\u003cbr/\\u003eFormat: JSON\\u003cbr/\\u003eEndpoint: kx{YYYYMMDD}.dat\\\"]\\n    DCE[\\\"update_from_dce()\\u003cbr/\\u003eLines 220-265\\u003cbr/\\u003eFormat: TXT\\u003cbr/\\u003ePOST: exportDayQuotesChData.html\\\"]\\n    CZCE[\\\"update_from_czce()\\u003cbr/\\u003eLines 177-217\\u003cbr/\\u003eFormat: TXT\\u003cbr/\\u003eFile: FutureDataDaily.txt\\\"]\\n    CFFEX[\\\"update_from_cffex()\\u003cbr/\\u003eLines 296-349\\u003cbr/\\u003eFormat: XML\\u003cbr/\\u003ePath: /sj/hqsj/rtj/{date}/index.xml\\\"]\\n    GFEX[\\\"update_from_gfex()\\u003cbr/\\u003eLines 268-293\\u003cbr/\\u003eFormat: JSON\\u003cbr/\\u003ePOST: /gfexweb/Quote/getQuote_ftr\\\"]\\n    \\n    DailyBar[\\\"DailyBar Model\\u003cbr/\\u003ePer-Contract OHLC Data\\\"]\\n    \\n    FetchData --\\u003e SHFE\\n    FetchData --\\u003e DCE\\n    FetchData --\\u003e CZCE\\n    FetchData --\\u003e CFFEX\\n    FetchData --\\u003e GFEX\\n    \\n    SHFE --\\u003e DailyBar\\n    DCE --\\u003e DailyBar\\n    CZCE --\\u003e DailyBar\\n    CFFEX --\\u003e DailyBar\\n    GFEX --\\u003e DailyBar\\n```\\n\\n**Exchange Data Acquisition Functions**\\n\\n**Common Pattern**:\\n1. Use `aiohttp.ClientSession` for async HTTP requests\\n2. Use semaphore (`max_conn_*`) to limit concurrent connections\\n3. Parse exchange-specific format (JSON/XML/TXT)\\n4. Call `DailyBar.objects.update_or_create()` to persist data\\n5. Return `True` on success, `False` on exception\\n\\n**Exchange-Specific Details**:\\n\\n| Exchange | Function | Data Format | Key Fields |\\n|----------|----------|-------------|------------|\\n| SHFE () | `update_from_shfe()` [121-174]() | JSON (`o_curinstrument` array) | PRODUCTID, DELIVERYMONTH, OPENPRICE, HIGHESTPRICE, LOWESTPRICE, CLOSEPRICE, SETTLEMENTPRICE, VOLUME, OPENINTEREST |\\n| DCE () | `update_from_dce()` [220-265]() | Tab-separated text | , , , , , , , ,  |\\n| CZCE () | `update_from_czce()` [177-217]() | Pipe/comma-separated text | , , , , , , ,  |\\n| CFFEX () | `update_from_cffex()` [296-349]() | XML (`\\u003cdailydata\\u003e` elements) | instrumentid, openprice, highestprice, lowestprice, closeprice, settlementprice, volume, openinterest |\\n| GFEX () | `update_from_gfex()` [268-293]() | JSON (`contractQuote` object) | openPrice, highPrice, lowPrice, closePrice, clearPrice, matchTotQty, openInterest |\\n\\nSources: [trader/utils/__init__.py:121-349]()\\n\\n### Data Processing Functions\\n\\n**Main Contract Calculation** - `calc_main_inst()` [381-421]()\\n\\nDetermines the \\\"main contract\\\" (most liquid contract) for each instrument using a three-tier logic:\\n\\n1. **Primary Condition** [385-388](): Volume  10,000 AND Open Interest  10,000 (or CFFEX instruments), select max volume\\n2. **Secondary Condition** [390-395](): If no match, find contract with max volume for 3 consecutive days\\n3. **Fallback Condition** [397-400](): If still no match, use current max volume contract\\n\\nWhen main contract changes (rollover), calls `handle_rollover()` [365-378]() to adjust historical prices by basis (new close - old close).\\n\\n**Historical Signal Calculation** - `calc_history_signal()` [500-600]()\\n\\nBacktesting function that generates historical signals based on the same indicators used in live trading:\\n- Uses ATR for volatility measurement [511]()\\n- Calculates short/long trend using SMA [513-517]()\\n- Computes high/low breakout lines [518-519]()\\n- Implements long/short entry logic [526-551]()\\n- Applies stop-loss rules [552-589]()\\n\\n**Contract Arguments Fetching** - `get_contracts_argument()` [685-796]()\\n\\nFetches daily trading parameters (margin rates, limit ratios) from all exchanges and stores in Redis with keys formatted as `LIMITRATIO:{exchange}:{code}:{inst_id}`.\\n\\nSources: [trader/utils/__init__.py:381-796]()\\n\\n## Data Layer Components\\n\\nThe data layer defines the persistence models using Django ORM and system-wide constants.\\n\\n### Django Models\\n\\n**Location**: [panel/models.py:1-289]()\\n\\nThe system defines nine primary models organized into three categories:\\n\\n**Configuration Models**:\\n\\n| Model | Purpose | Key Fields | Lines |\\n|-------|---------|------------|-------|\\n| `Broker` | Trading account configuration | name, contract_type, trade_address, market_address, identify, username, password, cash, current, pre_balance, margin | [61-82]() |\\n| `Strategy` | Trading strategy definition | name, broker, instruments (M2M), force_opens (M2M) | [104-125]() |\\n| `Instrument` | Futures product specification | exchange, product_code, name, main_code, last_main, volume_multiple, price_tick, margin_rate, fee_money, fee_volume, up_limit_ratio, down_limit_ratio | [146-170]() |\\n| `Param` | Strategy parameters | strategy, code, str_value, int_value, float_value | [128-143]() |\\n\\n**Market Data Models**:\\n\\n| Model | Purpose | Key Fields | Lines |\\n|-------|---------|------------|-------|\\n| `DailyBar` | Per-contract daily OHLC bars | exchange, code, expire_date, time, open, high, low, close, settlement, volume, open_interest | [216-234]() |\\n| `MainBar` | Continuous main contract series | exchange, product_code, code, time, open, high, low, close, settlement, volume, open_interest, basis | [194-213]() |\\n\\n**Trading Models**:\\n\\n| Model | Purpose | Key Fields | Lines |\\n|-------|---------|------------|-------|\\n| `Signal` | Trading signal generated by strategy | strategy, instrument, code, type, price, volume, trigger_time, priority, processed | [173-191]() |\\n| `Order` | Order sent to CTP | broker, strategy, instrument, code, order_ref, price, volume, direction, offset_flag, status, send_time, signal | [237-259]() |\\n| `Trade` | Executed trade/position | broker, strategy, instrument, code, direction, open_time, close_time, shares, filled_shares, avg_entry_price, avg_exit_price, profit, frozen_margin, cost | [262-288]() |\\n\\n**Performance Model**:\\n\\n| Model | Purpose | Key Fields | Lines |\\n|-------|---------|------------|-------|\\n| `Performance` | Daily equity snapshot | broker, day, capital, unit_count, NAV, accumulated, dividend, used_margin | [85-101]() |\\n\\n**Helper Model**:\\n\\n- `Autonumber` [42-44](): Auto-incrementing ID generator for OrderRef creation\\n\\n**Utility Function**:\\n- `to_df()` [25-39](): Converts Django QuerySet to pandas DataFrame for technical analysis\\n\\nSources: [panel/models.py:1-289]()\\n\\n### Constants and Enumerations\\n\\n**Location**: [panel/const.py]()\\n\\nSystem-wide constants define enumeration types for various trading entities. While the file wasn't provided in full, based on usage in other files, it contains:\\n\\n**Exchange Types**: `ExchangeType.SHFE`, `ExchangeType.DCE`, `ExchangeType.CZCE`, `ExchangeType.CFFEX`, `ExchangeType.GFEX`, `ExchangeType.INE`\\n\\n**Signal Types**: `SignalType.BUY`, `SignalType.SELL`, `SignalType.SELL_SHORT`, `SignalType.BUY_COVER`, `SignalType.ROLL_OPEN`, `SignalType.ROLL_CLOSE`\\n\\n**Direction Types**: `DirectionType.LONG`, `DirectionType.SHORT`\\n\\n**Order Status**: `OrderStatus.AllTraded`, `OrderStatus.PartTradedQueueing`, `OrderStatus.Canceled`, etc.\\n\\n**Offset Flags**: `OffsetFlag.Open`, `OffsetFlag.Close`, `CombOffsetFlag.Open`, etc.\\n\\n**Priority Types**: `PriorityType.High`, `PriorityType.Normal`, `PriorityType.LOW`\\n\\nSources: [panel/const.py](), [trader/strategy/brother2.py:312-340](), [panel/models.py:22]()\\n\\n## Message Bus Components\\n\\nThe system uses Redis as a central message bus for communication between the trading strategy and the CTP API gateway process.\\n\\n### Redis Client Instances\\n\\n**Configuration**: [trader/utils/read_config.py]() loads Redis connection parameters from `config.ini`\\n\\n**Client Types**:\\n\\n```mermaid\\ngraph TB\\n    BaseModule[\\\"BaseModule\\\"]\\n    TradeStrategy[\\\"TradeStrategy\\\"]\\n    \\n    AsyncClient[\\\"self.redis_client\\u003cbr/\\u003eaioredis.Redis\\u003cbr/\\u003eAsync Pub/Sub Client\\\"]\\n    SyncClient[\\\"self.raw_redis\\u003cbr/\\u003eredis.StrictRedis\\u003cbr/\\u003eSync Operations\\\"]\\n    SubClient[\\\"self.sub_client\\u003cbr/\\u003ePubSub Instance\\u003cbr/\\u003ePattern Subscriptions\\\"]\\n    \\n    RedisServer[\\\"Redis Server\\u003cbr/\\u003ePub/Sub + KV Store\\\"]\\n    \\n    BaseModule --\\u003e AsyncClient\\n    BaseModule --\\u003e SyncClient\\n    BaseModule --\\u003e SubClient\\n    TradeStrategy --\\u003e BaseModule\\n    \\n    AsyncClient --\\u003e RedisServer\\n    SyncClient --\\u003e RedisServer\\n    SubClient --\\u003e RedisServer\\n```\\n\\n**Redis Client Architecture**\\n\\n**Async Client** (`self.redis_client`) [trader/strategy/__init__.py:41-44]():\\n- Used for Pub/Sub pattern subscriptions via `psubscribe()`\\n- Non-blocking operations in async context\\n- Created with `aioredis.from_url()`\\n\\n**Sync Client** (`self.raw_redis`) [trader/strategy/__init__.py:45-47]():\\n- Used for blocking operations like `get()`, `set()`, `publish()`\\n- Heartbeat updates [trader/strategy/brother2.py:570]()\\n- Trading day retrieval [trader/strategy/brother2.py:61-62]()\\n\\n**Subscription Client** (`self.sub_client`) [trader/strategy/__init__.py:48]():\\n- Dedicated Pub/Sub instance for pattern-based subscriptions\\n- Listens to channels in `_msg_reader()` [trader/strategy/__init__.py:110-121]()\\n\\nSources: [trader/strategy/__init__.py:37-48](), [trader/strategy/brother2.py:41-43, 61-62, 570]()\\n\\n### Channel Patterns\\n\\nChannel names are configured via `config.ini` and follow specific patterns:\\n\\n**Request Channel** (`self.__request_format`) [trader/strategy/brother2.py:43]():\\n- Format: `MSG:CTP:REQ:*`\\n- Used to publish CTP API requests (order insert, cancel, query)\\n- Example: `ReqOrderInsert`, `ReqQryTradingAccount`, `ReqQryInvestorPositionDetail`\\n\\n**Trade Response Channels** (`self.__trade_response_format`) [trader/strategy/brother2.py:42]():\\n- Format: `MSG:CTP:RSP:TRADE:{EventName}:{OrderRef}`\\n- Pattern subscriptions for order/trade events\\n- Examples:\\n  - `MSG:CTP:RSP:TRADE:OnRtnOrder:*` [trader/strategy/brother2.py:510]()\\n  - `MSG:CTP:RSP:TRADE:OnRtnTrade:*` [trader/strategy/brother2.py:391]()\\n  - `MSG:CTP:RSP:TRADE:OnRspQryOrder:{RequestID}` [trader/strategy/brother2.py:243]()\\n\\n**Market Response Channels** (`self.__market_response_format`) [trader/strategy/brother2.py:41]():\\n- Format: `MSG:CTP:RSP:MARKET:{EventName}:{InstrumentID}`\\n- Real-time market data ticks\\n- Example: `MSG:CTP:RSP:MARKET:OnRtnDepthMarketData:*` [trader/strategy/brother2.py:373]()\\n\\nSources: [trader/strategy/brother2.py:41-43, 243, 264, 285, 352-354, 373, 391, 510]()\\n\\n## Configuration System\\n\\n**Location**: [trader/utils/read_config.py]()\\n\\nThe configuration system loads settings from `config.ini` and provides them to all components via a global `config` object.\\n\\n**Configuration Sections**:\\n\\n| Section | Purpose | Used By |\\n|---------|---------|---------|\\n| `MSG_CHANNEL` | Redis channel name formats | TradeStrategy [trader/strategy/brother2.py:41-43]() |\\n| `TRADE` | Trading parameters (timeout, ignore list) | TradeStrategy [trader/strategy/brother2.py:35, 44]() |\\n| `REDIS` | Redis connection settings | BaseModule [trader/strategy/__init__.py:41-47]() |\\n| `MYSQL` | Database connection settings | Django settings |\\n| `LOG` | Logging configuration | System-wide |\\n\\n**CTP Error Mapping**:\\n\\nThe system also loads CTP error definitions from `error.xml` into a `ctp_errors` dictionary for human-readable error messages:\\n\\nUsage: [trader/strategy/brother2.py:363]() - `logger.warning(f\\\": {ctp_errors[result['ErrorID']]}\\\")`\\n\\nSources: [trader/utils/read_config.py](), [trader/strategy/brother2.py:29, 35, 41-44, 363]()\\n\\n## Component Interaction Flow\\n\\nThe following diagram illustrates how components interact during a typical order execution cycle:\\n\\n```mermaid\\nsequenceDiagram\\n    participant Cron as \\\"Cron Scheduler\\u003cbr/\\u003eBaseModule._call_next()\\\"\\n    participant TS as \\\"TradeStrategy\\u003cbr/\\u003eprocessing_signal1()\\\"\\n    participant DB as \\\"Django ORM\\u003cbr/\\u003eSignal.objects\\\"\\n    participant Redis as \\\"Redis Message Bus\\u003cbr/\\u003eself.raw_redis\\\"\\n    participant CTP as \\\"CTP Gateway Process\\\"\\n    participant CB as \\\"Callback Handler\\u003cbr/\\u003eOnRtnTrade()\\\"\\n    \\n    Cron-\\u003e\\u003eTS: Trigger at 08:55 (crontab)\\n    TS-\\u003e\\u003eDB: Query unprocessed signals\\n    DB--\\u003e\\u003eTS: Signal instances\\n    \\n    loop For each signal\\n        TS-\\u003e\\u003eTS: ReqOrderInsert(signal)\\n        Note over TS: Build order params\\u003cbr/\\u003eLines 302-340\\n        TS-\\u003e\\u003eRedis: publish(MSG:CTP:REQ:ReqOrderInsert)\\n        Redis-\\u003e\\u003eCTP: Forward order request\\n        CTP--\\u003e\\u003eRedis: OnRtnOrder (status update)\\n        Redis--\\u003e\\u003eCB: Pattern match: MSG:CTP:RSP:TRADE:OnRtnOrder:*\\n        CB-\\u003e\\u003eDB: Create/Update Order instance\\n        \\n        alt Order Filled\\n            CTP--\\u003e\\u003eRedis: OnRtnTrade (execution)\\n            Redis--\\u003e\\u003eCB: Pattern match: MSG:CTP:RSP:TRADE:OnRtnTrade:*\\n            CB-\\u003e\\u003eDB: Update Trade instance\\n            CB-\\u003e\\u003eDB: Mark signal.processed = True\\n        end\\n    end\\n```\\n\\n**Component Interaction During Order Execution**\\n\\n**Key Interaction Points**:\\n\\n1. **Cron Trigger** [trader/strategy/__init__.py:74-78](): `_call_next()` schedules and executes cron callbacks\\n2. **Signal Query** [trader/strategy/brother2.py:579-580](): Django ORM filters unprocessed signals\\n3. **Order Insert** [trader/strategy/brother2.py:301-343](): Constructs CTP order parameters and publishes to Redis\\n4. **Message Routing** [trader/strategy/__init__.py:110-121](): `_msg_reader()` receives Redis messages and routes to decorated callbacks\\n5. **Trade Recording** [trader/strategy/brother2.py:392-469](): `OnRtnTrade()` updates Trade model with execution details\\n6. **Signal Completion** [trader/strategy/brother2.py:463-467](): Marks signal as processed when order is fully filled\\n\\nSources: [trader/strategy/__init__.py:74-78, 110-121](), [trader/strategy/brother2.py:301-343, 392-469, 579-580]()\\n\\n## Component Dependencies\\n\\nThe following table summarizes the import dependencies between major components:\\n\\n| Component | Imports From | Purpose |\\n|-----------|--------------|---------|\\n| `TradeStrategy` | `BaseModule` | Inherit framework infrastructure |\\n| `TradeStrategy` | `trader.utils` | Access data fetching and calculation functions |\\n| `TradeStrategy` | `panel.models` | Persist and query trading data |\\n| `TradeStrategy` | `trader.utils.read_config` | Load configuration and error mappings |\\n| `BaseModule` | `trader.utils.func_container` | Use `CallbackFunctionContainer` for decorator support |\\n| `BaseModule` | `trader.utils.read_config` | Load Redis connection settings |\\n| `trader.utils` | `panel.models` | Store DailyBar, MainBar, Instrument data |\\n| `trader.utils` | `trader.utils.read_config` | Access exchange URLs and ignore lists |\\n| All components | `aioredis`, `redis` | Async and sync Redis operations |\\n| All components | `django` | ORM, timezone utilities, database connection |\\n\\nSources: [trader/strategy/brother2.py:16-32](), [trader/strategy/__init__.py:16-31](), [trader/utils/__init__.py:16-38]()\"])</script><script>self.__next_f.push([1,\"1e:T6c9e,\"])</script><script>self.__next_f.push([1,\"# Data Flow Pipeline\\n\\n\\u003cdetails\\u003e\\n\\u003csummary\\u003eRelevant source files\\u003c/summary\\u003e\\n\\nThe following files were used as context for generating this wiki page:\\n\\n- [panel/models.py](panel/models.py)\\n- [trader/strategy/brother2.py](trader/strategy/brother2.py)\\n- [trader/utils/__init__.py](trader/utils/__init__.py)\\n- [trader/utils/fetch_data.py](trader/utils/fetch_data.py)\\n\\n\\u003c/details\\u003e\\n\\n\\n\\n## Purpose and Scope\\n\\nThis document describes the complete data flow pipeline in the trader system, from fetching raw market data from Chinese commodity exchanges to generating trading signals and executing orders. The pipeline processes daily OHLC (Open, High, Low, Close) data through multiple transformation stages to support both historical backtesting and live trading.\\n\\nFor details about the models used in this pipeline, see [Data Models](#5.1). For information about how signals are calculated and executed, see [Signal Generation](#4.3) and [Order Execution Flow](#4.4).\\n\\n## Pipeline Overview\\n\\nThe data flow pipeline consists of six major stages that transform raw exchange data into trading decisions and performance metrics:\\n\\n```mermaid\\nflowchart TD\\n    Stage1[\\\"Stage 1: Daily Data Acquisition\\u003cbr/\\u003eupdate_from_shfe/dce/czce/cffex/gfex\\\"]\\n    Stage2[\\\"Stage 2: DailyBar Storage\\u003cbr/\\u003epanel.models.DailyBar\\\"]\\n    Stage3[\\\"Stage 3: Main Contract Identification\\u003cbr/\\u003ecalc_main_inst\\\"]\\n    Stage4[\\\"Stage 4: Continuous Series Construction\\u003cbr/\\u003epanel.models.MainBar + handle_rollover\\\"]\\n    Stage5[\\\"Stage 5: Signal Generation\\u003cbr/\\u003ecalc_signal / calc_history_signal\\\"]\\n    Stage6[\\\"Stage 6: Order Execution\\u003cbr/\\u003eReqOrderInsert  OnRtnTrade\\\"]\\n    Stage7[\\\"Stage 7: Performance Tracking\\u003cbr/\\u003epanel.models.Performance\\\"]\\n    \\n    Stage1 --\\u003e Stage2\\n    Stage2 --\\u003e Stage3\\n    Stage3 --\\u003e Stage4\\n    Stage4 --\\u003e Stage5\\n    Stage5 --\\u003e Stage6\\n    Stage6 --\\u003e Stage7\\n    \\n    Stage4 -.-\\u003e|\\\"Historical Backtest\\\"| Stage5\\n    Stage4 -.-\\u003e|\\\"Live Trading\\\"| Stage5\\n```\\n\\n**Sources:** [trader/utils/__init__.py:121-796](), [trader/strategy/brother2.py:684-724](), [panel/models.py:194-235]()\\n\\n## Stage 1: Daily Data Acquisition\\n\\nThe system fetches daily market data from five Chinese commodity exchanges using asynchronous HTTP requests. Each exchange provides data in a different format (JSON, XML, or text), requiring exchange-specific parsing logic.\\n\\n```mermaid\\nflowchart LR\\n    subgraph Exchanges[\\\"Exchange APIs\\\"]\\n        SHFE[\\\"SHFE\\u003cbr/\\u003e\\u003cbr/\\u003eJSON format\\\"]\\n        DCE[\\\"DCE\\u003cbr/\\u003e\\u003cbr/\\u003eText/Table format\\\"]\\n        CZCE[\\\"CZCE\\u003cbr/\\u003e\\u003cbr/\\u003eText/Pipe-delimited\\\"]\\n        CFFEX[\\\"CFFEX\\u003cbr/\\u003e\\u003cbr/\\u003eXML format\\\"]\\n        GFEX[\\\"GFEX\\u003cbr/\\u003e\\u003cbr/\\u003eJSON format\\\"]\\n    end\\n    \\n    subgraph Functions[\\\"Async Update Functions\\\"]\\n        UpdateSHFE[\\\"update_from_shfe\\u003cbr/\\u003etrader/utils/__init__.py:121-174\\\"]\\n        UpdateDCE[\\\"update_from_dce\\u003cbr/\\u003etrader/utils/__init__.py:220-265\\\"]\\n        UpdateCZCE[\\\"update_from_czce\\u003cbr/\\u003etrader/utils/__init__.py:177-217\\\"]\\n        UpdateCFFEX[\\\"update_from_cffex\\u003cbr/\\u003etrader/utils/__init__.py:296-349\\\"]\\n        UpdateGFEX[\\\"update_from_gfex\\u003cbr/\\u003etrader/utils/__init__.py:268-293\\\"]\\n    end\\n    \\n    subgraph Orchestration[\\\"Orchestration\\\"]\\n        CollectQuote[\\\"TradeStrategy.collect_quote\\u003cbr/\\u003eCron: 17:00 daily\\u003cbr/\\u003ebrother2.py:684-703\\\"]\\n    end\\n    \\n    SHFE --\\u003e|\\\"HTTP GET\\u003cbr/\\u003ekx{date}.dat\\\"| UpdateSHFE\\n    DCE --\\u003e|\\\"HTTP POST\\u003cbr/\\u003eexportDayQuotesChData.html\\\"| UpdateDCE\\n    CZCE --\\u003e|\\\"HTTP GET\\u003cbr/\\u003eFutureDataDaily.txt\\\"| UpdateCZCE\\n    CFFEX --\\u003e|\\\"HTTP GET\\u003cbr/\\u003eindex.xml\\\"| UpdateCFFEX\\n    GFEX --\\u003e|\\\"HTTP POST\\u003cbr/\\u003egetQuote_ftr\\\"| UpdateGFEX\\n    \\n    CollectQuote --\\u003e UpdateSHFE\\n    CollectQuote --\\u003e UpdateDCE\\n    CollectQuote --\\u003e UpdateCZCE\\n    CollectQuote --\\u003e UpdateCFFEX\\n    CollectQuote --\\u003e UpdateGFEX\\n```\\n\\n### Data Acquisition Process\\n\\nThe `TradeStrategy.collect_quote` method orchestrates the data acquisition process:\\n\\n1. **Scheduled Trigger**: Executes daily at 17:00 (after market close) via cron scheduling\\n2. **Parallel Fetching**: Launches all five update functions concurrently using `asyncio.gather`\\n3. **Retry Logic**: If any exchange fetch fails, retries after 10 minutes with only failed tasks\\n4. **Calculation Trigger**: Once all exchanges succeed, triggers the `calculate` method\\n\\n**Data Format Examples:**\\n\\n| Exchange | Format | Key Fields | Sample Record |\\n|----------|--------|------------|---------------|\\n| SHFE | JSON | PRODUCTID, DELIVERYMONTH, OPENPRICE, HIGHESTPRICE, LOWESTPRICE, CLOSEPRICE, SETTLEMENTPRICE, VOLUME, OPENINTEREST | `{\\\"PRODUCTID\\\":\\\"cu_f\\\", \\\"DELIVERYMONTH\\\":\\\"2112\\\", \\\"OPENPRICE\\\":69770, \\\"CLOSEPRICE\\\":69900, ...}` |\\n| DCE | Tab-delimited text | , , , , , , , ,  | `['', '1611', '3,760', '3,760', '3,760', '3,760', '3,860', '3,760', '2', '0']` |\\n| CZCE | Pipe/Comma-delimited | , , , , , , , ,  | `['CF601', '11,970.00', '11,970.00', '11,970.00', '11,800.00', '11,870.00', '11,905.00', '13,826', '59,140']` |\\n| CFFEX | XML | instrumentid, openprice, highestprice, lowestprice, closeprice, settlementprice, volume, openinterest | `\\u003cinstrumentid\\u003eIC2112\\u003c/instrumentid\\u003e\\u003copenprice\\u003e7272\\u003c/openprice\\u003e...` |\\n| GFEX | JSON | openPrice, highPrice, lowPrice, closePrice, clearPrice, matchTotQty, openInterest | `{\\\"openPrice\\\": 5200, \\\"highPrice\\\": 5250, \\\"closePrice\\\": 5210, ...}` |\\n\\n**Sources:** [trader/strategy/brother2.py:684-703](), [trader/utils/__init__.py:121-349]()\\n\\n## Stage 2: DailyBar Storage\\n\\nRaw exchange data is parsed and stored in the `DailyBar` model, which represents individual contract prices for a specific date.\\n\\n```mermaid\\nflowchart TB\\n    subgraph Parsing[\\\"Data Parsing\\\"]\\n        ParseLogic[\\\"Parse exchange-specific format\\u003cbr/\\u003eExtract: code, expire_date, OHLC, settlement, volume, open_interest\\\"]\\n    end\\n    \\n    subgraph Validation[\\\"Data Validation\\\"]\\n        FilterIgnored[\\\"Filter ignored instruments\\u003cbr/\\u003eIGNORE_INST_LIST = WH,bb,JR,RI,RS,LR,PM,im\\\"]\\n        ValidateFields[\\\"Validate numeric fields\\u003cbr/\\u003eUse close price if OHLC missing\\\"]\\n    end\\n    \\n    subgraph Storage[\\\"Database Storage\\\"]\\n        DailyBarModel[\\\"DailyBar.objects.update_or_create\\u003cbr/\\u003epanel/models.py:216-235\\u003cbr/\\u003eUnique: (exchange, code, time)\\\"]\\n    end\\n    \\n    ParseLogic --\\u003e FilterIgnored\\n    FilterIgnored --\\u003e ValidateFields\\n    ValidateFields --\\u003e DailyBarModel\\n```\\n\\n### DailyBar Model Structure\\n\\n| Field | Type | Description | Example |\\n|-------|------|-------------|---------|\\n| `exchange` | CharField(8) | Exchange identifier | `'SHFE'`, `'DCE'`, `'CZCE'`, `'CFFEX'`, `'GFEX'`, `'INE'` |\\n| `code` | CharField(16) | Full contract code | `'cu2112'`, `'a2201'`, `'CF601'`, `'IC2112'` |\\n| `expire_date` | IntegerField | Contract expiry date | `2112`, `2201` |\\n| `time` | DateField | Trading date | `2021-12-09` |\\n| `open` | Decimal(12,3) | Opening price | `69770.000` |\\n| `high` | Decimal(12,3) | Highest price | `70280.000` |\\n| `low` | Decimal(12,3) | Lowest price | `69600.000` |\\n| `close` | Decimal(12,3) | Closing price | `69900.000` |\\n| `settlement` | Decimal(12,3) | Settlement price | `69950.000` |\\n| `volume` | IntegerField | Trading volume | `19450` |\\n| `open_interest` | Decimal(12,3) | Open interest | `19065.000` |\\n\\n**Key Implementation Details:**\\n\\n- Uses `update_or_create` to avoid duplicates and handle reprocessing\\n- Handles missing OHLC values by falling back to close price\\n- Filters instruments in the ignore list (low-liquidity or deprecated contracts)\\n- Removes commas from numeric strings before conversion\\n- Distinguishes Shanghai International Energy Exchange (INE) products from SHFE\\n\\n**Sources:** [panel/models.py:216-235](), [trader/utils/__init__.py:121-349]()\\n\\n## Stage 3: Main Contract Identification\\n\\nThe `calc_main_inst` function identifies which contract should be considered the \\\"main\\\" contract for each instrument at any given time. The main contract is typically the most liquid contract and is used for continuous price series construction.\\n\\n```mermaid\\nflowchart TD\\n    Start[\\\"calc_main_inst called\\u003cbr/\\u003etrader/utils/__init__.py:381-421\\\"]\\n    \\n    Condition1{\\\"Condition 1:\\u003cbr/\\u003evolume  10,000 AND\\u003cbr/\\u003eopen_interest  10,000 AND\\u003cbr/\\u003ehighest volume?\\u003cbr/\\u003e(OR CFFEX exchange)\\\"}\\n    \\n    Condition2{\\\"Condition 2:\\u003cbr/\\u003eSame contract has\\u003cbr/\\u003ehighest volume for\\u003cbr/\\u003e3 consecutive days?\\\"}\\n    \\n    Condition3{\\\"Condition 3:\\u003cbr/\\u003eTake highest volume\\u003cbr/\\u003econtract among\\u003cbr/\\u003eremaining candidates\\\"}\\n    \\n    CheckChange{\\\"Main contract\\u003cbr/\\u003echanged?\\\"}\\n    \\n    UpdateInst[\\\"Update Instrument:\\u003cbr/\\u003elast_main = old main_code\\u003cbr/\\u003emain_code = new code\\u003cbr/\\u003echange_time = today\\\"]\\n    \\n    StoreBar[\\\"store_main_bar\\u003cbr/\\u003eCreate MainBar record\\u003cbr/\\u003etrader/utils/__init__.py:352-362\\\"]\\n    \\n    HandleRollover[\\\"handle_rollover\\u003cbr/\\u003eApply basis adjustment\\u003cbr/\\u003etrader/utils/__init__.py:365-378\\\"]\\n    \\n    End[\\\"Return main_code, updated\\\"]\\n    \\n    Start --\\u003e Condition1\\n    Condition1 --\\u003e|Yes| StoreBar\\n    Condition1 --\\u003e|No| Condition2\\n    Condition2 --\\u003e|Yes| StoreBar\\n    Condition2 --\\u003e|No| Condition3\\n    Condition3 --\\u003e StoreBar\\n    StoreBar --\\u003e CheckChange\\n    CheckChange --\\u003e|Yes, and new \\u003e old| UpdateInst\\n    CheckChange --\\u003e|No| End\\n    UpdateInst --\\u003e HandleRollover\\n    HandleRollover --\\u003e End\\n```\\n\\n### Main Contract Selection Logic\\n\\nThe algorithm uses a three-tier fallback strategy:\\n\\n**Tier 1: Volume and Open Interest Threshold**\\n```\\nQuery DailyBar.objects.filter(\\n    (exchange == CFFEX) OR (volume \\u003e= 10,000 AND open_interest \\u003e= 10,000),\\n    exchange = inst.exchange,\\n    code matches ^{product_code}[0-9]+,\\n    expire_date \\u003e= current_main_expire_date,\\n    time = today\\n).order_by('-volume').first()\\n```\\n\\n**Tier 2: Three-Day Consecutive Volume Leader**\\n```sql\\nSELECT a.* FROM panel_dailybar a \\nINNER JOIN (\\n    SELECT time, max(volume) v \\n    FROM panel_dailybar \\n    WHERE CODE RLIKE '^{product_code}[0-9]+' \\n    AND time \\u003c= today \\n    GROUP BY time \\n    ORDER BY time DESC \\n    LIMIT 3\\n) b \\nWHERE a.time = b.time AND a.volume = b.v \\nORDER BY a.time DESC LIMIT 3\\n```\\nReturns a contract only if the same contract code appears in all 3 records.\\n\\n**Tier 3: Highest Current Volume**\\n```\\nQuery DailyBar.objects.filter(\\n    exchange = inst.exchange,\\n    code matches ^{product_code}[0-9]+,\\n    expire_date \\u003e= current_main_expire_date,\\n    time = today\\n).order_by('-volume', '-open_interest', 'code').first()\\n```\\n\\n**Rollover Trigger Conditions:**\\n- New contract identified AND\\n- `new_code != current_main_code` AND  \\n- `new_code \\u003e current_main_code` (prevents backward rollover)\\n\\n**Sources:** [trader/utils/__init__.py:381-421](), [trader/strategy/brother2.py:705-724]()\\n\\n## Stage 4: Continuous Series Construction\\n\\nWhen a main contract rollover occurs, the system creates a continuous price series by applying basis adjustments to historical MainBar records. This ensures technical indicators calculated on the continuous series remain meaningful across contract transitions.\\n\\n```mermaid\\nflowchart TD\\n    Detect[\\\"Main contract change detected\\u003cbr/\\u003enew_code \\u003e old main_code\\\"]\\n    \\n    GetBars[\\\"Fetch both contracts' DailyBar\\u003cbr/\\u003efor rollover date:\\u003cbr/\\u003eold_bar = DailyBar(code=last_main)\\u003cbr/\\u003enew_bar = DailyBar(code=main_code)\\\"]\\n    \\n    CalcBasis[\\\"Calculate basis:\\u003cbr/\\u003ebasis = new_bar.close - old_bar.close\\\"]\\n    \\n    UpdateCurrent[\\\"Create MainBar for today:\\u003cbr/\\u003ecode = new_bar.code\\u003cbr/\\u003eOHLC = new_bar OHLC\\u003cbr/\\u003ebasis = calculated basis\\\"]\\n    \\n    AdjustHistory[\\\"Adjust all historical MainBar:\\u003cbr/\\u003eMainBar.filter(time \\u003c today).update(\\u003cbr/\\u003e  open = F('open') + basis,\\u003cbr/\\u003e  high = F('high') + basis,\\u003cbr/\\u003e  low = F('low') + basis,\\u003cbr/\\u003e  close = F('close') + basis,\\u003cbr/\\u003e  settlement = F('settlement') + basis\\u003cbr/\\u003e)\\\"]\\n    \\n    Detect --\\u003e GetBars\\n    GetBars --\\u003e CalcBasis\\n    CalcBasis --\\u003e UpdateCurrent\\n    UpdateCurrent --\\u003e AdjustHistory\\n```\\n\\n### Rollover Adjustment Example\\n\\nConsider copper (cu) rolling from cu2112 to cu2201:\\n\\n| Date | Old Main (cu2112) | New Main (cu2201) | Event |\\n|------|-------------------|-------------------|-------|\\n| 2021-12-15 | Close: 69,900 | Close: 70,100 | - |\\n| 2021-12-16 | Close: 69,850 | Close: 70,150 | Rollover triggered, basis = 70,150 - 69,850 = 300 |\\n\\n**Historical MainBar Adjustment:**\\n```\\nAll MainBar records with time \\u003c 2021-12-16:\\n  open = open + 300\\n  high = high + 300  \\n  low = low + 300\\n  close = close + 300\\n  settlement = settlement + 300\\n```\\n\\nThis adjustment ensures that:\\n1. The continuous series shows no artificial gap at the rollover point\\n2. Price levels remain consistent for technical analysis\\n3. ATR and other indicators calculated across rollover dates remain valid\\n\\n### MainBar Model Structure\\n\\n| Field | Type | Description | Notes |\\n|-------|------|-------------|-------|\\n| `exchange` | CharField(8) | Exchange identifier | Indexed for queries |\\n| `product_code` | CharField(8) | Product identifier (e.g., 'cu', 'a') | Indexed for queries |\\n| `code` | CharField(16) | Current main contract code | Changes at rollover |\\n| `time` | DateField | Trading date | Indexed for time-series queries |\\n| `open`, `high`, `low`, `close` | Decimal(12,3) | OHLC prices | Adjusted on rollover |\\n| `settlement` | Decimal(12,3) | Settlement price | Adjusted on rollover |\\n| `volume` | IntegerField | Trading volume | Not adjusted |\\n| `open_interest` | Decimal(12,3) | Open interest | Not adjusted |\\n| `basis` | Decimal(12,3) | Rollover basis adjustment | Set at rollover date |\\n\\n**Sources:** [trader/utils/__init__.py:352-378](), [panel/models.py:194-213]()\\n\\n## Stage 5: Signal Generation\\n\\nThe system generates trading signals using technical analysis on the MainBar continuous series. Signals are created in two contexts: historical backtesting (`calc_history_signal`) and live trading (`calc_signal`).\\n\\n```mermaid\\nflowchart TD\\n    subgraph LiveTrading[\\\"Live Signal Generation\\\"]\\n        Calculate[\\\"TradeStrategy.calculate\\u003cbr/\\u003eCalled after collect_quote\\u003cbr/\\u003ebrother2.py:705-723\\\"]\\n        CalcSignal[\\\"TradeStrategy.calc_signal\\u003cbr/\\u003eFor each instrument\\u003cbr/\\u003ebrother2.py:725-869\\\"]\\n        LoadParams[\\\"Load strategy parameters:\\u003cbr/\\u003ebreak_n, atr_n, long_n, short_n, stop_n, risk\\\"]\\n        FetchBars[\\\"Fetch MainBar:\\u003cbr/\\u003efilter(time \\u003c= day, product_code=inst)\\u003cbr/\\u003eorder_by('-time')[:400]\\\"]\\n        CalcIndicators[\\\"Calculate indicators:\\u003cbr/\\u003eATR(atr_n)\\u003cbr/\\u003eSMA short_trend(short_n)\\u003cbr/\\u003eSMA long_trend(long_n)\\u003cbr/\\u003ehigh_line = rolling_max(break_n)\\u003cbr/\\u003elow_line = rolling_min(break_n)\\\"]\\n        CheckPos[\\\"Check existing position:\\u003cbr/\\u003eTrade.filter(close_time=null)\\\"]\\n        GenSignal[\\\"Generate Signal based on:\\u003cbr/\\u003e1. Entry: trend + breakout\\u003cbr/\\u003e2. Exit: ATR stop loss\\u003cbr/\\u003e3. Rollover: code change\\\"]\\n        CreateSignal[\\\"Signal.objects.update_or_create\\u003cbr/\\u003epanel/models.py:173-192\\\"]\\n        \\n        Calculate --\\u003e CalcSignal\\n        CalcSignal --\\u003e LoadParams\\n        LoadParams --\\u003e FetchBars\\n        FetchBars --\\u003e CalcIndicators\\n        CalcIndicators --\\u003e CheckPos\\n        CheckPos --\\u003e GenSignal\\n        GenSignal --\\u003e CreateSignal\\n    end\\n    \\n    subgraph Historical[\\\"Historical Backtest\\\"]\\n        CalcHistory[\\\"calc_history_signal\\u003cbr/\\u003etrader/utils/__init__.py:500-600\\\"]\\n        HistFetch[\\\"Fetch all MainBar history:\\u003cbr/\\u003efilter(time \\u003c= day)\\\"]\\n        HistIndicators[\\\"Calculate same indicators\\u003cbr/\\u003eover full history\\\"]\\n        Simulate[\\\"Simulate trades:\\u003cbr/\\u003eLoop through each day\\u003cbr/\\u003eTrack position state\\u003cbr/\\u003eGenerate signals \\u0026 trades\\\"]\\n        \\n        CalcHistory --\\u003e HistFetch\\n        HistFetch --\\u003e HistIndicators\\n        HistIndicators --\\u003e Simulate\\n    end\\n```\\n\\n### Signal Generation Logic\\n\\n**Entry Signals:**\\n\\n| Signal Type | Condition | Code Reference |\\n|------------|-----------|----------------|\\n| BUY (Long Entry) | `short_trend \\u003e long_trend AND close \\u003e= high_line[previous]` | [brother2.py:746]() |\\n| SELL_SHORT (Short Entry) | `short_trend \\u003c long_trend AND close \\u003c= low_line[previous]` | [brother2.py:747]() |\\n\\n**Exit Signals:**\\n\\n| Signal Type | Condition | Code Reference |\\n|------------|-----------|----------------|\\n| SELL (Long Exit) | `close \\u003c= highest_high_since_entry - ATR[entry] * stop_n` | [brother2.py:776]() |\\n| BUY_COVER (Short Exit) | `close \\u003e= lowest_low_since_entry + ATR[entry] * stop_n` | [brother2.py:806]() |\\n\\n**Rollover Signals:**\\n\\n| Signal Type | Condition | Code Reference |\\n|------------|-----------|----------------|\\n| ROLL_CLOSE | `position.code != inst.main_code AND position.code \\u003c inst.main_code` | [brother2.py:751]() |\\n| ROLL_OPEN | Generated after ROLL_CLOSE for same volume | [brother2.py:784-793]() |\\n\\n### Technical Indicators Calculation\\n\\n**ATR (Average True Range):**\\n```python\\nfrom talib import ATR\\ndf[\\\"atr\\\"] = ATR(df.high, df.low, df.close, timeperiod=atr_n)\\n```\\n\\n**SMA (Simple Moving Average) - Manual Implementation:**\\n```python\\n# trader/utils/__init__.py:516-517 and brother2.py:740-742\\nfor idx in range(1, df.shape[0]):\\n    df.short_trend[idx] = (df.short_trend[idx-1] * (short_n - 1) + df.close[idx]) / short_n\\n    df.long_trend[idx] = (df.long_trend[idx-1] * (long_n - 1) + df.close[idx]) / long_n\\n```\\n\\n**Breakout Channels:**\\n```python\\ndf[\\\"high_line\\\"] = df.close.rolling(window=break_n).max()\\ndf[\\\"low_line\\\"] = df.close.rolling(window=break_n).min()\\n```\\n\\n### Signal Model Structure\\n\\n| Field | Type | Description | Example |\\n|-------|------|-------------|---------|\\n| `strategy` | ForeignKey | Strategy that generated signal | Strategy object |\\n| `instrument` | ForeignKey | Instrument to trade | Instrument(product_code='cu') |\\n| `code` | CharField(16) | Specific contract code | `'cu2112'` |\\n| `type` | CharField(16) | Signal type | `'BUY'`, `'SELL'`, `'ROLL_OPEN'`, etc. |\\n| `trigger_value` | Decimal(12,3) | ATR at signal generation | Used for position sizing |\\n| `price` | Decimal(12,3) | Limit order price | Calculated based on limit price |\\n| `volume` | IntegerField | Number of contracts | Based on risk management |\\n| `trigger_time` | DateTimeField | When signal was generated | Used for filtering |\\n| `priority` | IntegerField | Processing priority | HIGH, NORMAL, LOW |\\n| `processed` | BooleanField | Whether order was sent | False until executed |\\n\\n**Sources:** [trader/strategy/brother2.py:725-869](), [trader/utils/__init__.py:500-600](), [panel/models.py:173-192]()\\n\\n## Stage 6: Order Execution and Trade Recording\\n\\nSignals are processed during pre-market sessions and converted into orders sent to the CTP API. Trade confirmations update position records in real-time.\\n\\n```mermaid\\nsequenceDiagram\\n    participant Cron as Cron Scheduler\\n    participant Strategy as TradeStrategy\\n    participant DB as Django ORM\\n    participant Redis as Redis Pub/Sub\\n    participant CTP as CTP API\\n    \\n    Note over Cron,Strategy: Pre-market: 08:55, 09:25, 20:55\\n    \\n    Cron-\\u003e\\u003eStrategy: processing_signal1/2/3()\\n    Strategy-\\u003e\\u003eDB: Query unprocessed Signals:\\u003cbr/\\u003eSignal.filter(processed=False)\\n    DB--\\u003e\\u003eStrategy: List of signals\\n    \\n    loop For each signal\\n        Strategy-\\u003e\\u003eStrategy: ReqOrderInsert(signal)\\u003cbr/\\u003ebrother2.py:301-343\\n        Note over Strategy: Generate OrderRef:\\u003cbr/\\u003eAutonumber.create().id\\u003cbr/\\u003e+ signal.id\\n        Strategy-\\u003e\\u003eRedis: Publish to MSG:CTP:REQ:ReqOrderInsert\\n        \\n        Redis-\\u003e\\u003eCTP: Forward order request\\n        CTP--\\u003e\\u003eRedis: OnRtnOrder (status update)\\n        Redis--\\u003e\\u003eStrategy: Subscribe MSG:CTP:RSP:TRADE:OnRtnOrder:{OrderRef}\\n        Strategy-\\u003e\\u003eStrategy: save_order(order)\\u003cbr/\\u003ebrother2.py:472-495\\n        Strategy-\\u003e\\u003eDB: Order.update_or_create\\n        \\n        alt Order Filled\\n            CTP--\\u003e\\u003eRedis: OnRtnTrade\\n            Redis--\\u003e\\u003eStrategy: Subscribe MSG:CTP:RSP:TRADE:OnRtnTrade:{OrderRef}\\n            Strategy-\\u003e\\u003eStrategy: OnRtnTrade callback\\u003cbr/\\u003ebrother2.py:391-469\\n            \\n            alt Opening Position\\n                Strategy-\\u003e\\u003eDB: Trade.create or update:\\u003cbr/\\u003eavg_entry_price, filled_shares, cost\\n            else Closing Position\\n                Strategy-\\u003e\\u003eDB: Trade.update:\\u003cbr/\\u003eavg_exit_price, closed_shares,\\u003cbr/\\u003eprofit = (exit - entry) * volume * multiplier\\n            end\\n            \\n            Strategy-\\u003e\\u003eDB: Signal.update(processed=True)\\n        end\\n    end\\n```\\n\\n### Order Reference Generation\\n\\nEach order is assigned a unique 12-character `OrderRef`:\\n\\n```\\nFormat: AAAAAAAIIIII\\nWhere:\\n  AAAAAAA = 7-digit Autonumber ID (auto-incrementing)\\n  IIIII   = 5-digit Signal ID\\n```\\n\\nThis encoding allows the system to:\\n1. Track which signal generated which order\\n2. Distinguish system-generated orders (OrderRef \\u003e= 10000) from manual trades\\n3. Route trade confirmations back to the originating signal\\n\\n**Sources:** [trader/strategy/brother2.py:301-305](), [ORDER_REF_SIGNAL_ID_START constant]()\\n\\n### Trade Model State Transitions\\n\\n```mermaid\\nstateDiagram-v2\\n    [*] --\\u003e OpenPending: Signal processed, order sent\\n    OpenPending --\\u003e PartiallyFilled: OnRtnTrade (opening)\\n    PartiallyFilled --\\u003e PartiallyFilled: More fills\\n    PartiallyFilled --\\u003e FullyOpen: filled_shares == shares\\n    OpenPending --\\u003e FullyOpen: OnRtnTrade (all at once)\\n    \\n    FullyOpen --\\u003e ClosePending: Exit signal generated\\n    ClosePending --\\u003e PartiallyClosing: OnRtnTrade (closing)\\n    PartiallyClosing --\\u003e PartiallyClosing: More fills\\n    PartiallyClosing --\\u003e Closed: closed_shares == shares\\n    ClosePending --\\u003e Closed: OnRtnTrade (all at once)\\n    \\n    Closed --\\u003e [*]\\n```\\n\\n**Trade Record Fields During Lifecycle:**\\n\\n| State | Key Fields | Description |\\n|-------|------------|-------------|\\n| **Open Pending** | `shares`, `open_order` | Order sent, awaiting fills |\\n| **Partially Filled** | `filled_shares \\u003c shares` | Some fills received |\\n| **Fully Open** | `filled_shares == shares`, `close_time = null` | Position established |\\n| **Close Pending** | `close_order` set | Exit order sent |\\n| **Partially Closing** | `closed_shares \\u003c shares` | Partial exit fills |\\n| **Closed** | `closed_shares == shares`, `close_time` set, `profit` calculated | Position fully closed |\\n\\n**Profit Calculation:**\\n```python\\n# For long positions:\\nprofit = (avg_exit_price - avg_entry_price) * shares * volume_multiple\\n\\n# For short positions:\\nprofit = (avg_entry_price - avg_exit_price) * shares * volume_multiple\\n```\\n\\n**Sources:** [trader/strategy/brother2.py:391-469](), [panel/models.py:262-289]()\\n\\n## Stage 7: Performance Tracking\\n\\nDaily performance metrics are calculated and stored after market close (15:30), tracking account equity, NAV, and risk metrics.\\n\\n```mermaid\\nflowchart TD\\n    Trigger[\\\"Cron trigger: 15:30 daily\\u003cbr/\\u003eupdate_equity method\\u003cbr/\\u003ebrother2.py:656-682\\\"]\\n    \\n    RefreshData[\\\"refresh_account executed at 15:20:\\u003cbr/\\u003eQuery CTP for account data\\u003cbr/\\u003ebrother2.py:86-112\\\"]\\n    \\n    CalcEquity[\\\"Calculate equity components:\\u003cbr/\\u003ecurrent = pre_balance + close_profit\\u003cbr/\\u003e  + position_profit - commission\\u003cbr/\\u003ecash = available\\u003cbr/\\u003emargin = curr_margin\\\"]\\n    \\n    CalcDividend[\\\"Calculate cumulative dividend:\\u003cbr/\\u003edividend = sum(past dividends)\\u003cbr/\\u003e  + deposit - withdraw\\\"]\\n    \\n    CalcFake[\\\"Adjust virtual capital:\\u003cbr/\\u003efake = original_fake - deposit + withdraw\\\"]\\n    \\n    CalcNAV[\\\"Calculate NAV:\\u003cbr/\\u003eunit = dividend + fake\\u003cbr/\\u003eNAV = (current + fake) / unit\\u003cbr/\\u003eaccumulated = current / (unit - fake)\\\"]\\n    \\n    StorePerf[\\\"Performance.update_or_create:\\u003cbr/\\u003ebroker, day, capital, NAV,\\u003cbr/\\u003eaccumulated, used_margin,\\u003cbr/\\u003edividend, fake\\\"]\\n    \\n    Trigger --\\u003e RefreshData\\n    RefreshData --\\u003e CalcEquity\\n    CalcEquity --\\u003e CalcDividend\\n    CalcDividend --\\u003e CalcFake\\n    CalcFake --\\u003e CalcNAV\\n    CalcNAV --\\u003e StorePerf\\n```\\n\\n### Performance Metrics\\n\\n**Key Formulas:**\\n\\n| Metric | Formula | Description |\\n|--------|---------|-------------|\\n| **Static Equity** | `pre_balance + deposit - withdraw` | Previous settlement + net cash flow |\\n| **Dynamic Equity** | `static_equity + close_profit + position_profit - commission` | Current total value |\\n| **Available Cash** | `cash = CTP available` | Withdrawable funds |\\n| **Unit Count** | `unit = cumulative_dividend + fake` | Total virtual units |\\n| **NAV** | `(current + fake) / unit` | Net asset value per unit |\\n| **Accumulated NAV** | `current / (unit - fake)` | Excluding virtual capital |\\n| **Risk Ratio** | `margin / current` | Margin usage percentage |\\n\\n**Performance Model Structure:**\\n\\n| Field | Type | Description |\\n|-------|------|-------------|\\n| `broker` | ForeignKey | Account reference |\\n| `day` | DateField | Trading date |\\n| `capital` | Decimal(12,2) | Dynamic equity |\\n| `unit_count` | IntegerField | Virtual units outstanding |\\n| `NAV` | Decimal(8,3) | Net asset value |\\n| `accumulated` | Decimal(8,3) | Accumulated NAV |\\n| `dividend` | Decimal(12,2) | Net deposit/withdrawal |\\n| `used_margin` | Decimal(12,2) | Occupied margin |\\n| `fake` | Decimal(12,2) | Virtual capital |\\n\\n**Sources:** [trader/strategy/brother2.py:656-682](), [trader/strategy/brother2.py:86-112](), [panel/models.py:85-101]()\\n\\n## Complete Daily Cycle\\n\\nThe following diagram shows how all stages interact during a complete trading day:\\n\\n```mermaid\\ngantt\\n    title Daily Pipeline Execution Schedule\\n    dateFormat HH:mm\\n    axisFormat %H:%M\\n    \\n    section Night Session\\n    Night signal processing    :20:55, 5m\\n    Night trading              :21:00, 150m\\n    \\n    section Morning Data\\n    Morning signal processing  :08:55, 5m\\n    Day trading starts         :09:00, 120m\\n    Stock index processing     :09:25, 5m\\n    \\n    section Afternoon Close\\n    Market close               :15:00, 0m\\n    Refresh account/positions  :15:20, 10m\\n    Update equity/performance  :15:30, 5m\\n    \\n    section Evening Processing\\n    Collect exchange data      :17:00, 30m\\n    Calculate main contracts   :17:30, 10m\\n    Generate signals           :17:40, 20m\\n```\\n\\n### Scheduled Task Summary\\n\\n| Time | Task | Method | Description |\\n|------|------|--------|-------------|\\n| **08:55** | Process day session signals (non-CFFEX) | `processing_signal1` | Query signals where `instrument.night_trade=False` and `exchange != CFFEX` |\\n| **09:01** | Check missed day signals | `check_signal1_processed` | Retry unprocessed signals from 08:55 |\\n| **09:25** | Process CFFEX signals | `processing_signal2` | Query signals where `exchange == CFFEX` |\\n| **09:31** | Check missed CFFEX signals | `check_signal2_processed` | Retry unprocessed CFFEX signals |\\n| **15:20** | Refresh all data | `refresh_all` | Update account, positions, instruments |\\n| **15:30** | Update equity | `update_equity` | Calculate and store performance metrics |\\n| **17:00** | Collect quotes | `collect_quote` | Fetch data from all 5 exchanges |\\n| **17:00+** | Calculate signals | `calculate` | Run `calc_main_inst` and `calc_signal` for all instruments |\\n| **20:55** | Process night session signals | `processing_signal3` | Query signals where `instrument.night_trade=True` |\\n| **21:01** | Check missed night signals | `check_signal3_processed` | Retry unprocessed night signals |\\n| **Every 1 min** | Heartbeat | `heartbeat` | Update `HEARTBEAT:TRADER` in Redis |\\n\\n**Sources:** [trader/strategy/brother2.py:568-703]()\\n\\n## Data Flow Summary\\n\\n**Input:** Raw OHLC data from 5 Chinese exchanges  \\n**Output:** Trading signals, executed orders, P\\u0026L tracking, performance metrics\\n\\n**Key Transformations:**\\n\\n1. **Exchange Data  DailyBar:** Parse and normalize exchange-specific formats\\n2. **DailyBar  Main Contract:** Identify most liquid contract using volume/OI heuristics\\n3. **Main Contract  MainBar:** Create continuous series with rollover adjustments\\n4. **MainBar  Technical Indicators:** Calculate ATR, SMA, breakout levels\\n5. **Indicators + Position  Signal:** Generate entry/exit/rollover signals\\n6. **Signal  Order  Trade:** Execute via CTP API, track fills and P\\u0026L\\n7. **Trades + Account  Performance:** Calculate daily NAV and risk metrics\\n\\nThis pipeline supports both historical backtesting (using `calc_history_signal`) and live trading (using `calc_signal`), ensuring consistency between strategy development and production execution.\\n\\n**Sources:** [trader/utils/__init__.py:1-797](), [trader/strategy/brother2.py:1-1169](), [panel/models.py:1-289]()\"])</script><script>self.__next_f.push([1,\"1f:T5084,\"])</script><script>self.__next_f.push([1,\"# Message Bus and Communication\\n\\n\\u003cdetails\\u003e\\n\\u003csummary\\u003eRelevant source files\\u003c/summary\\u003e\\n\\nThe following files were used as context for generating this wiki page:\\n\\n- [trader/strategy/__init__.py](trader/strategy/__init__.py)\\n- [trader/strategy/brother2.py](trader/strategy/brother2.py)\\n- [trader/utils/read_config.py](trader/utils/read_config.py)\\n\\n\\u003c/details\\u003e\\n\\n\\n\\nThis document describes the Redis-based message bus architecture that enables communication between the trading strategy system and the CTP (China Futures Trading Platform) API. The message bus decouples the `TradeStrategy` module from the CTP API handler, enabling asynchronous, non-blocking operations and supporting multiple concurrent strategy instances.\\n\\nFor information about the trading strategy implementation itself, see [TradeStrategy Class](#4.1). For details on scheduled task execution, see [Scheduled Tasks](#4.6).\\n\\n---\\n\\n## Redis Pub/Sub Architecture\\n\\nThe system uses Redis as a central message broker implementing a publish-subscribe pattern. Redis serves two roles:\\n1. **Message Bus**: Enables asynchronous communication between components via pub/sub channels\\n2. **Cache/Storage**: Stores runtime data like trading day information and limit ratios\\n\\n### Core Components\\n\\n```mermaid\\ngraph TB\\n    subgraph \\\"Trading Strategy Process\\\"\\n        TS[TradeStrategy\\u003cbr/\\u003etrader/strategy/brother2.py]\\n        BM[BaseModule\\u003cbr/\\u003etrader/strategy/__init__.py]\\n        TS --\\u003e BM\\n    end\\n    \\n    subgraph \\\"Redis Message Bus\\\"\\n        REQ_CH[\\\"Request Channels\\u003cbr/\\u003eMSG:CTP:REQ:*\\\"]\\n        TRADE_RSP[\\\"Trade Response\\u003cbr/\\u003eMSG:CTP:RSP:TRADE:*:*\\\"]\\n        MARKET_RSP[\\\"Market Response\\u003cbr/\\u003eMSG:CTP:RSP:MARKET:*:*\\\"]\\n        LOG_CH[\\\"Log Channel\\u003cbr/\\u003eMSG:LOG:WEIXIN\\\"]\\n    end\\n    \\n    subgraph \\\"CTP Gateway Process\\\"\\n        CTP[\\\"CTP API Handler\\u003cbr/\\u003e(External Process)\\\"]\\n    end\\n    \\n    TS --\\u003e|\\\"publish\\\"| REQ_CH\\n    REQ_CH --\\u003e|\\\"subscribe\\\"| CTP\\n    \\n    CTP --\\u003e|\\\"publish\\\"| TRADE_RSP\\n    CTP --\\u003e|\\\"publish\\\"| MARKET_RSP\\n    \\n    TRADE_RSP --\\u003e|\\\"psubscribe\\\"| BM\\n    MARKET_RSP --\\u003e|\\\"psubscribe\\\"| BM\\n    \\n    TS --\\u003e|\\\"publish\\\"| LOG_CH\\n    \\n    BM --\\u003e|\\\"route to callbacks\\\"| TS\\n```\\n\\n**Sources**: [trader/strategy/__init__.py:36-57](), [trader/strategy/brother2.py:38-43]()\\n\\n### Redis Connection Setup\\n\\nThe `BaseModule` class initializes two Redis clients:\\n\\n| Client | Type | Purpose |\\n|--------|------|---------|\\n| `redis_client` | `aioredis.Redis` | Async pub/sub operations (used for subscribing) |\\n| `raw_redis` | `redis.StrictRedis` | Synchronous operations (used for publishing and caching) |\\n| `sub_client` | `aioredis.client.PubSub` | Pub/sub subscription manager |\\n\\n**Sources**: [trader/strategy/__init__.py:41-48]()\\n\\n---\\n\\n## Channel Naming Conventions\\n\\nAll channel names follow structured patterns defined in `config.ini` and are formatted using these configuration values:\\n\\n### Configuration Structure\\n\\n```ini\\n[MSG_CHANNEL]\\nrequest_pattern = MSG:CTP:REQ:*\\nrequest_format = MSG:CTP:REQ:{}\\ntrade_response_prefix = MSG:CTP:RSP:TRADE:\\ntrade_response_format = MSG:CTP:RSP:TRADE:{}:{}\\nmarket_response_prefix = MSG:CTP:RSP:MARKET:\\nmarket_response_format = MSG:CTP:RSP:MARKET:{}:{}\\nweixin_log = MSG:LOG:WEIXIN\\n```\\n\\n**Sources**: [trader/utils/read_config.py:23-31]()\\n\\n### Channel Patterns\\n\\n| Channel Pattern | Format | Example | Purpose |\\n|----------------|--------|---------|---------|\\n| **Request** | `MSG:CTP:REQ:{command}` | `MSG:CTP:REQ:ReqQryTradingAccount` | Commands sent to CTP API |\\n| **Trade Response** | `MSG:CTP:RSP:TRADE:{callback}:{identifier}` | `MSG:CTP:RSP:TRADE:OnRtnOrder:12345678` | Order and trade callbacks |\\n| **Market Response** | `MSG:CTP:RSP:MARKET:{callback}:{identifier}` | `MSG:CTP:RSP:MARKET:OnRtnDepthMarketData:rb2405` | Market data ticks |\\n| **Log** | `MSG:LOG:WEIXIN` | `MSG:LOG:WEIXIN` | System logs forwarded to WeChat |\\n\\n**Key Identifiers**:\\n- **RequestID**: Unique integer for tracking request-response pairs (used in queries)\\n- **OrderRef**: Format `{autoid:07}{signal_id:05}` for tracking orders (7-digit auto number + 5-digit signal ID)\\n- **InstrumentID**: Contract code for market data subscriptions\\n\\n**Sources**: [trader/strategy/brother2.py:41-43](), [trader/utils/read_config.py:23-31]()\\n\\n---\\n\\n## Communication Patterns\\n\\nThe system implements three distinct communication patterns based on operation type.\\n\\n### Pattern 1: Request-Response (Query Operations)\\n\\nUsed for querying data from CTP API where a response is expected.\\n\\n```mermaid\\nsequenceDiagram\\n    participant TS as TradeStrategy\\n    participant Redis as Redis Pub/Sub\\n    participant CTP as CTP Gateway\\n    \\n    Note over TS: Needs account data\\n    TS-\\u003e\\u003eTS: request_id = get_next_id()\\n    TS-\\u003e\\u003eRedis: psubscribe(\\\"MSG:CTP:RSP:TRADE:OnRspQryTradingAccount:{request_id}\\\")\\n    TS-\\u003e\\u003eRedis: psubscribe(\\\"MSG:CTP:RSP:TRADE:OnRspError:{request_id}\\\")\\n    TS-\\u003e\\u003eRedis: publish(\\\"MSG:CTP:REQ:ReqQryTradingAccount\\\", \\u003cbr/\\u003e{\\\"RequestID\\\": request_id})\\n    \\n    Redis-\\u003e\\u003eCTP: Forward query request\\n    CTP-\\u003e\\u003eCTP: Query CTP API\\n    \\n    loop Multiple response packets\\n        CTP-\\u003e\\u003eRedis: publish(\\\"MSG:CTP:RSP:TRADE:OnRspQryTradingAccount:{request_id}\\\",\\u003cbr/\\u003e{\\\"data\\\": {...}, \\\"bIsLast\\\": false})\\n        Redis-\\u003e\\u003eTS: Message received\\n        TS-\\u003e\\u003eTS: Append to result list\\n    end\\n    \\n    CTP-\\u003e\\u003eRedis: publish(\\\"MSG:CTP:RSP:TRADE:OnRspQryTradingAccount:{request_id}\\\",\\u003cbr/\\u003e{\\\"data\\\": {...}, \\\"bIsLast\\\": true})\\n    Redis-\\u003e\\u003eTS: Final message\\n    TS-\\u003e\\u003eTS: Return complete result\\n    TS-\\u003e\\u003eRedis: punsubscribe()\\n```\\n\\n**Implementation**: The `query` method implements this pattern with timeout handling.\\n\\n**Sources**: [trader/strategy/brother2.py:236-257]()\\n\\n#### Query Method Implementation\\n\\n```python\\nasync def query(self, query_type: str, **kwargs):\\n    sub_client = self.redis_client.pubsub(ignore_subscribe_messages=True)\\n    request_id = get_next_id()\\n    kwargs['RequestID'] = request_id\\n    \\n    # Subscribe to response channels\\n    channel_rsp_qry = self.__trade_response_format.format('OnRspQry' + query_type, request_id)\\n    channel_rsp_err = self.__trade_response_format.format('OnRspError', request_id)\\n    await sub_client.psubscribe(channel_rsp_qry, channel_rsp_err)\\n    \\n    # Create async task to collect responses\\n    task = asyncio.create_task(self.query_reader(sub_client))\\n    \\n    # Publish request\\n    self.raw_redis.publish(self.__request_format.format('ReqQry' + query_type), json.dumps(kwargs))\\n    \\n    # Wait for response with timeout\\n    await asyncio.wait_for(task, HANDLER_TIME_OUT)\\n    \\n    # Cleanup\\n    await sub_client.punsubscribe()\\n    await sub_client.close()\\n    return task.result()\\n```\\n\\n**Key Operations**:\\n- **Account Query**: `query('TradingAccount')`  Returns balance, margin, cash\\n- **Position Query**: `query('InvestorPositionDetail')`  Returns open positions\\n- **Instrument Query**: `query('Instrument')`  Returns contract specifications\\n- **Order Query**: `query('Order')`  Returns order status\\n\\n**Sources**: [trader/strategy/brother2.py:236-257](), [trader/strategy/brother2.py:86-112](), [trader/strategy/brother2.py:114-154]()\\n\\n---\\n\\n### Pattern 2: Fire-and-Forget (Order Operations)\\n\\nUsed for sending orders where acknowledgment comes through separate callback channels.\\n\\n```mermaid\\nsequenceDiagram\\n    participant TS as TradeStrategy\\n    participant Redis as Redis Pub/Sub\\n    participant CTP as CTP Gateway\\n    \\n    Note over TS: Process Signal\\n    TS-\\u003e\\u003eTS: order_ref = f\\\"{autoid:07}{signal_id:05}\\\"\\n    TS-\\u003e\\u003eRedis: publish(\\\"MSG:CTP:REQ:ReqOrderInsert\\\",\\u003cbr/\\u003e{\\\"OrderRef\\\": order_ref, \\\"InstrumentID\\\": \\\"rb2405\\\", ...})\\n    Note over TS: No waiting for response\\n    \\n    Redis-\\u003e\\u003eCTP: Forward order\\n    CTP-\\u003e\\u003eCTP: Submit to exchange\\n    \\n    Note over CTP: Order accepted by exchange\\n    CTP-\\u003e\\u003eRedis: publish(\\\"MSG:CTP:RSP:TRADE:OnRtnOrder:{order_ref}\\\",\\u003cbr/\\u003eorder status)\\n    Redis-\\u003e\\u003eTS: Order callback (async)\\n    TS-\\u003e\\u003eTS: OnRtnOrder() - update Order model\\n    \\n    Note over CTP: Order filled\\n    CTP-\\u003e\\u003eRedis: publish(\\\"MSG:CTP:RSP:TRADE:OnRtnTrade:{order_ref}\\\",\\u003cbr/\\u003etrade details)\\n    Redis-\\u003e\\u003eTS: Trade callback (async)\\n    TS-\\u003e\\u003eTS: OnRtnTrade() - update Trade model\\n```\\n\\n**Sources**: [trader/strategy/brother2.py:301-343](), [trader/strategy/brother2.py:391-469](), [trader/strategy/brother2.py:510-566]()\\n\\n#### Order Insertion Implementation\\n\\nThe `ReqOrderInsert` method publishes order requests without waiting for immediate response:\\n\\n```python\\ndef ReqOrderInsert(self, sig: Signal):\\n    request_id = get_next_id()\\n    autoid = Autonumber.objects.create()\\n    order_ref = f\\\"{autoid.id:07}{sig.id:05}\\\"  # 12-digit unique identifier\\n    \\n    param_dict = {\\n        'RequestID': request_id,\\n        'OrderRef': order_ref,\\n        'InstrumentID': sig.code,\\n        'VolumeTotalOriginal': sig.volume,\\n        'LimitPrice': float(sig.price),\\n        'Direction': ...,\\n        'CombOffsetFlag': ...\\n    }\\n    \\n    # Fire and forget\\n    self.raw_redis.publish(\\n        self.__request_format.format('ReqOrderInsert'), \\n        json.dumps(param_dict)\\n    )\\n```\\n\\n**Order Reference Format**: The 12-digit `OrderRef` encodes both an auto-incrementing ID and the Signal ID:\\n- Positions 1-7: Auto-increment ID from `Autonumber` table\\n- Positions 8-12: Signal ID (starting from position defined by `ORDER_REF_SIGNAL_ID_START`)\\n\\nThis allows callbacks to identify which signal triggered the order.\\n\\n**Sources**: [trader/strategy/brother2.py:301-343]()\\n\\n---\\n\\n### Pattern 3: Streaming (Market Data)\\n\\nUsed for continuous real-time market data updates.\\n\\n```mermaid\\nsequenceDiagram\\n    participant TS as TradeStrategy\\n    participant Redis as Redis Pub/Sub\\n    participant CTP as CTP Gateway\\n    \\n    Note over TS: Subscribe to market data\\n    TS-\\u003e\\u003eRedis: publish(\\\"MSG:CTP:REQ:SubscribeMarketData\\\",\\u003cbr/\\u003e[\\\"rb2405\\\", \\\"hc2405\\\"])\\n    Redis-\\u003e\\u003eCTP: Forward subscription\\n    CTP-\\u003e\\u003eCTP: Subscribe with exchange\\n    CTP-\\u003e\\u003eRedis: publish(\\\"MSG:CTP:RSP:MARKET:OnRspSubMarketData:0\\\",\\u003cbr/\\u003econfirmation)\\n    Redis-\\u003e\\u003eTS: Subscription confirmed\\n    \\n    loop Continuous streaming\\n        Note over CTP: Market tick update\\n        CTP-\\u003e\\u003eRedis: publish(\\\"MSG:CTP:RSP:MARKET:OnRtnDepthMarketData:rb2405\\\",\\u003cbr/\\u003etick data)\\n        Redis-\\u003e\\u003eTS: Market data callback\\n        TS-\\u003e\\u003eTS: OnRtnDepthMarketData() - process tick\\n    end\\n```\\n\\n**Sources**: [trader/strategy/brother2.py:259-279](), [trader/strategy/brother2.py:373-380]()\\n\\n---\\n\\n## Callback System\\n\\nThe callback system uses the `@RegisterCallback` decorator to register handler functions for specific channels or cron schedules.\\n\\n### Callback Registration Architecture\\n\\n```mermaid\\ngraph TB\\n    subgraph \\\"Decorator Registration\\\"\\n        RD[\\\"@RegisterCallback\\u003cbr/\\u003edecorator\\\"]\\n        CFC[\\\"CallbackFunctionContainer\\u003cbr/\\u003etrader/utils/func_container.py\\\"]\\n        RD --\\u003e CFC\\n    end\\n    \\n    subgraph \\\"BaseModule Initialization\\\"\\n        REG[\\\"_register_callback()\\u003cbr/\\u003etrader/strategy/__init__.py:58-69\\\"]\\n        CH_ROUTER[\\\"channel_router: dict\\u003cbr/\\u003epattern  function\\\"]\\n        CRON_ROUTER[\\\"crontab_router: dict\\u003cbr/\\u003ecron expr  {func, iter, handle}\\\"]\\n        \\n        REG --\\u003e CH_ROUTER\\n        REG --\\u003e CRON_ROUTER\\n    end\\n    \\n    subgraph \\\"Runtime Execution\\\"\\n        MSG_READER[\\\"_msg_reader()\\u003cbr/\\u003eListen for messages\\\"]\\n        CALL_NEXT[\\\"_call_next()\\u003cbr/\\u003eSchedule cron tasks\\\"]\\n        \\n        CH_ROUTER --\\u003e MSG_READER\\n        CRON_ROUTER --\\u003e CALL_NEXT\\n    end\\n    \\n    CFC --\\u003e REG\\n    MSG_READER --\\u003e|\\\"route by pattern\\\"| HANDLER[\\\"Callback Function\\\"]\\n    CALL_NEXT --\\u003e|\\\"execute\\\"| HANDLER\\n```\\n\\n**Sources**: [trader/strategy/__init__.py:58-69](), [trader/strategy/__init__.py:110-121]()\\n\\n### Channel Callback Example\\n\\nCallbacks are registered using pattern matching with wildcards:\\n\\n```python\\n@RegisterCallback(channel='MSG:CTP:RSP:TRADE:OnRtnTrade:*')\\nasync def OnRtnTrade(self, channel, trade: dict):\\n    # Extract OrderRef from channel\\n    order_ref: str = channel.split(':')[-1]\\n    \\n    # Determine if manual trade\\n    manual_trade = int(order_ref) \\u003c 10000\\n    \\n    if not manual_trade:\\n        signal = Signal.objects.get(id=int(order_ref[ORDER_REF_SIGNAL_ID_START:]))\\n    \\n    # Process trade execution\\n    # ... update Trade and Order models\\n```\\n\\n**Pattern Matching**: The `*` wildcard allows subscribing to all trades regardless of OrderRef, then extracting the OrderRef from the channel name at runtime.\\n\\n**Sources**: [trader/strategy/brother2.py:391-469]()\\n\\n### Registered Callbacks\\n\\n| Callback | Channel Pattern | Trigger | Purpose |\\n|----------|----------------|---------|---------|\\n| `OnRtnTrade` | `MSG:CTP:RSP:TRADE:OnRtnTrade:*` | Trade execution | Update Trade model, mark Signal processed |\\n| `OnRtnOrder` | `MSG:CTP:RSP:TRADE:OnRtnOrder:*` | Order status change | Update Order model, handle rejections |\\n| `OnRtnDepthMarketData` | `MSG:CTP:RSP:MARKET:OnRtnDepthMarketData:*` | Market tick | Process real-time market data |\\n\\n**Sources**: [trader/strategy/brother2.py:373-380](), [trader/strategy/brother2.py:391-469](), [trader/strategy/brother2.py:510-566]()\\n\\n---\\n\\n## Message Reader Implementation\\n\\nThe `BaseModule` class implements an asynchronous message reader that routes incoming messages to registered callbacks.\\n\\n```mermaid\\nflowchart TD\\n    START[\\\"install() called\\\"]\\n    START --\\u003e PSUB[\\\"psubscribe(*channel_router.keys())\\\"]\\n    PSUB --\\u003e CREATE[\\\"asyncio.run_coroutine_threadsafe(_msg_reader())\\\"]\\n    \\n    CREATE --\\u003e LOOP{\\\"async for msg in\\u003cbr/\\u003esub_client.listen()\\\"}\\n    \\n    LOOP --\\u003e|\\\"type == 'pmessage'\\\"| EXTRACT[\\\"Extract:\\u003cbr/\\u003e- channel\\u003cbr/\\u003e- pattern\\u003cbr/\\u003e- data = json.loads(msg['data'])\\\"]\\n    EXTRACT --\\u003e ROUTE[\\\"self.channel_router[pattern]\\\"]\\n    ROUTE --\\u003e TASK[\\\"io_loop.create_task(\\u003cbr/\\u003ecallback(channel, data))\\\"]\\n    TASK --\\u003e LOOP\\n    \\n    LOOP --\\u003e|\\\"type == 'punsubscribe'\\\"| BREAK[\\\"break\\\"]\\n    BREAK --\\u003e END[\\\"Exit _msg_reader\\\"]\\n    \\n    LOOP --\\u003e|\\\"other types\\\"| IGNORE[\\\"Ignore\\\"]\\n    IGNORE --\\u003e LOOP\\n```\\n\\n**Key Features**:\\n- **Pattern-based routing**: Uses the subscription pattern (not the actual channel) to find the callback\\n- **Async execution**: Each callback runs as a separate asyncio task\\n- **JSON deserialization**: Automatically deserializes message data\\n- **Graceful shutdown**: Exits when `punsubscribe` message received\\n\\n**Sources**: [trader/strategy/__init__.py:110-121]()\\n\\n---\\n\\n## Request ID Management\\n\\nThe system uses a global atomic counter to generate unique request IDs for tracking request-response pairs.\\n\\n### ID Generation\\n\\n```python\\ndef get_next_id():\\n    \\\"\\\"\\\"Generate unique request ID for CTP API calls\\\"\\\"\\\"\\n    # Implementation uses atomic increment\\n    # Returns integer that uniquely identifies the request\\n```\\n\\n### Usage Patterns\\n\\n| Operation | ID Type | Format | Example | Purpose |\\n|-----------|---------|--------|---------|---------|\\n| **Query** | RequestID | Integer | `12345` | Track query responses |\\n| **Order** | RequestID + OrderRef | `{autoid:07}{signal_id:05}` | `0000123000045` | Track order lifecycle |\\n| **Market Data** | None | N/A | N/A | Streaming data needs no tracking |\\n\\n**Sources**: [trader/strategy/brother2.py:221-223](), [trader/strategy/brother2.py:236-257](), [trader/strategy/brother2.py:301-343]()\\n\\n---\\n\\n## Error Handling\\n\\n### Query Timeout\\n\\nQueries implement timeout handling using `asyncio.wait_for`:\\n\\n```python\\nawait asyncio.wait_for(task, HANDLER_TIME_OUT)  # Default 10 seconds\\n```\\n\\nIf a query times out, it raises `asyncio.TimeoutError` and logs a warning.\\n\\n**Sources**: [trader/strategy/brother2.py:248](), [trader/strategy/brother2.py:35]()\\n\\n### CTP Error Responses\\n\\nWhen CTP API returns errors, they arrive on the `OnRspError` channel:\\n\\n```python\\nchannel_rsp_err = self.__trade_response_format.format('OnRspError', request_id)\\nawait sub_client.psubscribe(channel_rsp_qry, channel_rsp_err)\\n```\\n\\nError codes are mapped using `ctp_errors` dictionary loaded from `error.xml`:\\n\\n```python\\nif 'ErrorID' in result:\\n    logger.warning(f\\\": {ctp_errors[result['ErrorID']]}\\\")\\n    return False\\n```\\n\\n**Sources**: [trader/strategy/brother2.py:244](), [trader/strategy/brother2.py:362-363](), [trader/utils/read_config.py:74-78]()\\n\\n---\\n\\n## Subscription Management\\n\\n### Channel Subscription Flow\\n\\n```mermaid\\nsequenceDiagram\\n    participant TS as TradeStrategy\\n    participant BM as BaseModule\\n    participant Redis as Redis\\n    \\n    Note over TS: Startup\\n    TS-\\u003e\\u003eBM: await install()\\n    BM-\\u003e\\u003eBM: _register_callback()\\u003cbr/\\u003eBuild channel_router\\n    BM-\\u003e\\u003eRedis: await sub_client.psubscribe(\\u003cbr/\\u003e*channel_router.keys())\\n    BM-\\u003e\\u003eBM: asyncio.run_coroutine_threadsafe(\\u003cbr/\\u003e_msg_reader())\\n    Note over BM: Background task listening\\n    \\n    Note over TS: Runtime - Messages arrive\\n    Redis--\\u003e\\u003eBM: pmessage received\\n    BM-\\u003e\\u003eBM: Route to callback via pattern\\n    BM-\\u003e\\u003eTS: await callback(channel, data)\\n    \\n    Note over TS: Shutdown\\n    TS-\\u003e\\u003eBM: await uninstall()\\n    BM-\\u003e\\u003eRedis: await sub_client.punsubscribe()\\n    BM-\\u003e\\u003eBM: Wait for _msg_reader to exit\\n    BM-\\u003e\\u003eRedis: await sub_client.close()\\n```\\n\\n**Sources**: [trader/strategy/__init__.py:80-93](), [trader/strategy/__init__.py:95-108]()\\n\\n### Dynamic Subscriptions\\n\\nFor temporary subscriptions (e.g., during queries), the system creates dedicated pub/sub clients:\\n\\n```python\\n# Create temporary subscription\\nsub_client = self.redis_client.pubsub(ignore_subscribe_messages=True)\\nawait sub_client.psubscribe(channel_rsp_qry, channel_rsp_err)\\n\\n# Use subscription\\ntask = asyncio.create_task(self.query_reader(sub_client))\\n# ... wait for result ...\\n\\n# Cleanup\\nawait sub_client.punsubscribe()\\nawait sub_client.close()\\n```\\n\\nThis pattern prevents mixing temporary subscriptions with permanent ones managed by `BaseModule`.\\n\\n**Sources**: [trader/strategy/brother2.py:240](), [trader/strategy/brother2.py:249-250]()\\n\\n---\\n\\n## Performance Considerations\\n\\n### Connection Pooling\\n\\nThe system maintains separate Redis connections for different purposes:\\n\\n- **Async client** (`redis_client`): Used for pub/sub subscriptions\\n- **Sync client** (`raw_redis`): Used for publishing and caching operations\\n- **Temporary clients**: Created per-query for request-response pattern\\n\\nThis separation prevents blocking operations from interfering with message handling.\\n\\n**Sources**: [trader/strategy/__init__.py:41-48]()\\n\\n### Message Serialization\\n\\nAll messages are serialized using `ujson` for performance:\\n\\n```python\\nimport ujson as json\\n\\n# Publishing\\nself.raw_redis.publish(channel, json.dumps(param_dict))\\n\\n# Receiving\\ndata = json.loads(msg['data'])\\n```\\n\\n`ujson` (UltraJSON) provides faster serialization than standard `json` library.\\n\\n**Sources**: [trader/strategy/brother2.py:25](), [trader/strategy/__init__.py:17]()\\n\\n### Timeout Configuration\\n\\nDefault timeout for CTP commands is configurable:\\n\\n```ini\\n[TRADE]\\ncommand_timeout = 10\\n```\\n\\nThis timeout applies to all query operations to prevent indefinite hanging.\\n\\n**Sources**: [trader/strategy/brother2.py:35](), [trader/utils/read_config.py:34]()\\n\\n---\\n\\n## Integration with CTP Gateway\\n\\nWhile the CTP Gateway process is external to this codebase, understanding its role is important:\\n\\n### Gateway Responsibilities\\n\\n1. **Subscribe** to `MSG:CTP:REQ:*` channels\\n2. **Execute** CTP API calls based on request type\\n3. **Publish** responses to appropriate channels:\\n   - Query responses  `MSG:CTP:RSP:TRADE:OnRspQry{Type}:{RequestID}`\\n   - Order callbacks  `MSG:CTP:RSP:TRADE:OnRtnOrder:{OrderRef}`\\n   - Trade callbacks  `MSG:CTP:RSP:TRADE:OnRtnTrade:{OrderRef}`\\n   - Market data  `MSG:CTP:RSP:MARKET:OnRtnDepthMarketData:{InstrumentID}`\\n\\n### Request Types\\n\\n| Request Channel | CTP API Call | Response Channel |\\n|----------------|--------------|------------------|\\n| `ReqQryTradingAccount` | QryTradingAccount | `OnRspQryTradingAccount` |\\n| `ReqQryInvestorPositionDetail` | QryInvestorPositionDetail | `OnRspQryInvestorPositionDetail` |\\n| `ReqQryInstrument` | QryInstrument | `OnRspQryInstrument` |\\n| `ReqOrderInsert` | ReqOrderInsert | `OnRtnOrder` + `OnRtnTrade` |\\n| `ReqOrderAction` | ReqOrderAction | `OnRspOrderAction` |\\n| `SubscribeMarketData` | SubscribeMarketData | `OnRtnDepthMarketData` |\\n\\n**Sources**: [trader/strategy/brother2.py:86-343]()\\n\\n---\\n\\n## Summary\\n\\nThe Redis message bus architecture provides:\\n\\n1. **Decoupling**: Trading strategy is independent of CTP API implementation\\n2. **Asynchronous Operations**: Non-blocking I/O for all CTP interactions\\n3. **Scalability**: Multiple strategy instances can run concurrently\\n4. **Reliability**: Message queue ensures delivery even if components restart\\n5. **Observability**: All messages logged and can be monitored\\n6. **Testability**: Strategy can be tested without live CTP connection by mocking Redis messages\\n\\nThe three communication patterns (request-response, fire-and-forget, streaming) cover all interaction types with the CTP API, while the callback system provides clean, decorator-based event handling.\"])</script><script>self.__next_f.push([1,\"20:T5775,\"])</script><script>self.__next_f.push([1,\"# Trading Strategy System\\n\\n\\u003cdetails\\u003e\\n\\u003csummary\\u003eRelevant source files\\u003c/summary\\u003e\\n\\nThe following files were used as context for generating this wiki page:\\n\\n- [panel/models.py](panel/models.py)\\n- [trader/strategy/__init__.py](trader/strategy/__init__.py)\\n- [trader/strategy/brother2.py](trader/strategy/brother2.py)\\n\\n\\u003c/details\\u003e\\n\\n\\n\\n## Purpose and Scope\\n\\nThe Trading Strategy System is the core execution engine responsible for generating trading signals, managing order execution, and monitoring positions in the automated futures trading platform. This document provides a comprehensive overview of the system architecture, signal generation algorithms, order execution flow, and risk management mechanisms.\\n\\n**Related Documentation:**\\n- For the `TradeStrategy` class implementation details, see [TradeStrategy Class](#4.1)\\n- For the underlying framework architecture, see [BaseModule Framework](#4.2)\\n- For signal calculation algorithms and technical indicators, see [Signal Generation](#4.3)\\n- For the complete order lifecycle, see [Order Execution Flow](#4.4)\\n- For position sizing and risk controls, see [Risk Management](#4.5)\\n- For timing and scheduling of trading operations, see [Scheduled Tasks](#4.6)\\n- For data model specifications, see [Data Models](#5.1)\\n- For system architecture overview, see [Architecture](#3)\\n\\n---\\n\\n## System Architecture Overview\\n\\nThe Trading Strategy System is built on a layered architecture with the `TradeStrategy` class at its center, extending the `BaseModule` framework for asynchronous event handling and scheduled task execution.\\n\\n### High-Level Component Architecture\\n\\n```mermaid\\ngraph TB\\n    subgraph \\\"Strategy Layer\\\"\\n        TS[\\\"TradeStrategy\\u003cbr/\\u003e(brother2.py)\\\"]\\n        BM[\\\"BaseModule\\u003cbr/\\u003e(__init__.py)\\\"]\\n    end\\n    \\n    subgraph \\\"Scheduling \\u0026 Events\\\"\\n        CRON[\\\"Cron Scheduler\\u003cbr/\\u003e(croniter)\\\"]\\n        CB[\\\"CallbackFunctionContainer\\u003cbr/\\u003e(func_container)\\\"]\\n    end\\n    \\n    subgraph \\\"Message Infrastructure\\\"\\n        REDIS[\\\"Redis Pub/Sub\\\"]\\n        REQ_CH[\\\"Request Channels\\u003cbr/\\u003eMSG:CTP:REQ:*\\\"]\\n        RSP_CH[\\\"Response Channels\\u003cbr/\\u003eMSG:CTP:RSP:*\\\"]\\n    end\\n    \\n    subgraph \\\"Data Layer\\\"\\n        SIG[\\\"Signal Model\\\"]\\n        ORD[\\\"Order Model\\\"]\\n        TRD[\\\"Trade Model\\\"]\\n        PERF[\\\"Performance Model\\\"]\\n        INST[\\\"Instrument Model\\\"]\\n        BAR[\\\"DailyBar/MainBar\\\"]\\n    end\\n    \\n    subgraph \\\"External Systems\\\"\\n        CTP[\\\"CTP Trading API\\\"]\\n        EXCH[\\\"5 Chinese Exchanges\\\"]\\n    end\\n    \\n    TS --\\u003e|extends| BM\\n    BM --\\u003e|uses| CB\\n    BM --\\u003e|uses| CRON\\n    BM --\\u003e|async I/O| REDIS\\n    \\n    CRON -.-\\u003e|triggers| TS\\n    CB -.-\\u003e|@RegisterCallback| TS\\n    \\n    TS --\\u003e|publish| REQ_CH\\n    RSP_CH --\\u003e|subscribe| TS\\n    \\n    REQ_CH --\\u003e|forward| CTP\\n    CTP --\\u003e|push| RSP_CH\\n    \\n    TS --\\u003e|read/write| SIG\\n    TS --\\u003e|read/write| ORD\\n    TS --\\u003e|read/write| TRD\\n    TS --\\u003e|read/write| PERF\\n    TS --\\u003e|read| INST\\n    TS --\\u003e|read| BAR\\n    \\n    EXCH -.-\\u003e|daily data| BAR\\n```\\n\\n**Sources:** [trader/strategy/brother2.py:1-871](), [trader/strategy/__init__.py:1-140](), [panel/models.py:1-289]()\\n\\n---\\n\\n## Core Components\\n\\n### TradeStrategy Class\\n\\nThe `TradeStrategy` class is the primary orchestrator of all trading operations. Located in [trader/strategy/brother2.py:38-871](), it handles:\\n\\n- **Account Management**: Balance, margin, and position tracking\\n- **Signal Processing**: Reading and executing trading signals from the database\\n- **Order Execution**: Submitting orders to CTP API via Redis\\n- **Risk Management**: Position sizing and stop-loss calculations\\n- **Data Collection**: Gathering daily market data from exchanges\\n\\n**Key Attributes:**\\n\\n| Attribute | Type | Purpose |\\n|-----------|------|---------|\\n| `__strategy` | Strategy | Database reference to strategy configuration |\\n| `__broker` | Broker | Account credentials and balance information |\\n| `__inst_ids` | list | Product codes tracked by this strategy |\\n| `__cur_pos` | dict | Current positions `{instrument: position_details}` |\\n| `__activeOrders` | dict | Unfilled orders awaiting execution |\\n| `__trading_day` | datetime | Current trading day |\\n| `__cash` | Decimal | Available cash for trading |\\n| `__margin` | Decimal | Used margin for open positions |\\n\\n**Sources:** [trader/strategy/brother2.py:38-63]()\\n\\n### BaseModule Framework\\n\\n`BaseModule` provides the foundational infrastructure for asynchronous operation. Defined in [trader/strategy/__init__.py:36-140](), it implements:\\n\\n- **Redis Integration**: Asynchronous pub/sub client management\\n- **Callback System**: Decorator-based event routing\\n- **Cron Scheduling**: Time-based task execution using `croniter`\\n- **Event Loop Management**: Asyncio-based non-blocking I/O\\n\\n**Key Methods:**\\n\\n| Method | Purpose |\\n|--------|---------|\\n| `install()` | Register callbacks and subscribe to Redis channels |\\n| `_msg_reader()` | Async message loop for Redis pub/sub |\\n| `_call_next()` | Schedule next cron job execution |\\n| `run()` | Start the event loop |\\n\\n**Sources:** [trader/strategy/__init__.py:36-140]()\\n\\n---\\n\\n## Data Flow Architecture\\n\\n### Signal Generation to Order Execution Pipeline\\n\\n```mermaid\\nsequenceDiagram\\n    participant CRON as \\\"Cron: 17:00\\\"\\n    participant CALC as \\\"calculate()\\\"\\n    participant SIG_GEN as \\\"calc_signal()\\\"\\n    participant DB_SIG as \\\"Signal Model\\\"\\n    participant PROC as \\\"processing_signal*()\\\"\\n    participant REQ as \\\"ReqOrderInsert()\\\"\\n    participant REDIS as \\\"Redis Pub/Sub\\\"\\n    participant CTP as \\\"CTP API\\\"\\n    participant RTN as \\\"OnRtnOrder/OnRtnTrade\\\"\\n    participant DB_ORD as \\\"Order/Trade Models\\\"\\n    \\n    CRON-\\u003e\\u003eCALC: \\\"Scheduled trigger\\\"\\n    CALC-\\u003e\\u003eSIG_GEN: \\\"For each Instrument\\\"\\n    \\n    SIG_GEN-\\u003e\\u003eSIG_GEN: \\\"Calculate ATR, SMA, breakout\\\"\\n    SIG_GEN-\\u003e\\u003eSIG_GEN: \\\"Determine buy/sell signal\\\"\\n    SIG_GEN-\\u003e\\u003eDB_SIG: \\\"Create Signal record\\\"\\n    \\n    Note over PROC: \\\"Next trading session (08:55/09:25/20:55)\\\"\\n    PROC-\\u003e\\u003eDB_SIG: \\\"Query unprocessed signals\\\"\\n    PROC-\\u003e\\u003eREQ: \\\"For each signal\\\"\\n    \\n    REQ-\\u003e\\u003eREQ: \\\"Build order params\\\"\\n    REQ-\\u003e\\u003eREDIS: \\\"Publish to MSG:CTP:REQ:ReqOrderInsert\\\"\\n    REDIS-\\u003e\\u003eCTP: \\\"Forward order request\\\"\\n    \\n    CTP-\\u003e\\u003eREDIS: \\\"OnRtnOrder callback\\\"\\n    REDIS-\\u003e\\u003eRTN: \\\"Subscribe pattern match\\\"\\n    RTN-\\u003e\\u003eDB_ORD: \\\"Save Order record\\\"\\n    \\n    CTP-\\u003e\\u003eREDIS: \\\"OnRtnTrade callback\\\"\\n    REDIS-\\u003e\\u003eRTN: \\\"Trade confirmation\\\"\\n    RTN-\\u003e\\u003eDB_ORD: \\\"Update Trade record\\\"\\n    RTN-\\u003e\\u003eDB_SIG: \\\"Mark signal.processed=True\\\"\\n```\\n\\n**Sources:** [trader/strategy/brother2.py:684-724](), [trader/strategy/brother2.py:301-343](), [trader/strategy/brother2.py:391-469](), [trader/strategy/brother2.py:510-566]()\\n\\n---\\n\\n## Signal Generation System\\n\\n### Signal Types and Purposes\\n\\nThe system supports six signal types, defined in [panel/models.py:173-192]():\\n\\n| Signal Type | Code | Purpose |\\n|-------------|------|---------|\\n| `BUY` | Open long position | Enter bullish trade |\\n| `SELL` | Close long position | Exit long or enter short |\\n| `SELL_SHORT` | Open short position | Enter bearish trade |\\n| `BUY_COVER` | Close short position | Exit short position |\\n| `ROLL_OPEN` | Open new contract | Rollover to new main contract |\\n| `ROLL_CLOSE` | Close expiring contract | Exit old main contract |\\n\\n### Signal Calculation Algorithm\\n\\nThe `calc_signal()` method in [trader/strategy/brother2.py:725-856]() implements a breakout strategy with ATR-based position sizing:\\n\\n```mermaid\\nflowchart TD\\n    START[\\\"calc_signal(inst, day)\\\"] --\\u003e LOAD[\\\"Load strategy parameters\\u003cbr/\\u003eBreakPeriod, AtrPeriod, etc.\\\"]\\n    LOAD --\\u003e QUERY[\\\"Query MainBar data\\u003cbr/\\u003eLast 400 records\\\"]\\n    QUERY --\\u003e CALC_IND[\\\"Calculate indicators:\\u003cbr/\\u003eATR, SMA(short), SMA(long)\\u003cbr/\\u003eHigh/Low breakout lines\\\"]\\n    \\n    CALC_IND --\\u003e CHECK_POS{\\\"Has open\\u003cbr/\\u003eposition?\\\"}\\n    \\n    CHECK_POS --\\u003e|Yes| CHECK_DIR{\\\"Position\\u003cbr/\\u003edirection?\\\"}\\n    CHECK_POS --\\u003e|No| CHECK_SIGNAL{\\\"Breakout\\u003cbr/\\u003esignal?\\\"}\\n    \\n    CHECK_DIR --\\u003e|Long| LONG_MGMT[\\\"Check stop-loss:\\u003cbr/\\u003eclose \\u003c max_high - ATR*stop_n\\\"]\\n    CHECK_DIR --\\u003e|Short| SHORT_MGMT[\\\"Check stop-loss:\\u003cbr/\\u003eclose \\u003e min_low + ATR*stop_n\\\"]\\n    \\n    LONG_MGMT --\\u003e STOP_LONG{\\\"Stop-loss\\u003cbr/\\u003etriggered?\\\"}\\n    SHORT_MGMT --\\u003e STOP_SHORT{\\\"Stop-loss\\u003cbr/\\u003etriggered?\\\"}\\n    \\n    STOP_LONG --\\u003e|Yes| SIG_SELL[\\\"Generate SELL signal\\\"]\\n    STOP_SHORT --\\u003e|Yes| SIG_COVER[\\\"Generate BUY_COVER signal\\\"]\\n    \\n    STOP_LONG --\\u003e|No| ROLL_CHECK_LONG[\\\"Check rollover:\\u003cbr/\\u003epos.code != main_code?\\\"]\\n    STOP_SHORT --\\u003e|No| ROLL_CHECK_SHORT[\\\"Check rollover:\\u003cbr/\\u003epos.code != main_code?\\\"]\\n    \\n    ROLL_CHECK_LONG --\\u003e|Yes| ROLL_SIG[\\\"Generate ROLL_CLOSE\\u003cbr/\\u003eand ROLL_OPEN signals\\\"]\\n    ROLL_CHECK_SHORT --\\u003e|Yes| ROLL_SIG\\n    \\n    CHECK_SIGNAL --\\u003e|Buy| CALC_VOL_BUY[\\\"Calculate volume:\\u003cbr/\\u003e(capital + profit) * risk / ATR\\\"]\\n    CHECK_SIGNAL --\\u003e|Sell| CALC_VOL_SELL[\\\"Calculate volume:\\u003cbr/\\u003e(capital + profit) * risk / ATR\\\"]\\n    \\n    CALC_VOL_BUY --\\u003e SIG_BUY[\\\"Generate BUY signal\\\"]\\n    CALC_VOL_SELL --\\u003e SIG_SHORT[\\\"Generate SELL_SHORT signal\\\"]\\n    \\n    SIG_SELL --\\u003e SAVE[\\\"Save Signal to database\\\"]\\n    SIG_COVER --\\u003e SAVE\\n    SIG_BUY --\\u003e SAVE\\n    SIG_SHORT --\\u003e SAVE\\n    ROLL_SIG --\\u003e SAVE\\n    ROLL_CHECK_LONG --\\u003e END\\n    ROLL_CHECK_SHORT --\\u003e END\\n    CHECK_SIGNAL --\\u003e|None| END\\n    \\n    SAVE --\\u003e END[\\\"Return signal, margin\\\"]\\n```\\n\\n**Technical Indicator Calculations:**\\n\\n- **ATR (Average True Range)**: [trader/strategy/brother2.py:737]() using TA-Lib\\n- **Short-term SMA**: Manual calculation [trader/strategy/brother2.py:741]()\\n- **Long-term SMA**: Manual calculation [trader/strategy/brother2.py:742]()\\n- **Breakout levels**: Rolling max/min [trader/strategy/brother2.py:743-744]()\\n\\n**Position Sizing Formula:**\\n\\n```\\nvolume = (starting_capital + section_profit) * risk_parameter / (ATR * volume_multiple)\\n```\\n\\nImplemented in [trader/strategy/brother2.py:828-835]()\\n\\n**Sources:** [trader/strategy/brother2.py:725-856](), [panel/models.py:173-192]()\\n\\n---\\n\\n## Order Execution System\\n\\n### Order Lifecycle State Machine\\n\\n```mermaid\\nstateDiagram-v2\\n    [*] --\\u003e SignalCreated: \\\"Signal generated by calc_signal()\\\"\\n    SignalCreated --\\u003e SignalQueued: \\\"Stored in database\\\"\\n    SignalQueued --\\u003e OrderSubmitted: \\\"ReqOrderInsert() at scheduled time\\\"\\n    \\n    OrderSubmitted --\\u003e OrderAccepted: \\\"OnRtnOrder: OrderSubmitStatus=Accepted\\\"\\n    OrderSubmitted --\\u003e OrderRejected: \\\"OnRtnOrder: OrderSubmitStatus=Rejected\\\"\\n    \\n    OrderAccepted --\\u003e PartiallyFilled: \\\"OnRtnTrade: VolumeTraded \\u003c Volume\\\"\\n    OrderAccepted --\\u003e AllTraded: \\\"OnRtnTrade: VolumeTraded = Volume\\\"\\n    \\n    PartiallyFilled --\\u003e AllTraded: \\\"OnRtnTrade: Complete fill\\\"\\n    PartiallyFilled --\\u003e Canceled: \\\"User cancellation\\\"\\n    \\n    OrderRejected --\\u003e PriceAdjust: \\\"Price outside limit\\\"\\n    PriceAdjust --\\u003e OrderSubmitted: \\\"Retry with adjusted price\\\"\\n    \\n    AllTraded --\\u003e TradeRecorded: \\\"Update Trade model\\\"\\n    TradeRecorded --\\u003e SignalProcessed: \\\"Mark signal.processed=True\\\"\\n    SignalProcessed --\\u003e [*]\\n    \\n    Canceled --\\u003e [*]\\n    OrderRejected --\\u003e [*]: \\\"Fatal error\\\"\\n```\\n\\n### Order Submission: ReqOrderInsert()\\n\\nThe `ReqOrderInsert()` method in [trader/strategy/brother2.py:301-343]() handles order construction and submission:\\n\\n**Order Reference Format:**\\n```\\nOrderRef = {AutoIncrement:07d}{SignalID:05d}\\n```\\n\\nExample: `0000042000123` = Auto ID 42, Signal ID 123\\n\\n**Order Parameter Mapping:**\\n\\n| Signal Type | Direction | OffsetFlag | Notes |\\n|-------------|-----------|------------|-------|\\n| `BUY` | `D_Buy` | `OF_Open` | Open long position |\\n| `SELL` | `D_Sell` | `OF_Close` or `OF_CloseToday` | Close long (SHFE differentiates) |\\n| `SELL_SHORT` | `D_Sell` | `OF_Open` | Open short position |\\n| `BUY_COVER` | `D_Buy` | `OF_Close` or `OF_CloseToday` | Close short (SHFE differentiates) |\\n| `ROLL_CLOSE` | Based on position | `OF_Close` or `OF_CloseToday` | Exit old contract |\\n| `ROLL_OPEN` | Based on position | `OF_Open` | Enter new contract |\\n\\n**Special Handling:**\\n- SHFE (Shanghai Futures Exchange) requires distinction between `OF_Close` (close yesterday) and `OF_CloseToday` (close today)\\n- Implemented in [trader/strategy/brother2.py:324-325]() and [trader/strategy/brother2.py:331-332]()\\n\\n**Sources:** [trader/strategy/brother2.py:301-343]()\\n\\n### Order Callbacks: OnRtnOrder() and OnRtnTrade()\\n\\n#### OnRtnOrder Callback\\n\\nRegistered at [trader/strategy/brother2.py:510-566](), handles order status updates:\\n\\n**Key Responsibilities:**\\n1. Save order details to `Order` model\\n2. Handle rejected orders due to price limit violations\\n3. Automatically adjust price and resubmit (50% delta adjustment)\\n\\n**Price Adjustment Algorithm** [trader/strategy/brother2.py:522-564]():\\n```python\\n# For orders rejected due to limit price violation:\\nif order_rejected and price_outside_limit:\\n    delta = (submitted_price - settlement) * 0.5\\n    new_price = settlement + delta\\n    if delta / settlement \\u003c 0.01:\\n        abort_order()  # Delta too small\\n    else:\\n        resubmit_with_new_price()\\n```\\n\\n#### OnRtnTrade Callback\\n\\nRegistered at [trader/strategy/brother2.py:391-469](), handles trade execution confirmations:\\n\\n**Opening Position Flow:**\\n1. Query existing `Trade` for the same instrument and direction\\n2. If new trade: Create `Trade` record\\n3. If partial fill: Update `avg_entry_price` and `filled_shares`\\n4. Calculate trade cost (commission) and frozen margin\\n\\n**Closing Position Flow:**\\n1. Find open `Trade` with matching instrument and opposite direction\\n2. Update `avg_exit_price` and `closed_shares`\\n3. Calculate profit: `(exit_price - entry_price) * volume * multiplier`\\n4. Mark `Trade.close_time` when fully closed\\n5. Mark `Signal.processed = True`\\n\\n**Trade Cost Calculation** [trader/strategy/brother2.py:406]():\\n```python\\ncost = volume * price * fee_money * volume_multiple + volume * fee_volume\\n```\\n\\n**Sources:** [trader/strategy/brother2.py:391-469](), [trader/strategy/brother2.py:510-566]()\\n\\n---\\n\\n## Risk Management Features\\n\\n### Position Size Calculation\\n\\nPosition sizing is ATR-based and accounts for section-level P\\u0026L. Implemented in [trader/strategy/brother2.py:828-835]():\\n\\n**Formula:**\\n```\\nrisk_each = ATR * volume_multiple\\nvolume = (starting_capital + section_profit) * risk_parameter / risk_each\\n```\\n\\n**Risk Parameter:** Configurable via `Param` model with code `'Risk'` [trader/strategy/brother2.py:732]()\\n\\n### Stop-Loss Mechanism\\n\\nStop-loss is triggered when price moves against the position by `stop_n * ATR` from the highest (long) or lowest (short) point since entry.\\n\\n**Long Position Stop-Loss** [trader/strategy/brother2.py:776]():\\n```python\\nif close \\u003c= max(high[entry_idx:current]) - ATR[entry_idx] * stop_n:\\n    signal = SELL\\n```\\n\\n**Short Position Stop-Loss** [trader/strategy/brother2.py:808]():\\n```python\\nif close \\u003e= min(low[entry_idx:current]) + ATR[entry_idx] * stop_n:\\n    signal = BUY_COVER\\n```\\n\\n### Margin Risk Warning\\n\\nThe system monitors total margin usage and warns when risk exceeds 80% of equity. Implemented in [trader/strategy/brother2.py:719-721]():\\n\\n```python\\nif (all_margin + current_margin) / current_equity \\u003e 0.8:\\n    log_risk_warning()\\n```\\n\\n**Sources:** [trader/strategy/brother2.py:725-856]()\\n\\n---\\n\\n## Scheduled Task System\\n\\n### Cron-Based Scheduling\\n\\nThe `@RegisterCallback` decorator enables cron-based task scheduling. Defined in [trader/strategy/__init__.py:58-79]().\\n\\n### Trading Session Schedule\\n\\n| Time | Task | Function | Purpose |\\n|------|------|----------|---------|\\n| `55 8 * * *` | Process day session signals | `processing_signal1()` | Execute non-CFFEX signals |\\n| `1 9 * * *` | Check signal processing | `check_signal1_processed()` | Retry missed signals |\\n| `25 9 * * *` | Process CFFEX signals | `processing_signal2()` | Execute stock index futures |\\n| `31 9 * * *` | Check CFFEX processing | `check_signal2_processed()` | Retry CFFEX signals |\\n| `20 15 * * *` | Refresh account data | `refresh_all()` | Update balances, positions |\\n| `30 15 * * *` | Update performance | `update_equity()` | Calculate NAV, equity |\\n| `0 17 * * *` | Collect market data | `collect_quote()` | Fetch daily bars |\\n| `55 20 * * *` | Process night signals | `processing_signal3()` | Execute night trading signals |\\n| `1 21 * * *` | Check night processing | `check_signal3_processed()` | Retry night signals |\\n| `*/1 * * * *` | Heartbeat | `heartbeat()` | System health check |\\n\\n**Signal Processing Logic:**\\n\\nAll `processing_signal*()` functions follow the same pattern [trader/strategy/brother2.py:572-642]():\\n1. Check if today is a trading day\\n2. Query unprocessed signals from database\\n3. Sort by priority (`-priority`)\\n4. Call `ReqOrderInsert()` for each signal\\n\\n**Sources:** [trader/strategy/brother2.py:568-703](), [trader/strategy/__init__.py:58-79]()\\n\\n---\\n\\n## Account and Position Management\\n\\n### Account Refresh: refresh_account()\\n\\nExecuted at [trader/strategy/brother2.py:86-112](), updates broker account state:\\n\\n**Equity Calculations:**\\n```python\\n# Static equity (pre_balance) = yesterday_settlement + deposit - withdraw\\npre_balance = PreBalance + deposit - withdraw\\n\\n# Dynamic equity (current) = static + closed_profit + position_profit - commission\\ncurrent = pre_balance + CloseProfit + PositionProfit - Commission\\n\\n# Available cash\\ncash = Available\\n\\n# Used margin\\nmargin = CurrMargin\\n```\\n\\n**Database Update:** [trader/strategy/brother2.py:104-108]()\\n\\n### Position Refresh: refresh_position()\\n\\nExecuted at [trader/strategy/brother2.py:114-154](), synchronizes positions with CTP:\\n\\n**Process:**\\n1. Query `InvestorPositionDetail` from CTP API\\n2. Aggregate positions by instrument (multiple fills  single position)\\n3. Calculate weighted average open price\\n4. Update or create `Trade` records in database\\n5. Delete trades that no longer exist\\n\\n**Position Aggregation** [trader/strategy/brother2.py:123-130]():\\n```python\\nif existing_position:\\n    avg_price = (old_price * old_volume + new_price * new_volume) / (old_volume + new_volume)\\n    volume += new_volume\\n    profit += position_profit\\n    margin += position_margin\\n```\\n\\n**Sources:** [trader/strategy/brother2.py:86-154]()\\n\\n### Instrument Refresh: refresh_instrument()\\n\\nExecuted at [trader/strategy/brother2.py:156-205](), updates contract specifications:\\n\\n**Data Gathered:**\\n- Exchange and product ID\\n- Contract name and volume multiple\\n- Price tick size\\n- Margin rate (for main contract)\\n- Commission fees (for main contract)\\n\\n**Sources:** [trader/strategy/brother2.py:156-205]()\\n\\n---\\n\\n## Performance Tracking\\n\\n### Daily NAV Calculation: update_equity()\\n\\nScheduled at 15:30 daily [trader/strategy/brother2.py:656-682](), calculates performance metrics:\\n\\n**Net Asset Value (NAV):**\\n```python\\nunit_count = historical_dividend + fake_capital\\nNAV = (current_equity + fake_capital) / unit_count\\n```\\n\\n**Accumulated NAV:**\\n```python\\naccumulated = current_equity / (unit_count - fake_capital)\\n```\\n\\n**Performance Record Fields:**\\n- `capital`: Current equity\\n- `used_margin`: Margin in use\\n- `dividend`: Net deposits (deposit - withdraw)\\n- `fake`: Virtual capital for testing\\n- `NAV`: Unit net asset value\\n- `accumulated`: Cumulative NAV\\n\\n**Sources:** [trader/strategy/brother2.py:656-682](), [panel/models.py:85-102]()\\n\\n---\\n\\n## Integration Architecture\\n\\n### Redis Channel Patterns\\n\\nThe system uses pattern-based subscriptions for flexible message routing:\\n\\n| Channel Pattern | Direction | Purpose |\\n|----------------|-----------|---------|\\n| `MSG:CTP:REQ:{command}` | Outbound | Send commands to CTP API |\\n| `MSG:CTP:RSP:TRADE:{callback}:{orderRef}` | Inbound | Order/trade updates |\\n| `MSG:CTP:RSP:MARKET:{callback}:{instrument}` | Inbound | Market data ticks |\\n| `MSG:CTP:RSP:TRADE:OnRspQry{queryType}:{requestID}` | Inbound | Query responses |\\n\\n**Pattern Subscription** [trader/strategy/brother2.py:373](), [trader/strategy/brother2.py:391](), [trader/strategy/brother2.py:510]():\\n```python\\n@RegisterCallback(channel='MSG:CTP:RSP:TRADE:OnRtnOrder:*')\\n@RegisterCallback(channel='MSG:CTP:RSP:TRADE:OnRtnTrade:*')\\n@RegisterCallback(channel='MSG:CTP:RSP:MARKET:OnRtnDepthMarketData:*')\\n```\\n\\n### Database Models Integration\\n\\n```mermaid\\ngraph LR\\n    TS[\\\"TradeStrategy\\\"]\\n    \\n    subgraph \\\"Core Models\\\"\\n        STRAT[\\\"Strategy\\\"]\\n        INST[\\\"Instrument\\\"]\\n        SIG[\\\"Signal\\\"]\\n        ORD[\\\"Order\\\"]\\n        TRD[\\\"Trade\\\"]\\n    end\\n    \\n    subgraph \\\"Account Models\\\"\\n        BRKR[\\\"Broker\\\"]\\n        PERF[\\\"Performance\\\"]\\n    end\\n    \\n    subgraph \\\"Market Data\\\"\\n        DBAR[\\\"DailyBar\\\"]\\n        MBAR[\\\"MainBar\\\"]\\n    end\\n    \\n    TS --\\u003e|read| STRAT\\n    TS --\\u003e|read| INST\\n    TS --\\u003e|read/write| SIG\\n    TS --\\u003e|write| ORD\\n    TS --\\u003e|read/write| TRD\\n    TS --\\u003e|read/write| BRKR\\n    TS --\\u003e|write| PERF\\n    TS --\\u003e|read| DBAR\\n    TS --\\u003e|read| MBAR\\n    \\n    STRAT --\\u003e|references| BRKR\\n    STRAT --\\u003e|many-to-many| INST\\n    SIG --\\u003e|references| STRAT\\n    SIG --\\u003e|references| INST\\n    ORD --\\u003e|one-to-one| SIG\\n    TRD --\\u003e|one-to-one| ORD\\n```\\n\\n**Sources:** [panel/models.py:61-289](), [trader/strategy/brother2.py:38-871]()\\n\\n---\\n\\n## Code Reference Summary\\n\\n### Key Classes and Methods\\n\\n| Component | File | Lines | Description |\\n|-----------|------|-------|-------------|\\n| `TradeStrategy` | trader/strategy/brother2.py | 38-871 | Main strategy orchestrator |\\n| `BaseModule` | trader/strategy/__init__.py | 36-140 | Async framework base class |\\n| `calc_signal()` | trader/strategy/brother2.py | 725-856 | Signal generation algorithm |\\n| `ReqOrderInsert()` | trader/strategy/brother2.py | 301-343 | Order submission |\\n| `OnRtnOrder()` | trader/strategy/brother2.py | 510-566 | Order status callback |\\n| `OnRtnTrade()` | trader/strategy/brother2.py | 391-469 | Trade execution callback |\\n| `refresh_account()` | trader/strategy/brother2.py | 86-112 | Account balance update |\\n| `refresh_position()` | trader/strategy/brother2.py | 114-154 | Position synchronization |\\n| `collect_quote()` | trader/strategy/brother2.py | 684-703 | Market data collection |\\n| `calculate()` | trader/strategy/brother2.py | 705-723 | Signal calculation loop |\\n\\n### Key Models\\n\\n| Model | File | Lines | Purpose |\\n|-------|------|-------|---------|\\n| `Strategy` | panel/models.py | 104-126 | Strategy configuration |\\n| `Instrument` | panel/models.py | 146-171 | Contract specifications |\\n| `Signal` | panel/models.py | 173-192 | Trading signals |\\n| `Order` | panel/models.py | 237-260 | Order records |\\n| `Trade` | panel/models.py | 262-289 | Position records |\\n| `Broker` | panel/models.py | 61-83 | Account information |\\n| `Performance` | panel/models.py | 85-102 | Daily performance metrics |\\n| `DailyBar` | panel/models.py | 216-235 | Individual contract OHLC |\\n| `MainBar` | panel/models.py | 194-214 | Continuous contract OHLC |\\n\\n**Sources:** [trader/strategy/brother2.py:1-871](), [trader/strategy/__init__.py:1-140](), [panel/models.py:1-289]()\"])</script><script>self.__next_f.push([1,\"21:T8521,\"])</script><script>self.__next_f.push([1,\"# TradeStrategy Class\\n\\n\\u003cdetails\\u003e\\n\\u003csummary\\u003eRelevant source files\\u003c/summary\\u003e\\n\\nThe following files were used as context for generating this wiki page:\\n\\n- [panel/const.py](panel/const.py)\\n- [panel/models.py](panel/models.py)\\n- [trader/strategy/brother2.py](trader/strategy/brother2.py)\\n\\n\\u003c/details\\u003e\\n\\n\\n\\n## Purpose and Scope\\n\\nThe `TradeStrategy` class is the core trading engine of the automated futures trading system. It extends `BaseModule` to provide complete trading lifecycle management: account monitoring, position tracking, signal generation, order execution, and performance calculation. This class orchestrates all trading operations for Chinese commodity futures markets through the CTP API via Redis Pub/Sub.\\n\\nFor information about the base framework that provides Redis integration and scheduling, see [BaseModule Framework](#4.2). For details on how signals are generated using technical indicators, see [Signal Generation](#4.3). For the complete order execution workflow, see [Order Execution Flow](#4.4).\\n\\n**Sources:** [trader/strategy/brother2.py:38-871]()\\n\\n## Class Overview\\n\\n### Inheritance and Initialization\\n\\n`TradeStrategy` extends `BaseModule` to inherit Redis Pub/Sub capabilities and cron-based scheduling infrastructure. The class is initialized with a strategy name that links it to a specific `Strategy` model instance in the database.\\n\\n```mermaid\\nclassDiagram\\n    class BaseModule {\\n        +redis_client\\n        +raw_redis\\n        +io_loop\\n        +install()\\n        +RegisterCallback decorator\\n    }\\n    \\n    class TradeStrategy {\\n        -__strategy: Strategy\\n        -__broker: Broker\\n        -__inst_ids: list\\n        -__fake: Decimal\\n        -__current: Decimal\\n        -__cash: Decimal\\n        -__margin: Decimal\\n        -__cur_pos: dict\\n        -__activeOrders: dict\\n        -__trading_day: datetime\\n        -__last_trading_day: datetime\\n        +start()\\n        +refresh_account()\\n        +refresh_position()\\n        +refresh_instrument()\\n        +ReqOrderInsert()\\n        +cancel_order()\\n        +calculate()\\n        +calc_signal()\\n        +OnRtnTrade()\\n        +OnRtnOrder()\\n        +OnRtnDepthMarketData()\\n    }\\n    \\n    class Strategy {\\n        +broker: Broker\\n        +name: str\\n        +instruments: ManyToMany\\n        +param_set: ParamManager\\n    }\\n    \\n    class Broker {\\n        +cash: Decimal\\n        +current: Decimal\\n        +margin: Decimal\\n        +fake: Decimal\\n    }\\n    \\n    BaseModule \\u003c|-- TradeStrategy\\n    TradeStrategy --\\u003e Strategy\\n    Strategy --\\u003e Broker\\n```\\n\\n**Key initialization parameters** [trader/strategy/brother2.py:39-62]():\\n\\n| Parameter | Type | Purpose |\\n|-----------|------|---------|\\n| `name` | str | Strategy name to load from database |\\n| `__strategy` | Strategy | Django model instance containing strategy configuration |\\n| `__broker` | Broker | Account information and credentials |\\n| `__inst_ids` | list | Product codes this strategy trades |\\n| `__fake` | Decimal | Virtual capital for tracking |\\n| `__current` | Decimal | Dynamic equity (current portfolio value) |\\n| `__pre_balance` | Decimal | Static equity (previous settlement) |\\n| `__cash` | Decimal | Available cash for trading |\\n| `__margin` | Decimal | Occupied margin |\\n| `__cur_pos` | dict | Current positions by instrument code |\\n| `__activeOrders` | dict | Pending orders |\\n| `__trading_day` | datetime | Current trading day |\\n| `__last_trading_day` | datetime | Previous trading day |\\n\\n**Sources:** [trader/strategy/brother2.py:38-62](), [panel/models.py:104-126](), [panel/models.py:61-83]()\\n\\n### State Management Architecture\\n\\n```mermaid\\ngraph TB\\n    subgraph \\\"TradeStrategy Internal State\\\"\\n        AccountState[\\\"Account State\\u003cbr/\\u003e__cash, __current\\u003cbr/\\u003e__margin, __fake\\\"]\\n        PositionState[\\\"Position State\\u003cbr/\\u003e__cur_pos: dict\\u003cbr/\\u003e__shares: dict\\\"]\\n        ConfigState[\\\"Configuration State\\u003cbr/\\u003e__strategy: Strategy\\u003cbr/\\u003e__broker: Broker\\u003cbr/\\u003e__inst_ids: list\\\"]\\n        TradingDays[\\\"Trading Calendar\\u003cbr/\\u003e__trading_day\\u003cbr/\\u003e__last_trading_day\\\"]\\n    end\\n    \\n    subgraph \\\"Database Models\\\"\\n        BrokerModel[\\\"Broker Model\\u003cbr/\\u003epanel.models.Broker\\\"]\\n        TradeModel[\\\"Trade Model\\u003cbr/\\u003epanel.models.Trade\\\"]\\n        StrategyModel[\\\"Strategy Model\\u003cbr/\\u003epanel.models.Strategy\\\"]\\n        SignalModel[\\\"Signal Model\\u003cbr/\\u003epanel.models.Signal\\\"]\\n    end\\n    \\n    subgraph \\\"External State\\\"\\n        Redis[\\\"Redis\\u003cbr/\\u003eTradingDay key\\u003cbr/\\u003eLIMITRATIO keys\\\"]\\n        CTP[\\\"CTP API\\u003cbr/\\u003eAccount queries\\u003cbr/\\u003ePosition queries\\\"]\\n    end\\n    \\n    ConfigState --\\u003e StrategyModel\\n    ConfigState --\\u003e BrokerModel\\n    AccountState --\\u003e BrokerModel\\n    PositionState --\\u003e TradeModel\\n    \\n    CTP -.-\\u003e|refresh_account| AccountState\\n    CTP -.-\\u003e|refresh_position| PositionState\\n    Redis -.-\\u003e|get TradingDay| TradingDays\\n    Redis -.-\\u003e|get LIMITRATIO| ConfigState\\n    \\n    AccountState -.-\\u003e|save| BrokerModel\\n    PositionState -.-\\u003e|update/create| TradeModel\\n```\\n\\n**Sources:** [trader/strategy/brother2.py:45-62](), [trader/strategy/brother2.py:86-113](), [trader/strategy/brother2.py:114-154]()\\n\\n## Core Responsibilities\\n\\n### 1. Account Management\\n\\nThe `refresh_account()` method queries CTP for current account status and synchronizes it with the database.\\n\\n**Key operations** [trader/strategy/brother2.py:86-112]():\\n\\n1. Query `TradingAccount` from CTP via Redis\\n2. Calculate virtual capital: `fake = original_fake - deposit + withdraw`\\n3. Calculate static equity: `pre_balance = previous_balance + deposit - withdraw`\\n4. Calculate dynamic equity: `current = static + close_profit + position_profit - commission`\\n5. Update `Broker` model in database\\n\\n```mermaid\\nsequenceDiagram\\n    participant TS as TradeStrategy\\n    participant Redis as Redis Pub/Sub\\n    participant CTP as CTP API\\n    participant DB as Django ORM\\n    \\n    TS-\\u003e\\u003eRedis: query('TradingAccount')\\n    Redis-\\u003e\\u003eCTP: ReqQryTradingAccount\\n    CTP--\\u003e\\u003eRedis: OnRspQryTradingAccount\\n    Redis--\\u003e\\u003eTS: account data\\n    \\n    TS-\\u003e\\u003eTS: Calculate fake, pre_balance, current\\n    TS-\\u003e\\u003eDB: Broker.save(cash, current, margin)\\n    \\n    Note over TS: Updated state:\\u003cbr/\\u003e__cash, __current\\u003cbr/\\u003e__pre_balance, __margin\\n```\\n\\n**Sources:** [trader/strategy/brother2.py:86-112]()\\n\\n### 2. Position Management\\n\\nThe `refresh_position()` method synchronizes positions from CTP with the `Trade` model.\\n\\n**Key operations** [trader/strategy/brother2.py:114-154]():\\n\\n1. Query `InvestorPositionDetail` from CTP\\n2. Aggregate positions by instrument code (handling multiple position entries)\\n3. Delete trades that no longer exist in CTP\\n4. Create or update `Trade` records with current position details\\n\\n| Field | Source | Calculation |\\n|-------|--------|-------------|\\n| `shares` | CTP | Sum of all position volumes |\\n| `avg_entry_price` | CTP | Weighted average open price |\\n| `profit` | DailyBar | `(close - open_price) * volume * multiplier * direction` |\\n| `frozen_margin` | CTP | Sum of margin for all positions |\\n\\n**Sources:** [trader/strategy/brother2.py:114-154](), [panel/models.py:262-289]()\\n\\n### 3. Instrument Management\\n\\nThe `refresh_instrument()` method updates contract specifications from CTP.\\n\\n**Key operations** [trader/strategy/brother2.py:156-205]():\\n\\n1. Query all tradable instruments from CTP\\n2. Filter by product class (futures only) and ignore list\\n3. Extract contract specifications: exchange, name, multiplier, price tick\\n4. For main contracts, query margin rates and commission rates\\n5. Update `Instrument` model\\n\\n**Sources:** [trader/strategy/brother2.py:156-205](), [panel/models.py:146-171]()\\n\\n## Signal Generation and Trading Logic\\n\\n### Signal Calculation Method\\n\\nThe `calc_signal()` method generates trading signals using technical indicators for each instrument.\\n\\n```mermaid\\nflowchart TD\\n    Start[\\\"calc_signal(inst, day)\\\"]\\n    LoadParams[\\\"Load Strategy Parameters\\u003cbr/\\u003eBreakPeriod, AtrPeriod\\u003cbr/\\u003eLongPeriod, ShortPeriod\\u003cbr/\\u003eStopLoss, Risk\\\"]\\n    LoadData[\\\"Load MainBar data\\u003cbr/\\u003e(last 400 records)\\\"]\\n    CalcIndicators[\\\"Calculate Indicators\\u003cbr/\\u003eATR(atr_n)\\u003cbr/\\u003eshort_trend (SMA)\\u003cbr/\\u003elong_trend (SMA)\\u003cbr/\\u003ehigh_line (max)\\u003cbr/\\u003elow_line (min)\\\"]\\n    \\n    CheckPosition{\\\"Has Position?\\\"}\\n    CheckRollover{\\\"Rollover\\u003cbr/\\u003eRequired?\\\"}\\n    \\n    BuySignal{\\\"Short \\u003e Long AND\\u003cbr/\\u003eClose \\u003e= High Line?\\\"}\\n    SellSignal{\\\"Short \\u003c Long AND\\u003cbr/\\u003eClose \\u003c= Low Line?\\\"}\\n    \\n    LongPosition{\\\"Long\\u003cbr/\\u003ePosition?\\\"}\\n    CheckLongStop{\\\"Close \\u003c= Max High\\u003cbr/\\u003e- ATR * StopN?\\\"}\\n    \\n    ShortPosition{\\\"Short\\u003cbr/\\u003ePosition?\\\"}\\n    CheckShortStop{\\\"Close \\u003e= Min Low\\u003cbr/\\u003e+ ATR * StopN?\\\"}\\n    \\n    GenerateSignal[\\\"Generate Signal\\u003cbr/\\u003eCreate/Update in DB\\\"]\\n    CalcVolume[\\\"Calculate Volume\\u003cbr/\\u003e(start_cash + profit) * risk / (ATR * multiplier)\\\"]\\n    \\n    Start --\\u003e LoadParams\\n    LoadParams --\\u003e LoadData\\n    LoadData --\\u003e CalcIndicators\\n    CalcIndicators --\\u003e CheckPosition\\n    \\n    CheckPosition --\\u003e|Yes| CheckRollover\\n    CheckPosition --\\u003e|No| BuySignal\\n    \\n    CheckRollover --\\u003e|Yes| GenerateSignal\\n    CheckRollover --\\u003e|No| LongPosition\\n    \\n    LongPosition --\\u003e|Yes| CheckLongStop\\n    LongPosition --\\u003e|No| ShortPosition\\n    \\n    CheckLongStop --\\u003e|Yes| GenerateSignal\\n    CheckLongStop --\\u003e|No| End\\n    \\n    ShortPosition --\\u003e|Yes| CheckShortStop\\n    CheckShortStop --\\u003e|Yes| GenerateSignal\\n    CheckShortStop --\\u003e|No| End\\n    \\n    BuySignal --\\u003e|Yes| CalcVolume\\n    BuySignal --\\u003e|No| SellSignal\\n    \\n    SellSignal --\\u003e|Yes| CalcVolume\\n    SellSignal --\\u003e|No| End\\n    \\n    CalcVolume --\\u003e GenerateSignal\\n    GenerateSignal --\\u003e End[\\\"Return Signal, Margin\\\"]\\n    \\n    End\\n```\\n\\n**Technical Indicator Calculations** [trader/strategy/brother2.py:734-744]():\\n\\n| Indicator | Formula | Purpose |\\n|-----------|---------|---------|\\n| `atr` | `ATR(high, low, close, atr_n)` | Volatility measurement for position sizing |\\n| `short_trend` | `SMA(close, short_n)` | Short-term trend direction |\\n| `long_trend` | `SMA(close, long_n)` | Long-term trend direction |\\n| `high_line` | `max(close, break_n)` | Breakout resistance level |\\n| `low_line` | `min(close, break_n)` | Breakout support level |\\n\\n**Signal Types Generated** [trader/strategy/brother2.py:759-856]():\\n\\n```mermaid\\nstateDiagram-v2\\n    [*] --\\u003e NoPosition\\n    \\n    NoPosition --\\u003e LongPosition: BUY Signal\\u003cbr/\\u003e(short_trend \\u003e long_trend\\u003cbr/\\u003eAND close \\u003e= high_line)\\n    NoPosition --\\u003e ShortPosition: SELL_SHORT Signal\\u003cbr/\\u003e(short_trend \\u003c long_trend\\u003cbr/\\u003eAND close \\u003c= low_line)\\n    \\n    LongPosition --\\u003e NoPosition: SELL Signal\\u003cbr/\\u003e(Stop Loss:\\u003cbr/\\u003eclose \\u003c= max_high - ATR*stop_n)\\n    LongPosition --\\u003e LongPosition: ROLL_CLOSE + ROLL_OPEN\\u003cbr/\\u003e(Contract Rollover)\\n    \\n    ShortPosition --\\u003e NoPosition: BUY_COVER Signal\\u003cbr/\\u003e(Stop Loss:\\u003cbr/\\u003eclose \\u003e= min_low + ATR*stop_n)\\n    ShortPosition --\\u003e ShortPosition: ROLL_CLOSE + ROLL_OPEN\\u003cbr/\\u003e(Contract Rollover)\\n    \\n    note right of NoPosition\\n        Position Sizing:\\n        volume = (capital + profit) * risk / (ATR * multiplier)\\n    end note\\n    \\n    note right of LongPosition\\n        Stop Loss:\\n        Exit when price drops\\n        ATR*stop_n from highest high\\n    end note\\n    \\n    note right of ShortPosition\\n        Stop Loss:\\n        Exit when price rises\\n        ATR*stop_n from lowest low\\n    end note\\n```\\n\\n**Sources:** [trader/strategy/brother2.py:725-856](), [panel/const.py:165-172]()\\n\\n### Position Sizing Algorithm\\n\\n**Formula** [trader/strategy/brother2.py:828-835]():\\n\\n```\\nvolume = (start_cash + profit) * risk / (ATR * volume_multiple)\\n```\\n\\nWhere:\\n- `start_cash`: Initial capital (from Performance.unit_count)\\n- `profit`: Cumulative profit from same section instruments\\n- `risk`: Risk parameter (e.g., 0.02 for 2% risk per trade)\\n- `ATR`: Average True Range (volatility)\\n- `volume_multiple`: Contract multiplier\\n\\n**Sources:** [trader/strategy/brother2.py:828-835]()\\n\\n## Order Execution\\n\\n### Order Insertion Method\\n\\nThe `ReqOrderInsert()` method constructs and publishes order requests to CTP via Redis.\\n\\n**Order Request Structure** [trader/strategy/brother2.py:301-343]():\\n\\n```mermaid\\nflowchart LR\\n    Signal[\\\"Signal Object\\u003cbr/\\u003einstrument, code\\u003cbr/\\u003etype, price, volume\\\"]\\n    \\n    OrderRef[\\\"Generate OrderRef\\u003cbr/\\u003eFormat: AAAAAAASSSSS\\u003cbr/\\u003eA=Autonumber(7 digits)\\u003cbr/\\u003eS=Signal ID(5 digits)\\\"]\\n    \\n    ParamDict[\\\"Order Parameters\\u003cbr/\\u003eInstrumentID\\u003cbr/\\u003eDirection\\u003cbr/\\u003eCombOffsetFlag\\u003cbr/\\u003eLimitPrice\\u003cbr/\\u003eVolumeTotalOriginal\\\"]\\n    \\n    CheckType{\\\"Signal Type\\\"}\\n    \\n    BuyOpen[\\\"BUY/SELL_SHORT\\u003cbr/\\u003eDirection = D_Buy/D_Sell\\u003cbr/\\u003eOffsetFlag = Open\\\"]\\n    \\n    SellClose[\\\"SELL/BUY_COVER\\u003cbr/\\u003eDirection = D_Sell/D_Buy\\u003cbr/\\u003eOffsetFlag = Close\\u003cbr/\\u003eCheck SHFE CloseToday\\\"]\\n    \\n    RollClose[\\\"ROLL_CLOSE\\u003cbr/\\u003eGet existing position\\u003cbr/\\u003eReverse direction\\u003cbr/\\u003eOffsetFlag = Close\\\"]\\n    \\n    RollOpen[\\\"ROLL_OPEN\\u003cbr/\\u003eMatch position direction\\u003cbr/\\u003eOffsetFlag = Open\\\"]\\n    \\n    Publish[\\\"Publish to Redis\\u003cbr/\\u003eMSG:CTP:REQ:ReqOrderInsert\\\"]\\n    \\n    Signal --\\u003e OrderRef\\n    OrderRef --\\u003e ParamDict\\n    ParamDict --\\u003e CheckType\\n    \\n    CheckType --\\u003e BuyOpen\\n    CheckType --\\u003e SellClose\\n    CheckType --\\u003e RollClose\\n    CheckType --\\u003e RollOpen\\n    \\n    BuyOpen --\\u003e Publish\\n    SellClose --\\u003e Publish\\n    RollClose --\\u003e Publish\\n    RollOpen --\\u003e Publish\\n```\\n\\n**OrderRef Format** [trader/strategy/brother2.py:304-305]():\\n- 7-digit Autonumber ID (from database sequence)\\n- 5-digit Signal ID\\n- Example: `00001230004567` (Autonumber=123, Signal=4567)\\n\\n**Special Handling** [trader/strategy/brother2.py:324-333]():\\n- **SHFE CloseToday**: Shanghai Futures Exchange requires explicit `CloseToday` flag for intraday positions\\n- **Rollover Logic**: For `ROLL_CLOSE`, looks up existing position to determine direction; for `ROLL_OPEN`, matches previous position direction\\n\\n**Sources:** [trader/strategy/brother2.py:301-343](), [trader/utils/__init__.py:ORDER_REF_SIGNAL_ID_START]()\\n\\n### Order Cancellation\\n\\nThe `cancel_order()` method cancels pending orders using the CTP order action API.\\n\\n**Cancellation Flow** [trader/strategy/brother2.py:345-371]():\\n\\n1. Subscribe to response channels: `OnRtnOrder`, `OnRspOrderAction`, `OnRspError`\\n2. Publish cancellation request with original order details\\n3. Wait for confirmation (with timeout)\\n4. Handle errors from CTP error code dictionary\\n\\n**Sources:** [trader/strategy/brother2.py:345-371]()\\n\\n## Callback Handlers\\n\\n### Trade Confirmation Handler\\n\\nThe `OnRtnTrade()` callback processes trade execution confirmations from CTP.\\n\\n```mermaid\\nsequenceDiagram\\n    participant CTP as CTP API\\n    participant Redis as Redis Pub/Sub\\n    participant TS as TradeStrategy\\n    participant DB as Django ORM\\n    \\n    CTP-\\u003e\\u003eRedis: OnRtnTrade (execution report)\\n    Redis-\\u003e\\u003eTS: @RegisterCallback triggered\\n    \\n    TS-\\u003e\\u003eTS: Parse OrderRef to extract Signal ID\\n    \\n    alt Opening Trade\\n        TS-\\u003e\\u003eDB: Query/Create Trade record\\n        TS-\\u003e\\u003eTS: Calculate avg_entry_price\\n        TS-\\u003e\\u003eDB: Update filled_shares, cost, margin\\n    else Closing Trade\\n        TS-\\u003e\\u003eDB: Query existing Trade by code\\n        TS-\\u003e\\u003eTS: Calculate avg_exit_price\\n        TS-\\u003e\\u003eTS: Calculate profit = (exit - entry) * shares * multiplier\\n        TS-\\u003e\\u003eDB: Update closed_shares, profit, close_time\\n    end\\n    \\n    alt Trade Completed (all shares filled)\\n        TS-\\u003e\\u003eDB: Signal.processed = True\\n        TS-\\u003e\\u003eDB: Order.signal = signal\\n    end\\n    \\n    Note over TS,DB: Trade record now contains:\\u003cbr/\\u003eavg_entry_price, avg_exit_price\\u003cbr/\\u003efilled_shares, closed_shares\\u003cbr/\\u003eprofit, cost\\n```\\n\\n**Key Calculations** [trader/strategy/brother2.py:406-460]():\\n\\n| Calculation | Formula | Purpose |\\n|-------------|---------|---------|\\n| `trade_cost` | `volume * price * fee_money * multiplier + volume * fee_volume` | Commission fees |\\n| `trade_margin` | `volume * price * margin_rate` | Required margin |\\n| `avg_entry_price` | `(old_price * old_vol + new_price * new_vol) / total_vol` | Weighted average entry |\\n| `avg_exit_price` | `(old_price * old_vol + new_price * new_vol) / total_vol` | Weighted average exit |\\n| `profit` | `(exit_price - entry_price) * shares * multiplier` | P\\u0026L (reversed for short) |\\n\\n**Trade Completion Logic** [trader/strategy/brother2.py:463-467]():\\n- When `closed_shares == shares`, mark trade as complete\\n- Set `Signal.processed = True` to prevent reprocessing\\n- Link `Order.signal` for tracking\\n\\n**Sources:** [trader/strategy/brother2.py:391-469](), [panel/models.py:262-289]()\\n\\n### Order Status Handler\\n\\nThe `OnRtnOrder()` callback handles order status updates and rejected orders.\\n\\n**Rejection Handling** [trader/strategy/brother2.py:522-564]():\\n\\nWhen an order is rejected due to price beyond exchange limits, the system automatically adjusts and resubmits:\\n\\n1. Detect rejection: `OrderStatus.Canceled` + `OrderSubmitStatus.InsertRejected`\\n2. Calculate new price: `settlement  (requested_price - settlement) * 0.5`\\n3. Validate adjustment (must be \\u003e 1% of settlement)\\n4. Resubmit order with adjusted price\\n\\n**Price Adjustment Logic** [trader/strategy/brother2.py:528-564]():\\n\\n```\\nFor Buy Orders:\\n  delta = (limit_price - settlement) * 0.5\\n  new_price = round(settlement + delta, price_tick)\\n\\nFor Sell Orders:\\n  delta = (settlement - limit_price) * 0.5\\n  new_price = round(settlement - delta, price_tick)\\n```\\n\\n**Sources:** [trader/strategy/brother2.py:510-566]()\\n\\n### Market Data Handler\\n\\nThe `OnRtnDepthMarketData()` callback receives real-time tick data.\\n\\n**Purpose** [trader/strategy/brother2.py:373-380]():\\n- Receives real-time market depth updates\\n- Currently logs tick data for monitoring\\n- Can be extended for intraday trading logic\\n\\n**Sources:** [trader/strategy/brother2.py:373-380]()\\n\\n## Scheduled Tasks\\n\\nThe TradeStrategy class uses cron-based scheduling to execute tasks at specific times during the trading day.\\n\\n### Task Schedule Overview\\n\\n```mermaid\\ngantt\\n    title Daily Trading Schedule\\n    dateFormat HH:mm\\n    axisFormat %H:%M\\n    \\n    section Pre-Market\\n    processing_signal1 (Day Session)       :08:55, 6m\\n    check_signal1_processed                :09:01, 6m\\n    processing_signal2 (CFFEX)             :09:25, 6m\\n    check_signal2_processed                :09:31, 6m\\n    \\n    section Market Close\\n    refresh_all (Account/Position)         :15:20, 10m\\n    update_equity (Performance)            :15:30, 10m\\n    \\n    section Evening\\n    collect_quote (Exchange Data)          :17:00, 60m\\n    processing_signal3 (Night Session)     :20:55, 6m\\n    check_signal3_processed                :21:01, 6m\\n    \\n    section Monitoring\\n    heartbeat (Every Minute)               :08:00, 16h\\n```\\n\\n### Task Details\\n\\n| Cron Expression | Method | Purpose | Trading Session |\\n|----------------|--------|---------|----------------|\\n| `55 8 * * *` | `processing_signal1()` | Process day session signals (non-CFFEX) | Pre-market |\\n| `1 9 * * *` | `check_signal1_processed()` | Reprocess missed day signals | Market open |\\n| `25 9 * * *` | `processing_signal2()` | Process CFFEX signals (stock index/bonds) | CFFEX open |\\n| `31 9 * * *` | `check_signal2_processed()` | Reprocess missed CFFEX signals | CFFEX market |\\n| `20 15 * * *` | `refresh_all()` | Update account, positions, instruments | Market close |\\n| `30 15 * * *` | `update_equity()` | Calculate daily performance | Post-close |\\n| `0 17 * * *` | `collect_quote()` | Fetch exchange data, calculate signals | Evening |\\n| `55 20 * * *` | `processing_signal3()` | Process night session signals | Pre-night |\\n| `1 21 * * *` | `check_signal3_processed()` | Reprocess missed night signals | Night open |\\n| `*/1 * * * *` | `heartbeat()` | Maintain system alive status | Continuous |\\n\\n**Sources:** [trader/strategy/brother2.py:568-703]()\\n\\n### Signal Processing Tasks\\n\\n**Pre-Market Signal Processing** [trader/strategy/brother2.py:572-619]():\\n\\n```mermaid\\nflowchart TD\\n    Task[\\\"Scheduled Task Triggered\\\"]\\n    CheckTrading{\\\"is_trading_day()?\\\"}\\n    \\n    Task1[\\\"processing_signal1()\\u003cbr/\\u003e08:55\\u003cbr/\\u003eDay Session, Non-CFFEX\\\"]\\n    Query1[\\\"Query Signals WHERE\\u003cbr/\\u003eexchange != CFFEX\\u003cbr/\\u003enight_trade = False\\u003cbr/\\u003eprocessed = False\\\"]\\n    \\n    Task2[\\\"processing_signal2()\\u003cbr/\\u003e09:25\\u003cbr/\\u003eCFFEX Only\\\"]\\n    Query2[\\\"Query Signals WHERE\\u003cbr/\\u003eexchange = CFFEX\\u003cbr/\\u003enight_trade = False\\u003cbr/\\u003eprocessed = False\\\"]\\n    \\n    Task3[\\\"processing_signal3()\\u003cbr/\\u003e20:55\\u003cbr/\\u003eNight Session\\\"]\\n    Query3[\\\"Query Signals WHERE\\u003cbr/\\u003enight_trade = True\\u003cbr/\\u003eprocessed = False\\\"]\\n    \\n    OrderLoop[\\\"For each signal\\u003cbr/\\u003eOrder by -priority\\\"]\\n    Execute[\\\"ReqOrderInsert(signal)\\\"]\\n    \\n    Task --\\u003e CheckTrading\\n    CheckTrading --\\u003e|Yes| Task1\\n    CheckTrading --\\u003e|Yes| Task2\\n    CheckTrading --\\u003e|Yes| Task3\\n    CheckTrading --\\u003e|No| Skip[\\\"Skip processing\\\"]\\n    \\n    Task1 --\\u003e Query1\\n    Task2 --\\u003e Query2\\n    Task3 --\\u003e Query3\\n    \\n    Query1 --\\u003e OrderLoop\\n    Query2 --\\u003e OrderLoop\\n    Query3 --\\u003e OrderLoop\\n    \\n    OrderLoop --\\u003e Execute\\n```\\n\\n**Holiday Handling** [trader/strategy/brother2.py:583-585]():\\n- After 3+ day holidays, `processing_signal1()` triggers night signal processing\\n- Ensures signals generated before holiday are processed on first trading day\\n\\n**Sources:** [trader/strategy/brother2.py:572-642]()\\n\\n### Daily Update Tasks\\n\\n**Account and Position Refresh** [trader/strategy/brother2.py:644-654]():\\n\\n```\\nrefresh_all() at 15:20:\\n refresh_account()      Query TradingAccount, update Broker\\n refresh_position()     Query InvestorPositionDetail, sync Trade records\\n refresh_instrument()   Query Instrument specs, update margin/fees\\n```\\n\\n**Performance Calculation** [trader/strategy/brother2.py:656-682]():\\n\\n```\\nupdate_equity() at 15:30:\\n1. Calculate dividend = (previous dividends) + deposit - withdraw\\n2. Adjust fake capital = original_fake - deposit + withdraw\\n3. Calculate unit_count = dividend + fake\\n4. Calculate NAV = (current + fake) / unit_count\\n5. Calculate accumulated = current / (unit_count - fake)\\n6. Create/Update Performance record\\n```\\n\\n**Sources:** [trader/strategy/brother2.py:644-682]()\\n\\n### Data Collection and Signal Generation\\n\\n**Exchange Data Collection** [trader/strategy/brother2.py:684-703]():\\n\\n```mermaid\\nflowchart LR\\n    Trigger[\\\"collect_quote()\\u003cbr/\\u003e17:00 Daily\\\"]\\n    \\n    Tasks[\\\"Parallel Tasks:\\u003cbr/\\u003eupdate_from_shfe\\u003cbr/\\u003eupdate_from_dce\\u003cbr/\\u003eupdate_from_czce\\u003cbr/\\u003eupdate_from_cffex\\u003cbr/\\u003eupdate_from_gfex\\u003cbr/\\u003eget_contracts_argument\\\"]\\n    \\n    Gather[\\\"asyncio.gather\\u003cbr/\\u003eWait for all tasks\\\"]\\n    \\n    Success{\\\"All tasks\\u003cbr/\\u003esuccessful?\\\"}\\n    \\n    Calculate[\\\"calculate(day)\\u003cbr/\\u003eFor each instrument:\\u003cbr/\\u003e- calc_main_inst()\\u003cbr/\\u003e- calc_signal()\\\"]\\n    \\n    Retry[\\\"Retry failed tasks\\u003cbr/\\u003ein 10 minutes\\\"]\\n    \\n    Trigger --\\u003e Tasks\\n    Tasks --\\u003e Gather\\n    Gather --\\u003e Success\\n    Success --\\u003e|Yes| Calculate\\n    Success --\\u003e|No| Retry\\n    Retry --\\u003e Tasks\\n```\\n\\n**Signal Generation Process** [trader/strategy/brother2.py:705-723]():\\n\\n1. Generate main contract continuous series (`calc_main_inst()`)\\n2. For each instrument in strategy:\\n   - Calculate technical indicators\\n   - Generate trading signal if conditions met\\n   - Calculate required margin\\n3. Risk check: Alert if total margin \\u003e 80% of equity\\n\\n**Sources:** [trader/strategy/brother2.py:684-723]()\\n\\n## Price Limit Calculation\\n\\nThe system calculates exchange-imposed price limits to ensure orders are accepted.\\n\\n### Up Limit and Down Limit Methods\\n\\n**Up Limit Calculation** [trader/strategy/brother2.py:858-863]():\\n```\\nprice = settlement * (1 + limit_ratio)\\nreturn round(price, price_tick) - price_tick\\n```\\n\\n**Down Limit Calculation** [trader/strategy/brother2.py:865-870]():\\n```\\nprice = settlement * (1 - limit_ratio)\\nreturn round(price, price_tick) + price_tick\\n```\\n\\nThe `limit_ratio` is retrieved from Redis keys: `LIMITRATIO:{exchange}:{product_code}:{contract_code}`\\n\\n**Purpose**: \\n- Prevents order rejection due to price beyond exchange limits\\n- Adjusts limit by one tick inside the actual limit for better execution probability\\n\\n**Sources:** [trader/strategy/brother2.py:858-870]()\\n\\n## Query System\\n\\n### Generic Query Method\\n\\nThe `query()` method provides a generic interface for CTP API queries with async/await pattern.\\n\\n**Query Flow** [trader/strategy/brother2.py:236-257]():\\n\\n```mermaid\\nsequenceDiagram\\n    participant TS as TradeStrategy\\n    participant SubClient as PubSub Client\\n    participant Redis as Redis Pub/Sub\\n    participant CTP as CTP API\\n    \\n    TS-\\u003e\\u003eSubClient: Create pubsub instance\\n    TS-\\u003e\\u003eSubClient: psubscribe(response_channels)\\n    \\n    par Subscribe and Query\\n        SubClient-\\u003e\\u003eRedis: Subscribe OnRspQry{Type}, OnRspError\\n        TS-\\u003e\\u003eRedis: Publish ReqQry{Type}\\n    end\\n    \\n    Redis-\\u003e\\u003eCTP: Forward query request\\n    \\n    loop Multiple Response Messages\\n        CTP--\\u003e\\u003eRedis: Response data (bIsLast=False)\\n        Redis--\\u003e\\u003eSubClient: Forward message\\n        SubClient-\\u003e\\u003eSubClient: Accumulate results\\n    end\\n    \\n    CTP--\\u003e\\u003eRedis: Final response (bIsLast=True)\\n    Redis--\\u003e\\u003eSubClient: Forward message\\n    SubClient--\\u003e\\u003eTS: Return complete result list\\n    \\n    TS-\\u003e\\u003eSubClient: punsubscribe()\\n    TS-\\u003e\\u003eSubClient: close()\\n```\\n\\n**Supported Query Types** [trader/strategy/brother2.py:87-203]():\\n\\n| Query Type | Purpose | Used By |\\n|-----------|---------|---------|\\n| `TradingAccount` | Account balance and equity | `refresh_account()` |\\n| `InvestorPositionDetail` | Position holdings | `refresh_position()` |\\n| `Instrument` | Contract specifications | `refresh_instrument()` |\\n| `InstrumentMarginRate` | Margin requirements | `refresh_instrument()` |\\n| `InstrumentCommissionRate` | Commission fees | `refresh_instrument()` |\\n| `Order` | Order status | `start()` |\\n\\n**Timeout Handling** [trader/strategy/brother2.py:35](), [trader/strategy/brother2.py:248]():\\n- Default timeout: 10 seconds (configurable via `config.ini`)\\n- Raises `asyncio.TimeoutError` if CTP doesn't respond\\n\\n**Sources:** [trader/strategy/brother2.py:236-257](), [trader/strategy/brother2.py:220-234]()\\n\\n### Market Data Subscription\\n\\n**Subscribe/Unsubscribe Methods** [trader/strategy/brother2.py:259-299]():\\n\\nThese methods manage real-time market data subscriptions:\\n\\n- `SubscribeMarketData(inst_ids: list)`: Subscribe to tick data for instruments\\n- `UnSubscribeMarketData(inst_ids: list)`: Unsubscribe from tick data\\n\\nBoth follow the same async pattern as `query()` but use market data response channels.\\n\\n**Sources:** [trader/strategy/brother2.py:259-299]()\\n\\n## Integration Points\\n\\n### Redis Channel Configuration\\n\\n**Channel Formats** [trader/strategy/brother2.py:41-43]():\\n\\n| Variable | Config Key | Example Format |\\n|----------|------------|----------------|\\n| `__market_response_format` | `MSG_CHANNEL.market_response_format` | `MSG:CTP:RSP:MARKET:{event}:{id}` |\\n| `__trade_response_format` | `MSG_CHANNEL.trade_response_format` | `MSG:CTP:RSP:TRADE:{event}:{id}` |\\n| `__request_format` | `MSG_CHANNEL.request_format` | `MSG:CTP:REQ:{command}` |\\n\\n**Key Channels Used**:\\n- Request: `MSG:CTP:REQ:ReqOrderInsert`, `MSG:CTP:REQ:ReqOrderAction`, `MSG:CTP:REQ:ReqQry*`\\n- Trade Response: `MSG:CTP:RSP:TRADE:OnRtnTrade:*`, `MSG:CTP:RSP:TRADE:OnRtnOrder:*`\\n- Market Response: `MSG:CTP:RSP:MARKET:OnRtnDepthMarketData:*`\\n\\n**Sources:** [trader/strategy/brother2.py:41-43]()\\n\\n### Database Model Integration\\n\\n```mermaid\\nerDiagram\\n    TradeStrategy ||--|| Strategy : \\\"loads\\\"\\n    Strategy ||--|| Broker : \\\"belongs to\\\"\\n    Strategy ||--o{ Param : \\\"has parameters\\\"\\n    Strategy }o--o{ Instrument : \\\"trades\\\"\\n    \\n    TradeStrategy ||--o{ Signal : \\\"generates\\\"\\n    TradeStrategy ||--o{ Order : \\\"creates\\\"\\n    TradeStrategy ||--o{ Trade : \\\"manages\\\"\\n    \\n    Broker ||--o{ Performance : \\\"tracks\\\"\\n    \\n    Signal ||--o| Order : \\\"triggers\\\"\\n    Order ||--o| Trade : \\\"opens/closes\\\"\\n    Instrument ||--o{ Trade : \\\"traded in\\\"\\n    \\n    Trade ||--|| Instrument : \\\"references\\\"\\n    Signal ||--|| Instrument : \\\"targets\\\"\\n    \\n    DailyBar ||--|| Instrument : \\\"price data for\\\"\\n    MainBar ||--|| Instrument : \\\"continuous series for\\\"\\n```\\n\\n**Key Model Operations**:\\n\\n| Model | Create | Update | Query | Delete |\\n|-------|--------|--------|-------|--------|\\n| `Broker` | No | Yes (account data) | Yes (initialization) | No |\\n| `Strategy` | No | No | Yes (initialization) | No |\\n| `Instrument` | Yes | Yes (specs, main contract) | Yes (signal calc) | No |\\n| `Signal` | Yes | Yes (processed flag) | Yes (scheduled tasks) | No |\\n| `Order` | Yes | Yes (status) | Yes (startup check) | Yes (canceled) |\\n| `Trade` | Yes | Yes (fills, P\\u0026L) | Yes (position tracking) | Yes (closed positions) |\\n| `Performance` | Yes | Yes (daily NAV) | Yes (equity calc) | No |\\n| `DailyBar` | No | No | Yes (price data) | No |\\n| `MainBar` | Yes | No | Yes (signal calc) | No |\\n\\n**Sources:** [trader/strategy/brother2.py:32](), [panel/models.py:1-289]()\\n\\n## Error Handling and Logging\\n\\n### CTP Error Handling\\n\\n**Error Dictionary** [trader/strategy/brother2.py:29]():\\n- Loaded from `error.xml` via `ctp_errors` dictionary\\n- Maps CTP error codes to human-readable messages\\n- Used in order cancellation and query error responses\\n\\n### Logging Strategy\\n\\n**Logger Configuration** [trader/strategy/brother2.py:34]():\\n- Logger name: `'CTPApi'`\\n- Log levels used: `debug`, `info`, `warning`\\n\\n**Key Logged Events**:\\n- Account updates with formatted numbers\\n- Position changes\\n- Signal generation with volume and margin estimates\\n- Order insertions and cancellations\\n- Trade confirmations\\n- Errors with stack traces\\n\\n**Log Format Examples** [trader/strategy/brother2.py:109-110]():\\n```\\n,: 1,234,567 : 2,345,678 : 2,456,789\\n```\\n\\n**Sources:** [trader/strategy/brother2.py:34](), [trader/strategy/brother2.py:109-110]()\\n\\n## Startup Sequence\\n\\nThe `start()` method initializes the trading system when launched.\\n\\n**Startup Flow** [trader/strategy/brother2.py:64-84]():\\n\\n```mermaid\\nflowchart TD\\n    Start[\\\"start() method called\\\"]\\n    Install[\\\"await self.install()\\u003cbr/\\u003e(BaseModule setup)\\\"]\\n    Heartbeat[\\\"Set HEARTBEAT:TRADER\\u003cbr/\\u003ein Redis (60s TTL)\\\"]\\n    \\n    CheckTime{\\\"Check current time\\u003cbr/\\u003eWeekday and\\u003cbr/\\u003e(08:20-15:50 or\\u003cbr/\\u003e20:10-23:59)?\\\"}\\n    \\n    RefreshAccount[\\\"await refresh_account()\\u003cbr/\\u003eQuery account data\\\"]\\n    QueryOrders[\\\"await query('Order')\\u003cbr/\\u003eGet all orders\\\"]\\n    \\n    ProcessOrders[\\\"For each order:\\u003cbr/\\u003e- Cancel if unfilled\\u003cbr/\\u003e- Save if filled\\\"]\\n    \\n    RefreshPosition[\\\"await refresh_position()\\u003cbr/\\u003eSync positions\\\"]\\n    \\n    Ready[\\\"System Ready\\\"]\\n    \\n    Start --\\u003e Install\\n    Install --\\u003e Heartbeat\\n    Heartbeat --\\u003e CheckTime\\n    \\n    CheckTime --\\u003e|Trading Hours| RefreshAccount\\n    CheckTime --\\u003e|Non-Trading| Ready\\n    \\n    RefreshAccount --\\u003e QueryOrders\\n    QueryOrders --\\u003e ProcessOrders\\n    ProcessOrders --\\u003e RefreshPosition\\n    RefreshPosition --\\u003e Ready\\n```\\n\\n**Startup Order Handling** [trader/strategy/brother2.py:71-80]():\\n- Queries all orders from CTP\\n- Unfilled orders (status 1-4, submitted): Automatically canceled\\n- Filled orders: Saved to database\\n- Purpose: Clean slate at startup, prevent stale orders\\n\\n**Sources:** [trader/strategy/brother2.py:64-84]()\\n\\n## Helper Methods\\n\\n### Position Lookup Methods\\n\\n**`getShares(instrument: str)`** [trader/strategy/brother2.py:207-214]():\\n- Returns: `(shares, avg_price, open_date)`\\n- Warning: Only handles single-direction positions (long OR short, not both)\\n- Used for: Position queries in trading logic\\n\\n**`getPositions(inst_id: int)`** [trader/strategy/brother2.py:216-218]():\\n- Returns: First position dictionary\\n- Warning: Only handles single-direction positions\\n- Used for: Direct position data access\\n\\n**Sources:** [trader/strategy/brother2.py:207-218]()\\n\\n### Static Helper Methods\\n\\n**`get_trade_string(trade: dict)`** [trader/strategy/brother2.py:382-389]():\\n- Formats trade execution details for logging\\n- Returns: Human-readable trade description\\n- Example: `SHFE.cu2401 5 :75200 :09:15:30 : 00001230004567`\\n\\n**`get_order_string(order: dict)`** [trader/strategy/brother2.py:497-508]():\\n- Formats order status details for logging\\n- Returns: Comprehensive order information\\n- Example: `:00001230004567,SHFE.cu2401 5 :75200 :09:15:28 : :`\\n\\n**`save_order(order: dict)`** [trader/strategy/brother2.py:471-495]():\\n- Creates/updates Order model from CTP order dict\\n- Extracts signal ID from OrderRef\\n- Deletes canceled orders\\n- Returns: `(order_obj, created)`\\n\\n**Sources:** [trader/strategy/brother2.py:382-508]()\\n\\n## Configuration and Constants\\n\\n### Strategy Parameters\\n\\nThe strategy uses parameters stored in the `Param` model, loaded via `Strategy.param_set`.\\n\\n**Required Parameters** [trader/strategy/brother2.py:727-732]():\\n\\n| Parameter Code | Type | Purpose | Typical Value |\\n|---------------|------|---------|---------------|\\n| `BreakPeriod` | int | Breakout detection window | 20-60 days |\\n| `AtrPeriod` | int | ATR calculation period | 14-30 days |\\n| `LongPeriod` | int | Long-term trend SMA period | 200-350 days |\\n| `ShortPeriod` | int | Short-term trend SMA period | 50-150 days |\\n| `StopLoss` | int | Stop loss ATR multiplier | 2-4 |\\n| `Risk` | float | Risk per trade (% of capital) | 0.01-0.03 (1-3%) |\\n\\n**Sources:** [trader/strategy/brother2.py:727-732](), [panel/models.py:128-144]()\\n\\n### Ignored Instruments\\n\\n**Configuration** [trader/strategy/brother2.py:44]():\\n- Default: `\\\"WH,bb,JR,RI,RS,LR,PM,im\\\"`\\n- Purpose: Skip instruments with low liquidity or high margin requirements\\n- Can be overridden in `config.ini` under `TRADE.ignore_inst`\\n\\n**Sources:** [trader/strategy/brother2.py:44]()\\n\\n## Summary\\n\\nThe `TradeStrategy` class serves as the central trading engine with these core capabilities:\\n\\n1. **State Management**: Tracks account equity, positions, and configuration\\n2. **Data Synchronization**: Queries CTP for account, positions, and instruments\\n3. **Signal Generation**: Uses ATR-based breakout strategy with trend filters\\n4. **Order Execution**: Publishes orders to CTP via Redis with automatic rejection handling\\n5. **Position Tracking**: Maintains Trade records with P\\u0026L calculation\\n6. **Scheduled Operations**: Cron-based tasks for signal processing, data collection, and performance updates\\n7. **Event Handling**: Processes trade confirmations and order status updates asynchronously\\n8. **Risk Management**: Position sizing based on ATR, stop-loss protection, margin monitoring\\n\\n**Key Design Patterns**:\\n- Async/await for non-blocking I/O operations\\n- Redis Pub/Sub for CTP API decoupling\\n- Decorator-based callback registration (via `BaseModule`)\\n- Django ORM for persistence and queries\\n- Cron expressions for task scheduling\\n\\n**Sources:** [trader/strategy/brother2.py:1-871]()\"])</script><script>self.__next_f.push([1,\"22:T5c6a,\"])</script><script>self.__next_f.push([1,\"# BaseModule Framework\\n\\n\\u003cdetails\\u003e\\n\\u003csummary\\u003eRelevant source files\\u003c/summary\\u003e\\n\\nThe following files were used as context for generating this wiki page:\\n\\n- [.gitignore](.gitignore)\\n- [trader/strategy/__init__.py](trader/strategy/__init__.py)\\n- [trader/strategy/brother2.py](trader/strategy/brother2.py)\\n- [trader/utils/func_container.py](trader/utils/func_container.py)\\n\\n\\u003c/details\\u003e\\n\\n\\n\\n## Purpose and Scope\\n\\nThe BaseModule framework provides the foundational infrastructure for building event-driven trading strategies with Redis Pub/Sub integration and cron-based scheduling. It serves as the abstract base class for all trading strategy implementations, handling asynchronous message routing, scheduled task execution, and event loop management.\\n\\nThis page documents the BaseModule class and its supporting infrastructure. For the concrete trading strategy implementation that extends BaseModule, see [TradeStrategy Class](#4.1). For information about the callback decorator system used by BaseModule, see [Callback System](#8.2).\\n\\n---\\n\\n## Architecture Overview\\n\\nBaseModule implements a dual-dispatch system that routes both time-based events (via cron schedules) and message-based events (via Redis Pub/Sub). It extends `CallbackFunctionContainer` to collect callback functions decorated with `@RegisterCallback` and routes them to the appropriate handler based on their registration parameters.\\n\\n```mermaid\\nclassDiagram\\n    class CallbackFunctionContainer {\\n        \\u003c\\u003cabstract\\u003e\\u003e\\n        +callback_fun_args: dict\\n        +_collect_all()\\n    }\\n    \\n    class BaseModule {\\n        \\u003c\\u003cabstract\\u003e\\u003e\\n        +io_loop: asyncio.EventLoop\\n        +redis_client: aioredis.Redis\\n        +raw_redis: redis.StrictRedis\\n        +sub_client: PubSub\\n        +channel_router: dict\\n        +crontab_router: defaultdict\\n        +initialized: bool\\n        +_register_callback()\\n        +install()\\n        +uninstall()\\n        +start()\\n        +stop()\\n        +run()\\n        +_msg_reader()\\n        +_call_next()\\n        +_get_next()\\n    }\\n    \\n    class TradeStrategy {\\n        -__strategy: Strategy\\n        -__broker: Broker\\n        -__market_response_format: str\\n        -__trade_response_format: str\\n        +OnRtnDepthMarketData()\\n        +OnRtnTrade()\\n        +OnRtnOrder()\\n        +processing_signal1()\\n        +processing_signal2()\\n        +processing_signal3()\\n        +refresh_all()\\n        +collect_quote()\\n        +heartbeat()\\n    }\\n    \\n    CallbackFunctionContainer \\u003c|-- BaseModule\\n    BaseModule \\u003c|-- TradeStrategy\\n    \\n    BaseModule --\\u003e \\\"1\\\" asyncio.EventLoop : manages\\n    BaseModule --\\u003e \\\"1\\\" aioredis.Redis : async operations\\n    BaseModule --\\u003e \\\"1\\\" redis.StrictRedis : sync operations\\n    BaseModule --\\u003e \\\"1\\\" PubSub : message subscription\\n```\\n\\n**Sources:** [trader/strategy/__init__.py:36-140](), [trader/utils/func_container.py:35-49](), [trader/strategy/brother2.py:38-39]()\\n\\n---\\n\\n## Core Components\\n\\n### Event Loop Management\\n\\nBaseModule creates and manages a dedicated asyncio event loop for all asynchronous operations. The event loop is initialized in the constructor and runs continuously until explicitly stopped.\\n\\n| Component | Type | Purpose |\\n|-----------|------|---------|\\n| `io_loop` | `asyncio.EventLoop` | Main event loop for async operations |\\n| `datetime` | `datetime` | Reference timestamp for cron calculations |\\n| `time` | `float` | Unix timestamp at initialization |\\n| `loop_time` | `float` | Event loop time at initialization |\\n\\nThe event loop coordinates three primary subsystems:\\n- **Redis message listener**: Asynchronous coroutine that receives Pub/Sub messages\\n- **Cron schedulers**: Periodic callbacks scheduled via `io_loop.call_at()`\\n- **Task queue**: User-created tasks via `io_loop.create_task()`\\n\\n**Sources:** [trader/strategy/__init__.py:39-56]()\\n\\n---\\n\\n### Redis Client Architecture\\n\\nBaseModule maintains two Redis clients for different use cases:\\n\\n```mermaid\\ngraph TB\\n    BaseModule[\\\"BaseModule Instance\\\"]\\n    \\n    subgraph \\\"Redis Clients\\\"\\n        AsyncClient[\\\"redis_client\\u003cbr/\\u003e(aioredis.Redis)\\u003cbr/\\u003eAsync operations\\\"]\\n        SyncClient[\\\"raw_redis\\u003cbr/\\u003e(redis.StrictRedis)\\u003cbr/\\u003eSync operations\\\"]\\n        PubSubClient[\\\"sub_client\\u003cbr/\\u003e(aioredis.PubSub)\\u003cbr/\\u003ePattern subscriptions\\\"]\\n    end\\n    \\n    subgraph \\\"Configuration\\\"\\n        ConfigIni[\\\"config.ini\\u003cbr/\\u003e[REDIS] section\\\"]\\n    end\\n    \\n    subgraph \\\"Operations\\\"\\n        Queries[\\\"query()\\u003cbr/\\u003equery_reader()\\u003cbr/\\u003eAsync request/response\\\"]\\n        Publishing[\\\"ReqOrderInsert()\\u003cbr/\\u003eSync publish\\\"]\\n        Subscription[\\\"_msg_reader()\\u003cbr/\\u003ePattern matching\\\"]\\n    end\\n    \\n    ConfigIni --\\u003e|\\\"host, port, db\\\"| AsyncClient\\n    ConfigIni --\\u003e|\\\"host, port, db\\\"| SyncClient\\n    \\n    BaseModule --\\u003e AsyncClient\\n    BaseModule --\\u003e SyncClient\\n    BaseModule --\\u003e PubSubClient\\n    \\n    AsyncClient --\\u003e Queries\\n    SyncClient --\\u003e Publishing\\n    PubSubClient --\\u003e Subscription\\n```\\n\\n#### Async Redis Client (`redis_client`)\\n\\nCreated from `aioredis.from_url()` with connection parameters from `config.ini`. Used for:\\n- Creating pattern-based Pub/Sub subscriptions\\n- Asynchronous query operations requiring response handling\\n- Non-blocking channel operations\\n\\n#### Sync Redis Client (`raw_redis`)\\n\\nCreated from `redis.StrictRedis()`. Used for:\\n- Publishing messages to request channels\\n- Setting heartbeat keys with expiration\\n- Simple get/set operations where blocking is acceptable\\n\\n#### Pub/Sub Client (`sub_client`)\\n\\nCreated from `redis_client.pubsub()` for pattern-based message subscriptions. Supports wildcard patterns like `MSG:CTP:RSP:TRADE:OnRtnTrade:*`.\\n\\n**Sources:** [trader/strategy/__init__.py:41-48](), [trader/strategy/brother2.py:223](), [trader/strategy/brother2.py:341]()\\n\\n---\\n\\n## Callback Registration System\\n\\nBaseModule uses a decorator-based approach to register callback functions. The `@RegisterCallback` decorator marks methods with metadata that BaseModule collects during initialization.\\n\\n```mermaid\\ngraph LR\\n    subgraph \\\"Decorator Application\\\"\\n        Method[\\\"Method Definition\\u003cbr/\\u003e@RegisterCallback(crontab='0 17 * * *')\\u003cbr/\\u003easync def collect_quote()\\\"]\\n        Decorator[\\\"RegisterCallback\\u003cbr/\\u003eDecorator\\\"]\\n        Metadata[\\\"Function Attributes\\u003cbr/\\u003earg_crontab='0 17 * * *'\\u003cbr/\\u003eis_callback_function=True\\\"]\\n    end\\n    \\n    subgraph \\\"Collection Phase\\\"\\n        Container[\\\"CallbackFunctionContainer\\u003cbr/\\u003e_collect_all()\\\"]\\n        Args[\\\"callback_fun_args\\u003cbr/\\u003e{'collect_quote': {'crontab': '0 17 * * *'}}\\\"]\\n    end\\n    \\n    subgraph \\\"Registration Phase\\\"\\n        BaseModule[\\\"BaseModule\\u003cbr/\\u003e_register_callback()\\\"]\\n        CronRouter[\\\"crontab_router\\u003cbr/\\u003e{'0 17 * * *': {'func': collect_quote, 'iter': croniter, 'handle': None}}\\\"]\\n        ChannelRouter[\\\"channel_router\\u003cbr/\\u003e{'MSG:CTP:*': OnRtnTrade}\\\"]\\n    end\\n    \\n    Method --\\u003e Decorator\\n    Decorator --\\u003e Metadata\\n    Metadata --\\u003e Container\\n    Container --\\u003e Args\\n    Args --\\u003e BaseModule\\n    BaseModule --\\u003e CronRouter\\n    BaseModule --\\u003e ChannelRouter\\n```\\n\\n### Registration Parameters\\n\\nCallbacks can register with one of two parameters:\\n\\n| Parameter | Type | Purpose | Example |\\n|-----------|------|---------|---------|\\n| `channel` | `str` | Redis pattern subscription | `'MSG:CTP:RSP:TRADE:OnRtnOrder:*'` |\\n| `crontab` | `str` | Cron schedule expression | `'20 15 * * *'` (daily at 15:20) |\\n\\n### Decorator Implementation\\n\\nThe `@RegisterCallback` decorator is defined in [trader/utils/func_container.py:21-32]():\\n\\n```python\\ndef RegisterCallback(**out_kwargs):\\n    def _callback_handler(func):\\n        @wraps(func)\\n        def wrapper(self, *args, **kwargs):\\n            return func(self, *args, *kwargs)\\n        \\n        for key, value in out_kwargs.items():\\n            setattr(wrapper, f'arg_{key}', value)\\n        setattr(wrapper, 'is_callback_function', True)\\n        return wrapper\\n    \\n    return _callback_handler\\n```\\n\\n### Collection Process\\n\\n`CallbackFunctionContainer._collect_all()` [trader/utils/func_container.py:40-48]() iterates through all class methods, identifies those marked with `is_callback_function`, and extracts their parameters into `callback_fun_args` dictionary.\\n\\n**Sources:** [trader/utils/func_container.py:21-49](), [trader/strategy/__init__.py:58-69]()\\n\\n---\\n\\n## Cron Scheduling System\\n\\nBaseModule implements a precise cron scheduling system using the `croniter` library. Each cron callback maintains its own iterator and scheduled handle.\\n\\n### Cron Router Structure\\n\\n```mermaid\\ngraph TB\\n    subgraph \\\"Cron Router Data Structure\\\"\\n        Router[\\\"crontab_router\\u003cbr/\\u003e(defaultdict)\\\"]\\n        Entry1[\\\"Key: '*/1 * * * *'\\\"]\\n        Entry2[\\\"Key: '20 15 * * *'\\\"]\\n        Entry3[\\\"Key: '55 8 * * *'\\\"]\\n        \\n        Dict1[\\\"{'func': heartbeat,\\u003cbr/\\u003e'iter': croniter('*/1 * * * *'),\\u003cbr/\\u003e'handle': TimerHandle}\\\"]\\n        Dict2[\\\"{'func': refresh_all,\\u003cbr/\\u003e'iter': croniter('20 15 * * *'),\\u003cbr/\\u003e'handle': TimerHandle}\\\"]\\n        Dict3[\\\"{'func': processing_signal1,\\u003cbr/\\u003e'iter': croniter('55 8 * * *'),\\u003cbr/\\u003e'handle': TimerHandle}\\\"]\\n        \\n        Router --\\u003e Entry1\\n        Router --\\u003e Entry2\\n        Router --\\u003e Entry3\\n        Entry1 --\\u003e Dict1\\n        Entry2 --\\u003e Dict2\\n        Entry3 --\\u003e Dict3\\n    end\\n```\\n\\n### Scheduling Algorithm\\n\\nThe scheduling process follows this flow:\\n\\n1. **Initialization** [trader/strategy/__init__.py:59-67](): For each cron callback, create a `croniter` instance initialized with the current `datetime`\\n2. **Schedule Next** [trader/strategy/__init__.py:71-72](): Calculate next execution time using `croniter.get_next()` and convert to loop time\\n3. **Schedule Callback** [trader/strategy/__init__.py:77-78](): Use `io_loop.call_at()` to schedule `_call_next()` at the calculated time\\n4. **Execute and Reschedule** [trader/strategy/__init__.py:74-78](): When triggered, `_call_next()` creates a task for the callback and schedules the next iteration\\n\\n```mermaid\\nsequenceDiagram\\n    participant Init as _register_callback\\n    participant Router as crontab_router\\n    participant Loop as io_loop\\n    participant CallNext as _call_next\\n    participant Callback as callback function\\n    \\n    Init-\\u003e\\u003eRouter: Create croniter for '20 15 * * *'\\n    Init-\\u003e\\u003eRouter: Store func, iter, handle=None\\n    Init-\\u003e\\u003eInit: Calculate next_time via _get_next()\\n    Init-\\u003e\\u003eLoop: call_at(next_time, _call_next, key)\\n    Loop--\\u003e\\u003eRouter: Store TimerHandle\\n    \\n    Note over Loop: Wait until scheduled time\\n    \\n    Loop-\\u003e\\u003eCallNext: Execute _call_next(key)\\n    CallNext-\\u003e\\u003eCallNext: Cancel old handle\\n    CallNext-\\u003e\\u003eCallNext: Calculate new next_time\\n    CallNext-\\u003e\\u003eLoop: call_at(new_next_time, _call_next, key)\\n    CallNext-\\u003e\\u003eLoop: create_task(callback())\\n    Loop-\\u003e\\u003eCallback: Execute async callback\\n    \\n    Note over Loop: Repeat cycle\\n```\\n\\n### Time Synchronization\\n\\nBaseModule synchronizes multiple time sources during initialization [trader/strategy/__init__.py:59-61]():\\n\\n- `self.datetime`: Django timezone-aware datetime for cron calculations\\n- `self.time`: Unix timestamp from `time.time()`\\n- `self.loop_time`: Event loop time from `io_loop.time()`\\n\\nThis allows converting cron-based next execution times (in Unix time) to event loop times for accurate scheduling.\\n\\n**Sources:** [trader/strategy/__init__.py:58-78](), [trader/strategy/brother2.py:568-683]()\\n\\n---\\n\\n## Message Routing System\\n\\nBaseModule routes Redis Pub/Sub messages to handler functions based on pattern matching. The routing system supports wildcard patterns for flexible message filtering.\\n\\n### Channel Router Architecture\\n\\n```mermaid\\ngraph TB\\n    subgraph \\\"Message Flow\\\"\\n        Redis[(\\\"Redis\\u003cbr/\\u003ePub/Sub\\\")]\\n        SubClient[\\\"sub_client.listen()\\u003cbr/\\u003ePattern subscriptions\\\"]\\n        MsgReader[\\\"_msg_reader()\\u003cbr/\\u003eAsync message loop\\\"]\\n        \\n        Redis --\\u003e|\\\"pmessage events\\\"| SubClient\\n        SubClient --\\u003e|\\\"async for msg\\\"| MsgReader\\n    end\\n    \\n    subgraph \\\"Routing\\\"\\n        ChannelRouter[\\\"channel_router\\u003cbr/\\u003e{'pattern': handler_func}\\\"]\\n        \\n        Pattern1[\\\"'MSG:CTP:RSP:TRADE:OnRtnOrder:*'\\\"]\\n        Pattern2[\\\"'MSG:CTP:RSP:TRADE:OnRtnTrade:*'\\\"]\\n        Pattern3[\\\"'MSG:CTP:RSP:MARKET:OnRtnDepthMarketData:*'\\\"]\\n        \\n        Handler1[\\\"OnRtnOrder(channel, data)\\\"]\\n        Handler2[\\\"OnRtnTrade(channel, data)\\\"]\\n        Handler3[\\\"OnRtnDepthMarketData(channel, data)\\\"]\\n        \\n        MsgReader --\\u003e|\\\"lookup pattern\\\"| ChannelRouter\\n        ChannelRouter --\\u003e Pattern1\\n        ChannelRouter --\\u003e Pattern2\\n        ChannelRouter --\\u003e Pattern3\\n        Pattern1 --\\u003e Handler1\\n        Pattern2 --\\u003e Handler2\\n        Pattern3 --\\u003e Handler3\\n    end\\n    \\n    subgraph \\\"Execution\\\"\\n        IoLoop[\\\"io_loop.create_task()\\\"]\\n        Handler1 --\\u003e IoLoop\\n        Handler2 --\\u003e IoLoop\\n        Handler3 --\\u003e IoLoop\\n    end\\n```\\n\\n### Message Structure\\n\\nRedis Pub/Sub messages received by `_msg_reader()` have the following structure:\\n\\n```python\\n{\\n    'type': 'pmessage',\\n    'pattern': 'MSG:CTP:RSP:TRADE:OnRtnOrder:*',\\n    'channel': 'MSG:CTP:RSP:TRADE:OnRtnOrder:1234567',\\n    'data': '{\\\"OrderRef\\\": \\\"1234567\\\", \\\"InstrumentID\\\": \\\"rb2401\\\", ...}'\\n}\\n```\\n\\n### Handler Invocation\\n\\nWhen a message matches a pattern [trader/strategy/__init__.py:110-121]():\\n\\n1. Parse JSON data from `msg['data']`\\n2. Look up handler function in `channel_router` using `msg['pattern']`\\n3. Create async task: `io_loop.create_task(handler(channel, data))`\\n4. Handler receives both the specific channel name and parsed data\\n\\nThis design allows handlers to differentiate between multiple instances of the same message type (e.g., different order references) using the channel parameter.\\n\\n**Sources:** [trader/strategy/__init__.py:68-69](), [trader/strategy/__init__.py:110-121](), [trader/strategy/brother2.py:373-380](), [trader/strategy/brother2.py:391-469]()\\n\\n---\\n\\n## Lifecycle Management\\n\\nBaseModule defines a standard lifecycle for strategy initialization, execution, and shutdown.\\n\\n### Lifecycle State Diagram\\n\\n```mermaid\\nstateDiagram-v2\\n    [*] --\\u003e Constructed: __init__()\\n    Constructed --\\u003e Installing: start() / install()\\n    Installing --\\u003e Registering: _register_callback()\\n    Registering --\\u003e Subscribing: sub_client.psubscribe()\\n    Subscribing --\\u003e Scheduling: Setup cron handles\\n    Scheduling --\\u003e Running: initialized = True\\n    Running --\\u003e Running: Message handling\\n    Running --\\u003e Running: Cron execution\\n    Running --\\u003e Uninstalling: stop() / uninstall()\\n    Uninstalling --\\u003e Unsubscribing: sub_client.punsubscribe()\\n    Unsubscribing --\\u003e Canceling: Cancel all cron handles\\n    Canceling --\\u003e Shutdown: initialized = False\\n    Shutdown --\\u003e [*]\\n```\\n\\n### Key Lifecycle Methods\\n\\n#### `__init__()` [trader/strategy/__init__.py:37-56]()\\n\\nInitializes core infrastructure:\\n- Creates new asyncio event loop\\n- Initializes async and sync Redis clients\\n- Creates Pub/Sub client\\n- Initializes router dictionaries\\n- Calls `CallbackFunctionContainer.__init__()` to collect callbacks\\n\\n#### `install()` [trader/strategy/__init__.py:80-93]()\\n\\nActivates the module:\\n1. Calls `_register_callback()` to populate routers\\n2. Pattern-subscribes to all channels in `channel_router`\\n3. Launches `_msg_reader()` coroutine for message handling\\n4. Schedules all cron callbacks via `io_loop.call_at()`\\n5. Sets `initialized = True`\\n\\n#### `start()` [trader/strategy/__init__.py:123-124]()\\n\\nDefault implementation calls `install()`. Subclasses override to add initialization logic (e.g., `TradeStrategy.start()` [trader/strategy/brother2.py:64-84]() queries initial account state).\\n\\n#### `run()` [trader/strategy/__init__.py:129-139]()\\n\\nEntry point for running the strategy:\\n1. Creates task for `start()`\\n2. Runs event loop forever with `io_loop.run_forever()`\\n3. Handles `KeyboardInterrupt` to trigger graceful shutdown\\n4. Calls `stop()` on exception or interruption\\n\\n#### `stop()` / `uninstall()` [trader/strategy/__init__.py:95-108](), [trader/strategy/__init__.py:126-127]()\\n\\nCleanup sequence:\\n1. Unsubscribe from all Redis channels\\n2. Close Pub/Sub client\\n3. Cancel all cron timer handles\\n4. Set `initialized = False`\\n\\n**Sources:** [trader/strategy/__init__.py:37-139](), [trader/strategy/brother2.py:64-84]()\\n\\n---\\n\\n## Integration with TradeStrategy\\n\\nTradeStrategy demonstrates practical usage of BaseModule's features through extensive callback registration.\\n\\n### Callback Type Distribution\\n\\nTradeStrategy registers callbacks for both message handling and scheduled tasks:\\n\\n| Callback Type | Count | Examples |\\n|---------------|-------|----------|\\n| Redis Channel Callbacks | 3 | `OnRtnDepthMarketData`, `OnRtnTrade`, `OnRtnOrder` |\\n| Cron Scheduled Tasks | 10 | `heartbeat`, `refresh_all`, `processing_signal1`, `collect_quote` |\\n\\n### Example: Market Data Handler\\n\\n```python\\n@RegisterCallback(channel='MSG:CTP:RSP:MARKET:OnRtnDepthMarketData:*')\\nasync def OnRtnDepthMarketData(self, channel, tick: dict):\\n    inst = channel.split(':')[-1]  # Extract instrument from channel\\n    tick['UpdateTime'] = datetime.datetime.strptime(tick['UpdateTime'], \\\"%Y%m%d %H:%M:%S:%f\\\")\\n    logger.debug('inst=%s, tick: %s', inst, tick)\\n```\\n\\nThis handler receives tick data for any instrument matching the pattern, extracting the specific instrument code from the channel name.\\n\\n### Example: Scheduled Task\\n\\n```python\\n@RegisterCallback(crontab='20 15 * * *')\\nasync def refresh_all(self):\\n    day = timezone.localtime()\\n    _, trading = await is_trading_day(day)\\n    if not trading:\\n        return\\n    await self.refresh_account()\\n    await self.refresh_position()\\n    await self.refresh_instrument()\\n```\\n\\nThis task runs daily at 15:20 (after market close) to refresh account, position, and instrument data from CTP.\\n\\n### Example: Signal Processing\\n\\n```python\\n@RegisterCallback(crontab='55 8 * * *')\\nasync def processing_signal1(self):\\n    await asyncio.sleep(5)\\n    day = timezone.localtime()\\n    _, trading = await is_trading_day(day)\\n    if trading:\\n        for sig in Signal.objects.filter(...):\\n            self.io_loop.call_soon(self.ReqOrderInsert, sig)\\n```\\n\\nProcesses day session signals at 08:55 (before market open), using `io_loop.call_soon()` to schedule order insertions.\\n\\n**Sources:** [trader/strategy/brother2.py:373-380](), [trader/strategy/brother2.py:391-469](), [trader/strategy/brother2.py:510-566](), [trader/strategy/brother2.py:568-683]()\\n\\n---\\n\\n## Synchronous vs Asynchronous Operations\\n\\nBaseModule supports both patterns through its dual Redis client architecture:\\n\\n### Async Pattern: Query/Response\\n\\n```mermaid\\nsequenceDiagram\\n    participant TS as TradeStrategy\\n    participant RC as redis_client\\u003cbr/\\u003e(async)\\n    participant Sub as sub_client\\u003cbr/\\u003e(PubSub)\\n    participant Redis as Redis Server\\n    participant CTP as CTP Gateway\\n    \\n    TS-\\u003e\\u003eSub: psubscribe('MSG:CTP:RSP:OnRspQryAccount:123')\\n    TS-\\u003e\\u003eSub: create_task(query_reader())\\n    TS-\\u003e\\u003eRC: publish('MSG:CTP:REQ:ReqQryAccount', data)\\n    RC-\\u003e\\u003eRedis: PUBLISH\\n    Redis-\\u003e\\u003eCTP: Forward request\\n    CTP-\\u003e\\u003eRedis: Response with RequestID=123\\n    Redis-\\u003e\\u003eSub: pmessage event\\n    Sub-\\u003e\\u003eTS: query_reader() returns data\\n    TS-\\u003e\\u003eTS: Process account data\\n    TS-\\u003e\\u003eSub: punsubscribe()\\n```\\n\\n**Used For:** Operations requiring response data (queries, order actions)\\n\\n**Example:** [trader/strategy/brother2.py:236-257]()\\n\\n### Sync Pattern: Fire-and-Forget\\n\\n```mermaid\\nsequenceDiagram\\n    participant TS as TradeStrategy\\n    participant RR as raw_redis\\u003cbr/\\u003e(sync)\\n    participant Redis as Redis Server\\n    participant CTP as CTP Gateway\\n    \\n    TS-\\u003e\\u003eRR: publish('MSG:CTP:REQ:ReqOrderInsert', order_data)\\n    RR-\\u003e\\u003eRedis: PUBLISH (blocking)\\n    Redis-\\u003e\\u003eCTP: Forward order\\n    Note over TS: Does not wait for response\\n    Note over TS: Response arrives via OnRtnOrder callback\\n```\\n\\n**Used For:** Fire-and-forget operations (order insertion, heartbeat updates)\\n\\n**Example:** [trader/strategy/brother2.py:301-343]()\\n\\n**Sources:** [trader/strategy/__init__.py:41-48](), [trader/strategy/brother2.py:220-257](), [trader/strategy/brother2.py:301-343]()\\n\\n---\\n\\n## Error Handling and Logging\\n\\nBaseModule implements comprehensive error handling at all lifecycle stages:\\n\\n### Installation Errors\\n\\n```python\\nasync def install(self):\\n    try:\\n        # ... installation logic ...\\n        self.initialized = True\\n        logger.debug('%s plugin installed', type(self).__name__)\\n    except Exception as e:\\n        logger.error('%s plugin install failed: %s', type(self).__name__, repr(e), exc_info=True)\\n```\\n\\n### Runtime Errors\\n\\nEach callback method should implement its own exception handling. BaseModule logs unhandled exceptions in `_msg_reader()` and `_call_next()` but continues processing other messages/tasks.\\n\\n### Graceful Shutdown\\n\\nThe `run()` method catches `KeyboardInterrupt` and general exceptions, ensuring `stop()` is called for cleanup:\\n\\n```python\\ndef run(self):\\n    try:\\n        self.io_loop.create_task(self.start())\\n        self.io_loop.run_forever()\\n    except KeyboardInterrupt:\\n        self.io_loop.run_until_complete(self.stop())\\n    except Exception as ee:\\n        logger.error(': %s', repr(ee), exc_info=True)\\n        self.io_loop.run_until_complete(self.stop())\\n    finally:\\n        logger.debug('')\\n```\\n\\n**Sources:** [trader/strategy/__init__.py:80-108](), [trader/strategy/__init__.py:129-139]()\\n\\n---\\n\\n## Configuration Dependencies\\n\\nBaseModule reads Redis connection parameters from `config.ini`:\\n\\n| Parameter | Section | Key | Default | Purpose |\\n|-----------|---------|-----|---------|---------|\\n| Redis Host | `[REDIS]` | `host` | `localhost` | Redis server hostname |\\n| Redis Port | `[REDIS]` | `port` | `6379` | Redis server port |\\n| Redis DB | `[REDIS]` | `db` | `0` | Redis database number |\\n\\nConfiguration is loaded via the `read_config` module. See [Configuration Reference](#7) for complete configuration options.\\n\\n**Sources:** [trader/strategy/__init__.py:41-47](), [trader/utils/read_config.py]()\\n\\n---\\n\\n## Key Design Patterns\\n\\n### Template Method Pattern\\n\\nBaseModule defines the framework structure (`install`, `uninstall`, `run`) while subclasses implement specific behavior by:\\n- Overriding `start()` for custom initialization\\n- Adding decorated callback methods for event handling\\n\\n### Observer Pattern\\n\\nThe message routing system implements the observer pattern:\\n- Redis channels are observable subjects\\n- Callback methods are observers\\n- `_msg_reader()` is the notification mechanism\\n\\n### Decorator Pattern\\n\\n`@RegisterCallback` decorates methods to add metadata without modifying their implementation, enabling automatic registration during collection phase.\\n\\n**Sources:** [trader/strategy/__init__.py:36-140](), [trader/utils/func_container.py:21-49]()\\n\\n---\\n\\n## Thread Safety Considerations\\n\\nBaseModule is **not thread-safe** by design. All operations must execute within the single event loop created by the instance:\\n\\n- **Redis operations**: Use `aioredis` for async operations within coroutines, `raw_redis` only for simple synchronous operations\\n- **Task scheduling**: Use `io_loop.call_soon()` or `io_loop.create_task()` to schedule work from within callbacks\\n- **External threads**: Use `asyncio.run_coroutine_threadsafe()` if calling from outside the event loop (as seen in [trader/strategy/__init__.py:84]())\\n\\n**Sources:** [trader/strategy/__init__.py:39-40](), [trader/strategy/__init__.py:84]()\\n\\n---\\n\\n## Performance Characteristics\\n\\n### Message Processing\\n\\n- **Pattern matching overhead**: Minimal - uses Redis's native pattern subscription\\n- **JSON parsing**: Uses `ujson` for fast parsing [trader/strategy/__init__.py:17]()\\n- **Concurrent handlers**: Each message creates a new task, allowing parallel processing of multiple messages\\n\\n### Cron Scheduling Precision\\n\\n- **Resolution**: 1 minute (standard cron)\\n- **Accuracy**: Depends on `croniter` precision and event loop latency\\n- **Overhead**: O(1) scheduling via `call_at()`, O(n) space where n = number of cron callbacks\\n\\n**Sources:** [trader/strategy/__init__.py:17](), [trader/strategy/__init__.py:25](), [trader/strategy/__init__.py:77-78]()\"])</script><script>self.__next_f.push([1,\"23:T476e,\"])</script><script>self.__next_f.push([1,\"# Signal Generation\\n\\n\\u003cdetails\\u003e\\n\\u003csummary\\u003eRelevant source files\\u003c/summary\\u003e\\n\\nThe following files were used as context for generating this wiki page:\\n\\n- [panel/models.py](panel/models.py)\\n- [trader/strategy/brother2.py](trader/strategy/brother2.py)\\n- [trader/utils/__init__.py](trader/utils/__init__.py)\\n\\n\\u003c/details\\u003e\\n\\n\\n\\nThis document explains how trading signals are calculated and generated in the trader system. Signal generation is the core decision-making process that determines when to enter or exit positions based on technical analysis of market data.\\n\\nFor information about how signals are executed and converted into orders, see [Order Execution Flow](#4.4). For details on risk management that influences position sizing, see [Risk Management](#4.5). For the underlying data models, see [Data Models](#5.1).\\n\\n## Overview\\n\\nSignal generation occurs in two contexts:\\n\\n1. **Live Trading**: Signals are generated daily at 17:00 after market close based on the latest market data ([trader/strategy/brother2.py:684-703]())\\n2. **Historical Backtesting**: Signals are calculated retroactively for strategy development and validation ([trader/utils/__init__.py:500-601]())\\n\\nBoth contexts use identical technical analysis logic to ensure consistency between backtesting and live trading.\\n\\n## Signal Types\\n\\nThe system generates six distinct signal types defined in the `SignalType` enumeration:\\n\\n| Signal Type | Purpose | Position Change |\\n|-------------|---------|-----------------|\\n| `BUY` | Open long position | None  Long |\\n| `SELL_SHORT` | Open short position | None  Short |\\n| `SELL` | Close long position | Long  None |\\n| `BUY_COVER` | Close short position | Short  None |\\n| `ROLL_OPEN` | Open new contract during rollover | Old contract  New contract |\\n| `ROLL_CLOSE` | Close old contract during rollover | Closes old, pairs with ROLL_OPEN |\\n\\n**Sources**: [panel/const.py](), [panel/models.py:173-192]()\\n\\n## Technical Analysis Framework\\n\\n### Strategy Parameters\\n\\nSignal generation is controlled by five key parameters stored in the `Param` model:\\n\\n```python\\n# Accessed via strategy.param_set.get(code='ParameterName')\\nbreak_n    # BreakPeriod: Lookback period for breakout detection\\natr_n      # AtrPeriod: Period for Average True Range calculation\\nlong_n     # LongPeriod: Period for long-term SMA\\nshort_n    # ShortPeriod: Period for short-term SMA\\nstop_n     # StopLoss: ATR multiplier for stop-loss distance\\nrisk       # Risk: Risk percentage per trade for position sizing\\n```\\n\\n**Sources**: [trader/strategy/brother2.py:727-732](), [panel/models.py:128-144]()\\n\\n### Technical Indicators\\n\\nThe signal generation algorithm computes three primary technical indicators:\\n\\n```mermaid\\ngraph TB\\n    MainBar[\\\"MainBar Data\\u003cbr/\\u003e(OHLC + Settlement)\\\"]\\n    \\n    ATR[\\\"ATR Indicator\\u003cbr/\\u003eAverage True Range\\u003cbr/\\u003etimeperiod=atr_n\\\"]\\n    ShortSMA[\\\"Short SMA\\u003cbr/\\u003eManual calculation\\u003cbr/\\u003eperiod=short_n\\\"]\\n    LongSMA[\\\"Long SMA\\u003cbr/\\u003eManual calculation\\u003cbr/\\u003eperiod=long_n\\\"]\\n    \\n    HighLine[\\\"Breakout High\\u003cbr/\\u003eRolling max(close)\\u003cbr/\\u003ewindow=break_n\\\"]\\n    LowLine[\\\"Breakout Low\\u003cbr/\\u003eRolling min(close)\\u003cbr/\\u003ewindow=break_n\\\"]\\n    \\n    MainBar --\\u003e ATR\\n    MainBar --\\u003e ShortSMA\\n    MainBar --\\u003e LongSMA\\n    MainBar --\\u003e HighLine\\n    MainBar --\\u003e LowLine\\n    \\n    ATR --\\u003e StopLoss[\\\"Stop Loss Calculation\\\"]\\n    ATR --\\u003e PositionSizing[\\\"Position Sizing\\\"]\\n    \\n    ShortSMA --\\u003e TrendFilter[\\\"Trend Filter\\u003cbr/\\u003eshort vs long\\\"]\\n    LongSMA --\\u003e TrendFilter\\n    \\n    HighLine --\\u003e BreakoutBuy[\\\"Breakout Detection\\u003cbr/\\u003eBuy Signal\\\"]\\n    LowLine --\\u003e BreakoutSell[\\\"Breakout Detection\\u003cbr/\\u003eSell Signal\\\"]\\n    \\n    TrendFilter --\\u003e BreakoutBuy\\n    TrendFilter --\\u003e BreakoutSell\\n```\\n\\n**Sources**: [trader/strategy/brother2.py:734-744]()\\n\\n#### ATR Calculation\\n\\nAverage True Range (ATR) is calculated using TA-Lib and serves two purposes:\\n1. **Stop-loss placement**: Trailing stops are placed at `ATR * stop_n` from the highest/lowest point\\n2. **Position sizing**: Trade size is inversely proportional to ATR (volatility)\\n\\n```python\\ndf[\\\"atr\\\"] = ATR(df.high, df.low, df.close, timeperiod=atr_n)\\n```\\n\\n**Sources**: [trader/strategy/brother2.py:737](), [trader/utils/__init__.py:511]()\\n\\n#### Simple Moving Average (SMA)\\n\\nTwo SMAs are calculated manually using an iterative approach (not TA-Lib) for trend filtering:\\n\\n```python\\n# Manual SMA calculation\\nfor idx in range(1, df.shape[0]):\\n    df.short_trend[idx] = (df.short_trend[idx - 1] * (short_n - 1) + df.close[idx]) / short_n\\n    df.long_trend[idx] = (df.long_trend[idx - 1] * (long_n - 1) + df.close[idx]) / long_n\\n```\\n\\n**Trend determination**:\\n- **Uptrend**: `short_trend \\u003e long_trend` (only BUY signals allowed)\\n- **Downtrend**: `short_trend \\u003c long_trend` (only SELL_SHORT signals allowed)\\n\\n**Sources**: [trader/strategy/brother2.py:740-742](), [trader/utils/__init__.py:516-517]()\\n\\n#### Breakout Levels\\n\\nRolling maximum and minimum over `break_n` periods define breakout thresholds:\\n\\n```python\\ndf[\\\"high_line\\\"] = df.close.rolling(window=break_n).max()\\ndf[\\\"low_line\\\"] = df.close.rolling(window=break_n).min()\\n```\\n\\n**Sources**: [trader/strategy/brother2.py:743-744]()\\n\\n## Signal Generation Algorithm\\n\\n### Core Logic Flow\\n\\n```mermaid\\nflowchart TD\\n    Start[\\\"calc_signal()\\u003cbr/\\u003eCalled at 17:00 daily\\\"]\\n    \\n    LoadData[\\\"Load MainBar data\\u003cbr/\\u003eFilter: time \\u003c= day, exchange, product_code\\u003cbr/\\u003eOrder by time, limit 400 records\\\"]\\n    \\n    CalcIndicators[\\\"Calculate Technical Indicators\\u003cbr/\\u003e- ATR\\u003cbr/\\u003e- Short SMA / Long SMA\\u003cbr/\\u003e- High Line / Low Line\\\"]\\n    \\n    CheckPosition{\\\"Existing Position?\\u003cbr/\\u003eQuery Trade table\\u003cbr/\\u003eclose_time is NULL\\\"}\\n    \\n    Start --\\u003e LoadData\\n    LoadData --\\u003e CalcIndicators\\n    CalcIndicators --\\u003e CheckPosition\\n    \\n    CheckPosition --\\u003e|Yes| PositionLogic[\\\"Position Management Logic\\\"]\\n    CheckPosition --\\u003e|No| EntryLogic[\\\"Entry Signal Logic\\\"]\\n    \\n    PositionLogic --\\u003e CheckDirection{\\\"Position\\u003cbr/\\u003eDirection?\\\"}\\n    \\n    CheckDirection --\\u003e|Long| LongChecks[\\\"Long Position Checks\\u003cbr/\\u003e1. Stop-loss: close \\u003c= HH - ATR*stop_n\\u003cbr/\\u003e2. Rollover: code != main_code\\\"]\\n    CheckDirection --\\u003e|Short| ShortChecks[\\\"Short Position Checks\\u003cbr/\\u003e1. Stop-loss: close \\u003e= LL + ATR*stop_n\\u003cbr/\\u003e2. Rollover: code != main_code\\\"]\\n    \\n    LongChecks --\\u003e|Stop Hit| GenSELL[\\\"Generate SELL signal\\u003cbr/\\u003ePriority: High\\u003cbr/\\u003ePrice: calc_down_limit\\\"]\\n    LongChecks --\\u003e|Rollover| GenROLL_LONG[\\\"Generate ROLL_OPEN + ROLL_CLOSE\\u003cbr/\\u003ePriority: Normal\\\"]\\n    \\n    ShortChecks --\\u003e|Stop Hit| GenBUY_COVER[\\\"Generate BUY_COVER signal\\u003cbr/\\u003ePriority: High\\u003cbr/\\u003ePrice: calc_up_limit\\\"]\\n    ShortChecks --\\u003e|Rollover| GenROLL_SHORT[\\\"Generate ROLL_OPEN + ROLL_CLOSE\\u003cbr/\\u003ePriority: Normal\\\"]\\n    \\n    EntryLogic --\\u003e TrendCheck{\\\"Trend Direction?\\u003cbr/\\u003eshort_trend vs long_trend\\\"}\\n    \\n    TrendCheck --\\u003e|Uptrend| BuyCheck{\\\"Breakout Up?\\u003cbr/\\u003eclose \\u003e= high_line[-1]\\\"}\\n    TrendCheck --\\u003e|Downtrend| SellCheck{\\\"Breakout Down?\\u003cbr/\\u003eclose \\u003c= low_line[-1]\\\"}\\n    \\n    BuyCheck --\\u003e|Yes| CalcBuySize[\\\"Calculate Position Size\\u003cbr/\\u003evolume = (capital + profit) * risk / (ATR * multiple)\\\"]\\n    SellCheck --\\u003e|Yes| CalcSellSize[\\\"Calculate Position Size\\u003cbr/\\u003evolume = (capital + profit) * risk / (ATR * multiple)\\\"]\\n    \\n    CalcBuySize --\\u003e CheckMargin{\\\"Volume \\u003e 0\\u003cbr/\\u003eand\\u003cbr/\\u003eMargin OK?\\\"}\\n    CalcSellSize --\\u003e CheckMargin\\n    \\n    CheckMargin --\\u003e|Yes, Buy| GenBUY[\\\"Generate BUY signal\\u003cbr/\\u003ePriority: Low\\u003cbr/\\u003ePrice: calc_up_limit\\\"]\\n    CheckMargin --\\u003e|Yes, Sell| GenSELL_SHORT[\\\"Generate SELL_SHORT signal\\u003cbr/\\u003ePriority: Low\\u003cbr/\\u003ePrice: calc_down_limit\\\"]\\n    \\n    GenBUY --\\u003e SaveSignal[\\\"Signal.objects.update_or_create()\\u003cbr/\\u003eSave to database\\\"]\\n    GenSELL --\\u003e SaveSignal\\n    GenBUY_COVER --\\u003e SaveSignal\\n    GenSELL_SHORT --\\u003e SaveSignal\\n    GenROLL_LONG --\\u003e SaveSignal\\n    GenROLL_SHORT --\\u003e SaveSignal\\n    \\n    SaveSignal --\\u003e End[\\\"Return signal, margin\\\"]\\n```\\n\\n**Sources**: [trader/strategy/brother2.py:725-856]()\\n\\n### Entry Signal Generation (No Position)\\n\\nWhen no position exists, the system evaluates potential entry signals:\\n\\n```python\\nbuy_sig = (df.short_trend[idx] \\u003e df.long_trend[idx] and \\n           price_round(df.close[idx], inst.price_tick) \\u003e= \\n           price_round(df.high_line[idx - 1], inst.price_tick))\\n\\nsell_sig = (df.short_trend[idx] \\u003c df.long_trend[idx] and \\n            price_round(df.close[idx], inst.price_tick) \\u003c= \\n            price_round(df.low_line[idx - 1], inst.price_tick))\\n```\\n\\n**Buy Signal Conditions**:\\n1. Uptrend: `short_trend \\u003e long_trend`\\n2. Breakout: Current close  Previous period high line\\n\\n**Sell Short Signal Conditions**:\\n1. Downtrend: `short_trend \\u003c long_trend`\\n2. Breakout: Current close  Previous period low line\\n\\n**Sources**: [trader/strategy/brother2.py:746-747]()\\n\\n### Position Sizing\\n\\nPosition size is calculated using a fixed fractional risk model:\\n\\n```python\\nstart_cash = Performance.objects.last().unit_count\\nprofit = Trade.objects.filter(\\n    strategy=strategy, instrument__section=inst.section\\n).aggregate(sum=Sum('profit'))['sum']\\nrisk_each = Decimal(df.atr[idx]) * Decimal(inst.volume_multiple)\\nvolume_ori = (start_cash + profit) * risk / risk_each\\nvolume = round(volume_ori)\\n```\\n\\n**Formula**: \\n```\\nVolume = (Initial Capital + Section P\\u0026L)  Risk% / (ATR  Contract Multiplier)\\n```\\n\\nThis ensures that each trade risks the same percentage of capital adjusted for instrument volatility.\\n\\n**Sources**: [trader/strategy/brother2.py:828-835]()\\n\\n### Exit Signal Generation (With Position)\\n\\nWhen a position exists, the system monitors for exit conditions:\\n\\n#### Stop-Loss for Long Positions\\n\\n```python\\n# Find highest high since position opened\\nfirst_pos = pos  # Trace back through rollovers\\npos_idx = df.index.get_loc(first_pos.open_time.astimezone().date().isoformat())\\n\\n# Stop condition\\nif df.close[idx] \\u003c= df.high[pos_idx:idx].max() - df.atr[pos_idx - 1] * stop_n:\\n    signal = SignalType.SELL\\n    priority = PriorityType.High\\n```\\n\\n**Logic**: Exit when current close falls below (Highest High - ATR  stop_n) since entry.\\n\\n**Sources**: [trader/strategy/brother2.py:764-782]()\\n\\n#### Stop-Loss for Short Positions\\n\\n```python\\n# Find lowest low since position opened\\npos_idx = df.index.get_loc(first_pos.open_time.astimezone().date().isoformat())\\n\\n# Stop condition\\nif df.close[idx] \\u003e= df.low[pos_idx:idx].min() + df.atr[pos_idx - 1] * stop_n:\\n    signal = SignalType.BUY_COVER\\n    priority = PriorityType.High\\n```\\n\\n**Logic**: Exit when current close rises above (Lowest Low + ATR  stop_n) since entry.\\n\\n**Sources**: [trader/strategy/brother2.py:796-814]()\\n\\n#### Contract Rollover\\n\\nWhen the main contract changes (e.g., from `cu2201` to `cu2202`), the system generates paired rollover signals:\\n\\n```python\\nroll_over = pos.code != inst.main_code and pos.code \\u003c inst.main_code\\n\\nif roll_over:\\n    # Close old contract\\n    Signal.objects.update_or_create(\\n        code=pos.code, type=SignalType.ROLL_CLOSE, ...)\\n    # Open new contract\\n    signal = SignalType.ROLL_OPEN\\n    priority = PriorityType.Normal\\n```\\n\\n**Sources**: [trader/strategy/brother2.py:750-751, 784-793, 816-825]()\\n\\n## Price Limit Calculations\\n\\nOrder prices are set near exchange-imposed price limits to ensure execution priority:\\n\\n### Upper Limit (for Buy Orders)\\n\\n```python\\ndef calc_up_limit(inst: Instrument, bar: DailyBar):\\n    settlement = bar.settlement\\n    limit_ratio = str_to_number(redis.get(f\\\"LIMITRATIO:{inst.exchange}:{inst.product_code}:{bar.code}\\\"))\\n    price_tick = inst.price_tick\\n    price = price_round(settlement * (1 + limit_ratio), price_tick)\\n    return price - price_tick  # One tick below limit\\n```\\n\\n### Lower Limit (for Sell Orders)\\n\\n```python\\ndef calc_down_limit(inst: Instrument, bar: DailyBar):\\n    settlement = bar.settlement\\n    limit_ratio = str_to_number(redis.get(f\\\"LIMITRATIO:{inst.exchange}:{inst.product_code}:{bar.code}\\\"))\\n    price_tick = inst.price_tick\\n    price = price_round(settlement * (1 - limit_ratio), price_tick)\\n    return price + price_tick  # One tick above limit\\n```\\n\\nLimit ratios are fetched daily from exchange websites and cached in Redis (see `get_contracts_argument` function).\\n\\n**Sources**: [trader/strategy/brother2.py:858-870](), [trader/utils/__init__.py:685-796]()\\n\\n## Signal Storage\\n\\nGenerated signals are persisted in the `Signal` model with the following key fields:\\n\\n```python\\nsig, _ = Signal.objects.update_or_create(\\n    code=signal_code if signal_code else inst.main_code,\\n    strategy=self.__strategy,\\n    instrument=inst,\\n    type=signal,\\n    trigger_time=day,\\n    defaults={\\n        'price': price,\\n        'volume': volume,\\n        'priority': priority,\\n        'processed': False\\n    }\\n)\\n```\\n\\n**Key Fields**:\\n- `code`: Specific contract to trade (e.g., `cu2201`)\\n- `instrument`: Product instrument (e.g., `cu`)\\n- `type`: Signal type enumeration\\n- `trigger_time`: When the signal was generated\\n- `price`: Limit price for order execution\\n- `volume`: Number of contracts\\n- `priority`: Execution priority (High for stops, Low for entries)\\n- `processed`: Boolean flag indicating if signal has been executed\\n\\n**Sources**: [trader/strategy/brother2.py:847-849](), [panel/models.py:173-192]()\\n\\n## Integration with Trading System\\n\\n### Daily Signal Generation Schedule\\n\\n```mermaid\\nsequenceDiagram\\n    participant Cron as \\\"@RegisterCallback\\u003cbr/\\u003ecrontab='0 17 * * *'\\\"\\n    participant TS as \\\"TradeStrategy\\\"\\n    participant Exchange as \\\"Exchange APIs\\u003cbr/\\u003eupdate_from_*\\\"\\n    participant CalcMain as \\\"calc_main_inst()\\\"\\n    participant CalcSig as \\\"calc_signal()\\\"\\n    participant DB as \\\"MySQL Database\\\"\\n    \\n    Note over Cron,DB: Daily 17:00 Execution\\n    \\n    Cron-\\u003e\\u003eTS: collect_quote()\\n    TS-\\u003e\\u003eExchange: Fetch daily market data\\n    Exchange--\\u003e\\u003eTS: DailyBar data\\n    TS-\\u003e\\u003eDB: Save DailyBar records\\n    \\n    TS-\\u003e\\u003eCalcMain: For each Instrument\\n    CalcMain-\\u003e\\u003eDB: Query DailyBar\\n    CalcMain-\\u003e\\u003eCalcMain: Determine main contract\\n    CalcMain-\\u003e\\u003eDB: Store MainBar (continuous)\\n    CalcMain--\\u003e\\u003eTS: main_code, updated\\n    \\n    TS-\\u003e\\u003eCalcSig: For each Instrument in strategy\\n    CalcSig-\\u003e\\u003eDB: Load 400 MainBar records\\n    CalcSig-\\u003e\\u003eCalcSig: Calculate ATR, SMA, Breakout\\n    CalcSig-\\u003e\\u003eDB: Query existing Trade position\\n    \\n    alt No Position\\n        CalcSig-\\u003e\\u003eCalcSig: Check entry conditions\\n        CalcSig-\\u003e\\u003eCalcSig: Calculate position size\\n    else Has Position\\n        CalcSig-\\u003e\\u003eCalcSig: Check stop-loss\\n        CalcSig-\\u003e\\u003eCalcSig: Check rollover need\\n    end\\n    \\n    CalcSig-\\u003e\\u003eDB: Signal.objects.update_or_create()\\n    CalcSig--\\u003e\\u003eTS: signal, margin\\n    \\n    TS-\\u003e\\u003eTS: Calculate total margin requirement\\n    \\n    alt Margin \\u003e 80% of equity\\n        TS-\\u003e\\u003eTS: Log risk warning\\n    end\\n```\\n\\n**Sources**: [trader/strategy/brother2.py:684-723]()\\n\\n### Signal Processing Flow\\n\\nOnce signals are generated and stored, they are processed during trading sessions:\\n\\n1. **08:55** - Day session signals (non-CFFEX, non-night instruments) ([trader/strategy/brother2.py:572-586]())\\n2. **09:25** - Stock index and treasury futures (CFFEX) ([trader/strategy/brother2.py:598-609]())\\n3. **20:55** - Night session signals ([trader/strategy/brother2.py:621-632]())\\n\\nSee [Scheduled Tasks](#4.6) for detailed execution timing.\\n\\n**Sources**: [trader/strategy/brother2.py:572-643]()\\n\\n## Historical Signal Calculation\\n\\nThe `calc_history_signal` function implements identical logic for backtesting:\\n\\n```python\\ndef calc_history_signal(inst: Instrument, day: datetime.datetime, strategy: Strategy):\\n    # Load parameters\\n    break_n = strategy.param_set.get(code='BreakPeriod').int_value\\n    atr_n = strategy.param_set.get(code='AtrPeriod').int_value\\n    # ... etc\\n    \\n    # Load all historical data up to day\\n    df = to_df(MainBar.objects.filter(\\n        time__lte=day.date(),\\n        exchange=inst.exchange,\\n        product_code=inst.product_code\\n    ).order_by('time').values_list(...))\\n    \\n    # Calculate indicators\\n    df['atr'] = ATR(df.high, df.low, df.close, timeperiod=atr_n)\\n    # Manual SMA calculation\\n    # Breakout lines\\n    \\n    # Simulate trading day by day\\n    for cur_idx in range(break_n+1, df.shape[0]):\\n        # Check entry/exit conditions\\n        # Create Signal and Trade records\\n```\\n\\nThis function:\\n- Uses the same parameter set and indicator calculations as live trading\\n- Processes historical data chronologically\\n- Creates both `Signal` and `Trade` records to simulate full trade lifecycle\\n- Useful for strategy optimization and performance validation\\n\\n**Sources**: [trader/utils/__init__.py:500-601]()\\n\\n## Force Open Mechanism\\n\\nThe system supports manual signal generation via the `force_opens` many-to-many field:\\n\\n```python\\nelif self.__strategy.force_opens.filter(id=inst.id).exists() and not buy_sig and not sell_sig:\\n    logger.info(f': {inst}')\\n    if df.short_trend[idx] \\u003e df.long_trend[idx]:\\n        buy_sig = True\\n    else:\\n        sell_sig = True\\n    self.__strategy.force_opens.remove(inst)\\n```\\n\\nThis allows operators to manually trigger position entry based on discretionary analysis, respecting the current trend direction.\\n\\n**Sources**: [trader/strategy/brother2.py:752-758](), [panel/models.py:108]()\\n\\n## Configuration\\n\\nSignal generation behavior is controlled through strategy parameters accessible via Django admin interface:\\n\\n| Parameter | Type | Description | Typical Value |\\n|-----------|------|-------------|---------------|\\n| `BreakPeriod` | int | Breakout lookback period | 20-60 days |\\n| `AtrPeriod` | int | ATR calculation period | 14-30 days |\\n| `LongPeriod` | int | Long-term SMA period | 50-200 days |\\n| `ShortPeriod` | int | Short-term SMA period | 10-50 days |\\n| `StopLoss` | int | ATR multiplier for stops | 2-4 |\\n| `Risk` | float | Risk per trade (%) | 0.01-0.03 (1-3%) |\\n\\nThese parameters can be adjusted per strategy without code changes.\\n\\n**Sources**: [trader/strategy/brother2.py:727-732](), [panel/models.py:128-144]()\\n\\n## Error Handling and Logging\\n\\nSignal generation includes comprehensive logging and error handling:\\n\\n```python\\ntry:\\n    # Signal generation logic\\n    logger.info(f\\\": {sig}({volume_ori:.1f}) \\\"\\n                f\\\": {use_margin:.0f}({use_margin / 10000:.1f})\\\")\\n    return signal, use_margin\\nexcept Exception as e:\\n    logger.warning(f'calc_signal : {repr(e)}', exc_info=True)\\n    return None, 0\\n```\\n\\nAll signal generation events are logged with:\\n- Signal details (instrument, type, volume)\\n- Position sizing calculations\\n- Margin requirements\\n- Risk warnings when aggregate margin exceeds 80% of equity\\n\\n**Sources**: [trader/strategy/brother2.py:719-723, 844-856]()\"])</script><script>self.__next_f.push([1,\"24:T5300,\"])</script><script>self.__next_f.push([1,\"# Order Execution Flow\\n\\n\\u003cdetails\\u003e\\n\\u003csummary\\u003eRelevant source files\\u003c/summary\\u003e\\n\\nThe following files were used as context for generating this wiki page:\\n\\n- [panel/const.py](panel/const.py)\\n- [panel/models.py](panel/models.py)\\n- [trader/strategy/brother2.py](trader/strategy/brother2.py)\\n\\n\\u003c/details\\u003e\\n\\n\\n\\n## Purpose and Scope\\n\\nThis document describes the complete order execution lifecycle in the trader system, from signal generation through order submission to trade recording. It covers how the `TradeStrategy` class converts trading signals into CTP API orders, tracks order status updates via Redis Pub/Sub, and records executed trades in the database.\\n\\nFor information about how trading signals are generated, see [Signal Generation](#4.3). For details on the scheduled tasks that trigger signal processing, see [Scheduled Tasks](#4.6). For CTP API integration details, see [CTP API Integration](#6).\\n\\n## Order Lifecycle Overview\\n\\nThe order execution flow follows these stages:\\n\\n| Stage | Component | Database Model | Status |\\n|-------|-----------|----------------|--------|\\n| 1. Signal Creation | `calc_signal()` | `Signal` | `processed=False` |\\n| 2. Signal Processing | `processing_signal1/2/3()` | `Signal` | Queried from DB |\\n| 3. Order Conversion | `ReqOrderInsert()` | - | OrderRef generated |\\n| 4. Order Submission | Redis Pub/Sub | - | Published to CTP |\\n| 5. Order Confirmation | `OnRtnOrder()` | `Order` | Created/Updated |\\n| 6. Trade Execution | `OnRtnTrade()` | `Trade` | Position updated |\\n| 7. Signal Completion | `OnRtnTrade()` | `Signal` | `processed=True` |\\n\\nThe system uses an asynchronous, event-driven architecture where order submission and execution callbacks are decoupled via Redis message channels.\\n\\n**Sources:** [trader/strategy/brother2.py:301-343](), [trader/strategy/brother2.py:391-469](), [trader/strategy/brother2.py:510-566]()\\n\\n## Order Lifecycle State Diagram\\n\\n```mermaid\\nstateDiagram-v2\\n    [*] --\\u003e SignalCreated: calc_signal() generates signal\\n    SignalCreated --\\u003e SignalQueued: Signal.processed=False\\n    SignalQueued --\\u003e OrderConverting: processing_signal1/2/3() queries signal\\n    OrderConverting --\\u003e OrderSubmitted: ReqOrderInsert() publishes to Redis\\n    OrderSubmitted --\\u003e OrderAccepted: OnRtnOrder(OrderSubmitStatus=Accepted)\\n    OrderAccepted --\\u003e PartiallyFilled: OnRtnTrade(partial fill)\\n    OrderAccepted --\\u003e FullyFilled: OnRtnTrade(complete fill)\\n    PartiallyFilled --\\u003e FullyFilled: OnRtnTrade(remaining fill)\\n    PartiallyFilled --\\u003e Canceled: OnRtnOrder(Canceled)\\n    OrderAccepted --\\u003e Canceled: OnRtnOrder(Canceled)\\n    OrderSubmitted --\\u003e Rejected: OnRtnOrder(InsertRejected)\\n    Rejected --\\u003e ResubmitAdjusted: Price adjustment logic\\n    ResubmitAdjusted --\\u003e OrderSubmitted: Retry with new price\\n    Rejected --\\u003e [*]: Give up after adjustment\\n    FullyFilled --\\u003e SignalProcessed: Signal.processed=True\\n    Canceled --\\u003e [*]\\n    SignalProcessed --\\u003e [*]\\n```\\n\\n**Sources:** [trader/strategy/brother2.py:510-566](), [trader/strategy/brother2.py:391-469](), [panel/const.py:90-110]()\\n\\n## Signal to Order Conversion\\n\\n### ReqOrderInsert Method\\n\\nThe `ReqOrderInsert()` method in `TradeStrategy` converts a `Signal` object into a CTP order request. This is where trading logic (buy/sell/rollover) is translated into CTP API parameters.\\n\\n**Key Steps:**\\n\\n1. **Generate OrderRef**: Creates a unique 12-digit order reference combining an auto-incrementing ID and the signal ID\\n   - Format: `{autoid:07}{signal_id:05}`\\n   - Example: `0000123000456` (autoid=123, signal_id=456)\\n\\n2. **Set Order Parameters**: Maps signal type to CTP direction and offset flags\\n\\n| Signal Type | CTP Direction | CTP Offset Flag | Description |\\n|-------------|--------------|-----------------|-------------|\\n| `BUY` | `D_Buy` | `OF_Open` | Open long position |\\n| `SELL_SHORT` | `D_Sell` | `OF_Open` | Open short position |\\n| `SELL` | `D_Sell` | `OF_Close` | Close long position |\\n| `BUY_COVER` | `D_Buy` | `OF_Close` | Close short position |\\n| `ROLL_CLOSE` | (from position) | `OF_Close` or `OF_CloseToday` | Close old contract |\\n| `ROLL_OPEN` | (from position) | `OF_Open` | Open new contract |\\n\\n3. **Handle SHFE Today/Yesterday Distinction**: For Shanghai Futures Exchange, positions opened today must use `OF_CloseToday` flag when closed\\n\\n4. **Publish to Redis**: Sends order request to `MSG:CTP:REQ:ReqOrderInsert` channel\\n\\n**Sources:** [trader/strategy/brother2.py:301-343](), [trader/utils/read_config.py](), [panel/const.py:165-172]()\\n\\n### Order Parameter Example\\n\\n```mermaid\\ngraph LR\\n    Signal[\\\"Signal Object\\u003cbr/\\u003einstrument: rb (rebar)\\u003cbr/\\u003ecode: rb2501\\u003cbr/\\u003etype: BUY\\u003cbr/\\u003evolume: 2\\u003cbr/\\u003eprice: 3650\\\"]\\n    \\n    OrderRef[\\\"Generate OrderRef\\u003cbr/\\u003eAutonumber.id: 0000042\\u003cbr/\\u003eSignal.id: 00123\\u003cbr/\\u003eResult: '0000042000123'\\\"]\\n    \\n    Params[\\\"CTP Order Params\\u003cbr/\\u003eOrderRef: '0000042000123'\\u003cbr/\\u003eInstrumentID: 'rb2501'\\u003cbr/\\u003eDirection: D_Buy\\u003cbr/\\u003eCombOffsetFlag: OF_Open\\u003cbr/\\u003eLimitPrice: 3650.0\\u003cbr/\\u003eVolumeTotalOriginal: 2\\\"]\\n    \\n    Redis[\\\"Redis Channel\\u003cbr/\\u003eMSG:CTP:REQ:ReqOrderInsert\\\"]\\n    \\n    Signal --\\u003e OrderRef\\n    OrderRef --\\u003e Params\\n    Params --\\u003e Redis\\n```\\n\\n**Sources:** [trader/strategy/brother2.py:301-343](), [trader/utils/__init__.py]()\\n\\n## Order Submission Process\\n\\n### Redis Channel Communication\\n\\nOrder submission uses a request-response pattern via Redis Pub/Sub channels. The channel format is configured in `config.ini`:\\n\\n```\\n[MSG_CHANNEL]\\nrequest_format = MSG:CTP:REQ:{command}\\ntrade_response_format = MSG:CTP:RSP:TRADE:{callback}:{OrderRef}\\n```\\n\\n**Submission Flow:**\\n\\n```mermaid\\nsequenceDiagram\\n    participant TS as TradeStrategy\\n    participant Redis as Redis Pub/Sub\\n    participant CTP as CTP Gateway\\n    \\n    Note over TS: ReqOrderInsert(signal)\\n    TS-\\u003e\\u003eTS: Generate OrderRef='0000042000123'\\n    TS-\\u003e\\u003eTS: Build order params dict\\n    TS-\\u003e\\u003eRedis: PUBLISH MSG:CTP:REQ:ReqOrderInsert\\n    Note over Redis,CTP: CTP Gateway subscribes to\\u003cbr/\\u003eMSG:CTP:REQ:*\\n    Redis-\\u003e\\u003eCTP: Forward order request\\n    CTP-\\u003e\\u003eCTP: Call CTP API\\u003cbr/\\u003eOrderInsert()\\n    \\n    Note over CTP: Async callbacks follow...\\n```\\n\\n**Sources:** [trader/strategy/brother2.py:301-343](), [trader/utils/read_config.py]()\\n\\n### Scheduled Signal Processing\\n\\nThe system processes signals at three scheduled times to handle different trading sessions:\\n\\n| Cron Schedule | Method | Purpose | Exchanges |\\n|---------------|--------|---------|-----------|\\n| `55 8 * * *` | `processing_signal1()` | Day session (non-CFFEX) | SHFE, DCE, CZCE, GFEX |\\n| `25 9 * * *` | `processing_signal2()` | Day session (CFFEX) | CFFEX (stock index, bonds) |\\n| `55 20 * * *` | `processing_signal3()` | Night session | All with night trading |\\n\\nEach method:\\n1. Checks if today is a trading day\\n2. Queries unprocessed signals: `Signal.objects.filter(processed=False, trigger_time__gte=last_trading_day)`\\n3. Orders by priority (High \\u003e Normal \\u003e Low)\\n4. Calls `ReqOrderInsert()` for each signal\\n\\n**Sources:** [trader/strategy/brother2.py:572-642]()\\n\\n## Order Status Tracking\\n\\n### OnRtnOrder Callback\\n\\nThe `OnRtnOrder()` callback handles order status updates from CTP. It is registered to listen on the pattern `MSG:CTP:RSP:TRADE:OnRtnOrder:*`.\\n\\n**Callback Flow:**\\n\\n```mermaid\\nsequenceDiagram\\n    participant CTP as CTP Gateway\\n    participant Redis as Redis Pub/Sub\\n    participant TS as TradeStrategy\\n    participant DB as Django ORM\\n    \\n    CTP-\\u003e\\u003eRedis: PUBLISH MSG:CTP:RSP:TRADE:OnRtnOrder:0000042000123\\n    Redis-\\u003e\\u003eTS: Pattern match callback\\n    TS-\\u003e\\u003eTS: Extract OrderRef from channel\\n    \\n    alt Order Accepted\\n        TS-\\u003e\\u003eTS: save_order(order_dict)\\n        TS-\\u003e\\u003eDB: Order.objects.update_or_create()\\n        Note over DB: Create/update Order record\\n    else Order Canceled \\u0026 Rejected\\n        TS-\\u003e\\u003eDB: Check DailyBar for last price\\n        TS-\\u003e\\u003eTS: Adjust price by 50%\\n        TS-\\u003e\\u003eTS: ReqOrderInsert(signal, new_price)\\n        Note over TS: Retry with adjusted price\\n    end\\n```\\n\\n**Order Status Values:**\\n\\n| CTP Status | Django Enum | Description | Action |\\n|------------|-------------|-------------|--------|\\n| `OST_AllTraded` | `AllTraded` | Completely filled | Mark signal processed (in OnRtnTrade) |\\n| `OST_PartTradedQueueing` | `PartTradedQueueing` | Partial fill, still active | Wait for more fills |\\n| `OST_NoTradeQueueing` | `NoTradeQueueing` | No fill yet, queued | Wait |\\n| `OST_Canceled` | `Canceled` | Order canceled | May retry with adjusted price |\\n\\n**Sources:** [trader/strategy/brother2.py:510-566](), [trader/strategy/brother2.py:471-495](), [panel/const.py:90-99]()\\n\\n### Rejected Order Retry Logic\\n\\nWhen an order is rejected due to price exceeding exchange limits (`OrderSubmitStatus=InsertRejected`), the system automatically adjusts and retries:\\n\\n1. **Retrieve last settlement price** from `DailyBar`\\n2. **Calculate delta**: 50% of the difference between order price and settlement\\n3. **Adjust price**:\\n   - For long positions: `new_price = settlement + delta`\\n   - For short positions: `new_price = settlement - delta`\\n4. **Validate adjustment**: If delta/settlement \\u003c 1%, give up (price too aggressive)\\n5. **Resubmit**: Call `ReqOrderInsert()` with adjusted price\\n\\n**Sources:** [trader/strategy/brother2.py:523-564]()\\n\\n## Trade Execution and Recording\\n\\n### OnRtnTrade Callback\\n\\nThe `OnRtnTrade()` callback handles trade confirmations from CTP. It is registered on pattern `MSG:CTP:RSP:TRADE:OnRtnTrade:*`.\\n\\n**Trade Processing Logic:**\\n\\n```mermaid\\nflowchart TD\\n    Start[\\\"OnRtnTrade(trade_dict)\\\"]\\n    ExtractRef[\\\"Extract OrderRef from channel\\\"]\\n    IsManual{\\\"OrderRef \\u003c 10000?\\\"}\\n    GetSignal[\\\"Get Signal by ID from OrderRef\\\"]\\n    CheckOffset{\\\"OffsetFlag?\\\"}\\n    \\n    Start --\\u003e ExtractRef\\n    ExtractRef --\\u003e IsManual\\n    IsManual --\\u003e|Yes| ManualTrade[\\\"Manual trade\\u003cbr/\\u003e(no signal)\\\"]\\n    IsManual --\\u003e|No| GetSignal\\n    GetSignal --\\u003e CheckOffset\\n    \\n    CheckOffset --\\u003e|Open| OpenPosition[\\\"Process Opening Trade\\\"]\\n    CheckOffset --\\u003e|Close| ClosePosition[\\\"Process Closing Trade\\\"]\\n    \\n    OpenPosition --\\u003e FindTrade[\\\"Find or create Trade record\\\"]\\n    FindTrade --\\u003e UpdateOpen[\\\"Update filled_shares,\\u003cbr/\\u003eavg_entry_price,\\u003cbr/\\u003ecost, frozen_margin\\\"]\\n    \\n    ClosePosition --\\u003e FindOpenTrade[\\\"Find open Trade record\\\"]\\n    FindOpenTrade --\\u003e UpdateClose[\\\"Update closed_shares,\\u003cbr/\\u003eavg_exit_price,\\u003cbr/\\u003eprofit\\\"]\\n    UpdateClose --\\u003e CheckComplete{\\\"closed_shares\\u003cbr/\\u003e== shares?\\\"}\\n    CheckComplete --\\u003e|Yes| SetCloseTime[\\\"Set close_time,\\u003cbr/\\u003ecalculate profit\\\"]\\n    CheckComplete --\\u003e|No| PartialClose[\\\"Keep Trade open\\\"]\\n    \\n    UpdateOpen --\\u003e IsComplete{\\\"Order fully\\u003cbr/\\u003efilled?\\\"}\\n    SetCloseTime --\\u003e MarkProcessed\\n    IsComplete --\\u003e|Yes| MarkProcessed[\\\"Signal.processed=True\\\"]\\n    IsComplete --\\u003e|No| WaitMore[\\\"Wait for more fills\\\"]\\n    \\n    PartialClose --\\u003e End\\n    MarkProcessed --\\u003e End[\\\"Trade recorded\\\"]\\n    WaitMore --\\u003e End\\n    ManualTrade --\\u003e End\\n```\\n\\n**Sources:** [trader/strategy/brother2.py:391-469]()\\n\\n### Opening Position Trade Record\\n\\nWhen a trade opens a position (`OffsetFlag=Open`):\\n\\n1. **Find or create Trade**: Query for existing `Trade` record with matching parameters\\n2. **Calculate costs**:\\n   - `trade_cost = volume * price * fee_money * volume_multiple + volume * fee_volume`\\n   - `trade_margin = volume * price * margin_rate`\\n3. **Update fields**:\\n   - `filled_shares`: Cumulative filled shares (may be partial)\\n   - `avg_entry_price`: Volume-weighted average entry price\\n   - `cost`: Cumulative commission fees\\n   - `frozen_margin`: Total margin locked\\n\\n4. **Link to Order**: Set `open_order` foreign key to the `Order` record\\n\\n**Sources:** [trader/strategy/brother2.py:412-434](), [panel/models.py:262-288]()\\n\\n### Closing Position Trade Record\\n\\nWhen a trade closes a position (`OffsetFlag=Close` or `CloseToday`):\\n\\n1. **Find open position**: Query for `Trade` with `close_time__isnull=True` and matching direction (opposite of trade direction)\\n2. **Update closed shares**:\\n   - `closed_shares`: Cumulative closed shares\\n   - `avg_exit_price`: Volume-weighted average exit price\\n3. **Calculate profit** (if fully closed):\\n   - Long: `profit = (avg_exit_price - avg_entry_price) * shares * volume_multiple`\\n   - Short: `profit = (avg_entry_price - avg_exit_price) * shares * volume_multiple`\\n4. **Set close_time**: Mark position as closed\\n5. **Link to Order**: Set `close_order` foreign key\\n\\n**Sources:** [trader/strategy/brother2.py:435-460](), [panel/models.py:262-288]()\\n\\n## Data Model Relationships\\n\\n```mermaid\\nerDiagram\\n    Signal ||--o| Order : \\\"may generate\\\"\\n    Order ||--o| Trade : \\\"opens position\\\"\\n    Order ||--o| Trade : \\\"closes position\\\"\\n    Strategy ||--o{ Signal : \\\"generates\\\"\\n    Strategy ||--o{ Order : \\\"submits\\\"\\n    Strategy ||--o{ Trade : \\\"executes\\\"\\n    Instrument ||--o{ Signal : \\\"for instrument\\\"\\n    Instrument ||--o{ Order : \\\"for instrument\\\"\\n    Instrument ||--o{ Trade : \\\"for instrument\\\"\\n    Broker ||--o{ Order : \\\"submitted by\\\"\\n    Broker ||--o{ Trade : \\\"executed by\\\"\\n    \\n    Signal {\\n        int id PK\\n        string code \\\"contract code\\\"\\n        string type \\\"BUY/SELL/ROLL_CLOSE/etc\\\"\\n        decimal price\\n        int volume\\n        datetime trigger_time\\n        int priority \\\"0=LOW, 1=Normal, 2=High\\\"\\n        bool processed \\\"False until trade complete\\\"\\n    }\\n    \\n    Order {\\n        string order_ref PK \\\"12-digit unique ID\\\"\\n        string code \\\"contract code\\\"\\n        decimal price\\n        int volume\\n        string direction \\\"LONG/SHORT\\\"\\n        string offset_flag \\\"Open/Close\\\"\\n        string status \\\"AllTraded/PartTraded/etc\\\"\\n        datetime send_time\\n    }\\n    \\n    Trade {\\n        string code \\\"contract code\\\"\\n        string direction \\\"LONG/SHORT\\\"\\n        datetime open_time\\n        datetime close_time \\\"NULL if open\\\"\\n        int shares \\\"total shares\\\"\\n        int filled_shares \\\"shares filled so far\\\"\\n        int closed_shares \\\"shares closed so far\\\"\\n        decimal avg_entry_price\\n        decimal avg_exit_price\\n        decimal profit \\\"P\\u0026L\\\"\\n        decimal cost \\\"commission fees\\\"\\n    }\\n```\\n\\n**Field Relationships:**\\n\\n- **Signal.id  Order.order_ref**: Signal ID embedded in positions 8-12 of OrderRef (e.g., `0000042` `00123`)\\n- **Order.signal**: OneToOne link set when trade completes in `OnRtnTrade`\\n- **Trade.open_order**: OneToOne link to order that opened position\\n- **Trade.close_order**: OneToOne link to order that closed position\\n- **Signal.processed**: Set to `True` only when corresponding trade is fully filled\\n\\n**Sources:** [panel/models.py:173-288](), [trader/strategy/brother2.py:301-305](), [trader/utils/__init__.py]()\\n\\n## Redis Channel Patterns\\n\\n### Channel Naming Convention\\n\\nThe system uses pattern-based Redis channels to route messages by OrderRef:\\n\\n| Channel Type | Format | Example | Subscriber |\\n|--------------|--------|---------|------------|\\n| Order Request | `MSG:CTP:REQ:{command}` | `MSG:CTP:REQ:ReqOrderInsert` | CTP Gateway |\\n| Order Response | `MSG:CTP:RSP:TRADE:{callback}:{OrderRef}` | `MSG:CTP:RSP:TRADE:OnRtnOrder:0000042000123` | TradeStrategy |\\n| Trade Response | `MSG:CTP:RSP:TRADE:{callback}:{OrderRef}` | `MSG:CTP:RSP:TRADE:OnRtnTrade:0000042000123` | TradeStrategy |\\n| Error Response | `MSG:CTP:RSP:TRADE:OnRspError:{RequestID}` | `MSG:CTP:RSP:TRADE:OnRspError:12345` | TradeStrategy |\\n\\n**Pattern Subscription:**\\n\\nThe `TradeStrategy` class registers callbacks using the `@RegisterCallback` decorator with pattern matching:\\n\\n```python\\n@RegisterCallback(channel='MSG:CTP:RSP:TRADE:OnRtnOrder:*')\\nasync def OnRtnOrder(self, channel: str, order: dict):\\n    # Extract OrderRef from channel\\n    order_ref = channel.split(':')[-1]\\n    ...\\n```\\n\\nThis allows multiple strategy instances to coexist, each receiving only the order confirmations relevant to their own orders.\\n\\n**Sources:** [trader/strategy/brother2.py:510-511](), [trader/strategy/brother2.py:391-392](), [trader/strategy/__init__.py]()\\n\\n### Message Flow Diagram\\n\\n```mermaid\\nsequenceDiagram\\n    participant S as processing_signal1()\\n    participant R as ReqOrderInsert()\\n    participant Redis as Redis Pub/Sub\\n    participant CTP as CTP Gateway\\n    participant OO as OnRtnOrder callback\\n    participant OT as OnRtnTrade callback\\n    participant DB as MySQL\\n    \\n    Note over S: 08:55 cron trigger\\n    S-\\u003e\\u003eDB: Query Signal.filter(processed=False)\\n    DB--\\u003e\\u003eS: [signal1, signal2, ...]\\n    \\n    loop For each signal\\n        S-\\u003e\\u003eR: ReqOrderInsert(signal)\\n        R-\\u003e\\u003eR: Generate OrderRef\\n        R-\\u003e\\u003eRedis: PUBLISH MSG:CTP:REQ:ReqOrderInsert\\n    end\\n    \\n    Redis-\\u003e\\u003eCTP: Forward order\\n    CTP-\\u003e\\u003eRedis: PUBLISH MSG:CTP:RSP:TRADE:OnRtnOrder:{OrderRef}\\n    Redis-\\u003e\\u003eOO: Pattern match callback\\n    OO-\\u003e\\u003eDB: Order.objects.update_or_create()\\n    \\n    Note over CTP: Order matched on exchange\\n    CTP-\\u003e\\u003eRedis: PUBLISH MSG:CTP:RSP:TRADE:OnRtnTrade:{OrderRef}\\n    Redis-\\u003e\\u003eOT: Pattern match callback\\n    OT-\\u003e\\u003eDB: Trade.objects.create/update()\\n    \\n    alt Fully filled\\n        OT-\\u003e\\u003eDB: Signal.processed=True\\n    else Partially filled\\n        Note over OT: Wait for more OnRtnTrade\\n    end\\n```\\n\\n**Sources:** [trader/strategy/brother2.py:572-643](), [trader/strategy/brother2.py:301-343](), [trader/strategy/brother2.py:510-566](), [trader/strategy/brother2.py:391-469]()\\n\\n## Error Handling and Recovery\\n\\n### Order Rejection Scenarios\\n\\n| Error Condition | Detection | Recovery Action |\\n|-----------------|-----------|-----------------|\\n| Price beyond limit | `OrderStatus=Canceled`, `OrderSubmitStatus=InsertRejected` | Adjust price 50% toward settlement, retry |\\n| Insufficient margin | `ErrorID` in OnRspError | Log warning, do not retry |\\n| Invalid instrument | `ErrorID` in OnRspError | Log error, do not retry |\\n| Network timeout | No response within `HANDLER_TIME_OUT` (10s) | Asyncio timeout exception |\\n| Duplicate OrderRef | Should not occur (auto-increment) | Manual intervention required |\\n\\n**Price Adjustment Example:**\\n\\nIf buying at 3700 is rejected with settlement at 3600:\\n1. `delta = (3700 - 3600) * 0.5 = 50`\\n2. `new_price = 3600 + 50 = 3650`\\n3. Check: `50 / 3600 = 1.4%` (acceptable)\\n4. Round to price tick and retry\\n\\nIf the delta is less than 1% of settlement, the system gives up to avoid chasing the market.\\n\\n**Sources:** [trader/strategy/brother2.py:523-564]()\\n\\n### Manual Order Handling\\n\\nOrders with `OrderRef \\u003c 10000` are considered manual orders (not generated by the system):\\n\\n1. **No Signal Association**: These orders are not linked to any `Signal` record\\n2. **Trade Creation**: System still creates/updates `Trade` records for position tracking\\n3. **No Processed Flag**: Since there's no signal, nothing is marked processed\\n\\nThis allows manual intervention while maintaining accurate position tracking.\\n\\n**Sources:** [trader/strategy/brother2.py:400-402](), [trader/strategy/brother2.py:474-475]()\\n\\n### Holiday Recovery\\n\\nAfter a multi-day holiday, the system may have unprocessed night session signals from before the break. The `processing_signal1()` method detects this condition:\\n\\n```python\\nif (self.__trading_day - self.__last_trading_day).days \\u003e 3:\\n    logger.info('.')\\n    self.io_loop.call_soon(asyncio.create_task, self.processing_signal3())\\n```\\n\\nThis ensures signals generated on the last trading day before a holiday are still processed.\\n\\n**Sources:** [trader/strategy/brother2.py:583-585]()\\n\\n## Complete Order Lifecycle Example\\n\\n**Scenario:** Open a 2-hand long position in rb2501 (rebar futures)\\n\\n```mermaid\\nsequenceDiagram\\n    autonumber\\n    participant CS as calc_signal()\\n    participant PS as processing_signal1()\\n    participant RI as ReqOrderInsert()\\n    participant CTP as CTP Exchange\\n    participant OO as OnRtnOrder()\\n    participant OT as OnRtnTrade()\\n    participant DB as MySQL\\n    \\n    Note over CS: 17:00 signal calculation\\n    CS-\\u003e\\u003eDB: Signal.objects.update_or_create()\\u003cbr/\\u003ecode='rb2501', type=BUY\\u003cbr/\\u003evolume=2, price=3650\\u003cbr/\\u003eprocessed=False\\n    \\n    Note over PS: 08:55 next day\\n    PS-\\u003e\\u003eDB: Query Signal.filter(processed=False)\\n    DB--\\u003e\\u003ePS: [rb2501 BUY signal]\\n    PS-\\u003e\\u003eRI: ReqOrderInsert(signal)\\n    \\n    RI-\\u003e\\u003eDB: Autonumber.objects.create()\\n    DB--\\u003e\\u003eRI: id=42\\n    RI-\\u003e\\u003eRI: OrderRef = '0000042000123'\\n    RI-\\u003e\\u003eCTP: Publish order via Redis\\n    \\n    CTP--\\u003e\\u003eOO: OnRtnOrder(NoTradeQueueing)\\n    OO-\\u003e\\u003eDB: Order.objects.update_or_create()\\u003cbr/\\u003eorder_ref='0000042000123'\\u003cbr/\\u003estatus=NoTradeQueueing\\n    \\n    Note over CTP: Partial fill: 1 hand @ 3650\\n    CTP--\\u003e\\u003eOT: OnRtnTrade(Volume=1, Price=3650)\\n    OT-\\u003e\\u003eDB: Trade.objects.create()\\u003cbr/\\u003eshares=2, filled_shares=1\\u003cbr/\\u003eavg_entry_price=3650\\n    \\n    CTP--\\u003e\\u003eOO: OnRtnOrder(PartTradedQueueing)\\n    OO-\\u003e\\u003eDB: Order.status=PartTradedQueueing\\n    \\n    Note over CTP: Complete fill: 1 hand @ 3651\\n    CTP--\\u003e\\u003eOT: OnRtnTrade(Volume=1, Price=3651)\\n    OT-\\u003e\\u003eDB: Trade.filled_shares=2\\u003cbr/\\u003eavg_entry_price=3650.5\\u003cbr/\\u003e(weighted average)\\n    OT-\\u003e\\u003eDB: Signal.processed=True\\n    \\n    CTP--\\u003e\\u003eOO: OnRtnOrder(AllTraded)\\n    OO-\\u003e\\u003eDB: Order.status=AllTraded\\u003cbr/\\u003eOrder.signal=signal\\n```\\n\\n**Final Database State:**\\n\\n| Model | Key Fields |\\n|-------|------------|\\n| **Signal** | code='rb2501', type='BUY', volume=2, processed=True |\\n| **Order** | order_ref='0000042000123', status='AllTraded', volume=2, signal_id=123 |\\n| **Trade** | code='rb2501', direction='LONG', shares=2, filled_shares=2, avg_entry_price=3650.5, close_time=NULL |\\n\\n**Sources:** [trader/strategy/brother2.py:725-856](), [trader/strategy/brother2.py:301-343](), [trader/strategy/brother2.py:510-566](), [trader/strategy/brother2.py:391-469]()\"])</script><script>self.__next_f.push([1,\"25:T621f,\"])</script><script>self.__next_f.push([1,\"# Risk Management\\n\\n\\u003cdetails\\u003e\\n\\u003csummary\\u003eRelevant source files\\u003c/summary\\u003e\\n\\nThe following files were used as context for generating this wiki page:\\n\\n- [panel/models.py](panel/models.py)\\n- [trader/strategy/brother2.py](trader/strategy/brother2.py)\\n- [trader/utils/__init__.py](trader/utils/__init__.py)\\n\\n\\u003c/details\\u003e\\n\\n\\n\\nThis document describes the risk management systems and controls implemented in the automated trading platform. The risk management framework operates at multiple levels: position sizing, stop-loss execution, margin monitoring, price limit validation, and portfolio-level risk controls.\\n\\nFor information about signal generation and order execution workflows, see [Signal Generation](#4.3) and [Order Execution Flow](#4.4). For performance tracking and equity monitoring, see [Data Models](#5.1).\\n\\n## Overview of Risk Controls\\n\\nThe system implements a multi-layered risk management approach:\\n\\n1. **Pre-trade validation**: Position sizing based on account equity and ATR-based risk limits\\n2. **Stop-loss mechanisms**: ATR-based trailing stops for both long and short positions\\n3. **Margin monitoring**: Real-time margin usage tracking with pre-trade margin estimation\\n4. **Price limit protection**: Automatic price adjustment to stay within exchange limits\\n5. **Portfolio risk controls**: Account-level risk percentage monitoring and diversification tracking\\n\\n```mermaid\\ngraph TB\\n    subgraph \\\"Pre-Trade Risk Validation\\\"\\n        SignalGen[\\\"calc_signal()\\u003cbr/\\u003eSignal Generation\\\"]\\n        PositionSize[\\\"Position Sizing\\u003cbr/\\u003e(ATR-based)\\\"]\\n        MarginCheck[\\\"Margin Estimation\\\"]\\n        RiskCheck[\\\"Risk Percentage Check\\u003cbr/\\u003e80% threshold\\\"]\\n    end\\n    \\n    subgraph \\\"Order Execution Controls\\\"\\n        PriceLimits[\\\"calc_up_limit()\\u003cbr/\\u003ecalc_down_limit()\\u003cbr/\\u003ePrice Limit Validation\\\"]\\n        OrderInsert[\\\"ReqOrderInsert()\\u003cbr/\\u003eOrder Submission\\\"]\\n        OrderReject[\\\"OnRtnOrder()\\u003cbr/\\u003eRejection Handling\\\"]\\n    end\\n    \\n    subgraph \\\"Position Monitoring\\\"\\n        StopLoss[\\\"ATR Trailing Stop-Loss\\\"]\\n        MarginMonitor[\\\"refresh_account()\\u003cbr/\\u003erefresh_position()\\u003cbr/\\u003eMargin Tracking\\\"]\\n        EquityUpdate[\\\"update_equity()\\u003cbr/\\u003eNAV Calculation\\\"]\\n    end\\n    \\n    SignalGen --\\u003e PositionSize\\n    PositionSize --\\u003e MarginCheck\\n    MarginCheck --\\u003e RiskCheck\\n    RiskCheck --\\u003e|Pass| PriceLimits\\n    RiskCheck --\\u003e|Fail| Abort[\\\"Abort Order\\u003cbr/\\u003eLog Warning\\\"]\\n    \\n    PriceLimits --\\u003e OrderInsert\\n    OrderInsert --\\u003e OrderReject\\n    OrderReject --\\u003e|Rejected| PriceAdjust[\\\"Adjust Price\\u003cbr/\\u003e50% reduction\\\"]\\n    PriceAdjust --\\u003e OrderInsert\\n    \\n    OrderInsert --\\u003e|Filled| StopLoss\\n    StopLoss --\\u003e MarginMonitor\\n    MarginMonitor --\\u003e EquityUpdate\\n```\\n\\n**Sources:** [trader/strategy/brother2.py:725-856](), [trader/strategy/brother2.py:86-154]()\\n\\n## Position Sizing\\n\\nThe system uses ATR-based position sizing to ensure consistent risk exposure across all instruments. Position size is calculated dynamically based on account equity, instrument volatility, and configured risk parameters.\\n\\n### Position Sizing Algorithm\\n\\n```mermaid\\nflowchart TD\\n    StartCash[\\\"start_cash = Performance.unit_count\\\"]\\n    SectionProfit[\\\"profit = Sum of profits\\u003cbr/\\u003ein instrument section\\\"]\\n    ATR[\\\"risk_each = ATR  volume_multiple\\\"]\\n    RiskParam[\\\"risk = Strategy.Risk parameter\\u003cbr/\\u003e(e.g., 0.01 for 1%)\\\"]\\n    \\n    Formula[\\\"volume_ori =\\u003cbr/\\u003e(start_cash + profit)  risk / risk_each\\\"]\\n    Round[\\\"volume = round(volume_ori)\\\"]\\n    \\n    Validate{volume \\u003e 0?}\\n    CalcMargin[\\\"use_margin =\\u003cbr/\\u003eprice  volume  volume_multiple\\u003cbr/\\u003e margin_rate\\\"]\\n    \\n    AbortLow[\\\"Log: 'Risk exceeds limit'\\u003cbr/\\u003eAbort order\\\"]\\n    \\n    StartCash --\\u003e Formula\\n    SectionProfit --\\u003e Formula\\n    ATR --\\u003e Formula\\n    RiskParam --\\u003e Formula\\n    \\n    Formula --\\u003e Round\\n    Round --\\u003e Validate\\n    Validate --\\u003e|Yes| CalcMargin\\n    Validate --\\u003e|No| AbortLow\\n```\\n\\n**Sources:** [trader/strategy/brother2.py:828-844]()\\n\\n### Implementation Details\\n\\nThe position sizing calculation occurs in the `calc_signal` method for new position entries:\\n\\n**Key Variables:**\\n- `start_cash`: Initial capital from `Performance.objects.last().unit_count`\\n- `profit`: Cumulative profit from the instrument's section (e.g., all metals)\\n- `risk_each`: Single-contract risk in currency terms (ATR  contract multiplier)\\n- `risk`: Configured risk percentage per trade (from `Strategy.param_set`)\\n\\n**Formula:**\\n```\\nvolume_ori = (start_cash + profit)  risk / risk_each\\nvolume = round(volume_ori)\\n```\\n\\n**Example Calculation:**\\n| Parameter | Value | Unit |\\n|-----------|-------|------|\\n| Start Cash | 1,000,000 | CNY |\\n| Section Profit | 50,000 | CNY |\\n| ATR | 100 | Price points |\\n| Volume Multiple | 10 | Tons/contract |\\n| Risk Parameter | 0.01 | 1% |\\n| **Risk Each** | 1,000 | CNY |\\n| **Volume (raw)** | 10.5 | Contracts |\\n| **Volume (rounded)** | 11 | Contracts |\\n\\n**Sources:** [trader/strategy/brother2.py:828-844]()\\n\\n## Stop-Loss Mechanisms\\n\\nThe system implements ATR-based trailing stop-losses that adapt to market volatility. Stop-loss levels are calculated dynamically and trigger automatic position closure when breached.\\n\\n### Stop-Loss Logic\\n\\n```mermaid\\nflowchart LR\\n    subgraph \\\"Long Position Stop-Loss\\\"\\n        LongEntry[\\\"Entry at idx_pos\\\"]\\n        LongHH[\\\"Calculate highest high\\u003cbr/\\u003efrom entry to current\\\"]\\n        LongStop[\\\"Stop = HH - ATR[entry]  stop_n\\\"]\\n        LongTrigger{close \\u003c= stop?}\\n        LongExit[\\\"Generate SELL signal\\\"]\\n    end\\n    \\n    subgraph \\\"Short Position Stop-Loss\\\"\\n        ShortEntry[\\\"Entry at idx_pos\\\"]\\n        ShortLL[\\\"Calculate lowest low\\u003cbr/\\u003efrom entry to current\\\"]\\n        ShortStop[\\\"Stop = LL + ATR[entry]  stop_n\\\"]\\n        ShortTrigger{close \\u003e= stop?}\\n        ShortExit[\\\"Generate BUY_COVER signal\\\"]\\n    end\\n    \\n    LongEntry --\\u003e LongHH --\\u003e LongStop --\\u003e LongTrigger\\n    LongTrigger --\\u003e|Yes| LongExit\\n    \\n    ShortEntry --\\u003e ShortLL --\\u003e ShortStop --\\u003e ShortTrigger\\n    ShortTrigger --\\u003e|Yes| ShortExit\\n```\\n\\n**Sources:** [trader/strategy/brother2.py:762-826]()\\n\\n### Stop-Loss Implementation\\n\\nStop-loss checks occur daily during signal calculation for open positions:\\n\\n**Long Position Stop-Loss** ([trader/strategy/brother2.py:776-782]()):\\n```\\nCondition: close \\u003c= highest_high - ATR[entry_day - 1]  stop_n\\nAction: Create SELL signal at calc_down_limit price\\nPriority: HIGH\\n```\\n\\n**Short Position Stop-Loss** ([trader/strategy/brother2.py:808-814]()):\\n```\\nCondition: close \\u003e= lowest_low + ATR[entry_day - 1]  stop_n\\nAction: Create BUY_COVER signal at calc_up_limit price\\nPriority: HIGH\\n```\\n\\n**Key Features:**\\n1. **Trailing Mechanism**: Stop level moves with favorable price movement (using HH for longs, LL for shorts)\\n2. **Volatility Adjustment**: ATR multiple ensures stops adapt to market conditions\\n3. **Entry ATR Lock**: Uses ATR from entry day minus one, preventing intraday volatility from widening stops\\n4. **Rollover Handling**: Traces back through contract rollovers to find original entry point ([trader/strategy/brother2.py:764-774]())\\n\\n**Parameters:**\\n| Parameter | Symbol | Typical Value | Description |\\n|-----------|--------|---------------|-------------|\\n| Stop Multiplier | `stop_n` | 2-3 | ATR multiples for stop distance |\\n| ATR Period | `atr_n` | 20 | Days for ATR calculation |\\n\\n**Sources:** [trader/strategy/brother2.py:762-826]()\\n\\n## Margin Management\\n\\nThe system continuously monitors margin usage at both the account level and position level, with pre-trade margin estimation to prevent over-leveraging.\\n\\n### Margin Tracking Components\\n\\n```mermaid\\ngraph TB\\n    subgraph \\\"Account Margin Tracking\\\"\\n        RefreshAccount[\\\"refresh_account()\\u003cbr/\\u003eQuery CTP API\\\"]\\n        AccountFields[\\\"\\u003cb\\u003eBroker Model Fields:\\u003c/b\\u003e\\u003cbr/\\u003ecash: Available funds\\u003cbr/\\u003emargin: Used margin\\u003cbr/\\u003ecurrent: Dynamic equity\\u003cbr/\\u003epre_balance: Static equity\\\"]\\n    end\\n    \\n    subgraph \\\"Position Margin Tracking\\\"\\n        RefreshPos[\\\"refresh_position()\\u003cbr/\\u003eQuery position details\\\"]\\n        TradeFrozen[\\\"\\u003cb\\u003eTrade.frozen_margin:\\u003c/b\\u003e\\u003cbr/\\u003evolume  price  margin_rate\\\"]\\n    end\\n    \\n    subgraph \\\"Pre-Trade Margin Estimation\\\"\\n        CalcSignal[\\\"calc_signal()\\u003cbr/\\u003eNew position signals\\\"]\\n        EstMargin[\\\"use_margin =\\u003cbr/\\u003evolume  price  margin_rate\\u003cbr/\\u003e volume_multiple\\\"]\\n        TotalMargin[\\\"total = use_margin + current_margin\\\"]\\n        RiskRatio[\\\"risk_ratio = total / equity\\\"]\\n    end\\n    \\n    subgraph \\\"Risk Alert System\\\"\\n        Check{risk_ratio \\u003e 0.8?}\\n        Alert[\\\"Log warning:\\u003cbr/\\u003e'Risk ratio will reach XX%\\u003cbr/\\u003eRecommend adding margin'\\\"]\\n    end\\n    \\n    RefreshAccount --\\u003e AccountFields\\n    RefreshPos --\\u003e TradeFrozen\\n    \\n    CalcSignal --\\u003e EstMargin\\n    EstMargin --\\u003e TotalMargin\\n    AccountFields --\\u003e TotalMargin\\n    TotalMargin --\\u003e RiskRatio\\n    RiskRatio --\\u003e Check\\n    Check --\\u003e|Yes| Alert\\n```\\n\\n**Sources:** [trader/strategy/brother2.py:86-154](), [trader/strategy/brother2.py:705-723]()\\n\\n### Margin Calculation Details\\n\\n**Account-Level Margin** ([trader/strategy/brother2.py:86-112]()):\\n- **Source**: `query('TradingAccount')` from CTP API\\n- **Frequency**: Daily at 15:20 via `refresh_all()` scheduled task\\n- **Fields Updated**:\\n  - `Broker.cash`: Available funds for new positions\\n  - `Broker.margin`: Total margin locked in open positions\\n  - `Broker.current`: Dynamic equity (static + unrealized P\\u0026L - fees)\\n  - `Broker.pre_balance`: Static equity (prior close + deposits - withdrawals)\\n\\n**Position-Level Margin** ([trader/strategy/brother2.py:114-154]()):\\n- **Source**: `query('InvestorPositionDetail')` from CTP API\\n- **Calculation**: `margin = volume  open_price  margin_rate`\\n- **Storage**: `Trade.frozen_margin` field per position\\n\\n**Pre-Trade Margin Estimation** ([trader/strategy/brother2.py:840]()):\\n```\\nuse_margin = volume  settlement_price  instrument.margin_rate  instrument.volume_multiple\\n```\\n\\n**Risk Threshold Check** ([trader/strategy/brother2.py:719-721]()):\\n```\\nif (estimated_margin + current_margin) / current_equity \\u003e 0.8:\\n    Log warning with recommended actions\\n```\\n\\n**Sources:** [trader/strategy/brother2.py:86-154](), [trader/strategy/brother2.py:705-723]()\\n\\n## Price Limit Protection\\n\\nThe system prevents order rejections due to price limit violations by calculating valid price ranges based on exchange-provided limit ratios and automatically adjusting rejected orders.\\n\\n### Price Limit Calculation\\n\\n```mermaid\\nflowchart TD\\n    GetRatio[\\\"Get limit_ratio from Redis\\u003cbr/\\u003eKey: LIMITRATIO:{exchange}:{code}:{contract}\\\"]\\n    Settlement[\\\"Get bar.settlement\\u003cbr/\\u003efrom DailyBar\\\"]\\n    \\n    subgraph \\\"Upper Limit (Buy Orders)\\\"\\n        UpCalc[\\\"price = settlement  (1 + limit_ratio)\\u003cbr/\\u003eRound to price_tick\\\"]\\n        UpAdjust[\\\"final = price - price_tick\\u003cbr/\\u003e(One tick inside limit)\\\"]\\n    end\\n    \\n    subgraph \\\"Lower Limit (Sell Orders)\\\"\\n        DownCalc[\\\"price = settlement  (1 - limit_ratio)\\u003cbr/\\u003eRound to price_tick\\\"]\\n        DownAdjust[\\\"final = price + price_tick\\u003cbr/\\u003e(One tick inside limit)\\\"]\\n    end\\n    \\n    GetRatio --\\u003e Settlement\\n    Settlement --\\u003e UpCalc\\n    Settlement --\\u003e DownCalc\\n    UpCalc --\\u003e UpAdjust\\n    DownCalc --\\u003e DownAdjust\\n```\\n\\n**Sources:** [trader/strategy/brother2.py:858-870](), [trader/utils/__init__.py:685-796]()\\n\\n### Price Limit Sources\\n\\nExchange limit ratios are fetched daily and stored in Redis:\\n\\n| Exchange | Data Source | Update Frequency | Storage Key Pattern |\\n|----------|-------------|------------------|---------------------|\\n| SHFE/INE | `ContractDailyTradeArgument{date}.dat` | Daily 17:00 | `LIMITRATIO:SHFE:{code}:{contract}` |\\n| DCE | `exportDayTradPara.html` | Daily 17:00 | `LIMITRATIO:DCE:{code}:{contract}` |\\n| CZCE | `FutureDataClearParams.txt` | Daily 17:00 | `LIMITRATIO:CZCE:{code}:{contract}` |\\n| CFFEX | `jycs/{date}/index.xml` | Daily 17:00 | `LIMITRATIO:CFFEX:{code}:{contract}` |\\n\\n**Limit Ratio Fetch Implementation**: [trader/utils/__init__.py:685-796]()\\n\\n### Order Rejection Handling\\n\\nWhen an order is rejected due to price limit violations, the system automatically adjusts and resubmits:\\n\\n**Rejection Detection** ([trader/strategy/brother2.py:523]()):\\n```\\nif order['OrderStatus'] == OrderStatus.Canceled and \\n   order['OrderSubmitStatus'] == OrderSubmitStatus.InsertRejected:\\n```\\n\\n**Price Adjustment Logic** ([trader/strategy/brother2.py:528-564]()):\\n1. Get last settlement price from `DailyBar`\\n2. Calculate delta: `delta = (order_price - settlement)  0.5`\\n3. Check if delta is sufficient: `delta / settlement \\u003e= 0.01` (1%)\\n4. Adjust price: `new_price = settlement  delta`\\n5. Resubmit order via `ReqOrderInsert(signal)`\\n\\n**Example:**\\n- Original buy order price: 5,100 (rejected, limit is 5,050)\\n- Last settlement: 5,000\\n- Delta: (5,100 - 5,000)  0.5 = 50\\n- New price: 5,000 + 50 = 5,050 \\n- If delta \\u003c 1% of settlement, order is abandoned\\n\\n**Sources:** [trader/strategy/brother2.py:522-565]()\\n\\n## Portfolio Risk Controls\\n\\nThe system implements portfolio-level risk monitoring to prevent over-concentration and excessive leverage across all positions.\\n\\n### Risk Monitoring Dashboard\\n\\n**Real-Time Metrics** ([trader/strategy/brother2.py:86-112]()):\\n\\n| Metric | Field | Calculation | Update Frequency |\\n|--------|-------|-------------|------------------|\\n| Available Funds | `Broker.cash` | From CTP API | Daily 15:20 |\\n| Used Margin | `Broker.margin` | Sum of position margins | Daily 15:20 |\\n| Dynamic Equity | `Broker.current` | Pre-balance + unrealized P\\u0026L - fees | Daily 15:20 |\\n| Static Equity | `Broker.pre_balance` | Prior close + deposits - withdrawals | Daily 15:20 |\\n| Risk Ratio | Calculated | (Used + Estimated Margin) / Equity | Pre-trade |\\n\\n**Daily Performance Recording** ([trader/strategy/brother2.py:656-683]()):\\n- **Time**: 15:30 daily via `update_equity()` task\\n- **Storage**: `Performance` model with NAV and accumulated equity\\n- **Fields**: `capital`, `used_margin`, `dividend`, `NAV`, `accumulated`\\n\\n### Section-Based Diversification\\n\\nPosition sizing incorporates section-level profit tracking to prevent over-exposure to correlated instruments:\\n\\n**Section Aggregation** ([trader/strategy/brother2.py:830-831]()):\\n```python\\nprofit = Trade.objects.filter(\\n    strategy=self.__strategy, \\n    instrument__section=inst.section\\n).aggregate(sum=Sum('profit'))['sum']\\n\\nvolume_ori = (start_cash + profit)  risk / risk_each\\n```\\n\\n**Instrument Sections** (from `panel/models.py`):\\n- Agricultural: Grains, oilseeds, soft commodities\\n- Metals: Base metals, precious metals\\n- Energy: Crude oil, coal, natural gas\\n- Financials: Stock indices, treasury bonds\\n\\nBy adding section profits to the capital base, the system reduces position sizes in sections with accumulated gains, naturally diversifying into underperforming sectors.\\n\\n**Sources:** [trader/strategy/brother2.py:828-834]()\\n\\n### Risk Ratio Alert System\\n\\n**Pre-Trade Risk Check** ([trader/strategy/brother2.py:719-721]()):\\n```python\\nall_margin = sum(estimated margins for new signals)\\nrisk_ratio = (all_margin + self.__margin) / self.__current\\n\\nif risk_ratio \\u003e 0.8:\\n    logger.info(\\n        f\\\"Risk Alert\\\"\\n        f\\\"Opening margin total: {all_margin:,.0f} ({all_margin/10000:.1f})\\\"\\n        f\\\"Account risk ratio will reach: {risk_ratio*100:.0f}%\\\"\\n        f\\\"Recommend adding margin or reducing position size!\\\"\\n    )\\n```\\n\\n**Alert Thresholds:**\\n- **80% risk ratio**: Warning logged, positions still opened\\n- **100% risk ratio**: Insufficient margin, orders would fail at CTP level\\n- **Recommendation**: Maintain risk ratio below 70% for safety buffer\\n\\n**Sources:** [trader/strategy/brother2.py:719-721]()\\n\\n## Risk Parameters Configuration\\n\\nAll risk parameters are stored in the `Param` model and linked to the `Strategy`:\\n\\n### Core Risk Parameters\\n\\n```mermaid\\nclassDiagram\\n    class Param {\\n        +strategy: ForeignKey\\n        +code: CharField\\n        +int_value: IntegerField\\n        +float_value: DecimalField\\n    }\\n    \\n    class RiskParameters {\\n        \\u003c\\u003cenumeration\\u003e\\u003e\\n        BreakPeriod: int\\n        AtrPeriod: int\\n        LongPeriod: int\\n        ShortPeriod: int\\n        StopLoss: int\\n        Risk: float\\n    }\\n    \\n    Param --\\u003e RiskParameters: stores\\n```\\n\\n| Parameter Code | Type | Typical Value | Purpose |\\n|----------------|------|---------------|---------|\\n| `BreakPeriod` | int | 20-60 | Days for breakout channel |\\n| `AtrPeriod` | int | 20 | Days for ATR calculation |\\n| `LongPeriod` | int | 350 | Days for long-term trend |\\n| `ShortPeriod` | int | 75 | Days for short-term trend |\\n| `StopLoss` | int | 2-3 | ATR multiples for stop distance |\\n| `Risk` | float | 0.01 | Risk percentage per trade (1%) |\\n\\n**Parameter Retrieval** ([trader/strategy/brother2.py:727-732]()):\\n```python\\nbreak_n = self.__strategy.param_set.get(code='BreakPeriod').int_value\\natr_n = self.__strategy.param_set.get(code='AtrPeriod').int_value\\nstop_n = self.__strategy.param_set.get(code='StopLoss').int_value\\nrisk = self.__strategy.param_set.get(code='Risk').float_value\\n```\\n\\n**Sources:** [trader/strategy/brother2.py:727-732](), [panel/models.py:128-144]()\\n\\n## Contract Filtering and Restrictions\\n\\nThe system implements filtering mechanisms to exclude high-risk or illiquid contracts from trading.\\n\\n### Ignored Instruments\\n\\n**Configuration** ([trader/strategy/brother2.py:44]()):\\n```python\\nself.__ignore_inst_list = config.get(\\n    'TRADE', 'ignore_inst', \\n    fallback=\\\"WH,bb,JR,RI,RS,LR,PM,im\\\"\\n).split(',')\\n```\\n\\n**Default Excluded Contracts:**\\n- `WH`: Strong gluten wheat (low liquidity)\\n- `bb`: Blockboard (discontinued)\\n- `JR`: Japonica rice (policy restrictions)\\n- `RI`: Long-grain rice (low volume)\\n- `RS`: Rapeseed (seasonal, thin markets)\\n- `LR`: Late indica rice (illiquid)\\n- `PM`: General wheat (policy-sensitive)\\n- `im`: Iron ore fines (replaced by `i`)\\n\\n### Margin Rate Filtering\\n\\nDuring instrument updates, contracts with excessive margin requirements are filtered:\\n\\n**Filter Condition** ([trader/utils/__init__.py:165]()):\\n```python\\nif inst['LongMarginRatio'] \\u003e 1:\\n    continue  # Skip contracts with \\u003e100% margin (likely data error)\\n```\\n\\n### Volume and Open Interest Filters\\n\\nMain contract selection applies liquidity filters to ensure tradeable contracts:\\n\\n**Main Contract Conditions** ([trader/utils/__init__.py:385-400]()):\\n```\\nCondition 1: volume \\u003e= 10,000 AND open_interest \\u003e= 10,000 (for non-CFFEX)\\nCondition 2: Highest volume for 3 consecutive days\\nCondition 3: Highest current volume (fallback)\\n```\\n\\n**Sources:** [trader/strategy/brother2.py:44](), [trader/utils/__init__.py:381-421]()\\n\\n## Exchange-Specific Risk Controls\\n\\nDifferent exchanges have varying rules that require specific risk handling:\\n\\n### SHFE Special Rules\\n\\n**Today/Yesterday Position Handling** ([trader/strategy/brother2.py:324-332]()):\\n```python\\nif pos.open_time.date() == timezone.localtime().date() and \\n   pos.instrument.exchange == ExchangeType.SHFE:\\n    param_dict['CombOffsetFlag'] = ApiStruct.OF_CloseToday\\n```\\n\\nSHFE (Shanghai Futures Exchange) distinguishes between closing today's positions (`CloseToday`) and closing prior positions (`Close`), with different fee structures.\\n\\n### CFFEX Signal Timing\\n\\n**Separate Processing Window** ([trader/strategy/brother2.py:598-609]()):\\n```python\\n@RegisterCallback(crontab='25 9 * * *')\\nasync def processing_signal2(self):\\n    # Process CFFEX (stock index) signals separately at 9:25\\n    for sig in Signal.objects.filter(\\n        instrument__exchange=ExchangeType.CFFEX, ...):\\n        self.io_loop.call_soon(self.ReqOrderInsert, sig)\\n```\\n\\nCFFEX (China Financial Futures Exchange) opens at 9:30, later than commodity markets (9:00), requiring delayed signal processing.\\n\\n### Night Trading Sessions\\n\\n**Night Session Filtering** ([trader/strategy/brother2.py:622-632]()):\\n```python\\n@RegisterCallback(crontab='55 20 * * *')\\nasync def processing_signal3(self):\\n    # Process night trading signals at 20:55\\n    for sig in Signal.objects.filter(\\n        instrument__night_trade=True, ...):\\n        self.io_loop.call_soon(self.ReqOrderInsert, sig)\\n```\\n\\nOnly specific commodity contracts have night trading sessions (21:00-02:30). The system filters signals by `Instrument.night_trade` field.\\n\\n**Sources:** [trader/strategy/brother2.py:324-332](), [trader/strategy/brother2.py:572-642]()\\n\\n## Risk Event Handling\\n\\nThe system implements specific handlers for risk-related events during live trading:\\n\\n### Order Rejection Recovery\\n\\n```mermaid\\nsequenceDiagram\\n    participant Strategy as TradeStrategy\\n    participant CTP as CTP API\\n    participant Handler as OnRtnOrder\\n    participant Logger as Risk Logger\\n    \\n    Strategy-\\u003e\\u003eCTP: ReqOrderInsert(signal)\\n    CTP--\\u003e\\u003eHandler: OrderStatus.Canceled\\u003cbr/\\u003eSubmitStatus.InsertRejected\\n    \\n    Handler-\\u003e\\u003eHandler: Check rejection reason\\n    \\n    alt Price beyond limit\\n        Handler-\\u003e\\u003eHandler: Calculate delta\\u003cbr/\\u003edelta = (price - settlement)  0.5\\n        \\n        alt delta \\u003e= 1% of settlement\\n            Handler-\\u003e\\u003eLogger: Log: \\\"Resubmit at new price\\\"\\n            Handler-\\u003e\\u003eStrategy: ReqOrderInsert(adjusted_signal)\\n        else delta \\u003c 1%\\n            Handler-\\u003e\\u003eLogger: Log: \\\"Abandon order, insufficient room\\\"\\n        end\\n    end\\n```\\n\\n**Sources:** [trader/strategy/brother2.py:510-566]()\\n\\n### Position Reconciliation\\n\\n**Daily Position Refresh** ([trader/strategy/brother2.py:114-154]()):\\n- Query all position details from CTP\\n- Delete `Trade` records for non-existent positions\\n- Create missing `Trade` records for unreported positions (e.g., manual trades)\\n- Update position P\\u0026L based on latest market prices\\n\\n**Orphan Position Cleanup** ([trader/strategy/brother2.py:131]()):\\n```python\\nTrade.objects.filter(\\n    ~Q(code__in=self.__cur_pos.keys()), \\n    close_time__isnull=True\\n).delete()\\n```\\n\\n### Account Anomaly Detection\\n\\n**Deposit/Withdrawal Tracking** ([trader/strategy/brother2.py:91-98]()):\\n```python\\nself.__withdraw = Decimal(account['Withdraw'])\\nself.__deposit = Decimal(account['Deposit'])\\n\\n# Adjust fake capital for deposits/withdrawals\\nfake = self.__fake - self.__deposit + self.__withdraw\\nif fake \\u003c 1:\\n    fake = 0  # Prevent negative fake capital\\n```\\n\\n**Equity Reconciliation** ([trader/strategy/brother2.py:99-100]()):\\n```python\\nself.__pre_balance = Decimal(account['PreBalance']) + \\n                     self.__deposit - self.__withdraw\\nself.__current = self.__pre_balance + Decimal(account['CloseProfit']) + \\n                 Decimal(account['PositionProfit']) - Decimal(account['Commission'])\\n```\\n\\n**Sources:** [trader/strategy/brother2.py:86-112](), [trader/strategy/brother2.py:114-154]()\\n\\n## Best Practices and Recommendations\\n\\n### Recommended Risk Parameter Ranges\\n\\nBased on the system's design and typical futures market volatility:\\n\\n| Parameter | Conservative | Moderate | Aggressive | Notes |\\n|-----------|--------------|----------|------------|-------|\\n| Risk per Trade | 0.005 (0.5%) | 0.01 (1%) | 0.02 (2%) | Higher = larger positions |\\n| Stop Loss ATR | 3 | 2 | 1.5 | Higher = wider stops |\\n| Max Risk Ratio | 60% | 70% | 80% | Account margin / equity |\\n| BreakPeriod | 60 | 40 | 20 | Days for breakout detection |\\n\\n### Pre-Trade Checklist\\n\\nBefore deploying a strategy in live trading:\\n\\n1. **Verify Risk Parameters**\\n   - Confirm `Risk` parameter in `Param` table\\n   - Validate `StopLoss` ATR multiple is appropriate\\n   - Check margin requirements for target instruments\\n\\n2. **Test Margin Calculations**\\n   - Run `calc_signal()` in test mode\\n   - Verify estimated margins don't exceed 70% threshold\\n   - Account for multiple simultaneous signals\\n\\n3. **Validate Price Limits**\\n   - Ensure Redis contains current limit ratios\\n   - Test `calc_up_limit()` and `calc_down_limit()` functions\\n   - Verify exchange-specific limit fetch is working\\n\\n4. **Configure Instrument Filters**\\n   - Update `ignore_inst` list in config.ini\\n   - Verify `Instrument.night_trade` flags are correct\\n   - Check exchange assignments for INE instruments\\n\\n### Monitoring During Live Trading\\n\\n**Critical Metrics to Watch:**\\n\\n1. **Risk Ratio**: `(used_margin + estimated_margin) / current_equity`\\n   - Target: \\u003c 70%\\n   - Warning: 70-80%\\n   - Critical: \\u003e 80%\\n\\n2. **Stop-Loss Execution**\\n   - Monitor `Signal` table for stop signals with `priority=High`\\n   - Verify stop signals are processed within one trading session\\n   - Check for rollover-related stop calculation errors\\n\\n3. **Order Rejection Rate**\\n   - Track `OrderStatus.Canceled` with `InsertRejected`\\n   - High rejection rate may indicate price limit issues\\n   - Review adjusted price calculations\\n\\n4. **Position Reconciliation**\\n   - Compare `Trade` records with CTP position query results\\n   - Investigate discrepancies immediately\\n   - Manual trades should appear in Trade table after daily refresh\\n\\n**Sources:** [trader/strategy/brother2.py:705-856]()\\n\\n## Summary\\n\\nThe risk management system provides comprehensive protection through:\\n\\n1. **Position Sizing**: ATR-based calculation ensuring consistent 1% risk per trade\\n2. **Stop-Losses**: Trailing ATR-based stops that adapt to volatility\\n3. **Margin Controls**: Real-time monitoring with 80% risk ratio threshold\\n4. **Price Protection**: Automatic limit validation and order adjustment\\n5. **Portfolio Limits**: Section-based diversification and account-level risk caps\\n\\nAll risk controls are configurable through the `Strategy` and `Param` models, allowing optimization without code changes. The system prioritizes capital preservation while maintaining flexibility for different trading styles.\"])</script><script>self.__next_f.push([1,\"26:T5c25,\"])</script><script>self.__next_f.push([1,\"# Scheduled Tasks\\n\\n\\u003cdetails\\u003e\\n\\u003csummary\\u003eRelevant source files\\u003c/summary\\u003e\\n\\nThe following files were used as context for generating this wiki page:\\n\\n- [trader/strategy/__init__.py](trader/strategy/__init__.py)\\n- [trader/strategy/brother2.py](trader/strategy/brother2.py)\\n\\n\\u003c/details\\u003e\\n\\n\\n\\n## Purpose and Scope\\n\\nThis page documents the cron-based scheduling system used in the trader platform to execute time-triggered operations. The system handles market data collection, signal processing, account updates, and performance tracking at specific times throughout the trading day.\\n\\nFor information about the trading strategy logic and signal generation, see [TradeStrategy Class](#4.1). For details on signal processing and order execution logic, see [Order Execution Flow](#4.4).\\n\\nSources: [trader/strategy/brother2.py:1-871](), [trader/strategy/__init__.py:1-140]()\\n\\n## Overview\\n\\nThe trader system uses a cron-based scheduler built on Python's `asyncio` event loop and the `croniter` library. The `BaseModule` class provides the scheduling infrastructure, while `TradeStrategy` defines the specific scheduled tasks using the `@RegisterCallback` decorator with crontab expressions.\\n\\nThe scheduling system supports:\\n- **Cron-style time specifications** using standard cron syntax\\n- **Asynchronous task execution** without blocking the event loop\\n- **Automatic task rescheduling** after each execution\\n- **Trading day validation** to skip tasks on non-trading days\\n\\nSources: [trader/strategy/__init__.py:36-140](), [trader/strategy/brother2.py:38-63]()\\n\\n## Scheduling Infrastructure\\n\\n### BaseModule Framework\\n\\nThe `BaseModule` class provides the core scheduling infrastructure through several key components:\\n\\n```mermaid\\ngraph TB\\n    subgraph \\\"BaseModule Class\\\"\\n        CallbackContainer[\\\"CallbackFunctionContainer\\u003cbr/\\u003e(parent class)\\\"]\\n        RegisterCallback[\\\"@RegisterCallback decorator\\u003cbr/\\u003ecrontab parameter\\\"]\\n        CrontabRouter[\\\"crontab_router dict\\u003cbr/\\u003e{cron_expr: {func, iter, handle}}\\\"]\\n        RegisterMethod[\\\"_register_callback()\\u003cbr/\\u003eline 58-70\\\"]\\n        InstallMethod[\\\"install()\\u003cbr/\\u003eline 80-93\\\"]\\n    end\\n    \\n    subgraph \\\"Event Loop Management\\\"\\n        IOLoop[\\\"asyncio.new_event_loop()\\u003cbr/\\u003eself.io_loop\\\"]\\n        CallAt[\\\"io_loop.call_at()\\u003cbr/\\u003eschedule next execution\\\"]\\n        CallNext[\\\"_call_next(key)\\u003cbr/\\u003eline 74-78\\\"]\\n        GetNext[\\\"_get_next(key)\\u003cbr/\\u003eline 71-72\\\"]\\n    end\\n    \\n    subgraph \\\"Cron Processing\\\"\\n        Croniter[\\\"croniter library\\u003cbr/\\u003eparse cron expressions\\\"]\\n        GetNextTime[\\\"croniter.get_next()\\u003cbr/\\u003ecalculate next timestamp\\\"]\\n    end\\n    \\n    RegisterCallback --\\u003e|\\\"defines\\\"| CrontabRouter\\n    InstallMethod --\\u003e RegisterMethod\\n    RegisterMethod --\\u003e CrontabRouter\\n    RegisterMethod --\\u003e Croniter\\n    \\n    CrontabRouter --\\u003e CallNext\\n    CallNext --\\u003e GetNext\\n    GetNext --\\u003e Croniter\\n    GetNext --\\u003e GetNextTime\\n    CallNext --\\u003e CallAt\\n    CallAt --\\u003e|\\\"schedules\\\"| CallNext\\n    \\n    IOLoop --\\u003e|\\\"executes\\\"| CallNext\\n```\\n\\n**BaseModule Scheduling Components**\\n\\nSources: [trader/strategy/__init__.py:36-93]()\\n\\n| Component | Type | Purpose |\\n|-----------|------|---------|\\n| `callback_fun_args` | dict | Stores decorator arguments for each callback function |\\n| `crontab_router` | defaultdict | Maps cron expressions to function, iterator, and handle |\\n| `io_loop` | asyncio.EventLoop | Event loop for scheduling and executing tasks |\\n| `datetime` | timezone-aware datetime | System time reference for cron calculations |\\n| `time` | float | Unix timestamp when registration occurred |\\n| `loop_time` | float | Event loop time when registration occurred |\\n\\nSources: [trader/strategy/__init__.py:36-56]()\\n\\n### Registration and Initialization Flow\\n\\n```mermaid\\nsequenceDiagram\\n    participant Strategy as \\\"TradeStrategy instance\\\"\\n    participant BaseModule as \\\"BaseModule\\\"\\n    participant CallbackContainer as \\\"CallbackFunctionContainer\\\"\\n    participant Croniter as \\\"croniter library\\\"\\n    participant EventLoop as \\\"asyncio event loop\\\"\\n    \\n    Note over Strategy: Initialization\\n    Strategy-\\u003e\\u003eBaseModule: __init__()\\n    BaseModule-\\u003e\\u003eCallbackContainer: super().__init__()\\n    CallbackContainer-\\u003e\\u003eCallbackContainer: Scan for @RegisterCallback decorators\\n    CallbackContainer-\\u003e\\u003eCallbackContainer: Store in callback_fun_args\\n    \\n    Note over Strategy: Installation\\n    Strategy-\\u003e\\u003eBaseModule: await install()\\n    BaseModule-\\u003e\\u003eBaseModule: _register_callback()\\n    \\n    loop For each crontab callback\\n        BaseModule-\\u003e\\u003eCroniter: croniter(cron_expr, datetime)\\n        Croniter--\\u003e\\u003eBaseModule: iterator object\\n        BaseModule-\\u003e\\u003eBaseModule: Store in crontab_router[key]\\n        BaseModule-\\u003e\\u003eBaseModule: _get_next(key)\\n        BaseModule-\\u003e\\u003eCroniter: iterator.get_next()\\n        Croniter--\\u003e\\u003eBaseModule: next_timestamp\\n        BaseModule-\\u003e\\u003eEventLoop: call_at(next_timestamp, _call_next, key)\\n        EventLoop--\\u003e\\u003eBaseModule: handle\\n        BaseModule-\\u003e\\u003eBaseModule: Store handle in crontab_router[key]\\n    end\\n    \\n    BaseModule--\\u003e\\u003eStrategy: Initialization complete\\n    \\n    Note over EventLoop: At scheduled time\\n    EventLoop-\\u003e\\u003eBaseModule: Execute _call_next(key)\\n    BaseModule-\\u003e\\u003eBaseModule: Cancel old handle\\n    BaseModule-\\u003e\\u003eEventLoop: Reschedule with call_at()\\n    BaseModule-\\u003e\\u003eEventLoop: create_task(func())\\n    EventLoop-\\u003e\\u003eStrategy: Execute scheduled callback\\n```\\n\\n**Task Registration and Execution Sequence**\\n\\nSources: [trader/strategy/__init__.py:58-93]()\\n\\n### Cron Expression Processing\\n\\nThe system converts cron expressions to actual execution times using the following logic:\\n\\n1. **Parse cron expression** using `croniter(cron_expr, start_datetime)` [trader/strategy/__init__.py:66]()\\n2. **Calculate next execution** via `croniter.get_next()` which returns Unix timestamp [trader/strategy/__init__.py:72]()\\n3. **Convert to event loop time** by adding delta to `loop_time` [trader/strategy/__init__.py:72]()\\n4. **Schedule execution** using `io_loop.call_at(loop_time, callback, args)` [trader/strategy/__init__.py:77]()\\n5. **Reschedule after execution** by repeating steps 2-4 [trader/strategy/__init__.py:74-78]()\\n\\nSources: [trader/strategy/__init__.py:71-78]()\\n\\n## Task Execution Flow\\n\\n```mermaid\\nsequenceDiagram\\n    participant EventLoop as \\\"asyncio Event Loop\\\"\\n    participant BaseModule as \\\"BaseModule\\\"\\n    participant Callback as \\\"Scheduled Callback\\u003cbr/\\u003e(e.g., processing_signal1)\\\"\\n    participant CronRouter as \\\"crontab_router\\\"\\n    participant Croniter as \\\"croniter\\\"\\n    \\n    Note over EventLoop: Scheduled time reached\\n    EventLoop-\\u003e\\u003eBaseModule: _call_next(key)\\n    \\n    BaseModule-\\u003e\\u003eCronRouter: Get crontab_router[key]\\n    CronRouter--\\u003e\\u003eBaseModule: {func, iter, handle}\\n    \\n    BaseModule-\\u003e\\u003eBaseModule: Cancel existing handle\\n    Note over BaseModule: handle.cancel()\\n    \\n    BaseModule-\\u003e\\u003eBaseModule: _get_next(key)\\n    BaseModule-\\u003e\\u003eCroniter: iter.get_next()\\n    Croniter--\\u003e\\u003eBaseModule: next_timestamp\\n    BaseModule-\\u003e\\u003eBaseModule: Convert to loop_time\\n    \\n    BaseModule-\\u003e\\u003eEventLoop: call_at(next_loop_time, _call_next, key)\\n    EventLoop--\\u003e\\u003eBaseModule: new_handle\\n    BaseModule-\\u003e\\u003eCronRouter: Store new_handle\\n    \\n    BaseModule-\\u003e\\u003eEventLoop: create_task(func())\\n    EventLoop-\\u003e\\u003eCallback: Execute async function\\n    \\n    Note over Callback: Task execution\\u003cbr/\\u003e(may take several seconds)\\n    \\n    Callback--\\u003e\\u003eEventLoop: Task complete\\n    \\n    Note over EventLoop: Wait until next scheduled time\\n```\\n\\n**Scheduled Task Execution Flow**\\n\\nSources: [trader/strategy/__init__.py:74-78]()\\n\\n## Scheduled Tasks Reference\\n\\n### Complete Task List\\n\\nThe `TradeStrategy` class defines ten scheduled tasks that execute at specific times throughout the trading day:\\n\\n| Task Name | Cron Expression | Time | Purpose |\\n|-----------|----------------|------|---------|\\n| `heartbeat` | `*/1 * * * *` | Every minute | Update heartbeat indicator in Redis |\\n| `processing_signal1` | `55 8 * * *` | 08:55 | Process day session signals (non-CFFEX) |\\n| `check_signal1_processed` | `1 9 * * *` | 09:01 | Verify day signals were processed |\\n| `processing_signal2` | `25 9 * * *` | 09:25 | Process CFFEX (stock index) signals |\\n| `check_signal2_processed` | `31 9 * * *` | 09:31 | Verify CFFEX signals were processed |\\n| `processing_signal3` | `55 20 * * *` | 20:55 | Process night session signals |\\n| `check_signal3_processed` | `1 21 * * *` | 21:01 | Verify night signals were processed |\\n| `refresh_all` | `20 15 * * *` | 15:20 | Update account, positions, instruments |\\n| `update_equity` | `30 15 * * *` | 15:30 | Calculate daily performance metrics |\\n| `collect_quote` | `0 17 * * *` | 17:00 | Fetch exchange data and generate signals |\\n\\nSources: [trader/strategy/brother2.py:568-703]()\\n\\n### Task Implementation Details\\n\\n#### Heartbeat Task\\n\\n```\\n@RegisterCallback(crontab='*/1 * * * *')\\nasync def heartbeat(self):\\n```\\n\\n**Purpose:** Maintains a Redis key indicating the trading system is alive.\\n\\n**Operations:**\\n- Sets `HEARTBEAT:TRADER` key with TTL of 301 seconds\\n- Allows monitoring systems to detect if trader process has died\\n\\nSources: [trader/strategy/brother2.py:568-570]()\\n\\n#### Signal Processing Tasks\\n\\nThe system has three signal processing windows corresponding to different trading sessions:\\n\\n##### processing_signal1 (Day Session)\\n\\n```\\n@RegisterCallback(crontab='55 8 * * *')\\nasync def processing_signal1(self):\\n```\\n\\n**Purpose:** Process signals for day-session instruments (excluding CFFEX) before market open at 09:00.\\n\\n**Operations:**\\n1. Wait 5 seconds after scheduled time [line 574]()\\n2. Validate it's a trading day using `is_trading_day()` [line 576]()\\n3. Query unprocessed signals for instruments with `night_trade=False` and not CFFEX [line 579-580]()\\n4. Call `ReqOrderInsert()` for each signal [line 582]()\\n5. Special handling: After holidays (\\u003e3 days), also process night signals [line 583-585]()\\n\\nSources: [trader/strategy/brother2.py:572-585]()\\n\\n##### processing_signal2 (CFFEX Session)\\n\\n```\\n@RegisterCallback(crontab='25 9 * * *')\\nasync def processing_signal2(self):\\n```\\n\\n**Purpose:** Process signals for CFFEX instruments (stock index futures) which start trading at 09:30.\\n\\n**Operations:**\\n1. Wait 5 seconds after scheduled time [line 600]()\\n2. Validate trading day [line 602]()\\n3. Query unprocessed CFFEX signals [line 605-606]()\\n4. Call `ReqOrderInsert()` for each signal [line 608]()\\n\\nSources: [trader/strategy/brother2.py:598-608]()\\n\\n##### processing_signal3 (Night Session)\\n\\n```\\n@RegisterCallback(crontab='55 20 * * *')\\nasync def processing_signal3(self):\\n```\\n\\n**Purpose:** Process signals for night-trading instruments before night session opens at 21:00.\\n\\n**Operations:**\\n1. Wait 5 seconds after scheduled time [line 623]()\\n2. Validate trading day [line 625]()\\n3. Query unprocessed signals for instruments with `night_trade=True` [line 628-629]()\\n4. Call `ReqOrderInsert()` for each signal [line 631]()\\n\\nSources: [trader/strategy/brother2.py:621-631]()\\n\\n#### Signal Verification Tasks\\n\\nEach signal processing task has a corresponding verification task that runs 6 minutes later:\\n\\n##### check_signal1_processed\\n\\n```\\n@RegisterCallback(crontab='1 9 * * *')\\nasync def check_signal1_processed(self):\\n```\\n\\n**Purpose:** Reprocess any day-session signals that failed to execute.\\n\\nSources: [trader/strategy/brother2.py:587-596]()\\n\\n##### check_signal2_processed\\n\\n```\\n@RegisterCallback(crontab='31 9 * * *')\\nasync def check_signal2_processed(self):\\n```\\n\\n**Purpose:** Reprocess any CFFEX signals that failed to execute.\\n\\nSources: [trader/strategy/brother2.py:610-619]()\\n\\n##### check_signal3_processed\\n\\n```\\n@RegisterCallback(crontab='1 21 * * *')\\nasync def check_signal3_processed(self):\\n```\\n\\n**Purpose:** Reprocess any night-session signals that failed to execute.\\n\\nSources: [trader/strategy/brother2.py:633-642]()\\n\\n#### Account Refresh Task\\n\\n```\\n@RegisterCallback(crontab='20 15 * * *')\\nasync def refresh_all(self):\\n```\\n\\n**Purpose:** Update all account information after market close (15:00).\\n\\n**Operations:**\\n1. Validate trading day [line 647-650]()\\n2. Call `refresh_account()` - update cash, margin, equity [line 651]()\\n3. Call `refresh_position()` - sync positions with CTP [line 652]()\\n4. Call `refresh_instrument()` - update contract specifications [line 653]()\\n\\nSources: [trader/strategy/brother2.py:644-654]()\\n\\n**refresh_account() Details:**\\n- Queries CTP for `TradingAccount` data [line 89]()\\n- Updates `Broker` model with current cash, equity, margin [line 104-108]()\\n- Calculates virtual capital accounting for deposits/withdrawals [line 94-96]()\\n\\nSources: [trader/strategy/brother2.py:86-112]()\\n\\n**refresh_position() Details:**\\n- Queries CTP for `InvestorPositionDetail` [line 117]()\\n- Aggregates positions by instrument code [line 119-130]()\\n- Updates or creates `Trade` records for each position [line 132-151]()\\n- Deletes `Trade` records for closed positions [line 131]()\\n\\nSources: [trader/strategy/brother2.py:114-154]()\\n\\n**refresh_instrument() Details:**\\n- Queries CTP for all tradable futures instruments [line 160]()\\n- Filters by exchange and margin ratio [line 165-166]()\\n- Updates `Instrument` model with contract specs [line 183-202]()\\n- Queries and updates margin rates and commission fees for main contracts [line 188-193]()\\n\\nSources: [trader/strategy/brother2.py:156-205]()\\n\\n#### Performance Update Task\\n\\n```\\n@RegisterCallback(crontab='30 15 * * *')\\nasync def update_equity(self):\\n```\\n\\n**Purpose:** Calculate and record daily performance metrics.\\n\\n**Operations:**\\n1. Validate trading day [line 658]()\\n2. Calculate accumulated dividends from past performance [line 660-663]()\\n3. Adjust for deposits and withdrawals [line 664]()\\n4. Update virtual capital accounting [line 666-670]()\\n5. Calculate unit count (total capital base) [line 671]()\\n6. Calculate NAV (Net Asset Value) = (current + fake) / unit [line 672]()\\n7. Calculate accumulated NAV = current / (unit - fake) [line 673]()\\n8. Create `Performance` record for the day [line 674-676]()\\n\\nSources: [trader/strategy/brother2.py:656-682]()\\n\\n#### Data Collection and Signal Generation Task\\n\\n```\\n@RegisterCallback(crontab='0 17 * * *')\\nasync def collect_quote(self, tasks=None):\\n```\\n\\n**Purpose:** Fetch daily market data from exchanges and generate trading signals for next day.\\n\\n**Operations:**\\n1. Validate trading day [line 688-690]()\\n2. Execute data fetch tasks asynchronously [line 694-695]():\\n   - `update_from_shfe` - Shanghai Futures Exchange\\n   - `update_from_dce` - Dalian Commodity Exchange\\n   - `update_from_czce` - Zhengzhou Commodity Exchange\\n   - `update_from_cffex` - China Financial Futures Exchange\\n   - `update_from_gfex` - Guangzhou Futures Exchange\\n   - `get_contracts_argument` - Fetch contract specifications\\n3. Wait for all tasks with `asyncio.gather()` [line 695]()\\n4. If all successful, call `calculate()` to generate signals [line 697]()\\n5. If any failed, retry failed tasks after 10 minutes [line 699-700]()\\n\\nSources: [trader/strategy/brother2.py:684-703]()\\n\\n**calculate() Method:**\\n- Iterates through all instruments [line 711]()\\n- For each instrument, calls `calc_main_inst()` to update main contract [line 714]()\\n- Calls `calc_signal()` to generate trading signals [line 717]()\\n- Accumulates margin requirements and warns if risk exceeds 80% [line 719-721]()\\n\\nSources: [trader/strategy/brother2.py:705-723]()\\n\\n## Trading Day Schedule\\n\\nThe following diagram shows when each scheduled task executes during a typical trading day:\\n\\n```mermaid\\ngantt\\n    title Trading Day Scheduled Task Timeline\\n    dateFormat HH:mm\\n    axisFormat %H:%M\\n    \\n    section Pre-Market\\n    \\\"processing_signal1\\u003cbr/\\u003eDay session signals\\\" :milestone, m1, 08:55, 0m\\n    \\\"check_signal1_processed\\u003cbr/\\u003eVerify day signals\\\" :milestone, m2, 09:01, 0m\\n    \\\"processing_signal2\\u003cbr/\\u003eCFFEX signals\\\" :milestone, m3, 09:25, 0m\\n    \\\"check_signal2_processed\\u003cbr/\\u003eVerify CFFEX signals\\\" :milestone, m4, 09:31, 0m\\n    \\n    section Market Hours\\n    \\\"Day Session Trading\\\" :active, t1, 09:00, 135m\\n    \\\"Lunch Break\\\" :crit, t2, 11:30, 90m\\n    \\\"Afternoon Session\\\" :active, t3, 13:00, 120m\\n    \\n    section Post-Market\\n    \\\"refresh_all\\u003cbr/\\u003eAccount, positions, instruments\\\" :milestone, m5, 15:20, 0m\\n    \\\"update_equity\\u003cbr/\\u003eDaily performance\\\" :milestone, m6, 15:30, 0m\\n    \\\"collect_quote\\u003cbr/\\u003eData fetch + signal gen\\\" :milestone, m7, 17:00, 0m\\n    \\n    section Evening\\n    \\\"processing_signal3\\u003cbr/\\u003eNight session signals\\\" :milestone, m8, 20:55, 0m\\n    \\\"Night Session Trading\\\" :active, t4, 21:00, 210m\\n    \\\"check_signal3_processed\\u003cbr/\\u003eVerify night signals\\\" :milestone, m9, 21:01, 0m\\n```\\n\\n**Daily Execution Timeline**\\n\\nSources: [trader/strategy/brother2.py:568-703]()\\n\\n### Task Coordination Logic\\n\\n```mermaid\\nflowchart TD\\n    Start[\\\"17:00 collect_quote\\u003cbr/\\u003eFetch exchange data\\\"]\\n    \\n    Start --\\u003e CalcMain[\\\"calculate()\\u003cbr/\\u003eGenerate main contracts\\\"]\\n    CalcMain --\\u003e CalcSignal[\\\"calc_signal()\\u003cbr/\\u003eGenerate trading signals\\\"]\\n    CalcSignal --\\u003e SaveSignal[\\\"Save Signal records\\u003cbr/\\u003eto database\\\"]\\n    \\n    SaveSignal --\\u003e NightCheck{\\\"Has night\\u003cbr/\\u003etrading?\\\"}\\n    NightCheck --\\u003e|Yes| Night[\\\"20:55 processing_signal3\\u003cbr/\\u003eProcess night signals\\\"]\\n    NightCheck --\\u003e|No| Day[\\\"Wait for next day\\\"]\\n    \\n    Night --\\u003e NightVerify[\\\"21:01 check_signal3_processed\\u003cbr/\\u003eVerify execution\\\"]\\n    \\n    Day --\\u003e Morning1[\\\"08:55 processing_signal1\\u003cbr/\\u003eProcess day signals\\\"]\\n    Morning1 --\\u003e Verify1[\\\"09:01 check_signal1_processed\\u003cbr/\\u003eVerify execution\\\"]\\n    \\n    Verify1 --\\u003e Morning2[\\\"09:25 processing_signal2\\u003cbr/\\u003eProcess CFFEX signals\\\"]\\n    Morning2 --\\u003e Verify2[\\\"09:31 check_signal2_processed\\u003cbr/\\u003eVerify execution\\\"]\\n    \\n    Verify2 --\\u003e Trade[\\\"Trading day execution\\\"]\\n    \\n    Trade --\\u003e Close[\\\"15:20 refresh_all\\u003cbr/\\u003eUpdate positions\\\"]\\n    Close --\\u003e Perf[\\\"15:30 update_equity\\u003cbr/\\u003eCalculate performance\\\"]\\n    \\n    Perf --\\u003e Start\\n    \\n    style Start fill:#e1f5ff\\n    style CalcSignal fill:#e1f5ff\\n    style SaveSignal fill:#ffe1e1\\n    style Night fill:#fff4e1\\n    style Morning1 fill:#fff4e1\\n    style Morning2 fill:#fff4e1\\n    style Close fill:#e1ffe1\\n    style Perf fill:#e1ffe1\\n```\\n\\n**Task Coordination and Data Flow**\\n\\nSources: [trader/strategy/brother2.py:684-856]()\\n\\n## Implementation Details\\n\\n### Trading Day Validation\\n\\nMost scheduled tasks validate that the current day is a trading day before executing:\\n\\n```python\\nday = timezone.localtime()\\n_, trading = await is_trading_day(day)\\nif not trading:\\n    logger.info(', ')\\n    return\\n```\\n\\nThis prevents unnecessary operations on weekends and holidays. The `is_trading_day()` function is defined in [trader/utils/__init__.py]() and checks against a calendar of Chinese trading holidays.\\n\\nSources: [trader/strategy/brother2.py:647-650](), [trader/strategy/brother2.py:687-690]()\\n\\n### Signal Processing Logic\\n\\nSignal processing tasks follow this pattern:\\n\\n1. **Query unprocessed signals** from database with filters for:\\n   - Strategy match: `strategy=self.__strategy`\\n   - Time range: `trigger_time__gte=self.__last_trading_day`\\n   - Unprocessed: `processed=False`\\n   - Session-specific filters (exchange, night_trade flag)\\n   - Order by priority: `.order_by('-priority')`\\n\\n2. **Execute each signal** by calling `self.io_loop.call_soon(self.ReqOrderInsert, sig)`, which:\\n   - Generates an order request\\n   - Publishes to Redis CTP request channel\\n   - Returns immediately (non-blocking)\\n\\n3. **Signal completion** is tracked asynchronously through CTP callbacks [trader/strategy/brother2.py:463-467]()\\n\\nSources: [trader/strategy/brother2.py:572-642]()\\n\\n### Error Handling and Retry Logic\\n\\nThe `collect_quote()` task implements retry logic for failed data fetches:\\n\\n```python\\nresult = await asyncio.gather(*[func(day) for func in tasks], return_exceptions=True)\\nif all(result):\\n    self.io_loop.call_soon(self.calculate, day)\\nelse:\\n    failed_tasks = [tasks[i] for i, rst in enumerate(result) if not rst]\\n    self.io_loop.call_later(10 * 60, asyncio.create_task, self.collect_quote(failed_tasks))\\n```\\n\\nThis ensures that temporary network failures don't prevent data collection. Failed tasks are retried after 10 minutes.\\n\\nSources: [trader/strategy/brother2.py:695-700]()\\n\\n### Task Timing Considerations\\n\\n| Time | Task | Rationale |\\n|------|------|-----------|\\n| 08:55 | `processing_signal1` | 5 minutes before day session opens (09:00) |\\n| 09:01 | `check_signal1_processed` | 6 minutes after signal processing started |\\n| 09:25 | `processing_signal2` | 5 minutes before CFFEX session opens (09:30) |\\n| 15:20 | `refresh_all` | 20 minutes after market closes (15:00) to allow settlement |\\n| 15:30 | `update_equity` | After account refresh completes |\\n| 17:00 | `collect_quote` | After exchanges publish daily settlement data |\\n| 20:55 | `processing_signal3` | 5 minutes before night session opens (21:00) |\\n\\nThe timing ensures adequate buffer for exchange data availability and CTP API processing.\\n\\nSources: [trader/strategy/brother2.py:568-703]()\\n\\n### Async Sleep Pattern\\n\\nSeveral tasks include `await asyncio.sleep(5)` at the beginning [trader/strategy/brother2.py:574](), [trader/strategy/brother2.py:600](), [trader/strategy/brother2.py:623](). This provides a small buffer after the scheduled time to ensure:\\n- Database operations from previous tasks complete\\n- System resources are available\\n- Clock synchronization tolerance\\n\\nSources: [trader/strategy/brother2.py:574](), [trader/strategy/brother2.py:600](), [trader/strategy/brother2.py:623]()\\n\\n## Task Dependencies\\n\\n```mermaid\\ngraph TB\\n    subgraph \\\"Data Layer\\\"\\n        Signal[\\\"Signal model\\u003cbr/\\u003eUnprocessed signals\\\"]\\n        Trade[\\\"Trade model\\u003cbr/\\u003eOpen positions\\\"]\\n        Performance[\\\"Performance model\\u003cbr/\\u003eDaily metrics\\\"]\\n        Broker[\\\"Broker model\\u003cbr/\\u003eAccount data\\\"]\\n        Instrument[\\\"Instrument model\\u003cbr/\\u003eContract specs\\\"]\\n    end\\n    \\n    subgraph \\\"17:00 Data Collection\\\"\\n        CollectQuote[\\\"collect_quote()\\\"]\\n        UpdateSHFE[\\\"update_from_shfe()\\\"]\\n        UpdateDCE[\\\"update_from_dce()\\\"]\\n        UpdateCZCE[\\\"update_from_czce()\\\"]\\n        UpdateCFFEX[\\\"update_from_cffex()\\\"]\\n        UpdateGFEX[\\\"update_from_gfex()\\\"]\\n        Calculate[\\\"calculate()\\\"]\\n        CalcMainInst[\\\"calc_main_inst()\\\"]\\n        CalcSignal[\\\"calc_signal()\\\"]\\n    end\\n    \\n    subgraph \\\"Signal Processing\\\"\\n        ProcessSignal1[\\\"processing_signal1()\\u003cbr/\\u003e08:55\\\"]\\n        ProcessSignal2[\\\"processing_signal2()\\u003cbr/\\u003e09:25\\\"]\\n        ProcessSignal3[\\\"processing_signal3()\\u003cbr/\\u003e20:55\\\"]\\n        ReqOrderInsert[\\\"ReqOrderInsert()\\\"]\\n    end\\n    \\n    subgraph \\\"15:20 Account Refresh\\\"\\n        RefreshAll[\\\"refresh_all()\\\"]\\n        RefreshAccount[\\\"refresh_account()\\\"]\\n        RefreshPosition[\\\"refresh_position()\\\"]\\n        RefreshInstrument[\\\"refresh_instrument()\\\"]\\n    end\\n    \\n    subgraph \\\"15:30 Performance\\\"\\n        UpdateEquity[\\\"update_equity()\\\"]\\n    end\\n    \\n    CollectQuote --\\u003e UpdateSHFE\\n    CollectQuote --\\u003e UpdateDCE\\n    CollectQuote --\\u003e UpdateCZCE\\n    CollectQuote --\\u003e UpdateCFFEX\\n    CollectQuote --\\u003e UpdateGFEX\\n    \\n    UpdateSHFE --\\u003e Calculate\\n    UpdateDCE --\\u003e Calculate\\n    UpdateCZCE --\\u003e Calculate\\n    UpdateCFFEX --\\u003e Calculate\\n    UpdateGFEX --\\u003e Calculate\\n    \\n    Calculate --\\u003e CalcMainInst\\n    CalcMainInst --\\u003e CalcSignal\\n    CalcSignal --\\u003e Signal\\n    \\n    Signal --\\u003e ProcessSignal1\\n    Signal --\\u003e ProcessSignal2\\n    Signal --\\u003e ProcessSignal3\\n    \\n    ProcessSignal1 --\\u003e ReqOrderInsert\\n    ProcessSignal2 --\\u003e ReqOrderInsert\\n    ProcessSignal3 --\\u003e ReqOrderInsert\\n    \\n    RefreshAll --\\u003e RefreshAccount\\n    RefreshAll --\\u003e RefreshPosition\\n    RefreshAll --\\u003e RefreshInstrument\\n    \\n    RefreshAccount --\\u003e Broker\\n    RefreshPosition --\\u003e Trade\\n    RefreshInstrument --\\u003e Instrument\\n    \\n    Broker --\\u003e UpdateEquity\\n    Trade --\\u003e UpdateEquity\\n    UpdateEquity --\\u003e Performance\\n    \\n    Performance --\\u003e CalcSignal\\n    Trade --\\u003e CalcSignal\\n```\\n\\n**Task and Data Dependencies**\\n\\nSources: [trader/strategy/brother2.py:568-856]()\"])</script><script>self.__next_f.push([1,\"27:T4363,\"])</script><script>self.__next_f.push([1,\"# Data Management\\n\\n\\u003cdetails\\u003e\\n\\u003csummary\\u003eRelevant source files\\u003c/summary\\u003e\\n\\nThe following files were used as context for generating this wiki page:\\n\\n- [panel/models.py](panel/models.py)\\n- [trader/utils/__init__.py](trader/utils/__init__.py)\\n- [trader/utils/fetch_data.py](trader/utils/fetch_data.py)\\n\\n\\u003c/details\\u003e\\n\\n\\n\\n## Purpose and Scope\\n\\nThis document provides an overview of the data management subsystem within the trader platform. It covers the complete data lifecycle: acquisition from five Chinese commodity exchanges, processing and transformation into continuous series, storage in Django models, and integration with technical analysis functions.\\n\\nFor detailed information about specific subsystems:\\n- For comprehensive model definitions and field specifications, see [Data Models](#5.1)\\n- For exchange-specific data fetching protocols, see [Exchange Data Acquisition](#5.2)\\n- For main contract selection algorithms and rollover handling, see [Main Contract Calculation](#5.3)\\n- For technical indicator computation, see [Technical Analysis](#5.4)\\n- For backtesting and historical signal generation, see [Historical Signal Calculation](#5.5)\\n\\n---\\n\\n## Data Sources\\n\\nThe system acquires daily market data from five Chinese commodity exchanges, each with different data formats and access protocols:\\n\\n| Exchange | Code | IP Variable | Data Format | Exchange Function | Products |\\n|----------|------|-------------|-------------|-------------------|----------|\\n| Shanghai Futures Exchange | SHFE | `shfe_ip` | JSON | `update_from_shfe()` | Metals, energy |\\n| Dalian Commodity Exchange | DCE | `dce_ip` | TXT (tab-delimited) | `update_from_dce()` | Agricultural, chemicals |\\n| Zhengzhou Commodity Exchange | CZCE | `czce_ip` | TXT (pipe/comma) | `update_from_czce()` | Agricultural |\\n| China Financial Futures Exchange | CFFEX | `cffex_ip` | XML | `update_from_cffex()` | Stock index futures |\\n| Guangzhou Futures Exchange | GFEX | `gfex_ip` | JSON | `update_from_gfex()` | Industrial products |\\n\\nAdditional special handling:\\n- **INE (Shanghai International Energy Exchange)**: Four energy products (`sc`, `bc`, `nr`, `lu`) on SHFE infrastructure but marked with `ExchangeType.INE` [trader/utils/__init__.py:54]()\\n- **Ignored instruments**: Configurable list in `config.ini` under `TRADE.ignore_inst` [trader/utils/__init__.py:53]()\\n\\n**Sources:** [trader/utils/__init__.py:42-52](), [trader/utils/__init__.py:121-349]()\\n\\n---\\n\\n## Data Model Architecture\\n\\nThe data management system is built on Django ORM with eight core models organized into three functional layers:\\n\\n```mermaid\\ngraph TB\\n    subgraph \\\"Configuration Layer\\\"\\n        Broker[\\\"Broker\\u003cbr/\\u003e(Account credentials)\\\"]\\n        Strategy[\\\"Strategy\\u003cbr/\\u003e(Trading logic config)\\\"]\\n        Param[\\\"Param\\u003cbr/\\u003e(Strategy parameters)\\\"]\\n        Instrument[\\\"Instrument\\u003cbr/\\u003e(Contract specifications)\\\"]\\n    end\\n    \\n    subgraph \\\"Market Data Layer\\\"\\n        DailyBar[\\\"DailyBar\\u003cbr/\\u003e(Individual contract OHLC)\\\"]\\n        MainBar[\\\"MainBar\\u003cbr/\\u003e(Continuous series with rollover)\\\"]\\n    end\\n    \\n    subgraph \\\"Trading Layer\\\"\\n        Signal[\\\"Signal\\u003cbr/\\u003e(Trading signals)\\\"]\\n        Order[\\\"Order\\u003cbr/\\u003e(CTP order records)\\\"]\\n        Trade[\\\"Trade\\u003cbr/\\u003e(Position tracking, P\\u0026L)\\\"]\\n        Performance[\\\"Performance\\u003cbr/\\u003e(Daily NAV)\\\"]\\n    end\\n    \\n    Strategy --\\u003e|\\\"ManyToMany\\\"| Instrument\\n    Strategy --\\u003e|\\\"ForeignKey\\\"| Broker\\n    Param --\\u003e|\\\"ForeignKey\\\"| Strategy\\n    \\n    DailyBar --\\u003e|\\\"calc_main_inst()\\\"| MainBar\\n    MainBar --\\u003e|\\\"handle_rollover()\\\"| MainBar\\n    \\n    Instrument --\\u003e Signal\\n    Signal --\\u003e Order\\n    Order --\\u003e Trade\\n    Trade --\\u003e Performance\\n    \\n    Strategy --\\u003e Signal\\n    Strategy --\\u003e Order\\n    Strategy --\\u003e Trade\\n```\\n\\n**Key Model Relationships:**\\n- `DailyBar` stores raw OHLC data for individual contracts (e.g., `cu2112`, `cu2201`)\\n- `MainBar` represents continuous series by tracking the main contract and adjusting for rollovers\\n- `Instrument` defines product specifications (tick size, margin rates, multipliers)\\n- `Signal` represents trading decisions generated by technical analysis\\n- `Trade` tracks positions from open to close with P\\u0026L calculation\\n\\n**Sources:** [panel/models.py:1-289]()\\n\\n---\\n\\n## Data Acquisition Pipeline\\n\\n```mermaid\\nflowchart LR\\n    subgraph \\\"Scheduling\\\"\\n        FetchData[\\\"fetch_data.py\\u003cbr/\\u003efetch_bar()\\\"]\\n        CheckDay[\\\"check_trading_day()\\\"]\\n    end\\n    \\n    subgraph \\\"Exchange Async Tasks\\\"\\n        SHFE[\\\"update_from_shfe()\\u003cbr/\\u003eJSON HTTP GET\\\"]\\n        DCE[\\\"update_from_dce()\\u003cbr/\\u003ePOST form data\\\"]\\n        CZCE[\\\"update_from_czce()\\u003cbr/\\u003eTXT HTTP GET\\\"]\\n        CFFEX[\\\"update_from_cffex()\\u003cbr/\\u003eXML HTTP GET\\\"]\\n        GFEX[\\\"update_from_gfex()\\u003cbr/\\u003eJSON POST\\\"]\\n    end\\n    \\n    subgraph \\\"Database\\\"\\n        DailyBarModel[\\\"DailyBar.objects\\u003cbr/\\u003eupdate_or_create()\\\"]\\n        InstrumentModel[\\\"Instrument.objects\\u003cbr/\\u003eupdate(name=...)\\\"]\\n    end\\n    \\n    FetchData --\\u003e CheckDay\\n    CheckDay --\\u003e|\\\"is_trading_day\\\"| SHFE\\n    CheckDay --\\u003e DCE\\n    CheckDay --\\u003e CZCE\\n    CheckDay --\\u003e CFFEX\\n    CheckDay --\\u003e GFEX\\n    \\n    SHFE --\\u003e DailyBarModel\\n    DCE --\\u003e DailyBarModel\\n    CZCE --\\u003e DailyBarModel\\n    CFFEX --\\u003e DailyBarModel\\n    GFEX --\\u003e DailyBarModel\\n    \\n    SHFE --\\u003e InstrumentModel\\n    \\n    DailyBarModel --\\u003e CalcMain[\\\"calc_main_inst()\\u003cbr/\\u003eIdentify main contract\\\"]\\n    CalcMain --\\u003e MainBarModel[\\\"MainBar.objects\\u003cbr/\\u003estore_main_bar()\\\"]\\n    CalcMain --\\u003e Rollover[\\\"handle_rollover()\\u003cbr/\\u003eBasis adjustment\\\"]\\n```\\n\\n### Acquisition Process\\n\\n**Step 1: Trading Day Verification**\\n\\nThe system checks if a given day is a trading day by querying CFFEX for available data files:\\n\\n```\\ncheck_trading_day(day)  HTTP HEAD request to CFFEX index.xml\\n  Response 200  Trading day\\n  Response 404  Non-trading day\\n```\\n\\n[trader/utils/__init__.py:101-108]()\\n\\n**Step 2: Parallel Exchange Data Fetching**\\n\\nUsing `asyncio` with semaphore-based rate limiting to prevent overwhelming exchange servers:\\n\\n| Exchange | Semaphore Limit | Variable |\\n|----------|----------------|----------|\\n| SHFE | 15 | `max_conn_shfe` |\\n| DCE | 5 | `max_conn_dce` |\\n| CZCE | 15 | `max_conn_czce` |\\n| CFFEX | 15 | `max_conn_cffex` |\\n| GFEX | 5 | `max_conn_gfex` |\\n\\n[trader/utils/__init__.py:42-46]()\\n\\n**Step 3: Data Parsing and Storage**\\n\\nEach exchange function parses the response and creates/updates `DailyBar` records:\\n\\n```python\\nDailyBar.objects.update_or_create(\\n    code=instrument_code,\\n    exchange=ExchangeType.SHFE,\\n    time=day,\\n    defaults={\\n        'expire_date': expire_date,\\n        'open': open_price,\\n        'high': high_price,\\n        'low': low_price,\\n        'close': close_price,\\n        'settlement': settlement_price,\\n        'volume': volume,\\n        'open_interest': open_interest\\n    }\\n)\\n```\\n\\n[trader/utils/__init__.py:154-167]()\\n\\n**Sources:** [trader/utils/fetch_data.py:24-64](), [trader/utils/__init__.py:121-349]()\\n\\n---\\n\\n## Main Contract and Continuous Series\\n\\n### Main Contract Identification\\n\\nThe `calc_main_inst()` function determines which contract is the \\\"main\\\" (most liquid) contract using a three-tier selection algorithm:\\n\\n```mermaid\\nflowchart TD\\n    Start[\\\"calc_main_inst(inst, day)\\\"] --\\u003e Cond1{\\\"Condition 1:\\u003cbr/\\u003evolume \\u003e= 10,000\\u003cbr/\\u003eAND\\u003cbr/\\u003eopen_interest \\u003e= 10,000\\u003cbr/\\u003eOR\\u003cbr/\\u003eexchange == CFFEX\\\"}\\n    \\n    Cond1 --\\u003e|\\\"Yes\\\"| MaxVol1[\\\"Select max(volume)\\u003cbr/\\u003ewith expire_date \\u003e= current_main\\\"]\\n    Cond1 --\\u003e|\\\"No\\\"| Cond2{\\\"Condition 2:\\u003cbr/\\u003eSame contract had\\u003cbr/\\u003emax(volume) for\\u003cbr/\\u003e3 consecutive days?\\\"}\\n    \\n    MaxVol1 --\\u003e Found1{\\\"Contract found?\\\"}\\n    Found1 --\\u003e|\\\"Yes\\\"| CheckChange\\n    Found1 --\\u003e|\\\"No\\\"| Cond2\\n    \\n    Cond2 --\\u003e|\\\"Yes\\\"| UseConsistent[\\\"Use that contract\\\"]\\n    Cond2 --\\u003e|\\\"No\\\"| Fallback[\\\"Condition 3:\\u003cbr/\\u003eUse max(volume)\\u003cbr/\\u003eregardless of thresholds\\\"]\\n    \\n    UseConsistent --\\u003e CheckChange{\\\"Contract changed\\u003cbr/\\u003eAND\\u003cbr/\\u003enew_code \\u003e old_code?\\\"}\\n    Fallback --\\u003e CheckChange\\n    \\n    CheckChange --\\u003e|\\\"Yes\\\"| Rollover[\\\"handle_rollover()\\u003cbr/\\u003eAdjust basis\\\"]\\n    CheckChange --\\u003e|\\\"No\\\"| StoreBar[\\\"store_main_bar()\\\"]\\n    \\n    Rollover --\\u003e StoreBar\\n    StoreBar --\\u003e End[\\\"Return (main_code, updated)\\\"]\\n```\\n\\n**Rollover Handling:**\\n\\nWhen the main contract changes (e.g., from `cu2112` to `cu2201`), the system:\\n\\n1. Calculates basis: `basis = new_contract.close - old_contract.close`\\n2. Adjusts all historical `MainBar` records:\\n   ```\\n   MainBar.objects.filter(time__lt=rollover_date).update(\\n       open=F('open') + basis,\\n       high=F('high') + basis,\\n       low=F('low') + basis,\\n       close=F('close') + basis,\\n       settlement=F('settlement') + basis\\n   )\\n   ```\\n\\nThis creates a continuous price series suitable for technical analysis and backtesting. [trader/utils/__init__.py:365-378]()\\n\\n**Sources:** [trader/utils/__init__.py:381-421](), [trader/utils/__init__.py:365-378](), [trader/utils/__init__.py:352-362]()\\n\\n---\\n\\n## Technical Analysis Integration\\n\\nThe data management system provides processed `MainBar` data to technical analysis functions. These functions use TA-Lib to compute indicators like ATR, SMA, RSI, and MACD.\\n\\n### Data Flow for Signal Generation\\n\\n```mermaid\\nflowchart LR\\n    subgraph \\\"Data Retrieval\\\"\\n        Query[\\\"MainBar.objects.filter()\\u003cbr/\\u003eExchange + product_code + time range\\\"]\\n        DF[\\\"to_df()\\u003cbr/\\u003eConvert to pandas DataFrame\\\"]\\n    end\\n    \\n    subgraph \\\"Indicator Calculation\\\"\\n        ATRCalc[\\\"ATR(high, low, close, period=n)\\\"]\\n        TrendCalc[\\\"SMA calculation\\u003cbr/\\u003eshort_trend, long_trend\\\"]\\n        BreakCalc[\\\"Rolling max/min\\u003cbr/\\u003ehigh_line, low_line\\\"]\\n    end\\n    \\n    subgraph \\\"Signal Logic\\\"\\n        Condition[\\\"Compare:\\u003cbr/\\u003eclose vs high_line\\u003cbr/\\u003eclose vs low_line\\u003cbr/\\u003eshort_trend vs long_trend\\\"]\\n        SignalGen[\\\"Signal.objects.create()\\u003cbr/\\u003eBUY/SELL/BUY_COVER/SELL_SHORT\\\"]\\n    end\\n    \\n    Query --\\u003e DF\\n    DF --\\u003e ATRCalc\\n    DF --\\u003e TrendCalc\\n    DF --\\u003e BreakCalc\\n    \\n    ATRCalc --\\u003e Condition\\n    TrendCalc --\\u003e Condition\\n    BreakCalc --\\u003e Condition\\n    \\n    Condition --\\u003e SignalGen\\n```\\n\\n### Example: Historical Signal Calculation\\n\\nThe `calc_history_signal()` function demonstrates the complete data flow:\\n\\n1. **Fetch data:** Query `MainBar` for the instrument up to the target date [trader/utils/__init__.py:506-509]()\\n2. **Convert to DataFrame:** Use `to_df()` helper to create pandas DataFrame [panel/models.py:25-39]()\\n3. **Calculate indicators:**\\n   - ATR using TA-Lib: `ATR(df.high, df.low, df.close, timeperiod=atr_n)` [trader/utils/__init__.py:511]()\\n   - SMA trends using custom calculation [trader/utils/__init__.py:513-517]()\\n   - Breakout levels using rolling window [trader/utils/__init__.py:518-519]()\\n4. **Generate signals:** Create `Signal` and `Trade` records based on indicator conditions [trader/utils/__init__.py:527-551]()\\n\\n**Sources:** [trader/utils/__init__.py:500-600](), [panel/models.py:25-39]()\\n\\n---\\n\\n## Data Storage Schema\\n\\n### Primary Tables\\n\\n**DailyBar** - Individual contract daily bars\\n\\n| Field | Type | Description |\\n|-------|------|-------------|\\n| `exchange` | CharField(8) | Exchange identifier (SHFE, DCE, etc.) |\\n| `code` | CharField(16) | Contract code (e.g., `cu2112`) |\\n| `expire_date` | IntegerField | Expiration month (e.g., `2112`) |\\n| `time` | DateField | Trading date (indexed) |\\n| `open`, `high`, `low`, `close` | DecimalField(12,3) | OHLC prices |\\n| `settlement` | DecimalField(12,3) | Settlement price |\\n| `volume` | IntegerField | Trading volume |\\n| `open_interest` | DecimalField(12,3) | Open interest |\\n\\n[panel/models.py:216-234]()\\n\\n**MainBar** - Continuous series with rollover adjustments\\n\\n| Field | Type | Description |\\n|-------|------|-------------|\\n| `exchange` | CharField(8) | Exchange identifier |\\n| `product_code` | CharField(8) | Product code (e.g., `cu`) - indexed |\\n| `code` | CharField(16) | Current main contract code |\\n| `time` | DateField | Trading date (indexed) |\\n| `open`, `high`, `low`, `close` | DecimalField(12,3) | Adjusted OHLC prices |\\n| `settlement` | DecimalField(12,3) | Adjusted settlement price |\\n| `volume` | IntegerField | Trading volume |\\n| `open_interest` | DecimalField(12,3) | Open interest |\\n| `basis` | DecimalField(12,3) | Rollover basis adjustment |\\n\\n[panel/models.py:194-213]()\\n\\n**Instrument** - Contract specifications\\n\\nKey fields include:\\n- `product_code` (unique): Product identifier (e.g., `cu`, `rb`, `IF`)\\n- `main_code`: Current main contract\\n- `last_main`: Previous main contract for rollover tracking\\n- `change_time`: Timestamp of last main contract change\\n- `volume_multiple`: Contract multiplier for P\\u0026L calculation\\n- `price_tick`: Minimum price increment\\n- `margin_rate`: Margin requirement ratio\\n- `up_limit_ratio`, `down_limit_ratio`: Daily price limit ratios\\n\\n[panel/models.py:146-170]()\\n\\n**Sources:** [panel/models.py:146-234]()\\n\\n---\\n\\n## Data Acquisition Configuration\\n\\n### Exchange-Specific Parameters\\n\\nThe system uses configurable IP addresses and connection limits defined in `trader/utils/__init__.py`:\\n\\n```python\\ncffex_ip = 'www.cffex.com.cn'\\nshfe_ip = 'www.shfe.com.cn'\\nczce_ip = 'www.czce.com.cn'\\ndce_ip = 'www.dce.com.cn'\\ngfex_ip = 'www.gfex.com.cn'\\n```\\n\\n[trader/utils/__init__.py:48-52]()\\n\\n### Ignored Instruments\\n\\nProducts can be excluded from data acquisition by adding them to the configuration file:\\n\\n```ini\\n[TRADE]\\nignore_inst = SPD,IPS,fb,bb\\n```\\n\\nThis list is loaded at runtime: [trader/utils/__init__.py:53]()\\n\\n### Limit Ratio Updates\\n\\nThe system periodically fetches daily price limit ratios from exchanges using `get_contracts_argument()`. These ratios are:\\n1. Retrieved from exchange websites [trader/utils/__init__.py:685-796]()\\n2. Cached in Redis with keys: `LIMITRATIO:{exchange}:{product_code}:{contract_code}`\\n3. Persisted to `Instrument.up_limit_ratio` and `Instrument.down_limit_ratio` fields\\n\\n**Sources:** [trader/utils/__init__.py:48-53](), [trader/utils/__init__.py:685-796]()\\n\\n---\\n\\n## Utility Functions\\n\\n### Data Conversion\\n\\n**`to_df(queryset, index_col, parse_dates)`**\\n\\nConverts Django QuerySet to pandas DataFrame for analysis. Uses `read_sql_query()` to efficiently transfer data from database to DataFrame format. [panel/models.py:25-39]()\\n\\n**`price_round(x, base)`**\\n\\nRounds prices to the minimum tick size. Example:\\n```\\nprice_round(1.3, 0.2)  1.2\\nprice_round(1.5, 0.2)  1.4\\n```\\n\\nHandles decimal precision correctly for financial calculations. [trader/utils/__init__.py:67-84]()\\n\\n### Trading Day Utilities\\n\\n**`is_trading_day(day)`**\\n\\nChecks Redis cache for trading day information. Redis keys:\\n- `TradingDay`: Current trading day\\n- `LastTradingDay`: Previous trading day\\n\\n[trader/utils/__init__.py:94-98]()\\n\\n**`check_trading_day(day)`**\\n\\nAsynchronously verifies if a date is a trading day by making HTTP request to CFFEX. Returns tuple `(datetime, bool)`. [trader/utils/__init__.py:101-108]()\\n\\n**Sources:** [trader/utils/__init__.py:67-84](), [trader/utils/__init__.py:94-108](), [panel/models.py:25-39]()\\n\\n---\\n\\n## Data Processing Workflow\\n\\n### Daily Update Sequence\\n\\nThe typical daily data update follows this sequence (executed by `fetch_data.py`):\\n\\n1. **Identify trading days** (async batch)\\n   - Query date range (e.g., last 365 days)\\n   - Check each day with `check_trading_day()`\\n   - Collect list of valid trading days\\n\\n2. **Fetch exchange data** (parallel async)\\n   - For each trading day, spawn 4-5 concurrent tasks\\n   - Each task fetches from one exchange\\n   - Semaphores control request rates\\n   - Data is parsed and stored in `DailyBar`\\n\\n3. **Calculate main contracts** (sequential)\\n   - For each `Instrument`, run `calc_main_inst()`\\n   - Detect main contract changes\\n   - Store continuous series in `MainBar`\\n   - Apply rollover adjustments when necessary\\n\\n4. **Update contract specifications** (optional)\\n   - Fetch limit ratios with `get_contracts_argument()`\\n   - Update `Instrument` model fields\\n\\n**Sources:** [trader/utils/fetch_data.py:24-64]()\\n\\n### Historical Data Backfill\\n\\nFor loading historical data from external sources (e.g., third-party data vendors):\\n\\n**`load_kt_data(directory)`**\\n\\nLoads data from text files in Kingsoft Trader format:\\n```\\n1210224,10944.000,10992.000,10758.000,10904.000,10702.000,42202,20897,PK2110\\n```\\n\\nThe function:\\n1. Parses each line for OHLCV data and main contract code\\n2. Detects contract changes within the file\\n3. Bulk inserts `MainBar` records\\n4. Updates `Instrument.main_code` and `Instrument.change_time`\\n\\n[trader/utils/__init__.py:649-681]()\\n\\n**Sources:** [trader/utils/__init__.py:649-681]()\\n\\n---\\n\\n## Summary\\n\\nThe data management subsystem provides:\\n\\n1. **Multi-exchange data acquisition** using async HTTP requests with rate limiting\\n2. **Normalized storage** in Django models (`DailyBar` for raw data, `MainBar` for continuous series)\\n3. **Main contract tracking** with automatic rollover adjustment for continuous backtesting\\n4. **Integration with TA-Lib** through pandas DataFrame conversion\\n5. **Contract specification management** including margin rates, tick sizes, and price limits\\n\\nThe system processes data from five exchanges with different protocols (JSON, XML, TXT) into a unified schema, enabling consistent technical analysis and signal generation across all instruments.\\n\\n**Key Entry Points:**\\n- Data acquisition: `fetch_data.py`  `fetch_bar()`\\n- Main contract calculation: `trader/utils/__init__.py`  `calc_main_inst()`\\n- Historical signal generation: `trader/utils/__init__.py`  `calc_history_signal()`\\n- Data models: `panel/models.py`\\n\\nFor deeper exploration of specific subsystems, refer to the child pages under this section.\"])</script><script>self.__next_f.push([1,\"28:T6174,\"])</script><script>self.__next_f.push([1,\"# Data Models\\n\\n\\u003cdetails\\u003e\\n\\u003csummary\\u003eRelevant source files\\u003c/summary\\u003e\\n\\nThe following files were used as context for generating this wiki page:\\n\\n- [panel/const.py](panel/const.py)\\n- [panel/models.py](panel/models.py)\\n\\n\\u003c/details\\u003e\\n\\n\\n\\n## Purpose and Scope\\n\\nThis document provides a comprehensive reference for all Django ORM models in the trader system. These models define the database schema for storing trading accounts, strategies, market data, signals, orders, trades, and performance metrics.\\n\\nThe models are defined in [panel/models.py:1-289]() and use constants from [panel/const.py:1-178](). For information about how market data flows through these models, see [Data Flow Pipeline](#3.2). For details on how signals are generated and processed using these models, see [Signal Generation](#4.3).\\n\\n**Sources**: [panel/models.py:1-289](), [panel/const.py:1-178]()\\n\\n## Model Architecture Overview\\n\\nThe system contains 12 core Django models organized into four functional categories:\\n\\n```mermaid\\ngraph TB\\n    subgraph \\\"Account \\u0026 Configuration\\\"\\n        Broker[\\\"Broker\\u003cbr/\\u003e(Trading Account)\\\"]\\n        Address[\\\"Address\\u003cbr/\\u003e(CTP Front-end)\\\"]\\n        Strategy[\\\"Strategy\\u003cbr/\\u003e(Trading Strategy)\\\"]\\n        Param[\\\"Param\\u003cbr/\\u003e(Strategy Parameters)\\\"]\\n    end\\n    \\n    subgraph \\\"Market Data\\\"\\n        Instrument[\\\"Instrument\\u003cbr/\\u003e(Contract Metadata)\\\"]\\n        DailyBar[\\\"DailyBar\\u003cbr/\\u003e(Individual Contract OHLC)\\\"]\\n        MainBar[\\\"MainBar\\u003cbr/\\u003e(Main Contract Continuous Series)\\\"]\\n    end\\n    \\n    subgraph \\\"Trading Execution\\\"\\n        Signal[\\\"Signal\\u003cbr/\\u003e(Trading Signals)\\\"]\\n        Order[\\\"Order\\u003cbr/\\u003e(CTP Orders)\\\"]\\n        Trade[\\\"Trade\\u003cbr/\\u003e(Positions \\u0026 P/L)\\\"]\\n    end\\n    \\n    subgraph \\\"Tracking \\u0026 Utilities\\\"\\n        Performance[\\\"Performance\\u003cbr/\\u003e(Daily NAV/Equity)\\\"]\\n        Autonumber[\\\"Autonumber\\u003cbr/\\u003e(ID Generator)\\\"]\\n    end\\n    \\n    Address --\\u003e|\\\"trade_address\\u003cbr/\\u003emarket_address\\\"| Broker\\n    Broker --\\u003e|\\\"ForeignKey\\\"| Strategy\\n    Strategy --\\u003e|\\\"ManyToMany\\\"| Instrument\\n    Strategy --\\u003e|\\\"ForeignKey\\\"| Param\\n    Strategy --\\u003e|\\\"ForeignKey\\\"| Signal\\n    Instrument --\\u003e|\\\"ForeignKey\\\"| Signal\\n    Signal --\\u003e|\\\"OneToOne\\\"| Order\\n    Broker --\\u003e|\\\"ForeignKey\\\"| Order\\n    Strategy --\\u003e|\\\"ForeignKey\\\"| Order\\n    Instrument --\\u003e|\\\"ForeignKey\\\"| Order\\n    Order --\\u003e|\\\"OneToOne\\u003cbr/\\u003e(open_order)\\\"| Trade\\n    Order --\\u003e|\\\"OneToOne\\u003cbr/\\u003e(close_order)\\\"| Trade\\n    Broker --\\u003e|\\\"ForeignKey\\\"| Trade\\n    Strategy --\\u003e|\\\"ForeignKey\\\"| Trade\\n    Instrument --\\u003e|\\\"ForeignKey\\\"| Trade\\n    Broker --\\u003e|\\\"ForeignKey\\\"| Performance\\n```\\n\\n**Diagram: Model Architecture and Relationships**\\n\\nThe models follow a clear data flow: market data is stored in `DailyBar` and processed into `MainBar`. Trading strategies (`Strategy`) monitor instruments (`Instrument`) and generate signals (`Signal`). Signals are executed as orders (`Order`) through brokers (`Broker`), resulting in trades (`Trade`). Daily performance metrics are tracked in `Performance`.\\n\\n**Sources**: [panel/models.py:1-289]()\\n\\n## Entity Relationship Diagram\\n\\n```mermaid\\nerDiagram\\n    Broker ||--o{ Strategy : \\\"has many\\\"\\n    Broker ||--o{ Order : \\\"places\\\"\\n    Broker ||--o{ Trade : \\\"executes\\\"\\n    Broker ||--o{ Performance : \\\"tracks\\\"\\n    Broker }o--|| Address : \\\"trade_address\\\"\\n    Broker }o--|| Address : \\\"market_address\\\"\\n    \\n    Strategy ||--o{ Signal : \\\"generates\\\"\\n    Strategy ||--o{ Order : \\\"controls\\\"\\n    Strategy ||--o{ Trade : \\\"manages\\\"\\n    Strategy ||--o{ Param : \\\"configured by\\\"\\n    Strategy }o--o{ Instrument : \\\"trades\\\"\\n    Strategy }o--o{ Instrument : \\\"force_opens\\\"\\n    \\n    Instrument ||--o{ Signal : \\\"triggers\\\"\\n    Instrument ||--o{ Order : \\\"references\\\"\\n    Instrument ||--o{ Trade : \\\"tracks\\\"\\n    \\n    Signal ||--o| Order : \\\"executed as\\\"\\n    \\n    Order ||--o| Trade : \\\"opens position\\\"\\n    Order ||--o| Trade : \\\"closes position\\\"\\n    \\n    Broker {\\n        int id PK\\n        string name\\n        string contract_type\\n        decimal cash\\n        decimal current\\n        decimal margin\\n    }\\n    \\n    Strategy {\\n        int id PK\\n        int broker_id FK\\n        string name\\n    }\\n    \\n    Instrument {\\n        int id PK\\n        string exchange\\n        string product_code UK\\n        string main_code\\n        string last_main\\n        datetime change_time\\n    }\\n    \\n    Signal {\\n        int id PK\\n        int strategy_id FK\\n        int instrument_id FK\\n        string type\\n        decimal price\\n        int volume\\n        datetime trigger_time\\n        boolean processed\\n    }\\n    \\n    Order {\\n        int id PK\\n        int broker_id FK\\n        int strategy_id FK\\n        int instrument_id FK\\n        int signal_id FK\\n        string order_ref\\n        string status\\n        datetime send_time\\n    }\\n    \\n    Trade {\\n        int id PK\\n        int broker_id FK\\n        int strategy_id FK\\n        int instrument_id FK\\n        int open_order_id FK\\n        int close_order_id FK\\n        int shares\\n        decimal profit\\n    }\\n    \\n    Performance {\\n        int id PK\\n        int broker_id FK\\n        date day\\n        decimal capital\\n        decimal NAV\\n    }\\n```\\n\\n**Diagram: Entity-Relationship Model with Key Fields**\\n\\n**Sources**: [panel/models.py:61-288]()\\n\\n## Account \\u0026 Configuration Models\\n\\n### Broker\\n\\nThe `Broker` model represents a trading account with a futures broker, storing authentication credentials and account balances.\\n\\n**Location**: [panel/models.py:61-82]()\\n\\n| Field | Type | Description |\\n|-------|------|-------------|\\n| `name` | CharField(64) | Account name/identifier |\\n| `contract_type` | CharField(32) | Market type (STOCK, FUTURE, OPTION) from [ContractType](#panel/const.py:19-22)() |\\n| `trade_address` | ForeignKey(Address) | CTP trading front-end server |\\n| `market_address` | ForeignKey(Address) | CTP market data front-end server |\\n| `identify` | CharField(32) | Broker-provided unique identifier |\\n| `username` | CharField(32) | CTP API username |\\n| `password` | CharField(32) | CTP API password |\\n| `fake` | DecimalField(12,2) | Virtual capital for testing |\\n| `cash` | DecimalField(12,2) | Available cash (updated by `refresh_all()`) |\\n| `current` | DecimalField(12,2) | Dynamic equity (current market value) |\\n| `pre_balance` | DecimalField(12,2) | Static equity (previous day's balance) |\\n| `margin` | DecimalField(12,2) | Used margin |\\n\\n**Key Methods**:\\n- `__str__()`: Returns formatted name with market type display\\n\\n**Relationships**:\\n- Has many: `Strategy`, `Order`, `Trade`, `Performance`\\n- References: `Address` (trade_address, market_address)\\n\\n**Sources**: [panel/models.py:61-82](), [panel/const.py:19-22]()\\n\\n### Address\\n\\nThe `Address` model stores CTP front-end server connection details.\\n\\n**Location**: [panel/models.py:47-58]()\\n\\n| Field | Type | Description |\\n|-------|------|-------------|\\n| `name` | CharField(64) | Server name/identifier |\\n| `url` | CharField(128) | Connection URL (e.g., \\\"tcp://180.168.146.187:10100\\\") |\\n| `type` | CharField(16) | Server type (TRADE or MARKET) from [AddressType](#panel/const.py:55-57)() |\\n| `operator` | CharField(16) | Network operator (TELECOM or UNICOM) from [OperatorType](#panel/const.py:60-62)() |\\n\\n**Sources**: [panel/models.py:47-58](), [panel/const.py:55-62]()\\n\\n### Strategy\\n\\nThe `Strategy` model defines a trading strategy configuration, linking a broker to specific instruments.\\n\\n**Location**: [panel/models.py:104-125]()\\n\\n| Field | Type | Description |\\n|-------|------|-------------|\\n| `broker` | ForeignKey(Broker) | Account executing this strategy |\\n| `name` | CharField(64) | Strategy name |\\n| `instruments` | ManyToManyField(Instrument) | Instruments traded by this strategy |\\n| `force_opens` | ManyToManyField(Instrument) | Instruments to manually open positions |\\n\\n**Key Methods**:\\n- `get_instruments()`: Returns list of all traded instruments\\n- `get_force_opens()`: Returns list of manually opened instruments\\n\\n**Relationships**:\\n- Belongs to: `Broker`\\n- Has many: `Signal`, `Order`, `Trade`, `Param`\\n- Many-to-many: `Instrument` (via `instruments` and `force_opens`)\\n\\n**Sources**: [panel/models.py:104-125]()\\n\\n### Param\\n\\nThe `Param` model stores configurable parameters for strategies (e.g., ATR period, risk multipliers).\\n\\n**Location**: [panel/models.py:128-143]()\\n\\n| Field | Type | Description |\\n|-------|------|-------------|\\n| `strategy` | ForeignKey(Strategy) | Strategy this parameter belongs to |\\n| `code` | CharField(64) | Parameter name/key |\\n| `str_value` | CharField(128) | String value (nullable) |\\n| `int_value` | IntegerField | Integer value (nullable) |\\n| `float_value` | DecimalField(12,3) | Decimal value (nullable) |\\n| `update_time` | DateTimeField | Auto-updated on save |\\n\\n**Note**: Only one of `str_value`, `int_value`, or `float_value` should be populated per parameter.\\n\\n**Sources**: [panel/models.py:128-143]()\\n\\n## Market Data Models\\n\\n### Instrument\\n\\nThe `Instrument` model stores metadata for futures contracts, including exchange information, contract specifications, and main contract tracking.\\n\\n**Location**: [panel/models.py:146-170]()\\n\\n| Field | Type | Description |\\n|-------|------|-------------|\\n| `exchange` | CharField(8) | Exchange code from [ExchangeType](#panel/const.py:25-31)() (SHFE, DCE, CZCE, CFFEX, INE, GFEX) |\\n| `section` | CharField(48) | Sector classification from [SectionType](#panel/const.py:34-40)() |\\n| `sort` | CharField(48) | Product category from [SortType](#panel/const.py:43-52)() |\\n| `name` | CharField(32) | Chinese name (e.g., \\\"\\\") |\\n| `product_code` | CharField(16) | Unique product code (e.g., \\\"rb\\\") |\\n| `all_inst` | CharField(256) | Comma-separated list of active contracts |\\n| `main_code` | CharField(16) | Current main contract code (e.g., \\\"rb2405\\\") |\\n| `last_main` | CharField(16) | Previous main contract code |\\n| `change_time` | DateTimeField | Timestamp of last main contract switch |\\n| `night_trade` | BooleanField | Whether instrument trades in night session |\\n| `volume_multiple` | IntegerField | Contract multiplier (e.g., 10 tons per lot) |\\n| `price_tick` | DecimalField(8,3) | Minimum price increment |\\n| `margin_rate` | DecimalField(6,5) | Margin requirement as decimal (e.g., 0.08 = 8%) |\\n| `fee_money` | DecimalField(7,6) | Commission as percentage of value |\\n| `fee_volume` | DecimalField(6,2) | Fixed commission per lot |\\n| `up_limit_ratio` | DecimalField(3,2) | Daily price limit up ratio |\\n| `down_limit_ratio` | DecimalField(3,2) | Daily price limit down ratio |\\n\\n**Key Fields**:\\n- `product_code` is a unique identifier (e.g., \\\"rb\\\" for )\\n- `main_code` is updated by `calc_main_inst()` in [trader/utils/__init__.py]()\\n- `change_time` tracks when main contract switches occur (rollover)\\n\\n**Relationships**:\\n- Many-to-many with: `Strategy`\\n- Has many: `Signal`, `Order`, `Trade`\\n\\n**Sources**: [panel/models.py:146-170](), [panel/const.py:25-52]()\\n\\n### DailyBar\\n\\nThe `DailyBar` model stores daily OHLC data for individual futures contracts.\\n\\n**Location**: [panel/models.py:216-234]()\\n\\n| Field | Type | Description |\\n|-------|------|-------------|\\n| `exchange` | CharField(8) | Exchange code from [ExchangeType](#panel/const.py:25-31)() |\\n| `code` | CharField(16) | Specific contract code (e.g., \\\"rb2405\\\") - indexed |\\n| `expire_date` | IntegerField | Contract expiration date (YYYYMMDD format) |\\n| `time` | DateField | Trading date - indexed |\\n| `open` | DecimalField(12,3) | Opening price |\\n| `high` | DecimalField(12,3) | Highest price |\\n| `low` | DecimalField(12,3) | Lowest price |\\n| `close` | DecimalField(12,3) | Closing price |\\n| `settlement` | DecimalField(12,3) | Settlement price |\\n| `volume` | IntegerField | Trading volume (number of lots) |\\n| `open_interest` | DecimalField(12,3) | Open interest () |\\n\\n**Data Source**: Populated by `update_from_shfe()`, `update_from_dce()`, etc. in [trader/utils/__init__.py]()\\n\\n**Indexes**: Compound index on (`code`, `time`) for efficient queries\\n\\n**Sources**: [panel/models.py:216-234]()\\n\\n### MainBar\\n\\nThe `MainBar` model stores continuous OHLC data for main contracts, with rollover adjustments applied.\\n\\n**Location**: [panel/models.py:194-213]()\\n\\n| Field | Type | Description |\\n|-------|------|-------------|\\n| `exchange` | CharField(8) | Exchange code from [ExchangeType](#panel/const.py:25-31)() |\\n| `product_code` | CharField(8) | Product identifier (e.g., \\\"rb\\\") - indexed |\\n| `code` | CharField(16) | Actual contract code at this time (e.g., \\\"rb2405\\\") |\\n| `time` | DateField | Trading date - indexed |\\n| `open` | DecimalField(12,3) | Opening price (rollover-adjusted) |\\n| `high` | DecimalField(12,3) | Highest price (rollover-adjusted) |\\n| `low` | DecimalField(12,3) | Lowest price (rollover-adjusted) |\\n| `close` | DecimalField(12,3) | Closing price (rollover-adjusted) |\\n| `settlement` | DecimalField(12,3) | Settlement price (rollover-adjusted) |\\n| `volume` | IntegerField | Trading volume |\\n| `open_interest` | DecimalField(12,3) | Open interest |\\n| `basis` | DecimalField(12,3) | Basis (spot vs futures spread) |\\n\\n**Key Differences from DailyBar**:\\n- `MainBar` represents a continuous time series using only main contracts\\n- Prices are adjusted during rollover to create a continuous series\\n- Used for technical indicator calculation and backtesting\\n- Generated by `calc_main_inst()` in [trader/utils/__init__.py]()\\n\\n**Sources**: [panel/models.py:194-213]()\\n\\n## Trading Execution Models\\n\\n### Signal\\n\\nThe `Signal` model represents trading signals generated by strategy logic, ready to be executed as orders.\\n\\n**Location**: [panel/models.py:173-191]()\\n\\n| Field | Type | Description |\\n|-------|------|-------------|\\n| `strategy` | ForeignKey(Strategy) | Strategy that generated this signal |\\n| `instrument` | ForeignKey(Instrument) | Target instrument |\\n| `code` | CharField(16) | Specific contract code (may differ from instrument.main_code) |\\n| `type` | CharField(16) | Signal type from [SignalType](#panel/const.py:165-171)() |\\n| `trigger_value` | DecimalField(12,3) | Technical indicator value that triggered signal |\\n| `price` | DecimalField(12,3) | Suggested execution price |\\n| `volume` | IntegerField | Number of lots to trade |\\n| `trigger_time` | DateTimeField | When signal was generated |\\n| `priority` | IntegerField | Execution priority from [PriorityType](#panel/const.py:174-177)() |\\n| `processed` | BooleanField | Whether signal has been executed (default: False) |\\n\\n**Signal Types** (from [panel/const.py:165-171]()):\\n\\n| Type | Description | Usage |\\n|------|-------------|-------|\\n| `ROLL_CLOSE` | Close old contract during rollover | Executed first during rollover |\\n| `ROLL_OPEN` | Open new contract during rollover | Executed after ROLL_CLOSE |\\n| `BUY` | Buy to open long position | Standard long entry |\\n| `SELL_SHORT` | Sell to open short position | Standard short entry |\\n| `SELL` | Sell to close long position | Long exit |\\n| `BUY_COVER` | Buy to close short position | Short exit |\\n\\n**Workflow**:\\n1. Generated by `calc_signal()` or `calc_history_signal()` in [trader/utils/__init__.py]()\\n2. Stored with `processed=False`\\n3. Processed by `processing_signal1/2/3()` in TradeStrategy at 08:55, 09:25, 20:55\\n4. Converted to `Order` and sent to CTP\\n5. Marked `processed=True` after order is confirmed\\n\\n**Sources**: [panel/models.py:173-191](), [panel/const.py:165-177]()\\n\\n### Order\\n\\nThe `Order` model tracks orders sent to the CTP trading platform.\\n\\n**Location**: [panel/models.py:237-259]()\\n\\n| Field | Type | Description |\\n|-------|------|-------------|\\n| `broker` | ForeignKey(Broker) | Account placing this order |\\n| `strategy` | ForeignKey(Strategy) | Strategy controlling this order (nullable) |\\n| `order_ref` | CharField(13) | Unique order reference ID |\\n| `instrument` | ForeignKey(Instrument) | Instrument being traded |\\n| `code` | CharField(16) | Specific contract code |\\n| `front` | IntegerField | CTP front-end server ID |\\n| `session` | IntegerField | CTP session ID |\\n| `price` | DecimalField(12,3) | Order price |\\n| `volume` | IntegerField | Order volume (lots) |\\n| `direction` | CharField(8) | LONG or SHORT from [DirectionType](#panel/const.py:65-67)() |\\n| `offset_flag` | CharField(8) | Open/Close flag from [OffsetFlag](#panel/const.py:80-87)() |\\n| `status` | CharField(16) | Order status from [OrderStatus](#panel/const.py:90-99)() |\\n| `send_time` | DateTimeField | When order was sent to CTP |\\n| `update_time` | DateTimeField | Last status update time |\\n| `signal` | OneToOneField(Signal) | Signal that triggered this order (nullable) |\\n\\n**Order Status Flow** (from [panel/const.py:90-99]()):\\n\\n```mermaid\\nstateDiagram-v2\\n    [*] --\\u003e NoTradeQueueing: \\\"Order Sent\\\"\\n    NoTradeQueueing --\\u003e PartTradedQueueing: \\\"Partial Fill\\\"\\n    NoTradeQueueing --\\u003e AllTraded: \\\"Complete Fill\\\"\\n    NoTradeQueueing --\\u003e Canceled: \\\"User Cancel\\\"\\n    PartTradedQueueing --\\u003e AllTraded: \\\"Complete Fill\\\"\\n    PartTradedQueueing --\\u003e PartTradedNotQueueing: \\\"Partial Fill Rejected\\\"\\n    PartTradedQueueing --\\u003e Canceled: \\\"User Cancel\\\"\\n    AllTraded --\\u003e [*]\\n    Canceled --\\u003e [*]\\n```\\n\\n**Diagram: Order Status State Machine**\\n\\n**Direction and Offset Combinations**:\\n\\n| Direction | Offset Flag | Meaning |\\n|-----------|-------------|---------|\\n| LONG | Open | Buy to open long position |\\n| LONG | Close | Buy to close short position (cover) |\\n| SHORT | Open | Sell to open short position |\\n| SHORT | Close | Sell to close long position |\\n| * | CloseToday | Close today's position (exchange-specific) |\\n| * | CloseYesterday | Close yesterday's position (exchange-specific) |\\n\\n**Sources**: [panel/models.py:237-259](), [panel/const.py:65-99]()\\n\\n### Trade\\n\\nThe `Trade` model represents an open or closed position, tracking P\\u0026L and linking open/close orders.\\n\\n**Location**: [panel/models.py:262-288]()\\n\\n| Field | Type | Description |\\n|-------|------|-------------|\\n| `broker` | ForeignKey(Broker) | Account holding this position |\\n| `strategy` | ForeignKey(Strategy) | Strategy managing this position (nullable) |\\n| `instrument` | ForeignKey(Instrument) | Instrument being traded |\\n| `open_order` | OneToOneField(Order) | Order that opened this position |\\n| `close_order` | OneToOneField(Order) | Order that closed this position (nullable) |\\n| `code` | CharField(16) | Contract code |\\n| `direction` | CharField(8) | LONG or SHORT from [DirectionType](#panel/const.py:65-67)() |\\n| `open_time` | DateTimeField | When position was opened |\\n| `close_time` | DateTimeField | When position was closed (nullable) |\\n| `shares` | IntegerField | Total position size (lots) |\\n| `filled_shares` | IntegerField | Number of lots filled |\\n| `closed_shares` | IntegerField | Number of lots closed |\\n| `avg_entry_price` | DecimalField(12,3) | Average opening price |\\n| `avg_exit_price` | DecimalField(12,3) | Average closing price |\\n| `profit` | DecimalField(12,3) | Position P\\u0026L (unrealized or realized) |\\n| `frozen_margin` | DecimalField(12,3) | Margin locked for this position |\\n| `cost` | DecimalField(12,2) | Total commission paid |\\n\\n**P\\u0026L Calculation**:\\n- For long positions: `profit = (current_price - avg_entry_price) * shares * volume_multiple`\\n- For short positions: `profit = (avg_entry_price - current_price) * shares * volume_multiple`\\n- Updated by `refresh_all()` in TradeStrategy at market close (15:20)\\n\\n**Position Lifecycle**:\\n1. `Trade` created when `open_order` is filled\\n2. `filled_shares` updated as order fills\\n3. `close_order` assigned when exit signal triggers\\n4. `closed_shares` updated as close order fills\\n5. `close_time` set when fully closed\\n6. Final `profit` calculated including commission\\n\\n**Sources**: [panel/models.py:262-288]()\\n\\n## Performance Tracking Models\\n\\n### Performance\\n\\nThe `Performance` model stores daily snapshots of account equity and NAV (Net Asset Value).\\n\\n**Location**: [panel/models.py:85-101]()\\n\\n| Field | Type | Description |\\n|-------|------|-------------|\\n| `broker` | ForeignKey(Broker) | Account being tracked |\\n| `day` | DateField | Performance snapshot date |\\n| `capital` | DecimalField(12,2) | Total capital (cash + positions) |\\n| `unit_count` | IntegerField | Number of units (for fund accounting) |\\n| `NAV` | DecimalField(8,3) | Net Asset Value per unit |\\n| `accumulated` | DecimalField(8,3) | Accumulated NAV (includes distributions) |\\n| `dividend` | DecimalField(12,2) | Dividends distributed |\\n| `used_margin` | DecimalField(12,2) | Total margin in use |\\n| `fake` | DecimalField(12,2) | Virtual capital component |\\n\\n**NAV Calculation**:\\n```\\nNAV = capital / unit_count\\naccumulated = NAV + (total_dividends / unit_count)\\n```\\n\\n**Update Schedule**: Created/updated by `calc_performance()` at 15:20 daily\\n\\n**Sources**: [panel/models.py:85-101]()\\n\\n### Autonumber\\n\\nThe `Autonumber` model provides a simple auto-incrementing ID generator for system use.\\n\\n**Location**: [panel/models.py:42-44]()\\n\\n| Field | Type | Description |\\n|-------|------|-------------|\\n| `id` | AutoField | Auto-incrementing primary key |\\n| `create_date` | DateTimeField | Creation timestamp (auto-set) |\\n\\n**Usage**: Can be used to generate unique sequence numbers for orders or other entities requiring sequential IDs.\\n\\n**Sources**: [panel/models.py:42-44]()\\n\\n## Model Workflow Integration\\n\\n```mermaid\\nsequenceDiagram\\n    participant Exchange as \\\"Exchange APIs\\\"\\n    participant DailyBar as \\\"DailyBar Model\\\"\\n    participant MainBar as \\\"MainBar Model\\\"\\n    participant Instrument as \\\"Instrument Model\\\"\\n    participant Strategy as \\\"Strategy Model\\\"\\n    participant Signal as \\\"Signal Model\\\"\\n    participant Order as \\\"Order Model\\\"\\n    participant Trade as \\\"Trade Model\\\"\\n    participant Broker as \\\"Broker Model\\\"\\n    participant Performance as \\\"Performance Model\\\"\\n    \\n    Note over Exchange,DailyBar: Daily Data Collection (17:00)\\n    Exchange-\\u003e\\u003eDailyBar: \\\"update_from_shfe/dce/czce/cffex/gfex()\\\"\\n    DailyBar-\\u003e\\u003eMainBar: \\\"calc_main_inst()\\\"\\n    DailyBar-\\u003e\\u003eInstrument: \\\"Update main_code\\\"\\n    \\n    Note over MainBar,Signal: Signal Generation (17:00)\\n    MainBar-\\u003e\\u003eStrategy: \\\"calc_signal()\\\"\\n    Strategy-\\u003e\\u003eSignal: \\\"Create Signal records\\u003cbr/\\u003eprocessed=False\\\"\\n    \\n    Note over Signal,Order: Pre-Market Processing (08:55, 09:25, 20:55)\\n    Strategy-\\u003e\\u003eSignal: \\\"Query unprocessed signals\\\"\\n    Signal-\\u003e\\u003eOrder: \\\"ReqOrderInsert()\\u003cbr/\\u003eCreate Order\\\"\\n    Order--\\u003e\\u003eTrade: \\\"OnRtnTrade: Update Trade\\\"\\n    Order--\\u003e\\u003eSignal: \\\"Mark processed=True\\\"\\n    \\n    Note over Broker,Performance: Market Close (15:20)\\n    Strategy-\\u003e\\u003eBroker: \\\"refresh_all()\\u003cbr/\\u003eQuery CTP account\\\"\\n    Strategy-\\u003e\\u003eTrade: \\\"Query positions\\u003cbr/\\u003eUpdate profit\\\"\\n    Broker-\\u003e\\u003ePerformance: \\\"calc_performance()\\u003cbr/\\u003eCreate daily snapshot\\\"\\n```\\n\\n**Diagram: Data Flow Through Models During Daily Trading Cycle**\\n\\n**Sources**: [panel/models.py:1-289](), [trader/utils/__init__.py]()\\n\\n## Utility Function Reference\\n\\nThe `to_df()` function in [panel/models.py:25-39]() provides a convenient way to convert Django QuerySets to pandas DataFrames:\\n\\n```python\\ndef to_df(queryset, index_col=None, parse_dates=None)\\n```\\n\\n**Parameters**:\\n- `queryset`: Django QuerySet to convert\\n- `index_col`: Column(s) to use as DataFrame index\\n- `parse_dates`: Columns to parse as datetime objects\\n\\n**Usage Example**:\\n```python\\n# Convert MainBar queryset to DataFrame for technical analysis\\nbars = MainBar.objects.filter(product_code='rb').order_by('time')\\ndf = to_df(bars, index_col='time', parse_dates=['time'])\\n```\\n\\n**Sources**: [panel/models.py:25-39]()\\n\\n## Constants and Enumerations\\n\\nAll models use enumerations defined in [panel/const.py:1-178]() for type-safe field choices. Key enumerations:\\n\\n| Enumeration | Location | Used By | Values |\\n|-------------|----------|---------|--------|\\n| `ContractType` | [panel/const.py:19-22]() | Broker.contract_type | STOCK, FUTURE, OPTION |\\n| `ExchangeType` | [panel/const.py:25-31]() | Instrument.exchange, DailyBar.exchange, MainBar.exchange | SHFE, DCE, CZCE, CFFEX, INE, GFEX |\\n| `SectionType` | [panel/const.py:34-40]() | Instrument.section | Stock, Bond, Metal, Agricultural, EnergyChemical, BlackMaterial |\\n| `SortType` | [panel/const.py:43-52]() | Instrument.sort | Stock, Bond, Rare, Metal, EdibleOil, Feed, Cotton, EnergyChemical, BlackMaterial |\\n| `DirectionType` | [panel/const.py:65-67]() | Order.direction, Trade.direction | LONG (0), SHORT (1) |\\n| `OffsetFlag` | [panel/const.py:80-87]() | Order.offset_flag | Open, Close, ForceClose, CloseToday, CloseYesterday, ForceOff, LocalForceClose |\\n| `OrderStatus` | [panel/const.py:90-99]() | Order.status | AllTraded, PartTradedQueueing, NoTradeQueueing, Canceled, etc. |\\n| `SignalType` | [panel/const.py:165-171]() | Signal.type | ROLL_CLOSE, ROLL_OPEN, BUY, SELL_SHORT, SELL, BUY_COVER |\\n| `PriorityType` | [panel/const.py:174-177]() | Signal.priority | LOW (0), Normal (1), High (2) |\\n\\n**Sources**: [panel/const.py:1-178]()\\n\\n## Database Indexes and Performance\\n\\nKey indexes for query optimization:\\n\\n| Model | Indexed Fields | Purpose |\\n|-------|----------------|---------|\\n| `DailyBar` | `code`, `time` | Fast queries by contract and date range |\\n| `MainBar` | `product_code`, `time` | Fast queries for continuous series |\\n| `Instrument` | `product_code` (unique) | Quick lookup by product code |\\n\\nAll primary keys (`id`) are automatically indexed by Django. Foreign key fields are also automatically indexed for join performance.\\n\\n**Sources**: [panel/models.py:1-289]()\"])</script><script>self.__next_f.push([1,\"29:T45f5,\"])</script><script>self.__next_f.push([1,\"# Exchange Data Acquisition\\n\\n\\u003cdetails\\u003e\\n\\u003csummary\\u003eRelevant source files\\u003c/summary\\u003e\\n\\nThe following files were used as context for generating this wiki page:\\n\\n- [test/test_api.py](test/test_api.py)\\n- [trader/utils/__init__.py](trader/utils/__init__.py)\\n- [trader/utils/fetch_data.py](trader/utils/fetch_data.py)\\n\\n\\u003c/details\\u003e\\n\\n\\n\\n## Purpose and Scope\\n\\nThis document describes the system's data acquisition layer, which fetches daily market data from five Chinese commodity exchanges and persists it to the database. The data includes OHLC (Open, High, Low, Close) prices, settlement prices, trading volume, and open interest for individual futures contracts.\\n\\nThis page focuses on the HTTP-based data fetching mechanisms. For information about:\\n- How main contracts are calculated from this data, see [Main Contract Calculation](#5.3)\\n- The database models that store this data, see [Data Models](#5.1)\\n- How trading strategies use this data, see [Trading Strategy System](#4)\\n- The scheduled task that triggers daily data updates, see [Scheduled Tasks](#4.6)\\n\\n---\\n\\n## System Overview\\n\\nThe data acquisition system fetches daily market data asynchronously from five exchanges using HTTP/HTTPS requests. Each exchange provides data in different formats and requires different parsing strategies:\\n\\n| Exchange | Data Format | HTTP Method | Function | Lines |\\n|----------|-------------|-------------|----------|-------|\\n| SHFE (Shanghai) | JSON | GET | `update_from_shfe()` | [trader/utils/__init__.py:121-174]() |\\n| DCE (Dalian) | TXT (tab-separated) | POST | `update_from_dce()` | [trader/utils/__init__.py:220-265]() |\\n| CZCE (Zhengzhou) | TXT (pipe/comma-separated) | GET | `update_from_czce()` | [trader/utils/__init__.py:177-217]() |\\n| CFFEX (Financial) | XML | GET | `update_from_cffex()` | [trader/utils/__init__.py:296-349]() |\\n| GFEX (Guangzhou) | JSON | POST | `update_from_gfex()` | [trader/utils/__init__.py:268-293]() |\\n\\nAll data is persisted to the `DailyBar` model, which represents daily price bars for individual futures contracts.\\n\\n**Sources:** [trader/utils/__init__.py:121-349]()\\n\\n---\\n\\n## Data Acquisition Architecture\\n\\n```mermaid\\ngraph TB\\n    subgraph \\\"Orchestration Layer\\\"\\n        FetchData[\\\"fetch_bar()\\u003cbr/\\u003etrader/utils/fetch_data.py\\\"]\\n        CheckDay[\\\"check_trading_day()\\u003cbr/\\u003eVerify trading day\\\"]\\n    end\\n    \\n    subgraph \\\"Exchange Data Sources\\\"\\n        SHFE[\\\"SHFE\\u003cbr/\\u003ewww.shfe.com.cn\\u003cbr/\\u003eJSON format\\\"]\\n        DCE[\\\"DCE\\u003cbr/\\u003ewww.dce.com.cn\\u003cbr/\\u003eTXT format\\\"]\\n        CZCE[\\\"CZCE\\u003cbr/\\u003ewww.czce.com.cn\\u003cbr/\\u003eTXT format\\\"]\\n        CFFEX[\\\"CFFEX\\u003cbr/\\u003ewww.cffex.com.cn\\u003cbr/\\u003eXML format\\\"]\\n        GFEX[\\\"GFEX\\u003cbr/\\u003ewww.gfex.com.cn\\u003cbr/\\u003eJSON format\\\"]\\n    end\\n    \\n    subgraph \\\"Data Fetchers\\\"\\n        UpdateSHFE[\\\"update_from_shfe()\\u003cbr/\\u003eSemaphore: 15\\\"]\\n        UpdateDCE[\\\"update_from_dce()\\u003cbr/\\u003eSemaphore: 5\\\"]\\n        UpdateCZCE[\\\"update_from_czce()\\u003cbr/\\u003eSemaphore: 15\\\"]\\n        UpdateCFFEX[\\\"update_from_cffex()\\u003cbr/\\u003eSemaphore: 15\\\"]\\n        UpdateGFEX[\\\"update_from_gfex()\\u003cbr/\\u003eSemaphore: 5\\\"]\\n    end\\n    \\n    subgraph \\\"Data Storage\\\"\\n        DailyBar[(\\\"DailyBar Model\\u003cbr/\\u003eDjango ORM\\\")]\\n        MySQL[(\\\"MySQL Database\\\")]\\n    end\\n    \\n    FetchData --\\u003e|\\\"Async tasks\\\"| CheckDay\\n    CheckDay --\\u003e|\\\"If trading day\\\"| UpdateSHFE\\n    CheckDay --\\u003e|\\\"If trading day\\\"| UpdateDCE\\n    CheckDay --\\u003e|\\\"If trading day\\\"| UpdateCZCE\\n    CheckDay --\\u003e|\\\"If trading day\\\"| UpdateCFFEX\\n    CheckDay --\\u003e|\\\"If trading day\\\"| UpdateGFEX\\n    \\n    SHFE -.-\\u003e|\\\"HTTP GET\\\"| UpdateSHFE\\n    DCE -.-\\u003e|\\\"HTTP POST\\\"| UpdateDCE\\n    CZCE -.-\\u003e|\\\"HTTP GET\\\"| UpdateCZCE\\n    CFFEX -.-\\u003e|\\\"HTTP GET\\\"| UpdateCFFEX\\n    GFEX -.-\\u003e|\\\"HTTP POST\\\"| UpdateGFEX\\n    \\n    UpdateSHFE --\\u003e DailyBar\\n    UpdateDCE --\\u003e DailyBar\\n    UpdateCZCE --\\u003e DailyBar\\n    UpdateCFFEX --\\u003e DailyBar\\n    UpdateGFEX --\\u003e DailyBar\\n    \\n    DailyBar --\\u003e MySQL\\n```\\n\\n**Sources:** [trader/utils/fetch_data.py:24-64](), [trader/utils/__init__.py:42-52]()\\n\\n---\\n\\n## Connection Management\\n\\nThe system uses `asyncio.Semaphore` objects to limit concurrent connections to each exchange, preventing server overload and rate limiting:\\n\\n```python\\nmax_conn_shfe = asyncio.Semaphore(15)\\nmax_conn_dce = asyncio.Semaphore(5)\\nmax_conn_gfex = asyncio.Semaphore(5)\\nmax_conn_czce = asyncio.Semaphore(15)\\nmax_conn_cffex = asyncio.Semaphore(15)\\n```\\n\\nThe connection limits are configured based on each exchange's server capacity and responsiveness. Before making HTTP requests, functions acquire the semaphore and release it after receiving the response.\\n\\n**Sources:** [trader/utils/__init__.py:42-46]()\\n\\n---\\n\\n## Exchange-Specific Implementations\\n\\n### SHFE (Shanghai Futures Exchange)\\n\\n**Endpoint:** `http://www.shfe.com.cn/data/tradedata/future/dailydata/kx{YYYYMMDD}.dat`\\n\\n**Data Format:** JSON\\n\\n**Key Fields:**\\n- `PRODUCTGROUPID`: Product code (e.g., \\\"cu\\\", \\\"al\\\")\\n- `PRODUCTNAME`: Chinese name (e.g., \\\"\\\")\\n- `DELIVERYMONTH`: Contract expiry (e.g., \\\"2112\\\")\\n- `OPENPRICE`, `HIGHESTPRICE`, `LOWESTPRICE`, `CLOSEPRICE`: OHLC prices\\n- `SETTLEMENTPRICE`: Daily settlement price\\n- `VOLUME`: Trading volume\\n- `OPENINTEREST`: Open interest\\n\\n**Special Handling:**\\n- INE (International Energy Exchange) contracts (`sc`, `bc`, `nr`, `lu`) are marked with `ExchangeType.INE` instead of `ExchangeType.SHFE`\\n- Contract codes with `_f` suffix are filtered to select futures (not options)\\n- Instrument Chinese names are updated in the database\\n\\n**Implementation:**\\n\\n```mermaid\\nsequenceDiagram\\n    participant Func as update_from_shfe()\\n    participant HTTP as aiohttp Session\\n    participant SHFE as www.shfe.com.cn\\n    participant DB as DailyBar Model\\n    participant Inst as Instrument Model\\n    \\n    Func-\\u003e\\u003eHTTP: Acquire semaphore (max 15)\\n    HTTP-\\u003e\\u003eSHFE: GET /data/tradedata/future/dailydata/kx{date}.dat\\n    SHFE--\\u003e\\u003eHTTP: JSON response\\n    HTTP-\\u003e\\u003eFunc: Release semaphore\\n    \\n    loop For each contract in JSON\\n        Func-\\u003e\\u003eFunc: Parse PRODUCTGROUPID, DELIVERYMONTH\\n        Func-\\u003e\\u003eFunc: Check if in IGNORE_INST_LIST\\n        Func-\\u003e\\u003eFunc: Determine exchange (SHFE vs INE)\\n        Func-\\u003e\\u003eDB: update_or_create(code, exchange, time)\\n        Func-\\u003e\\u003eFunc: Store name in dict\\n    end\\n    \\n    loop For each product code\\n        Func-\\u003e\\u003eInst: Update Chinese name\\n    end\\n```\\n\\n**Sources:** [trader/utils/__init__.py:121-174]()\\n\\n---\\n\\n### DCE (Dalian Commodity Exchange)\\n\\n**Endpoint:** `http://www.dce.com.cn/publicweb/quotesdata/exportDayQuotesChData.html`\\n\\n**Data Format:** Tab-separated TXT\\n\\n**HTTP Method:** POST with form data:\\n- `dayQuotes.variety`: \\\"all\\\"\\n- `dayQuotes.trade_type`: 0\\n- `exportFlag`: \\\"txt\\\"\\n- `year`, `month`, `day`: Date components\\n\\n**Key Fields:** (Tab-separated, starting from line 3)\\n```\\n[, , , , , , , , , 1, , , , ]\\n```\\n\\n**Special Handling:**\\n- Uses `DCE_NAME_CODE` dictionary to map Chinese names to product codes\\n- Removes product code prefix from contract month (e.g., \\\"a1611\\\"  \\\"1611\\\")\\n- Handles missing data with \\\"-\\\" character by substituting close price\\n\\n**Sources:** [trader/utils/__init__.py:220-265]()\\n\\n---\\n\\n### CZCE (Zhengzhou Commodity Exchange)\\n\\n**Endpoint:** `http://www.czce.com.cn/cn/DFSStaticFiles/Future/{YYYY}/{YYYYMMDD}/FutureDataDaily.txt`\\n\\n**Data Format:** Pipe-separated or comma-separated TXT\\n\\n**Key Fields:**\\n```\\n[, , , , , , , 1, 2, (), , , (), ]\\n```\\n\\n**Special Handling:**\\n- Automatically detects delimiter (pipe `|` or comma `,`)\\n- Extracts product code using regex `[A-Za-z]+`\\n- Calculates `expire_date` using `get_expire_date()` helper function\\n- Removes commas from numeric strings (e.g., \\\"11,970.00\\\"  \\\"11970.00\\\")\\n- Uses close price if settlement is zero\\n\\n**Sources:** [trader/utils/__init__.py:177-217]()\\n\\n---\\n\\n### CFFEX (China Financial Futures Exchange)\\n\\n**Endpoint:** `http://www.cffex.com.cn/sj/hqsj/rtj/{YYYY}{MM}/{DD}/index.xml?id=7`\\n\\n**Data Format:** XML\\n\\n**Key Fields:**\\n```xml\\n\\u003cdailydata\\u003e\\n    \\u003cinstrumentid\\u003eIC2112\\u003c/instrumentid\\u003e\\n    \\u003ctradingday\\u003e20211209\\u003c/tradingday\\u003e\\n    \\u003copenprice\\u003e7272\\u003c/openprice\\u003e\\n    \\u003chighestprice\\u003e7330\\u003c/highestprice\\u003e\\n    \\u003clowestprice\\u003e7264.4\\u003c/lowestprice\\u003e\\n    \\u003ccloseprice\\u003e7302.4\\u003c/closeprice\\u003e\\n    \\u003csettlementprice\\u003e7314.2\\u003c/settlementprice\\u003e\\n    \\u003cvolume\\u003e51752\\u003c/volume\\u003e\\n    \\u003copeninterest\\u003e101956\\u003c/openinterest\\u003e\\n    \\u003cproductid\\u003eIC\\u003c/productid\\u003e\\n    \\u003cexpiredate\\u003e20211217\\u003c/expiredate\\u003e\\n\\u003c/dailydata\\u003e\\n```\\n\\n**Special Handling:**\\n- Parses XML using `xml.etree.ElementTree`\\n- Filters out option contracts (instrument ID length \\u003e 6)\\n- Extracts 4-digit expire date from 8-digit date (e.g., \\\"20211217\\\"  \\\"1217\\\")\\n\\n**Sources:** [trader/utils/__init__.py:296-349]()\\n\\n---\\n\\n### GFEX (Guangzhou Futures Exchange)\\n\\n**Endpoint:** `http://www.gfex.com.cn/gfexweb/Quote/getQuote_ftr`\\n\\n**Data Format:** JSON\\n\\n**HTTP Method:** POST with form data:\\n- `varietyid`: Product ID (\\\"lc\\\" or \\\"si\\\")\\n\\n**Key Fields:**\\n```json\\n{\\n  \\\"contractQuote\\\": {\\n    \\\"lc2201\\\": {\\n      \\\"openPrice\\\": \\\"...\\\",\\n      \\\"highPrice\\\": \\\"...\\\",\\n      \\\"lowPrice\\\": \\\"...\\\",\\n      \\\"closePrice\\\": \\\"...\\\",\\n      \\\"clearPrice\\\": \\\"...\\\",\\n      \\\"matchTotQty\\\": \\\"...\\\",\\n      \\\"openInterest\\\": \\\"...\\\"\\n    }\\n  }\\n}\\n```\\n\\n**Special Handling:**\\n- Iterates through product IDs (\\\"lc\\\", \\\"si\\\")\\n- Handles missing data with \\\"--\\\" string by substituting close price\\n- Removes product code prefix to get expire date\\n\\n**Sources:** [trader/utils/__init__.py:268-293]()\\n\\n---\\n\\n## Trading Day Verification\\n\\nBefore fetching data, the system verifies whether a given date is a trading day:\\n\\n### check_trading_day()\\n\\n**Purpose:** Determines if a date was a trading day by attempting to fetch CFFEX data\\n\\n**Implementation:**\\n1. Constructs URL: `http://www.cffex.com.cn/fzjy/mrhq/{YYYY}{MM}/{DD}/index.xml`\\n2. Issues GET request with `allow_redirects=False`\\n3. Returns `True` if HTTP status is 200, `False` otherwise\\n\\nThis leverages the fact that CFFEX only publishes data for actual trading days.\\n\\n### is_trading_day()\\n\\n**Purpose:** Checks if a date is a trading day using Redis cache\\n\\n**Implementation:**\\n1. Connects to Redis\\n2. Checks if date string (`YYYYMMDD`) matches `TradingDay` or `LastTradingDay` keys\\n3. Returns boolean result\\n\\nThis is faster than HTTP checks and used during live trading.\\n\\n**Sources:** [trader/utils/__init__.py:94-108]()\\n\\n---\\n\\n## Contract Trading Parameters\\n\\nThe `get_contracts_argument()` function fetches additional trading parameters for each contract, including margin ratios and price limit ratios:\\n\\n```mermaid\\ngraph LR\\n    subgraph \\\"Data Sources\\\"\\n        SHFE_ARG[\\\"SHFE\\u003cbr/\\u003eContractDailyTradeArgument\\\"]\\n        DCE_ARG[\\\"DCE\\u003cbr/\\u003eexportDayTradPara.html\\\"]\\n        CZCE_ARG[\\\"CZCE\\u003cbr/\\u003eFutureDataClearParams.txt\\\"]\\n        CFFEX_ARG[\\\"CFFEX\\u003cbr/\\u003eindex.xml\\\"]\\n    end\\n    \\n    subgraph \\\"Processing\\\"\\n        GetArg[\\\"get_contracts_argument()\\\"]\\n        Redis[(\\\"Redis Cache\\u003cbr/\\u003eLIMITRATIO:{ex}:{code}:{inst}\\\")]\\n    end\\n    \\n    subgraph \\\"Database\\\"\\n        Instrument[(\\\"Instrument Model\\u003cbr/\\u003eup_limit_ratio\\u003cbr/\\u003edown_limit_ratio\\\")]\\n    end\\n    \\n    SHFE_ARG --\\u003e GetArg\\n    DCE_ARG --\\u003e GetArg\\n    CZCE_ARG --\\u003e GetArg\\n    CFFEX_ARG --\\u003e GetArg\\n    \\n    GetArg --\\u003e Redis\\n    Redis --\\u003e Instrument\\n```\\n\\n**Key Ratios Extracted:**\\n\\n| Exchange | Source Field | Ratio Type |\\n|----------|--------------|------------|\\n| SHFE | `UPPER_VALUE` / `LOWER_VALUE` | Price limit percentage |\\n| DCE | `` | Price limit percentage |\\n| CZCE | `(%)` | Price limit percentage (requires parsing `9` format) |\\n| CFFEX | `UPPER_VALUE` / `LOWER_VALUE` | Price limit percentage |\\n\\nThe function stores ratios in Redis with keys like `LIMITRATIO:SHFE:cu:cu2201`, then updates the `Instrument` model with `up_limit_ratio` and `down_limit_ratio` fields.\\n\\n**Sources:** [trader/utils/__init__.py:685-796]()\\n\\n---\\n\\n## Data Orchestration\\n\\n### fetch_bar() Function Flow\\n\\nThe `fetch_bar()` function in `trader/utils/fetch_data.py` orchestrates the complete data fetching process:\\n\\n```mermaid\\nflowchart TD\\n    Start[\\\"fetch_bar()\\\"] --\\u003e DateRange[\\\"Generate date range\\u003cbr/\\u003e(day_end - 365 days to day_end)\\\"]\\n    DateRange --\\u003e CheckTasks[\\\"Create check_trading_day() tasks\\u003cbr/\\u003efor each date\\\"]\\n    CheckTasks --\\u003e AwaitChecks[\\\"Await all checks\\u003cbr/\\u003ewith progress bar (tqdm)\\\"]\\n    AwaitChecks --\\u003e FilterDays[\\\"Filter trading days\\\"]\\n    FilterDays --\\u003e CreateFetch[\\\"Create update_from_*() tasks\\u003cbr/\\u003efor each trading day\\\"]\\n    \\n    CreateFetch --\\u003e FetchSHFE[\\\"update_from_shfe()\\\"]\\n    CreateFetch --\\u003e FetchDCE[\\\"update_from_dce()\\\"]\\n    CreateFetch --\\u003e FetchCZCE[\\\"update_from_czce()\\\"]\\n    CreateFetch --\\u003e FetchCFFEX[\\\"update_from_cffex()\\\"]\\n    \\n    FetchSHFE --\\u003e AwaitAll[\\\"Await all fetch tasks\\u003cbr/\\u003ewith progress bar\\\"]\\n    FetchDCE --\\u003e AwaitAll\\n    FetchCZCE --\\u003e AwaitAll\\n    FetchCFFEX --\\u003e AwaitAll\\n    \\n    AwaitAll --\\u003e Complete[\\\"Complete\\\"]\\n```\\n\\n**Execution Pattern:**\\n1. **Phase 1 - Trading Day Check:** Concurrently checks all dates in range (using `check_trading_day()`)\\n2. **Phase 2 - Data Fetching:** For each trading day, creates 4 concurrent fetch tasks (one per exchange)\\n3. **Progress Tracking:** Uses `tqdm` for visual progress bars during both phases\\n\\n**Alternative: fetch_bar2()**\\n\\nA sequential variant exists at [trader/utils/fetch_data.py:49-64]() that processes one day at a time, waiting for all exchanges to complete before moving to the next day. This is more conservative but slower.\\n\\n**Sources:** [trader/utils/fetch_data.py:24-64]()\\n\\n---\\n\\n## Error Handling\\n\\nAll exchange-specific functions follow a consistent error handling pattern:\\n\\n```python\\nasync def update_from_\\u003cexchange\\u003e(day: datetime.datetime) -\\u003e bool:\\n    try:\\n        # HTTP request and parsing logic\\n        return True\\n    except Exception as e:\\n        logger.warning(f'update_from_\\u003cexchange\\u003e failed: {repr(e)}', exc_info=True)\\n        return False\\n```\\n\\n**Key Characteristics:**\\n- Returns `bool` to indicate success/failure\\n- Logs warnings with full exception traces\\n- Does not propagate exceptions to orchestration layer\\n- Allows partial success (some exchanges can fail without blocking others)\\n\\nThe orchestration layer can check return values to determine which exchanges succeeded:\\n\\n```python\\nresult = await asyncio.gather(*tasks, return_exceptions=True)\\n# result = [True, True, True, True, True] if all succeeded\\n```\\n\\n**Sources:** [trader/utils/__init__.py:172-174, 215-217, 263-265, 290-293, 347-349]()\\n\\n---\\n\\n## Data Persistence Pattern\\n\\nAll fetchers use Django ORM's `update_or_create()` method to handle duplicate data gracefully:\\n\\n```python\\nDailyBar.objects.update_or_create(\\n    code=\\u003ccontract_code\\u003e,\\n    exchange=\\u003cexchange_enum\\u003e,\\n    time=\\u003cdate\\u003e,\\n    defaults={\\n        'expire_date': \\u003cexpire_date\\u003e,\\n        'open': \\u003copen_price\\u003e,\\n        'high': \\u003chigh_price\\u003e,\\n        'low': \\u003clow_price\\u003e,\\n        'close': \\u003cclose_price\\u003e,\\n        'settlement': \\u003csettlement_price\\u003e,\\n        'volume': \\u003cvolume\\u003e,\\n        'open_interest': \\u003copen_interest\\u003e\\n    }\\n)\\n```\\n\\n**Behavior:**\\n- **Unique Key:** `(code, exchange, time)` combination\\n- **Insert:** Creates new record if key doesn't exist\\n- **Update:** Updates `defaults` fields if key exists\\n- **Atomic:** Single database operation prevents race conditions\\n\\nThis pattern allows re-running data fetches for the same day without creating duplicates, which is useful for:\\n- Recovering from partial failures\\n- Correcting data when exchanges publish revisions\\n- Backfilling historical data\\n\\n**Sources:** [trader/utils/__init__.py:154-167, 199-213, 247-261, 279-289, 330-345]()\\n\\n---\\n\\n## Configuration\\n\\nExchange endpoints are configured as module-level variables:\\n\\n```python\\ncffex_ip = 'www.cffex.com.cn'\\nshfe_ip = 'www.shfe.com.cn'\\nczce_ip = 'www.czce.com.cn'\\ndce_ip = 'www.dce.com.cn'\\ngfex_ip = 'www.gfex.com.cn'\\n```\\n\\nThe `IGNORE_INST_LIST` configuration specifies product codes to skip during data acquisition:\\n\\n```python\\nIGNORE_INST_LIST = config.get('TRADE', 'ignore_inst').split(',')\\n```\\n\\nThis allows filtering out contracts that are:\\n- Not traded by the strategy\\n- Illiquid or inactive\\n- Pending delisting\\n\\n**Sources:** [trader/utils/__init__.py:48-54]()\\n\\n---\\n\\n## Testing\\n\\nThe test suite in `test/test_api.py` provides individual tests for each exchange fetcher:\\n\\n| Test Method | Target Function | Purpose |\\n|-------------|-----------------|---------|\\n| `test_get_shfe_data()` | `update_from_shfe()` | Verify SHFE data fetch |\\n| `test_get_dce_data()` | `update_from_dce()` | Verify DCE data fetch |\\n| `test_get_czce_data()` | `update_from_czce()` | Verify CZCE data fetch |\\n| `test_get_cffex_data()` | `update_from_cffex()` | Verify CFFEX data fetch |\\n| `test_get_contracts_argument()` | `get_contracts_argument()` | Verify trading parameter fetch |\\n| `test_get_all()` | All functions | Verify concurrent execution |\\n\\n**Test Setup:**\\n- Connects to Redis to retrieve `LastTradingDay`\\n- Uses `asynctest.TestCase` for async test support\\n- Tests can be selectively enabled/disabled with `@asynctest.skipIf` decorator\\n\\n**Sources:** [test/test_api.py:34-76]()\\n\\n---\\n\\n## Integration with Main Contract Calculation\\n\\nAfter daily bars are fetched, the system calculates which contract is the \\\"main\\\" (most actively traded) contract for each product. This process is described in detail in [Main Contract Calculation](#5.3).\\n\\nThe relationship between data acquisition and main contract calculation:\\n\\n```mermaid\\ngraph LR\\n    Fetch[\\\"Exchange Data\\u003cbr/\\u003eAcquisition\\\"] --\\u003e DailyBar[(\\\"DailyBar\\u003cbr/\\u003eIndividual Contracts\\\")]\\n    DailyBar --\\u003e CalcMain[\\\"calc_main_inst()\\u003cbr/\\u003eIdentify Main Contract\\\"]\\n    CalcMain --\\u003e MainBar[(\\\"MainBar\\u003cbr/\\u003eContinuous Series\\\")]\\n    MainBar --\\u003e Strategy[\\\"Trading Strategy\\u003cbr/\\u003eSignal Generation\\\"]\\n```\\n\\n**Execution Order:**\\n1. Fetch daily data from all exchanges  `DailyBar` records\\n2. Calculate main contract for each product  Updates `Instrument.main_code`\\n3. Store main contract's bar data  `MainBar` records\\n4. Handle rollover adjustments if main contract changed\\n5. Trading strategies use `MainBar` for continuous price series\\n\\n**Sources:** [trader/utils/__init__.py:381-421]()\"])</script><script>self.__next_f.push([1,\"2a:T3f88,\"])</script><script>self.__next_f.push([1,\"# Main Contract Calculation\\n\\n\\u003cdetails\\u003e\\n\\u003csummary\\u003eRelevant source files\\u003c/summary\\u003e\\n\\nThe following files were used as context for generating this wiki page:\\n\\n- [panel/models.py](panel/models.py)\\n- [trader/utils/__init__.py](trader/utils/__init__.py)\\n\\n\\u003c/details\\u003e\\n\\n\\n\\n## Purpose and Scope\\n\\nThis page documents the algorithm used to identify the \\\"main contract\\\" (most actively traded contract) for each futures instrument and how the system handles contract rollovers to create continuous price series. This is a critical component of the data management system that enables historical backtesting and live trading with seamless contract transitions.\\n\\nFor information about how daily market data is fetched from exchanges, see [Exchange Data Acquisition](#5.2). For details on how technical indicators use the continuous main contract data, see [Technical Analysis](#5.4).\\n\\n## Overview\\n\\nFutures contracts have finite lifespans and expire on predetermined dates. For each underlying commodity (e.g., copper, crude oil), multiple contracts trade simultaneously with different expiration months. The system must:\\n\\n1. **Identify the main contract**: Determine which specific contract (e.g., `cu2401`, `cu2402`) is the most liquid at any given time\\n2. **Create continuous series**: Build a seamless historical price series that transitions smoothly between contracts\\n3. **Handle rollover adjustments**: Apply basis corrections when the main contract changes to prevent artificial price jumps\\n\\nThe main contract typically has the highest trading volume and open interest, making it the most reliable for price discovery and execution.\\n\\n**Sources:** [trader/utils/__init__.py:381-421]()\\n\\n---\\n\\n## Main Contract Selection Algorithm\\n\\nThe system employs a three-tier selection algorithm to identify the main contract, with fallback logic to ensure robustness:\\n\\n### Selection Criteria\\n\\n| Priority | Criteria | Description | Line Reference |\\n|----------|----------|-------------|----------------|\\n| 1 | Volume-based (with liquidity filters) | Highest volume contract where volume  10,000 AND open interest  10,000 (except for CFFEX which has no minimum) | [trader/utils/__init__.py:385-388]() |\\n| 2 | Consecutive 3-day volume leader | If no contract meets criteria 1, select contract with highest volume for 3 consecutive days | [trader/utils/__init__.py:391-395]() |\\n| 3 | Current volume maximum | As final fallback, select contract with highest volume regardless of liquidity thresholds | [trader/utils/__init__.py:397-400]() |\\n\\n### Selection Logic\\n\\n```mermaid\\nflowchart TD\\n    Start[\\\"calc_main_inst(inst, day)\\\"]\\n    GetExpire[\\\"Get current expire_date\\u003cbr/\\u003efrom inst.main_code\\\"]\\n    \\n    Check1[\\\"Query DailyBar:\\u003cbr/\\u003evolume  10,000 AND\\u003cbr/\\u003eopen_interest  10,000\\u003cbr/\\u003eOR exchange == CFFEX\\\"]\\n    HasBar1{check_bar\\u003cbr/\\u003efound?}\\n    \\n    Check2[\\\"Query last 3 days:\\u003cbr/\\u003eSame contract has\\u003cbr/\\u003emax volume all 3 days\\\"]\\n    HasBar2{check_bar\\u003cbr/\\u003efound?}\\n    \\n    Check3[\\\"Query DailyBar:\\u003cbr/\\u003eOrder by volume DESC,\\u003cbr/\\u003eopen_interest DESC\\\"]\\n    \\n    IsFirst{inst.main_code\\u003cbr/\\u003eis None?}\\n    \\n    HasChanged{check_bar.code\\u003cbr/\\u003e!= inst.main_code\\u003cbr/\\u003eAND code \\u003e main_code?}\\n    \\n    FirstTime[\\\"inst.main_code = check_bar.code\\u003cbr/\\u003einst.change_time = day\\u003cbr/\\u003estore_main_bar()\\\"]\\n    \\n    Rollover[\\\"inst.last_main = inst.main_code\\u003cbr/\\u003einst.main_code = check_bar.code\\u003cbr/\\u003einst.change_time = day\\u003cbr/\\u003estore_main_bar()\\u003cbr/\\u003ehandle_rollover()\\\"]\\n    \\n    NoChange[\\\"store_main_bar()\\\"]\\n    \\n    Return[\\\"Return (main_code, updated)\\\"]\\n    \\n    Start --\\u003e GetExpire\\n    GetExpire --\\u003e Check1\\n    Check1 --\\u003e HasBar1\\n    \\n    HasBar1 --\\u003e|Yes| IsFirst\\n    HasBar1 --\\u003e|No| Check2\\n    \\n    Check2 --\\u003e HasBar2\\n    HasBar2 --\\u003e|Yes| IsFirst\\n    HasBar2 --\\u003e|No| Check3\\n    Check3 --\\u003e IsFirst\\n    \\n    IsFirst --\\u003e|Yes| FirstTime\\n    IsFirst --\\u003e|No| HasChanged\\n    \\n    HasChanged --\\u003e|Yes| Rollover\\n    HasChanged --\\u003e|No| NoChange\\n    \\n    FirstTime --\\u003e Return\\n    Rollover --\\u003e Return\\n    NoChange --\\u003e Return\\n    \\n    style Rollover fill:#f9f9f9,stroke:#333,stroke-width:2px\\n    style Check1 fill:#f9f9f9,stroke:#333,stroke-width:1px\\n    style Check2 fill:#f9f9f9,stroke:#333,stroke-width:1px\\n    style Check3 fill:#f9f9f9,stroke:#333,stroke-width:1px\\n```\\n\\n**Sources:** [trader/utils/__init__.py:381-421]()\\n\\n---\\n\\n## Data Models\\n\\nThe main contract calculation interacts with three primary Django models:\\n\\n### Instrument Model Fields\\n\\nThe `Instrument` model tracks the current state of main contract information:\\n\\n| Field | Type | Purpose |\\n|-------|------|---------|\\n| `product_code` | CharField(16) | Base instrument code (e.g., `cu` for copper) |\\n| `main_code` | CharField(16) | Current main contract code (e.g., `cu2401`) |\\n| `last_main` | CharField(16) | Previous main contract before last rollover |\\n| `change_time` | DateTimeField | Timestamp of last main contract change |\\n| `exchange` | CharField(8) | Exchange identifier (SHFE, DCE, CZCE, CFFEX, GFEX) |\\n\\n**Sources:** [panel/models.py:146-171]()\\n\\n### DailyBar Model\\n\\nThe `DailyBar` model stores OHLC data for individual contracts:\\n\\n```mermaid\\nclassDiagram\\n    class DailyBar {\\n        +CharField exchange\\n        +CharField code\\n        +IntegerField expire_date\\n        +DateField time\\n        +DecimalField open\\n        +DecimalField high\\n        +DecimalField low\\n        +DecimalField close\\n        +DecimalField settlement\\n        +IntegerField volume\\n        +DecimalField open_interest\\n    }\\n```\\n\\n**Sources:** [panel/models.py:216-234]()\\n\\n### MainBar Model\\n\\nThe `MainBar` model stores the continuous adjusted series:\\n\\n```mermaid\\nclassDiagram\\n    class MainBar {\\n        +CharField exchange\\n        +CharField product_code\\n        +CharField code\\n        +DateField time\\n        +DecimalField open\\n        +DecimalField high\\n        +DecimalField low\\n        +DecimalField close\\n        +DecimalField settlement\\n        +IntegerField volume\\n        +DecimalField open_interest\\n        +DecimalField basis\\n    }\\n```\\n\\nThe `basis` field stores the price adjustment applied during rollover to maintain continuity.\\n\\n**Sources:** [panel/models.py:194-213]()\\n\\n---\\n\\n## Rollover Handling\\n\\nWhen the main contract changes, the system applies a **basis adjustment** to all historical prices to prevent artificial gaps in the continuous series.\\n\\n### Basis Calculation\\n\\nThe basis is calculated as the difference between the new and old contract closing prices on the rollover day:\\n\\n```\\nbasis = new_contract.close - old_contract.close\\n```\\n\\n### Price Adjustment Formula\\n\\nAll historical `MainBar` records (where `time \\u003c rollover_date`) are adjusted:\\n\\n```\\nadjusted_open = original_open + basis\\nadjusted_high = original_high + basis\\nadjusted_low = original_low + basis\\nadjusted_close = original_close + basis\\nadjusted_settlement = original_settlement + basis\\n```\\n\\nThis ensures that the continuous price series does not show artificial jumps at rollover points.\\n\\n### Rollover Workflow\\n\\n```mermaid\\nsequenceDiagram\\n    participant CI as calc_main_inst\\n    participant DB as DailyBar\\n    participant I as Instrument\\n    participant HR as handle_rollover\\n    participant MB as MainBar\\n    \\n    CI-\\u003e\\u003eDB: Query new contract bar (new_bar)\\n    CI-\\u003e\\u003eDB: Query old contract bar (old_bar)\\n    \\n    CI-\\u003e\\u003eI: Update inst.last_main = inst.main_code\\n    CI-\\u003e\\u003eI: Update inst.main_code = new_bar.code\\n    CI-\\u003e\\u003eI: Update inst.change_time = day\\n    \\n    CI-\\u003e\\u003eMB: store_main_bar(inst, new_bar)\\n    \\n    CI-\\u003e\\u003eHR: handle_rollover(inst, new_bar)\\n    \\n    HR-\\u003e\\u003eDB: Get old_bar for old contract\\n    HR-\\u003e\\u003eMB: Get main_bar for rollover day\\n    \\n    rect rgb(245, 245, 245)\\n        Note over HR: Calculate basis:\\u003cbr/\\u003ebasis = new_bar.close - old_bar.close\\n    end\\n    \\n    HR-\\u003e\\u003eMB: Update main_bar.basis = basis\\n    \\n    rect rgb(245, 245, 245)\\n        Note over HR: Apply basis to all historical records:\\u003cbr/\\u003eUPDATE MainBar\\u003cbr/\\u003eSET open = open + basis,\\u003cbr/\\u003ehigh = high + basis,\\u003cbr/\\u003elow = low + basis,\\u003cbr/\\u003eclose = close + basis,\\u003cbr/\\u003esettlement = settlement + basis\\u003cbr/\\u003eWHERE time \\u003c rollover_day\\n    end\\n    \\n    HR--\\u003e\\u003eCI: Rollover complete\\n    CI--\\u003e\\u003eCI: Return (main_code, updated=True)\\n```\\n\\n**Sources:** [trader/utils/__init__.py:365-378](), [trader/utils/__init__.py:410-418]()\\n\\n---\\n\\n## Main Contract Calculation Functions\\n\\n### Core Functions\\n\\n```mermaid\\ngraph TD\\n    CMIA[\\\"create_main_all()\\\"]\\n    CM[\\\"create_main(inst)\\\"]\\n    CMI[\\\"calc_main_inst(inst, day)\\\"]\\n    SMB[\\\"store_main_bar(inst, bar)\\\"]\\n    HR[\\\"handle_rollover(inst, new_bar)\\\"]\\n    \\n    DB[(\\\"DailyBar\\u003cbr/\\u003eIndividual contracts\\\")]\\n    MB[(\\\"MainBar\\u003cbr/\\u003eContinuous series\\\")]\\n    IM[(\\\"Instrument\\u003cbr/\\u003emain_code tracking\\\")]\\n    \\n    CMIA --\\u003e|\\\"For each Instrument\\\"| CM\\n    CM --\\u003e|\\\"For each trading day\\\"| CMI\\n    \\n    CMI --\\u003e|\\\"Query bars\\\"| DB\\n    CMI --\\u003e|\\\"Check/update\\\"| IM\\n    CMI --\\u003e|\\\"First time or no change\\\"| SMB\\n    CMI --\\u003e|\\\"Main contract changed\\\"| HR\\n    \\n    SMB --\\u003e|\\\"Insert/update\\\"| MB\\n    HR --\\u003e|\\\"Calculate basis\\\"| DB\\n    HR --\\u003e|\\\"Adjust historical prices\\\"| MB\\n    HR --\\u003e|\\\"Store new bar\\\"| SMB\\n    \\n    style CMI fill:#f9f9f9,stroke:#333,stroke-width:2px\\n    style HR fill:#f9f9f9,stroke:#333,stroke-width:2px\\n```\\n\\n**Sources:** [trader/utils/__init__.py:352-444]()\\n\\n### Function Descriptions\\n\\n#### `calc_main_inst(inst: Instrument, day: datetime.datetime)`\\n\\nDetermines the main contract for a specific instrument on a given day.\\n\\n- **Parameters:**\\n  - `inst`: Instrument object containing exchange, product_code\\n  - `day`: Date to calculate main contract for\\n- **Returns:** Tuple of `(main_code: str, updated: bool)`\\n- **Side effects:** Updates `Instrument` model fields, creates/updates `MainBar` records\\n\\n**Sources:** [trader/utils/__init__.py:381-421]()\\n\\n#### `store_main_bar(inst: Instrument, bar: DailyBar)`\\n\\nCreates or updates a `MainBar` record from a `DailyBar` record.\\n\\n- **Parameters:**\\n  - `inst`: Instrument object containing exchange, product_code\\n  - `bar`: DailyBar containing OHLC data\\n- **Side effects:** Creates/updates MainBar record with bar's OHLC data\\n\\n**Sources:** [trader/utils/__init__.py:352-362]()\\n\\n#### `handle_rollover(inst: Instrument, new_bar: DailyBar)`\\n\\nHandles the rollover process when the main contract changes.\\n\\n- **Parameters:**\\n  - `inst`: Instrument with updated main_code and last_main\\n  - `new_bar`: DailyBar of the new main contract\\n- **Algorithm:**\\n  1. Query old contract bar for same day\\n  2. Calculate basis = new_close - old_close\\n  3. Update current MainBar with basis value\\n  4. Apply basis adjustment to all historical MainBar records\\n\\n**Sources:** [trader/utils/__init__.py:365-378]()\\n\\n#### `create_main(inst: Instrument)`\\n\\nProcesses all historical days for a single instrument to build the complete continuous series.\\n\\n- **Parameters:**\\n  - `inst`: Instrument to process\\n- **Algorithm:**\\n  - If `inst.change_time` is None: Process all days from earliest DailyBar\\n  - Otherwise: Process days after `inst.change_time`\\n  - Calls `calc_main_inst()` for each day\\n\\n**Sources:** [trader/utils/__init__.py:424-438]()\\n\\n#### `create_main_all()`\\n\\nEntry point to rebuild main contract series for all instruments in the database.\\n\\n**Sources:** [trader/utils/__init__.py:441-444]()\\n\\n---\\n\\n## Complete Workflow Example\\n\\nThis example illustrates the main contract calculation for copper (`cu`) on a specific day:\\n\\n```mermaid\\nsequenceDiagram\\n    participant System\\n    participant DailyBar\\n    participant calc_main_inst\\n    participant Instrument\\n    participant MainBar\\n    participant handle_rollover\\n    \\n    System-\\u003e\\u003eDailyBar: Fetch all cu contracts for 2024-01-15\\n    Note over DailyBar: cu2401: volume=50,000, OI=80,000\\u003cbr/\\u003ecu2402: volume=120,000, OI=150,000\\u003cbr/\\u003ecu2403: volume=20,000, OI=30,000\\n    \\n    System-\\u003e\\u003ecalc_main_inst: calc_main_inst(cu_inst, 2024-01-15)\\n    \\n    calc_main_inst-\\u003e\\u003eInstrument: Get current inst.main_code = \\\"cu2401\\\"\\n    calc_main_inst-\\u003e\\u003eDailyBar: Query with volume  10K, OI  10K\\n    DailyBar--\\u003e\\u003ecalc_main_inst: Returns cu2402 (highest volume)\\n    \\n    calc_main_inst-\\u003e\\u003ecalc_main_inst: Check: cu2402 != cu2401 AND cu2402 \\u003e cu2401\\n    Note over calc_main_inst: Main contract changed!\\n    \\n    calc_main_inst-\\u003e\\u003eInstrument: inst.last_main = \\\"cu2401\\\"\\n    calc_main_inst-\\u003e\\u003eInstrument: inst.main_code = \\\"cu2402\\\"\\n    calc_main_inst-\\u003e\\u003eInstrument: inst.change_time = 2024-01-15\\n    \\n    calc_main_inst-\\u003e\\u003eMainBar: store_main_bar(cu_inst, cu2402_bar)\\n    MainBar--\\u003e\\u003ecalc_main_inst: MainBar created/updated\\n    \\n    calc_main_inst-\\u003e\\u003ehandle_rollover: handle_rollover(cu_inst, cu2402_bar)\\n    \\n    handle_rollover-\\u003e\\u003eDailyBar: Get cu2401 bar for 2024-01-15\\n    DailyBar--\\u003e\\u003ehandle_rollover: old_bar.close = 68,500\\n    \\n    handle_rollover-\\u003e\\u003eMainBar: Get MainBar for 2024-01-15\\n    MainBar--\\u003e\\u003ehandle_rollover: main_bar (cu2402_bar)\\n    \\n    Note over handle_rollover: cu2402_bar.close = 68,650\\u003cbr/\\u003ebasis = 68,650 - 68,500 = 150\\n    \\n    handle_rollover-\\u003e\\u003eMainBar: UPDATE main_bar SET basis = 150\\n    \\n    handle_rollover-\\u003e\\u003eMainBar: UPDATE all MainBar WHERE time \\u003c 2024-01-15\\u003cbr/\\u003eSET open = open + 150,\\u003cbr/\\u003ehigh = high + 150,\\u003cbr/\\u003elow = low + 150,\\u003cbr/\\u003eclose = close + 150,\\u003cbr/\\u003esettlement = settlement + 150\\n    \\n    handle_rollover--\\u003e\\u003ecalc_main_inst: Rollover complete\\n    calc_main_inst--\\u003e\\u003eSystem: Return (\\\"cu2402\\\", True)\\n```\\n\\n**Sources:** [trader/utils/__init__.py:381-421](), [trader/utils/__init__.py:365-378]()\\n\\n---\\n\\n## Key Implementation Details\\n\\n### Expire Date Handling\\n\\nThe system filters contracts to only consider those with `expire_date \\u003e= current_main_expire_date` to prevent rolling back to earlier contracts:\\n\\n```python\\n# From calc_main_inst\\nexpire_date = get_expire_date(inst.main_code, day) if inst.main_code else day.strftime('%y%m')\\ncheck_bar = DailyBar.objects.filter(\\n    ...,\\n    expire_date__gte=expire_date,\\n    ...\\n).order_by('-volume').first()\\n```\\n\\n**Sources:** [trader/utils/__init__.py:383-388]()\\n\\n### CFFEX Special Handling\\n\\nStock index futures (CFFEX exchange) bypass liquidity filters because they're highly liquid by nature:\\n\\n```python\\ncheck_bar = DailyBar.objects.filter(\\n    (Q(exchange=ExchangeType.CFFEX) | (Q(volume__gte=10000) \\u0026 Q(open_interest__gte=10000))),\\n    ...\\n).order_by('-volume').first()\\n```\\n\\n**Sources:** [trader/utils/__init__.py:385-388]()\\n\\n### Code Ordering for Tie-breaking\\n\\nWhen multiple contracts have the same volume and open interest, the system uses lexicographic ordering on contract code:\\n\\n```python\\ncheck_bar = DailyBar.objects.filter(\\n    ...\\n).order_by('-volume', '-open_interest', 'code').first()\\n```\\n\\nThis ensures deterministic selection: `cu2401` would be chosen over `cu2402` if volumes are identical.\\n\\n**Sources:** [trader/utils/__init__.py:400]()\\n\\n### Database Bulk Update for Basis Adjustment\\n\\nThe rollover adjustment uses Django ORM's `F()` expressions to perform a single SQL UPDATE statement for efficiency:\\n\\n```python\\nMainBar.objects.filter(\\n    exchange=inst.exchange,\\n    product_code=inst.product_code,\\n    time__lt=new_bar.time\\n).update(\\n    open=F('open') + basis,\\n    high=F('high') + basis,\\n    low=F('low') + basis,\\n    close=F('close') + basis,\\n    settlement=F('settlement') + basis\\n)\\n```\\n\\n**Sources:** [trader/utils/__init__.py:376-378]()\\n\\n---\\n\\n## Integration with Other Systems\\n\\nThe main contract calculation integrates with several other system components:\\n\\n| Component | Integration Point | Description |\\n|-----------|------------------|-------------|\\n| Exchange Data Acquisition | `update_from_*()` functions | After fetching daily data, `calc_main_inst()` is called to update main contracts |\\n| Historical Signal Calculation | `calc_history_signal()` | Queries MainBar for continuous price series to generate trading signals |\\n| Live Trading Strategy | TradeStrategy class | Uses `inst.main_code` to determine which contract to trade |\\n| Technical Analysis | TA-Lib indicators | Computes indicators (ATR, SMA, etc.) on MainBar continuous series |\\n\\n**Sources:** [trader/utils/__init__.py:500-601]()\\n\\n---\\n\\n## Summary\\n\\nThe main contract calculation system provides:\\n\\n1. **Robust contract selection** with three-tier fallback logic\\n2. **Seamless continuous series** through basis adjustment\\n3. **Efficient database operations** using bulk updates\\n4. **Exchange-specific handling** for different market characteristics\\n\\nThis enables the trading system to operate on a continuous price series while automatically handling contract rollovers, ensuring backtests and live trading use consistent, adjusted data.\"])</script><script>self.__next_f.push([1,\"2b:T24ab,\"])</script><script>self.__next_f.push([1,\"# Technical Analysis\\n\\n\\u003cdetails\\u003e\\n\\u003csummary\\u003eRelevant source files\\u003c/summary\\u003e\\n\\nThe following files were used as context for generating this wiki page:\\n\\n- [requirements.txt](requirements.txt)\\n- [trader/strategy/brother2.py](trader/strategy/brother2.py)\\n- [trader/utils/__init__.py](trader/utils/__init__.py)\\n\\n\\u003c/details\\u003e\\n\\n\\n\\nThis document explains how technical analysis is implemented in the `trader` system, focusing on the calculation and use of technical indicators such as ATR, SMA, breakout levels, and their integration into trading signal generation. It covers the relevant code entities, data flows, and the role of TA-Lib. \\n\\n**Scope:**  \\n- How technical indicators are computed and used for signal generation.\\n- The relationship between technical analysis and other system components (e.g., data models, strategy logic).\\n- The main code locations and functions responsible for technical analysis.\\n\\n**Related topics:**  \\n- For data model details, see [Data Models](#5.1).\\n- For main contract calculation and rollover logic, see [Main Contract Calculation](#5.3).\\n- For historical backtesting, see [Historical Signal Calculation](#5.5).\\n- For the overall signal generation process, see [Signal Generation](#4.3).\\n\\n---\\n\\n## Purpose of Technical Analysis in the System\\n\\nTechnical analysis in this system is used to:\\n- Calculate trading signals (buy, sell, roll, stop-loss) based on price action and volatility.\\n- Determine position sizing and risk management parameters.\\n- Support both live trading and historical backtesting with consistent logic.\\n\\nThe system relies on daily bar data (OHLCV) and continuous main contract series to compute indicators.\\n\\n**Sources:**  \\n[trader/strategy/brother2.py:725-856]()  \\n[trader/utils/__init__.py:461-463, 500-601]()  \\n\\n---\\n\\n## Key Technical Indicators\\n\\nThe following indicators are central to the system's trading logic:\\n\\n| Indicator | Description | Code Reference |\\n|-----------|-------------|---------------|\\n| ATR (Average True Range) | Measures market volatility, used for stop-loss and position sizing | `ATR` from TA-Lib, see [trader/strategy/brother2.py:737]() |\\n| SMA (Simple Moving Average) | Used for trend detection (short and long period) | Manual calculation, see [trader/strategy/brother2.py:740-742]() |\\n| Breakout Levels | Highest high / lowest low over a window, used for entry signals | Rolling max/min, see [trader/strategy/brother2.py:743-744]() |\\n\\n**Sources:**  \\n[trader/strategy/brother2.py:737-744]()  \\n[trader/utils/__init__.py:461-463, 500-601]()  \\n\\n---\\n\\n## Technical Analysis Data Flow\\n\\n### Diagram: \\\"Technical Analysis Data Flow and Code Entities\\\"\\n\\n```mermaid\\nflowchart TD\\n    subgraph \\\"Data Layer\\\"\\n        MainBar[\\\"MainBar (panel.models)\\\"]\\n        DailyBar[\\\"DailyBar (panel.models)\\\"]\\n    end\\n    subgraph \\\"Indicator Calculation\\\"\\n        ATR[\\\"ATR (TA-Lib)\\\"]\\n        SMA[\\\"SMA (manual, see calc_signal)\\\"]\\n        Breakout[\\\"Breakout Levels (rolling max/min)\\\"]\\n    end\\n    subgraph \\\"Strategy Logic\\\"\\n        calc_signal[\\\"calc_signal (TradeStrategy)\\\"]\\n        calc_history_signal[\\\"calc_history_signal (utils.__init__.py)\\\"]\\n    end\\n    subgraph \\\"Signal Model\\\"\\n        Signal[\\\"Signal (panel.models)\\\"]\\n    end\\n\\n    DailyBar --\\u003e MainBar\\n    MainBar --\\u003e ATR\\n    MainBar --\\u003e SMA\\n    MainBar --\\u003e Breakout\\n    ATR --\\u003e calc_signal\\n    SMA --\\u003e calc_signal\\n    Breakout --\\u003e calc_signal\\n    ATR --\\u003e calc_history_signal\\n    SMA --\\u003e calc_history_signal\\n    Breakout --\\u003e calc_history_signal\\n    calc_signal --\\u003e Signal\\n    calc_history_signal --\\u003e Signal\\n```\\n\\n**Sources:**  \\n[trader/strategy/brother2.py:725-856]()  \\n[trader/utils/__init__.py:500-601]()  \\n\\n---\\n\\n## Code Entities and Their Roles\\n\\n### Table: Main Code Entities for Technical Analysis\\n\\n| Entity | File | Role |\\n|--------|------|------|\\n| `TradeStrategy.calc_signal` | `trader/strategy/brother2.py` | Main function for live signal calculation using technical indicators |\\n| `calc_history_signal` | `trader/utils/__init__.py` | Historical signal calculation for backtesting |\\n| `ATR` | `TA-Lib` (imported in both files) | Volatility indicator |\\n| `price_round` | `trader/utils/__init__.py` | Rounds prices to instrument tick size |\\n| `Signal` | `panel/models.py` | Stores generated trading signals |\\n| `MainBar` | `panel/models.py` | Continuous main contract price series |\\n\\n**Sources:**  \\n[trader/strategy/brother2.py:725-856]()  \\n[trader/utils/__init__.py:500-601, 67-85]()  \\n\\n---\\n\\n## Indicator Calculation Logic\\n\\n### ATR (Average True Range)\\n\\n- Calculated using TA-Lib's `ATR` function.\\n- Used for:\\n  - Determining stop-loss thresholds.\\n  - Position sizing (risk per trade).\\n\\n**Example (see code):**\\n```python\\ndf[\\\"atr\\\"] = ATR(df.high, df.low, df.close, timeperiod=atr_n)\\n```\\n[trader/strategy/brother2.py:737]()\\n\\n### SMA (Simple Moving Average)\\n\\n- Short and long period SMAs are calculated manually for trend detection.\\n- Used to determine the direction of the trade (trend-following logic).\\n\\n**Example (see code):**\\n```python\\nfor idx in range(1, df.shape[0]):\\n    df.short_trend[idx] = (df.short_trend[idx - 1] * (short_n - 1) + df.close[idx]) / short_n\\n    df.long_trend[idx] = (df.long_trend[idx - 1] * (long_n - 1) + df.close[idx]) / long_n\\n```\\n[trader/strategy/brother2.py:740-742]()\\n\\n### Breakout Levels\\n\\n- Calculated as rolling maximum (high) and minimum (low) over a configurable window.\\n- Used to trigger entry signals when price breaks out of recent range.\\n\\n**Example (see code):**\\n```python\\ndf[\\\"high_line\\\"] = df.close.rolling(window=break_n).max()\\ndf[\\\"low_line\\\"] = df.close.rolling(window=break_n).min()\\n```\\n[trader/strategy/brother2.py:743-744]()\\n\\n**Sources:**  \\n[trader/strategy/brother2.py:737-744]()  \\n\\n---\\n\\n## Signal Generation Using Technical Indicators\\n\\n### Diagram: \\\"calc_signal and Signal Generation Logic\\\"\\n\\n```mermaid\\nflowchart TD\\n    subgraph \\\"TradeStrategy\\\"\\n        calc_signal[\\\"calc_signal(inst, day)\\\"]\\n    end\\n    subgraph \\\"Inputs\\\"\\n        MainBar[\\\"MainBar.objects.filter(...)\\\"]\\n        StrategyParams[\\\"Strategy.param_set\\\"]\\n        Trade[\\\"Trade.objects.filter(...)\\\"]\\n    end\\n    subgraph \\\"Indicators\\\"\\n        ATR[\\\"ATR\\\"]\\n        SMA[\\\"SMA (short_trend, long_trend)\\\"]\\n        Breakout[\\\"Breakout Levels\\\"]\\n    end\\n    subgraph \\\"Outputs\\\"\\n        Signal[\\\"Signal.objects.update_or_create(...)\\\"]\\n    end\\n\\n    MainBar --\\u003e calc_signal\\n    StrategyParams --\\u003e calc_signal\\n    Trade --\\u003e calc_signal\\n    calc_signal --\\u003e ATR\\n    calc_signal --\\u003e SMA\\n    calc_signal --\\u003e Breakout\\n    ATR --\\u003e calc_signal\\n    SMA --\\u003e calc_signal\\n    Breakout --\\u003e calc_signal\\n    calc_signal --\\u003e Signal\\n```\\n\\n**Sources:**  \\n[trader/strategy/brother2.py:725-856]()  \\n\\n---\\n\\n## Example: Signal Generation Logic\\n\\nThe `calc_signal` method in `TradeStrategy` performs the following steps:\\n\\n1. **Fetches historical price data** from `MainBar` for the instrument.\\n2. **Calculates indicators**:\\n   - ATR for volatility.\\n   - Short and long SMAs for trend.\\n   - Breakout levels for entry triggers.\\n3. **Determines signal conditions**:\\n   - **Buy**: Short SMA \\u003e Long SMA and close \\u003e= previous high_line.\\n   - **Sell**: Short SMA \\u003c Long SMA and close \\u003c= previous low_line.\\n   - **Stop-loss**: Price moves against position by a multiple of ATR.\\n   - **Rollover**: Main contract changes.\\n4. **Calculates position size** based on risk and ATR.\\n5. **Creates or updates a Signal** in the database.\\n\\n**Sources:**  \\n[trader/strategy/brother2.py:725-856]()  \\n\\n---\\n\\n## Technical Analysis in Backtesting\\n\\nThe function `calc_history_signal` in `trader/utils/__init__.py` implements the same indicator logic for historical data, ensuring that backtesting and live trading use consistent rules.\\n\\n- Iterates over historical bars.\\n- Applies the same ATR, SMA, and breakout logic.\\n- Records signals and trades for each historical event.\\n\\n**Sources:**  \\n[trader/utils/__init__.py:500-601]()  \\n\\n---\\n\\n## Bridging System and Code: Entity Mapping Diagram\\n\\n### Diagram: \\\"System Entities to Code Entities for Technical Analysis\\\"\\n\\n```mermaid\\ngraph TD\\n    \\\"MainBar (panel.models)\\\" --\\u003e|\\\"input to\\\"| \\\"calc_signal (TradeStrategy)\\\"\\n    \\\"MainBar (panel.models)\\\" --\\u003e|\\\"input to\\\"| \\\"calc_history_signal (utils.__init__.py)\\\"\\n    \\\"ATR (TA-Lib)\\\" --\\u003e|\\\"used in\\\"| \\\"calc_signal (TradeStrategy)\\\"\\n    \\\"ATR (TA-Lib)\\\" --\\u003e|\\\"used in\\\"| \\\"calc_history_signal (utils.__init__.py)\\\"\\n    \\\"SMA (manual)\\\" --\\u003e|\\\"used in\\\"| \\\"calc_signal (TradeStrategy)\\\"\\n    \\\"SMA (manual)\\\" --\\u003e|\\\"used in\\\"| \\\"calc_history_signal (utils.__init__.py)\\\"\\n    \\\"Breakout Levels\\\" --\\u003e|\\\"used in\\\"| \\\"calc_signal (TradeStrategy)\\\"\\n    \\\"Breakout Levels\\\" --\\u003e|\\\"used in\\\"| \\\"calc_history_signal (utils.__init__.py)\\\"\\n    \\\"Signal (panel.models)\\\" \\u003c--|\\\"output from\\\"| \\\"calc_signal (TradeStrategy)\\\"\\n    \\\"Signal (panel.models)\\\" \\u003c--|\\\"output from\\\"| \\\"calc_history_signal (utils.__init__.py)\\\"\\n```\\n\\n**Sources:**  \\n[trader/strategy/brother2.py:725-856]()  \\n[trader/utils/__init__.py:500-601]()  \\n\\n---\\n\\n## Summary\\n\\n- Technical analysis in the `trader` system is implemented using a combination of TA-Lib (for ATR), manual SMA calculations, and rolling breakout levels.\\n- The main logic is in `TradeStrategy.calc_signal` for live trading and `calc_history_signal` for backtesting.\\n- Signals are generated based on indicator conditions and stored in the `Signal` model.\\n- The same indicator logic is used for both live and historical analysis, ensuring consistency.\\n\\n**Sources:**  \\n[trader/strategy/brother2.py:725-856]()  \\n[trader/utils/__init__.py:500-601]()  \\n[trader/utils/__init__.py:67-85]()  \\n[requirements.txt:12]()\"])</script><script>self.__next_f.push([1,\"2c:T67cf,\"])</script><script>self.__next_f.push([1,\"# Historical Signal Calculation\\n\\n\\u003cdetails\\u003e\\n\\u003csummary\\u003eRelevant source files\\u003c/summary\\u003e\\n\\nThe following files were used as context for generating this wiki page:\\n\\n- [panel/models.py](panel/models.py)\\n- [trader/utils/__init__.py](trader/utils/__init__.py)\\n\\n\\u003c/details\\u003e\\n\\n\\n\\n## Purpose and Scope\\n\\nThis document describes the historical signal calculation system, which is used to backtest trading strategies by simulating signal generation and trade execution using historical market data. The system applies the same technical indicators and trading rules used in live trading to historical MainBar data, creating Signal and Trade records as if the strategy had been running in the past.\\n\\nFor information about live signal generation, see [Signal Generation](#4.3). For details on the data models used, see [Data Models](#5.1). For information about technical indicators, see [Technical Analysis](#5.4).\\n\\n**Sources:** [trader/utils/__init__.py:500-601]()\\n\\n---\\n\\n## Overview\\n\\nThe historical signal calculation system serves as a backtesting engine that:\\n\\n1. **Loads historical price data** from the MainBar model for a specific instrument\\n2. **Calculates technical indicators** (ATR, SMA trends, breakout levels) \\n3. **Simulates signal generation** by applying trading rules to each historical bar\\n4. **Creates Trade records** with entry/exit prices and profit/loss calculations\\n5. **Persists results** to the database for performance analysis\\n\\nThe system uses the same parameters and logic as the live trading strategy, ensuring consistency between backtesting and real-time execution.\\n\\n**Key Functions:**\\n- `calc_history_signal()` - Backtests a single instrument for a specific time period\\n- `calc_his_all()` - Runs backtest across all instruments in a strategy\\n\\n**Sources:** [trader/utils/__init__.py:500-615]()\\n\\n---\\n\\n## System Architecture\\n\\nThe following diagram illustrates how the historical signal calculation system fits into the broader data pipeline:\\n\\n```mermaid\\ngraph TB\\n    subgraph \\\"Historical Data\\\"\\n        DailyBar[(DailyBar Model\\u003cbr/\\u003eIndividual Contracts)]\\n        MainBar[(MainBar Model\\u003cbr/\\u003eContinuous Series)]\\n    end\\n    \\n    subgraph \\\"Strategy Configuration\\\"\\n        Strategy[Strategy Model]\\n        Params[Param Model\\u003cbr/\\u003eBreakPeriod\\u003cbr/\\u003eAtrPeriod\\u003cbr/\\u003eLongPeriod\\u003cbr/\\u003eShortPeriod\\u003cbr/\\u003eStopLoss]\\n        Instrument[Instrument Model\\u003cbr/\\u003eproduct_code\\u003cbr/\\u003evolume_multiple]\\n    end\\n    \\n    subgraph \\\"Historical Calculation Engine\\\"\\n        CalcHistory[calc_history_signal]\\n        LoadData[Load MainBar Data]\\n        CalcIndicators[Calculate Indicators\\u003cbr/\\u003eATR, SMA, Breakout]\\n        SimulateTrades[Simulate Trading Logic]\\n    end\\n    \\n    subgraph \\\"Technical Analysis\\\"\\n        TALib[TA-Lib ATR]\\n        SMA[SMA Calculation]\\n        Breakout[Breakout Levels\\u003cbr/\\u003erolling max/min]\\n    end\\n    \\n    subgraph \\\"Output\\\"\\n        Signal[(Signal Model\\u003cbr/\\u003eBUY, SELL\\u003cbr/\\u003eBUY_COVER, SELL_SHORT)]\\n        Trade[(Trade Model\\u003cbr/\\u003eP\\u0026L Calculation)]\\n    end\\n    \\n    Strategy --\\u003e Params\\n    Strategy --\\u003e Instrument\\n    Instrument --\\u003e CalcHistory\\n    Params --\\u003e CalcHistory\\n    \\n    MainBar --\\u003e LoadData\\n    LoadData --\\u003e CalcHistory\\n    \\n    CalcHistory --\\u003e CalcIndicators\\n    CalcIndicators --\\u003e TALib\\n    CalcIndicators --\\u003e SMA\\n    CalcIndicators --\\u003e Breakout\\n    \\n    CalcIndicators --\\u003e SimulateTrades\\n    SimulateTrades --\\u003e Signal\\n    SimulateTrades --\\u003e Trade\\n    \\n    style CalcHistory fill:#ff6b6b\\n    style Signal fill:#ffd3b6\\n    style Trade fill:#a8e6cf\\n```\\n\\n**Sources:** [trader/utils/__init__.py:500-615](), [panel/models.py:104-289]()\\n\\n---\\n\\n## Strategy Parameters\\n\\nThe historical signal calculation system uses five key parameters from the Strategy's `param_set`:\\n\\n| Parameter Code | Purpose | Usage in Algorithm |\\n|----------------|---------|-------------------|\\n| `BreakPeriod` | Breakout period | Lookback window for calculating high_line and low_line (rolling max/min) |\\n| `AtrPeriod` | ATR calculation period | Period for Average True Range calculation used in stop-loss |\\n| `LongPeriod` | Long-term trend period | Period for slow exponential moving average |\\n| `ShortPeriod` | Short-term trend period | Period for fast exponential moving average |\\n| `StopLoss` | Stop-loss multiplier | Number of ATRs used as stop-loss distance |\\n\\nThese parameters are retrieved at the start of the calculation:\\n\\n```python\\nbreak_n = strategy.param_set.get(code='BreakPeriod').int_value\\natr_n = strategy.param_set.get(code='AtrPeriod').int_value\\nlong_n = strategy.param_set.get(code='LongPeriod').int_value\\nshort_n = strategy.param_set.get(code='ShortPeriod').int_value\\nstop_n = strategy.param_set.get(code='StopLoss').int_value\\n```\\n\\n**Sources:** [trader/utils/__init__.py:501-505]()\\n\\n---\\n\\n## Data Loading and Preparation\\n\\nThe historical calculation process begins by loading MainBar data and preparing a pandas DataFrame with calculated indicators:\\n\\n```mermaid\\nflowchart LR\\n    subgraph \\\"Data Query\\\"\\n        QueryMainBar[\\\"MainBar.objects.filter\\u003cbr/\\u003etime \\u003c= day\\u003cbr/\\u003eexchange=inst.exchange\\u003cbr/\\u003eproduct_code=inst.product_code\\\"]\\n    end\\n    \\n    subgraph \\\"DataFrame Construction\\\"\\n        ToDF[\\\"to_df()\\u003cbr/\\u003eColumns: time, open,\\u003cbr/\\u003ehigh, low, close,\\u003cbr/\\u003esettlement\\\"]\\n        SetIndex[\\\"Set DatetimeIndex\\u003cbr/\\u003ewith timezone\\\"]\\n    end\\n    \\n    subgraph \\\"Indicator Calculation\\\"\\n        CalcATR[\\\"ATR()\\u003cbr/\\u003etimeperiod=atr_n\\\"]\\n        CalcShortTrend[\\\"short_trend\\u003cbr/\\u003eExponential MA\\u003cbr/\\u003eperiod=short_n\\\"]\\n        CalcLongTrend[\\\"long_trend\\u003cbr/\\u003eExponential MA\\u003cbr/\\u003eperiod=long_n\\\"]\\n        CalcBreakout[\\\"high_line, low_line\\u003cbr/\\u003erolling max/min\\u003cbr/\\u003ewindow=break_n\\\"]\\n    end\\n    \\n    QueryMainBar --\\u003e ToDF\\n    ToDF --\\u003e SetIndex\\n    SetIndex --\\u003e CalcATR\\n    SetIndex --\\u003e CalcShortTrend\\n    SetIndex --\\u003e CalcLongTrend\\n    SetIndex --\\u003e CalcBreakout\\n```\\n\\nThe resulting DataFrame has the following structure:\\n\\n| Column | Description |\\n|--------|-------------|\\n| `time` | Date (index) |\\n| `open` | Opening price |\\n| `high` | Highest price |\\n| `low` | Lowest price |\\n| `close` | Closing price |\\n| `settlement` | Settlement price |\\n| `atr` | Average True Range |\\n| `short_trend` | Short-term exponential moving average |\\n| `long_trend` | Long-term exponential moving average |\\n| `high_line` | Breakout resistance (N-period high) |\\n| `low_line` | Breakout support (N-period low) |\\n\\n**Sources:** [trader/utils/__init__.py:506-519](), [panel/models.py:25-39]()\\n\\n---\\n\\n## Technical Indicator Calculations\\n\\n### ATR (Average True Range)\\n\\nATR is calculated using TA-Lib's built-in function:\\n\\n```python\\ndf['atr'] = ATR(df.high, df.low, df.close, timeperiod=atr_n)\\n```\\n\\nATR measures market volatility and is used for:\\n- **Position sizing** (trigger_value in signals)\\n- **Stop-loss calculation** (distance from entry = atr * stop_n)\\n\\n**Sources:** [trader/utils/__init__.py:511]()\\n\\n### Exponential Moving Averages (Trend Lines)\\n\\nShort-term and long-term trends are calculated using exponential smoothing:\\n\\n```python\\nfor idx in range(1, df.shape[0]):\\n    df.iloc[idx, 7] = (df.iloc[idx - 1, 7] * (short_n - 1) + df.iloc[idx, 4]) / short_n\\n    df.iloc[idx, 8] = (df.iloc[idx - 1, 8] * (long_n - 1) + df.iloc[idx, 4]) / long_n\\n```\\n\\nThis implements the formula: `SMA_t = (SMA_{t-1} * (N-1) + Price_t) / N`\\n\\nThe crossover of these trends determines trend direction:\\n- **Bullish trend**: `short_trend \\u003e long_trend`\\n- **Bearish trend**: `short_trend \\u003c long_trend`\\n\\n**Sources:** [trader/utils/__init__.py:513-517]()\\n\\n### Breakout Levels\\n\\nBreakout levels are calculated using rolling window operations:\\n\\n```python\\ndf['high_line'] = df.close.rolling(window=break_n).max()\\ndf['low_line'] = df.close.rolling(window=break_n).min()\\n```\\n\\nThese represent:\\n- **high_line**: Resistance level (highest close in last N periods)\\n- **low_line**: Support level (lowest close in last N periods)\\n\\n**Sources:** [trader/utils/__init__.py:518-519]()\\n\\n---\\n\\n## Signal Generation Logic\\n\\nThe system simulates trading by iterating through historical bars and applying entry/exit rules:\\n\\n```mermaid\\nflowchart TD\\n    Start[\\\"Start at bar\\u003cbr/\\u003ebreak_n + 1\\\"]\\n    CheckPos{\\\"Current Position?\\\"}\\n    \\n    subgraph \\\"No Position (cur_pos == 0)\\\"\\n        CheckLongEntry{\\\"short_trend \\u003e long_trend\\u003cbr/\\u003eAND\\u003cbr/\\u003eclose \\u003e= high_line?\\\"}\\n        CheckShortEntry{\\\"short_trend \\u003c long_trend\\u003cbr/\\u003eAND\\u003cbr/\\u003eclose \\u003c low_line?\\\"}\\n        CreateBuySignal[\\\"Create Signal\\u003cbr/\\u003etype=BUY\\u003cbr/\\u003eCreate Trade\\u003cbr/\\u003edirection=LONG\\\"]\\n        CreateSellSignal[\\\"Create Signal\\u003cbr/\\u003etype=SELL_SHORT\\u003cbr/\\u003eCreate Trade\\u003cbr/\\u003edirection=SHORT\\\"]\\n    end\\n    \\n    subgraph \\\"Long Position (cur_pos \\u003e 0)\\\"\\n        CalcHH[\\\"Calculate HH\\u003cbr/\\u003ehighest high since entry\\\"]\\n        CheckLongExit{\\\"close \\u003c= HH - ATR * stop_n?\\\"}\\n        CloseLong[\\\"Create Signal\\u003cbr/\\u003etype=SELL\\u003cbr/\\u003eClose Trade\\u003cbr/\\u003eCalculate P\\u0026L\\\"]\\n    end\\n    \\n    subgraph \\\"Short Position (cur_pos \\u003c 0)\\\"\\n        CalcLL[\\\"Calculate LL\\u003cbr/\\u003elowest low since entry\\\"]\\n        CheckShortExit{\\\"close \\u003e= LL + ATR * stop_n?\\\"}\\n        CloseShort[\\\"Create Signal\\u003cbr/\\u003etype=BUY_COVER\\u003cbr/\\u003eClose Trade\\u003cbr/\\u003eCalculate P\\u0026L\\\"]\\n    end\\n    \\n    NextBar[\\\"Move to next bar\\\"]\\n    \\n    Start --\\u003e CheckPos\\n    CheckPos --\\u003e|\\\"No Position\\\"| CheckLongEntry\\n    CheckLongEntry --\\u003e|\\\"Yes\\\"| CreateBuySignal\\n    CheckLongEntry --\\u003e|\\\"No\\\"| CheckShortEntry\\n    CheckShortEntry --\\u003e|\\\"Yes\\\"| CreateSellSignal\\n    CheckShortEntry --\\u003e|\\\"No\\\"| NextBar\\n    \\n    CheckPos --\\u003e|\\\"Long Position\\\"| CalcHH\\n    CalcHH --\\u003e CheckLongExit\\n    CheckLongExit --\\u003e|\\\"Yes\\\"| CloseLong\\n    CheckLongExit --\\u003e|\\\"No\\\"| NextBar\\n    \\n    CheckPos --\\u003e|\\\"Short Position\\\"| CalcLL\\n    CalcLL --\\u003e CheckShortExit\\n    CheckShortExit --\\u003e|\\\"Yes\\\"| CloseShort\\n    CheckShortExit --\\u003e|\\\"No\\\"| NextBar\\n    \\n    CreateBuySignal --\\u003e NextBar\\n    CreateSellSignal --\\u003e NextBar\\n    CloseLong --\\u003e NextBar\\n    CloseShort --\\u003e NextBar\\n```\\n\\n**Sources:** [trader/utils/__init__.py:520-589]()\\n\\n---\\n\\n## Entry Signal Rules\\n\\n### Long Entry (BUY Signal)\\n\\nA long entry signal is generated when:\\n1. **No current position** (`cur_pos == 0`)\\n2. **Bullish trend**: `short_trend \\u003e long_trend`\\n3. **Breakout**: `close \\u003e= high_line` (previous bar's high_line)\\n\\nImplementation:\\n```python\\nif cur_pos == 0:\\n    if df.short_trend[idx] \\u003e df.long_trend[idx] and int(df.close[idx]) \\u003e= int(df.high_line[idx-1]):\\n        new_bar = MainBar.objects.filter(\\n            exchange=inst.exchange, product_code=inst.product_code, time=cur_date).first()\\n        Signal.objects.create(\\n            code=new_bar.code, trigger_value=df.atr[idx],\\n            strategy=strategy, instrument=inst, type=SignalType.BUY, processed=True,\\n            trigger_time=prev_date, price=new_bar.open, volume=1, priority=PriorityType.LOW)\\n        last_trade = Trade.objects.create(\\n            broker=strategy.broker, strategy=strategy, instrument=inst,\\n            code=new_bar.code, direction=DirectionType.values[DirectionType.LONG],\\n            open_time=cur_date, shares=1, filled_shares=1, avg_entry_price=new_bar.open)\\n```\\n\\n**Sources:** [trader/utils/__init__.py:526-538]()\\n\\n### Short Entry (SELL_SHORT Signal)\\n\\nA short entry signal is generated when:\\n1. **No current position** (`cur_pos == 0`)\\n2. **Bearish trend**: `short_trend \\u003c long_trend`\\n3. **Breakdown**: `close \\u003c low_line` (previous bar's low_line)\\n\\nImplementation follows the same pattern as long entry, but creates a SELL_SHORT signal and SHORT direction trade.\\n\\n**Sources:** [trader/utils/__init__.py:539-551]()\\n\\n---\\n\\n## Exit Signal Rules\\n\\n### Long Exit (SELL Signal)\\n\\nA long position is closed when:\\n1. **Currently long** (`cur_pos \\u003e 0`)\\n2. **Stop-loss triggered**: `close \\u003c= HH - atr * stop_n`\\n\\nWhere:\\n- `HH` = highest high since position entry\\n- `atr` = ATR value at position entry time\\n- `stop_n` = stop-loss multiplier parameter\\n\\nImplementation:\\n```python\\nelif cur_pos \\u003e 0 and prev_date \\u003e last_trade.open_time:\\n    hh = float(MainBar.objects.filter(\\n        exchange=inst.exchange, product_code=inst.product_code,\\n        time__gte=last_trade.open_time,\\n        time__lt=prev_date).aggregate(Max('high'))['high__max'])\\n    if df.close[idx] \\u003c= hh - df.atr[cur_pos-1] * stop_n:\\n        # Create SELL signal and close trade\\n```\\n\\n**Sources:** [trader/utils/__init__.py:552-570]()\\n\\n### Short Exit (BUY_COVER Signal)\\n\\nA short position is closed when:\\n1. **Currently short** (`cur_pos \\u003c 0`)\\n2. **Stop-loss triggered**: `close \\u003e= LL + atr * stop_n`\\n\\nWhere:\\n- `LL` = lowest low since position entry\\n- `atr` = ATR value at position entry time\\n- `stop_n` = stop-loss multiplier parameter\\n\\n**Sources:** [trader/utils/__init__.py:571-589]()\\n\\n---\\n\\n## Trade Record Creation\\n\\nFor each signal, the system creates corresponding Trade records with complete position tracking:\\n\\n### Entry Trade Fields\\n\\nWhen a position is opened, a Trade record is created with:\\n\\n| Field | Description | Example Value |\\n|-------|-------------|---------------|\\n| `broker` | Strategy's broker account | `strategy.broker` |\\n| `strategy` | Associated strategy | Strategy instance |\\n| `instrument` | Traded instrument | Instrument instance |\\n| `code` | Specific contract code | `'rb2201'` |\\n| `direction` | Position direction | `''` or `''` |\\n| `open_time` | Entry timestamp | Current bar's datetime |\\n| `shares` | Position size | `1` |\\n| `filled_shares` | Filled quantity | `1` |\\n| `avg_entry_price` | Entry price | `new_bar.open` |\\n\\n### Exit Trade Fields\\n\\nWhen a position is closed, the Trade record is updated with:\\n\\n| Field | Description | Calculation |\\n|-------|-------------|-------------|\\n| `avg_exit_price` | Exit price | `new_bar.open` |\\n| `close_time` | Exit timestamp | Current bar's datetime |\\n| `closed_shares` | Quantity closed | `1` |\\n| `profit` | Realized P\\u0026L | `(exit - entry) * volume_multiple` (long)\\u003cbr/\\u003e`(entry - exit) * volume_multiple` (short) |\\n\\n**Long Position P\\u0026L:**\\n```python\\nlast_trade.profit = (new_bar.open - last_trade.avg_entry_price) * inst.volume_multiple\\n```\\n\\n**Short Position P\\u0026L:**\\n```python\\nlast_trade.profit = (last_trade.avg_entry_price - new_bar.open) * inst.volume_multiple\\n```\\n\\n**Sources:** [trader/utils/__init__.py:534-600](), [panel/models.py:262-289]()\\n\\n---\\n\\n## Position State Management\\n\\nThe system tracks position state using the `cur_pos` variable:\\n\\n| Value | State | Meaning |\\n|-------|-------|---------|\\n| `0` | Flat | No position |\\n| `\\u003e 0` | Long | Long position, value = entry bar index |\\n| `\\u003c 0` | Short | Short position, value = -1 * entry bar index |\\n\\nThis encoding allows the system to:\\n1. **Determine position direction** (sign of cur_pos)\\n2. **Retrieve entry bar index** for ATR lookup (abs(cur_pos) - 1)\\n3. **Track position lifetime** for stop-loss calculations\\n\\nExample:\\n```python\\ncur_pos = cur_idx          # Long entry at bar cur_idx\\ncur_pos = cur_idx * -1     # Short entry at bar cur_idx\\ncur_pos = 0                # Position closed\\n```\\n\\n**Sources:** [trader/utils/__init__.py:520-589]()\\n\\n---\\n\\n## End-of-Backtest Position Handling\\n\\nIf a position is still open when the backtest reaches the target date (`day`), the system automatically closes it at the opening price:\\n\\n```python\\nif cur_pos != 0 and cur_date.date() == day.date():\\n    last_trade.avg_exit_price = df.open[cur_idx]\\n    last_trade.close_time = cur_date\\n    last_trade.closed_shares = 1\\n    if last_trade.direction == DirectionType.values[DirectionType.LONG]:\\n        last_trade.profit = (last_trade.avg_entry_price - Decimal(df.open[cur_idx])) * \\\\\\n                            inst.volume_multiple\\n    else:\\n        last_trade.profit = (Decimal(df.open[cur_idx]) - last_trade.avg_entry_price) * \\\\\\n                            inst.volume_multiple\\n    last_trade.save()\\n```\\n\\nThis ensures:\\n- All trades have complete entry/exit information\\n- P\\u0026L is calculated for performance analysis\\n- The backtest produces a complete trading history\\n\\n**Sources:** [trader/utils/__init__.py:590-600]()\\n\\n---\\n\\n## Database Interactions\\n\\nThe historical signal calculation system interacts with multiple Django models:\\n\\n```mermaid\\ngraph LR\\n    subgraph \\\"Input Models\\\"\\n        MainBar[MainBar\\u003cbr/\\u003eHistorical prices]\\n        Strategy[Strategy\\u003cbr/\\u003eTrading strategy]\\n        Param[Param\\u003cbr/\\u003eStrategy parameters]\\n        Instrument[Instrument\\u003cbr/\\u003eContract specifications]\\n    end\\n    \\n    subgraph \\\"calc_history_signal Function\\\"\\n        Load[Load Data]\\n        Calculate[Calculate Indicators]\\n        Simulate[Simulate Trading]\\n    end\\n    \\n    subgraph \\\"Output Models\\\"\\n        Signal[Signal\\u003cbr/\\u003eEntry/Exit signals]\\n        Trade[Trade\\u003cbr/\\u003ePosition records]\\n    end\\n    \\n    MainBar --\\u003e|\\\"objects.filter\\u003cbr/\\u003evalues_list\\\"| Load\\n    Strategy --\\u003e|\\\"param_set.get\\\"| Load\\n    Instrument --\\u003e|\\\"volume_multiple\\\"| Load\\n    \\n    Load --\\u003e Calculate\\n    Calculate --\\u003e Simulate\\n    \\n    Simulate --\\u003e|\\\"objects.create\\u003cbr/\\u003eprocessed=True\\\"| Signal\\n    Simulate --\\u003e|\\\"objects.create\\u003cbr/\\u003eP\\u0026L calculation\\\"| Trade\\n    \\n    style Load fill:#e6f3ff\\n    style Calculate fill:#ffe6e6\\n    style Simulate fill:#e6ffe6\\n```\\n\\n### Query Operations\\n\\n**Reading historical data:**\\n```python\\nMainBar.objects.filter(\\n    time__lte=day.date(),\\n    exchange=inst.exchange, \\n    product_code=inst.product_code\\n).order_by('time').values_list('time', 'open', 'high', 'low', 'close', 'settlement')\\n```\\n\\n**Loading strategy parameters:**\\n```python\\nstrategy.param_set.get(code='BreakPeriod').int_value\\n```\\n\\n### Write Operations\\n\\n**Creating signals:**\\n```python\\nSignal.objects.create(\\n    code=new_bar.code,\\n    trigger_value=df.atr[idx],\\n    strategy=strategy,\\n    instrument=inst,\\n    type=SignalType.BUY,\\n    processed=True,\\n    trigger_time=prev_date,\\n    price=new_bar.open,\\n    volume=1,\\n    priority=PriorityType.LOW\\n)\\n```\\n\\n**Creating/updating trades:**\\n```python\\nTrade.objects.create(\\n    broker=strategy.broker,\\n    strategy=strategy,\\n    instrument=inst,\\n    code=new_bar.code,\\n    direction=DirectionType.values[DirectionType.LONG],\\n    open_time=cur_date,\\n    shares=1,\\n    filled_shares=1,\\n    avg_entry_price=new_bar.open\\n)\\n```\\n\\n**Sources:** [trader/utils/__init__.py:506-600](), [panel/models.py:173-289]()\\n\\n---\\n\\n## Batch Processing with calc_his_all\\n\\nThe `calc_his_all()` function applies historical signal calculation to all instruments in a strategy:\\n\\n```mermaid\\nflowchart TD\\n    Start[\\\"calc_his_all(day)\\\"]\\n    GetStrategy[\\\"Get Strategy\\u003cbr/\\u003ename='2.0'\\\"]\\n    GetInstruments[\\\"Get all instruments\\u003cbr/\\u003ein strategy\\\"]\\n    \\n    subgraph \\\"For Each Instrument\\\"\\n        CheckLastTrade[\\\"Query last open trade\\u003cbr/\\u003eclose_time__isnull=True\\\"]\\n        DetermineStartDate{\\\"Last trade\\u003cbr/\\u003eexists?\\\"}\\n        UseLastDay[\\\"Use open_time\\u003cbr/\\u003eas start date\\\"]\\n        UseHistoryEnd[\\\"Use last MainBar.time\\u003cbr/\\u003eas start date\\\"]\\n        CallCalcHistory[\\\"calc_history_signal\\u003cbr/\\u003e(inst, last_day, strategy)\\\"]\\n    end\\n    \\n    Done[\\\"Complete\\\"]\\n    \\n    Start --\\u003e GetStrategy\\n    GetStrategy --\\u003e GetInstruments\\n    GetInstruments --\\u003e CheckLastTrade\\n    CheckLastTrade --\\u003e DetermineStartDate\\n    DetermineStartDate --\\u003e|\\\"Yes\\\"| UseLastDay\\n    DetermineStartDate --\\u003e|\\\"No\\\"| UseHistoryEnd\\n    UseLastDay --\\u003e CallCalcHistory\\n    UseHistoryEnd --\\u003e CallCalcHistory\\n    CallCalcHistory --\\u003e Done\\n```\\n\\nImplementation:\\n```python\\ndef calc_his_all(day: datetime.datetime):\\n    strategy = Strategy.objects.get(name='2.0')\\n    print(f'calc_his_all day: {day} stragety: {strategy}')\\n    for inst in strategy.instruments.all():\\n        print('process', inst)\\n        last_day = Trade.objects.filter(instrument=inst, close_time__isnull=True).values_list(\\n            'open_time', flat=True).first()\\n        if last_day is None:\\n            last_day = datetime.datetime.combine(\\n                MainBar.objects.filter(product_code=inst.product_code, time__lte=day).order_by(\\n                    '-time').values_list('time', flat=True).first(), timezone.make_aware(datetime.time.min))\\n        calc_history_signal(inst, last_day, strategy)\\n```\\n\\nThis function:\\n1. Retrieves the strategy named \\\"2.0\\\"\\n2. Iterates through all associated instruments\\n3. For each instrument, determines the starting point:\\n   - If there's an open trade, start from its `open_time`\\n   - Otherwise, start from the last available MainBar\\n4. Calls `calc_history_signal()` for that instrument\\n\\n**Sources:** [trader/utils/__init__.py:603-614]()\\n\\n---\\n\\n## Usage Examples\\n\\n### Backtesting a Single Instrument\\n\\nTo backtest a specific instrument up to a certain date:\\n\\n```python\\nimport datetime\\nfrom django.utils import timezone\\nfrom panel.models import Instrument, Strategy\\n\\n# Get instrument and strategy\\ninst = Instrument.objects.get(product_code='rb')\\nstrategy = Strategy.objects.get(name='2.0')\\n\\n# Set target date\\ntarget_date = timezone.make_aware(datetime.datetime(2021, 12, 31))\\n\\n# Run backtest\\ncalc_history_signal(inst, target_date, strategy)\\n```\\n\\nThis will:\\n- Load all MainBar data for 'rb' up to 2021-12-31\\n- Calculate indicators\\n- Generate signals and trades\\n- Store results in Signal and Trade tables\\n\\n### Backtesting All Strategy Instruments\\n\\nTo backtest all instruments in a strategy:\\n\\n```python\\nimport datetime\\nfrom django.utils import timezone\\n\\n# Set target date\\ntarget_date = timezone.make_aware(datetime.datetime(2021, 12, 31))\\n\\n# Run batch backtest\\ncalc_his_all(target_date)\\n```\\n\\nThis processes all instruments in the \\\"2.0\\\" strategy, resuming from the last incomplete trade if one exists.\\n\\n**Sources:** [trader/utils/__init__.py:500-614]()\\n\\n---\\n\\n## Integration with Live Trading\\n\\nThe historical signal calculation system uses the same logic as live signal generation, ensuring consistency:\\n\\n| Component | Historical | Live |\\n|-----------|-----------|------|\\n| **Entry Conditions** | Trend + breakout | Same |\\n| **Exit Conditions** | ATR-based stop-loss | Same |\\n| **Parameters** | Strategy.param_set | Same |\\n| **Indicators** | ATR, SMA, breakout | Same |\\n| **Signal Types** | BUY, SELL, SELL_SHORT, BUY_COVER | Same |\\n| **Execution Price** | Next bar's open | Market order |\\n| **Data Source** | MainBar (historical) | Real-time quotes |\\n\\nThe key difference is:\\n- **Historical**: Creates signals with `processed=True` and immediately creates Trade records\\n- **Live**: Creates signals with `processed=False`, which are then processed by the trading system\\n\\nThis allows strategies to be validated on historical data before deployment to live trading.\\n\\n**Sources:** [trader/utils/__init__.py:500-601](), [trader/strategy/brother2.py]() (referenced in architecture diagrams)\\n\\n---\\n\\n## Performance Considerations\\n\\n### Memory Usage\\n\\nThe system loads entire price history into a pandas DataFrame:\\n```python\\ndf = to_df(MainBar.objects.filter(...).values_list(...))\\n```\\n\\nFor instruments with long histories (10+ years), this can consume significant memory. Consider:\\n- Limiting the backtest period\\n- Processing in chunks for very long histories\\n\\n### Database Writes\\n\\nEach signal and trade creates a database record. For a complete backtest across multiple years and instruments:\\n- Signals: ~100-500 per instrument per year\\n- Trades: ~50-250 per instrument per year\\n\\nUse `bulk_create()` if optimizing for large-scale backtesting.\\n\\n### Calculation Complexity\\n\\nThe nested loop structure has O(n) complexity for stop-loss calculations:\\n```python\\nfor cur_idx in range(break_n+1, df.shape[0]):  # O(n)\\n    if cur_pos \\u003e 0:\\n        hh = MainBar.objects.filter(...).aggregate(Max('high'))  # O(n) query\\n```\\n\\nFor typical futures data (250 trading days/year), this is acceptable, but could be optimized using rolling calculations.\\n\\n**Sources:** [trader/utils/__init__.py:506-589]()\\n\\n---\\n\\n## Signal Record Fields\\n\\nHistorical signals are created with the following fields:\\n\\n| Field | Type | Description | Example Value |\\n|-------|------|-------------|---------------|\\n| `strategy` | ForeignKey | Associated strategy | Strategy instance |\\n| `instrument` | ForeignKey | Traded instrument | Instrument('rb') |\\n| `code` | CharField | Specific contract | `'rb2201'` |\\n| `type` | CharField | Signal type | `'BUY'`, `'SELL'`, `'SELL_SHORT'`, `'BUY_COVER'` |\\n| `trigger_value` | DecimalField | ATR at signal time | `150.234` |\\n| `price` | DecimalField | Execution price | `4520.000` (next bar's open) |\\n| `volume` | IntegerField | Quantity | `1` |\\n| `trigger_time` | DateTimeField | Signal generation time | Previous bar's datetime |\\n| `priority` | IntegerField | Signal priority | `PriorityType.LOW` |\\n| `processed` | BooleanField | Processing status | `True` (always for historical) |\\n\\nThe `processed=True` flag indicates these are historical simulations, distinguishing them from live signals awaiting execution.\\n\\n**Sources:** [trader/utils/__init__.py:530-583](), [panel/models.py:173-192]()\\n\\n---\\n\\n## Limitations and Considerations\\n\\n### Execution Assumptions\\n\\nThe backtest makes several simplifying assumptions:\\n\\n1. **Fill Guarantee**: All orders are filled at the next bar's opening price\\n2. **No Slippage**: Execution price exactly equals the open price\\n3. **Full Position Size**: Always trades 1 contract (no partial fills)\\n4. **No Transaction Costs**: Fees and commissions are not included in P\\u0026L\\n5. **Infinite Liquidity**: Market impact is not considered\\n\\n### Look-Ahead Bias Prevention\\n\\nThe system prevents look-ahead bias by:\\n- Using `high_line[idx-1]` (previous bar's high) for entry comparison\\n- Calculating signals based on closed bars only\\n- Executing at next bar's open price\\n\\n### Market Conditions\\n\\nHistorical backtests may not accurately reflect:\\n- Extreme volatility events\\n- Market regime changes\\n- Liquidity constraints\\n- Exchange trading halts\\n- Contract rollover costs (handled separately by MainBar basis adjustment)\\n\\n**Sources:** [trader/utils/__init__.py:526-589]()\\n\\n---\\n\\n## Debugging and Validation\\n\\n### Verifying Signal Generation\\n\\nTo check generated signals for an instrument:\\n\\n```python\\nfrom panel.models import Signal, Instrument\\n\\ninst = Instrument.objects.get(product_code='rb')\\nsignals = Signal.objects.filter(\\n    instrument=inst,\\n    processed=True\\n).order_by('trigger_time')\\n\\nfor sig in signals:\\n    print(f\\\"{sig.trigger_time}: {sig.type} @ {sig.price} (ATR: {sig.trigger_value})\\\")\\n```\\n\\n### Analyzing Trade Performance\\n\\nTo analyze backtest results:\\n\\n```python\\nfrom panel.models import Trade\\nfrom django.db.models import Sum, Avg, Count\\n\\ntrades = Trade.objects.filter(\\n    instrument=inst,\\n    close_time__isnull=False\\n)\\n\\nstats = trades.aggregate(\\n    total_trades=Count('id'),\\n    total_profit=Sum('profit'),\\n    avg_profit=Avg('profit')\\n)\\n\\nprint(f\\\"Total Trades: {stats['total_trades']}\\\")\\nprint(f\\\"Total P\\u0026L: {stats['total_profit']}\\\")\\nprint(f\\\"Average P\\u0026L per Trade: {stats['avg_profit']}\\\")\\n```\\n\\n### Comparing Historical vs Live Signals\\n\\nTo ensure consistency between historical and live signal generation:\\n\\n1. Run `calc_history_signal()` for a recent period\\n2. Compare generated signals with those from live trading\\n3. Verify entry/exit prices and timing match\\n4. Check ATR values and breakout levels align\\n\\n**Sources:** [panel/models.py:173-289]()\"])</script><script>self.__next_f.push([1,\"2d:T4100,\"])</script><script>self.__next_f.push([1,\"# CTP API Integration\\n\\n\\u003cdetails\\u003e\\n\\u003csummary\\u003eRelevant source files\\u003c/summary\\u003e\\n\\nThe following files were used as context for generating this wiki page:\\n\\n- [trader/strategy/__init__.py](trader/strategy/__init__.py)\\n- [trader/strategy/brother2.py](trader/strategy/brother2.py)\\n- [trader/utils/error.xml](trader/utils/error.xml)\\n\\n\\u003c/details\\u003e\\n\\n\\n\\nThis document describes how the trader system integrates with the China Futures Trading Platform (CTP) API through a Redis-based message bus architecture. The integration enables asynchronous, non-blocking communication between the trading strategy and the CTP gateway process.\\n\\n**Scope**: This page covers the overall CTP API integration architecture, channel patterns, and core communication mechanisms. For detailed information on specific topics:\\n- Request-response patterns and message flow: see [Request-Response Patterns](#6.1)\\n- Order insertion, cancellation, and lifecycle: see [Order Management](#6.2)\\n- Real-time market data streaming: see [Market Data Handling](#6.3)\\n- CTP error codes and handling strategies: see [Error Codes and Handling](#6.4)\\n\\n## Architecture Overview\\n\\nThe CTP API integration uses Redis Pub/Sub as a message broker to decouple the `TradeStrategy` class from the CTP gateway process. This architecture provides asynchronous, non-blocking operations and enables multiple strategy instances to communicate with a single CTP connection.\\n\\n### CTP Integration Architecture\\n\\n```mermaid\\ngraph TB\\n    subgraph \\\"Trading Strategy Process\\\"\\n        TS[\\\"TradeStrategy\\u003cbr/\\u003e(brother2.py)\\\"]\\n        BaseM[\\\"BaseModule\\u003cbr/\\u003e(__init__.py)\\\"]\\n        RedisClient[\\\"aioredis.Redis\\u003cbr/\\u003easync client\\\"]\\n        RawRedis[\\\"redis.StrictRedis\\u003cbr/\\u003esync client\\\"]\\n    end\\n    \\n    subgraph \\\"Redis Message Bus\\\"\\n        ReqChan[\\\"Request Channels\\u003cbr/\\u003eMSG:CTP:REQ:*\\\"]\\n        TradeRsp[\\\"Trade Response\\u003cbr/\\u003eMSG:CTP:RSP:TRADE:*\\\"]\\n        MarketRsp[\\\"Market Response\\u003cbr/\\u003eMSG:CTP:RSP:MARKET:*\\\"]\\n    end\\n    \\n    subgraph \\\"CTP Gateway Process\\\"\\n        CTPHandler[\\\"CTP API Handler\\u003cbr/\\u003e(separate process)\\\"]\\n        CTPAPI[\\\"CTP C++ API\\\"]\\n    end\\n    \\n    subgraph \\\"Exchange\\\"\\n        Exchange[\\\"Trading Exchange\\u003cbr/\\u003eOrder Execution\\\"]\\n    end\\n    \\n    TS --\\u003e BaseM\\n    BaseM --\\u003e RedisClient\\n    BaseM --\\u003e RawRedis\\n    \\n    RawRedis --\\u003e|publish requests| ReqChan\\n    ReqChan -.-\\u003e|subscribe| CTPHandler\\n    \\n    CTPHandler --\\u003e|publish responses| TradeRsp\\n    CTPHandler --\\u003e|publish responses| MarketRsp\\n    \\n    RedisClient -.-\\u003e|pattern subscribe| TradeRsp\\n    RedisClient -.-\\u003e|pattern subscribe| MarketRsp\\n    \\n    CTPHandler \\u003c--\\u003e CTPAPI\\n    CTPAPI \\u003c--\\u003e Exchange\\n    \\n    TradeRsp --\\u003e|async callbacks| TS\\n    MarketRsp --\\u003e|async callbacks| TS\\n```\\n\\n**Sources**: [trader/strategy/brother2.py:38-63](), [trader/strategy/__init__.py:36-57]()\\n\\nThe integration consists of three main components:\\n\\n1. **TradeStrategy Process**: Contains the trading logic and communicates with Redis\\n2. **Redis Message Bus**: Routes messages between strategy and CTP gateway\\n3. **CTP Gateway Process**: Maintains connection to CTP API and handles exchange communication\\n\\n## Redis Channel Architecture\\n\\nThe system uses structured Redis channel patterns to organize different types of messages. Channels are defined by configuration and follow a consistent naming convention.\\n\\n### Channel Pattern Structure\\n\\n| Channel Type | Pattern | Direction | Purpose |\\n|-------------|---------|-----------|---------|\\n| **Request** | `MSG:CTP:REQ:{Operation}` | Strategy  CTP | Send commands to CTP gateway |\\n| **Trade Response** | `MSG:CTP:RSP:TRADE:{Callback}:{RequestID\\\\|OrderRef}` | CTP  Strategy | Order status, trades, query results |\\n| **Market Response** | `MSG:CTP:RSP:MARKET:{Callback}:{InstrumentID}` | CTP  Strategy | Real-time market data ticks |\\n| **Error Response** | `MSG:CTP:RSP:{TRADE\\\\|MARKET}:OnRspError:{RequestID}` | CTP  Strategy | Error notifications |\\n\\n**Sources**: [trader/strategy/brother2.py:41-43]()\\n\\n### Channel Configuration\\n\\nThe channel format patterns are loaded from `config.ini`:\\n\\n```ini\\n[MSG_CHANNEL]\\nrequest_format = MSG:CTP:REQ:{}\\ntrade_response_format = MSG:CTP:RSP:TRADE:{}:{}\\nmarket_response_format = MSG:CTP:RSP:MARKET:{}:{}\\n```\\n\\nThese patterns are used throughout the code:\\n- `self.__request_format` for publishing requests\\n- `self.__trade_response_format` for subscribing to trade responses\\n- `self.__market_response_format` for subscribing to market data\\n\\n**Sources**: [trader/strategy/brother2.py:41-43]()\\n\\n## Communication Flow\\n\\nThe following diagram illustrates the complete request-response flow for CTP operations:\\n\\n### Request-Response Flow Diagram\\n\\n```mermaid\\nsequenceDiagram\\n    participant TS as TradeStrategy\\n    participant Redis as Redis PubSub\\n    participant CTP as CTP Gateway\\n    participant Exchange as Exchange\\n\\n    Note over TS,Exchange: Query Operation Example\\n    \\n    TS-\\u003e\\u003eTS: Generate RequestID\\n    TS-\\u003e\\u003eRedis: PSUBSCRIBE\\u003cbr/\\u003eMSG:CTP:RSP:TRADE:OnRspQryInstrument:{RequestID}\\n    TS-\\u003e\\u003eRedis: PSUBSCRIBE\\u003cbr/\\u003eMSG:CTP:RSP:TRADE:OnRspError:{RequestID}\\n    \\n    TS-\\u003e\\u003eRedis: PUBLISH MSG:CTP:REQ:ReqQryInstrument\\u003cbr/\\u003e{RequestID, ...params}\\n    \\n    Redis--\\u003e\\u003eCTP: Message forwarded\\n    CTP-\\u003e\\u003eExchange: Query instruments\\n    \\n    loop For each result page\\n        Exchange--\\u003e\\u003eCTP: Result page\\n        CTP-\\u003e\\u003eRedis: PUBLISH MSG:CTP:RSP:TRADE:OnRspQryInstrument:{RequestID}\\u003cbr/\\u003e{data, bIsLast=false}\\n        Redis--\\u003e\\u003eTS: Message delivered\\n    end\\n    \\n    CTP-\\u003e\\u003eRedis: PUBLISH MSG:CTP:RSP:TRADE:OnRspQryInstrument:{RequestID}\\u003cbr/\\u003e{data, bIsLast=true}\\n    Redis--\\u003e\\u003eTS: Final message\\n    \\n    TS-\\u003e\\u003eRedis: PUNSUBSCRIBE\\n    TS-\\u003e\\u003eTS: Return results\\n\\n    Note over TS,Exchange: Order Insertion Example\\n    \\n    TS-\\u003e\\u003eTS: Generate OrderRef from Signal.id\\n    TS-\\u003e\\u003eRedis: PUBLISH MSG:CTP:REQ:ReqOrderInsert\\u003cbr/\\u003e{OrderRef, InstrumentID, ...}\\n    \\n    Redis--\\u003e\\u003eCTP: Message forwarded\\n    CTP-\\u003e\\u003eExchange: Insert order\\n    \\n    Exchange--\\u003e\\u003eCTP: OnRtnOrder (accepted)\\n    CTP-\\u003e\\u003eRedis: PUBLISH MSG:CTP:RSP:TRADE:OnRtnOrder:{OrderRef}\\n    Redis--\\u003e\\u003eTS: Order status update\\n    TS-\\u003e\\u003eTS: @RegisterCallback\\u003cbr/\\u003eOnRtnOrder handler\\n    \\n    Exchange--\\u003e\\u003eCTP: OnRtnTrade (filled)\\n    CTP-\\u003e\\u003eRedis: PUBLISH MSG:CTP:RSP:TRADE:OnRtnTrade:{OrderRef}\\n    Redis--\\u003e\\u003eTS: Trade confirmation\\n    TS-\\u003e\\u003eTS: @RegisterCallback\\u003cbr/\\u003eOnRtnTrade handler\\n```\\n\\n**Sources**: [trader/strategy/brother2.py:220-258](), [trader/strategy/brother2.py:301-343](), [trader/strategy/brother2.py:373-469]()\\n\\n## Core Operations\\n\\nThe `TradeStrategy` class provides methods for three main categories of CTP operations:\\n\\n### Query Operations\\n\\nQuery operations retrieve information from the CTP system (account, positions, instruments, etc.). All queries use the same async pattern with the `query()` method.\\n\\n**Method**: `async def query(self, query_type: str, **kwargs) -\\u003e list`\\n\\n| Query Type | Purpose | Return Value |\\n|-----------|---------|--------------|\\n| `TradingAccount` | Account balance, margin, available funds | Single account dict |\\n| `InvestorPositionDetail` | Detailed position information | List of position dicts |\\n| `Instrument` | Contract specifications | List of instrument dicts |\\n| `InstrumentMarginRate` | Margin rate for specific instrument | Margin rate dict |\\n| `InstrumentCommissionRate` | Commission fee structure | Commission dict |\\n| `Order` | Order status (for recovery on startup) | List of order dicts |\\n\\n**Implementation Pattern**:\\n1. Generate unique `RequestID`\\n2. Subscribe to response channels (both success and error)\\n3. Publish request to CTP gateway\\n4. Wait for paginated results (until `bIsLast=true`)\\n5. Unsubscribe and return aggregated results\\n\\n**Sources**: [trader/strategy/brother2.py:236-258]()\\n\\n### Order Operations\\n\\nOrder operations send trading instructions to the exchange. Orders are identified by `OrderRef`, which encodes both the auto-incrementing order number and the originating signal ID.\\n\\n**Method**: `def ReqOrderInsert(self, sig: Signal) -\\u003e None`\\n\\nOrder insertion is **fire-and-forget** (synchronous publish). Confirmations arrive asynchronously via `OnRtnOrder` and `OnRtnTrade` callbacks.\\n\\n**OrderRef Format**: `{autoid:07d}{signal_id:05d}` (12 digits total)\\n- First 7 digits: `Autonumber.id` (unique sequence)\\n- Last 5 digits: `Signal.id` (links order to originating signal)\\n\\n**Sources**: [trader/strategy/brother2.py:301-343]()\\n\\n### Market Data Operations\\n\\nMarket data operations manage subscriptions to real-time tick data streams.\\n\\n**Methods**:\\n- `async def SubscribeMarketData(self, inst_ids: list) -\\u003e list`\\n- `async def UnSubscribeMarketData(self, inst_ids: list) -\\u003e list`\\n\\nMarket data flows continuously after subscription. Each tick arrives on channel:\\n`MSG:CTP:RSP:MARKET:OnRtnDepthMarketData:{InstrumentID}`\\n\\n**Sources**: [trader/strategy/brother2.py:259-299](), [trader/strategy/brother2.py:373-380]()\\n\\n## Async/Await Integration Model\\n\\nThe integration uses Python's `asyncio` framework for non-blocking I/O operations. The `BaseModule` class provides the async infrastructure.\\n\\n### Event Loop and Redis Clients\\n\\n```mermaid\\ngraph TB\\n    subgraph \\\"BaseModule Initialization\\\"\\n        EventLoop[\\\"asyncio.EventLoop\\u003cbr/\\u003eself.io_loop\\\"]\\n        AsyncRedis[\\\"aioredis.Redis\\u003cbr/\\u003eself.redis_client\\u003cbr/\\u003e(async operations)\\\"]\\n        SyncRedis[\\\"redis.StrictRedis\\u003cbr/\\u003eself.raw_redis\\u003cbr/\\u003e(sync operations)\\\"]\\n        PubSub[\\\"aioredis.PubSub\\u003cbr/\\u003eself.sub_client\\\"]\\n    end\\n    \\n    subgraph \\\"Async Operations\\\"\\n        Query[\\\"query() method\\u003cbr/\\u003easyncio.wait_for\\\"]\\n        Subscribe[\\\"psubscribe()\\u003cbr/\\u003epattern matching\\\"]\\n        Reader[\\\"_msg_reader()\\u003cbr/\\u003easync for loop\\\"]\\n    end\\n    \\n    subgraph \\\"Sync Operations\\\"\\n        Publish[\\\"publish() requests\\u003cbr/\\u003efire-and-forget\\\"]\\n        GetSet[\\\"get/set operations\\u003cbr/\\u003eRedis KV store\\\"]\\n    end\\n    \\n    EventLoop --\\u003e AsyncRedis\\n    EventLoop --\\u003e SyncRedis\\n    AsyncRedis --\\u003e PubSub\\n    \\n    PubSub --\\u003e Subscribe\\n    Subscribe --\\u003e Reader\\n    \\n    AsyncRedis --\\u003e Query\\n    \\n    SyncRedis --\\u003e Publish\\n    SyncRedis --\\u003e GetSet\\n```\\n\\n**Sources**: [trader/strategy/__init__.py:36-57]()\\n\\n### Two Redis Client Pattern\\n\\nThe system uses **two Redis clients** for different purposes:\\n\\n| Client | Type | Use Case | Example |\\n|--------|------|----------|---------|\\n| `self.redis_client` | `aioredis.Redis` | Async operations requiring response | `query()`, `cancel_order()` |\\n| `self.raw_redis` | `redis.StrictRedis` | Sync fire-and-forget operations | `ReqOrderInsert()`, cache get/set |\\n\\n**Rationale**: \\n- Async client enables `await` for operations requiring response\\n- Sync client provides lower latency for fire-and-forget publishes\\n- Separating clients prevents async context contamination\\n\\n**Sources**: [trader/strategy/__init__.py:41-47](), [trader/strategy/brother2.py:223](), [trader/strategy/brother2.py:341]()\\n\\n## Callback Registration System\\n\\nThe `@RegisterCallback` decorator binds methods to Redis channels and cron schedules. Callbacks execute automatically when messages arrive.\\n\\n### Callback Decorator Usage\\n\\n```python\\n@RegisterCallback(channel='MSG:CTP:RSP:TRADE:OnRtnOrder:*')\\nasync def OnRtnOrder(self, channel: str, order: dict):\\n    # Handles order status updates\\n    pass\\n\\n@RegisterCallback(channel='MSG:CTP:RSP:TRADE:OnRtnTrade:*')\\nasync def OnRtnTrade(self, channel: str, trade: dict):\\n    # Handles trade confirmations\\n    pass\\n\\n@RegisterCallback(channel='MSG:CTP:RSP:MARKET:OnRtnDepthMarketData:*')\\nasync def OnRtnDepthMarketData(self, channel: str, tick: dict):\\n    # Handles real-time market ticks\\n    pass\\n```\\n\\n**Channel Parameter**: The `channel` argument contains the full channel name, which can be parsed to extract identifiers (e.g., `OrderRef`, `InstrumentID`).\\n\\n**Pattern Matching**: The `*` wildcard matches any suffix, enabling pattern-based routing.\\n\\n**Sources**: [trader/strategy/brother2.py:373-380](), [trader/strategy/brother2.py:391-469](), [trader/strategy/brother2.py:510-566]()\\n\\n## Timeout and Error Handling\\n\\n### Timeout Configuration\\n\\nAll CTP operations use a configurable timeout to prevent indefinite blocking:\\n\\n```ini\\n[TRADE]\\ncommand_timeout = 10\\n```\\n\\nThe timeout is enforced using `asyncio.wait_for()`:\\n\\n```python\\nawait asyncio.wait_for(task, HANDLER_TIME_OUT)\\n```\\n\\nIf the timeout expires, the operation raises `asyncio.TimeoutError` and the method returns `None`.\\n\\n**Sources**: [trader/strategy/brother2.py:35](), [trader/strategy/brother2.py:248]()\\n\\n### Error Response Handling\\n\\nCTP errors arrive on dedicated error channels:\\n- `MSG:CTP:RSP:TRADE:OnRspError:{RequestID}`\\n- `MSG:CTP:RSP:MARKET:OnRspError:{RequestID}`\\n\\nError responses contain:\\n- `ErrorID`: Numeric error code (see [Error Codes and Handling](#6.4))\\n- `ErrorMsg`: Human-readable error description (Chinese)\\n\\nThe system maps error codes to messages using `error.xml`:\\n\\n```python\\nfrom trader.utils.read_config import ctp_errors\\n\\nif 'ErrorID' in result:\\n    logger.warning(f\\\": {ctp_errors[result['ErrorID']]}\\\")\\n```\\n\\n**Sources**: [trader/strategy/brother2.py:29](), [trader/strategy/brother2.py:362-364](), [trader/utils/error.xml:1-266]()\\n\\n## Configuration Reference\\n\\n### Required Configuration Sections\\n\\n| Section | Key | Description | Default |\\n|---------|-----|-------------|---------|\\n| `MSG_CHANNEL` | `request_format` | Request channel pattern | `MSG:CTP:REQ:{}` |\\n| `MSG_CHANNEL` | `trade_response_format` | Trade response pattern | `MSG:CTP:RSP:TRADE:{}:{}` |\\n| `MSG_CHANNEL` | `market_response_format` | Market response pattern | `MSG:CTP:RSP:MARKET:{}:{}` |\\n| `TRADE` | `command_timeout` | Operation timeout (seconds) | `10` |\\n| `TRADE` | `ignore_inst` | Comma-separated list of products to ignore | `WH,bb,JR,RI,RS,LR,PM,im` |\\n| `REDIS` | `host` | Redis server hostname | `localhost` |\\n| `REDIS` | `port` | Redis server port | `6379` |\\n| `REDIS` | `db` | Redis database number | `0` |\\n\\n**Sources**: [trader/strategy/brother2.py:35](), [trader/strategy/brother2.py:41-44](), [trader/strategy/__init__.py:41-47]()\\n\\n## Message Format\\n\\nAll messages exchanged via Redis are JSON-encoded dictionaries. The CTP gateway process converts between CTP C++ structs and JSON.\\n\\n### Common Message Fields\\n\\n| Field | Type | Description | Present In |\\n|-------|------|-------------|-----------|\\n| `RequestID` | int | Unique request identifier | Queries, errors |\\n| `OrderRef` | string | 12-digit order reference | Orders, trades |\\n| `InstrumentID` | string | Contract code (e.g., `IF2312`) | All operations |\\n| `bIsLast` | bool | Last message in paginated response | Query responses |\\n| `empty` | bool | Indicates empty result | Query responses |\\n| `ErrorID` | int | CTP error code | Error responses |\\n| `ErrorMsg` | string | Error description (Chinese) | Error responses |\\n\\n### Example Message Structures\\n\\n**Query Request**:\\n```json\\n{\\n  \\\"RequestID\\\": 12345\\n}\\n```\\n\\n**Order Insert Request**:\\n```json\\n{\\n  \\\"RequestID\\\": 12346,\\n  \\\"OrderRef\\\": \\\"00001230001\\\",\\n  \\\"InstrumentID\\\": \\\"IF2312\\\",\\n  \\\"VolumeTotalOriginal\\\": 1,\\n  \\\"LimitPrice\\\": 4200.0,\\n  \\\"Direction\\\": \\\"0\\\",\\n  \\\"CombOffsetFlag\\\": \\\"0\\\"\\n}\\n```\\n\\n**Sources**: [trader/strategy/brother2.py:220-224](), [trader/strategy/brother2.py:301-343]()\\n\\n## Connection Lifecycle\\n\\nThe CTP connection is managed by a separate gateway process (not shown in the provided files). The `TradeStrategy` assumes the CTP gateway is already connected and authenticated.\\n\\n### Strategy Startup Sequence\\n\\nWhen `TradeStrategy.start()` executes, it performs the following initialization:\\n\\n1. **Install callbacks**: Register message handlers and cron jobs\\n2. **Set heartbeat**: Update Redis key `HEARTBEAT:TRADER` with 61s expiry\\n3. **Check trading hours**: Only proceed if market is open\\n4. **Refresh account**: Query account balance and margin\\n5. **Query orders**: Retrieve pending orders and cancel if necessary\\n6. **Refresh positions**: Synchronize position data with database\\n\\n**Sources**: [trader/strategy/brother2.py:64-84]()\\n\\n## Integration with Django Models\\n\\nCTP responses are persisted to Django models to maintain state across restarts:\\n\\n| CTP Callback | Django Model | Purpose |\\n|-------------|--------------|---------|\\n| `OnRspQryTradingAccount` | `Broker` | Account balance, margin |\\n| `OnRspQryInvestorPositionDetail` | `Trade` | Open positions |\\n| `OnRtnOrder` | `Order` | Order status |\\n| `OnRtnTrade` | `Trade` | Trade records, P\\u0026L |\\n\\nThis persistence enables the strategy to recover its state after crashes or restarts.\\n\\n**Sources**: [trader/strategy/brother2.py:86-154]()\\n\\n---\\n\\nFor detailed information on specific CTP integration topics:\\n- Message flow patterns and async handling: [Request-Response Patterns](#6.1)\\n- Order lifecycle and error recovery: [Order Management](#6.2)\\n- Market data streaming and tick handling: [Market Data Handling](#6.3)\\n- Complete error code reference: [Error Codes and Handling](#6.4)\"])</script><script>self.__next_f.push([1,\"2e:T5550,\"])</script><script>self.__next_f.push([1,\"# Request-Response Patterns\\n\\n\\u003cdetails\\u003e\\n\\u003csummary\\u003eRelevant source files\\u003c/summary\\u003e\\n\\nThe following files were used as context for generating this wiki page:\\n\\n- [trader/strategy/brother2.py](trader/strategy/brother2.py)\\n- [trader/utils/read_config.py](trader/utils/read_config.py)\\n\\n\\u003c/details\\u003e\\n\\n\\n\\n## Purpose and Scope\\n\\nThis document describes the request-response communication patterns used by the trader system to interact with the CTP (China Futures Trading Platform) API via Redis Pub/Sub. It covers the channel naming conventions, message routing strategies, timeout handling, and specific patterns for queries, order management, and market data subscriptions.\\n\\nFor information about the overall message bus architecture and communication infrastructure, see [Message Bus and Communication](#3.3). For details on order management workflows, see [Order Management](#6.2). For market data handling specifics, see [Market Data Handling](#6.3).\\n\\n---\\n\\n## Architecture Overview\\n\\nThe trader system uses Redis Pub/Sub as a decoupling layer between the trading strategy logic and the CTP API. This enables asynchronous, non-blocking communication and supports multiple strategy instances.\\n\\n### Communication Flow\\n\\n```mermaid\\ngraph TB\\n    subgraph \\\"TradeStrategy Process\\\"\\n        TS[\\\"TradeStrategy\\u003cbr/\\u003e(brother2.py)\\\"]\\n        PC[\\\"PubSub Client\\u003cbr/\\u003e(aioredis)\\\"]\\n    end\\n    \\n    subgraph \\\"Redis Message Bus\\\"\\n        REQ[\\\"Request Channels\\u003cbr/\\u003eMSG:CTP:REQ:*\\\"]\\n        RSP_TRADE[\\\"Trade Response\\u003cbr/\\u003eMSG:CTP:RSP:TRADE:*\\\"]\\n        RSP_MARKET[\\\"Market Response\\u003cbr/\\u003eMSG:CTP:RSP:MARKET:*\\\"]\\n    end\\n    \\n    subgraph \\\"CTP Gateway Process\\\"\\n        HANDLER[\\\"CTP API Handler\\\"]\\n    end\\n    \\n    TS --\\u003e|\\\"1. Publish Request\\u003cbr/\\u003e(RequestID)\\\"| REQ\\n    REQ --\\u003e|\\\"2. Subscribe\\\"| HANDLER\\n    HANDLER --\\u003e|\\\"3. Call CTP API\\\"| CTP_API[\\\"CTP API\\\"]\\n    CTP_API --\\u003e|\\\"4. Response\\\"| HANDLER\\n    HANDLER --\\u003e|\\\"5. Publish Response\\u003cbr/\\u003e(RequestID/OrderRef)\\\"| RSP_TRADE\\n    HANDLER --\\u003e|\\\"5. Publish Response\\\"| RSP_MARKET\\n    RSP_TRADE --\\u003e|\\\"6. Pattern Subscribe\\\"| PC\\n    RSP_MARKET --\\u003e|\\\"6. Pattern Subscribe\\\"| PC\\n    PC --\\u003e|\\\"7. Return Data\\\"| TS\\n```\\n\\n**Sources:** [trader/strategy/brother2.py:236-257](), [trader/utils/read_config.py:23-31]()\\n\\n---\\n\\n## Channel Naming Conventions\\n\\nChannel names follow a hierarchical pattern that enables routing and filtering of messages.\\n\\n### Request Channels\\n\\n| Channel Pattern | Purpose | Example |\\n|----------------|---------|---------|\\n| `MSG:CTP:REQ:{RequestType}` | General request format | `MSG:CTP:REQ:ReqQryTradingAccount` |\\n| `MSG:CTP:REQ:ReqQry{QueryType}` | Query requests | `MSG:CTP:REQ:ReqQryInstrument` |\\n| `MSG:CTP:REQ:ReqOrderInsert` | Order insertion | `MSG:CTP:REQ:ReqOrderInsert` |\\n| `MSG:CTP:REQ:ReqOrderAction` | Order cancellation | `MSG:CTP:REQ:ReqOrderAction` |\\n| `MSG:CTP:REQ:SubscribeMarketData` | Market data subscription | `MSG:CTP:REQ:SubscribeMarketData` |\\n| `MSG:CTP:REQ:UnSubscribeMarketData` | Market data unsubscription | `MSG:CTP:REQ:UnSubscribeMarketData` |\\n\\n### Response Channels\\n\\n| Channel Pattern | Purpose | Routing Key |\\n|----------------|---------|-------------|\\n| `MSG:CTP:RSP:TRADE:{ResponseType}:{RequestID}` | Trade responses (queries, actions) | `RequestID` |\\n| `MSG:CTP:RSP:TRADE:OnRtnOrder:{OrderRef}` | Order status updates | `OrderRef` |\\n| `MSG:CTP:RSP:TRADE:OnRtnTrade:{OrderRef}` | Trade confirmations | `OrderRef` |\\n| `MSG:CTP:RSP:MARKET:{ResponseType}:{RequestID}` | Market data responses | `RequestID` or `0` |\\n| `MSG:CTP:RSP:MARKET:OnRtnDepthMarketData:{InstrumentID}` | Real-time tick data | `InstrumentID` |\\n\\n**Sources:** [trader/utils/read_config.py:23-31](), [trader/strategy/brother2.py:41-43]()\\n\\n---\\n\\n## Request-Response Pattern Types\\n\\n### Pattern 1: Query Request-Response\\n\\nThis pattern is used for querying account information, positions, instruments, margin rates, and commission rates. It employs a blocking wait with timeout.\\n\\n```mermaid\\nsequenceDiagram\\n    participant TS as TradeStrategy\\n    participant PC as PubSub Client\\n    participant Redis as Redis\\n    participant CTP as CTP Gateway\\n    \\n    Note over TS: query('TradingAccount')\\n    TS-\\u003e\\u003ePC: pubsub(ignore_subscribe_messages=True)\\n    TS-\\u003e\\u003eTS: request_id = get_next_id()\\n    TS-\\u003e\\u003ePC: psubscribe('MSG:CTP:RSP:TRADE:OnRspQryTradingAccount:{request_id}')\\n    TS-\\u003e\\u003ePC: psubscribe('MSG:CTP:RSP:TRADE:OnRspError:{request_id}')\\n    TS-\\u003e\\u003eRedis: publish('MSG:CTP:REQ:ReqQryTradingAccount', {'RequestID': request_id})\\n    \\n    par Background Task\\n        PC-\\u003e\\u003ePC: query_reader() listens\\n    end\\n    \\n    CTP-\\u003e\\u003eRedis: Response messages (multiple if bIsLast=false)\\n    Redis-\\u003e\\u003ePC: Matched by pattern\\n    PC-\\u003e\\u003eTS: task.result() with list of responses\\n    TS-\\u003e\\u003ePC: punsubscribe()\\n    TS-\\u003e\\u003ePC: close()\\n    TS-\\u003e\\u003eTS: return result\\n```\\n\\n#### Implementation Details\\n\\nThe `query()` method implements this pattern:\\n\\n| Step | Action | Code Reference |\\n|------|--------|----------------|\\n| 1 | Create temporary pubsub client | [trader/strategy/brother2.py:240]() |\\n| 2 | Generate unique RequestID | [trader/strategy/brother2.py:241-242]() |\\n| 3 | Subscribe to response channels with pattern | [trader/strategy/brother2.py:243-245]() |\\n| 4 | Create async reader task | [trader/strategy/brother2.py:246]() |\\n| 5 | Publish request with RequestID | [trader/strategy/brother2.py:247]() |\\n| 6 | Wait for response with timeout | [trader/strategy/brother2.py:248]() |\\n| 7 | Clean up subscription | [trader/strategy/brother2.py:249-250]() |\\n\\nThe `query_reader()` helper accumulates multiple messages until `bIsLast=True`:\\n\\n```python\\n# Simplified logic from trader/strategy/brother2.py:226-234\\nasync def query_reader(pb: aioredis.client.PubSub):\\n    msg_list = []\\n    async for msg in pb.listen():\\n        msg_dict = json.loads(msg['data'])\\n        if 'empty' not in msg_dict or not msg_dict['empty']:\\n            msg_list.append(msg_dict)\\n        if 'bIsLast' not in msg_dict or msg_dict['bIsLast']:\\n            return msg_list\\n```\\n\\n**Sources:** [trader/strategy/brother2.py:236-257](), [trader/strategy/brother2.py:226-234]()\\n\\n---\\n\\n### Pattern 2: Fire-and-Forget Order Insert\\n\\nOrder insertion uses a fire-and-forget pattern where the request is published without waiting for immediate confirmation. Responses arrive asynchronously through callback handlers.\\n\\n```mermaid\\nsequenceDiagram\\n    participant TS as TradeStrategy\\n    participant Redis as Redis\\n    participant CTP as CTP Gateway\\n    participant CB as Callback Handler\\n    \\n    Note over TS: ReqOrderInsert(signal)\\n    TS-\\u003e\\u003eTS: generate order_ref from Autonumber \\u0026 signal.id\\n    TS-\\u003e\\u003eTS: build param_dict with order params\\n    TS-\\u003e\\u003eRedis: publish('MSG:CTP:REQ:ReqOrderInsert', param_dict)\\n    Note over TS: Function returns immediately\\n    \\n    CTP-\\u003e\\u003eRedis: publish('MSG:CTP:RSP:TRADE:OnRtnOrder:{order_ref}', order_status)\\n    Redis-\\u003e\\u003eCB: @RegisterCallback matches pattern\\n    CB-\\u003e\\u003eCB: OnRtnOrder() saves order\\n    \\n    alt Order Filled\\n        CTP-\\u003e\\u003eRedis: publish('MSG:CTP:RSP:TRADE:OnRtnTrade:{order_ref}', trade_data)\\n        Redis-\\u003e\\u003eCB: @RegisterCallback matches pattern\\n        CB-\\u003e\\u003eCB: OnRtnTrade() updates trade record\\n    end\\n```\\n\\n#### Order Reference Generation\\n\\nThe system generates unique `OrderRef` values by combining auto-incrementing ID and signal ID:\\n\\n```python\\n# From trader/strategy/brother2.py:304-305\\nautoid = Autonumber.objects.create()\\norder_ref = f\\\"{autoid.id:07}{sig.id:05}\\\"\\n```\\n\\nFormat: `{Autonumber:7 digits}{SignalID:5 digits}` (12 digits total)\\n\\nThis allows:\\n- Routing responses back to the originating strategy instance\\n- Linking orders to trading signals for tracking\\n- Distinguishing manual trades (order_ref \\u003c 10000) from automated trades\\n\\n**Sources:** [trader/strategy/brother2.py:301-343](), [trader/strategy/brother2.py:391-469](), [trader/strategy/brother2.py:510-566]()\\n\\n---\\n\\n### Pattern 3: Order Action (Cancel) with Confirmation\\n\\nOrder cancellation follows a hybrid pattern that publishes a request and waits for confirmation from multiple response channels.\\n\\n```mermaid\\nsequenceDiagram\\n    participant TS as TradeStrategy\\n    participant PC as PubSub Client\\n    participant Redis as Redis\\n    participant CTP as CTP Gateway\\n    \\n    Note over TS: cancel_order(order_dict)\\n    TS-\\u003e\\u003ePC: pubsub(ignore_subscribe_messages=True)\\n    TS-\\u003e\\u003eTS: request_id = get_next_id()\\n    TS-\\u003e\\u003ePC: psubscribe('MSG:CTP:RSP:TRADE:OnRtnOrder:{order_ref}')\\n    TS-\\u003e\\u003ePC: psubscribe('MSG:CTP:RSP:TRADE:OnRspOrderAction:0')\\n    TS-\\u003e\\u003ePC: psubscribe('MSG:CTP:RSP:TRADE:OnRspError:{request_id}')\\n    TS-\\u003e\\u003eRedis: publish('MSG:CTP:REQ:ReqOrderAction', order_dict)\\n    \\n    par Background Task\\n        PC-\\u003e\\u003ePC: query_reader() listens\\n    end\\n    \\n    alt Success\\n        CTP-\\u003e\\u003eRedis: OnRspOrderAction or OnRtnOrder\\n        Redis-\\u003e\\u003ePC: Matched response\\n        PC-\\u003e\\u003eTS: result[0] without ErrorID\\n        TS-\\u003e\\u003eTS: return True\\n    else Error\\n        CTP-\\u003e\\u003eRedis: OnRspError with ErrorID\\n        Redis-\\u003e\\u003ePC: Matched error\\n        PC-\\u003e\\u003eTS: result[0] with ErrorID\\n        TS-\\u003e\\u003eTS: log error, return False\\n    end\\n    \\n    TS-\\u003e\\u003ePC: punsubscribe()\\n    TS-\\u003e\\u003ePC: close()\\n```\\n\\n#### Multi-Channel Subscription Strategy\\n\\nThe cancel operation subscribes to three channels simultaneously:\\n\\n| Channel | Purpose | When Published |\\n|---------|---------|----------------|\\n| `OnRtnOrder:{order_ref}` | Order status update | When order state changes |\\n| `OnRspOrderAction:0` | Action confirmation | Immediate response to action |\\n| `OnRspError:{request_id}` | Error response | If action fails |\\n\\nThis ensures the system receives confirmation regardless of which response type the CTP API sends first.\\n\\n**Sources:** [trader/strategy/brother2.py:345-371]()\\n\\n---\\n\\n### Pattern 4: Market Data Subscription\\n\\nMarket data subscriptions use a request-response pattern similar to queries but with specific response routing.\\n\\n```mermaid\\nsequenceDiagram\\n    participant TS as TradeStrategy\\n    participant PC as PubSub Client\\n    participant Redis as Redis\\n    participant CTP as CTP Gateway\\n    \\n    Note over TS: SubscribeMarketData(['IF2312', 'IC2312'])\\n    TS-\\u003e\\u003ePC: pubsub(ignore_subscribe_messages=True)\\n    TS-\\u003e\\u003ePC: psubscribe('MSG:CTP:RSP:MARKET:OnRspSubMarketData:0')\\n    TS-\\u003e\\u003ePC: psubscribe('MSG:CTP:RSP:MARKET:OnRspError:0')\\n    TS-\\u003e\\u003eRedis: publish('MSG:CTP:REQ:SubscribeMarketData', ['IF2312', 'IC2312'])\\n    \\n    CTP-\\u003e\\u003eRedis: OnRspSubMarketData (one per instrument)\\n    Redis-\\u003e\\u003ePC: Matched responses\\n    PC-\\u003e\\u003eTS: list of subscription confirmations\\n    TS-\\u003e\\u003ePC: punsubscribe()\\n    TS-\\u003e\\u003ePC: close()\\n    \\n    Note over TS,CTP: After subscription established\\n    loop Real-time ticks\\n        CTP-\\u003e\\u003eRedis: publish('MSG:CTP:RSP:MARKET:OnRtnDepthMarketData:IF2312', tick)\\n        Redis-\\u003e\\u003eTS: @RegisterCallback receives tick\\n        TS-\\u003e\\u003eTS: OnRtnDepthMarketData() processes tick\\n    end\\n```\\n\\n#### Subscribe vs. Real-time Data\\n\\nThe pattern distinguishes between:\\n\\n1. **Subscription Confirmation** (RequestID=0):\\n   - Response channel: `MSG:CTP:RSP:MARKET:OnRspSubMarketData:0`\\n   - Confirms subscription was accepted\\n   - Returns list of subscribed instruments\\n\\n2. **Real-time Market Data** (InstrumentID routing):\\n   - Response channel: `MSG:CTP:RSP:MARKET:OnRtnDepthMarketData:{InstrumentID}`\\n   - Continuous stream after subscription\\n   - Handled by callback decorator\\n\\n**Sources:** [trader/strategy/brother2.py:259-299](), [trader/strategy/brother2.py:373-380]()\\n\\n---\\n\\n## Message Format and Structure\\n\\n### Request Message Structure\\n\\nAll requests are JSON-encoded dictionaries published to request channels:\\n\\n```json\\n{\\n  \\\"RequestID\\\": 12345,\\n  \\\"InstrumentID\\\": \\\"IF2312\\\",\\n  \\\"VolumeTotalOriginal\\\": 1,\\n  \\\"LimitPrice\\\": 4230.5,\\n  \\\"Direction\\\": \\\"0\\\",\\n  \\\"CombOffsetFlag\\\": \\\"0\\\"\\n}\\n```\\n\\n**Required Fields:**\\n- `RequestID`: Unique integer for routing responses (generated by `get_next_id()`)\\n- Request-specific fields vary by request type\\n\\n### Response Message Structure\\n\\nResponse messages include additional metadata:\\n\\n```json\\n{\\n  \\\"RequestID\\\": 12345,\\n  \\\"InstrumentID\\\": \\\"IF2312\\\",\\n  \\\"Balance\\\": 1000000.0,\\n  \\\"Available\\\": 850000.0,\\n  \\\"empty\\\": false,\\n  \\\"bIsLast\\\": true\\n}\\n```\\n\\n**Common Fields:**\\n- `empty`: Boolean indicating if this is a placeholder response\\n- `bIsLast`: Boolean indicating this is the final response in a sequence\\n- `ErrorID`: Integer error code (if error occurred)\\n- `ErrorMsg`: String error message (if error occurred)\\n\\n### Multi-Message Responses\\n\\nSome queries return multiple messages (e.g., querying all instruments). The `query_reader()` accumulates messages until receiving one with `bIsLast=True`:\\n\\n| Query Type | Typical Response Count |\\n|------------|------------------------|\\n| `TradingAccount` | 1 (always single) |\\n| `Instrument` | 500+ (one per instrument) |\\n| `InvestorPositionDetail` | 0-100+ (one per position) |\\n| `Order` | 0-50+ (one per order) |\\n\\n**Sources:** [trader/strategy/brother2.py:226-234](), [trader/strategy/brother2.py:236-257]()\\n\\n---\\n\\n## Timeout and Error Handling\\n\\n### Timeout Configuration\\n\\nAll blocking request-response operations use a configurable timeout:\\n\\n```python\\n# From config.ini\\n[TRADE]\\ncommand_timeout = 5  # seconds (default: 10)\\n```\\n\\nImplementation uses `asyncio.wait_for()`:\\n\\n```python\\n# From trader/strategy/brother2.py:248\\nawait asyncio.wait_for(task, HANDLER_TIME_OUT)\\n```\\n\\n**Sources:** [trader/strategy/brother2.py:35](), [trader/utils/read_config.py:34]()\\n\\n### Error Handling Strategy\\n\\n```mermaid\\ngraph TD\\n    REQ[\\\"Request Published\\\"]\\n    WAIT[\\\"Wait for Response\\u003cbr/\\u003e(with timeout)\\\"]\\n    RECV[\\\"Response Received\\\"]\\n    CHK_ERR{\\\"ErrorID present?\\\"}\\n    CHK_EMPTY{\\\"empty=true?\\\"}\\n    LOG_ERR[\\\"Log Error\\u003cbr/\\u003ewith ctp_errors lookup\\\"]\\n    LOG_WARN[\\\"Log Warning\\u003cbr/\\u003eOperation failed\\\"]\\n    CLEANUP[\\\"Cleanup:\\u003cbr/\\u003eunsubscribe, close\\\"]\\n    SUCCESS[\\\"Return Result\\\"]\\n    FAIL[\\\"Return None/False\\\"]\\n    \\n    REQ --\\u003e WAIT\\n    WAIT --\\u003e|Timeout Exception| LOG_WARN\\n    WAIT --\\u003e|Data Received| RECV\\n    RECV --\\u003e CHK_EMPTY\\n    CHK_EMPTY --\\u003e|Yes| WAIT\\n    CHK_EMPTY --\\u003e|No| CHK_ERR\\n    CHK_ERR --\\u003e|Yes| LOG_ERR\\n    CHK_ERR --\\u003e|No| SUCCESS\\n    LOG_ERR --\\u003e CLEANUP\\n    LOG_WARN --\\u003e CLEANUP\\n    SUCCESS --\\u003e CLEANUP\\n    CLEANUP --\\u003e FAIL\\n    CLEANUP --\\u003e SUCCESS\\n```\\n\\n#### Error Code Lookup\\n\\nThe system maintains a mapping of CTP error codes loaded from `error.xml`:\\n\\n```python\\n# From trader/utils/read_config.py:74-78\\nctp_errors = {}\\nfor error in ET.parse(ctp_xml_path).getroot():\\n    ctp_errors[int(error.attrib['value'])] = error.attrib['prompt']\\n```\\n\\nExample usage in error handling:\\n\\n```python\\n# From trader/strategy/brother2.py:362-363\\nif 'ErrorID' in result:\\n    logger.warning(f\\\": {ctp_errors[result['ErrorID']]}\\\")\\n```\\n\\n**Sources:** [trader/strategy/brother2.py:252-257](), [trader/strategy/brother2.py:362-363](), [trader/utils/read_config.py:74-78]()\\n\\n---\\n\\n## Pattern Subscription and Callback Routing\\n\\n### Pattern-Based Subscriptions\\n\\nThe system uses Redis pattern subscriptions (`psubscribe`) to match multiple channels:\\n\\n```python\\n# From trader/strategy/brother2.py:245\\nawait sub_client.psubscribe(channel_rsp_qry, channel_rsp_err)\\n```\\n\\n**Pattern Examples:**\\n- `MSG:CTP:RSP:TRADE:OnRspQryInstrument:*` - Matches any RequestID\\n- `MSG:CTP:RSP:TRADE:OnRtnTrade:*` - Matches any OrderRef\\n- `MSG:CTP:RSP:MARKET:OnRtnDepthMarketData:*` - Matches any InstrumentID\\n\\n### Callback Decorator Registration\\n\\nThe `@RegisterCallback` decorator enables automatic routing of Redis messages to handler methods:\\n\\n```python\\n# From trader/strategy/brother2.py:373, 391, 510\\n@RegisterCallback(channel='MSG:CTP:RSP:MARKET:OnRtnDepthMarketData:*')\\nasync def OnRtnDepthMarketData(self, channel, tick: dict):\\n    # Process tick data\\n    \\n@RegisterCallback(channel='MSG:CTP:RSP:TRADE:OnRtnTrade:*')\\nasync def OnRtnTrade(self, channel, trade: dict):\\n    # Process trade confirmation\\n    \\n@RegisterCallback(channel='MSG:CTP:RSP:TRADE:OnRtnOrder:*')\\nasync def OnRtnOrder(self, _: str, order: dict):\\n    # Process order status update\\n```\\n\\nThe decorator handles:\\n- Pattern matching against channel names\\n- JSON deserialization of message data\\n- Asynchronous invocation of handler methods\\n- Error isolation (one handler failure doesn't affect others)\\n\\n**Sources:** [trader/strategy/brother2.py:373-380](), [trader/strategy/brother2.py:391-469](), [trader/strategy/brother2.py:510-566]()\\n\\n---\\n\\n## Request-Response Pattern Examples\\n\\n### Example 1: Query Account Information\\n\\n```python\\n# Usage from trader/strategy/brother2.py:89\\naccount = await self.query('TradingAccount')\\naccount = account[0]  # Single response\\n\\n# Extracts:\\n# - Balance, Available cash\\n# - PreBalance (yesterday's equity)\\n# - CloseProfit, PositionProfit\\n# - Commission, CurrMargin\\n```\\n\\n**Channel Flow:**\\n1. Request: `MSG:CTP:REQ:ReqQryTradingAccount` with `{\\\"RequestID\\\": 12345}`\\n2. Response: `MSG:CTP:RSP:TRADE:OnRspQryTradingAccount:12345` with account data\\n\\n### Example 2: Query Positions\\n\\n```python\\n# Usage from trader/strategy/brother2.py:117\\npos_list = await self.query('InvestorPositionDetail')\\n\\n# Returns list of positions:\\n# [\\n#   {\\\"InstrumentID\\\": \\\"IF2312\\\", \\\"Direction\\\": \\\"0\\\", \\\"Volume\\\": 2, ...},\\n#   {\\\"InstrumentID\\\": \\\"IC2312\\\", \\\"Direction\\\": \\\"1\\\", \\\"Volume\\\": 1, ...}\\n# ]\\n```\\n\\n**Channel Flow:**\\n1. Request: `MSG:CTP:REQ:ReqQryInvestorPositionDetail` with `{\\\"RequestID\\\": 12346}`\\n2. Responses: Multiple messages to `MSG:CTP:RSP:TRADE:OnRspQryInvestorPositionDetail:12346`\\n3. Accumulated until `bIsLast=True`\\n\\n### Example 3: Query Instrument Details\\n\\n```python\\n# Usage from trader/strategy/brother2.py:160\\ninst_list = await self.query('Instrument')\\n\\n# Returns list of tradable instruments:\\n# [\\n#   {\\\"InstrumentID\\\": \\\"IF2312\\\", \\\"ProductID\\\": \\\"IF\\\", \\\"VolumeMultiple\\\": 300, ...},\\n#   {\\\"InstrumentID\\\": \\\"IC2312\\\", \\\"ProductID\\\": \\\"IC\\\", \\\"VolumeMultiple\\\": 200, ...},\\n#   ...  # 500+ instruments\\n# ]\\n```\\n\\n### Example 4: Query Margin Rate\\n\\n```python\\n# Usage from trader/strategy/brother2.py:188\\nmargin_rate = await self.query('InstrumentMarginRate', InstrumentID=inst.main_code)\\nmargin_rate = margin_rate[0]['LongMarginRatioByMoney']\\n\\n# Request includes additional parameter: InstrumentID\\n```\\n\\n**Channel Flow:**\\n1. Request: `MSG:CTP:REQ:ReqQryInstrumentMarginRate` with `{\\\"RequestID\\\": 12347, \\\"InstrumentID\\\": \\\"IF2312\\\"}`\\n2. Response: `MSG:CTP:RSP:TRADE:OnRspQryInstrumentMarginRate:12347` with margin data\\n\\n### Example 5: Insert Order\\n\\n```python\\n# Usage from trader/strategy/brother2.py:302-341\\nself.ReqOrderInsert(signal)\\n\\n# Builds order parameters:\\nparam_dict = {\\n    'RequestID': request_id,\\n    'OrderRef': '00000120001',  # Auto-generated\\n    'InstrumentID': 'IF2312',\\n    'VolumeTotalOriginal': 1,\\n    'LimitPrice': 4230.5,\\n    'Direction': '0',  # Buy\\n    'CombOffsetFlag': '0'  # Open\\n}\\n\\n# Publishes to: MSG:CTP:REQ:ReqOrderInsert\\n# Response arrives via callback: OnRtnOrder, OnRtnTrade\\n```\\n\\n### Example 6: Cancel Order\\n\\n```python\\n# Usage from trader/strategy/brother2.py:77, 345-371\\nresult = await self.cancel_order(order_dict)\\n\\nif result:\\n    logger.info(\\\"Order cancelled successfully\\\")\\nelse:\\n    logger.warning(\\\"Order cancellation failed\\\")\\n```\\n\\n**Channel Flow:**\\n1. Request: `MSG:CTP:REQ:ReqOrderAction` with order details\\n2. Responses (any of):\\n   - `MSG:CTP:RSP:TRADE:OnRtnOrder:{order_ref}` (status update)\\n   - `MSG:CTP:RSP:TRADE:OnRspOrderAction:0` (action confirmation)\\n   - `MSG:CTP:RSP:TRADE:OnRspError:{request_id}` (error)\\n\\n**Sources:** [trader/strategy/brother2.py:86-112](), [trader/strategy/brother2.py:114-154](), [trader/strategy/brother2.py:156-205](), [trader/strategy/brother2.py:301-343](), [trader/strategy/brother2.py:345-371]()\\n\\n---\\n\\n## Asynchronous Operation Details\\n\\n### PubSub Client Lifecycle\\n\\nEach request-response operation follows a strict lifecycle:\\n\\n| Phase | Action | Purpose |\\n|-------|--------|---------|\\n| 1. Create | `self.redis_client.pubsub(ignore_subscribe_messages=True)` | Isolates operation from global subscriptions |\\n| 2. Subscribe | `await sub_client.psubscribe(channels...)` | Register interest in response patterns |\\n| 3. Start Task | `asyncio.create_task(self.query_reader(sub_client))` | Begin listening for responses |\\n| 4. Publish | `self.raw_redis.publish(channel, message)` | Send request |\\n| 5. Wait | `await asyncio.wait_for(task, timeout)` | Block until response or timeout |\\n| 6. Cleanup | `await sub_client.punsubscribe(); await sub_client.close()` | Release resources |\\n\\n### Connection Pool Management\\n\\nThe system maintains two Redis clients:\\n\\n1. **`self.redis_client`** (aioredis): Async client for pubsub operations\\n2. **`self.raw_redis`** (redis-py): Synchronous client for publish operations\\n\\nThis separation ensures:\\n- Publish operations don't block on subscriptions\\n- Temporary pubsub clients don't affect global subscriptions\\n- Fire-and-forget operations use synchronous client for efficiency\\n\\n**Sources:** [trader/strategy/brother2.py:236-257](), [trader/strategy/brother2.py:240](), [trader/strategy/brother2.py:247]()\\n\\n---\\n\\n## Summary\\n\\nThe trader system implements four distinct request-response patterns:\\n\\n| Pattern | Blocking | Timeout | Response Routing | Use Cases |\\n|---------|----------|---------|------------------|-----------|\\n| Query Request-Response | Yes | Configurable | RequestID | Account, positions, instruments |\\n| Fire-and-Forget | No | N/A | OrderRef callback | Order insertion |\\n| Action with Confirmation | Yes | Configurable | RequestID + OrderRef | Order cancellation |\\n| Market Data Subscription | Initial blocking | Configurable | RequestID  InstrumentID stream | Market data |\\n\\nAll patterns leverage:\\n- **Redis pattern subscriptions** for flexible routing\\n- **Unique identifiers** (RequestID, OrderRef) for message correlation\\n- **Temporary pubsub clients** for isolated operations\\n- **Callback decorators** for asynchronous event handling\\n- **Timeout protection** to prevent indefinite blocking\\n\\nThis architecture enables the trading system to maintain multiple concurrent operations while ensuring reliable message delivery and proper error handling.\\n\\n**Sources:** [trader/strategy/brother2.py:220-371](), [trader/utils/read_config.py:23-31]()\"])</script><script>self.__next_f.push([1,\"2f:T51a4,\"])</script><script>self.__next_f.push([1,\"# Order Management\\n\\n\\u003cdetails\\u003e\\n\\u003csummary\\u003eRelevant source files\\u003c/summary\\u003e\\n\\nThe following files were used as context for generating this wiki page:\\n\\n- [panel/const.py](panel/const.py)\\n- [panel/models.py](panel/models.py)\\n- [trader/strategy/brother2.py](trader/strategy/brother2.py)\\n\\n\\u003c/details\\u003e\\n\\n\\n\\n## Purpose and Scope\\n\\nThis page documents the order management system within the CTP API integration layer. Order management encompasses the complete lifecycle of trading orders: insertion, status tracking, cancellation, trade confirmation, and error handling. The system bridges trading signals generated by strategies with actual order execution through the CTP trading platform via Redis messaging.\\n\\nFor information about how orders are triggered by trading signals, see [Signal Generation](#4.3). For details on the Redis communication patterns used, see [Request-Response Patterns](#6.1). For handling CTP-specific error codes, see [Error Codes and Handling](#6.4).\\n\\n## Order Lifecycle Overview\\n\\nThe order management system follows a structured lifecycle from signal generation to final execution:\\n\\n```mermaid\\nstateDiagram-v2\\n    [*] --\\u003e SignalGenerated: calc_signal()\\n    SignalGenerated --\\u003e OrderInserted: ReqOrderInsert()\\n    OrderInserted --\\u003e OrderAccepted: OnRtnOrder (OSS_Accepted)\\n    OrderAccepted --\\u003e PartiallyFilled: OnRtnTrade\\n    OrderAccepted --\\u003e FullyFilled: OnRtnTrade\\n    OrderAccepted --\\u003e Cancelled: cancel_order()\\n    OrderAccepted --\\u003e Rejected: OnRtnOrder (InsertRejected)\\n    PartiallyFilled --\\u003e FullyFilled: OnRtnTrade\\n    PartiallyFilled --\\u003e Cancelled: cancel_order()\\n    FullyFilled --\\u003e TradeRecorded: save_order()\\n    Rejected --\\u003e OrderReinserted: Price adjustment\\n    Cancelled --\\u003e [*]\\n    TradeRecorded --\\u003e [*]\\n```\\n\\n**Sources:** [trader/strategy/brother2.py:301-871]()\\n\\n## Order Insertion Process\\n\\n### Order Request Generation\\n\\nOrders are created through the `ReqOrderInsert` method, which converts a `Signal` object into a CTP-compatible order request. The method generates a unique `OrderRef` identifier combining an auto-incrementing sequence number and the signal ID.\\n\\n```mermaid\\nflowchart TD\\n    Signal[\\\"Signal Model\\u003cbr/\\u003e(code, type, volume, price)\\\"] --\\u003e GenOrderRef[\\\"Generate OrderRef\\u003cbr/\\u003eAutonumber.id + Signal.id\\\"]\\n    GenOrderRef --\\u003e BuildParams[\\\"Build Order Parameters\\u003cbr/\\u003eparam_dict\\\"]\\n    BuildParams --\\u003e CheckType{\\\"Signal Type?\\\"}\\n    \\n    CheckType --\\u003e|\\\"BUY/SELL_SHORT\\\"| SetOpen[\\\"Direction: D_Buy/D_Sell\\u003cbr/\\u003eCombOffsetFlag: OF_Open\\\"]\\n    CheckType --\\u003e|\\\"BUY_COVER/SELL\\\"| QueryPos[\\\"Query Trade Position\\u003cbr/\\u003eclose_time__isnull=True\\\"]\\n    CheckType --\\u003e|\\\"ROLL_CLOSE\\\"| QueryRollPos[\\\"Query Position to Close\\u003cbr/\\u003eshares=sig.volume\\\"]\\n    CheckType --\\u003e|\\\"ROLL_OPEN\\\"| QueryNewPos[\\\"Query Last Main Position\\\"]\\n    \\n    QueryPos --\\u003e CheckExchange{\\\"Exchange\\u003cbr/\\u003e== SHFE?\\\"}\\n    CheckExchange --\\u003e|\\\"Yes + Same Day\\\"| SetCloseToday[\\\"CombOffsetFlag: OF_CloseToday\\\"]\\n    CheckExchange --\\u003e|\\\"No or Different Day\\\"| SetClose[\\\"CombOffsetFlag: OF_Close\\\"]\\n    \\n    QueryRollPos --\\u003e SetRollClose[\\\"CombOffsetFlag: OF_Close\\u003cbr/\\u003eDirection: Opposite of position\\\"]\\n    QueryNewPos --\\u003e SetRollOpen[\\\"CombOffsetFlag: OF_Open\\u003cbr/\\u003eDirection: Same as old position\\\"]\\n    \\n    SetOpen --\\u003e Publish[\\\"Publish to Redis\\u003cbr/\\u003eMSG:CTP:REQ:ReqOrderInsert\\\"]\\n    SetClose --\\u003e Publish\\n    SetCloseToday --\\u003e Publish\\n    SetRollClose --\\u003e Publish\\n    SetRollOpen --\\u003e Publish\\n```\\n\\n**OrderRef Format:**\\n- 7 digits: `Autonumber.id` (auto-incrementing sequence)\\n- 5 digits: `Signal.id` (starting from position 7)\\n- Total: 12-digit unique identifier\\n\\n**Key Parameters Mapping:**\\n\\n| Signal Type | CTP Direction | CTP CombOffsetFlag | Special Logic |\\n|------------|---------------|-------------------|---------------|\\n| `BUY` | `D_Buy` | `OF_Open` | None |\\n| `SELL_SHORT` | `D_Sell` | `OF_Open` | None |\\n| `SELL` | `D_Sell` | `OF_Close` or `OF_CloseToday` | SHFE exchange checks same-day open |\\n| `BUY_COVER` | `D_Buy` | `OF_Close` or `OF_CloseToday` | SHFE exchange checks same-day open |\\n| `ROLL_CLOSE` | Opposite of position | `OF_Close` or `OF_CloseToday` | Closes old contract during rollover |\\n| `ROLL_OPEN` | Same as position | `OF_Open` | Opens new contract during rollover |\\n\\n**Sources:** [trader/strategy/brother2.py:301-343](), [panel/models.py:173-191](), [panel/const.py:70-88]()\\n\\n### Shanghai Exchange Special Handling\\n\\nThe Shanghai Futures Exchange (SHFE) requires distinction between closing positions opened today (`OF_CloseToday`) versus positions opened on previous days (`OF_Close`). The system automatically determines this based on the position's `open_time`:\\n\\n```python\\n# Pseudocode from lines 324-325, 331-332\\nif pos.open_time.date() == today.date() and pos.instrument.exchange == ExchangeType.SHFE:\\n    param_dict['CombOffsetFlag'] = ApiStruct.OF_CloseToday\\n```\\n\\n**Sources:** [trader/strategy/brother2.py:324-332]()\\n\\n## Order Status Tracking\\n\\n### OnRtnOrder Callback\\n\\nOrder status updates are received asynchronously through the `OnRtnOrder` callback, subscribed to the Redis channel pattern `MSG:CTP:RSP:TRADE:OnRtnOrder:*`. The callback processes three primary scenarios:\\n\\n1. **Successful Order Acceptance** - Order enters exchange queue\\n2. **Order Rejection** - Order rejected by exchange (price limits, etc.)\\n3. **Order Cancellation** - Previously submitted order is cancelled\\n\\n```mermaid\\nflowchart TD\\n    RedisMsg[\\\"Redis Channel\\u003cbr/\\u003eMSG:CTP:RSP:TRADE:OnRtnOrder:{OrderRef}\\\"] --\\u003e CheckLen{\\\"InstrumentID\\u003cbr/\\u003elength \\u003e 6?\\\"}\\n    CheckLen --\\u003e|\\\"Yes\\\"| Skip[\\\"Skip (non-standard contract)\\\"]\\n    CheckLen --\\u003e|\\\"No\\\"| CheckSysID{\\\"OrderSysID\\u003cbr/\\u003eexists?\\\"}\\n    \\n    CheckSysID --\\u003e|\\\"Yes\\\"| LogOrder[\\\"Log Order Details\\u003cbr/\\u003eget_order_string()\\\"]\\n    CheckSysID --\\u003e|\\\"No\\\"| SaveOnly[\\\"save_order() only\\\"]\\n    \\n    LogOrder --\\u003e SaveOrder[\\\"save_order()\\u003cbr/\\u003eOrder.objects.update_or_create()\\\"]\\n    SaveOrder --\\u003e CheckStatus{\\\"OrderStatus \\u0026\\u003cbr/\\u003eOrderSubmitStatus?\\\"}\\n    \\n    CheckStatus --\\u003e|\\\"Canceled +\\u003cbr/\\u003eInsertRejected\\\"| HandleReject[\\\"Handle Rejection\\\"]\\n    CheckStatus --\\u003e|\\\"Other\\\"| Done[\\\"Complete\\\"]\\n    \\n    HandleReject --\\u003e CalcNewPrice[\\\"Calculate New Price\\u003cbr/\\u003e50% closer to settlement\\\"]\\n    CalcNewPrice --\\u003e CheckDelta{\\\"Price delta\\u003cbr/\\u003e\\u003e 1% settlement?\\\"}\\n    CheckDelta --\\u003e|\\\"Yes\\\"| Resubmit[\\\"Resubmit Order\\u003cbr/\\u003eReqOrderInsert(signal)\\\"]\\n    CheckDelta --\\u003e|\\\"No\\\"| Abandon[\\\"Abandon Order\\u003cbr/\\u003eLog warning\\\"]\\n```\\n\\n**Sources:** [trader/strategy/brother2.py:510-566](), [trader/strategy/brother2.py:498-508]()\\n\\n### Order Status Enumeration\\n\\nThe system tracks orders through multiple status states defined in `OrderStatus`:\\n\\n| Status Code | Label | Description |\\n|------------|-------|-------------|\\n| `0` | `AllTraded` | Order completely filled |\\n| `1` | `PartTradedQueueing` | Partially filled, remainder in queue |\\n| `2` | `PartTradedNotQueueing` | Partially filled, remainder cancelled |\\n| `3` | `NoTradeQueueing` | No fills yet, still in queue |\\n| `4` | `NoTradeNotQueueing` | Not filled and removed from queue |\\n| `5` | `Canceled` | Order cancelled |\\n| `a` | `Unknown` | Status unknown |\\n\\n**Sources:** [panel/const.py:90-100](), [panel/models.py:237-260]()\\n\\n### Order Model Persistence\\n\\nOrder information is persisted through the `save_order` static method, which extracts the signal ID from the `OrderRef` and creates or updates an `Order` model instance:\\n\\n**Order Model Fields:**\\n\\n| Field | Type | Description |\\n|-------|------|-------------|\\n| `order_ref` | CharField(13) | Unique order reference from CTP |\\n| `broker` | ForeignKey | Account executing the order |\\n| `strategy` | ForeignKey | Strategy generating the signal |\\n| `instrument` | ForeignKey | Product being traded |\\n| `code` | CharField(16) | Specific contract code (e.g., \\\"IF2403\\\") |\\n| `front` | IntegerField | Front-end server ID |\\n| `session` | IntegerField | Session ID |\\n| `price` | DecimalField | Order limit price |\\n| `volume` | IntegerField | Number of contracts |\\n| `direction` | CharField | LONG or SHORT |\\n| `offset_flag` | CharField | Open, Close, CloseToday, etc. |\\n| `status` | CharField | Current order status |\\n| `send_time` | DateTimeField | When order was sent |\\n| `update_time` | DateTimeField | Last status update time |\\n| `signal` | OneToOneField | Originating signal (linked after confirmation) |\\n\\n**Sources:** [panel/models.py:237-260](), [trader/strategy/brother2.py:472-495]()\\n\\n## Order Cancellation\\n\\n### Cancel Order Method\\n\\nThe `cancel_order` method provides asynchronous order cancellation with confirmation. It subscribes to three Redis channels to track the cancellation response:\\n\\n```mermaid\\nsequenceDiagram\\n    participant TS as \\\"TradeStrategy\\\"\\n    participant Redis as \\\"Redis Pub/Sub\\\"\\n    participant CTP as \\\"CTP Gateway\\\"\\n    \\n    TS-\\u003e\\u003eRedis: Subscribe to response channels\\u003cbr/\\u003eOnRtnOrder:{OrderRef}\\u003cbr/\\u003eOnRspOrderAction:0\\u003cbr/\\u003eOnRspError:{RequestID}\\n    TS-\\u003e\\u003eRedis: Publish ReqOrderAction\\u003cbr/\\u003ewith order details\\n    Redis-\\u003e\\u003eCTP: Forward cancellation request\\n    \\n    alt Cancellation Successful\\n        CTP-\\u003e\\u003eRedis: OnRtnOrder update\\u003cbr/\\u003e(status=Canceled)\\n        Redis-\\u003e\\u003eTS: Confirmation message\\n        TS-\\u003e\\u003eTS: Return True\\n    else Cancellation Failed\\n        CTP-\\u003e\\u003eRedis: OnRspError\\u003cbr/\\u003e(ErrorID != 0)\\n        Redis-\\u003e\\u003eTS: Error message\\n        TS-\\u003e\\u003eTS: Log error, Return False\\n    end\\n    \\n    TS-\\u003e\\u003eRedis: Unsubscribe channels\\n```\\n\\n**Implementation Details:**\\n- **Timeout:** 10 seconds (configurable via `HANDLER_TIME_OUT`)\\n- **Return Value:** Boolean indicating success/failure\\n- **Error Handling:** Logs CTP error codes from `ctp_errors` dictionary\\n\\n**Sources:** [trader/strategy/brother2.py:345-371]()\\n\\n### Cancellation During System Startup\\n\\nDuring system startup, the `start` method automatically cancels any outstanding orders from previous sessions:\\n\\n```python\\n# Pseudocode from lines 71-77\\norder_list = await self.query('Order')\\nfor order in order_list:\\n    if order['OrderStatus'] in [1,2,3,4] and order['OrderSubmitStatus'] == OSS_Accepted:\\n        await self.cancel_order(order)\\n```\\n\\nThis ensures clean state when the trading system restarts during market hours.\\n\\n**Sources:** [trader/strategy/brother2.py:64-84]()\\n\\n## Trade Confirmation and Recording\\n\\n### OnRtnTrade Callback\\n\\nWhen orders are filled (partially or fully), the system receives trade confirmations through `OnRtnTrade`, subscribed to `MSG:CTP:RSP:TRADE:OnRtnTrade:*`. This callback handles the complex logic of updating position records and calculating P\\u0026L.\\n\\n```mermaid\\nflowchart TD\\n    TradeMsg[\\\"Trade Message\\u003cbr/\\u003eOnRtnTrade\\\"] --\\u003e CheckManual{\\\"OrderRef\\u003cbr/\\u003e\\u003c 10000?\\\"}\\n    CheckManual --\\u003e|\\\"Yes\\\"| ManualTrade[\\\"Manual Trade\\u003cbr/\\u003e(not from signal)\\\"]\\n    CheckManual --\\u003e|\\\"No\\\"| ExtractSignal[\\\"Extract Signal ID\\u003cbr/\\u003efrom OrderRef[7:12]\\\"]\\n    \\n    ExtractSignal --\\u003e CheckOffset{\\\"OffsetFlag?\\\"}\\n    ManualTrade --\\u003e CheckOffset\\n    \\n    CheckOffset --\\u003e|\\\"Open\\\"| QueryOpenPos[\\\"Query or Create Trade\\u003cbr/\\u003efilter(close_time__isnull=True)\\\"]\\n    CheckOffset --\\u003e|\\\"Close\\\"| QueryClosePos[\\\"Query Open Position\\u003cbr/\\u003efilter(closed_shares \\u003c shares)\\\"]\\n    \\n    QueryOpenPos --\\u003e CheckNew{\\\"Trade\\u003cbr/\\u003eexists?\\\"}\\n    CheckNew --\\u003e|\\\"No\\\"| CreateTrade[\\\"Create New Trade\\u003cbr/\\u003eshares=order.volume\\u003cbr/\\u003efilled_shares=trade_volume\\\"]\\n    CheckNew --\\u003e|\\\"Yes\\\"| UpdateOpen[\\\"Update Trade\\u003cbr/\\u003eavg_entry_price (weighted)\\u003cbr/\\u003efilled_shares += volume\\\"]\\n    \\n    QueryClosePos --\\u003e UpdateClose[\\\"Update Trade\\u003cbr/\\u003eavg_exit_price (weighted)\\u003cbr/\\u003eclosed_shares += volume\\\"]\\n    UpdateClose --\\u003e CheckComplete{\\\"closed_shares\\u003cbr/\\u003e== shares?\\\"}\\n    CheckComplete --\\u003e|\\\"Yes\\\"| CalcProfit[\\\"Calculate Final Profit\\u003cbr/\\u003e(exit - entry) * volume * multiplier\\u003cbr/\\u003eSet close_time\\\"]\\n    CheckComplete --\\u003e|\\\"No\\\"| PartialClose[\\\"Partial Close\\u003cbr/\\u003eKeep position open\\\"]\\n    \\n    CreateTrade --\\u003e CheckOrderStatus{\\\"Order Status\\u003cbr/\\u003e== AllTraded?\\\"}\\n    UpdateOpen --\\u003e CheckOrderStatus\\n    CheckOrderStatus --\\u003e|\\\"Yes\\\"| MarkProcessed[\\\"Mark Signal.processed=True\\u003cbr/\\u003eLink Order.signal\\\"]\\n    CheckOrderStatus --\\u003e|\\\"No\\\"| WaitMore[\\\"Wait for more fills\\\"]\\n    \\n    CalcProfit --\\u003e MarkProcessed\\n    PartialClose --\\u003e Done[\\\"Complete\\\"]\\n    MarkProcessed --\\u003e Done\\n    WaitMore --\\u003e Done\\n```\\n\\n**Sources:** [trader/strategy/brother2.py:391-469]()\\n\\n### Trade Model Fields\\n\\nThe `Trade` model represents actual positions and their P\\u0026L:\\n\\n| Field | Type | Description |\\n|-------|------|-------------|\\n| `broker` | ForeignKey | Account holding position |\\n| `strategy` | ForeignKey | Strategy managing position |\\n| `instrument` | ForeignKey | Product being traded |\\n| `code` | CharField(16) | Specific contract code |\\n| `direction` | CharField | LONG or SHORT |\\n| `open_order` | OneToOneField | Order that opened position |\\n| `close_order` | OneToOneField | Order that closed position |\\n| `open_time` | DateTimeField | When position was opened |\\n| `close_time` | DateTimeField | When position was closed (null if open) |\\n| `shares` | IntegerField | Total position size |\\n| `filled_shares` | IntegerField | Shares actually filled on open |\\n| `closed_shares` | IntegerField | Shares filled on close |\\n| `avg_entry_price` | DecimalField | Weighted average entry price |\\n| `avg_exit_price` | DecimalField | Weighted average exit price |\\n| `profit` | DecimalField | Realized/unrealized P\\u0026L |\\n| `frozen_margin` | DecimalField | Margin requirement |\\n| `cost` | DecimalField | Total commission fees |\\n\\n**Sources:** [panel/models.py:262-289]()\\n\\n### Profit Calculation\\n\\nFor **long positions**:\\n```\\nprofit = (avg_exit_price - avg_entry_price)  shares  volume_multiple\\n```\\n\\nFor **short positions**:\\n```\\nprofit = (avg_entry_price - avg_exit_price)  shares  volume_multiple\\n```\\n\\n**Sources:** [trader/strategy/brother2.py:455-459]()\\n\\n### Fee Calculation\\n\\nTrading costs are accumulated as orders are filled:\\n```\\ncost = (volume  price  fee_money  volume_multiple) + (volume  fee_volume)\\n```\\n\\nWhere:\\n- `fee_money`: Percentage-based fee on notional value\\n- `fee_volume`: Fixed fee per contract\\n\\n**Sources:** [trader/strategy/brother2.py:406-407](), [trader/strategy/brother2.py:432-433](), [trader/strategy/brother2.py:450]()\\n\\n## Error Handling and Recovery\\n\\n### Price Limit Rejection Recovery\\n\\nWhen an order is rejected due to price limits (`OrderStatus.Canceled` + `OrderSubmitStatus.InsertRejected`), the system automatically adjusts the price and resubmits:\\n\\n**Adjustment Algorithm:**\\n\\n1. **Retrieve Last Settlement Price** from `DailyBar`\\n2. **Calculate Delta** - 50% of distance between rejected price and settlement\\n3. **Adjust Price Toward Settlement:**\\n   - Long orders: `new_price = settlement + delta  0.5`\\n   - Short orders: `new_price = settlement - delta  0.5`\\n4. **Round to Price Tick** using `price_round()`\\n5. **Validate Adjustment** - If delta \\u003c 1% of settlement, abandon order\\n6. **Resubmit** with adjusted price\\n\\n```mermaid\\nflowchart LR\\n    Rejected[\\\"Order Rejected\\u003cbr/\\u003ePrice Limit\\\"] --\\u003e GetSettlement[\\\"Get DailyBar\\u003cbr/\\u003esettlement price\\\"]\\n    GetSettlement --\\u003e CalcDelta[\\\"delta = (price - settlement)  0.5\\\"]\\n    CalcDelta --\\u003e NewPrice[\\\"new_price = settlement + delta\\\"]\\n    NewPrice --\\u003e Round[\\\"price_round(new_price, price_tick)\\\"]\\n    Round --\\u003e CheckDelta{\\\"delta / settlement\\u003cbr/\\u003e\\u003e 1%?\\\"}\\n    CheckDelta --\\u003e|\\\"Yes\\\"| Resubmit[\\\"Update signal.price\\u003cbr/\\u003eReqOrderInsert(signal)\\\"]\\n    CheckDelta --\\u003e|\\\"No\\\"| Abandon[\\\"Log warning\\u003cbr/\\u003eAbandon order\\\"]\\n```\\n\\n**Sources:** [trader/strategy/brother2.py:522-564]()\\n\\n### Manual Order Detection\\n\\nOrders not generated by the system (with `OrderRef \\u003c 10000`) are classified as manual orders. These are processed differently:\\n\\n- **No Signal Linking** - Manual orders don't mark signals as processed\\n- **Position Creation** - Still create/update `Trade` records\\n- **Flexible Matching** - Match positions by instrument and direction only\\n\\n**Sources:** [trader/strategy/brother2.py:400-401](), [trader/strategy/brother2.py:413-416]()\\n\\n### Trade String Formatting\\n\\nFor logging and monitoring, the system generates human-readable trade descriptions:\\n\\n```python\\n# Example output:\\n# \\\"SHFE.rb2405 5 :3850 :09:31:25 : 000123400045\\\"\\n```\\n\\n**Components:**\\n- Exchange and contract code\\n- Offset flag (/) + Direction (/)\\n- Volume filled\\n- Fill price\\n- Fill time\\n- OrderRef\\n\\n**Sources:** [trader/strategy/brother2.py:382-389](), [trader/strategy/brother2.py:498-508]()\\n\\n## Order Query Operations\\n\\n### Query Method Pattern\\n\\nThe system provides a generic `query` method for retrieving various CTP data types, including order lists. It uses Redis Pub/Sub with pattern subscriptions:\\n\\n```mermaid\\nsequenceDiagram\\n    participant TS as \\\"TradeStrategy\\\"\\n    participant Sub as \\\"Redis Subscriber\\u003cbr/\\u003e(pubsub client)\\\"\\n    participant Pub as \\\"Redis Publisher\\u003cbr/\\u003e(raw_redis)\\\"\\n    participant CTP as \\\"CTP Gateway\\\"\\n    \\n    TS-\\u003e\\u003eSub: Create pubsub client\\n    TS-\\u003e\\u003eSub: Subscribe to patterns:\\u003cbr/\\u003eOnRspQry{Type}:{RequestID}\\u003cbr/\\u003eOnRspError:{RequestID}\\n    TS-\\u003e\\u003eSub: Start query_reader() task\\n    TS-\\u003e\\u003ePub: Publish ReqQry{Type}\\u003cbr/\\u003ewith RequestID\\n    Pub-\\u003e\\u003eCTP: Forward query request\\n    \\n    loop Until bIsLast=True\\n        CTP-\\u003e\\u003eSub: Response message\\n        Sub-\\u003e\\u003eSub: Accumulate in msg_list\\n    end\\n    \\n    Sub-\\u003e\\u003eTS: Return complete msg_list\\n    TS-\\u003e\\u003eSub: Unsubscribe \\u0026 close\\n```\\n\\n**Supported Query Types:**\\n- `TradingAccount` - Account balance and equity\\n- `InvestorPositionDetail` - Detailed position list\\n- `Instrument` - Contract specifications\\n- `InstrumentMarginRate` - Margin requirements\\n- `InstrumentCommissionRate` - Fee rates\\n- `Order` - Outstanding and historical orders\\n\\n**Sources:** [trader/strategy/brother2.py:236-257](), [trader/strategy/brother2.py:225-234]()\\n\\n### Startup Order Recovery\\n\\nOn system startup, the `start` method queries all orders and handles them appropriately:\\n\\n```python\\n# Pseudocode from lines 71-80\\norder_list = await self.query('Order')\\nfor order in order_list:\\n    if order_status_is_open(order):  # Not filled\\n        cancel_order(order)\\n    elif order_status_is_filled(order):  # Already filled\\n        save_order(order)\\n```\\n\\nThis ensures the system's database state matches the CTP gateway state.\\n\\n**Sources:** [trader/strategy/brother2.py:71-80]()\\n\\n## Signal Processing Scheduled Tasks\\n\\nOrder insertion is triggered by scheduled cron tasks that process different market sessions:\\n\\n| Task | Cron | Description |\\n|------|------|-------------|\\n| `processing_signal1` | `55 8 * * *` | Pre-market: Day session (non-CFFEX) |\\n| `check_signal1_processed` | `1 9 * * *` | Verify day signals processed |\\n| `processing_signal2` | `25 9 * * *` | CFFEX (stock index/bonds) |\\n| `check_signal2_processed` | `31 9 * * *` | Verify CFFEX signals processed |\\n| `processing_signal3` | `55 20 * * *` | Pre-market: Night session |\\n| `check_signal3_processed` | `1 21 * * *` | Verify night signals processed |\\n\\n**Filter Criteria:**\\n```python\\n# Day session (non-CFFEX)\\nSignal.objects.filter(\\n    ~Q(instrument__exchange=ExchangeType.CFFEX),\\n    trigger_time__gte=last_trading_day,\\n    strategy=strategy,\\n    instrument__night_trade=False,\\n    processed=False\\n)\\n\\n# Night session\\nSignal.objects.filter(\\n    trigger_time__gte=last_trading_day,\\n    strategy=strategy,\\n    instrument__night_trade=True,\\n    processed=False\\n)\\n```\\n\\n**Sources:** [trader/strategy/brother2.py:572-642]()\\n\\n## Integration with Redis Channels\\n\\nThe order management system uses three Redis channel categories:\\n\\n### Request Channel\\n**Format:** `MSG:CTP:REQ:{CommandName}`\\n- `ReqOrderInsert` - Submit new orders\\n- `ReqOrderAction` - Cancel orders\\n- `ReqQryOrder` - Query order status\\n\\n### Trade Response Channels\\n**Format:** `MSG:CTP:RSP:TRADE:{CallbackName}:{Identifier}`\\n- `OnRtnOrder:{OrderRef}` - Order status updates\\n- `OnRtnTrade:{OrderRef}` - Trade confirmations\\n- `OnRspOrderAction:0` - Cancellation responses\\n- `OnRspQryOrder:{RequestID}` - Query responses\\n- `OnRspError:{RequestID}` - Error responses\\n\\n**Pattern Subscriptions:**\\nThe system uses pattern subscriptions (`psubscribe`) to match multiple channels:\\n```python\\nawait sub_client.psubscribe(\\n    'MSG:CTP:RSP:TRADE:OnRtnOrder:*',\\n    'MSG:CTP:RSP:TRADE:OnRspOrderAction:0',\\n    'MSG:CTP:RSP:TRADE:OnRspError:{request_id}'\\n)\\n```\\n\\n**Sources:** [trader/strategy/brother2.py:41-43](), [trader/strategy/brother2.py:352-355](), [trader/strategy/brother2.py:243-245]()\\n\\n## Summary Table: Key Methods\\n\\n| Method | Purpose | Return Type | Redis Channels Used |\\n|--------|---------|-------------|-------------------|\\n| `ReqOrderInsert` | Submit order from signal | None | `MSG:CTP:REQ:ReqOrderInsert` |\\n| `cancel_order` | Cancel existing order | bool | `OnRtnOrder:{ref}`, `OnRspOrderAction:0`, `OnRspError:{id}` |\\n| `OnRtnOrder` | Handle order status updates | None (callback) | `MSG:CTP:RSP:TRADE:OnRtnOrder:*` |\\n| `OnRtnTrade` | Process trade confirmations | None (callback) | `MSG:CTP:RSP:TRADE:OnRtnTrade:*` |\\n| `save_order` | Persist order to database | (Order, bool) | N/A |\\n| `query` | Query CTP data | list[dict] | `OnRspQry{Type}:{id}`, `OnRspError:{id}` |\\n| `get_order_string` | Format order for logging | str | N/A |\\n| `get_trade_string` | Format trade for logging | str | N/A |\\n\\n**Sources:** [trader/strategy/brother2.py:301-871]()\"])</script><script>self.__next_f.push([1,\"30:T4348,\"])</script><script>self.__next_f.push([1,\"# Market Data Handling\\n\\n\\u003cdetails\\u003e\\n\\u003csummary\\u003eRelevant source files\\u003c/summary\\u003e\\n\\nThe following files were used as context for generating this wiki page:\\n\\n- [trader/strategy/brother2.py](trader/strategy/brother2.py)\\n- [trader/utils/ApiStruct.py](trader/utils/ApiStruct.py)\\n- [trader/utils/tick.py](trader/utils/tick.py)\\n\\n\\u003c/details\\u003e\\n\\n\\n\\n## Purpose and Scope\\n\\nThis page documents the real-time market data handling system within the CTP API integration layer. It covers how the trading system subscribes to market data feeds, receives depth market data (Level 1 quotes), and processes tick updates through Redis Pub/Sub channels.\\n\\nFor information about historical market data acquisition from exchange APIs, see [Exchange Data Acquisition](#5.2). For details on order placement and trade execution, see [Order Management](#6.2).\\n\\n## Overview\\n\\nThe market data handling system provides real-time price feeds for monitoring positions and making trading decisions. Market data flows from the CTP Trading API through a Redis message bus to the TradeStrategy module, where it is processed asynchronously using callback functions.\\n\\n**Key Characteristics:**\\n- **Asynchronous delivery** via Redis Pub/Sub pattern\\n- **Level 1 market depth** (best bid/ask prices and volumes)\\n- **Instrument-specific channels** for efficient data routing\\n- **Non-blocking processing** to maintain system responsiveness\\n\\nSources: [trader/strategy/brother2.py:1-871]()\\n\\n## System Architecture\\n\\n```mermaid\\ngraph TB\\n    subgraph \\\"CTP Gateway Process\\\"\\n        CTPAPI[\\\"CTP Market Data API\\u003cbr/\\u003eOnRtnDepthMarketData\\\"]\\n    end\\n    \\n    subgraph \\\"Redis Message Bus\\\"\\n        MarketChannel[\\\"MSG:CTP:RSP:MARKET:OnRtnDepthMarketData:*\\u003cbr/\\u003e(Pattern Subscription)\\\"]\\n    end\\n    \\n    subgraph \\\"TradeStrategy Module\\\"\\n        Subscribe[\\\"SubscribeMarketData()\\u003cbr/\\u003eSubscribe to instruments\\\"]\\n        Unsubscribe[\\\"UnSubscribeMarketData()\\u003cbr/\\u003eUnsubscribe from instruments\\\"]\\n        Callback[\\\"@RegisterCallback\\u003cbr/\\u003eOnRtnDepthMarketData()\\\"]\\n        TickProcessor[\\\"TickBar Class\\u003cbr/\\u003eData Structuring\\\"]\\n    end\\n    \\n    subgraph \\\"Exchange Systems\\\"\\n        SHFE[\\\"SHFE\\\"]\\n        DCE[\\\"DCE\\\"]\\n        CZCE[\\\"CZCE\\\"]\\n        CFFEX[\\\"CFFEX\\\"]\\n        GFEX[\\\"GFEX\\\"]\\n    end\\n    \\n    SHFE \\u0026 DCE \\u0026 CZCE \\u0026 CFFEX \\u0026 GFEX --\\u003e|Real-time quotes| CTPAPI\\n    CTPAPI --\\u003e|Publish| MarketChannel\\n    Subscribe -.-\\u003e|Request subscription| MarketChannel\\n    Unsubscribe -.-\\u003e|Request unsubscription| MarketChannel\\n    MarketChannel --\\u003e|Tick updates| Callback\\n    Callback --\\u003e TickProcessor\\n    \\n    style Callback fill:#e1f5ff\\n    style MarketChannel fill:#fff3cd\\n```\\n\\n**Architecture Notes:**\\n- CTP Gateway publishes market data to Redis channels using instrument-specific routing\\n- TradeStrategy subscribes to channels matching monitored instruments\\n- Pattern-based subscriptions enable dynamic instrument monitoring\\n- TickBar class normalizes CTP API structures into a consistent format\\n\\nSources: [trader/strategy/brother2.py:41-42,259-299,373-380](), [trader/utils/tick.py:5-28]()\\n\\n## Market Data Subscription Flow\\n\\n```mermaid\\nsequenceDiagram\\n    participant TS as TradeStrategy\\n    participant SubClient as Redis PubSub Client\\n    participant ReqChannel as Request Channel\\u003cbr/\\u003eMSG:CTP:REQ:SubscribeMarketData\\n    participant Gateway as CTP Gateway\\n    participant RspChannel as Response Channel\\u003cbr/\\u003eMSG:CTP:RSP:MARKET:OnRspSubMarketData:0\\n    participant DataChannel as Data Channel\\u003cbr/\\u003eMSG:CTP:RSP:MARKET:OnRtnDepthMarketData:{inst}\\n    \\n    Note over TS: Subscription Request\\n    TS-\\u003e\\u003eSubClient: Create pubsub client\\n    TS-\\u003e\\u003eSubClient: psubscribe(channel_rsp_dat, channel_rsp_err)\\n    TS-\\u003e\\u003eReqChannel: Publish subscription request\\u003cbr/\\u003ejson.dumps(inst_ids)\\n    ReqChannel-\\u003e\\u003eGateway: Forward request\\n    Gateway--\\u003e\\u003eRspChannel: OnRspSubMarketData confirmation\\n    RspChannel--\\u003e\\u003eSubClient: Subscription response\\n    SubClient--\\u003e\\u003eTS: Return confirmation list\\n    TS-\\u003e\\u003eSubClient: punsubscribe() and close()\\n    \\n    Note over TS,DataChannel: Real-time Data Stream\\n    Gateway-\\u003e\\u003eDataChannel: OnRtnDepthMarketData (continuous)\\n    DataChannel-\\u003e\\u003eTS: Tick updates via @RegisterCallback\\n```\\n\\n**Subscription Process:**\\n1. **Request initiation**: TradeStrategy calls `SubscribeMarketData(inst_ids)` with list of instrument IDs\\n2. **Channel setup**: Temporary PubSub client subscribes to response channels\\n3. **Request publishing**: JSON-encoded instrument list sent to request channel\\n4. **Confirmation handling**: Wait for CTP Gateway confirmation with timeout (default 10 seconds)\\n5. **Channel activation**: Upon success, continuous tick data flows to data channels\\n\\nSources: [trader/strategy/brother2.py:259-278]()\\n\\n## Market Data Message Format\\n\\n### Channel Pattern\\n\\nMarket data channels follow a hierarchical naming convention:\\n\\n| Channel Type | Pattern | Example |\\n|-------------|---------|---------|\\n| **Subscription Response** | `MSG:CTP:RSP:MARKET:OnRspSubMarketData:0` | Confirmation of subscription |\\n| **Unsubscription Response** | `MSG:CTP:RSP:MARKET:OnRspUnSubMarketData:0` | Confirmation of unsubscription |\\n| **Tick Data Stream** | `MSG:CTP:RSP:MARKET:OnRtnDepthMarketData:{InstrumentID}` | Real-time ticks for specific instrument |\\n| **Error Channel** | `MSG:CTP:RSP:MARKET:OnRspError:0` | Subscription/request errors |\\n\\nThe channel format is configured via `config.ini`:\\n\\n```ini\\n[MSG_CHANNEL]\\nmarket_response_format = MSG:CTP:RSP:MARKET:{}:{}\\n```\\n\\nSources: [trader/strategy/brother2.py:41,264-265,285-286]()\\n\\n### Depth Market Data Structure\\n\\nThe CTP API provides the following market data fields in each tick update:\\n\\n```mermaid\\nclassDiagram\\n    class DepthMarketData {\\n        +str InstrumentID\\n        +str UpdateTime\\n        +double LastPrice\\n        +double BidPrice1\\n        +int BidVolume1\\n        +double AskPrice1\\n        +int AskVolume1\\n        +double OpenPrice\\n        +double HighestPrice\\n        +double LowestPrice\\n        +double PreClosePrice\\n        +double UpperLimitPrice\\n        +double LowerLimitPrice\\n        +int Volume\\n        +double OpenInterest\\n    }\\n    \\n    class TickBar {\\n        +str instrument\\n        +double price\\n        +double bid_price\\n        +int bid_volume\\n        +double ask_price\\n        +int ask_volume\\n        +double up_limit_price\\n        +double down_limit_price\\n        +int volume\\n        +int holding\\n        +double day_high\\n        +double day_low\\n        +double open\\n        +double pre_close\\n        +datetime dateTime\\n    }\\n    \\n    DepthMarketData --\\u003e TickBar : Normalized by\\n```\\n\\n**Field Descriptions:**\\n- **Price fields**: Last trade price, bid/ask prices, open/high/low/close\\n- **Volume fields**: Current volume increment, cumulative volume, bid/ask volumes\\n- **Limit prices**: Exchange-imposed upper/lower price limits\\n- **Open interest**: Total outstanding contracts (futures only)\\n\\nSources: [trader/utils/ApiStruct.py:1-1985](), [trader/utils/tick.py:5-28]()\\n\\n## Subscription Management API\\n\\n### SubscribeMarketData Method\\n\\nThe `SubscribeMarketData` method requests real-time market data feeds for specified instruments:\\n\\n**Method Signature:**\\n```python\\nasync def SubscribeMarketData(self, inst_ids: list) -\\u003e list\\n```\\n\\n**Parameters:**\\n- `inst_ids`: List of instrument codes (e.g., `[\\\"cu2312\\\", \\\"rb2401\\\"]`)\\n\\n**Return Value:**\\n- List of subscription confirmation dictionaries, or `None` on error\\n\\n**Implementation Details:**\\n```python\\n# 1. Create temporary subscription client\\nsub_client = self.redis_client.pubsub(ignore_subscribe_messages=True)\\n\\n# 2. Subscribe to response channels\\nchannel_rsp_dat = self.__market_response_format.format('OnRspSubMarketData', 0)\\nchannel_rsp_err = self.__market_response_format.format('OnRspError', 0)\\nawait sub_client.psubscribe(channel_rsp_dat, channel_rsp_err)\\n\\n# 3. Create async task to read responses\\ntask = asyncio.create_task(self.query_reader(sub_client))\\n\\n# 4. Publish subscription request\\nself.raw_redis.publish(\\n    self.__request_format.format('SubscribeMarketData'),\\n    json.dumps(inst_ids)\\n)\\n\\n# 5. Wait for confirmation with timeout\\nawait asyncio.wait_for(task, HANDLER_TIME_OUT)  # Default: 10 seconds\\n```\\n\\n**Error Handling:**\\n- Network timeouts return `None` and log warning\\n- Invalid instrument codes return error response from CTP\\n- Exception in subscription process closes client and returns `None`\\n\\nSources: [trader/strategy/brother2.py:259-278]()\\n\\n### UnSubscribeMarketData Method\\n\\nThe `UnSubscribeMarketData` method cancels market data subscriptions:\\n\\n**Method Signature:**\\n```python\\nasync def UnSubscribeMarketData(self, inst_ids: list) -\\u003e list\\n```\\n\\n**Parameters:**\\n- `inst_ids`: List of instrument codes to unsubscribe\\n\\n**Return Value:**\\n- List of unsubscription confirmation dictionaries, or `None` on error\\n\\n**Process:**\\n1. Create PubSub client for unsubscription response\\n2. Subscribe to `OnRspUnSubMarketData` channel\\n3. Publish unsubscription request with instrument list\\n4. Wait for CTP Gateway confirmation\\n5. Clean up temporary subscription\\n\\nSources: [trader/strategy/brother2.py:280-299]()\\n\\n## Real-Time Tick Processing\\n\\n### OnRtnDepthMarketData Callback\\n\\nThe `OnRtnDepthMarketData` callback is triggered for each tick update received from subscribed instruments:\\n\\n**Callback Registration:**\\n```python\\n@RegisterCallback(channel='MSG:CTP:RSP:MARKET:OnRtnDepthMarketData:*')\\nasync def OnRtnDepthMarketData(self, channel, tick: dict):\\n```\\n\\n**Channel Parameter:**\\n- Full Redis channel name: `MSG:CTP:RSP:MARKET:OnRtnDepthMarketData:{InstrumentID}`\\n- Instrument ID extracted from channel suffix\\n\\n**Tick Dictionary Structure:**\\n```python\\n{\\n    'InstrumentID': 'cu2312',\\n    'UpdateTime': '20231215 14:30:25:500',  # Format: YYYYMMDD HH:MM:SS:mmm\\n    'LastPrice': 68550.0,\\n    'BidPrice1': 68540.0,\\n    'BidVolume1': 20,\\n    'AskPrice1': 68560.0,\\n    'AskVolume1': 15,\\n    'HighestPrice': 68800.0,\\n    'LowestPrice': 68200.0,\\n    'OpenPrice': 68400.0,\\n    'PreClosePrice': 68350.0,\\n    'Volume': 125430,\\n    'OpenInterest': 234560,\\n    'UpperLimitPrice': 75200.0,\\n    'LowerLimitPrice': 61500.0\\n}\\n```\\n\\n**Processing Logic:**\\n```python\\n# Extract instrument from channel\\ninst = channel.split(':')[-1]\\n\\n# Parse timestamp\\ntick['UpdateTime'] = datetime.datetime.strptime(\\n    tick['UpdateTime'], \\n    \\\"%Y%m%d %H:%M:%S:%f\\\"\\n)\\n\\n# Log for debugging\\nlogger.debug('inst=%s, tick: %s', inst, tick)\\n```\\n\\n**Current Implementation:**\\nThe current callback performs minimal processing:\\n- Extracts instrument ID from channel name\\n- Converts timestamp string to datetime object\\n- Logs tick data at DEBUG level\\n\\n**Extension Points:**\\nThis callback can be extended to:\\n- Update internal position monitoring\\n- Trigger stop-loss evaluations\\n- Calculate real-time P\\u0026L\\n- Update risk metrics\\n- Feed data to charting/visualization systems\\n\\nSources: [trader/strategy/brother2.py:373-380]()\\n\\n## TickBar Data Structure\\n\\nThe `TickBar` class in `trader/utils/tick.py` provides a normalized structure for market data, processing raw CTP depth market data into a consistent format:\\n\\n### Class Definition\\n\\n```python\\nclass TickBar(object):\\n    def __init__(self, day, data, last_volume):\\n        \\\"\\\"\\\"\\n        Convert and organize CTP DepthMarketData format\\n        \\n        Parameters:\\n        - day: Trading date (YYYYMMDD string)\\n        - data: ApiStruct.DepthMarketData object\\n        - last_volume: Previous cumulative volume for calculating volume increment\\n        \\\"\\\"\\\"\\n```\\n\\n### Field Mapping\\n\\n| TickBar Field | CTP API Field | Description |\\n|---------------|---------------|-------------|\\n| `instrument` | `InstrumentID` | Contract code |\\n| `price` | `LastPrice` | Last traded price |\\n| `bid_price` | `BidPrice1` | Best bid price (Level 1) |\\n| `bid_volume` | `BidVolume1` | Best bid volume |\\n| `ask_price` | `AskPrice1` | Best ask price (Level 1) |\\n| `ask_volume` | `AskVolume1` | Best ask volume |\\n| `up_limit_price` | `UpperLimitPrice` | Daily upper price limit |\\n| `down_limit_price` | `LowerLimitPrice` | Daily lower price limit |\\n| `volume` | `Volume - last_volume` | Volume increment since last tick |\\n| `holding` | `OpenInterest` | Total open interest |\\n| `day_high` | `HighestPrice` | Highest price of the day |\\n| `day_low` | `LowestPrice` | Lowest price of the day |\\n| `open` | `OpenPrice` | Opening price |\\n| `pre_close` | `PreClosePrice` | Previous closing price |\\n| `dateTime` | `day + UpdateTime` | Timestamp with microseconds |\\n\\n### Timestamp Construction\\n\\nThe TickBar class constructs precise timestamps by combining the trading date with the update time:\\n\\n```python\\n# Combine date (YYYYMMDD) with time (HH:MM:SS)\\nself.dateTime = datetime.datetime.strptime(\\n    day + data.UpdateTime, \\n    \\\"%Y%m%d%H:%M:%S\\\"\\n)\\n\\n# Add current microsecond precision\\nself.dateTime = self.dateTime + datetime.timedelta(\\n    microseconds=datetime.datetime.now().microsecond\\n)\\n```\\n\\n**Note:** The CTP API's UpdateTime field only provides second-level precision. The current implementation adds local microseconds for finer granularity, though this may not reflect actual exchange timing.\\n\\nSources: [trader/utils/tick.py:5-28]()\\n\\n## Configuration\\n\\nMarket data handling is configured through the `config.ini` file and command timeout settings:\\n\\n### Channel Configuration\\n\\n```ini\\n[MSG_CHANNEL]\\nmarket_response_format = MSG:CTP:RSP:MARKET:{}:{}\\nrequest_format = MSG:CTP:REQ:{}\\n```\\n\\n### Timeout Configuration\\n\\n```python\\n# From trader/strategy/brother2.py\\nHANDLER_TIME_OUT = config.getint('TRADE', 'command_timeout', fallback=10)\\n```\\n\\n**Configuration Parameters:**\\n\\n| Parameter | Section | Default | Description |\\n|-----------|---------|---------|-------------|\\n| `market_response_format` | MSG_CHANNEL | Required | Pattern for market data response channels |\\n| `request_format` | MSG_CHANNEL | Required | Pattern for request channels |\\n| `command_timeout` | TRADE | 10 seconds | Max wait time for subscription responses |\\n\\nSources: [trader/strategy/brother2.py:35,41-43,269]()\\n\\n## Error Handling\\n\\n### Subscription Errors\\n\\nThe subscription methods handle various error conditions:\\n\\n**Timeout Errors:**\\n```python\\ntry:\\n    await asyncio.wait_for(task, HANDLER_TIME_OUT)\\nexcept asyncio.TimeoutError:\\n    logger.warning('SubscribeMarketData timeout', exc_info=True)\\n    await sub_client.close()\\n    return None\\n```\\n\\n**Network Errors:**\\n```python\\nexcept Exception as e:\\n    logger.warning(f'SubscribeMarketData error: {repr(e)}', exc_info=True)\\n    if sub_client and channel_rsp_dat:\\n        await sub_client.unsubscribe()\\n        await sub_client.close()\\n    return None\\n```\\n\\n**CTP API Errors:**\\nCTP errors are returned in the response message and logged. Common errors include:\\n- Invalid instrument codes\\n- Instrument not trading\\n- Exchange connection issues\\n- Subscription limits exceeded\\n\\nSources: [trader/strategy/brother2.py:259-278,280-299]()\\n\\n### Tick Processing Errors\\n\\nThe OnRtnDepthMarketData callback includes exception handling:\\n\\n```python\\n@RegisterCallback(channel='MSG:CTP:RSP:MARKET:OnRtnDepthMarketData:*')\\nasync def OnRtnDepthMarketData(self, channel, tick: dict):\\n    try:\\n        inst = channel.split(':')[-1]\\n        tick['UpdateTime'] = datetime.datetime.strptime(\\n            tick['UpdateTime'], \\n            \\\"%Y%m%d %H:%M:%S:%f\\\"\\n        )\\n        logger.debug('inst=%s, tick: %s', inst, tick)\\n    except Exception as ee:\\n        logger.warning('OnRtnDepthMarketData error: %s', repr(ee), exc_info=True)\\n```\\n\\n**Common Processing Errors:**\\n- Malformed timestamp strings\\n- Missing required fields in tick dictionary\\n- JSON decoding errors from Redis\\n- Invalid channel format\\n\\nSources: [trader/strategy/brother2.py:373-380]()\\n\\n## Integration with Trading Logic\\n\\nWhile the current implementation performs minimal tick processing, the market data system provides foundation for:\\n\\n### Position Monitoring\\n\\nReal-time ticks enable monitoring of open positions:\\n- Current unrealized P\\u0026L calculation\\n- Stop-loss trigger detection\\n- Take-profit level evaluation\\n- Margin requirement updates\\n\\n### Order Pricing\\n\\nMarket data informs order placement strategies:\\n- Limit order price selection\\n- Slippage estimation\\n- Liquidity assessment (bid/ask spreads)\\n- Market depth analysis\\n\\n### Risk Management\\n\\nContinuous market data feeds support risk controls:\\n- Real-time portfolio risk metrics\\n- Drawdown monitoring\\n- Volatility tracking\\n- Circuit breaker activation\\n\\n**Note:** The TradeStrategy class primarily uses historical daily bars for signal generation (see [Signal Generation](#4.3)), with tick data available for enhanced real-time monitoring capabilities.\\n\\nSources: [trader/strategy/brother2.py:373-380,725-856]()\\n\\n## Related Components\\n\\nThe market data handling system interacts with several other system components:\\n\\n| Component | Relationship | Reference |\\n|-----------|--------------|-----------|\\n| **BaseModule** | Provides Redis connection and callback infrastructure | [BaseModule Framework](#4.2) |\\n| **Signal Generation** | Uses historical bars rather than ticks for strategy signals | [Signal Generation](#4.3) |\\n| **Order Execution** | Market data helps inform order pricing | [Order Execution Flow](#4.4) |\\n| **Exchange Data Acquisition** | Daily bar data from exchange APIs complements real-time ticks | [Exchange Data Acquisition](#5.2) |\\n| **CTP Request-Response** | Subscription requests follow same pattern as queries | [Request-Response Patterns](#6.1) |\\n\\nSources: [trader/strategy/brother2.py:1-871]()\"])</script><script>self.__next_f.push([1,\"31:T59a3,\"])</script><script>self.__next_f.push([1,\"# Error Codes and Handling\\n\\n\\u003cdetails\\u003e\\n\\u003csummary\\u003eRelevant source files\\u003c/summary\\u003e\\n\\nThe following files were used as context for generating this wiki page:\\n\\n- [trader/strategy/brother2.py](trader/strategy/brother2.py)\\n- [trader/utils/error.xml](trader/utils/error.xml)\\n- [trader/utils/read_config.py](trader/utils/read_config.py)\\n\\n\\u003c/details\\u003e\\n\\n\\n\\nThis document provides a comprehensive reference for CTP (China Trading Platform) error codes and the system's error handling strategies. It covers the error code taxonomy, how errors are loaded and used throughout the codebase, error propagation through Redis channels, and common error scenarios with their resolutions.\\n\\nFor information about the broader CTP API integration architecture, see [CTP API Integration](#6). For details on specific request-response patterns, see [Request-Response Patterns](#6.1).\\n\\n---\\n\\n## Error Code System Overview\\n\\nThe trader system integrates with the CTP API, which returns standardized error codes for various failure conditions. These error codes are defined in an XML file and loaded into a dictionary at runtime for fast lookup and display.\\n\\n### Error Code Loading Mechanism\\n\\nThe error codes are loaded from [trader/utils/error.xml:1-267]() using Python's ElementTree XML parser:\\n\\n```python\\nctp_errors = {}\\nfor error in ET.parse(ctp_xml_path).getroot():\\n    ctp_errors[int(error.attrib['value'])] = error.attrib['prompt']\\n```\\n\\nThis creates a dictionary mapping integer error codes (e.g., `0`, `31`, `116`) to human-readable error messages in Chinese with \\\"CTP:\\\" prefix.\\n\\n**Key Components:**\\n- **error.xml**: XML file containing 100+ CTP error definitions with id, value (numeric code), and prompt (error message)\\n- **ctp_errors dictionary**: Runtime dictionary for O(1) error message lookup\\n- **read_config.py**: Module that loads and exposes the `ctp_errors` dictionary globally\\n\\n**Sources:** [trader/utils/read_config.py:74-78](), [trader/utils/error.xml:1-267]()\\n\\n---\\n\\n## Error Flow Architecture\\n\\n```mermaid\\ngraph TB\\n    subgraph \\\"TradeStrategy Process\\\"\\n        TS[TradeStrategy]\\n        QryFunc[query/cancel_order/SubscribeMarketData]\\n        ErrHandler[Error Handler\\u003cbr/\\u003etry/except blocks]\\n        Logger[logger.warning]\\n    end\\n    \\n    subgraph \\\"Redis Message Bus\\\"\\n        ReqChan[Request Channel\\u003cbr/\\u003eMSG:CTP:REQ:*]\\n        RspChan[Response Channel\\u003cbr/\\u003eMSG:CTP:RSP:TRADE:*]\\n        ErrChan[Error Channel\\u003cbr/\\u003eOnRspError]\\n    end\\n    \\n    subgraph \\\"CTP Gateway Process\\\"\\n        CTPGateway[CTP API Handler]\\n        CTPResp[CTP Response]\\n    end\\n    \\n    subgraph \\\"Error Lookup\\\"\\n        CTPErrors[ctp_errors dict]\\n        ErrorXML[error.xml\\u003cbr/\\u003e100+ error definitions]\\n    end\\n    \\n    TS --\\u003e|1. Call operation| QryFunc\\n    QryFunc --\\u003e|2. Publish request| ReqChan\\n    ReqChan --\\u003e|3. Forward| CTPGateway\\n    CTPGateway --\\u003e|4. CTP API call| CTPResp\\n    CTPResp --\\u003e|5a. Success| RspChan\\n    CTPResp --\\u003e|5b. Error with ErrorID| ErrChan\\n    RspChan --\\u003e|6. Subscribe| QryFunc\\n    ErrChan --\\u003e|6. Subscribe| QryFunc\\n    QryFunc --\\u003e|7. Exception raised| ErrHandler\\n    ErrHandler --\\u003e|8. Lookup ErrorID| CTPErrors\\n    CTPErrors -.-\\u003e|Loaded at startup| ErrorXML\\n    ErrHandler --\\u003e|9. Log error message| Logger\\n    Logger --\\u003e|10. Optional| WeixinLog[MSG:LOG:WEIXIN]\\n```\\n\\nThe error handling flow follows these steps:\\n\\n1. **Request Initiation**: TradeStrategy calls an operation (query, order insert, etc.)\\n2. **Redis Publishing**: Request published to appropriate channel\\n3. **CTP Gateway**: External process forwards request to CTP API\\n4. **CTP Response**: Either success data or error with `ErrorID` field\\n5. **Response Routing**: Success goes to data channel, errors to `OnRspError` channel\\n6. **Error Detection**: TradeStrategy detects `ErrorID` field in response\\n7. **Exception Handling**: Caught by try/except block\\n8. **Error Lookup**: `ctp_errors[ErrorID]` retrieves human-readable message\\n9. **Logging**: Error logged with context\\n10. **Optional Notification**: Critical errors forwarded to WeChat\\n\\n**Sources:** [trader/strategy/brother2.py:345-371](), [trader/strategy/brother2.py:236-257](), [trader/utils/read_config.py:74-78]()\\n\\n---\\n\\n## CTP Error Code Categories\\n\\nThe error codes are organized into several categories based on their functional areas:\\n\\n### Authentication and Access Errors (0-20)\\n\\n| Error Code | ID | Description |\\n|------------|-----|-------------|\\n| 0 | NONE | Successful operation |\\n| 3 | INVALID_LOGIN | Invalid login credentials |\\n| 4 | USER_NOT_ACTIVE | User account not active |\\n| 5 | DUPLICATE_LOGIN | User already logged in |\\n| 6 | NOT_LOGIN_YET | Operation requires login first |\\n| 7 | NOT_INITED | System not initialized |\\n| 8 | FRONT_NOT_ACTIVE | Trading front-end not active |\\n| 9 | NO_PRIVILEGE | User lacks required permissions |\\n| 11 | USER_NOT_FOUND | User account not found |\\n| 12 | BROKER_NOT_FOUND | Broker not found |\\n| 13 | INVESTOR_NOT_FOUND | Investor account not found |\\n| 16 | INSTRUMENT_NOT_FOUND | Trading instrument not found |\\n| 17 | INSTRUMENT_NOT_TRADING | Instrument not tradeable |\\n| 19 | INVESTOR_NOT_ACTIVE | Investor account not active |\\n| 20 | NOT_EXCHANGE_CLIENT | Investor not registered with exchange |\\n\\n### Order and Trading Errors (22-30)\\n\\n| Error Code | ID | Description |\\n|------------|-----|-------------|\\n| 22 | DUPLICATE_ORDER_REF | Duplicate OrderRef detected |\\n| 23 | BAD_ORDER_ACTION_FIELD | Invalid order action field |\\n| 24 | DUPLICATE_ORDER_ACTION_REF | Duplicate order cancellation |\\n| 25 | ORDER_NOT_FOUND | Order not found for cancellation |\\n| 26 | INSUITABLE_ORDER_STATUS | Order status doesn't allow cancellation |\\n| 28 | NO_TRADING_RIGHT | No permission to trade |\\n| 29 | CLOSE_ONLY | Only closing positions allowed |\\n| 30 | OVER_CLOSE_POSITION | Close volume exceeds position |\\n| 31 | INSUFFICIENT_MONEY | Insufficient account balance |\\n\\n### Position and Risk Errors (50-62)\\n\\n| Error Code | ID | Description |\\n|------------|-----|-------------|\\n| 50 | OVER_CLOSETODAY_POSITION | Insufficient today's position |\\n| 51 | OVER_CLOSEYESTERDAY_POSITION | Insufficient yesterday's position |\\n| 106 | POSI_LIMIT | Position limit exceeded |\\n| 113 | OUT_OF_TIMEINTERVAL | Operation not allowed at this time |\\n| 114 | OUT_OF_PRICEINTERVAL | Price outside allowed range |\\n| 116 | ORDER_FREQ_LIMIT | Order frequency limit exceeded |\\n\\n### System and Network Errors (39-44, 89-91)\\n\\n| Error Code | ID | Description |\\n|------------|-----|-------------|\\n| 39 | CFFEX_NETWORK_ERROR | Exchange network connection failed |\\n| 40 | CFFEX_OVER_REQUEST | Too many pending requests |\\n| 41 | CFFEX_OVER_REQUEST_PER_SECOND | Request rate limit exceeded |\\n| 42 | SETTLEMENT_INFO_NOT_CONFIRMED | Settlement not confirmed |\\n| 44 | EXCHANG_TRADING | Exchange in continuous trading |\\n| 89 | OPEN_FILE_FAILED | File operation failed |\\n| 90 | NEED_RETRY | Query not ready, retry later |\\n| 91 | EXCHANGE_RTNERROR | Exchange returned error |\\n\\n### Authentication and Security Errors (63-75, 131-150)\\n\\n| Error Code | ID | Description |\\n|------------|-----|-------------|\\n| 63 | AUTH_FAILED | Client authentication failed |\\n| 64 | NOT_AUTHENT | Client not authenticated |\\n| 75 | LOGIN_FORBIDDEN | Login blocked due to too many failures |\\n| 131 | WEAK_PASSWORD | Weak password detected |\\n| 140 | FIRST_LOGIN | Must change password on first login |\\n| 141 | PWD_OUT_OF_DATE | Password expired |\\n| 142 | PWD_MUST_DIFF | New password must differ from old |\\n| 143 | IP_FORBIDDEN | IP blocked due to login failures |\\n| 144 | IP_BLACK | IP in blacklist |\\n\\n### Transfer System Errors (1000-1043, 2000-2070)\\n\\nThese errors relate to bank-futures transfer operations ():\\n\\n| Error Code Range | Category | Description |\\n|------------------|----------|-------------|\\n| 1000-1043 | Bank Transfer | Basic bank-futures transfer errors |\\n| 2000-2070 | Extended Transfer | Additional transfer and authentication errors |\\n| 3001-3038 | Currency Exchange | Bank-futures currency exchange errors |\\n\\n### Special Error Codes\\n\\n| Error Code | ID | Description |\\n|------------|-----|-------------|\\n| 999999 | WAITING_OFFER_RSP | Waiting for bank response |\\n| 4040 | API_FRONT_SHAKE_HAND_ERR | API handshake failed |\\n| 4041 | DUPLICATE_SUBMIT | Duplicate submission |\\n| 4042 | AUTHIP_CHECK_ERR | IP authorization failed |\\n| 4060 | AUTH_IP_FORBIDDEN | IP banned from authentication |\\n\\n**Sources:** [trader/utils/error.xml:11-266]()\\n\\n---\\n\\n## Error Handling Patterns\\n\\n### Query Operation Error Handling\\n\\nThe `query` method demonstrates the standard async error handling pattern:\\n\\n```mermaid\\nsequenceDiagram\\n    participant Caller\\n    participant query_method\\n    participant SubClient as \\\"Redis PubSub\\\"\\n    participant TaskReader as \\\"query_reader task\\\"\\n    participant Logger\\n    participant CleanUp as \\\"Cleanup Handler\\\"\\n    \\n    Caller-\\u003e\\u003equery_method: query(type, **kwargs)\\n    query_method-\\u003e\\u003equery_method: Create RequestID\\n    query_method-\\u003e\\u003eSubClient: pubsub(ignore_subscribe=True)\\n    query_method-\\u003e\\u003eSubClient: psubscribe(OnRspQry*, OnRspError)\\n    query_method-\\u003e\\u003eTaskReader: create_task(query_reader)\\n    query_method-\\u003e\\u003eSubClient: publish(ReqQry* request)\\n    \\n    alt Successful Response\\n        SubClient-\\u003e\\u003eTaskReader: Data messages\\n        TaskReader-\\u003e\\u003eTaskReader: Accumulate until bIsLast=True\\n        TaskReader--\\u003e\\u003equery_method: Return list\\n        query_method-\\u003e\\u003eSubClient: punsubscribe()\\n        query_method-\\u003e\\u003eSubClient: close()\\n        query_method--\\u003e\\u003eCaller: Return data\\n    else Error Response\\n        SubClient-\\u003e\\u003eTaskReader: OnRspError with ErrorID\\n        TaskReader--\\u003e\\u003equery_method: Exception or error data\\n        query_method-\\u003e\\u003eLogger: logger.warning(f'{type} ')\\n        query_method-\\u003e\\u003eCleanUp: Check sub_client state\\n        CleanUp-\\u003e\\u003eSubClient: unsubscribe() if needed\\n        CleanUp-\\u003e\\u003eSubClient: close()\\n        query_method--\\u003e\\u003eCaller: Return None\\n    else Timeout\\n        TaskReader-\\u003e\\u003equery_method: asyncio.TimeoutError\\n        query_method-\\u003e\\u003eLogger: logger.warning(exception)\\n        query_method-\\u003e\\u003eCleanUp: Cleanup subscription\\n        query_method--\\u003e\\u003eCaller: Return None\\n    end\\n```\\n\\n**Key Implementation Points:**\\n\\n1. **Resource Management**: PubSub client created with `ignore_subscribe_messages=True`\\n2. **Pattern Subscription**: Subscribe to both data channel and error channel\\n3. **Timeout Protection**: `asyncio.wait_for(task, HANDLER_TIME_OUT)` prevents hanging\\n4. **Cleanup Guarantee**: Always unsubscribe and close client, even on error\\n5. **Error Return**: Returns `None` on error instead of raising exception\\n\\n**Sources:** [trader/strategy/brother2.py:236-257]()\\n\\n### Order Cancellation Error Handling\\n\\nThe `cancel_order` method shows error code lookup in action:\\n\\n```mermaid\\ngraph TB\\n    CancelReq[cancel_order called\\u003cbr/\\u003ewith order dict]\\n    CreateSub[Create PubSub client\\u003cbr/\\u003eSubscribe to channels]\\n    PublishReq[Publish ReqOrderAction\\u003cbr/\\u003eto Redis]\\n    WaitResp[Wait for response\\u003cbr/\\u003ewith timeout]\\n    CheckErr{Response has\\u003cbr/\\u003eErrorID field?}\\n    LookupErr[Lookup error message\\u003cbr/\\u003ectp_errors ErrorID]\\n    LogErr[logger.warning with\\u003cbr/\\u003eerror message]\\n    ReturnFalse[Return False]\\n    ReturnTrue[Return True]\\n    Cleanup[Unsubscribe and close\\u003cbr/\\u003ePubSub client]\\n    \\n    CancelReq --\\u003e CreateSub\\n    CreateSub --\\u003e PublishReq\\n    PublishReq --\\u003e WaitResp\\n    WaitResp --\\u003e CheckErr\\n    CheckErr --\\u003e|Yes| LookupErr\\n    CheckErr --\\u003e|No| ReturnTrue\\n    LookupErr --\\u003e LogErr\\n    LogErr --\\u003e ReturnFalse\\n    ReturnTrue --\\u003e Cleanup\\n    ReturnFalse --\\u003e Cleanup\\n```\\n\\n**Implementation Detail:**\\n```python\\nresult = task.result()[0]\\nif 'ErrorID' in result:\\n    logger.warning(f\\\": {ctp_errors[result['ErrorID']]}\\\")\\n    return False\\nreturn True\\n```\\n\\nThe error ID is looked up in the `ctp_errors` dictionary to display a human-readable message. This pattern is used consistently throughout the codebase.\\n\\n**Sources:** [trader/strategy/brother2.py:345-371]()\\n\\n### Market Data Subscription Error Handling\\n\\nBoth `SubscribeMarketData` and `UnSubscribeMarketData` follow the same pattern:\\n\\n1. Create PubSub client\\n2. Subscribe to `OnRspSubMarketData` or `OnRspUnSubMarketData` and `OnRspError`\\n3. Publish request\\n4. Wait for response with timeout\\n5. Check for errors\\n6. Cleanup subscription\\n7. Return result or `None`\\n\\n**Sources:** [trader/strategy/brother2.py:259-299]()\\n\\n---\\n\\n## Error Propagation and Recovery\\n\\n### Automatic Price Adjustment on Order Rejection\\n\\nWhen an order is rejected due to price exceeding exchange limits (order status `Canceled` with submit status `InsertRejected`), the system automatically adjusts the price and retries:\\n\\n```mermaid\\ngraph TD\\n    OnRtnOrder[OnRtnOrder callback\\u003cbr/\\u003ereceives order update]\\n    CheckStatus{Status=Canceled\\u003cbr/\\u003eAND InsertRejected?}\\n    GetLastBar[Get last DailyBar\\u003cbr/\\u003efor settlement price]\\n    CheckOffset{CombOffsetFlag?}\\n    CalcNewPrice[Calculate new price\\u003cbr/\\u003e50% closer to settlement]\\n    CheckDelta{Price delta\\u003cbr/\\u003e\\u003e 1% of settlement?}\\n    UpdateSignal[Update signal.price]\\n    ReqOrder[ReqOrderInsert\\u003cbr/\\u003eRetry with new price]\\n    LogAbandon[Log: price too low,\\u003cbr/\\u003eabandon order]\\n    EndFlow[Continue processing]\\n    \\n    OnRtnOrder --\\u003e CheckStatus\\n    CheckStatus --\\u003e|No| EndFlow\\n    CheckStatus --\\u003e|Yes| GetLastBar\\n    GetLastBar --\\u003e CheckOffset\\n    CheckOffset --\\u003e|Open| CalcNewPrice\\n    CheckOffset --\\u003e|Close| CalcNewPrice\\n    CalcNewPrice --\\u003e CheckDelta\\n    CheckDelta --\\u003e|Yes| UpdateSignal\\n    CheckDelta --\\u003e|No| LogAbandon\\n    UpdateSignal --\\u003e ReqOrder\\n    ReqOrder --\\u003e EndFlow\\n    LogAbandon --\\u003e EndFlow\\n```\\n\\n**Logic Flow:**\\n\\nFor **opening** orders:\\n- **Long direction**: `new_price = settlement + (old_price - settlement) * 0.5`\\n- **Short direction**: `new_price = settlement - (settlement - old_price) * 0.5`\\n\\nFor **closing** orders:\\n- Same calculation based on direction\\n\\nIf the price adjustment is less than 1% of settlement, the order is abandoned to avoid unfavorable fills.\\n\\n**Sources:** [trader/strategy/brother2.py:522-564]()\\n\\n---\\n\\n## Common Error Scenarios and Resolutions\\n\\n### Insufficient Funds (Error 31)\\n\\n**Scenario**: Order rejected with `INSUFFICIENT_MONEY` error.\\n\\n**Cause**: Account available cash less than required margin.\\n\\n**Resolution**:\\n1. Check current account status via `refresh_account()`\\n2. Verify margin requirements: `margin = price * volume * volume_multiple * margin_rate`\\n3. Reduce position size or increase account funding\\n4. Review `calc_signal` margin estimates vs actual margin\\n\\n**Related Code**: [trader/strategy/brother2.py:86-112](), [trader/strategy/brother2.py:719-721]()\\n\\n---\\n\\n### Over Close Position (Error 30)\\n\\n**Scenario**: Close order rejected with `OVER_CLOSE_POSITION` error.\\n\\n**Cause**: Attempting to close more contracts than currently held.\\n\\n**Resolution**:\\n1. Call `refresh_position()` to sync position data\\n2. Check `Trade` model for actual open positions\\n3. Ensure signal volume matches actual position shares\\n4. For SHFE exchange, distinguish between today's and yesterday's positions\\n\\n**Related Code**: [trader/strategy/brother2.py:114-154](), [trader/strategy/brother2.py:320-333]()\\n\\n---\\n\\n### Order Frequency Limit (Error 116)\\n\\n**Scenario**: Order rejected with `ORDER_FREQ_LIMIT` error.\\n\\n**Cause**: Submitting orders too frequently, exceeding exchange limits.\\n\\n**Resolution**:\\n1. Implement rate limiting in order submission logic\\n2. Add delays between order requests\\n3. Batch similar orders when possible\\n4. Review scheduled task timing to avoid bursts\\n\\n**Configuration**: [trader/strategy/brother2.py:35]() - `command_timeout` setting\\n\\n---\\n\\n### Duplicate Order Reference (Error 22)\\n\\n**Scenario**: Order rejected with `DUPLICATE_ORDER_REF` error.\\n\\n**Cause**: OrderRef already used for a previous order.\\n\\n**Resolution**:\\n1. Verify `Autonumber` model is generating unique IDs\\n2. Check OrderRef format: `f\\\"{autoid.id:07}{sig.id:05}\\\"`\\n3. Ensure database transactions are completing\\n4. Restart system if ID sequence corrupted\\n\\n**Related Code**: [trader/strategy/brother2.py:301-343]()\\n\\n---\\n\\n### Query Not Ready (Error 90)\\n\\n**Scenario**: Query returns `NEED_RETRY` error.\\n\\n**Cause**: CTP system not ready to process query (e.g., during settlement).\\n\\n**Resolution**:\\n1. Implement retry logic with exponential backoff\\n2. Avoid queries during known settlement times (15:00-15:30)\\n3. Check `is_trading_day()` before querying\\n4. Handle `None` return values gracefully\\n\\n**Related Code**: [trader/strategy/brother2.py:236-257]()\\n\\n---\\n\\n### Authentication Failures (Errors 63-75)\\n\\n**Scenario**: Login or operation fails with authentication errors.\\n\\n**Cause**: \\n- Invalid credentials\\n- IP restrictions\\n- Multiple login attempts\\n- Certificate issues\\n\\n**Resolution**:\\n1. Verify credentials in configuration file\\n2. Check IP whitelist settings\\n3. Wait for IP ban timeout (if Error 143 or 144)\\n4. Update API authentication if required (Error 64)\\n5. Change weak password (Error 131)\\n\\n**Configuration**: See [Configuration File Format](#7.1)\\n\\n---\\n\\n### Network and Timeout Errors (39-41, 90)\\n\\n**Scenario**: Operations timing out or network errors.\\n\\n**Cause**:\\n- CTP gateway process not running\\n- Network connectivity issues\\n- Redis connection problems\\n- Request rate limits\\n\\n**Resolution**:\\n1. Check Redis connectivity: `redis-cli ping`\\n2. Verify CTP gateway process is running\\n3. Review network logs\\n4. Adjust `HANDLER_TIME_OUT` if needed\\n5. Implement exponential backoff for retries\\n\\n**Configuration**: [trader/strategy/brother2.py:35]()\\n\\n---\\n\\n## Error Logging Strategy\\n\\n### Log Levels and Usage\\n\\nThe system uses Python's standard logging with the following patterns:\\n\\n| Log Level | Usage | Example |\\n|-----------|-------|---------|\\n| `logger.debug()` | Query operations, internal state | `logger.debug('...')` |\\n| `logger.info()` | Normal operations, signals | `logger.info(f': {sig}')` |\\n| `logger.warning()` | Errors, exceptions | `logger.warning(f'refresh_account : {repr(e)}')` |\\n\\n### Exception Logging Pattern\\n\\nAll async methods follow this pattern:\\n\\n```python\\nasync def method_name(self):\\n    try:\\n        # Operation logic\\n        pass\\n    except Exception as e:\\n        logger.warning(f'method_name : {repr(e)}', exc_info=True)\\n```\\n\\nThe `exc_info=True` parameter ensures full stack traces are logged for debugging.\\n\\n**Sources:** [trader/strategy/brother2.py:111-112](), [trader/strategy/brother2.py:153-154]()\\n\\n---\\n\\n### WeChat Notification Integration\\n\\nCritical errors can be forwarded to WeChat for real-time monitoring:\\n\\n```mermaid\\ngraph LR\\n    ErrorOccurs[Error Occurs]\\n    LoggerCall[logger.warning]\\n    CheckLevel{Error Level\\u003cbr/\\u003eWarrants\\u003cbr/\\u003eNotification?}\\n    PublishToRedis[Publish to\\u003cbr/\\u003eMSG:LOG:WEIXIN]\\n    WeixinService[WeChat Service\\u003cbr/\\u003eSubscriber]\\n    SendNotification[Send to\\u003cbr/\\u003eUser's WeChat]\\n    \\n    ErrorOccurs --\\u003e LoggerCall\\n    LoggerCall --\\u003e CheckLevel\\n    CheckLevel --\\u003e|Yes| PublishToRedis\\n    CheckLevel --\\u003e|No| EndLog[End]\\n    PublishToRedis --\\u003e WeixinService\\n    WeixinService --\\u003e SendNotification\\n```\\n\\n**Configuration**: The WeChat log channel is configured in `config.ini`:\\n```ini\\n[MSG_CHANNEL]\\nweixin_log = MSG:LOG:WEIXIN\\n```\\n\\n**Sources:** [trader/utils/read_config.py:31]()\\n\\n---\\n\\n## Error Response Message Structure\\n\\nCTP error responses received via Redis contain these key fields:\\n\\n| Field | Type | Description |\\n|-------|------|-------------|\\n| `ErrorID` | int | Numeric error code (0 = success) |\\n| `ErrorMsg` | str | Error message from CTP (may be in Chinese) |\\n| `RequestID` | int | Matches the request that triggered error |\\n| `bIsLast` | bool | Whether this is the last error in a sequence |\\n\\n**Example Error Response:**\\n```json\\n{\\n  \\\"ErrorID\\\": 31,\\n  \\\"ErrorMsg\\\": \\\"CTP:\\\",\\n  \\\"RequestID\\\": 12345,\\n  \\\"bIsLast\\\": true\\n}\\n```\\n\\nThe system checks for `ErrorID` field presence and looks up the localized message from `ctp_errors[31]`  `\\\"CTP:\\\"`.\\n\\n**Sources:** [trader/strategy/brother2.py:362-363]()\\n\\n---\\n\\n## Error Handling Best Practices\\n\\n### 1. Always Use Try-Except in Async Methods\\n\\nAll async methods that interact with external systems should wrap operations in try-except blocks:\\n\\n```python\\nasync def operation(self):\\n    try:\\n        result = await self.query('Type', **params)\\n        # Process result\\n    except Exception as e:\\n        logger.warning(f'operation : {repr(e)}', exc_info=True)\\n        return None  # Or appropriate default\\n```\\n\\n### 2. Implement Timeout Protection\\n\\nUse `asyncio.wait_for()` to prevent indefinite hangs:\\n\\n```python\\nawait asyncio.wait_for(task, HANDLER_TIME_OUT)\\n```\\n\\n### 3. Clean Up Resources\\n\\nAlways close PubSub clients and unsubscribe from channels:\\n\\n```python\\ntry:\\n    # Operation\\n    pass\\nfinally:\\n    if sub_client:\\n        await sub_client.punsubscribe()\\n        await sub_client.close()\\n```\\n\\n### 4. Return Safe Defaults\\n\\nMethods should return `None` or safe defaults on error rather than raising exceptions to higher layers, allowing the system to continue operating.\\n\\n### 5. Log with Context\\n\\nInclude relevant context in error messages:\\n\\n```python\\nlogger.warning(f'{query_type} : {repr(e)}', exc_info=True)\\n```\\n\\n### 6. Check Error Codes Explicitly\\n\\nWhen receiving responses, always check for `ErrorID` field:\\n\\n```python\\nif 'ErrorID' in result:\\n    logger.warning(f\\\": {ctp_errors[result['ErrorID']]}\\\")\\n    return False\\n```\\n\\n**Sources:** [trader/strategy/brother2.py:236-257](), [trader/strategy/brother2.py:345-371]()\\n\\n---\\n\\n## Extending the Error System\\n\\n### Adding New Error Codes\\n\\nTo add new CTP error codes:\\n\\n1. **Edit error.xml**: Add new `\\u003cerror\\u003e` element with unique `id`, `value`, and `prompt`\\n   ```xml\\n   \\u003cerror id=\\\"NEW_ERROR_ID\\\" value=\\\"9999\\\" prompt=\\\"CTP:New error description\\\"/\\u003e\\n   ```\\n\\n2. **Restart System**: The `ctp_errors` dictionary is loaded at import time, so restart is required\\n\\n3. **Test Error Handling**: Verify the new error code is properly looked up and logged\\n\\n### Custom Error Handling\\n\\nFor application-specific errors (not from CTP), use standard Python exceptions:\\n\\n```python\\nif invalid_condition:\\n    logger.warning(\\\"Custom error condition detected\\\")\\n    raise ValueError(\\\"Description of problem\\\")\\n```\\n\\nThese are caught by the standard try-except blocks and logged appropriately.\\n\\n**Sources:** [trader/utils/read_config.py:74-78](), [trader/utils/error.xml:1-267]()\\n\\n---\\n\\n## Summary\\n\\nThe error handling system provides:\\n\\n- **Comprehensive Error Coverage**: 100+ CTP error codes with Chinese descriptions\\n- **Consistent Patterns**: All async operations follow standardized error handling\\n- **Automatic Recovery**: Price adjustment and retry for rejected orders\\n- **Resource Safety**: Guaranteed cleanup of Redis subscriptions\\n- **Detailed Logging**: Full context and stack traces for debugging\\n- **Real-time Monitoring**: WeChat notifications for critical errors\\n- **Safe Degradation**: Returns safe defaults instead of crashing\\n\\nThe combination of the `ctp_errors` lookup dictionary, consistent try-except patterns, and Redis message routing ensures that errors are properly detected, logged, and handled without disrupting the trading system's operation.\"])</script><script>self.__next_f.push([1,\"32:T35e7,\"])</script><script>self.__next_f.push([1,\"# Configuration Reference\\n\\n\\u003cdetails\\u003e\\n\\u003csummary\\u003eRelevant source files\\u003c/summary\\u003e\\n\\nThe following files were used as context for generating this wiki page:\\n\\n- [panel/const.py](panel/const.py)\\n- [trader/utils/read_config.py](trader/utils/read_config.py)\\n\\n\\u003c/details\\u003e\\n\\n\\n\\n## Purpose and Scope\\n\\nThis page provides a comprehensive reference for the trader system's configuration infrastructure. It documents the configuration loading mechanism, file structure, and the enumeration system used throughout the codebase. The trader system uses two primary configuration sources:\\n\\n1. **Runtime Configuration**: Settings loaded from `config.ini` via the `read_config` module for system behavior, database connections, and API credentials\\n2. **Static Constants**: Type-safe enumerations and mappings defined in `panel/const.py` for trading operations, exchange protocols, and domain-specific values\\n\\nFor detailed documentation of specific configuration sections and parameters, see [Configuration File Format](#7.1). For a complete reference of enumeration types and constant values, see [Constants and Enumerations](#7.2).\\n\\n---\\n\\n## Configuration Architecture\\n\\nThe trader system separates configuration into two distinct layers: runtime settings that can be modified without code changes, and compile-time constants that define the trading domain model.\\n\\n### Configuration Loading Flow\\n\\n```mermaid\\ngraph TB\\n    subgraph \\\"Application Startup\\\"\\n        Main[\\\"trader/main.py\\u003cbr/\\u003eApplication Entry\\\"]\\n    end\\n    \\n    subgraph \\\"Configuration Module\\\"\\n        ReadConfig[\\\"trader/utils/read_config.py\\\"]\\n        ConfigParser[\\\"configparser.ConfigParser\\\"]\\n        AppDirs[\\\"appdirs.AppDirs\\\"]\\n        XMLParser[\\\"xml.etree.ElementTree\\\"]\\n    end\\n    \\n    subgraph \\\"Configuration Sources\\\"\\n        ConfigFile[\\\"config.ini\\u003cbr/\\u003e~/.trader/config.ini\\\"]\\n        ErrorXML[\\\"error.xml\\u003cbr/\\u003eCTP Error Definitions\\\"]\\n        DefaultConfig[\\\"config_example\\u003cbr/\\u003eTemplate String\\\"]\\n    end\\n    \\n    subgraph \\\"Configuration Objects\\\"\\n        ConfigObj[\\\"config\\u003cbr/\\u003eGlobal ConfigParser\\\"]\\n        CTPErrors[\\\"ctp_errors\\u003cbr/\\u003eDict[int, str]\\\"]\\n    end\\n    \\n    subgraph \\\"Constants Module\\\"\\n        ConstPy[\\\"panel/const.py\\\"]\\n        DjangoChoices[\\\"djchoices.DjangoChoices\\\"]\\n    end\\n    \\n    subgraph \\\"Constant Objects\\\"\\n        ContractType[\\\"ContractType\\\"]\\n        ExchangeType[\\\"ExchangeType\\\"]\\n        DirectionType[\\\"DirectionType\\\"]\\n        OrderStatus[\\\"OrderStatus\\\"]\\n        SignalType[\\\"SignalType\\\"]\\n        OtherEnums[\\\"OffsetFlag\\u003cbr/\\u003eCombOffsetFlag\\u003cbr/\\u003eSectionType\\u003cbr/\\u003eetc.\\\"]\\n    end\\n    \\n    Main --\\u003e ReadConfig\\n    Main --\\u003e ConstPy\\n    \\n    ReadConfig --\\u003e AppDirs\\n    AppDirs --\\u003e|\\\"Locate user config dir\\\"| ConfigFile\\n    \\n    ReadConfig --\\u003e|\\\"Check if exists\\\"| ConfigFile\\n    ConfigFile --\\u003e|\\\"Missing\\\"| DefaultConfig\\n    DefaultConfig --\\u003e|\\\"Create default\\\"| ConfigFile\\n    \\n    ConfigFile --\\u003e|\\\"Read\\\"| ConfigParser\\n    ConfigParser --\\u003e ConfigObj\\n    \\n    ReadConfig --\\u003e XMLParser\\n    ErrorXML --\\u003e XMLParser\\n    XMLParser --\\u003e CTPErrors\\n    \\n    ConstPy --\\u003e DjangoChoices\\n    DjangoChoices --\\u003e ContractType\\n    DjangoChoices --\\u003e ExchangeType\\n    DjangoChoices --\\u003e DirectionType\\n    DjangoChoices --\\u003e OrderStatus\\n    DjangoChoices --\\u003e SignalType\\n    DjangoChoices --\\u003e OtherEnums\\n```\\n\\n**Sources**: [trader/utils/read_config.py:1-79](), [panel/const.py:1-178]()\\n\\n---\\n\\n## Configuration File Structure\\n\\nThe `config.ini` file is automatically created on first run at the platform-specific user configuration directory using `appdirs`. The file uses INI format with the following sections:\\n\\n| Section | Purpose | Key Components |\\n|---------|---------|----------------|\\n| `MSG_CHANNEL` | Redis pub/sub channel naming patterns | Request/response formats for CTP API communication |\\n| `TRADE` | Trading behavior settings | Command timeout, ignored instruments |\\n| `REDIS` | Redis connection parameters | Host, port, database, encoding |\\n| `MYSQL` | MySQL database connection | Host, port, database, credentials |\\n| `QuantDL` | QuantDL API integration | API key for data service |\\n| `Tushare` | Tushare API integration | Token for market data service |\\n| `LOG` | Logging configuration | Level, format strings for console and WeChat |\\n\\n### Configuration Loading Mechanism\\n\\n```mermaid\\ngraph LR\\n    subgraph \\\"Initialization Process\\\"\\n        A[\\\"Import read_config module\\\"]\\n        B[\\\"app_dir = AppDirs('trader')\\\"]\\n        C[\\\"config_file path\\u003cbr/\\u003econstructed\\\"]\\n        D{\\\"config.ini\\u003cbr/\\u003eexists?\\\"}\\n        E[\\\"Create directories\\\"]\\n        F[\\\"Write config_example\\\"]\\n        G[\\\"configparser.ConfigParser\\\"]\\n        H[\\\"config.read(config_file)\\\"]\\n    end\\n    \\n    subgraph \\\"Error Code Loading\\\"\\n        I[\\\"Determine error.xml path\\u003cbr/\\u003ebased on sys.platform\\\"]\\n        J[\\\"ET.parse(ctp_xml_path)\\\"]\\n        K[\\\"Parse error elements\\\"]\\n        L[\\\"Build ctp_errors dict\\\"]\\n    end\\n    \\n    A --\\u003e B\\n    B --\\u003e C\\n    C --\\u003e D\\n    D --\\u003e|\\\"No\\\"| E\\n    E --\\u003e F\\n    F --\\u003e G\\n    D --\\u003e|\\\"Yes\\\"| G\\n    G --\\u003e H\\n    \\n    A --\\u003e I\\n    I --\\u003e J\\n    J --\\u003e K\\n    K --\\u003e L\\n    \\n    style H fill:#e1f5e1\\n    style L fill:#e1f5e1\\n```\\n\\nThe configuration module executes at import time, performing the following steps:\\n\\n1. **Determine Configuration Path**: Uses `appdirs.AppDirs('trader')` to locate the platform-specific user configuration directory [trader/utils/read_config.py:62-63]()\\n2. **Create Default if Missing**: If `config.ini` doesn't exist, creates it from the `config_example` template string [trader/utils/read_config.py:64-69]()\\n3. **Parse Configuration**: Loads settings using `configparser.ConfigParser` with `interpolation=None` to prevent variable expansion [trader/utils/read_config.py:71-72]()\\n4. **Load CTP Errors**: Parses `error.xml` to create the `ctp_errors` dictionary mapping error codes to Chinese prompt strings [trader/utils/read_config.py:74-78]()\\n\\n**Sources**: [trader/utils/read_config.py:16-79]()\\n\\n---\\n\\n## Global Configuration Objects\\n\\nThe `read_config` module exposes two primary objects that are imported throughout the codebase:\\n\\n### config Object\\n\\nThe `config` object is a `ConfigParser` instance providing access to all runtime settings:\\n\\n```python\\n# Example usage in codebase:\\nfrom trader.utils.read_config import config\\n\\nredis_host = config.get('REDIS', 'host')\\nredis_port = config.getint('REDIS', 'port')\\nlog_level = config.get('LOG', 'level')\\n```\\n\\n**Key Methods**:\\n- `config.get(section, option)` - Retrieve string value\\n- `config.getint(section, option)` - Retrieve integer value\\n- `config.getboolean(section, option)` - Retrieve boolean value\\n- `config.has_section(section)` - Check section existence\\n\\n**Sources**: [trader/utils/read_config.py:71-72]()\\n\\n### ctp_errors Dictionary\\n\\nThe `ctp_errors` dictionary maps CTP error codes (integers) to Chinese error messages (strings). This is populated from `error.xml` which contains the official CTP API error definitions.\\n\\n```python\\n# Example: ctp_errors[1] = ''\\n```\\n\\nThe error XML path is platform-specific:\\n- Windows: `D:/github/trader/trader/utils/error.xml`\\n- Linux: `/root/gitee/trader/trader/utils/error.xml`\\n\\n**Sources**: [trader/utils/read_config.py:74-78]()\\n\\n---\\n\\n## Constants and Enumeration System\\n\\nThe `panel/const.py` module defines all domain-specific constants using the `djchoices` library, which provides Django-compatible enumeration types. These constants ensure type safety and provide human-readable labels for database values.\\n\\n### Enumeration Pattern\\n\\nAll enumerations follow the `DjangoChoices` pattern:\\n\\n```python\\nclass ExampleType(DjangoChoices):\\n    OPTION1 = C(label='')\\n    OPTION2 = C(value='custom_value', label='')\\n    OPTION3 = C(value=b'0'[0], label='')\\n```\\n\\nThis pattern provides:\\n- Type-safe enumeration members\\n- Database storage values (defaults to member name if not specified)\\n- Human-readable Chinese labels for UI display\\n- Integration with Django model choice fields\\n\\n**Sources**: [panel/const.py:16-178]()\\n\\n### Core Enumeration Types\\n\\nThe system defines 11 primary enumeration classes:\\n\\n| Enumeration | Purpose | Value Count |\\n|-------------|---------|-------------|\\n| `ContractType` | Security type classification | 3 (, , ) |\\n| `ExchangeType` | Chinese exchange identifiers | 6 (SHFE, DCE, CZCE, CFFEX, INE, GFEX) |\\n| `SectionType` | Market sector categories | 6 (Metal, Agricultural, Energy, etc.) |\\n| `SortType` | Detailed commodity classification | 9 (Rare metals, Feed, Cotton, etc.) |\\n| `AddressType` | CTP API connection types | 2 (, ) |\\n| `OperatorType` | Network operator | 2 (, ) |\\n| `DirectionType` | Position direction | 2 (/LONG, /SHORT) |\\n| `OffsetFlag` | Open/close action | 7 (, , , etc.) |\\n| `CombOffsetFlag` | Combined offset flag | 7 (string-based values) |\\n| `OrderStatus` | Order state | 9 (AllTraded, PartTraded, Canceled, etc.) |\\n| `OrderSubmitStatus` | Order submission state | 7 (Submitted, Accepted, Rejected, etc.) |\\n| `SignalType` | Trading signal classification | 6 (BUY, SELL, ROLL_OPEN, etc.) |\\n| `PriorityType` | Signal priority levels | 3 (LOW, Normal, High) |\\n\\n**Sources**: [panel/const.py:19-178]()\\n\\n---\\n\\n## Exchange-Specific Mappings\\n\\nThe `const.py` module also defines static dictionaries for exchange-specific data transformations:\\n\\n### DCE_NAME_CODE Dictionary\\n\\nMaps Chinese commodity names to DCE (Dalian Commodity Exchange) instrument codes. This is used when processing DCE data files which use Chinese names.\\n\\n```python\\nDCE_NAME_CODE = {\\n    '': 'a',      # Soybean No.1\\n    '': 'b',      # Soybean No.2\\n    '': 'i',    # Iron ore\\n    '': 'j',      # Coke\\n    # ... 23 total mappings\\n}\\n```\\n\\n**Sources**: [panel/const.py:112-136]()\\n\\n### MONTH_CODE Dictionary\\n\\nConverts numeric month (1-12) to single-letter month codes used in futures contract naming conventions:\\n\\n```python\\nMONTH_CODE = {\\n    1: \\\"F\\\", 2: \\\"G\\\", 3: \\\"H\\\", 4: \\\"J\\\",\\n    5: \\\"K\\\", 6: \\\"M\\\", 7: \\\"N\\\", 8: \\\"Q\\\",\\n    9: \\\"U\\\", 10: \\\"V\\\", 11: \\\"X\\\", 12: \\\"Z\\\"\\n}\\n```\\n\\n**Sources**: [panel/const.py:138-151]()\\n\\n### KT_MARKET Dictionary\\n\\nMaps Kingtech trading system exchange codes to standard exchange identifiers:\\n\\n```python\\nKT_MARKET = {\\n    'DL': 'DCE',    # Dalian\\n    'DY': 'DCE',\\n    'SQ': 'SHFE',   # Shanghai\\n    'SY': 'SHFE',\\n    'ZJ': 'CFFEX',  # China Financial\\n    'ZZ': 'CZCE',   # Zhengzhou\\n    'ZY': 'CZCE',\\n}\\n```\\n\\n**Sources**: [panel/const.py:154-162]()\\n\\n---\\n\\n## Configuration Usage Pattern\\n\\nThe following diagram illustrates how configuration flows through the system from loading to consumption:\\n\\n```mermaid\\ngraph TB\\n    subgraph \\\"Module Import Time\\\"\\n        ImportRC[\\\"import read_config\\\"]\\n        ImportConst[\\\"import panel.const\\\"]\\n    end\\n    \\n    subgraph \\\"Configuration Objects Created\\\"\\n        ConfigObj[\\\"config: ConfigParser\\\"]\\n        CTPErr[\\\"ctp_errors: Dict\\\"]\\n        Enums[\\\"Enumeration Classes\\\"]\\n    end\\n    \\n    subgraph \\\"Consumer Modules\\\"\\n        Main[\\\"trader/main.py\\\"]\\n        Strategy[\\\"trader/strategy/brother2.py\\\"]\\n        BaseModule[\\\"trader/strategy/__init__.py\\\"]\\n        Utils[\\\"trader/utils/__init__.py\\\"]\\n        Models[\\\"panel/models.py\\\"]\\n    end\\n    \\n    subgraph \\\"Configuration Consumers\\\"\\n        Redis[\\\"Redis Connection\\u003cbr/\\u003ehost, port, db\\\"]\\n        MySQL[\\\"MySQL Connection\\u003cbr/\\u003ehost, port, credentials\\\"]\\n        Logger[\\\"Logging Setup\\u003cbr/\\u003elevel, format\\\"]\\n        Trading[\\\"Trading Parameters\\u003cbr/\\u003etimeout, ignored instruments\\\"]\\n        ModelFields[\\\"Model Choice Fields\\u003cbr/\\u003eDirectionType, SignalType\\\"]\\n    end\\n    \\n    ImportRC --\\u003e ConfigObj\\n    ImportRC --\\u003e CTPErr\\n    ImportConst --\\u003e Enums\\n    \\n    Main --\\u003e ConfigObj\\n    Strategy --\\u003e ConfigObj\\n    Strategy --\\u003e Enums\\n    BaseModule --\\u003e ConfigObj\\n    Utils --\\u003e ConfigObj\\n    Models --\\u003e Enums\\n    \\n    ConfigObj --\\u003e Redis\\n    ConfigObj --\\u003e MySQL\\n    ConfigObj --\\u003e Logger\\n    ConfigObj --\\u003e Trading\\n    Enums --\\u003e ModelFields\\n    \\n    CTPErr --\\u003e Strategy\\n```\\n\\n**Key Import Patterns**:\\n\\n1. **Runtime Configuration**: `from trader.utils.read_config import config`\\n2. **CTP Errors**: `from trader.utils.read_config import ctp_errors`\\n3. **Enumerations**: `from panel.const import ExchangeType, DirectionType, SignalType`\\n\\n**Sources**: [trader/utils/read_config.py:1-79](), [panel/const.py:1-178]()\\n\\n---\\n\\n## Configuration Validation\\n\\nThe system performs minimal validation at load time:\\n\\n1. **File Creation**: If `config.ini` is missing, a default template is created with example values [trader/utils/read_config.py:64-69]()\\n2. **XML Parsing**: If `error.xml` cannot be parsed, the import will fail with an exception [trader/utils/read_config.py:77-78]()\\n3. **No Runtime Validation**: The system does not validate configuration values at load time; invalid values will cause runtime errors when accessed\\n\\n### Common Configuration Issues\\n\\n| Issue | Symptom | Resolution |\\n|-------|---------|------------|\\n| Missing config.ini | File auto-created on first run | Edit auto-generated file with actual values |\\n| Incorrect error.xml path | ImportError at module load | Verify path matches platform (Windows/Linux) |\\n| Invalid Redis/MySQL credentials | Connection errors at runtime | Check `REDIS` and `MYSQL` sections |\\n| Wrong encoding | Unicode errors with Chinese text | Ensure `encoding = utf-8` in `REDIS` section |\\n\\n---\\n\\n## Configuration Reference Summary\\n\\nThis page introduced the trader system's dual-layer configuration architecture:\\n\\n1. **Runtime Configuration** (`config.ini`): Loaded via `read_config` module, providing flexible settings for connections, API credentials, and system behavior\\n2. **Static Constants** (`panel/const.py`): Type-safe enumerations defining the trading domain model using `DjangoChoices`\\n\\nFor detailed parameter documentation, proceed to:\\n- [Configuration File Format](#7.1) for `config.ini` section specifications\\n- [Constants and Enumerations](#7.2) for complete enumeration reference\\n\\n**Sources**: [trader/utils/read_config.py:1-79](), [panel/const.py:1-178]()\"])</script><script>self.__next_f.push([1,\"33:T2623,\"])</script><script>self.__next_f.push([1,\"# Configuration File Format\\n\\n\\u003cdetails\\u003e\\n\\u003csummary\\u003eRelevant source files\\u003c/summary\\u003e\\n\\nThe following files were used as context for generating this wiki page:\\n\\n- [trader/utils/read_config.py](trader/utils/read_config.py)\\n\\n\\u003c/details\\u003e\\n\\n\\n\\n## Purpose and Scope\\n\\nThis document describes the structure and format of the `config.ini` file used by the trader system. The configuration file controls Redis message channels, trading parameters, database connections, external API credentials, and logging settings. \\n\\nFor information about system constants and enumerations defined in code, see [Constants and Enumerations](#7.2). For initial system setup and configuration instructions, see [Configuration](#2.2).\\n\\n**Sources:** [trader/utils/read_config.py:1-79]()\\n\\n---\\n\\n## File Location\\n\\nThe configuration file is automatically created on first run using the `appdirs` library to determine platform-specific user configuration directories. The file location is stored in the `config_file` variable.\\n\\n```\\nconfig_file = os.path.join(app_dir.user_config_dir, 'config.ini')\\n```\\n\\n**Platform-Specific Locations:**\\n\\n| Platform | Typical Location |\\n|----------|------------------|\\n| Linux/Unix | `~/.config/trader/config.ini` |\\n| Windows | `C:\\\\Users\\\\\\u003cusername\\u003e\\\\AppData\\\\Local\\\\trader\\\\config.ini` |\\n| macOS | `~/Library/Application Support/trader/config.ini` |\\n\\nIf the configuration file does not exist, the system automatically creates it with default example values from the `config_example` string template defined in [trader/utils/read_config.py:23-60]().\\n\\n**Sources:** [trader/utils/read_config.py:62-69]()\\n\\n---\\n\\n## Configuration File Structure\\n\\n### Configuration Loading Process\\n\\n```mermaid\\nflowchart TD\\n    Start[\\\"System Startup\\\"]\\n    CheckFile{\\\"config.ini\\u003cbr/\\u003eexists?\\\"}\\n    CreateDir[\\\"os.makedirs()\\u003cbr/\\u003eCreate user_config_dir\\\"]\\n    WriteFile[\\\"Write config_example\\u003cbr/\\u003eto config.ini\\\"]\\n    LoadConfig[\\\"configparser.ConfigParser()\\u003cbr/\\u003econfig.read(config_file)\\\"]\\n    LoadXML[\\\"ET.parse(ctp_xml_path)\\u003cbr/\\u003eLoad error.xml\\\"]\\n    BuildDict[\\\"Build ctp_errors dict\\u003cbr/\\u003eMap error codes to messages\\\"]\\n    Ready[\\\"Config ready\\u003cbr/\\u003econfig object available\\\"]\\n    \\n    Start --\\u003e CheckFile\\n    CheckFile --\\u003e|No| CreateDir\\n    CreateDir --\\u003e WriteFile\\n    WriteFile --\\u003e LoadConfig\\n    CheckFile --\\u003e|Yes| LoadConfig\\n    LoadConfig --\\u003e LoadXML\\n    LoadXML --\\u003e BuildDict\\n    BuildDict --\\u003e Ready\\n```\\n\\n**Sources:** [trader/utils/read_config.py:62-78]()\\n\\n---\\n\\n## Configuration Sections\\n\\n### MSG_CHANNEL Section\\n\\nControls Redis message channel patterns for communication between the trader system and the CTP API gateway. These patterns define how messages are published and subscribed across the system.\\n\\n| Parameter | Default Value | Description |\\n|-----------|---------------|-------------|\\n| `request_pattern` | `MSG:CTP:REQ:*` | Pattern for subscribing to all CTP request messages |\\n| `request_format` | `MSG:CTP:REQ:{}` | Format string for publishing specific CTP requests |\\n| `trade_response_prefix` | `MSG:CTP:RSP:TRADE:` | Prefix for trade response channels |\\n| `trade_response_format` | `MSG:CTP:RSP:TRADE:{}:{}` | Format string for trade responses (BrokerID, OrderRef) |\\n| `market_response_prefix` | `MSG:CTP:RSP:MARKET:` | Prefix for market data response channels |\\n| `market_response_format` | `MSG:CTP:RSP:MARKET:{}:{}` | Format string for market data responses |\\n| `weixin_log` | `MSG:LOG:WEIXIN` | Channel for WeChat notification logs |\\n\\n**Sources:** [trader/utils/read_config.py:24-31]()\\n\\n---\\n\\n### TRADE Section\\n\\nConfigures trading system behavior and instrument filtering.\\n\\n| Parameter | Default Value | Description |\\n|-----------|---------------|-------------|\\n| `command_timeout` | `5` | Timeout in seconds for CTP command responses |\\n| `ignore_inst` | `WH,bb,JR,RI,RS,LR,PM,im` | Comma-separated list of instrument codes to ignore in trading |\\n\\n**Sources:** [trader/utils/read_config.py:33-35]()\\n\\n---\\n\\n### REDIS Section\\n\\nSpecifies Redis connection parameters for the message bus and caching layer.\\n\\n| Parameter | Default Value | Description |\\n|-----------|---------------|-------------|\\n| `host` | `127.0.0.1` | Redis server hostname or IP address |\\n| `port` | `6379` | Redis server port |\\n| `db` | `0` | Redis database number (0-15) |\\n| `encoding` | `utf-8` | Character encoding for Redis data |\\n\\n**Sources:** [trader/utils/read_config.py:37-41]()\\n\\n---\\n\\n### MYSQL Section\\n\\nDefines MySQL database connection parameters for Django ORM persistence.\\n\\n| Parameter | Default Value | Description |\\n|-----------|---------------|-------------|\\n| `host` | `127.0.0.1` | MySQL server hostname or IP address |\\n| `port` | `3306` | MySQL server port |\\n| `db` | `QuantDB` | Database name |\\n| `user` | `quant` | Database username |\\n| `password` | `123456` | Database password (change in production) |\\n\\n**Sources:** [trader/utils/read_config.py:43-48]()\\n\\n---\\n\\n### QuantDL Section\\n\\nAPI key for QuantDL data service (if used for market data acquisition).\\n\\n| Parameter | Default Value | Description |\\n|-----------|---------------|-------------|\\n| `api_key` | `123456` | QuantDL API authentication key |\\n\\n**Sources:** [trader/utils/read_config.py:50-51]()\\n\\n---\\n\\n### Tushare Section\\n\\nAPI token for Tushare Pro data service (if used for market data acquisition).\\n\\n| Parameter | Default Value | Description |\\n|-----------|---------------|-------------|\\n| `token` | `123456` | Tushare Pro API token |\\n\\n**Sources:** [trader/utils/read_config.py:53-54]()\\n\\n---\\n\\n### LOG Section\\n\\nControls logging behavior and format strings.\\n\\n| Parameter | Default Value | Description |\\n|-----------|---------------|-------------|\\n| `level` | `DEBUG` | Logging level: DEBUG, INFO, WARNING, ERROR, CRITICAL |\\n| `format` | `%(asctime)s %(name)s [%(levelname)s] %(message)s` | Python logging format string for standard logs |\\n| `weixin_format` | `[%(levelname)s] %(message)s` | Simplified format for WeChat notifications |\\n\\n**Sources:** [trader/utils/read_config.py:56-59]()\\n\\n---\\n\\n## Configuration Access Pattern\\n\\nThe configuration is loaded as a global `config` object using Python's `configparser.ConfigParser` with `interpolation=None` to prevent variable expansion.\\n\\n```mermaid\\nflowchart LR\\n    subgraph \\\"trader/utils/read_config.py\\\"\\n        ConfigFile[\\\"config_file\\u003cbr/\\u003eos.path.join(app_dir.user_config_dir,\\u003cbr/\\u003e'config.ini')\\\"]\\n        ConfigParser[\\\"config\\u003cbr/\\u003econfigparser.ConfigParser(interpolation=None)\\\"]\\n        ConfigObj[\\\"config object\\u003cbr/\\u003eGlobal access point\\\"]\\n    end\\n    \\n    subgraph \\\"Consumer Modules\\\"\\n        TradeStrategy[\\\"TradeStrategy\\u003cbr/\\u003etrader/strategy/brother2.py\\\"]\\n        BaseModule[\\\"BaseModule\\u003cbr/\\u003etrader/strategy/__init__.py\\\"]\\n        FetchData[\\\"fetch_data\\u003cbr/\\u003etrader/utils/fetch_data.py\\\"]\\n    end\\n    \\n    ConfigFile --\\u003e ConfigParser\\n    ConfigParser --\\u003e ConfigObj\\n    \\n    ConfigObj --\\u003e|\\\"import config\\u003cbr/\\u003econfig.get('REDIS', 'host')\\\"| TradeStrategy\\n    ConfigObj --\\u003e|\\\"import config\\\"| BaseModule\\n    ConfigObj --\\u003e|\\\"import config\\\"| FetchData\\n```\\n\\n**Access Example:**\\n```python\\nfrom trader.utils.read_config import config\\n\\n# Access Redis host\\nredis_host = config.get('REDIS', 'host')\\n\\n# Access MySQL configuration\\ndb_name = config.get('MYSQL', 'db')\\ndb_user = config.get('MYSQL', 'user')\\n```\\n\\n**Sources:** [trader/utils/read_config.py:71-72]()\\n\\n---\\n\\n## CTP Error Code Mapping\\n\\nIn addition to the configuration file, the `read_config` module loads CTP error definitions from an XML file (`error.xml`) and builds a lookup dictionary `ctp_errors`.\\n\\n### Error XML Location\\n\\nThe system determines the XML file path based on the platform:\\n\\n| Platform | Path |\\n|----------|------|\\n| Windows (`sys.platform == 'win32'`) | `D:/github/trader/trader/utils/error.xml` |\\n| Linux/Unix | `/root/gitee/trader/trader/utils/error.xml` |\\n\\n### Error Dictionary Structure\\n\\n```mermaid\\ngraph LR\\n    XML[\\\"error.xml\\u003cbr/\\u003eET.parse(ctp_xml_path)\\\"]\\n    Root[\\\"XML root element\\\"]\\n    Error1[\\\"\\u0026lt;error value='1' prompt='...'\\u0026gt;\\\"]\\n    Error2[\\\"\\u0026lt;error value='2' prompt='...'\\u0026gt;\\\"]\\n    ErrorN[\\\"\\u0026lt;error value='N' prompt='...'\\u0026gt;\\\"]\\n    Dict[\\\"ctp_errors dict\\u003cbr/\\u003e{int: str}\\\"]\\n    \\n    XML --\\u003e Root\\n    Root --\\u003e Error1\\n    Root --\\u003e Error2\\n    Root --\\u003e ErrorN\\n    Error1 --\\u003e|\\\"int(error.attrib['value'])\\\"| Dict\\n    Error2 --\\u003e Dict\\n    ErrorN --\\u003e Dict\\n```\\n\\nThe resulting `ctp_errors` dictionary maps integer error codes to human-readable error messages:\\n\\n```python\\nctp_errors = {\\n    1: \\\"Error message for code 1\\\",\\n    2: \\\"Error message for code 2\\\",\\n    # ... additional mappings\\n}\\n```\\n\\nThis dictionary is used throughout the system to translate CTP API error codes into meaningful messages for logging and error handling.\\n\\n**Sources:** [trader/utils/read_config.py:74-78]()\\n\\n---\\n\\n## Configuration Format Syntax\\n\\nThe configuration file uses standard INI format parsed by Python's `configparser` module:\\n\\n- **Sections:** Defined by `[SECTION_NAME]` headers\\n- **Key-Value Pairs:** `key = value` format\\n- **Comments:** Lines starting with `#` are comments\\n- **No Interpolation:** Variable expansion is disabled (`interpolation=None`)\\n- **Case Sensitivity:** Section names are case-sensitive; keys are case-insensitive by default\\n\\n**Example Section:**\\n```ini\\n[REDIS]\\nhost = 127.0.0.1\\nport = 6379\\ndb = 0\\nencoding = utf-8\\n```\\n\\n**Sources:** [trader/utils/read_config.py:23-60,71-72]()\\n\\n---\\n\\n## Module-Level Exports\\n\\nThe `read_config` module exports the following objects for use throughout the system:\\n\\n| Object | Type | Description |\\n|--------|------|-------------|\\n| `config_example` | `str` | Template string containing default configuration |\\n| `app_dir` | `AppDirs` | Application directory manager |\\n| `config_file` | `str` | Absolute path to configuration file |\\n| `config` | `ConfigParser` | Loaded configuration object |\\n| `ctp_errors` | `dict[int, str]` | CTP error code to message mapping |\\n\\n**Sources:** [trader/utils/read_config.py:23-78]()\"])</script><script>self.__next_f.push([1,\"34:T7513,\"])</script><script>self.__next_f.push([1,\"# Constants and Enumerations\\n\\n\\u003cdetails\\u003e\\n\\u003csummary\\u003eRelevant source files\\u003c/summary\\u003e\\n\\nThe following files were used as context for generating this wiki page:\\n\\n- [panel/const.py](panel/const.py)\\n- [trader/utils/ApiStruct.py](trader/utils/ApiStruct.py)\\n- [trader/utils/tick.py](trader/utils/tick.py)\\n\\n\\u003c/details\\u003e\\n\\n\\n\\nThis document provides a comprehensive reference for all constants, enumerations, and fixed value mappings used throughout the trader system. These definitions establish the standard vocabulary for instrument types, trading operations, exchange identifiers, and CTP API interactions.\\n\\nFor configuration values that can be modified by users (such as connection strings, API keys, and operational parameters), see [Configuration File Format](#7.1). This page focuses exclusively on hard-coded system constants that define the trading domain model.\\n\\n---\\n\\n## Purpose and Scope\\n\\nThe trader system uses two primary sources of constants:\\n\\n1. **Django Enumerations** ([panel/const.py:1-178]()): Application-level enumerations using the `djchoices` library for database-backed choices\\n2. **CTP API Constants** ([trader/utils/ApiStruct.py:1-1985]()): Low-level CTP trading platform protocol constants and error codes\\n\\nThese constants provide type safety, validate user input, enable database storage of standardized values, and map between system representations and exchange protocols.\\n\\n---\\n\\n## Django Enumeration Framework\\n\\nAll application-level enumerations extend `DjangoChoices` and use the `C()` constructor to define choice values. This pattern provides both Python code constants and Django ORM field choices.\\n\\n```mermaid\\ngraph TB\\n    subgraph \\\"Django Models Layer\\\"\\n        Broker[Broker Model]\\n        Strategy[Strategy Model]\\n        Instrument[Instrument Model]\\n        Order[Order Model]\\n        Trade[Trade Model]\\n        Signal[Signal Model]\\n    end\\n    \\n    subgraph \\\"Constants Module\\u003cbr/\\u003epanel/const.py\\\"\\n        ContractType[ContractType\\u003cbr/\\u003eSTOCK, FUTURE, OPTION]\\n        ExchangeType[ExchangeType\\u003cbr/\\u003eSHFE, DCE, CZCE, CFFEX, INE, GFEX]\\n        DirectionType[DirectionType\\u003cbr/\\u003eLONG, SHORT]\\n        OffsetFlag[OffsetFlag\\u003cbr/\\u003eOpen, Close, CloseToday, etc.]\\n        OrderStatus[OrderStatus\\u003cbr/\\u003eAllTraded, PartTraded, Canceled, etc.]\\n        SignalType[SignalType\\u003cbr/\\u003eBUY, SELL, ROLL_OPEN, ROLL_CLOSE]\\n    end\\n    \\n    Instrument --\\u003e ContractType\\n    Instrument --\\u003e ExchangeType\\n    Order --\\u003e DirectionType\\n    Order --\\u003e OffsetFlag\\n    Order --\\u003e OrderStatus\\n    Trade --\\u003e DirectionType\\n    Trade --\\u003e OffsetFlag\\n    Signal --\\u003e SignalType\\n    Signal --\\u003e DirectionType\\n```\\n\\n**Sources:** [panel/const.py:16-178](), [panel/models.py:1-500]()\\n\\n---\\n\\n## Contract and Instrument Enumerations\\n\\n### ContractType\\n\\nDefines the fundamental asset class for trading instruments.\\n\\n| Python Constant | Value | Label | Database Field Type |\\n|----------------|-------|-------|-------------------|\\n| `ContractType.STOCK` | `'STOCK'` |  (Stock) | CharField |\\n| `ContractType.FUTURE` | `'FUTURE'` |  (Futures) | CharField |\\n| `ContractType.OPTION` | `'OPTION'` |  (Options) | CharField |\\n\\n**Usage Example:**\\n```python\\nfrom panel.const import ContractType\\n\\n# In Instrument model\\ncontract_type = models.CharField(\\n    max_length=10, \\n    choices=ContractType.choices\\n)\\n\\n# Querying futures contracts\\nfutures = Instrument.objects.filter(\\n    contract_type=ContractType.FUTURE\\n)\\n```\\n\\n**Sources:** [panel/const.py:19-22]()\\n\\n### ExchangeType\\n\\nIdentifies the Chinese commodity and financial futures exchanges supported by the system.\\n\\n| Python Constant | Value | Label | Exchange Name |\\n|----------------|-------|-------|---------------|\\n| `ExchangeType.SHFE` | `'SHFE'` |  | Shanghai Futures Exchange |\\n| `ExchangeType.DCE` | `'DCE'` |  | Dalian Commodity Exchange |\\n| `ExchangeType.CZCE` | `'CZCE'` |  | Zhengzhou Commodity Exchange |\\n| `ExchangeType.CFFEX` | `'CFFEX'` |  | China Financial Futures Exchange |\\n| `ExchangeType.INE` | `'INE'` |  | Shanghai Int'l Energy Exchange |\\n| `ExchangeType.GFEX` | `'GFEX'` |  | Guangzhou Futures Exchange |\\n\\n**Integration with Data Acquisition:**\\n\\n```mermaid\\ngraph LR\\n    DataFetch[\\\"trader/utils/fetch_data.py\\u003cbr/\\u003eupdate_exchange_data()\\\"]\\n    SHFE[\\\"update_from_shfe()\\u003cbr/\\u003eExchangeType.SHFE\\\"]\\n    DCE[\\\"update_from_dce()\\u003cbr/\\u003eExchangeType.DCE\\\"]\\n    CZCE[\\\"update_from_czce()\\u003cbr/\\u003eExchangeType.CZCE\\\"]\\n    CFFEX[\\\"update_from_cffex()\\u003cbr/\\u003eExchangeType.CFFEX\\\"]\\n    GFEX[\\\"update_from_gfex()\\u003cbr/\\u003eExchangeType.GFEX\\\"]\\n    \\n    DailyBar[\\\"DailyBar Model\\u003cbr/\\u003eexchange field\\\"]\\n    MainBar[\\\"MainBar Model\\u003cbr/\\u003eexchange field\\\"]\\n    \\n    DataFetch --\\u003e SHFE \\u0026 DCE \\u0026 CZCE \\u0026 CFFEX \\u0026 GFEX\\n    SHFE \\u0026 DCE \\u0026 CZCE \\u0026 CFFEX \\u0026 GFEX --\\u003e DailyBar\\n    DailyBar --\\u003e MainBar\\n```\\n\\n**Sources:** [panel/const.py:25-31](), [trader/utils/__init__.py:100-450]()\\n\\n### SectionType and SortType\\n\\nCommodity classification hierarchies for organizing instruments.\\n\\n**SectionType** (Broad Categories):\\n\\n| Constant | Label |\\n|----------|-------|\\n| `SectionType.Stock` |  (Stock) |\\n| `SectionType.Bond` |  (Bond) |\\n| `SectionType.Metal` |  (Base Metals) |\\n| `SectionType.Agricultural` |  (Agricultural) |\\n| `SectionType.EnergyChemical` |  (Energy/Chemical) |\\n| `SectionType.BlackMaterial` |  (Black Materials) |\\n\\n**SortType** (Detailed Categories):\\n\\n| Constant | Label | Section |\\n|----------|-------|---------|\\n| `SortType.Rare` |  (Precious Metals) | Metal |\\n| `SortType.Metal` |  (Base Metals) | Metal |\\n| `SortType.EdibleOil` |  (Edible Oil) | Agricultural |\\n| `SortType.Feed` |  (Animal Feed) | Agricultural |\\n| `SortType.Cotton` |  (Cotton) | Agricultural |\\n| `SortType.EnergyChemical` |  | EnergyChemical |\\n| `SortType.BlackMaterial` |  | BlackMaterial |\\n\\n**Sources:** [panel/const.py:34-53]()\\n\\n---\\n\\n## Trading Operation Enumerations\\n\\n### DirectionType\\n\\nSpecifies long or short position direction.\\n\\n| Python Constant | Value | Label | CTP API Value |\\n|----------------|-------|-------|---------------|\\n| `DirectionType.LONG` | `48` (b'0'[0]) |  (Long) | `'0'` |\\n| `DirectionType.SHORT` | `49` (b'1'[0]) |  (Short) | `'1'` |\\n\\nThe byte values (`b'0'[0]`) convert CTP API character codes to integer ASCII values for database storage.\\n\\n**Usage in Order Execution:**\\n```python\\nfrom panel.const import DirectionType, OffsetFlag\\n\\n# Opening a long position\\norder = Order.objects.create(\\n    direction=DirectionType.LONG,\\n    offset_flag=OffsetFlag.Open,\\n    instrument=instrument,\\n    price=price,\\n    volume=volume\\n)\\n```\\n\\n**Sources:** [panel/const.py:65-67]()\\n\\n### OffsetFlag and CombOffsetFlag\\n\\nControls position opening and closing operations.\\n\\n#### OffsetFlag (Single Character)\\n\\n| Python Constant | Value | Label | CTP API |\\n|----------------|-------|-------|---------|\\n| `OffsetFlag.Open` | `48` (b'0'[0]) |  (Open) | `'0'` |\\n| `OffsetFlag.Close` | `49` (b'1'[0]) |  (Close) | `'1'` |\\n| `OffsetFlag.ForceClose` | `50` (b'2'[0]) |  (Force Close) | `'2'` |\\n| `OffsetFlag.CloseToday` | `51` (b'3'[0]) |  (Close Today) | `'3'` |\\n| `OffsetFlag.CloseYesterday` | `52` (b'4'[0]) |  (Close Yesterday) | `'4'` |\\n| `OffsetFlag.ForceOff` | `53` (b'5'[0]) |  (Force Off) | `'5'` |\\n| `OffsetFlag.LocalForceClose` | `54` (b'6'[0]) |  (Local Force) | `'6'` |\\n\\n#### CombOffsetFlag (String for Multiple Legs)\\n\\nString-based version for combination orders, using values `'0'` through `'6'` matching the byte values above.\\n\\n**Position Management Logic:**\\n\\n```mermaid\\ngraph TD\\n    CheckPosition[\\\"Check Current Position\\\"]\\n    HasPosition{Has Position?}\\n    SameDirection{Same Direction?}\\n    SelectOffset[\\\"Select OffsetFlag\\\"]\\n    \\n    CheckPosition --\\u003e HasPosition\\n    HasPosition --\\u003e|No Position| Open[\\\"OffsetFlag.Open\\\"]\\n    HasPosition --\\u003e|Has Position| SameDirection\\n    SameDirection --\\u003e|Yes| AddPosition[\\\"OffsetFlag.Open\\u003cbr/\\u003eAdd to position\\\"]\\n    SameDirection --\\u003e|No| SelectOffset\\n    SelectOffset --\\u003e CloseToday[\\\"OffsetFlag.CloseToday\\u003cbr/\\u003eFor today's position\\\"]\\n    SelectOffset --\\u003e CloseYesterday[\\\"OffsetFlag.CloseYesterday\\u003cbr/\\u003eFor yesterday's position\\\"]\\n    SelectOffset --\\u003e Close[\\\"OffsetFlag.Close\\u003cbr/\\u003eExchange auto-selects\\\"]\\n```\\n\\n**Sources:** [panel/const.py:70-88]()\\n\\n### OrderStatus\\n\\nTracks the lifecycle state of orders in the CTP system.\\n\\n| Python Constant | Value | Label | Description |\\n|----------------|-------|-------|-------------|\\n| `OrderStatus.AllTraded` | `48` (b'0'[0]) |  | Completely filled |\\n| `OrderStatus.PartTradedQueueing` | `49` (b'1'[0]) |  | Partially filled, still active |\\n| `OrderStatus.PartTradedNotQueueing` | `50` (b'2'[0]) |  | Partially filled, removed |\\n| `OrderStatus.NoTradeQueueing` | `51` (b'3'[0]) |  | Pending in order book |\\n| `OrderStatus.NoTradeNotQueueing` | `52` (b'4'[0]) |  | Not filled, removed |\\n| `OrderStatus.Canceled` | `53` (b'5'[0]) |  | Cancelled |\\n| `OrderStatus.Unknown` | `97` (b'a'[0]) |  | Unknown status |\\n| `OrderStatus.NotTouched` | `98` (b'b'[0]) |  | Conditional not triggered |\\n| `OrderStatus.Touched` | `99` (b'c'[0]) |  | Conditional triggered |\\n\\n**Order State Machine:**\\n\\n```mermaid\\nstateDiagram-v2\\n    [*] --\\u003e InsertSubmitted: ReqOrderInsert\\n    InsertSubmitted --\\u003e NoTradeQueueing: Accepted\\n    InsertSubmitted --\\u003e InsertRejected: Rejected\\n    \\n    NoTradeQueueing --\\u003e PartTradedQueueing: Partial Fill\\n    NoTradeQueueing --\\u003e AllTraded: Complete Fill\\n    NoTradeQueueing --\\u003e Canceled: Cancel Request\\n    \\n    PartTradedQueueing --\\u003e AllTraded: Remaining Filled\\n    PartTradedQueueing --\\u003e Canceled: Cancel Partial\\n    PartTradedQueueing --\\u003e PartTradedNotQueueing: Removed\\n    \\n    AllTraded --\\u003e [*]\\n    Canceled --\\u003e [*]\\n    InsertRejected --\\u003e [*]\\n    PartTradedNotQueueing --\\u003e [*]\\n```\\n\\n**Sources:** [panel/const.py:90-100]()\\n\\n### OrderSubmitStatus\\n\\nTracks submission and modification status independent of trading status.\\n\\n| Python Constant | Value | Label |\\n|----------------|-------|-------|\\n| `OrderSubmitStatus.InsertSubmitted` | `48` (b'0'[0]) |  |\\n| `OrderSubmitStatus.CancelSubmitted` | `49` (b'1'[0]) |  |\\n| `OrderSubmitStatus.ModifySubmitted` | `50` (b'2'[0]) |  |\\n| `OrderSubmitStatus.Accepted` | `51` (b'3'[0]) |  |\\n| `OrderSubmitStatus.InsertRejected` | `52` (b'4'[0]) |  |\\n| `OrderSubmitStatus.CancelRejected` | `53` (b'5'[0]) |  |\\n| `OrderSubmitStatus.ModifyRejected` | `54` (b'6'[0]) |  |\\n\\n**Sources:** [panel/const.py:102-110]()\\n\\n### SignalType\\n\\nDefines trading signal types generated by strategy logic.\\n\\n| Python Constant | Label | Description |\\n|----------------|-------|-------------|\\n| `SignalType.ROLL_CLOSE` |  | Close old contract during rollover |\\n| `SignalType.ROLL_OPEN` |  | Open new contract during rollover |\\n| `SignalType.BUY` |  | Buy to open (long) |\\n| `SignalType.SELL_SHORT` |  | Sell to open (short) |\\n| `SignalType.SELL` |  | Sell to close (long) |\\n| `SignalType.BUY_COVER` |  | Buy to close (short) |\\n\\n**Signal to Order Conversion:**\\n\\n```mermaid\\ngraph LR\\n    subgraph \\\"Strategy Layer\\\"\\n        CalcSignal[\\\"calc_signal()\\u003cbr/\\u003etrader/utils/__init__.py\\\"]\\n        SignalModel[\\\"Signal Model\\u003cbr/\\u003esignal_type field\\\"]\\n    end\\n    \\n    subgraph \\\"Order Execution\\\"\\n        ProcessSignal[\\\"processing_signal1/2/3()\\u003cbr/\\u003eTradeStrategy\\\"]\\n        ConvertToOrder[\\\"Map SignalType to\\u003cbr/\\u003eDirectionType + OffsetFlag\\\"]\\n        ReqOrder[\\\"ReqOrderInsert()\\u003cbr/\\u003eCTP API\\\"]\\n    end\\n    \\n    CalcSignal --\\u003e SignalModel\\n    SignalModel --\\u003e ProcessSignal\\n    ProcessSignal --\\u003e ConvertToOrder\\n    ConvertToOrder --\\u003e ReqOrder\\n    \\n    BUY[\\\"SignalType.BUY\\\"] --\\u003e LongOpen[\\\"LONG + Open\\\"]\\n    SELL[\\\"SignalType.SELL\\\"] --\\u003e LongClose[\\\"LONG + Close\\\"]\\n    SELL_SHORT[\\\"SignalType.SELL_SHORT\\\"] --\\u003e ShortOpen[\\\"SHORT + Open\\\"]\\n    BUY_COVER[\\\"SignalType.BUY_COVER\\\"] --\\u003e ShortClose[\\\"SHORT + Close\\\"]\\n```\\n\\n**Sources:** [panel/const.py:165-172](), [trader/strategy/brother2.py:200-350]()\\n\\n### PriorityType\\n\\nOrder execution priority levels.\\n\\n| Python Constant | Value | Label |\\n|----------------|-------|-------|\\n| `PriorityType.LOW` | `0` |  (Low) |\\n| `PriorityType.Normal` | `1` |  (Normal) |\\n| `PriorityType.High` | `2` |  (High) |\\n\\n**Sources:** [panel/const.py:174-177]()\\n\\n---\\n\\n## Exchange and Broker Enumerations\\n\\n### AddressType\\n\\nDistinguishes between trading and market data connections.\\n\\n| Python Constant | Label |\\n|----------------|-------|\\n| `AddressType.TRADE` |  (Trading) |\\n| `AddressType.MARKET` |  (Market Data) |\\n\\n### OperatorType\\n\\nNetwork operator for connection routing (Chinese telecom infrastructure).\\n\\n| Python Constant | Label |\\n|----------------|-------|\\n| `OperatorType.TELECOM` |  (Telecom) |\\n| `OperatorType.UNICOM` |  (Unicom) |\\n\\n**Sources:** [panel/const.py:55-63]()\\n\\n---\\n\\n## Mapping Dictionaries\\n\\n### DCE_NAME_CODE\\n\\nMaps Dalian Commodity Exchange product names (Chinese) to instrument codes.\\n\\n```python\\nDCE_NAME_CODE = {\\n    '': 'a',      # Soybean No.1\\n    '': 'b',      # Soybean No.2\\n    '': 'bb',   # Blockboard\\n    '': 'c',      # Corn\\n    '': 'cs', # Corn Starch\\n    '': 'fb',   # Fiberboard\\n    '': 'i',    # Iron Ore\\n    '': 'j',      # Coke\\n    '': 'jd',     # Egg\\n    '': 'jm',     # Coking Coal\\n    '': 'l',    # LLDPE\\n    '': 'm',      # Soybean Meal\\n    '': 'p',    # Palm Oil\\n    '': 'pp',   # Polypropylene\\n    '': 'v',  # PVC\\n    '': 'eb',   # Styrene\\n    '': 'eg',   # Ethylene Glycol\\n    '': 'pg', # LPG\\n    '': 'lh',     # Live Hog\\n    '': 'rr',     # Japonica Rice\\n    '': 'y',      # Soybean Oil\\n    '': 'lg',     # Logs\\n    '': 'bz',     # Benzene\\n}\\n```\\n\\n**Usage in Data Acquisition:**\\n```python\\n# trader/utils/__init__.py update_from_dce()\\nproduct_name = row['']\\nproduct_code = DCE_NAME_CODE.get(product_name)\\n```\\n\\n**Sources:** [panel/const.py:112-136]()\\n\\n### MONTH_CODE\\n\\nConverts month numbers to CTP month letter codes.\\n\\n| Month | Code | Month | Code |\\n|-------|------|-------|------|\\n| 1 | F | 7 | N |\\n| 2 | G | 8 | Q |\\n| 3 | H | 9 | U |\\n| 4 | J | 10 | V |\\n| 5 | K | 11 | X |\\n| 6 | M | 12 | Z |\\n\\n**Usage Example:**\\n```python\\n# Convert date to CTP instrument code\\nyear = 2024\\nmonth = 3\\ncode = 'cu'  # Copper\\nmonth_letter = MONTH_CODE[month]  # 'H'\\ninstrument_id = f\\\"{code}{year % 100:02d}{month_letter}\\\"  # cu24H\\n```\\n\\n**Sources:** [panel/const.py:138-151]()\\n\\n### KT_MARKET\\n\\nMaps KT (Kingstar/) system market codes to standard exchange codes.\\n\\n| KT Code | Exchange | Full Name |\\n|---------|----------|-----------|\\n| `'DL'` | `'DCE'` | Dalian (Night) |\\n| `'DY'` | `'DCE'` | Dalian (Day) |\\n| `'SQ'` | `'SHFE'` | Shanghai (Night) |\\n| `'SY'` | `'SHFE'` | Shanghai (Day) |\\n| `'ZJ'` | `'CFFEX'` | CFFEX |\\n| `'ZZ'` | `'CZCE'` | Zhengzhou |\\n| `'ZY'` | `'CZCE'` | Zhengzhou (Alt) |\\n\\n**Sources:** [panel/const.py:154-162]()\\n\\n---\\n\\n## CTP API Constants\\n\\nThe CTP (China Trading Platform) API defines hundreds of low-level constants for protocol communication. These are organized into several categories.\\n\\n### Data Type Definitions\\n\\n```mermaid\\ngraph TB\\n    subgraph \\\"Type System\\u003cbr/\\u003etrader/utils/ApiStruct.py\\\"\\n        TypeDict[\\\"T = dict()\\u003cbr/\\u003eType definitions\\\"]\\n        \\n        CharTypes[\\\"Character Types\\u003cbr/\\u003echar[N] arrays\\\"]\\n        IntTypes[\\\"Integer Types\\u003cbr/\\u003eint\\\"]\\n        DoubleTypes[\\\"Double Types\\u003cbr/\\u003edouble, Money, Price\\\"]\\n    end\\n    \\n    subgraph \\\"Key Field Types\\\"\\n        InstrumentID[\\\"T['InstrumentID'] = 'char[31]'\\u003cbr/\\u003eInstrument code\\\"]\\n        OrderRef[\\\"T['OrderRef'] = 'char[13]'\\u003cbr/\\u003eOrder reference\\\"]\\n        InvestorID[\\\"T['InvestorID'] = 'char[13]'\\u003cbr/\\u003eInvestor ID\\\"]\\n        Price[\\\"T['Price'] = 'double'\\u003cbr/\\u003ePrice value\\\"]\\n        Volume[\\\"T['Volume'] = 'int'\\u003cbr/\\u003eVolume\\\"]\\n        Money[\\\"T['Money'] = 'double'\\u003cbr/\\u003eMoney amount\\\"]\\n    end\\n    \\n    TypeDict --\\u003e CharTypes \\u0026 IntTypes \\u0026 DoubleTypes\\n    CharTypes --\\u003e InstrumentID \\u0026 OrderRef \\u0026 InvestorID\\n    DoubleTypes --\\u003e Price \\u0026 Money\\n    IntTypes --\\u003e Volume\\n```\\n\\n**Common Type Definitions:**\\n\\n| Type Key | C Type | Max Length | Purpose |\\n|----------|--------|------------|---------|\\n| `'InstrumentID'` | `char[31]` | 31 | Contract code |\\n| `'InvestorID'` | `char[13]` | 13 | Investor identifier |\\n| `'OrderRef'` | `char[13]` | 13 | Order reference |\\n| `'BrokerID'` | `char[11]` | 11 | Broker identifier |\\n| `'ExchangeID'` | `char[9]` | 9 | Exchange code |\\n| `'Price'` | `double` | - | Price value |\\n| `'Volume'` | `int` | - | Quantity |\\n| `'Money'` | `double` | - | Money amount |\\n\\n**Sources:** [trader/utils/ApiStruct.py:2-363]()\\n\\n### CTP Order Status Constants\\n\\nThese mirror the Django `OrderStatus` enum but use CTP's original naming convention.\\n\\n```python\\n# trader/utils/ApiStruct.py:163-172\\nOST_AllTraded = '0'              # \\nOST_PartTradedQueueing = '1'     # \\nOST_PartTradedNotQueueing = '2'  # \\nOST_NoTradeQueueing = '3'        # \\nOST_NoTradeNotQueueing = '4'     # \\nOST_Canceled = '5'               # \\nOST_Unknown = 'a'                # \\nOST_NotTouched = 'b'             # \\nOST_Touched = 'c'                # \\n```\\n\\n**Sources:** [trader/utils/ApiStruct.py:163-172]()\\n\\n### CTP Direction and Offset Constants\\n\\n```python\\n# Direction\\nD_Buy = '0'   # \\nD_Sell = '1'  # \\n\\n# OffsetFlag\\nOF_Open = '0'              # \\nOF_Close = '1'             # \\nOF_ForceClose = '2'        # \\nOF_CloseToday = '3'        # \\nOF_CloseYesterday = '4'    # \\nOF_ForceOff = '5'          # \\nOF_LocalForceClose = '6'   # \\n```\\n\\n**Sources:** [trader/utils/ApiStruct.py:203-258]()\\n\\n### CTP Price Type Constants\\n\\n```python\\nOPT_AnyPrice = '1'                  # \\nOPT_LimitPrice = '2'                # \\nOPT_BestPrice = '3'                 # \\nOPT_LastPrice = '4'                 # \\nOPT_LastPricePlusOneTicks = '5'     # 1ticks\\nOPT_AskPrice1 = '8'                 # \\nOPT_BidPrice1 = 'C'                 # \\nOPT_FiveLevelPrice = 'G'            # \\n```\\n\\n**Sources:** [trader/utils/ApiStruct.py:234-250]()\\n\\n### CTP Time Condition Constants\\n\\n```python\\nTC_IOC = '1'   #  (Immediate or Cancel)\\nTC_GFS = '2'   #  (Good for Session)\\nTC_GFD = '3'   #  (Good for Day)\\nTC_GTD = '4'   #  (Good till Date)\\nTC_GTC = '5'   #  (Good till Cancel)\\nTC_GFA = '6'   #  (Good for Auction)\\n```\\n\\n**Sources:** [trader/utils/ApiStruct.py:275-281]()\\n\\n### CTP Position Related Constants\\n\\n```python\\n# Position Date\\nPSD_Today = '1'      # \\nPSD_History = '2'    # \\n\\n# Position Direction\\nPD_Net = '1'     # \\nPD_Long = '2'    # \\nPD_Short = '3'   # \\n\\n# Hedge Flag\\nHF_Speculation = '1'  # \\nHF_Arbitrage = '2'    # \\nHF_Hedge = '3'        # \\n```\\n\\n**Sources:** [trader/utils/ApiStruct.py:181-225]()\\n\\n---\\n\\n## CTP Error Code Reference\\n\\nThe system maintains a comprehensive error code mapping dictionary with over 100 error conditions. This is used for error handling and logging throughout the trading system.\\n\\n### Error Code Dictionary Structure\\n\\n```python\\nerror = {\\n    'NONE': 0,\\n    0: 'CTP:',\\n    'INVALID_LOGIN': 3,\\n    3: 'CTP:',\\n    # ... hundreds more\\n}\\n```\\n\\nThe dictionary provides bidirectional lookup:\\n- String key  integer code: `error['NONE']` returns `0`\\n- Integer code  description: `error[0]` returns `'CTP:'`\\n\\n### Common Error Categories\\n\\n#### Authentication Errors (0-14)\\n\\n| Code | Constant | Description |\\n|------|----------|-------------|\\n| 3 | `INVALID_LOGIN` |  (Invalid login) |\\n| 4 | `USER_NOT_ACTIVE` |  (User not active) |\\n| 5 | `DUPLICATE_LOGIN` |  (Duplicate login) |\\n| 6 | `NOT_LOGIN_YET` |  (Not logged in) |\\n| 9 | `NO_PRIVILEGE` |  (No privilege) |\\n| 11 | `USER_NOT_FOUND` |  (User not found) |\\n| 14 | `OLD_PASSWORD_MISMATCH` |  (Old password mismatch) |\\n\\n#### Order Related Errors (15-30)\\n\\n| Code | Constant | Description |\\n|------|----------|-------------|\\n| 15 | `BAD_FIELD` |  (Bad order field) |\\n| 16 | `INSTRUMENT_NOT_FOUND` |  (Instrument not found) |\\n| 17 | `INSTRUMENT_NOT_TRADING` |  (Not trading) |\\n| 22 | `DUPLICATE_ORDER_REF` |  (Duplicate order ref) |\\n| 25 | `ORDER_NOT_FOUND` |  (Order not found) |\\n| 26 | `INSUITABLE_ORDER_STATUS` |  (Unsuitable status) |\\n| 28 | `NO_TRADING_RIGHT` |  (No trading right) |\\n| 29 | `CLOSE_ONLY` |  (Close only) |\\n| 30 | `OVER_CLOSE_POSITION` |  (Over close) |\\n\\n#### Risk Management Errors (31-53)\\n\\n| Code | Constant | Description |\\n|------|----------|-------------|\\n| 31 | `INSUFFICIENT_MONEY` |  (Insufficient money) |\\n| 42 | `SETTLEMENT_INFO_NOT_CONFIRMED` |  (Settlement not confirmed) |\\n| 50 | `OVER_CLOSETODAY_POSITION` |  (Over close today) |\\n| 51 | `OVER_CLOSEYESTERDAY_POSITION` |  (Over close yesterday) |\\n\\n#### Exchange Connection Errors (39-41, 91)\\n\\n| Code | Constant | Description |\\n|------|----------|-------------|\\n| 39 | `CFFEX_NETWORK_ERROR` |  (Network error) |\\n| 40 | `CFFEX_OVER_REQUEST` |  (Over request) |\\n| 41 | `CFFEX_OVER_REQUEST_PER_SECOND` |  (Over request per second) |\\n| 91 | `EXCHANGE_RTNERROR` |  (Exchange error) |\\n\\n#### Bank Transfer Errors (1000-1039)\\n\\nDedicated error range for bank-futures transfer operations ().\\n\\n| Code | Constant | Description |\\n|------|----------|-------------|\\n| 1002 | `ILLEGAL_TRANSFER_BANK` |  |\\n| 1003 | `ALREADY_OPEN_ACCOUNT` |  |\\n| 1004 | `NOT_OPEN_ACCOUNT` |  |\\n| 1019 | `NOT_SIGNIN` |  |\\n| 1022 | `NOT_IN_TRANSFER_TIME` |  |\\n| 1031 | `INSUFFICIENT_MONEY` |  |\\n\\n#### Bank System Errors (2000-2015)\\n\\n| Code | Constant | Description |\\n|------|----------|-------------|\\n| 2000 | `NO_VALID_BANKOFFER_AVAILABLE` |  |\\n| 2001 | `PASSWORD_MISMATCH` |  |\\n| 2004 | `DUPLATION_BANK_SERIAL` |  |\\n\\n### Error Handling Pattern\\n\\n```python\\n# trader/strategy/brother2.py or similar\\nfrom trader.utils.ApiStruct import error\\n\\ndef handle_order_error(error_id: int):\\n    \\\"\\\"\\\"Handle CTP API error codes\\\"\\\"\\\"\\n    error_msg = error.get(error_id, f'Unknown error: {error_id}')\\n    \\n    if error_id == 31:  # INSUFFICIENT_MONEY\\n        logger.error(f\\\"Order rejected: {error_msg}\\\")\\n        # Implement risk management logic\\n    elif error_id in [22, 24]:  # Duplicate order\\n        logger.warning(f\\\"Duplicate order: {error_msg}\\\")\\n        # Skip retry\\n    elif error_id in [39, 40, 41]:  # Exchange issues\\n        logger.error(f\\\"Exchange error: {error_msg}\\\")\\n        # Retry logic\\n    else:\\n        logger.error(f\\\"CTP Error {error_id}: {error_msg}\\\")\\n```\\n\\n**Full Error Mapping:**\\n\\n```mermaid\\ngraph TB\\n    subgraph \\\"Error Categories\\\"\\n        Auth[\\\"Authentication\\u003cbr/\\u003e0-14\\\"]\\n        Order[\\\"Order Operations\\u003cbr/\\u003e15-30\\\"]\\n        Risk[\\\"Risk Management\\u003cbr/\\u003e31-60\\\"]\\n        Exchange[\\\"Exchange Issues\\u003cbr/\\u003e39-41, 78-93\\\"]\\n        BankTransfer[\\\"Bank Transfer\\u003cbr/\\u003e1000-1039\\\"]\\n        BankSystem[\\\"Bank System\\u003cbr/\\u003e2000-2015\\\"]\\n        FBE[\\\"Foreign Exchange\\u003cbr/\\u003e3000-3038\\\"]\\n    end\\n    \\n    ErrorHandler[\\\"Error Handler\\u003cbr/\\u003eStrategy Layer\\\"]\\n    ErrorDict[\\\"error dict\\u003cbr/\\u003etrader/utils/ApiStruct.py:1894-1984\\\"]\\n    \\n    ErrorHandler --\\u003e ErrorDict\\n    ErrorDict --\\u003e Auth \\u0026 Order \\u0026 Risk \\u0026 Exchange \\u0026 BankTransfer \\u0026 BankSystem \\u0026 FBE\\n    \\n    LogSystem[\\\"Logging System\\u003cbr/\\u003etrader/utils/my_logger.py\\\"]\\n    ErrorHandler --\\u003e LogSystem\\n```\\n\\n**Sources:** [trader/utils/ApiStruct.py:1894-1984]()\\n\\n---\\n\\n## Usage Patterns and Integration\\n\\n### Constants in Django Models\\n\\n```python\\n# panel/models.py (conceptual)\\nfrom panel.const import (\\n    ContractType, ExchangeType, DirectionType,\\n    OffsetFlag, OrderStatus, SignalType\\n)\\n\\nclass Instrument(models.Model):\\n    contract_type = models.CharField(\\n        max_length=10,\\n        choices=ContractType.choices,\\n        default=ContractType.FUTURE\\n    )\\n    exchange = models.CharField(\\n        max_length=10,\\n        choices=ExchangeType.choices\\n    )\\n\\nclass Order(models.Model):\\n    direction = models.IntegerField(choices=DirectionType.choices)\\n    offset_flag = models.IntegerField(choices=OffsetFlag.choices)\\n    status = models.IntegerField(choices=OrderStatus.choices)\\n    \\nclass Signal(models.Model):\\n    signal_type = models.CharField(\\n        max_length=20,\\n        choices=SignalType.choices\\n    )\\n```\\n\\n### Constants in CTP API Communication\\n\\n```python\\n# trader/strategy/brother2.py (conceptual)\\nfrom trader.utils.ApiStruct import (\\n    D_Buy, D_Sell, OF_Open, OF_Close,\\n    OPT_LimitPrice, TC_GFD, HF_Speculation\\n)\\n\\ndef build_ctp_order_request(signal):\\n    \\\"\\\"\\\"Convert internal signal to CTP order structure\\\"\\\"\\\"\\n    request = {\\n        'InstrumentID': signal.instrument.code,\\n        'Direction': D_Buy if signal.direction == DirectionType.LONG else D_Sell,\\n        'OffsetFlag': OF_Open if signal.offset_flag == OffsetFlag.Open else OF_Close,\\n        'OrderPriceType': OPT_LimitPrice,\\n        'TimeCondition': TC_GFD,\\n        'HedgeFlag': HF_Speculation,\\n        'LimitPrice': signal.price,\\n        'VolumeTotalOriginal': signal.volume,\\n    }\\n    return request\\n```\\n\\n### Exchange Code Mapping\\n\\n```python\\n# trader/utils/__init__.py\\nfrom panel.const import ExchangeType\\n\\ndef update_daily_data():\\n    \\\"\\\"\\\"Update data from all exchanges\\\"\\\"\\\"\\n    exchanges = [\\n        (ExchangeType.SHFE, update_from_shfe),\\n        (ExchangeType.DCE, update_from_dce),\\n        (ExchangeType.CZCE, update_from_czce),\\n        (ExchangeType.CFFEX, update_from_cffex),\\n        (ExchangeType.GFEX, update_from_gfex),\\n    ]\\n    \\n    for exchange_type, update_func in exchanges:\\n        try:\\n            update_func()\\n            logger.info(f\\\"Updated {exchange_type}\\\")\\n        except Exception as e:\\n            logger.error(f\\\"Failed to update {exchange_type}: {e}\\\")\\n```\\n\\n**Sources:** [panel/models.py:1-500](), [trader/strategy/brother2.py:1-800](), [trader/utils/__init__.py:100-450]()\\n\\n---\\n\\n## Constant Value Transformations\\n\\n### Byte Value Conversion\\n\\nDjango enumerations store CTP character codes as integer byte values for database compatibility:\\n\\n```python\\n# panel/const.py approach\\nDirectionType.LONG = b'0'[0]  # ASCII value 48\\n\\n# Conversion back to CTP format\\ndirection_byte = bytes([DirectionType.LONG])  # b'0'\\ndirection_char = chr(DirectionType.LONG)      # '0'\\n```\\n\\n### String to Enum Lookup\\n\\n```python\\nfrom panel.const import OrderStatus\\n\\n# By value (integer)\\nstatus = OrderStatus.AllTraded  # 48\\n\\n# By label (for display)\\nlabel = OrderStatus.choices[OrderStatus.AllTraded]  # ''\\n\\n# Reverse lookup from CTP string\\nctp_status = '0'  # From CTP API\\ndb_status = ord(ctp_status)  # Convert to byte value: 48\\n```\\n\\n---\\n\\n## Summary Tables\\n\\n### All Django Enumerations\\n\\n| Enumeration Class | File Location | Primary Use |\\n|------------------|---------------|-------------|\\n| `ContractType` | [panel/const.py:19-22]() | Instrument classification |\\n| `ExchangeType` | [panel/const.py:25-31]() | Exchange identification |\\n| `SectionType` | [panel/const.py:34-41]() | Commodity categorization |\\n| `SortType` | [panel/const.py:43-53]() | Detailed product sorting |\\n| `AddressType` | [panel/const.py:55-58]() | Connection type (trade/market) |\\n| `OperatorType` | [panel/const.py:60-63]() | Network operator |\\n| `DirectionType` | [panel/const.py:65-67]() | Long/short direction |\\n| `CombOffsetFlag` | [panel/const.py:70-77]() | Open/close (string) |\\n| `OffsetFlag` | [panel/const.py:80-88]() | Open/close (byte) |\\n| `OrderStatus` | [panel/const.py:90-100]() | Order lifecycle state |\\n| `OrderSubmitStatus` | [panel/const.py:102-110]() | Submission status |\\n| `SignalType` | [panel/const.py:165-172]() | Trading signal types |\\n| `PriorityType` | [panel/const.py:174-177]() | Order priority |\\n\\n### Key Mapping Dictionaries\\n\\n| Dictionary Name | Purpose | Size |\\n|----------------|---------|------|\\n| `DCE_NAME_CODE` | DCE product name  code | 23 entries |\\n| `MONTH_CODE` | Month number  letter | 12 entries |\\n| `KT_MARKET` | KT market code  exchange | 7 entries |\\n| `error` | CTP error code  message | 200+ entries |\\n\\n**Sources:** [panel/const.py:1-178](), [trader/utils/ApiStruct.py:1-1985]()\\n\\n---\\n\\n## Best Practices\\n\\n1. **Always use constants instead of magic values:**\\n   ```python\\n   # Bad\\n   order.direction = 48\\n   \\n   # Good\\n   from panel.const import DirectionType\\n   order.direction = DirectionType.LONG\\n   ```\\n\\n2. **Use Django choices for model fields:**\\n   ```python\\n   status = models.IntegerField(choices=OrderStatus.choices)\\n   ```\\n\\n3. **Handle CTP error codes consistently:**\\n   ```python\\n   from trader.utils.ApiStruct import error\\n   error_msg = error.get(error_id, f'Unknown: {error_id}')\\n   ```\\n\\n4. **Map between systems explicitly:**\\n   ```python\\n   # Signal  CTP conversion\\n   ctp_direction = D_Buy if signal.direction == DirectionType.LONG else D_Sell\\n   ```\\n\\n5. **Document non-obvious mappings:**\\n   ```python\\n   # Month codes skip 'I' (looks like 1) and 'O' (looks like 0)\\n   month_letter = MONTH_CODE[datetime.now().month]\\n   ```\\n\\n**Sources:** [panel/const.py:1-178](), [trader/utils/ApiStruct.py:1-1985](), [trader/strategy/brother2.py:1-800]()\"])</script><script>self.__next_f.push([1,\"35:T41a8,\"])</script><script>self.__next_f.push([1,\"# Development Guide\\n\\n\\u003cdetails\\u003e\\n\\u003csummary\\u003eRelevant source files\\u003c/summary\\u003e\\n\\nThe following files were used as context for generating this wiki page:\\n\\n- [.gitignore](.gitignore)\\n- [test/test_api.py](test/test_api.py)\\n- [trader/strategy/__init__.py](trader/strategy/__init__.py)\\n- [trader/utils/func_container.py](trader/utils/func_container.py)\\n\\n\\u003c/details\\u003e\\n\\n\\n\\nThis guide provides essential information for developers working on or extending the trader system. It covers development environment setup, key architectural patterns, testing approaches, and guidelines for implementing custom trading strategies.\\n\\nFor detailed information on specific development topics, refer to:\\n- Testing strategies and data acquisition validation: [Testing](#8.1)\\n- Decorator-based callback system implementation: [Callback System](#8.2)\\n- Implementing new trading strategies: [Creating Custom Strategies](#8.3)\\n- Logging infrastructure and monitoring: [Logging and Monitoring](#8.4)\\n\\n## Development Environment Setup\\n\\n### Prerequisites\\n\\nThe trader system requires the following dependencies to be installed before development:\\n\\n| Component | Purpose | Configuration Reference |\\n|-----------|---------|------------------------|\\n| Python 3.7+ | Runtime environment | - |\\n| MySQL 5.7+ | Data persistence | [Configuration](#7.1) |\\n| Redis 5.0+ | Message bus and cache | [Configuration](#7.1) |\\n| TA-Lib | Technical analysis | System library |\\n| Django 2.2+ | ORM and web framework | `requirements.txt` |\\n\\n### Development Installation\\n\\n1. Clone the repository and install dependencies:\\n```bash\\npip install -r requirements.txt\\n```\\n\\n2. Configure the development environment by creating `config.ini` (see [Configuration](#2.2))\\n\\n3. Set up the Django environment variables in your test files:\\n\\n[test/test_api.py:16-27]()\\n\\nThe test file demonstrates three platform-specific paths for Django setup. Adjust the path in your development environment accordingly.\\n\\nSources: [test/test_api.py:16-27]()\\n\\n## Codebase Architecture for Developers\\n\\n### Directory Structure\\n\\n```\\ntrader/\\n strategy/           # Trading strategy implementations\\n    __init__.py    # BaseModule framework\\n    brother2.py    # TradeStrategy implementation\\n utils/             # Utility functions and data processing\\n    __init__.py    # Data acquisition and signal generation\\n    func_container.py  # Callback decorator system\\n    fetch_data.py  # Exchange data fetching\\n    read_config.py # Configuration management\\n    my_logger.py   # Logging infrastructure\\n main.py            # Application entry point\\npanel/\\n models.py          # Django data models\\n const.py           # System constants and enumerations\\ntest/\\n test_api.py        # API and data acquisition tests\\n```\\n\\n### Key Components for Extension\\n\\nThe following diagram shows the primary extension points for developers:\\n\\n```mermaid\\ngraph TB\\n    subgraph \\\"Extension Framework\\\"\\n        CallbackFunctionContainer[\\\"CallbackFunctionContainer\\u003cbr/\\u003e(func_container.py)\\\"]\\n        BaseModule[\\\"BaseModule\\u003cbr/\\u003e(strategy/__init__.py)\\\"]\\n        TradeStrategy[\\\"TradeStrategy\\u003cbr/\\u003e(strategy/brother2.py)\\\"]\\n    end\\n    \\n    subgraph \\\"Decorator System\\\"\\n        RegisterCallback[\\\"@RegisterCallback\\u003cbr/\\u003edecorator\\\"]\\n        CallbackArgs[\\\"callback_fun_args\\u003cbr/\\u003edict\\\"]\\n    end\\n    \\n    subgraph \\\"Callback Types\\\"\\n        CronCallback[\\\"crontab='schedule'\\\"]\\n        ChannelCallback[\\\"channel='pattern'\\\"]\\n    end\\n    \\n    subgraph \\\"Infrastructure\\\"\\n        RedisClient[\\\"aioredis.Redis\\u003cbr/\\u003eself.redis_client\\\"]\\n        SubClient[\\\"PubSub\\u003cbr/\\u003eself.sub_client\\\"]\\n        IOLoop[\\\"asyncio.EventLoop\\u003cbr/\\u003eself.io_loop\\\"]\\n    end\\n    \\n    subgraph \\\"Developer Extension\\\"\\n        CustomStrategy[\\\"Your Custom Strategy\\\"]\\n        CustomCallbacks[\\\"Your Callback Methods\\\"]\\n    end\\n    \\n    RegisterCallback --\\u003e CallbackArgs\\n    CallbackArgs --\\u003e CallbackFunctionContainer\\n    CallbackFunctionContainer --\\u003e BaseModule\\n    BaseModule --\\u003e TradeStrategy\\n    \\n    CronCallback -.-\\u003e|\\\"Registered via\\\"| RegisterCallback\\n    ChannelCallback -.-\\u003e|\\\"Registered via\\\"| RegisterCallback\\n    \\n    BaseModule --\\u003e RedisClient\\n    BaseModule --\\u003e SubClient\\n    BaseModule --\\u003e IOLoop\\n    \\n    BaseModule --\\u003e CustomStrategy\\n    CustomStrategy --\\u003e CustomCallbacks\\n    CustomCallbacks --\\u003e RegisterCallback\\n```\\n\\nSources: [trader/utils/func_container.py:21-49](), [trader/strategy/__init__.py:36-140]()\\n\\n## Development Workflow\\n\\n### Typical Development Cycle\\n\\n```mermaid\\nsequenceDiagram\\n    participant Dev as Developer\\n    participant Code as Codebase\\n    participant Test as Test Suite\\n    participant Django as Django Setup\\n    participant Redis as Redis Instance\\n    participant DB as MySQL Database\\n    \\n    Dev-\\u003e\\u003eCode: Implement new feature\\n    Dev-\\u003e\\u003eCode: Add callback decorators\\n    \\n    rect rgb(245, 245, 245)\\n        Note over Dev,Django: Testing Phase\\n        Dev-\\u003e\\u003eDjango: Configure environment\\n        Django-\\u003e\\u003eDjango: os.environ[\\\"DJANGO_SETTINGS_MODULE\\\"]\\n        Django-\\u003e\\u003eDjango: os.environ[\\\"DJANGO_ALLOW_ASYNC_UNSAFE\\\"]\\n        Django-\\u003e\\u003eDjango: django.setup()\\n        \\n        Dev-\\u003e\\u003eTest: Run test suite\\n        Test-\\u003e\\u003eRedis: Connect via config\\n        Test-\\u003e\\u003eDB: Query test data\\n        Test--\\u003e\\u003eDev: Test results\\n    end\\n    \\n    rect rgb(240, 240, 240)\\n        Note over Dev,Redis: Integration Testing\\n        Dev-\\u003e\\u003eRedis: Verify pub/sub channels\\n        Redis--\\u003e\\u003eDev: Channel responses\\n        Dev-\\u003e\\u003eDB: Verify data persistence\\n        DB--\\u003e\\u003eDev: Query results\\n    end\\n    \\n    Dev-\\u003e\\u003eCode: Commit changes\\n```\\n\\nSources: [test/test_api.py:16-27](), [test/test_api.py:34-42]()\\n\\n### Testing Data Acquisition\\n\\nThe test suite provides methods for validating data acquisition from all five exchanges:\\n\\n| Test Method | Purpose | Exchange |\\n|-------------|---------|----------|\\n| `test_get_shfe_data()` | Validate SHFE data fetch | Shanghai Futures Exchange |\\n| `test_get_dce_data()` | Validate DCE data fetch | Dalian Commodity Exchange |\\n| `test_get_czce_data()` | Validate CZCE data fetch | Zhengzhou Commodity Exchange |\\n| `test_get_cffex_data()` | Validate CFFEX data fetch | China Financial Futures Exchange |\\n| `test_get_all()` | Test all exchanges concurrently | All exchanges |\\n\\n[test/test_api.py:44-75]()\\n\\nEach test method uses `@asynctest.skipIf()` to enable/disable execution. To run a specific test, change the decorator argument to `False`.\\n\\nSources: [test/test_api.py:44-75]()\\n\\n## Key Development Patterns\\n\\n### Callback Registration Pattern\\n\\nThe trader system uses a decorator-based callback registration system. The `@RegisterCallback` decorator marks methods for automatic registration:\\n\\n```mermaid\\ngraph LR\\n    subgraph \\\"Method Definition\\\"\\n        Method[\\\"def my_callback(self)\\\"]\\n        Decorator[\\\"@RegisterCallback\\\"]\\n        Args[\\\"crontab='...' or channel='...'\\\"]\\n    end\\n    \\n    subgraph \\\"Registration Process\\\"\\n        CollectAll[\\\"_collect_all()\\\"]\\n        CheckAttr[\\\"hasattr(fun, 'is_callback_function')\\\"]\\n        ExtractArgs[\\\"Extract arg_* attributes\\\"]\\n        StoreDict[\\\"callback_fun_args[name] = params\\\"]\\n    end\\n    \\n    subgraph \\\"Runtime Routing\\\"\\n        CrontabRouter[\\\"crontab_router[schedule]\\\"]\\n        ChannelRouter[\\\"channel_router[pattern]\\\"]\\n        Execute[\\\"Execute callback\\\"]\\n    end\\n    \\n    Decorator --\\u003e Method\\n    Args --\\u003e Decorator\\n    \\n    Method --\\u003e CollectAll\\n    CollectAll --\\u003e CheckAttr\\n    CheckAttr --\\u003e ExtractArgs\\n    ExtractArgs --\\u003e StoreDict\\n    \\n    StoreDict --\\u003e CrontabRouter\\n    StoreDict --\\u003e ChannelRouter\\n    \\n    CrontabRouter --\\u003e Execute\\n    ChannelRouter --\\u003e Execute\\n```\\n\\nThe `RegisterCallback` decorator implementation:\\n\\n[trader/utils/func_container.py:21-32]()\\n\\nThe decorator sets attributes on the wrapped function:\\n- `is_callback_function`: Flag indicating callback registration\\n- `arg_{key}`: Stores each keyword argument passed to the decorator\\n\\nThe `CallbackFunctionContainer` base class collects all decorated methods:\\n\\n[trader/utils/func_container.py:35-49]()\\n\\nSources: [trader/utils/func_container.py:21-49]()\\n\\n### BaseModule Extension Pattern\\n\\n`BaseModule` provides the infrastructure for all strategy modules. The following table shows key attributes and their purposes:\\n\\n| Attribute | Type | Purpose |\\n|-----------|------|---------|\\n| `io_loop` | `asyncio.EventLoop` | Asynchronous event loop for task scheduling |\\n| `redis_client` | `aioredis.Redis` | Async Redis client for pub/sub operations |\\n| `raw_redis` | `redis.StrictRedis` | Synchronous Redis client for blocking operations |\\n| `sub_client` | `aioredis.PubSub` | Redis pub/sub subscriber |\\n| `channel_router` | `dict` | Maps channel patterns to callback functions |\\n| `crontab_router` | `defaultdict` | Maps cron schedules to callback functions and handlers |\\n\\n[trader/strategy/__init__.py:36-57]()\\n\\n### Callback Registration Flow\\n\\n```mermaid\\nstateDiagram-v2\\n    [*] --\\u003e __init__\\n    __init__ --\\u003e _collect_all: Collect decorated methods\\n    _collect_all --\\u003e callback_fun_args: Store in dict\\n    \\n    callback_fun_args --\\u003e install: Start module\\n    install --\\u003e _register_callback: Register callbacks\\n    \\n    _register_callback --\\u003e CheckType: Check callback type\\n    \\n    CheckType --\\u003e CrontabSetup: Has 'crontab' arg\\n    CheckType --\\u003e ChannelSetup: Has 'channel' arg\\n    \\n    state CrontabSetup {\\n        [*] --\\u003e CreateIter: croniter(schedule, datetime)\\n        CreateIter --\\u003e StoreRouter: crontab_router[key]\\n        StoreRouter --\\u003e ScheduleNext: call_at(_get_next())\\n    }\\n    \\n    state ChannelSetup {\\n        [*] --\\u003e MapPattern: channel_router[pattern] = func\\n        MapPattern --\\u003e Subscribe: sub_client.psubscribe()\\n        Subscribe --\\u003e StartReader: _msg_reader() task\\n    }\\n    \\n    CrontabSetup --\\u003e [*]\\n    ChannelSetup --\\u003e [*]\\n```\\n\\nThe `_register_callback()` method processes all collected callbacks:\\n\\n[trader/strategy/__init__.py:58-70]()\\n\\nFor cron-based callbacks, the system:\\n1. Creates a `croniter` instance for schedule calculation\\n2. Stores the function reference and iterator in `crontab_router`\\n3. Schedules the next execution using `io_loop.call_at()`\\n\\nFor channel-based callbacks, the system:\\n1. Maps the channel pattern to the callback function in `channel_router`\\n2. Subscribes to the pattern via `sub_client.psubscribe()`\\n3. Starts the message reader task\\n\\nSources: [trader/strategy/__init__.py:58-93]()\\n\\n### Cron Scheduling Implementation\\n\\nThe cron scheduling system uses `croniter` for time calculations and asyncio's event loop for execution:\\n\\n[trader/strategy/__init__.py:71-78]()\\n\\nKey methods:\\n- `_get_next(key)`: Calculates the next execution time in event loop time\\n- `_call_next(key)`: Schedules the next execution and runs the callback task\\n\\nThe calculation converts from cron time (Unix timestamp) to event loop time:\\n```python\\nloop_time + (cron_next_time - current_time)\\n```\\n\\nSources: [trader/strategy/__init__.py:71-78]()\\n\\n### Message Reading Pattern\\n\\nThe Redis pub/sub message reader processes incoming messages:\\n\\n[trader/strategy/__init__.py:110-122]()\\n\\nThe message format received from Redis:\\n```python\\n{\\n    'type': 'pmessage',\\n    'pattern': 'MSG:CTP:RSP:*',\\n    'channel': 'MSG:CTP:RSP:TRADE:12345',\\n    'data': '{\\\"field\\\": \\\"value\\\"}'\\n}\\n```\\n\\nThe reader:\\n1. Listens asynchronously for messages\\n2. Parses JSON data\\n3. Routes to the appropriate callback based on pattern matching\\n4. Creates a new task for each callback execution (non-blocking)\\n\\nSources: [trader/strategy/__init__.py:110-122]()\\n\\n## Development Tools and Utilities\\n\\n### Test Suite Configuration\\n\\nThe test suite uses `asynctest` for async test cases:\\n\\n[test/test_api.py:34-42]()\\n\\nThe `setUp()` method:\\n1. Connects to Redis using configuration from `config.ini`\\n2. Retrieves the last trading day from Redis key `\\\"LastTradingDay\\\"`\\n3. Converts to `datetime` object for test operations\\n\\nThe `tearDown()` method ensures proper cleanup:\\n\\n[test/test_api.py:41-42]()\\n\\nSources: [test/test_api.py:34-42]()\\n\\n### Running Concurrent Exchange Tests\\n\\nThe `test_get_all()` method demonstrates concurrent data acquisition testing:\\n\\n[test/test_api.py:65-75]()\\n\\nThis test:\\n1. Creates a list of coroutine tasks for all five exchanges\\n2. Uses `asyncio.gather()` to execute concurrently\\n3. Collects results including exceptions (via `return_exceptions=True`)\\n4. Asserts all tasks returned `True`\\n\\nTo run this test, change line 77 to `@asynctest.skipIf(False, 'no need')`.\\n\\nSources: [test/test_api.py:65-75]()\\n\\n### Data Loading and Main Contract Creation\\n\\nDevelopment utilities for data operations:\\n\\n| Method | Purpose | File Reference |\\n|--------|---------|----------------|\\n| `test_load_from_kt()` | Load historical data from external source | [test/test_api.py:78-79]() |\\n| `test_create_main()` | Create main contract series for instrument | [test/test_api.py:82-84]() |\\n| `test_calc_profit()` | Calculate unrealized P\\u0026L for open positions | [test/test_api.py:87-94]() |\\n\\nThe `test_calc_profit()` method shows how to calculate profit for open trades:\\n\\n[test/test_api.py:87-94]()\\n\\nThis demonstrates:\\n- Querying open trades (where `close_time` is NULL)\\n- Getting the latest daily bar for each trade's instrument\\n- Calculating profit based on direction (long vs. short)\\n- Updating the trade record\\n\\nSources: [test/test_api.py:78-94]()\\n\\n## Module Lifecycle\\n\\n### Installation and Start\\n\\n```mermaid\\ngraph TB\\n    Init[\\\"__init__()\\\"]\\n    Start[\\\"start()\\\"]\\n    Install[\\\"install()\\\"]\\n    \\n    subgraph \\\"Registration Phase\\\"\\n        RegCB[\\\"_register_callback()\\\"]\\n        SetupCron[\\\"Setup cron schedules\\\"]\\n        SubChannels[\\\"Subscribe to channels\\\"]\\n        StartReader[\\\"Start _msg_reader()\\\"]\\n    end\\n    \\n    subgraph \\\"Running Phase\\\"\\n        IOLoop[\\\"io_loop.run_forever()\\\"]\\n        CronTasks[\\\"Cron callbacks execute\\\"]\\n        ChannelTasks[\\\"Channel callbacks execute\\\"]\\n    end\\n    \\n    Init --\\u003e Start\\n    Start --\\u003e Install\\n    \\n    Install --\\u003e RegCB\\n    RegCB --\\u003e SetupCron\\n    RegCB --\\u003e SubChannels\\n    SubChannels --\\u003e StartReader\\n    \\n    Install --\\u003e IOLoop\\n    IOLoop --\\u003e CronTasks\\n    IOLoop --\\u003e ChannelTasks\\n    \\n    SetupCron -.-\\u003e|\\\"Scheduled\\\"| CronTasks\\n    StartReader -.-\\u003e|\\\"Listens\\\"| ChannelTasks\\n```\\n\\nThe installation process:\\n\\n[trader/strategy/__init__.py:80-93]()\\n\\nSources: [trader/strategy/__init__.py:80-93]()\\n\\n### Shutdown and Cleanup\\n\\nThe uninstall process ensures graceful shutdown:\\n\\n[trader/strategy/__init__.py:95-108]()\\n\\nCleanup steps:\\n1. Unsubscribe from all Redis pub/sub patterns\\n2. Clear subscription tasks\\n3. Close the Redis pub/sub client\\n4. Cancel all scheduled cron handlers\\n5. Set `initialized` flag to `False`\\n\\nThe main `run()` method handles the complete lifecycle:\\n\\n[trader/strategy/__init__.py:129-140]()\\n\\nThis method:\\n- Catches `KeyboardInterrupt` for graceful shutdown\\n- Catches all exceptions and logs them\\n- Always calls `stop()` to ensure cleanup\\n\\nSources: [trader/strategy/__init__.py:95-140]()\\n\\n## Best Practices\\n\\n### Async Method Implementation\\n\\nAll callback methods should be async coroutines:\\n\\n```python\\n@RegisterCallback(crontab='0 15 * * *')\\nasync def my_scheduled_task(self):\\n    # Your implementation\\n    pass\\n\\n@RegisterCallback(channel='MSG:CUSTOM:*')\\nasync def my_channel_handler(self, channel, data):\\n    # Your implementation\\n    pass\\n```\\n\\n### Error Handling\\n\\nWrap critical operations in try-except blocks with logging:\\n\\n```python\\ntry:\\n    # Your operation\\n    await some_async_operation()\\nexcept Exception as e:\\n    logger.error('Operation failed: %s', repr(e), exc_info=True)\\n```\\n\\nThis pattern appears throughout the codebase, for example in [trader/strategy/__init__.py:92-93]() and [trader/strategy/__init__.py:107-108]().\\n\\n### Redis Connection Management\\n\\nUse both async and sync Redis clients appropriately:\\n\\n- Use `self.redis_client` (aioredis) for pub/sub and async operations\\n- Use `self.raw_redis` (redis.StrictRedis) for blocking operations that need immediate results\\n\\n[trader/strategy/__init__.py:41-47]()\\n\\n### Testing Pattern\\n\\nUse the `@asynctest.skipIf()` decorator to control test execution:\\n\\n```python\\n@asynctest.skipIf(False, 'no need')  # Enable this test\\nasync def test_my_feature(self):\\n    self.assertTrue(await my_async_function())\\n```\\n\\nSources: [test/test_api.py:44-46](), [trader/strategy/__init__.py:41-47]()\\n\\n## Next Steps\\n\\nFor specific development tasks, refer to the following sections:\\n\\n- **Testing your changes**: See [Testing](#8.1) for comprehensive testing strategies\\n- **Understanding callbacks**: See [Callback System](#8.2) for detailed callback implementation\\n- **Building a strategy**: See [Creating Custom Strategies](#8.3) for step-by-step strategy development\\n- **Debugging and monitoring**: See [Logging and Monitoring](#8.4) for logging infrastructure\\n\\nFor API reference documentation:\\n- [BaseModule API](#10.2) - Complete method reference\\n- [Data Utilities API](#10.3) - Utility function reference\\n- [Django Models API](#10.4) - Data model reference\"])</script><script>self.__next_f.push([1,\"36:T37ea,\"])</script><script>self.__next_f.push([1,\"# Testing\\n\\n\\u003cdetails\\u003e\\n\\u003csummary\\u003eRelevant source files\\u003c/summary\\u003e\\n\\nThe following files were used as context for generating this wiki page:\\n\\n- [test/test.py](test/test.py)\\n- [test/test_api.py](test/test_api.py)\\n\\n\\u003c/details\\u003e\\n\\n\\n\\nThis document describes the testing infrastructure for the trader system, including how to run tests, validate data acquisition from exchanges, and test trading logic components. The testing framework uses Python's `asynctest` library for asynchronous test cases and relies on Django's ORM for database interactions.\\n\\nFor information about the data acquisition system being tested, see [Exchange Data Acquisition](#5.2). For details on creating custom strategies that may require testing, see [Creating Custom Strategies](#8.3).\\n\\n## Overview\\n\\nThe trader system includes two primary test mechanisms:\\n\\n1. **Unit Test Suite** ([test/test_api.py]()): Comprehensive test cases for exchange data acquisition and utility functions\\n2. **Manual Test Scripts** ([test/test.py]()): Simple scripts for ad-hoc testing of specific components\\n\\nAll tests require a properly configured Django environment and access to Redis for retrieving trading day information.\\n\\n**Sources:** [test/test_api.py:1-95](), [test/test.py:1-29]()\\n\\n## Test Infrastructure\\n\\n### Django Test Environment Setup\\n\\nThe test framework initializes Django before importing trader modules. This setup varies by platform to handle different development environments:\\n\\n```mermaid\\nflowchart TB\\n    Start[\\\"Test Script Execution\\\"]\\n    Platform{\\\"Platform Detection\\\"}\\n    Darwin[\\\"macOS: sys.platform == 'darwin'\\u003cbr/\\u003ePath: /Users/jeffchen/Documents/gitdir/dashboard\\\"]\\n    Win32[\\\"Windows: sys.platform == 'win32'\\u003cbr/\\u003ePath: D:\\\\\\\\GitHub\\\\\\\\dashboard\\\"]\\n    Linux[\\\"Linux: default\\u003cbr/\\u003ePath: /root/dashboard\\\"]\\n    Setup[\\\"Django Setup\\u003cbr/\\u003eDJANGO_SETTINGS_MODULE = 'dashboard.settings'\\u003cbr/\\u003eDJANGO_ALLOW_ASYNC_UNSAFE = 'true'\\u003cbr/\\u003edjango.setup()\\\"]\\n    Import[\\\"Import Trader Modules\\u003cbr/\\u003efrom trader.utils import *\\\"]\\n    Execute[\\\"Execute Test Cases\\\"]\\n    \\n    Start --\\u003e Platform\\n    Platform --\\u003e|\\\"macOS\\\"| Darwin\\n    Platform --\\u003e|\\\"Windows\\\"| Win32\\n    Platform --\\u003e|\\\"Linux/Other\\\"| Linux\\n    Darwin --\\u003e Setup\\n    Win32 --\\u003e Setup\\n    Linux --\\u003e Setup\\n    Setup --\\u003e Import\\n    Import --\\u003e Execute\\n```\\n\\n**Sources:** [test/test_api.py:16-27](), [test/test.py:1-12]()\\n\\n### Required Environment Variables\\n\\n| Variable | Value | Purpose |\\n|----------|-------|---------|\\n| `DJANGO_SETTINGS_MODULE` | `dashboard.settings` | Django configuration module |\\n| `DJANGO_ALLOW_ASYNC_UNSAFE` | `true` | Enable async operations in Django ORM |\\n\\n**Sources:** [test/test_api.py:25-26](), [test/test.py:10-11]()\\n\\n### Test Class Structure\\n\\nThe `APITest` class extends `asynctest.TestCase` to support asynchronous test methods:\\n\\n```mermaid\\nclassDiagram\\n    class asynctest_TestCase {\\n        \\u003c\\u003cexternal\\u003e\\u003e\\n        +setUp()\\n        +tearDown()\\n    }\\n    \\n    class APITest {\\n        -redis_client: StrictRedis\\n        -trading_day: datetime\\n        +setUp()\\n        +tearDown()\\n        +test_get_shfe_data()\\n        +test_get_dce_data()\\n        +test_get_czce_data()\\n        +test_get_cffex_data()\\n        +test_get_contracts_argument()\\n        +test_get_all()\\n        +test_load_from_kt()\\n        +test_create_main()\\n        +test_calc_profit()\\n    }\\n    \\n    class StrictRedis {\\n        \\u003c\\u003cexternal\\u003e\\u003e\\n        +get()\\n        +close()\\n    }\\n    \\n    asynctest_TestCase \\u003c|-- APITest\\n    APITest --\\u003e StrictRedis : uses\\n```\\n\\n**Sources:** [test/test_api.py:34-95]()\\n\\n## Running Tests\\n\\n### Prerequisites\\n\\n1. **Redis Server**: Must be running and accessible\\n2. **MySQL Database**: Django models must be migrated\\n3. **Trading Day Data**: Redis must contain `LastTradingDay` key\\n4. **Configuration**: `config.ini` must be properly configured (see [Configuration](#2.2))\\n\\n### Executing the Test Suite\\n\\nRun all tests using Python's unittest discovery:\\n\\n```bash\\npython -m unittest test.test_api.APITest\\n```\\n\\nRun a specific test method:\\n\\n```bash\\npython -m unittest test.test_api.APITest.test_get_all\\n```\\n\\n### Test Skipping\\n\\nMost tests are skipped by default using the `@asynctest.skipIf` decorator. To enable a test, modify the decorator:\\n\\n```python\\n@asynctest.skipIf(False, 'no need')  # Test will run\\n@asynctest.skipIf(True, 'no need')   # Test is skipped\\n```\\n\\n**Sources:** [test/test_api.py:44-95]()\\n\\n## Exchange Data Acquisition Tests\\n\\nThe test suite validates data fetching from all five Chinese commodity exchanges:\\n\\n### Individual Exchange Tests\\n\\n| Test Method | Exchange | Function Tested | Data Format |\\n|-------------|----------|-----------------|-------------|\\n| `test_get_shfe_data` | Shanghai Futures Exchange | `update_from_shfe()` | JSON |\\n| `test_get_dce_data` | Dalian Commodity Exchange | `update_from_dce()` | TXT |\\n| `test_get_czce_data` | Zhengzhou Commodity Exchange | `update_from_czce()` | TXT |\\n| `test_get_cffex_data` | China Financial Futures Exchange | `update_from_cffex()` | XML |\\n\\n**Sources:** [test/test_api.py:44-58]()\\n\\n### Test Execution Flow\\n\\n```mermaid\\nsequenceDiagram\\n    participant T as \\\"APITest\\\"\\n    participant R as \\\"redis_client\\\"\\n    participant U as \\\"update_from_*\\\"\\n    participant E as \\\"Exchange API\\\"\\n    participant D as \\\"Django ORM\\\"\\n    \\n    Note over T: setUp()\\n    T-\\u003e\\u003eR: get(\\\"LastTradingDay\\\")\\n    R--\\u003e\\u003eT: trading_day string\\n    T-\\u003e\\u003eT: Parse to datetime object\\n    \\n    Note over T: test_get_shfe_data()\\n    T-\\u003e\\u003eU: update_from_shfe(trading_day)\\n    U-\\u003e\\u003eE: HTTP GET request\\n    E--\\u003e\\u003eU: JSON response\\n    U-\\u003e\\u003eD: Save DailyBar records\\n    D--\\u003e\\u003eU: Success\\n    U--\\u003e\\u003eT: Return True\\n    T-\\u003e\\u003eT: assertTrue(result)\\n    \\n    Note over T: tearDown()\\n    T-\\u003e\\u003eR: close()\\n```\\n\\n**Sources:** [test/test_api.py:35-58]()\\n\\n### Concurrent Exchange Tests\\n\\nThe `test_get_all` method validates concurrent data fetching from all exchanges using `asyncio.gather`:\\n\\n```mermaid\\nflowchart LR\\n    Start[\\\"test_get_all()\\\"]\\n    Tasks[\\\"Create Task List:\\u003cbr/\\u003e- update_from_shfe\\u003cbr/\\u003e- update_from_dce\\u003cbr/\\u003e- update_from_czce\\u003cbr/\\u003e- update_from_cffex\\u003cbr/\\u003e- get_contracts_argument\\\"]\\n    Gather[\\\"asyncio.gather(*tasks,\\u003cbr/\\u003ereturn_exceptions=True)\\\"]\\n    Validate[\\\"assertEqual(result,\\u003cbr/\\u003e[True, True, True, True, True])\\\"]\\n    \\n    Start --\\u003e Tasks\\n    Tasks --\\u003e Gather\\n    Gather --\\u003e Validate\\n    \\n    subgraph \\\"Parallel Execution\\\"\\n        SHFE[\\\"SHFE API\\\"]\\n        DCE[\\\"DCE API\\\"]\\n        CZCE[\\\"CZCE API\\\"]\\n        CFFEX[\\\"CFFEX API\\\"]\\n        Contract[\\\"Contract Args\\\"]\\n    end\\n    \\n    Gather -.-\\u003e SHFE\\n    Gather -.-\\u003e DCE\\n    Gather -.-\\u003e CZCE\\n    Gather -.-\\u003e CFFEX\\n    Gather -.-\\u003e Contract\\n```\\n\\n**Sources:** [test/test_api.py:64-75]()\\n\\n## Utility Function Tests\\n\\n### Contract Argument Fetching\\n\\nTests the `get_contracts_argument` function which retrieves contract specifications:\\n\\n```python\\nasync def test_get_contracts_argument(self):\\n    self.assertTrue(await get_contracts_argument(self.trading_day))\\n```\\n\\nThis test validates that contract metadata (volume multipliers, tick sizes, margin ratios) is successfully retrieved and stored.\\n\\n**Sources:** [test/test_api.py:60-62]()\\n\\n### Main Contract Creation\\n\\nTests the main contract calculation algorithm (see [Main Contract Calculation](#5.3) for details):\\n\\n```python\\nasync def test_create_main(self):\\n    inst = Instrument.objects.get(product_code='eb')\\n    self.assertTrue(create_main(inst))\\n```\\n\\nThis validates that:\\n1. The main contract is correctly identified based on volume and open interest\\n2. `MainBar` records are created with proper rollover adjustments\\n3. Historical continuity is maintained\\n\\n**Sources:** [test/test_api.py:81-84]()\\n\\n### Profit Calculation Validation\\n\\nTests the profit calculation logic for open trades:\\n\\n```mermaid\\nflowchart TD\\n    Start[\\\"test_calc_profit()\\\"]\\n    Query[\\\"Query: Trade.objects.filter\\u003cbr/\\u003e(close_time__isnull=True)\\\"]\\n    Loop{\\\"For each\\u003cbr/\\u003eopen trade\\\"}\\n    GetBar[\\\"Get latest DailyBar\\u003cbr/\\u003efor trade.code\\\"]\\n    CalcProfit[\\\"profit = (bar.close - avg_entry_price)\\u003cbr/\\u003e* filled_shares * volume_multiple\\\"]\\n    CheckDir{\\\"direction ==\\u003cbr/\\u003eSHORT?\\\"}\\n    Negate[\\\"profit *= -1\\\"]\\n    Save[\\\"trade.save(update_fields=['profit'])\\\"]\\n    Done[\\\"End\\\"]\\n    \\n    Start --\\u003e Query\\n    Query --\\u003e Loop\\n    Loop --\\u003e|\\\"Yes\\\"| GetBar\\n    GetBar --\\u003e CalcProfit\\n    CalcProfit --\\u003e CheckDir\\n    CheckDir --\\u003e|\\\"Yes\\\"| Negate\\n    CheckDir --\\u003e|\\\"No\\\"| Save\\n    Negate --\\u003e Save\\n    Save --\\u003e Loop\\n    Loop --\\u003e|\\\"No more\\\"| Done\\n```\\n\\n**Sources:** [test/test_api.py:86-94]()\\n\\n## Manual Testing Scripts\\n\\n### Simple Exchange Test\\n\\nThe [test/test.py]() script provides a minimal example for testing individual exchange updates:\\n\\n| Component | Implementation |\\n|-----------|----------------|\\n| Event Loop | `asyncio.new_event_loop()` |\\n| Trading Day | `datetime.now() - timedelta(days=1)` with `pytz.FixedOffset(480)` (China timezone) |\\n| Target Function | `update_from_czce(day)` |\\n| Execution | `loop.run_until_complete()` |\\n\\nThis script is useful for:\\n- Quick validation of exchange API connectivity\\n- Testing date handling and timezone conversion\\n- Debugging data parsing issues\\n\\n**Sources:** [test/test.py:19-28]()\\n\\n### Running Manual Tests\\n\\n```bash\\npython test/test.py\\n```\\n\\nExpected output:\\n```\\nDONE!\\n```\\n\\n## Test Data Management\\n\\n### Redis Test Data\\n\\nThe test suite depends on Redis containing the `LastTradingDay` key, which is typically set by the production system during market hours. For testing purposes, manually set this key:\\n\\n```bash\\nredis-cli\\n\\u003e SET LastTradingDay \\\"20240115\\\"\\n```\\n\\n**Sources:** [test/test_api.py:39]()\\n\\n### Database Fixtures\\n\\nWhile the codebase doesn't include explicit test fixtures, tests rely on:\\n\\n1. **Instrument Records**: Must exist in database for contract-specific tests\\n2. **Strategy Records**: Required for signal and order tests\\n3. **Broker Records**: Needed for account and position tests\\n\\nConsider creating fixtures for repeatable test scenarios:\\n\\n```python\\n# Example fixture creation (not in current codebase)\\nfrom django.core.management import call_command\\ncall_command('loaddata', 'test_instruments.json')\\n```\\n\\n## KT Data Loading Test\\n\\nThe system includes a test for loading historical data from KT (Kingsoft) format files:\\n\\n```python\\nasync def test_load_from_kt(self):\\n    self.assertTrue(load_kt_data(r'D:\\\\test'))\\n```\\n\\nThis test validates:\\n- File parsing from KT export format\\n- Conversion to `DailyBar` model format\\n- Bulk insertion performance\\n\\n**Sources:** [test/test_api.py:77-79]()\\n\\n## Test Coverage Map\\n\\n```mermaid\\ngraph TB\\n    subgraph \\\"Data Acquisition Tests\\\"\\n        T1[\\\"test_get_shfe_data\\\"]\\n        T2[\\\"test_get_dce_data\\\"]\\n        T3[\\\"test_get_czce_data\\\"]\\n        T4[\\\"test_get_cffex_data\\\"]\\n        T5[\\\"test_get_all\\\"]\\n        T6[\\\"test_get_contracts_argument\\\"]\\n    end\\n    \\n    subgraph \\\"Data Processing Tests\\\"\\n        T7[\\\"test_create_main\\\"]\\n        T8[\\\"test_load_from_kt\\\"]\\n    end\\n    \\n    subgraph \\\"Trading Logic Tests\\\"\\n        T9[\\\"test_calc_profit\\\"]\\n    end\\n    \\n    subgraph \\\"trader.utils Functions\\\"\\n        F1[\\\"update_from_shfe\\\"]\\n        F2[\\\"update_from_dce\\\"]\\n        F3[\\\"update_from_czce\\\"]\\n        F4[\\\"update_from_cffex\\\"]\\n        F5[\\\"get_contracts_argument\\\"]\\n        F6[\\\"create_main\\\"]\\n        F7[\\\"load_kt_data\\\"]\\n    end\\n    \\n    subgraph \\\"Models\\\"\\n        M1[\\\"DailyBar\\\"]\\n        M2[\\\"MainBar\\\"]\\n        M3[\\\"Trade\\\"]\\n        M4[\\\"Instrument\\\"]\\n    end\\n    \\n    T1 --\\u003e F1\\n    T2 --\\u003e F2\\n    T3 --\\u003e F3\\n    T4 --\\u003e F4\\n    T5 --\\u003e F1 \\u0026 F2 \\u0026 F3 \\u0026 F4 \\u0026 F5\\n    T6 --\\u003e F5\\n    T7 --\\u003e F6\\n    T8 --\\u003e F7\\n    \\n    F1 \\u0026 F2 \\u0026 F3 \\u0026 F4 --\\u003e M1\\n    F6 --\\u003e M2\\n    T9 --\\u003e M3\\n    T7 --\\u003e M4\\n```\\n\\n**Sources:** [test/test_api.py:44-94]()\\n\\n## Debugging Tests\\n\\n### Enabling Verbose Output\\n\\nAdd print statements to track execution:\\n\\n```python\\nasync def test_get_all(self):\\n    print(f'tradingday: {self.trading_day}')  # Shows trading day being tested\\n    tasks = [...]\\n    result = await asyncio.gather(*tasks, return_exceptions=True)\\n    print(f'results: {result}')  # Shows individual task results\\n```\\n\\n**Sources:** [test/test_api.py:66]()\\n\\n### Common Test Failures\\n\\n| Issue | Cause | Solution |\\n|-------|-------|----------|\\n| `KeyError: 'LastTradingDay'` | Redis key not set | Set `LastTradingDay` in Redis manually |\\n| Import errors | Incorrect path in `sys.path.append()` | Update path to match your installation |\\n| Connection timeouts | Exchange API unavailable | Test during market hours or check network |\\n| `asyncio.gather` exceptions | Individual exchange failures | Run tests separately to isolate issue |\\n| Database errors | Django not configured | Verify `DJANGO_SETTINGS_MODULE` environment variable |\\n\\n### Logging Configuration\\n\\nEnable detailed logging for debugging (see [Logging and Monitoring](#8.4)):\\n\\n```python\\nimport logging\\nlogging.basicConfig(level=logging.DEBUG)\\n```\\n\\n## Test Best Practices\\n\\n### Test Isolation\\n\\nEach test should be independent and not rely on state from other tests. The `setUp` and `tearDown` methods ensure proper initialization and cleanup:\\n\\n```python\\ndef setUp(self):\\n    self.redis_client = redis.StrictRedis(...)\\n    self.trading_day = datetime.strptime(...)\\n\\ndef tearDown(self) -\\u003e None:\\n    self.redis_client.close()\\n```\\n\\n**Sources:** [test/test_api.py:35-42]()\\n\\n### Async Testing Pattern\\n\\nAll data acquisition functions are asynchronous. Use `async def` for test methods and `await` for async calls:\\n\\n```python\\n@asynctest.skipIf(False, 'no need')\\nasync def test_get_shfe_data(self):\\n    self.assertTrue(await update_from_shfe(self.trading_day))\\n```\\n\\n**Sources:** [test/test_api.py:44-46]()\\n\\n### Platform-Specific Paths\\n\\nHandle different development environments gracefully:\\n\\n```python\\nif sys.platform == 'darwin':\\n    sys.path.append('/Users/jeffchen/Documents/gitdir/dashboard')\\nelif sys.platform == 'win32':\\n    sys.path.append(r'D:\\\\GitHub\\\\dashboard')\\nelse:\\n    sys.path.append('/root/dashboard')\\n```\\n\\n**Sources:** [test/test_api.py:19-24]()\\n\\n## Future Testing Enhancements\\n\\nThe current test suite focuses on data acquisition. Consider adding:\\n\\n1. **Strategy Logic Tests**: Validate signal generation algorithms (see [Signal Generation](#4.3))\\n2. **Order Execution Tests**: Mock CTP API responses for order flow testing\\n3. **Risk Management Tests**: Verify position sizing and stop-loss logic (see [Risk Management](#4.5))\\n4. **Performance Tests**: Load testing for high-frequency market data\\n5. **Integration Tests**: End-to-end testing of complete trading cycles\\n6. **Continuous Integration**: Automated test execution on commits\\n\\n**Sources:** Based on system architecture analysis\"])</script><script>self.__next_f.push([1,\"37:T67b4,\"])</script><script>self.__next_f.push([1,\"# Callback System\\n\\n\\u003cdetails\\u003e\\n\\u003csummary\\u003eRelevant source files\\u003c/summary\\u003e\\n\\nThe following files were used as context for generating this wiki page:\\n\\n- [.gitignore](.gitignore)\\n- [trader/strategy/__init__.py](trader/strategy/__init__.py)\\n- [trader/strategy/brother2.py](trader/strategy/brother2.py)\\n- [trader/utils/func_container.py](trader/utils/func_container.py)\\n\\n\\u003c/details\\u003e\\n\\n\\n\\n## Purpose and Scope\\n\\nThis document describes the callback system used in the trader codebase, which provides an event-driven programming framework for responding to Redis Pub/Sub messages and executing scheduled tasks. The callback system is the core infrastructure that enables the trading strategy to react to market data updates, order confirmations, and execute scheduled operations like signal processing and account refreshes.\\n\\nFor information about the overall trading strategy architecture, see [TradeStrategy Class](#4.1). For details on Redis message patterns and CTP API integration, see [Message Bus and Communication](#3.3).\\n\\n## System Architecture\\n\\nThe callback system consists of three main components working together to provide a declarative event-driven programming model:\\n\\n```mermaid\\ngraph TB\\n    subgraph \\\"Decorator Layer\\\"\\n        RegisterCallback[\\\"@RegisterCallback\\u003cbr/\\u003eDecorator Function\\\"]\\n    end\\n    \\n    subgraph \\\"Container Layer\\\"\\n        CallbackFunctionContainer[\\\"CallbackFunctionContainer\\u003cbr/\\u003eAbstract Base Class\\\"]\\n        callback_fun_args[\\\"callback_fun_args: dict\\u003cbr/\\u003eStores function metadata\\\"]\\n    end\\n    \\n    subgraph \\\"Routing Layer\\\"\\n        BaseModule[\\\"BaseModule\\u003cbr/\\u003eImplements callback routing\\\"]\\n        channel_router[\\\"channel_router: dict\\u003cbr/\\u003epattern -\\u003e callback function\\\"]\\n        crontab_router[\\\"crontab_router: dict\\u003cbr/\\u003ecron expression -\\u003e callback info\\\"]\\n    end\\n    \\n    subgraph \\\"Implementation Layer\\\"\\n        TradeStrategy[\\\"TradeStrategy\\u003cbr/\\u003eExtends BaseModule\\\"]\\n        OnRtnTrade[\\\"OnRtnTrade()\\u003cbr/\\u003eChannel callback\\\"]\\n        OnRtnOrder[\\\"OnRtnOrder()\\u003cbr/\\u003eChannel callback\\\"]\\n        processing_signal1[\\\"processing_signal1()\\u003cbr/\\u003eCron callback\\\"]\\n        refresh_all[\\\"refresh_all()\\u003cbr/\\u003eCron callback\\\"]\\n    end\\n    \\n    subgraph \\\"Event Sources\\\"\\n        Redis[\\\"Redis Pub/Sub\\u003cbr/\\u003eMSG:CTP:RSP:TRADE:*\\u003cbr/\\u003eMSG:CTP:RSP:MARKET:*\\\"]\\n        Croniter[\\\"croniter\\u003cbr/\\u003eCron scheduling engine\\\"]\\n    end\\n    \\n    RegisterCallback --\\u003e|\\\"Marks function with metadata\\\"| CallbackFunctionContainer\\n    CallbackFunctionContainer --\\u003e|\\\"Collects decorated methods\\\"| callback_fun_args\\n    BaseModule --\\u003e|\\\"Extends\\\"| CallbackFunctionContainer\\n    BaseModule --\\u003e|\\\"Creates routers from\\\"| callback_fun_args\\n    BaseModule --\\u003e|\\\"Manages\\\"| channel_router\\n    BaseModule --\\u003e|\\\"Manages\\\"| crontab_router\\n    TradeStrategy --\\u003e|\\\"Extends\\\"| BaseModule\\n    TradeStrategy --\\u003e|\\\"Implements\\\"| OnRtnTrade\\n    TradeStrategy --\\u003e|\\\"Implements\\\"| OnRtnOrder\\n    TradeStrategy --\\u003e|\\\"Implements\\\"| processing_signal1\\n    TradeStrategy --\\u003e|\\\"Implements\\\"| refresh_all\\n    \\n    Redis --\\u003e|\\\"Triggers\\\"| channel_router\\n    Croniter --\\u003e|\\\"Triggers\\\"| crontab_router\\n    channel_router --\\u003e|\\\"Routes to\\\"| OnRtnTrade\\n    channel_router --\\u003e|\\\"Routes to\\\"| OnRtnOrder\\n    crontab_router --\\u003e|\\\"Schedules\\\"| processing_signal1\\n    crontab_router --\\u003e|\\\"Schedules\\\"| refresh_all\\n```\\n\\n**Sources:** [trader/utils/func_container.py:1-49](), [trader/strategy/__init__.py:1-140](), [trader/strategy/brother2.py:38-655]()\\n\\n## The RegisterCallback Decorator\\n\\nThe `@RegisterCallback` decorator is the entry point for defining callback functions. It marks methods with metadata indicating their trigger conditions.\\n\\n### Decorator Implementation\\n\\n```mermaid\\ngraph LR\\n    subgraph \\\"Decorator Usage\\\"\\n        UserMethod[\\\"def OnRtnTrade(self, channel, trade)\\\"]\\n        Decorated[\\\"@RegisterCallback(channel='MSG:CTP:RSP:TRADE:OnRtnTrade:*')\\\"]\\n    end\\n    \\n    subgraph \\\"Decorator Function\\\"\\n        RegisterCallback[\\\"RegisterCallback(**out_kwargs)\\\"]\\n        _callback_handler[\\\"_callback_handler(func)\\\"]\\n        wrapper[\\\"wrapper(*args, **kwargs)\\\"]\\n    end\\n    \\n    subgraph \\\"Applied Attributes\\\"\\n        arg_channel[\\\"wrapper.arg_channel = 'MSG:CTP:RSP:TRADE:OnRtnTrade:*'\\\"]\\n        is_callback[\\\"wrapper.is_callback_function = True\\\"]\\n    end\\n    \\n    Decorated --\\u003e RegisterCallback\\n    RegisterCallback --\\u003e _callback_handler\\n    _callback_handler --\\u003e wrapper\\n    wrapper --\\u003e arg_channel\\n    wrapper --\\u003e is_callback\\n    wrapper --\\u003e UserMethod\\n```\\n\\nThe decorator accepts keyword arguments that define callback triggers:\\n\\n| Argument | Type | Purpose | Example |\\n|----------|------|---------|---------|\\n| `channel` | str | Redis Pub/Sub pattern to subscribe to | `'MSG:CTP:RSP:TRADE:OnRtnTrade:*'` |\\n| `crontab` | str | Cron expression for scheduled execution | `'55 8 * * *'` (8:55 AM daily) |\\n\\n**Implementation Details:**\\n\\nThe decorator attaches metadata to the wrapped function by setting attributes [trader/utils/func_container.py:21-32]():\\n- Sets `arg_{key}` attributes for each keyword argument passed to the decorator\\n- Sets `is_callback_function = True` to mark the function as a callback\\n- Returns the original function wrapped to maintain its behavior\\n\\n**Sources:** [trader/utils/func_container.py:21-32]()\\n\\n## CallbackFunctionContainer Class\\n\\nThe `CallbackFunctionContainer` abstract base class collects all decorated callback methods during initialization and stores their metadata.\\n\\n```mermaid\\ngraph TB\\n    subgraph \\\"Initialization Process\\\"\\n        __init__[\\\"__init__()\\\"]\\n        _collect_all[\\\"_collect_all()\\\"]\\n    end\\n    \\n    subgraph \\\"Method Discovery\\\"\\n        dir[\\\"dir(self)\\u003cbr/\\u003eList all attributes\\\"]\\n        getattr[\\\"getattr(self, fun_name)\\u003cbr/\\u003eGet method object\\\"]\\n        hasattr[\\\"hasattr(fun, 'is_callback_function')\\u003cbr/\\u003eCheck if decorated\\\"]\\n    end\\n    \\n    subgraph \\\"Metadata Extraction\\\"\\n        extract_params[\\\"Extract arg_* attributes\\\"]\\n        params[\\\"params = {'channel': '...', 'crontab': '...'\\\"}\\n    end\\n    \\n    subgraph \\\"Storage\\\"\\n        callback_fun_args[\\\"callback_fun_args[fun_name] = params\\u003cbr/\\u003eStore metadata by function name\\\"]\\n    end\\n    \\n    __init__ --\\u003e _collect_all\\n    _collect_all --\\u003e dir\\n    dir --\\u003e getattr\\n    getattr --\\u003e hasattr\\n    hasattr --\\u003e|\\\"True\\\"| extract_params\\n    extract_params --\\u003e params\\n    params --\\u003e callback_fun_args\\n```\\n\\n### Collection Process\\n\\nThe `_collect_all()` method [trader/utils/func_container.py:40-48]() performs the following steps:\\n\\n1. **Enumerate Methods**: Uses `dir(self)` to get all attribute names\\n2. **Check Decoration**: For each attribute, checks if it has `is_callback_function` attribute\\n3. **Extract Parameters**: Collects all `arg_*` attributes into a dictionary\\n4. **Store Metadata**: Saves parameter dictionary in `self.callback_fun_args` keyed by function name\\n\\n**Example Storage Structure:**\\n\\n```python\\ncallback_fun_args = {\\n    'OnRtnTrade': {'channel': 'MSG:CTP:RSP:TRADE:OnRtnTrade:*'},\\n    'OnRtnOrder': {'channel': 'MSG:CTP:RSP:TRADE:OnRtnOrder:*'},\\n    'heartbeat': {'crontab': '*/1 * * * *'},\\n    'processing_signal1': {'crontab': '55 8 * * *'}\\n}\\n```\\n\\n**Sources:** [trader/utils/func_container.py:35-49]()\\n\\n## BaseModule Implementation\\n\\nThe `BaseModule` class extends `CallbackFunctionContainer` and implements the actual callback routing and execution infrastructure using Redis Pub/Sub for channel-based callbacks and `croniter` for scheduled callbacks.\\n\\n### Core Components\\n\\n```mermaid\\ngraph TB\\n    subgraph \\\"BaseModule Attributes\\\"\\n        io_loop[\\\"io_loop: asyncio.EventLoop\\u003cbr/\\u003eMain event loop\\\"]\\n        redis_client[\\\"redis_client: aioredis.Redis\\u003cbr/\\u003eAsync Redis client\\\"]\\n        sub_client[\\\"sub_client: aioredis.PubSub\\u003cbr/\\u003eSubscription client\\\"]\\n        channel_router[\\\"channel_router: dict\\u003cbr/\\u003epattern -\\u003e callback function\\\"]\\n        crontab_router[\\\"crontab_router: dict\\u003cbr/\\u003ecron -\\u003e {func, iter, handle}\\\"]\\n    end\\n    \\n    subgraph \\\"Registration Phase\\\"\\n        _register_callback[\\\"_register_callback()\\u003cbr/\\u003eBuild routers from metadata\\\"]\\n    end\\n    \\n    subgraph \\\"Channel Routing\\\"\\n        psubscribe[\\\"sub_client.psubscribe(*patterns)\\\"]\\n        _msg_reader[\\\"_msg_reader()\\u003cbr/\\u003eListen for messages\\\"]\\n        dispatch[\\\"Dispatch to callback function\\\"]\\n    end\\n    \\n    subgraph \\\"Cron Scheduling\\\"\\n        croniter_obj[\\\"croniter(expression, start_time)\\\"]\\n        call_at[\\\"io_loop.call_at(next_time, callback)\\\"]\\n        _call_next[\\\"_call_next(key)\\u003cbr/\\u003eExecute and reschedule\\\"]\\n    end\\n    \\n    _register_callback --\\u003e channel_router\\n    _register_callback --\\u003e crontab_router\\n    channel_router --\\u003e psubscribe\\n    psubscribe --\\u003e _msg_reader\\n    _msg_reader --\\u003e dispatch\\n    \\n    crontab_router --\\u003e croniter_obj\\n    croniter_obj --\\u003e call_at\\n    call_at --\\u003e _call_next\\n```\\n\\n### Router Registration\\n\\nThe `_register_callback()` method [trader/strategy/__init__.py:58-69]() builds two routing dictionaries:\\n\\n**Channel Router:**\\n- Key: Redis Pub/Sub pattern (e.g., `'MSG:CTP:RSP:TRADE:OnRtnTrade:*'`)\\n- Value: Callback function reference\\n\\n**Crontab Router:**\\n- Key: Cron expression (e.g., `'55 8 * * *'`)\\n- Value: Dictionary containing:\\n  - `'func'`: Callback function reference\\n  - `'iter'`: `croniter` iterator for calculating next execution time\\n  - `'handle'`: `asyncio.TimerHandle` for scheduled execution\\n\\n**Sources:** [trader/strategy/__init__.py:58-69]()\\n\\n### Installation Process\\n\\n```mermaid\\nsequenceDiagram\\n    participant Module as BaseModule/TradeStrategy\\n    participant Registry as _register_callback()\\n    participant SubClient as sub_client (aioredis.PubSub)\\n    participant EventLoop as io_loop\\n    participant Reader as _msg_reader()\\n    participant Scheduler as Cron Scheduler\\n    \\n    Module-\\u003e\\u003eRegistry: Call _register_callback()\\n    Registry-\\u003e\\u003eRegistry: Build channel_router\\n    Registry-\\u003e\\u003eRegistry: Build crontab_router\\n    \\n    Module-\\u003e\\u003eSubClient: psubscribe(*channel_patterns)\\n    SubClient--\\u003e\\u003eModule: Subscribed to patterns\\n    \\n    Module-\\u003e\\u003eEventLoop: asyncio.run_coroutine_threadsafe(_msg_reader())\\n    EventLoop-\\u003e\\u003eReader: Start listening\\n    \\n    loop For each cron expression\\n        Module-\\u003e\\u003eScheduler: io_loop.call_at(next_time, _call_next, key)\\n        Scheduler--\\u003e\\u003eModule: TimerHandle stored\\n    end\\n    \\n    Module-\\u003e\\u003eModule: Set initialized = True\\n```\\n\\nThe `install()` method [trader/strategy/__init__.py:80-93]() performs the following initialization:\\n\\n1. **Register Callbacks**: Calls `_register_callback()` to build routing tables\\n2. **Subscribe to Channels**: Uses `psubscribe()` to subscribe to all channel patterns\\n3. **Start Message Reader**: Launches `_msg_reader()` as a coroutine to listen for Redis messages\\n4. **Schedule Cron Callbacks**: For each cron expression, calculates next execution time and schedules callback\\n5. **Set Initialized Flag**: Marks the module as ready\\n\\n**Sources:** [trader/strategy/__init__.py:80-93]()\\n\\n## Channel-Based Callbacks\\n\\nChannel-based callbacks respond to Redis Pub/Sub messages, enabling event-driven responses to CTP API notifications and market data updates.\\n\\n### Message Flow\\n\\n```mermaid\\nsequenceDiagram\\n    participant CTP as CTP Gateway Process\\n    participant Redis as Redis Pub/Sub\\n    participant Reader as _msg_reader()\\n    participant Router as channel_router\\n    participant Callback as Callback Function\\n    participant EventLoop as io_loop\\n    \\n    CTP-\\u003e\\u003eRedis: PUBLISH 'MSG:CTP:RSP:TRADE:OnRtnTrade:12345' {...}\\n    Redis-\\u003e\\u003eReader: pmessage event\\n    Reader-\\u003e\\u003eReader: Parse JSON data\\n    Reader-\\u003e\\u003eRouter: Lookup callback for pattern\\n    Router--\\u003e\\u003eReader: Return callback function\\n    Reader-\\u003e\\u003eEventLoop: create_task(callback(channel, data))\\n    EventLoop-\\u003e\\u003eCallback: Execute asynchronously\\n```\\n\\n### Message Reader Implementation\\n\\nThe `_msg_reader()` method [trader/strategy/__init__.py:110-121]() implements an async message loop:\\n\\n1. **Listen Loop**: Uses `async for msg in self.sub_client.listen()` to receive messages\\n2. **Filter Message Type**: Only processes `'pmessage'` (pattern-matched messages)\\n3. **Extract Information**:\\n   - `msg['channel']`: Actual channel name (e.g., `'MSG:CTP:RSP:TRADE:OnRtnTrade:12345'`)\\n   - `msg['pattern']`: Matched pattern (e.g., `'MSG:CTP:RSP:TRADE:OnRtnTrade:*'`)\\n   - `msg['data']`: JSON-encoded message payload\\n4. **Parse JSON**: Deserializes message data using `ujson.loads()`\\n5. **Route and Execute**: Looks up callback function using pattern, creates async task with channel and data\\n6. **Handle Unsubscribe**: Breaks loop when `'punsubscribe'` message received\\n\\n**Sources:** [trader/strategy/__init__.py:110-121]()\\n\\n### Channel Callback Examples\\n\\nThe `TradeStrategy` class uses channel callbacks extensively for CTP API responses:\\n\\n| Callback Method | Channel Pattern | Purpose |\\n|-----------------|----------------|---------|\\n| `OnRtnTrade` | `MSG:CTP:RSP:TRADE:OnRtnTrade:*` | Handle trade execution notifications |\\n| `OnRtnOrder` | `MSG:CTP:RSP:TRADE:OnRtnOrder:*` | Handle order status updates |\\n| `OnRtnDepthMarketData` | `MSG:CTP:RSP:MARKET:OnRtnDepthMarketData:*` | Process real-time market data ticks |\\n\\n**Example: OnRtnTrade Callback**\\n\\n[trader/strategy/brother2.py:391-469]()\\n\\n```python\\n@RegisterCallback(channel='MSG:CTP:RSP:TRADE:OnRtnTrade:*')\\nasync def OnRtnTrade(self, channel, trade: dict):\\n    # Extract OrderRef from channel name\\n    order_ref: str = channel.split(':')[-1]\\n    \\n    # Process trade execution\\n    if trade['OffsetFlag'] == OffsetFlag.Open:  # Opening position\\n        last_trade = Trade.objects.create(...)\\n    else:  # Closing position\\n        last_trade = Trade.objects.filter(...).first()\\n        last_trade.close_time = trade_time\\n        last_trade.profit = profit_point * last_trade.shares\\n    \\n    # Mark signal as processed if trade completed\\n    if trade_completed and not manual_trade:\\n        signal.processed = True\\n        signal.save()\\n```\\n\\n**Channel Pattern Matching:**\\n\\nThe wildcard `*` in channel patterns enables routing by dynamic identifiers:\\n- Pattern: `MSG:CTP:RSP:TRADE:OnRtnTrade:*`\\n- Matches: `MSG:CTP:RSP:TRADE:OnRtnTrade:1234567890012`\\n- Extracts: OrderRef `1234567890012` from channel name\\n\\n**Sources:** [trader/strategy/brother2.py:391-469]()\\n\\n## Cron-Based Callbacks\\n\\nCron-based callbacks execute at scheduled times using cron expressions, enabling periodic tasks like signal processing, account refreshes, and data collection.\\n\\n### Scheduling Architecture\\n\\n```mermaid\\ngraph TB\\n    subgraph \\\"Cron Expression\\\"\\n        cron_expr[\\\"'55 8 * * *'\\u003cbr/\\u003eExecute at 8:55 AM daily\\\"]\\n    end\\n    \\n    subgraph \\\"Croniter Integration\\\"\\n        croniter_init[\\\"croniter(expression, start_time)\\u003cbr/\\u003eInitialize iterator\\\"]\\n        get_next[\\\"iter.get_next()\\u003cbr/\\u003eCalculate next timestamp\\\"]\\n    end\\n    \\n    subgraph \\\"Event Loop Scheduling\\\"\\n        loop_time[\\\"io_loop.time()\\u003cbr/\\u003eCurrent loop time\\\"]\\n        delta[\\\"next_time - current_time\\u003cbr/\\u003eSeconds until execution\\\"]\\n        call_at[\\\"io_loop.call_at(abs_time, callback)\\u003cbr/\\u003eSchedule callback\\\"]\\n        handle[\\\"TimerHandle\\u003cbr/\\u003eCancellable scheduled task\\\"]\\n    end\\n    \\n    subgraph \\\"Callback Execution\\\"\\n        _call_next[\\\"_call_next(key)\\u003cbr/\\u003eExecute callback\\\"]\\n        create_task[\\\"io_loop.create_task(func())\\u003cbr/\\u003eRun as async task\\\"]\\n        reschedule[\\\"Reschedule next execution\\\"]\\n    end\\n    \\n    cron_expr --\\u003e croniter_init\\n    croniter_init --\\u003e get_next\\n    get_next --\\u003e delta\\n    loop_time --\\u003e delta\\n    delta --\\u003e call_at\\n    call_at --\\u003e handle\\n    handle --\\u003e _call_next\\n    _call_next --\\u003e create_task\\n    _call_next --\\u003e reschedule\\n    reschedule --\\u003e get_next\\n```\\n\\n### Time Calculation\\n\\nThe `_get_next()` method [trader/strategy/__init__.py:71-72]() calculates the absolute event loop time for the next execution:\\n\\n```python\\ndef _get_next(self, key):\\n    return self.loop_time + (self.crontab_router[key]['iter'].get_next() - self.time)\\n```\\n\\n- `self.loop_time`: Event loop time at initialization (from `io_loop.time()`)\\n- `self.time`: Wall clock time at initialization (from `time.time()`)\\n- `get_next()`: Returns next execution timestamp as Unix time\\n- Result: Absolute event loop time for scheduling\\n\\n**Sources:** [trader/strategy/__init__.py:71-72]()\\n\\n### Callback Execution and Rescheduling\\n\\nThe `_call_next()` method [trader/strategy/__init__.py:74-78]() handles execution and automatic rescheduling:\\n\\n1. **Cancel Previous Handle**: If a handle exists, cancel it to prevent duplicates\\n2. **Schedule Next Execution**: Calculate next time and schedule new callback\\n3. **Execute Current Callback**: Create async task to run the callback function\\n\\nThis creates a self-perpetuating schedule where each execution automatically schedules the next one.\\n\\n**Sources:** [trader/strategy/__init__.py:74-78]()\\n\\n### Cron Callback Examples\\n\\nThe `TradeStrategy` class uses cron callbacks for scheduled operations throughout the trading day:\\n\\n| Time | Callback | Purpose | Cron Expression |\\n|------|----------|---------|-----------------|\\n| 8:55 AM | `processing_signal1` | Process day session signals (non-CFFEX, no night trading) | `'55 8 * * *'` |\\n| 9:01 AM | `check_signal1_processed` | Verify day session signals processed | `'1 9 * * *'` |\\n| 9:25 AM | `processing_signal2` | Process CFFEX (stock index) signals | `'25 9 * * *'` |\\n| 9:31 AM | `check_signal2_processed` | Verify CFFEX signals processed | `'31 9 * * *'` |\\n| 3:20 PM | `refresh_all` | Refresh account, positions, instruments | `'20 15 * * *'` |\\n| 3:30 PM | `update_equity` | Calculate daily performance metrics | `'30 15 * * *'` |\\n| 5:00 PM | `collect_quote` | Fetch exchange data, calculate signals | `'0 17 * * *'` |\\n| 8:55 PM | `processing_signal3` | Process night session signals | `'55 20 * * *'` |\\n| 9:01 PM | `check_signal3_processed` | Verify night session signals processed | `'1 21 * * *'` |\\n| Every minute | `heartbeat` | Update heartbeat key in Redis | `'*/1 * * * *'` |\\n\\n**Example: Signal Processing Callback**\\n\\n[trader/strategy/brother2.py:572-585]()\\n\\n```python\\n@RegisterCallback(crontab='55 8 * * *')\\nasync def processing_signal1(self):\\n    await asyncio.sleep(5)\\n    day = timezone.localtime()\\n    _, trading = await is_trading_day(day)\\n    if trading:\\n        logger.debug('..')\\n        for sig in Signal.objects.filter(\\n            ~Q(instrument__exchange=ExchangeType.CFFEX), \\n            trigger_time__gte=self.__last_trading_day, \\n            strategy=self.__strategy,\\n            instrument__night_trade=False, \\n            processed=False\\n        ).order_by('-priority'):\\n            logger.info(f': {sig}')\\n            self.io_loop.call_soon(self.ReqOrderInsert, sig)\\n```\\n\\n**Key Features:**\\n- Checks if current day is a trading day before proceeding\\n- Queries unprocessed signals from database\\n- Orders signals by priority (high to low)\\n- Schedules order insertion using `io_loop.call_soon()`\\n\\n**Sources:** [trader/strategy/brother2.py:572-585]()\\n\\n## Complete Callback Lifecycle\\n\\n```mermaid\\nsequenceDiagram\\n    participant Dev as Developer\\n    participant Decorator as @RegisterCallback\\n    participant Container as CallbackFunctionContainer\\n    participant BaseModule as BaseModule\\n    participant EventLoop as asyncio EventLoop\\n    participant Trigger as Event Source\\u003cbr/\\u003e(Redis/Cron)\\n    participant Callback as Callback Function\\n    \\n    Note over Dev,Callback: Phase 1: Definition\\n    Dev-\\u003e\\u003eDecorator: @RegisterCallback(channel='...')\\n    Decorator-\\u003e\\u003eCallback: Mark with metadata\\n    \\n    Note over Dev,Callback: Phase 2: Collection\\n    Container-\\u003e\\u003eContainer: __init__() calls _collect_all()\\n    Container-\\u003e\\u003eContainer: Scan all methods for is_callback_function\\n    Container-\\u003e\\u003eContainer: Store in callback_fun_args\\n    \\n    Note over Dev,Callback: Phase 3: Registration\\n    BaseModule-\\u003e\\u003eBaseModule: install() calls _register_callback()\\n    BaseModule-\\u003e\\u003eBaseModule: Build channel_router from metadata\\n    BaseModule-\\u003e\\u003eBaseModule: Build crontab_router from metadata\\n    BaseModule-\\u003e\\u003eEventLoop: Subscribe to channels\\n    BaseModule-\\u003e\\u003eEventLoop: Schedule cron callbacks\\n    \\n    Note over Dev,Callback: Phase 4: Execution\\n    Trigger-\\u003e\\u003eEventLoop: Event occurs (message/time)\\n    EventLoop-\\u003e\\u003eBaseModule: Dispatch to router\\n    BaseModule-\\u003e\\u003eEventLoop: create_task(callback(...))\\n    EventLoop-\\u003e\\u003eCallback: Execute async function\\n    Callback-\\u003e\\u003eCallback: Perform business logic\\n```\\n\\n### Lifecycle Phases\\n\\n**1. Definition Phase**\\n- Developer decorates methods with `@RegisterCallback()`\\n- Decorator attaches metadata attributes to function objects\\n- Sources: [trader/utils/func_container.py:21-32]()\\n\\n**2. Collection Phase**\\n- `CallbackFunctionContainer.__init__()` invokes `_collect_all()`\\n- Scans all class methods for `is_callback_function` attribute\\n- Extracts metadata and stores in `callback_fun_args` dictionary\\n- Sources: [trader/utils/func_container.py:36-48]()\\n\\n**3. Registration Phase**\\n- `BaseModule.install()` invokes `_register_callback()`\\n- Builds `channel_router` mapping patterns to callback functions\\n- Builds `crontab_router` with `croniter` instances and timer handles\\n- Subscribes to Redis channels and schedules cron callbacks\\n- Sources: [trader/strategy/__init__.py:58-93]()\\n\\n**4. Execution Phase**\\n- For channel callbacks: Redis message triggers `_msg_reader()`, routes to callback\\n- For cron callbacks: `io_loop.call_at()` triggers `_call_next()`, executes callback\\n- Callbacks run as async tasks in event loop\\n- Sources: [trader/strategy/__init__.py:74-78](), [trader/strategy/__init__.py:110-121]()\\n\\n## Practical Usage Patterns\\n\\n### Pattern 1: Market Data Response Handler\\n\\n```mermaid\\ngraph LR\\n    subgraph \\\"CTP Gateway\\\"\\n        OnRtnDepthMarketData_CTP[\\\"OnRtnDepthMarketData\\u003cbr/\\u003eCTP callback\\\"]\\n    end\\n    \\n    subgraph \\\"Redis Channel\\\"\\n        Publish[\\\"PUBLISH MSG:CTP:RSP:MARKET:OnRtnDepthMarketData:RB2401\\\"]\\n    end\\n    \\n    subgraph \\\"TradeStrategy\\\"\\n        Callback[\\\"@RegisterCallback(channel=\\u003cbr/\\u003e'MSG:CTP:RSP:MARKET:OnRtnDepthMarketData:*')\\u003cbr/\\u003eOnRtnDepthMarketData(channel, tick)\\\"]\\n    end\\n    \\n    subgraph \\\"Processing\\\"\\n        ParseTick[\\\"Parse tick data\\u003cbr/\\u003eUpdate internal state\\\"]\\n    end\\n    \\n    OnRtnDepthMarketData_CTP --\\u003e Publish\\n    Publish --\\u003e Callback\\n    Callback --\\u003e ParseTick\\n```\\n\\n**Implementation:** [trader/strategy/brother2.py:373-380]()\\n\\n**Sources:** [trader/strategy/brother2.py:373-380]()\\n\\n### Pattern 2: Order Execution Pipeline\\n\\n```mermaid\\ngraph LR\\n    subgraph \\\"Signal Generation\\\"\\n        calc_signal[\\\"calc_signal(inst, day)\\u003cbr/\\u003eGenerate Signal object\\\"]\\n    end\\n    \\n    subgraph \\\"Scheduled Processing\\\"\\n        processing_signal[\\\"@RegisterCallback(crontab='55 8 * * *')\\u003cbr/\\u003eprocessing_signal1()\\\"]\\n    end\\n    \\n    subgraph \\\"Order Insertion\\\"\\n        ReqOrderInsert[\\\"ReqOrderInsert(signal)\\u003cbr/\\u003ePublish order request\\\"]\\n    end\\n    \\n    subgraph \\\"Order Confirmation\\\"\\n        OnRtnOrder[\\\"@RegisterCallback(channel=\\u003cbr/\\u003e'MSG:CTP:RSP:TRADE:OnRtnOrder:*')\\u003cbr/\\u003eOnRtnOrder(channel, order)\\\"]\\n    end\\n    \\n    subgraph \\\"Trade Confirmation\\\"\\n        OnRtnTrade[\\\"@RegisterCallback(channel=\\u003cbr/\\u003e'MSG:CTP:RSP:TRADE:OnRtnTrade:*')\\u003cbr/\\u003eOnRtnTrade(channel, trade)\\\"]\\n    end\\n    \\n    calc_signal --\\u003e processing_signal\\n    processing_signal --\\u003e ReqOrderInsert\\n    ReqOrderInsert --\\u003e OnRtnOrder\\n    OnRtnOrder --\\u003e OnRtnTrade\\n```\\n\\n**Sources:** [trader/strategy/brother2.py:572-585](), [trader/strategy/brother2.py:301-343](), [trader/strategy/brother2.py:510-566](), [trader/strategy/brother2.py:391-469]()\\n\\n### Pattern 3: Daily Maintenance Schedule\\n\\n```mermaid\\ngantt\\n    title Trading Day Callback Schedule\\n    dateFormat HH:mm\\n    axisFormat %H:%M\\n    \\n    section Pre-Market\\n    processing_signal1 (Day session)    :08:55, 1m\\n    check_signal1_processed             :09:01, 1m\\n    processing_signal2 (CFFEX)          :09:25, 1m\\n    check_signal2_processed             :09:31, 1m\\n    \\n    section Market Close\\n    refresh_all (Account/Positions)     :15:20, 1m\\n    update_equity (Performance)         :15:30, 1m\\n    \\n    section Post-Market\\n    collect_quote (Data fetch)          :17:00, 1m\\n    \\n    section Night Session\\n    processing_signal3 (Night)          :20:55, 1m\\n    check_signal3_processed             :21:01, 1m\\n```\\n\\n**Sources:** [trader/strategy/brother2.py:568-655](), [trader/strategy/brother2.py:684-703]()\\n\\n## Error Handling and Robustness\\n\\n### Exception Safety\\n\\nAll callback functions in `BaseModule` include exception handling [trader/strategy/__init__.py:92-93](), [trader/strategy/__init__.py:107-108]():\\n\\n```python\\ntry:\\n    # Callback initialization/execution\\n    pass\\nexcept Exception as e:\\n    logger.error('%s plugin install failed: %s', type(self).__name__, repr(e), exc_info=True)\\n```\\n\\n### Graceful Shutdown\\n\\nThe `uninstall()` method [trader/strategy/__init__.py:95-108]() ensures clean teardown:\\n\\n1. **Unsubscribe from Channels**: `await self.sub_client.punsubscribe()`\\n2. **Clear Tasks**: `self.sub_tasks.clear()`\\n3. **Close Client**: `await self.sub_client.close()`\\n4. **Cancel Timers**: Cancel all `TimerHandle` objects in `crontab_router`\\n5. **Reset Flag**: Set `self.initialized = False`\\n\\n**Sources:** [trader/strategy/__init__.py:95-108]()\\n\\n## Key Design Principles\\n\\n### 1. Declarative Configuration\\n\\nCallbacks are configured using decorator syntax rather than explicit registration calls:\\n\\n```python\\n@RegisterCallback(channel='MSG:CTP:RSP:TRADE:OnRtnTrade:*')\\nasync def OnRtnTrade(self, channel, trade: dict):\\n    # Implementation\\n```\\n\\nThis makes callback registration visible at the point of definition.\\n\\n### 2. Separation of Concerns\\n\\n- **Decorator Layer**: Marks functions with metadata\\n- **Container Layer**: Collects and stores metadata\\n- **Routing Layer**: Maps events to callbacks\\n- **Implementation Layer**: Defines business logic\\n\\n### 3. Asynchronous Execution\\n\\nAll callbacks execute as async tasks in the event loop, enabling non-blocking I/O operations and concurrent processing of multiple events.\\n\\n### 4. Pattern-Based Routing\\n\\nChannel patterns with wildcards enable flexible message routing:\\n- Pattern: `MSG:CTP:RSP:TRADE:OnRtnTrade:*`\\n- Matches any OrderRef suffix\\n- Callback receives full channel name for extraction of dynamic identifiers\\n\\n### 5. Self-Perpetuating Schedules\\n\\nCron callbacks automatically reschedule themselves, ensuring continuous operation without manual intervention.\\n\\n## Summary\\n\\nThe callback system provides a robust, declarative framework for event-driven programming in the trader system. It abstracts away the complexities of Redis Pub/Sub message handling and cron scheduling, allowing developers to focus on implementing business logic in response to market events and scheduled triggers. The three-layer architecture (decorator, container, router) provides clean separation of concerns while maintaining flexibility and extensibility.\\n\\n**Complete Architecture Sources:** [trader/utils/func_container.py:1-49](), [trader/strategy/__init__.py:1-140](), [trader/strategy/brother2.py:38-1169]()\"])</script><script>self.__next_f.push([1,\"38:T8c92,\"])</script><script>self.__next_f.push([1,\"# Creating Custom Strategies\\n\\n\\u003cdetails\\u003e\\n\\u003csummary\\u003eRelevant source files\\u003c/summary\\u003e\\n\\nThe following files were used as context for generating this wiki page:\\n\\n- [panel/models.py](panel/models.py)\\n- [trader/strategy/__init__.py](trader/strategy/__init__.py)\\n- [trader/strategy/brother2.py](trader/strategy/brother2.py)\\n\\n\\u003c/details\\u003e\\n\\n\\n\\nThis document provides a comprehensive guide for developers to create custom trading strategies by extending the system's strategy framework. It covers the architecture, callback system, signal generation, order execution, and data access patterns.\\n\\nFor information about the existing TradeStrategy implementation and its internal workings, see [TradeStrategy Class](#4.1). For details on the callback decorator pattern, see [Callback System](#8.2). For signal generation algorithms used in the default strategy, see [Signal Generation](#4.3).\\n\\n---\\n\\n## Purpose and Scope\\n\\nThis guide explains how to implement a new trading strategy by:\\n- Extending the `BaseModule` abstract class\\n- Implementing signal calculation logic\\n- Integrating with the Redis message bus for CTP API communication\\n- Scheduling tasks with cron expressions\\n- Handling market data and order callbacks\\n- Managing positions and risk\\n\\nThe framework provides infrastructure for Redis Pub/Sub communication, cron-based scheduling, and callback management, allowing strategy developers to focus on trading logic.\\n\\n---\\n\\n## Strategy Architecture Overview\\n\\nCustom strategies in this system extend `BaseModule` and integrate with several core components:\\n\\n```mermaid\\ngraph TB\\n    subgraph \\\"Your Custom Strategy\\\"\\n        CustomStrat[\\\"YourStrategy Class\\u003cbr/\\u003e(extends BaseModule)\\\"]\\n        SignalLogic[\\\"Signal Calculation\\u003cbr/\\u003ecalc_signal()\\\"]\\n        OrderLogic[\\\"Order Execution\\u003cbr/\\u003eReqOrderInsert()\\\"]\\n        Callbacks[\\\"Event Handlers\\u003cbr/\\u003e@RegisterCallback\\\"]\\n    end\\n    \\n    subgraph \\\"BaseModule Framework\\\"\\n        BaseModule[\\\"BaseModule\\u003cbr/\\u003etrader/strategy/__init__.py\\\"]\\n        CallbackContainer[\\\"CallbackFunctionContainer\\u003cbr/\\u003e@RegisterCallback decorator\\\"]\\n        EventLoop[\\\"asyncio Event Loop\\\"]\\n        CronScheduler[\\\"Cron Scheduler\\u003cbr/\\u003ecroniter\\\"]\\n    end\\n    \\n    subgraph \\\"External Integration\\\"\\n        Redis[\\\"Redis Pub/Sub\\u003cbr/\\u003eaioredis + redis.StrictRedis\\\"]\\n        Django[\\\"Django ORM\\u003cbr/\\u003eModels\\\"]\\n        CTP[\\\"CTP API Gateway\\\"]\\n    end\\n    \\n    CustomStrat --\\u003e SignalLogic\\n    CustomStrat --\\u003e OrderLogic\\n    CustomStrat --\\u003e Callbacks\\n    \\n    CustomStrat -.-\\u003e|\\\"extends\\\"| BaseModule\\n    BaseModule --\\u003e CallbackContainer\\n    BaseModule --\\u003e EventLoop\\n    BaseModule --\\u003e CronScheduler\\n    \\n    CustomStrat \\u003c--\\u003e|\\\"query/persist\\\"| Django\\n    CustomStrat \\u003c--\\u003e|\\\"pub/sub\\\"| Redis\\n    Redis \\u003c--\\u003e|\\\"commands\\\"| CTP\\n    \\n    Callbacks -.-\\u003e|\\\"crontab='*/5 * * * *'\\\"| CronScheduler\\n    Callbacks -.-\\u003e|\\\"channel='MSG:CTP:*'\\\"| Redis\\n```\\n\\n**Sources:** [trader/strategy/__init__.py:36-140](), [trader/strategy/brother2.py:38-871]()\\n\\n---\\n\\n## BaseModule Class Reference\\n\\nThe `BaseModule` abstract class provides the following infrastructure:\\n\\n| Component | Attribute | Description |\\n|-----------|-----------|-------------|\\n| **Event Loop** | `self.io_loop` | asyncio event loop for async operations |\\n| **Redis Clients** | `self.redis_client` | aioredis async client for pub/sub |\\n| | `self.raw_redis` | redis.StrictRedis synchronous client |\\n| | `self.sub_client` | PubSub object for subscriptions |\\n| **Scheduling** | `self.crontab_router` | Dictionary of cron job handlers |\\n| | `self.channel_router` | Dictionary of channel pattern handlers |\\n| **State** | `self.initialized` | Boolean indicating installation status |\\n\\n**Key Methods:**\\n\\n| Method | Purpose |\\n|--------|---------|\\n| `async install()` | Register callbacks, subscribe to channels, start cron jobs |\\n| `async uninstall()` | Cleanup subscriptions and cancel scheduled tasks |\\n| `async start()` | Entry point called when strategy starts |\\n| `run()` | Main execution loop (blocking) |\\n\\n**Sources:** [trader/strategy/__init__.py:36-140]()\\n\\n---\\n\\n## Creating a Strategy Class Template\\n\\n### Basic Structure\\n\\n```python\\n# trader/strategy/my_strategy.py\\nimport asyncio\\nimport logging\\nfrom django.utils import timezone\\nfrom trader.strategy import BaseModule\\nfrom trader.utils.func_container import RegisterCallback\\nfrom panel.models import Strategy, Instrument, Signal, Trade\\n\\nlogger = logging.getLogger('MyStrategy')\\n\\n\\nclass MyStrategy(BaseModule):\\n    def __init__(self, strategy_name: str):\\n        super().__init__()\\n        # Load strategy configuration from database\\n        self.__strategy = Strategy.objects.get(name=strategy_name)\\n        self.__broker = self.__strategy.broker\\n        \\n        # Initialize strategy-specific state\\n        self.__positions = dict()\\n        self.__params = self._load_parameters()\\n    \\n    def _load_parameters(self):\\n        \\\"\\\"\\\"Load strategy parameters from database\\\"\\\"\\\"\\n        params = {}\\n        for param in self.__strategy.param_set.all():\\n            params[param.code] = {\\n                'str': param.str_value,\\n                'int': param.int_value,\\n                'float': param.float_value\\n            }\\n        return params\\n    \\n    async def start(self):\\n        \\\"\\\"\\\"Called on strategy startup\\\"\\\"\\\"\\n        await self.install()\\n        logger.info(f\\\"{self.__strategy.name} started\\\")\\n        # Initialize positions, refresh account, etc.\\n```\\n\\n**Sources:** [trader/strategy/brother2.py:38-63](), [trader/strategy/__init__.py:123-125]()\\n\\n---\\n\\n## Implementing Signal Calculation\\n\\n### Signal Generation Logic\\n\\nThe core of a strategy is its signal calculation logic, which analyzes market data and generates trading signals:\\n\\n```mermaid\\nflowchart LR\\n    subgraph \\\"Data Sources\\\"\\n        MainBar[\\\"MainBar Model\\u003cbr/\\u003eContinuous series\\\"]\\n        DailyBar[\\\"DailyBar Model\\u003cbr/\\u003eIndividual contracts\\\"]\\n        CurrentPos[\\\"Trade Model\\u003cbr/\\u003eCurrent positions\\\"]\\n    end\\n    \\n    subgraph \\\"calc_signal() Method\\\"\\n        LoadData[\\\"Load historical bars\\u003cbr/\\u003eMainBar.objects.filter()\\\"]\\n        CalcIndicators[\\\"Calculate indicators\\u003cbr/\\u003eATR, SMA, breakout levels\\\"]\\n        CheckPosition[\\\"Check existing position\\u003cbr/\\u003eTrade.objects.filter()\\\"]\\n        GenerateSignal[\\\"Generate signal logic\\u003cbr/\\u003ebuy_sig / sell_sig / stop_loss\\\"]\\n    end\\n    \\n    subgraph \\\"Output\\\"\\n        SignalModel[\\\"Signal Model\\u003cbr/\\u003eSignal.objects.create()\\\"]\\n        OrderExecution[\\\"Order insertion\\u003cbr/\\u003eReqOrderInsert()\\\"]\\n    end\\n    \\n    MainBar --\\u003e LoadData\\n    DailyBar --\\u003e LoadData\\n    CurrentPos --\\u003e CheckPosition\\n    \\n    LoadData --\\u003e CalcIndicators\\n    CalcIndicators --\\u003e CheckPosition\\n    CheckPosition --\\u003e GenerateSignal\\n    GenerateSignal --\\u003e SignalModel\\n    SignalModel --\\u003e OrderExecution\\n```\\n\\n**Example Implementation:**\\n\\nSee [trader/strategy/brother2.py:725-856]() for the complete `calc_signal()` method. Key steps:\\n\\n1. **Load Parameters** - Extract strategy parameters from database\\n2. **Load Historical Data** - Query `MainBar` records for technical analysis\\n3. **Calculate Indicators** - Use TA-Lib or custom calculations\\n4. **Check Positions** - Query `Trade` model for open positions\\n5. **Generate Signals** - Apply trading logic to determine entry/exit\\n6. **Create Signal Records** - Persist signals to database\\n\\n**Example Pattern:**\\n\\n```python\\ndef calc_signal(self, inst: Instrument, day: datetime.datetime):\\n    # 1. Load parameters\\n    break_n = self.__strategy.param_set.get(code='BreakPeriod').int_value\\n    atr_n = self.__strategy.param_set.get(code='AtrPeriod').int_value\\n    \\n    # 2. Load data and calculate indicators\\n    from panel.models import to_df\\n    df = to_df(MainBar.objects.filter(\\n        time__lte=day.date(),\\n        exchange=inst.exchange,\\n        product_code=inst.product_code\\n    ).order_by('-time').values_list('time', 'open', 'high', 'low', 'close')[:400])\\n    \\n    df = df.iloc[::-1]  # Reverse to ascending order\\n    df[\\\"atr\\\"] = ATR(df.high, df.low, df.close, timeperiod=atr_n)\\n    df[\\\"high_line\\\"] = df.close.rolling(window=break_n).max()\\n    \\n    # 3. Check for entry signals\\n    idx = -1\\n    buy_signal = df.close[idx] \\u003e= df.high_line[idx - 1]\\n    \\n    # 4. Check existing positions\\n    pos = Trade.objects.filter(\\n        close_time__isnull=True,\\n        broker=self.__broker,\\n        strategy=self.__strategy,\\n        instrument=inst\\n    ).first()\\n    \\n    # 5. Generate signal\\n    if buy_signal and not pos:\\n        Signal.objects.update_or_create(\\n            code=inst.main_code,\\n            strategy=self.__strategy,\\n            instrument=inst,\\n            type=SignalType.BUY,\\n            trigger_time=day,\\n            defaults={'price': price, 'volume': volume}\\n        )\\n```\\n\\n**Sources:** [trader/strategy/brother2.py:725-856](), [panel/models.py:194-214]()\\n\\n---\\n\\n## Using the Callback System\\n\\nThe `@RegisterCallback` decorator enables event-driven programming through two mechanisms:\\n\\n### 1. Cron-Based Scheduling\\n\\nSchedule periodic tasks using cron expressions:\\n\\n```python\\nfrom trader.utils.func_container import RegisterCallback\\n\\nclass MyStrategy(BaseModule):\\n    @RegisterCallback(crontab='0 17 * * *')  # Daily at 5:00 PM\\n    async def calculate_signals(self):\\n        \\\"\\\"\\\"Calculate signals after market close\\\"\\\"\\\"\\n        day = timezone.localtime()\\n        for inst in self.__strategy.instruments.all():\\n            self.calc_signal(inst, day)\\n    \\n    @RegisterCallback(crontab='55 8 * * *')  # Daily at 8:55 AM\\n    async def process_day_signals(self):\\n        \\\"\\\"\\\"Execute day session signals before market open\\\"\\\"\\\"\\n        for sig in Signal.objects.filter(\\n            strategy=self.__strategy,\\n            processed=False\\n        ):\\n            self.io_loop.call_soon(self.ReqOrderInsert, sig)\\n    \\n    @RegisterCallback(crontab='*/1 * * * *')  # Every minute\\n    async def heartbeat(self):\\n        \\\"\\\"\\\"Update heartbeat in Redis\\\"\\\"\\\"\\n        self.raw_redis.set('HEARTBEAT:MY_STRATEGY', 1, ex=301)\\n```\\n\\n**Cron Expression Format:**\\n```\\n* * * * *\\n    \\n     Day of week (0-7, Sunday=0 or 7)\\n    Month (1-12)\\n   Day of month (1-31)\\n  Hour (0-23)\\n Minute (0-59)\\n```\\n\\n**Sources:** [trader/strategy/brother2.py:568-703](), [trader/strategy/__init__.py:64-79]()\\n\\n### 2. Redis Channel Callbacks\\n\\nSubscribe to Redis Pub/Sub channels for real-time events:\\n\\n```python\\n@RegisterCallback(channel='MSG:CTP:RSP:TRADE:OnRtnTrade:*')\\nasync def OnRtnTrade(self, channel: str, trade: dict):\\n    \\\"\\\"\\\"Handle trade confirmations from CTP\\\"\\\"\\\"\\n    order_ref = channel.split(':')[-1]\\n    logger.info(f\\\"Trade confirmed: {trade['InstrumentID']} @ {trade['Price']}\\\")\\n    \\n    # Update Trade model with execution details\\n    # ... implementation ...\\n\\n@RegisterCallback(channel='MSG:CTP:RSP:MARKET:OnRtnDepthMarketData:*')\\nasync def OnRtnDepthMarketData(self, channel: str, tick: dict):\\n    \\\"\\\"\\\"Handle real-time market data ticks\\\"\\\"\\\"\\n    inst_id = channel.split(':')[-1]\\n    # Process tick data\\n    # ... implementation ...\\n\\n@RegisterCallback(channel='MSG:CTP:RSP:TRADE:OnRtnOrder:*')\\nasync def OnRtnOrder(self, channel: str, order: dict):\\n    \\\"\\\"\\\"Handle order status updates\\\"\\\"\\\"\\n    # Update Order model, handle rejections, etc.\\n    # ... implementation ...\\n```\\n\\n**Channel Pattern Routing:**\\n\\n| Channel Pattern | Event | Data Format |\\n|----------------|-------|-------------|\\n| `MSG:CTP:RSP:TRADE:OnRtnTrade:*` | Trade execution | `dict` with CTP trade fields |\\n| `MSG:CTP:RSP:TRADE:OnRtnOrder:*` | Order status | `dict` with CTP order fields |\\n| `MSG:CTP:RSP:MARKET:OnRtnDepthMarketData:*` | Market tick | `dict` with tick data |\\n\\n**Sources:** [trader/strategy/brother2.py:373-566](), [trader/utils/func_container.py]()\\n\\n---\\n\\n## Order Execution\\n\\n### Request-Response Pattern\\n\\nOrders are executed through Redis Pub/Sub to the CTP API gateway:\\n\\n```mermaid\\nsequenceDiagram\\n    participant Strategy as \\\"Your Strategy\\\"\\n    participant Redis as \\\"Redis Message Bus\\\"\\n    participant CTP as \\\"CTP API Gateway\\\"\\n    participant DB as \\\"Django ORM\\\"\\n    \\n    Strategy-\\u003e\\u003eDB: Query unprocessed signals\\n    DB--\\u003e\\u003eStrategy: Signal list\\n    \\n    Strategy-\\u003e\\u003eStrategy: ReqOrderInsert(signal)\\n    Strategy-\\u003e\\u003eRedis: Publish to MSG:CTP:REQ:ReqOrderInsert\\n    \\n    Redis-\\u003e\\u003eCTP: Forward order request\\n    CTP--\\u003e\\u003eRedis: OnRtnOrder (status update)\\n    Redis--\\u003e\\u003eStrategy: Order callback\\n    \\n    Strategy-\\u003e\\u003eDB: Save/update Order model\\n    \\n    CTP--\\u003e\\u003eRedis: OnRtnTrade (fill confirmation)\\n    Redis--\\u003e\\u003eStrategy: Trade callback\\n    \\n    Strategy-\\u003e\\u003eDB: Update Trade model\\n    Strategy-\\u003e\\u003eDB: Mark Signal.processed = True\\n```\\n\\n### ReqOrderInsert Implementation\\n\\nThe order insertion method constructs CTP API parameters and publishes to Redis:\\n\\n```python\\ndef ReqOrderInsert(self, sig: Signal):\\n    \\\"\\\"\\\"Execute a trading signal by sending order to CTP\\\"\\\"\\\"\\n    try:\\n        request_id = get_next_id()\\n        autoid = Autonumber.objects.create()\\n        order_ref = f\\\"{autoid.id:07}{sig.id:05}\\\"  # Unique order reference\\n        \\n        param_dict = {\\n            'RequestID': request_id,\\n            'OrderRef': order_ref,\\n            'InstrumentID': sig.code,\\n            'VolumeTotalOriginal': sig.volume,\\n            'LimitPrice': float(sig.price)\\n        }\\n        \\n        # Determine direction and offset flag based on signal type\\n        match sig.type:\\n            case SignalType.BUY:\\n                param_dict['Direction'] = ApiStruct.D_Buy\\n                param_dict['CombOffsetFlag'] = ApiStruct.OF_Open\\n            case SignalType.SELL:\\n                param_dict['Direction'] = ApiStruct.D_Sell\\n                param_dict['CombOffsetFlag'] = ApiStruct.OF_Close\\n                # Handle SHFE close today vs. close yesterday\\n                pos = Trade.objects.filter(\\n                    broker=self.__broker,\\n                    strategy=self.__strategy,\\n                    code=sig.code,\\n                    close_time__isnull=True\\n                ).first()\\n                if pos.open_time.date() == timezone.localtime().date():\\n                    if pos.instrument.exchange == ExchangeType.SHFE:\\n                        param_dict['CombOffsetFlag'] = ApiStruct.OF_CloseToday\\n        \\n        # Publish to Redis request channel\\n        self.raw_redis.publish(\\n            self.__request_format.format('ReqOrderInsert'),\\n            json.dumps(param_dict)\\n        )\\n        \\n    except Exception as e:\\n        logger.warning(f'ReqOrderInsert error: {repr(e)}', exc_info=True)\\n```\\n\\n**Key Concepts:**\\n\\n1. **OrderRef Format:** `{autonumber:07}{signal_id:05}` - Embeds signal ID for tracking\\n2. **CombOffsetFlag:** Distinguishes open, close, close_today (SHFE-specific)\\n3. **Asynchronous:** Fire-and-forget pattern, responses via callbacks\\n\\n**Sources:** [trader/strategy/brother2.py:301-344](), [trader/strategy/brother2.py:391-469]()\\n\\n---\\n\\n## Query Methods for CTP API\\n\\nThe framework provides async query methods for CTP data:\\n\\n### Pattern: Query with Async Response\\n\\n```python\\nasync def query(self, query_type: str, **kwargs):\\n    \\\"\\\"\\\"Generic query method with timeout\\\"\\\"\\\"\\n    sub_client = self.redis_client.pubsub(ignore_subscribe_messages=True)\\n    request_id = get_next_id()\\n    kwargs['RequestID'] = request_id\\n    \\n    # Subscribe to response channels\\n    channel_rsp = self.__trade_response_format.format(\\n        'OnRspQry' + query_type, request_id\\n    )\\n    channel_err = self.__trade_response_format.format(\\n        'OnRspError', request_id\\n    )\\n    await sub_client.psubscribe(channel_rsp, channel_err)\\n    \\n    # Send query request\\n    self.raw_redis.publish(\\n        self.__request_format.format('ReqQry' + query_type),\\n        json.dumps(kwargs)\\n    )\\n    \\n    # Wait for response\\n    task = asyncio.create_task(self.query_reader(sub_client))\\n    result = await asyncio.wait_for(task, timeout=HANDLER_TIME_OUT)\\n    \\n    await sub_client.punsubscribe()\\n    await sub_client.close()\\n    return result\\n```\\n\\n### Common Query Methods\\n\\n| Method | Query Type | Returns |\\n|--------|-----------|---------|\\n| `query('TradingAccount')` | Account info | Balance, margin, P\\u0026L |\\n| `query('InvestorPositionDetail')` | Position details | All open positions |\\n| `query('Instrument')` | Instrument list | Contract specifications |\\n| `query('Order')` | Order list | All orders (today) |\\n| `query('InstrumentMarginRate', InstrumentID=code)` | Margin rate | Margin requirements |\\n| `query('InstrumentCommissionRate', InstrumentID=code)` | Fee rate | Commission rates |\\n\\n**Example Usage:**\\n\\n```python\\nasync def refresh_account(self):\\n    \\\"\\\"\\\"Update account information from CTP\\\"\\\"\\\"\\n    account = await self.query('TradingAccount')\\n    account = account[0]  # Returns list with single dict\\n    \\n    self.__cash = Decimal(account['Available'])\\n    self.__margin = Decimal(account['CurrMargin'])\\n    self.__current = Decimal(account['PreBalance']) + \\\\\\n                     Decimal(account['CloseProfit']) + \\\\\\n                     Decimal(account['PositionProfit']) - \\\\\\n                     Decimal(account['Commission'])\\n    \\n    # Persist to database\\n    self.__broker.cash = self.__cash\\n    self.__broker.current = self.__current\\n    self.__broker.save(update_fields=['cash', 'current'])\\n```\\n\\n**Sources:** [trader/strategy/brother2.py:236-258](), [trader/strategy/brother2.py:86-113]()\\n\\n---\\n\\n## Data Model Integration\\n\\n### Accessing Strategy Configuration\\n\\n```python\\n# Load strategy and broker from database\\nstrategy = Strategy.objects.get(name='MyStrategy')\\nbroker = strategy.broker\\n\\n# Access related instruments\\nfor inst in strategy.instruments.all():\\n    print(f\\\"Trading: {inst.name} ({inst.product_code})\\\")\\n\\n# Load parameters\\nparams = strategy.param_set.all()\\natr_period = params.get(code='AtrPeriod').int_value\\n```\\n\\n### Querying Market Data\\n\\n```python\\nfrom panel.models import MainBar, DailyBar, to_df\\n\\n# Get continuous series for backtesting\\nbars = MainBar.objects.filter(\\n    exchange=inst.exchange,\\n    product_code=inst.product_code,\\n    time__lte=today\\n).order_by('-time')[:100]\\n\\n# Convert to pandas DataFrame for analysis\\ndf = to_df(bars, index_col='time', parse_dates=['time'])\\n\\n# Get specific contract data\\ndaily_bars = DailyBar.objects.filter(\\n    code='rb2505',\\n    time__gte='2024-01-01'\\n).order_by('time')\\n```\\n\\n### Managing Positions and Signals\\n\\n```python\\n# Check for open positions\\npos = Trade.objects.filter(\\n    broker=broker,\\n    strategy=strategy,\\n    instrument=inst,\\n    close_time__isnull=True  # Open positions only\\n).first()\\n\\nif pos:\\n    print(f\\\"Position: {pos.direction} {pos.shares} @ {pos.avg_entry_price}\\\")\\n\\n# Create trading signal\\nsig = Signal.objects.create(\\n    strategy=strategy,\\n    instrument=inst,\\n    code=inst.main_code,\\n    type=SignalType.BUY,\\n    price=4500.0,\\n    volume=1,\\n    trigger_time=timezone.now(),\\n    priority=PriorityType.Normal,\\n    processed=False\\n)\\n\\n# Query unprocessed signals\\npending = Signal.objects.filter(\\n    strategy=strategy,\\n    processed=False,\\n    trigger_time__gte=last_trading_day\\n).order_by('-priority')\\n```\\n\\n**Sources:** [panel/models.py:104-289](), [trader/strategy/brother2.py:114-154]()\\n\\n---\\n\\n## Complete Strategy Example\\n\\nHere is a simplified strategy class demonstrating all key components:\\n\\n```python\\n# trader/strategy/simple_breakout.py\\nimport asyncio\\nimport logging\\nfrom decimal import Decimal\\nfrom django.utils import timezone\\nfrom django.db.models import Q\\nfrom talib import ATR\\n\\nfrom trader.strategy import BaseModule\\nfrom trader.utils.func_container import RegisterCallback\\nfrom trader.utils import price_round, is_trading_day\\nfrom panel.models import (\\n    Strategy, Instrument, Signal, Trade, MainBar, DailyBar,\\n    SignalType, DirectionType, PriorityType, to_df\\n)\\n\\nlogger = logging.getLogger('SimpleBreakout')\\n\\n\\nclass SimpleBreakoutStrategy(BaseModule):\\n    \\\"\\\"\\\"\\n    Simple breakout strategy:\\n    - Buy when price breaks above N-day high\\n    - Sell when price breaks below N-day low\\n    - Exit on stop-loss (ATR-based)\\n    \\\"\\\"\\\"\\n    \\n    def __init__(self, strategy_name: str):\\n        super().__init__()\\n        self.__strategy = Strategy.objects.get(name=strategy_name)\\n        self.__broker = self.__strategy.broker\\n        \\n        # Load parameters\\n        params = self.__strategy.param_set\\n        self.__breakout_period = params.get(code='BreakoutPeriod').int_value\\n        self.__atr_period = params.get(code='AtrPeriod').int_value\\n        self.__stop_loss_atr = params.get(code='StopLossATR').float_value\\n        self.__position_size = params.get(code='PositionSize').int_value\\n    \\n    async def start(self):\\n        \\\"\\\"\\\"Initialize strategy on startup\\\"\\\"\\\"\\n        await self.install()\\n        self.raw_redis.set('HEARTBEAT:SIMPLE_BREAKOUT', 1, ex=61)\\n        logger.info(f\\\"Strategy {self.__strategy.name} started\\\")\\n        \\n        # Refresh positions from broker\\n        await self.refresh_positions()\\n    \\n    async def refresh_positions(self):\\n        \\\"\\\"\\\"Query and sync positions from CTP\\\"\\\"\\\"\\n        try:\\n            pos_list = await self.query('InvestorPositionDetail')\\n            for pos in pos_list:\\n                if pos.get('empty') or pos['Volume'] == 0:\\n                    continue\\n                \\n                # Sync with database Trade model\\n                inst = Instrument.objects.get(\\n                    product_code=pos['InstrumentID'][:2]\\n                )\\n                Trade.objects.update_or_create(\\n                    broker=self.__broker,\\n                    strategy=self.__strategy,\\n                    instrument=inst,\\n                    code=pos['InstrumentID'],\\n                    close_time__isnull=True,\\n                    defaults={\\n                        'direction': DirectionType.values[pos['Direction']],\\n                        'shares': pos['Volume'],\\n                        'avg_entry_price': Decimal(pos['OpenPrice'])\\n                    }\\n                )\\n        except Exception as e:\\n            logger.warning(f'refresh_positions error: {repr(e)}', exc_info=True)\\n    \\n    @RegisterCallback(crontab='0 17 * * *')\\n    async def calculate_signals(self):\\n        \\\"\\\"\\\"Calculate signals after market close (5:00 PM)\\\"\\\"\\\"\\n        day = timezone.localtime()\\n        _, is_trading = await is_trading_day(day)\\n        \\n        if not is_trading:\\n            logger.info('Non-trading day, skipping signal calculation')\\n            return\\n        \\n        logger.info('Calculating signals for all instruments...')\\n        \\n        for inst in self.__strategy.instruments.all():\\n            self._calc_instrument_signal(inst, day)\\n    \\n    def _calc_instrument_signal(self, inst: Instrument, day):\\n        \\\"\\\"\\\"Generate trading signal for one instrument\\\"\\\"\\\"\\n        try:\\n            # Load historical data\\n            df = to_df(\\n                MainBar.objects.filter(\\n                    exchange=inst.exchange,\\n                    product_code=inst.product_code,\\n                    time__lte=day.date()\\n                ).order_by('-time').values_list(\\n                    'time', 'open', 'high', 'low', 'close'\\n                )[:200]\\n            )\\n            \\n            if df.empty or len(df) \\u003c self.__breakout_period:\\n                logger.warning(f'Insufficient data for {inst.name}')\\n                return\\n            \\n            df = df.iloc[::-1]  # Ascending order\\n            \\n            # Calculate indicators\\n            df['atr'] = ATR(\\n                df.high, df.low, df.close,\\n                timeperiod=self.__atr_period\\n            )\\n            df['high_line'] = df.close.rolling(\\n                window=self.__breakout_period\\n            ).max()\\n            df['low_line'] = df.close.rolling(\\n                window=self.__breakout_period\\n            ).min()\\n            \\n            # Current values\\n            idx = -1\\n            current_price = df.close[idx]\\n            current_atr = df.atr[idx]\\n            prev_high = df.high_line[idx - 1]\\n            prev_low = df.low_line[idx - 1]\\n            \\n            # Check for breakout signals\\n            buy_signal = current_price \\u003e= prev_high\\n            sell_signal = current_price \\u003c= prev_low\\n            \\n            # Check existing position\\n            pos = Trade.objects.filter(\\n                broker=self.__broker,\\n                strategy=self.__strategy,\\n                instrument=inst,\\n                close_time__isnull=True\\n            ).first()\\n            \\n            if pos:\\n                # Check stop-loss\\n                if pos.direction == DirectionType.values[DirectionType.LONG]:\\n                    stop_price = pos.avg_entry_price - (\\n                        current_atr * Decimal(self.__stop_loss_atr)\\n                    )\\n                    if current_price \\u003c= stop_price:\\n                        self._create_signal(\\n                            inst, SignalType.SELL, pos.shares,\\n                            current_price, PriorityType.High\\n                        )\\n                else:\\n                    stop_price = pos.avg_entry_price + (\\n                        current_atr * Decimal(self.__stop_loss_atr)\\n                    )\\n                    if current_price \\u003e= stop_price:\\n                        self._create_signal(\\n                            inst, SignalType.BUY_COVER, pos.shares,\\n                            current_price, PriorityType.High\\n                        )\\n            else:\\n                # New entry signals\\n                if buy_signal:\\n                    self._create_signal(\\n                        inst, SignalType.BUY, self.__position_size,\\n                        current_price, PriorityType.Normal\\n                    )\\n                elif sell_signal:\\n                    self._create_signal(\\n                        inst, SignalType.SELL_SHORT, self.__position_size,\\n                        current_price, PriorityType.Normal\\n                    )\\n                    \\n        except Exception as e:\\n            logger.warning(f'_calc_instrument_signal error: {repr(e)}', exc_info=True)\\n    \\n    def _create_signal(self, inst, signal_type, volume, price, priority):\\n        \\\"\\\"\\\"Create or update signal record\\\"\\\"\\\"\\n        Signal.objects.update_or_create(\\n            code=inst.main_code,\\n            strategy=self.__strategy,\\n            instrument=inst,\\n            type=signal_type,\\n            trigger_time=timezone.now(),\\n            defaults={\\n                'price': price,\\n                'volume': volume,\\n                'priority': priority,\\n                'processed': False\\n            }\\n        )\\n        logger.info(f'Signal created: {inst.name} {signal_type} {volume}@{price}')\\n    \\n    @RegisterCallback(crontab='55 8 * * *')\\n    async def process_signals(self):\\n        \\\"\\\"\\\"Execute signals before market open (8:55 AM)\\\"\\\"\\\"\\n        day = timezone.localtime()\\n        _, is_trading = await is_trading_day(day)\\n        \\n        if not is_trading:\\n            return\\n        \\n        logger.info('Processing pending signals...')\\n        \\n        signals = Signal.objects.filter(\\n            strategy=self.__strategy,\\n            processed=False\\n        ).order_by('-priority', 'trigger_time')\\n        \\n        for sig in signals:\\n            logger.info(f'Executing signal: {sig}')\\n            self.io_loop.call_soon(self.ReqOrderInsert, sig)\\n    \\n    def ReqOrderInsert(self, sig: Signal):\\n        \\\"\\\"\\\"Send order request to CTP via Redis\\\"\\\"\\\"\\n        # Implementation similar to TradeStrategy.ReqOrderInsert\\n        # See trader/strategy/brother2.py:301-344\\n        pass\\n    \\n    @RegisterCallback(channel='MSG:CTP:RSP:TRADE:OnRtnTrade:*')\\n    async def OnRtnTrade(self, channel: str, trade: dict):\\n        \\\"\\\"\\\"Handle trade execution confirmations\\\"\\\"\\\"\\n        order_ref = channel.split(':')[-1]\\n        logger.info(f\\\"Trade executed: {trade['InstrumentID']} \\\"\\n                   f\\\"{trade['Volume']}@{trade['Price']}\\\")\\n        \\n        # Update Trade model with execution details\\n        # Mark signal as processed\\n        # See trader/strategy/brother2.py:391-469\\n        pass\\n    \\n    @RegisterCallback(channel='MSG:CTP:RSP:TRADE:OnRtnOrder:*')\\n    async def OnRtnOrder(self, channel: str, order: dict):\\n        \\\"\\\"\\\"Handle order status updates\\\"\\\"\\\"\\n        # Save order to database, handle rejections\\n        # See trader/strategy/brother2.py:510-566\\n        pass\\n    \\n    @RegisterCallback(crontab='*/1 * * * *')\\n    async def heartbeat(self):\\n        \\\"\\\"\\\"Update heartbeat every minute\\\"\\\"\\\"\\n        self.raw_redis.set('HEARTBEAT:SIMPLE_BREAKOUT', 1, ex=301)\\n```\\n\\n**Sources:** [trader/strategy/brother2.py:38-871](), [trader/strategy/__init__.py:36-140]()\\n\\n---\\n\\n## Best Practices\\n\\n### 1. Error Handling\\n\\nAlways wrap callback methods in try-except blocks:\\n\\n```python\\n@RegisterCallback(crontab='0 17 * * *')\\nasync def calculate_signals(self):\\n    try:\\n        # Signal calculation logic\\n        pass\\n    except Exception as e:\\n        logger.warning(f'calculate_signals error: {repr(e)}', exc_info=True)\\n```\\n\\n### 2. Asynchronous Execution\\n\\nUse `self.io_loop.call_soon()` for non-blocking operations:\\n\\n```python\\n# Don't block the event loop\\nfor sig in signals:\\n    self.io_loop.call_soon(self.ReqOrderInsert, sig)\\n\\n# For delayed execution\\nself.io_loop.call_later(60, self.check_position)\\n```\\n\\n### 3. Database Query Optimization\\n\\nLimit queryset results to avoid loading excessive data:\\n\\n```python\\n# Bad: Loads all records\\nbars = MainBar.objects.filter(product_code='rb')\\n\\n# Good: Limit to needed range\\nbars = MainBar.objects.filter(\\n    product_code='rb',\\n    time__lte=today\\n).order_by('-time')[:100]\\n```\\n\\n### 4. Parameter Management\\n\\nStore all configurable values as `Param` records:\\n\\n```python\\n# In Django admin, create Param records:\\n# - BreakoutPeriod (int_value=20)\\n# - AtrPeriod (int_value=14)\\n# - StopLossATR (float_value=2.0)\\n\\n# In strategy code:\\nself.__breakout_period = self.__strategy.param_set.get(\\n    code='BreakoutPeriod'\\n).int_value\\n```\\n\\n### 5. Position Synchronization\\n\\nAlways refresh positions from CTP on startup:\\n\\n```python\\nasync def start(self):\\n    await self.install()\\n    await self.refresh_positions()  # Sync with broker\\n```\\n\\n### 6. Signal Priority\\n\\nUse priority levels to control execution order:\\n\\n```python\\nfrom panel.const import PriorityType\\n\\n# High priority for stop-loss exits\\nSignal.objects.create(\\n    type=SignalType.SELL,\\n    priority=PriorityType.High,\\n    # ...\\n)\\n\\n# Normal priority for new entries\\nSignal.objects.create(\\n    type=SignalType.BUY,\\n    priority=PriorityType.Normal,\\n    # ...\\n)\\n```\\n\\n**Sources:** [trader/strategy/brother2.py:111-154](), [panel/const.py]()\\n\\n---\\n\\n## Testing Your Strategy\\n\\n### 1. Historical Signal Calculation\\n\\nTest signal generation logic with historical data:\\n\\n```python\\nfrom trader.utils import calc_history_signal\\nfrom panel.models import Instrument\\n\\ninst = Instrument.objects.get(product_code='rb')\\nstrategy = Strategy.objects.get(name='MyStrategy')\\n\\n# Generate historical signals\\ncalc_history_signal(\\n    inst,\\n    start_date='2023-01-01',\\n    end_date='2023-12-31',\\n    strategy=strategy\\n)\\n\\n# Query generated signals\\nsignals = Signal.objects.filter(\\n    strategy=strategy,\\n    instrument=inst,\\n    trigger_time__range=['2023-01-01', '2023-12-31']\\n).order_by('trigger_time')\\n\\nfor sig in signals:\\n    print(f\\\"{sig.trigger_time}: {sig.type} {sig.volume}@{sig.price}\\\")\\n```\\n\\n### 2. Dry-Run Mode\\n\\nUse a fake broker account for paper trading:\\n\\n```python\\n# In Django admin, set Broker.fake to a non-zero value\\nbroker = Broker.objects.get(name='TestAccount')\\nbroker.fake = 1000000  # 1 million virtual capital\\nbroker.save()\\n\\n# The strategy will use fake capital for position sizing\\n# but real CTP API for execution (if broker is configured)\\n```\\n\\n### 3. Manual Signal Testing\\n\\nCreate signals manually to test execution:\\n\\n```python\\nfrom panel.models import Signal, Instrument, SignalType\\nfrom django.utils import timezone\\n\\ninst = Instrument.objects.get(product_code='rb')\\nstrategy = Strategy.objects.get(name='MyStrategy')\\n\\n# Create test signal\\nSignal.objects.create(\\n    strategy=strategy,\\n    instrument=inst,\\n    code=inst.main_code,\\n    type=SignalType.BUY,\\n    price=4500.0,\\n    volume=1,\\n    trigger_time=timezone.now(),\\n    processed=False\\n)\\n\\n# Strategy will process this signal at next scheduled time\\n```\\n\\n**Sources:** [trader/utils/__init__.py](), [trader/strategy/brother2.py:572-643]()\\n\\n---\\n\\n## Deployment\\n\\n### 1. Register Strategy in Database\\n\\nUse Django admin or shell to create strategy record:\\n\\n```python\\nfrom panel.models import Strategy, Broker, Instrument, Param\\n\\n# Create strategy\\nbroker = Broker.objects.get(name='MyBroker')\\nstrategy = Strategy.objects.create(\\n    broker=broker,\\n    name='SimpleBreakout'\\n)\\n\\n# Add instruments\\nstrategy.instruments.add(\\n    Instrument.objects.get(product_code='rb'),\\n    Instrument.objects.get(product_code='cu'),\\n)\\n\\n# Add parameters\\nParam.objects.create(\\n    strategy=strategy,\\n    code='BreakoutPeriod',\\n    int_value=20\\n)\\nParam.objects.create(\\n    strategy=strategy,\\n    code='AtrPeriod',\\n    int_value=14\\n)\\nParam.objects.create(\\n    strategy=strategy,\\n    code='StopLossATR',\\n    float_value=2.0\\n)\\n```\\n\\n### 2. Update main.py\\n\\nModify the entry point to instantiate your strategy:\\n\\n```python\\n# trader/main.py\\nimport os\\nimport django\\n\\nos.environ.setdefault(\\\"DJANGO_SETTINGS_MODULE\\\", \\\"panel.settings\\\")\\ndjango.setup()\\n\\nfrom trader.strategy.simple_breakout import SimpleBreakoutStrategy\\n\\nif __name__ == '__main__':\\n    strategy = SimpleBreakoutStrategy('SimpleBreakout')\\n    strategy.run()  # Blocking call\\n```\\n\\n### 3. Run Strategy\\n\\n```bash\\npython trader/main.py\\n```\\n\\nThe strategy will:\\n1. Connect to Redis and subscribe to CTP channels\\n2. Schedule cron jobs for signal calculation and processing\\n3. Listen for order/trade callbacks\\n4. Execute continuously until interrupted\\n\\n**Sources:** [trader/main.py](), [trader/strategy/__init__.py:129-140]()\\n\\n---\\n\\n## Integration Points Reference\\n\\n### Redis Channel Patterns\\n\\n| Purpose | Pattern | Data Format |\\n|---------|---------|-------------|\\n| Send order | `MSG:CTP:REQ:ReqOrderInsert` | JSON with CTP order fields |\\n| Send query | `MSG:CTP:REQ:ReqQry{Type}` | JSON with RequestID |\\n| Cancel order | `MSG:CTP:REQ:ReqOrderAction` | JSON with order reference |\\n| Receive order status | `MSG:CTP:RSP:TRADE:OnRtnOrder:{OrderRef}` | JSON with order update |\\n| Receive trade | `MSG:CTP:RSP:TRADE:OnRtnTrade:{OrderRef}` | JSON with trade details |\\n| Receive market data | `MSG:CTP:RSP:MARKET:OnRtnDepthMarketData:{InstID}` | JSON with tick data |\\n| Query response | `MSG:CTP:RSP:TRADE:OnRspQry{Type}:{RequestID}` | JSON with query result |\\n\\n### Django Models\\n\\n| Model | Purpose | Key Fields |\\n|-------|---------|-----------|\\n| `Strategy` | Strategy configuration | name, broker, instruments, force_opens |\\n| `Param` | Strategy parameters | code, int_value, float_value, str_value |\\n| `Instrument` | Contract specifications | product_code, main_code, exchange, margin_rate |\\n| `Signal` | Trading signals | type, code, price, volume, processed |\\n| `Order` | Submitted orders | order_ref, status, direction, offset_flag |\\n| `Trade` | Position tracking | shares, avg_entry_price, profit, direction |\\n| `MainBar` | Continuous series | product_code, time, OHLC, settlement |\\n| `DailyBar` | Individual contracts | code, time, OHLC, volume, open_interest |\\n\\n**Sources:** [panel/models.py:104-289](), [trader/strategy/brother2.py:41-44]()\\n\\n---\\n\\n## Summary\\n\\nCreating a custom strategy involves:\\n\\n1. **Extend BaseModule** - Inherit from the abstract base class\\n2. **Implement start()** - Initialize strategy on startup\\n3. **Define Signal Logic** - Implement `calc_signal()` or similar method\\n4. **Register Callbacks** - Use `@RegisterCallback` for scheduling and events\\n5. **Execute Orders** - Implement `ReqOrderInsert()` for order submission\\n6. **Handle Events** - Implement callbacks for trades, orders, and market data\\n7. **Manage Data** - Use Django ORM to query and persist state\\n8. **Test Thoroughly** - Use historical signal calculation and dry-run mode\\n9. **Deploy** - Register in database and run via main.py\\n\\nThe framework handles Redis integration, event loop management, and CTP communication, allowing you to focus on trading logic.\\n\\n**Sources:** [trader/strategy/__init__.py:36-140](), [trader/strategy/brother2.py:38-871](), [panel/models.py:104-289]()\"])</script><script>self.__next_f.push([1,\"39:T405d,\"])</script><script>self.__next_f.push([1,\"# Logging and Monitoring\\n\\n\\u003cdetails\\u003e\\n\\u003csummary\\u003eRelevant source files\\u003c/summary\\u003e\\n\\nThe following files were used as context for generating this wiki page:\\n\\n- [trader/main.py](trader/main.py)\\n- [trader/utils/my_logger.py](trader/utils/my_logger.py)\\n- [trader/utils/read_config.py](trader/utils/read_config.py)\\n\\n\\u003c/details\\u003e\\n\\n\\n\\n## Purpose and Scope\\n\\nThis document describes the logging and monitoring infrastructure in the trader system. It covers the multi-tier logging architecture, log handlers, configuration options, Redis-based monitoring with WeChat integration, and log file management.\\n\\nFor information about the overall system configuration, see [Configuration Reference](#7). For details on scheduled tasks and system operations, see [Scheduled Tasks](#4.6).\\n\\n---\\n\\n## Logging Architecture\\n\\nThe trader system implements a three-tier logging architecture with distinct handlers for different output destinations. This design enables comprehensive logging while providing real-time monitoring capabilities through external services.\\n\\n### Handler Overview\\n\\nThe logging system uses three concurrent handlers, each serving a specific purpose:\\n\\n| Handler Type | Destination | Purpose | Default Level |\\n|--------------|-------------|---------|---------------|\\n| `RotatingFileHandler` | Local log file | Persistent audit trail and debugging | DEBUG |\\n| `StreamHandler` | Console (stdout) | Development and immediate feedback | DEBUG |\\n| `RedislHandler` | Redis channel | Real-time monitoring via WeChat | INFO |\\n\\nEach handler can be configured with independent log levels, allowing fine-grained control over what information is captured at each destination.\\n\\nSources: [trader/main.py:35-65]()\\n\\n### Logging System Diagram\\n\\n```mermaid\\ngraph TB\\n    subgraph \\\"Application Layer\\\"\\n        Strategy[\\\"TradeStrategy\\\"]\\n        Utils[\\\"trader.utils\\\"]\\n        DataFetch[\\\"fetch_data.py\\\"]\\n    end\\n    \\n    subgraph \\\"Python Logging Framework\\\"\\n        RootLogger[\\\"Root Logger\\u003cbr/\\u003elogger.setLevel('DEBUG')\\\"]\\n        NamedLogger[\\\"Named Logger\\u003cbr/\\u003elogging.getLogger('main')\\\"]\\n    end\\n    \\n    subgraph \\\"Log Handlers\\\"\\n        FileHandler[\\\"RotatingFileHandler\\u003cbr/\\u003etrader.log\\u003cbr/\\u003e1MB max, 1 backup\\\"]\\n        ConsoleHandler[\\\"StreamHandler\\u003cbr/\\u003estdout\\\"]\\n        RedisHandler[\\\"RedislHandler\\u003cbr/\\u003eCustom Implementation\\\"]\\n    end\\n    \\n    subgraph \\\"Output Destinations\\\"\\n        LogFile[\\\"Log File\\u003cbr/\\u003eapp_dir.user_log_dir/trader.log\\\"]\\n        Console[\\\"Console Output\\\"]\\n        RedisChannel[\\\"Redis Channel\\u003cbr/\\u003eMSG:LOG:WEIXIN\\\"]\\n    end\\n    \\n    subgraph \\\"External Services\\\"\\n        WeChat[\\\"WeChat Notification Service\\\"]\\n    end\\n    \\n    Strategy --\\u003e RootLogger\\n    Utils --\\u003e RootLogger\\n    DataFetch --\\u003e RootLogger\\n    \\n    RootLogger --\\u003e NamedLogger\\n    NamedLogger --\\u003e FileHandler\\n    NamedLogger --\\u003e ConsoleHandler\\n    NamedLogger --\\u003e RedisHandler\\n    \\n    FileHandler --\\u003e LogFile\\n    ConsoleHandler --\\u003e Console\\n    RedisHandler --\\u003e RedisChannel\\n    RedisChannel -.-\\u003e|\\\"Subscribe \\u0026 Forward\\\"| WeChat\\n    \\n    ConfigFile[\\\"config.ini [LOG]\\\"] -.-\\u003e|\\\"format\\\"| FileHandler\\n    ConfigFile -.-\\u003e|\\\"format\\\"| ConsoleHandler\\n    ConfigFile -.-\\u003e|\\\"weixin_format\\\"| RedisHandler\\n    ConfigFile -.-\\u003e|\\\"file_level\\\"| FileHandler\\n    ConfigFile -.-\\u003e|\\\"flower_level\\\"| RedisHandler\\n```\\n\\nSources: [trader/main.py:35-66]()\\n\\n---\\n\\n## Configuration\\n\\nLogging behavior is controlled through the `[LOG]` section of `config.ini`, along with related settings in the `[MSG_CHANNEL]` section for WeChat integration.\\n\\n### LOG Section Parameters\\n\\nThe following configuration parameters control logging behavior:\\n\\n| Parameter | Type | Default | Description |\\n|-----------|------|---------|-------------|\\n| `level` | String | DEBUG | Base log level for application loggers |\\n| `format` | String | `%(asctime)s %(name)s [%(levelname)s] %(message)s` | Format string for file and console handlers |\\n| `weixin_format` | String | `[%(levelname)s] %(message)s` | Simplified format for WeChat messages |\\n| `file_level` | String | DEBUG | Log level threshold for file handler |\\n| `flower_level` | String | INFO | Log level threshold for Redis/WeChat handler |\\n\\n### Configuration Example\\n\\n```ini\\n[LOG]\\nlevel = DEBUG\\nformat = %(asctime)s %(name)s [%(levelname)s] %(message)s\\nweixin_format = [%(levelname)s] %(message)s\\nfile_level = DEBUG\\nflower_level = INFO\\n\\n[MSG_CHANNEL]\\nweixin_log = MSG:LOG:WEIXIN\\n```\\n\\n### Log File Location\\n\\nLog files are stored in platform-specific directories managed by the `appdirs` library:\\n\\n- **Linux**: `/root/.local/share/trader/` or `~/.local/share/trader/`\\n- **Windows**: `C:\\\\Users\\\\\\u003cusername\\u003e\\\\AppData\\\\Local\\\\trader\\\\trader\\\\`\\n- **macOS**: `~/Library/Logs/trader/`\\n\\nThe main log file is named `trader.log` with automatic rotation when it exceeds 1MB. One backup file (`trader.log.1`) is retained.\\n\\nSources: [trader/main.py:49-54](), [trader/utils/read_config.py:62-63]()\\n\\n---\\n\\n## Redis-Based Monitoring\\n\\nThe trader system implements real-time monitoring through a custom Redis handler that publishes log messages to a Redis channel, enabling integration with external notification services.\\n\\n### RedislHandler Implementation\\n\\nThe `RedislHandler` class extends Python's `logging.StreamHandler` to publish log messages to Redis:\\n\\n```mermaid\\nclassDiagram\\n    class StreamHandler {\\n        \\u003c\\u003cPython stdlib\\u003e\\u003e\\n        +emit(record)\\n    }\\n    \\n    class RedislHandler {\\n        -redis_client: StrictRedis\\n        -channel: str\\n        +__init__(channel)\\n        +emit(message)\\n    }\\n    \\n    class StrictRedis {\\n        \\u003c\\u003credis-py\\u003e\\u003e\\n        +publish(channel, message)\\n    }\\n    \\n    StreamHandler \\u003c|-- RedislHandler\\n    RedislHandler --\\u003e StrictRedis : uses\\n    \\n    note for RedislHandler \\\"Publishes log messages to Redis channel\\\"\\n```\\n\\n**Key Characteristics:**\\n\\n- **Channel**: Configured via `config.get('MSG_CHANNEL', 'weixin_log')`, typically `MSG:LOG:WEIXIN`\\n- **Redis Connection**: Independent `StrictRedis` client created specifically for logging\\n- **Message Format**: Uses simplified format string from `weixin_format` configuration\\n- **Level Filtering**: Only messages at or above `flower_level` are published\\n\\n### Message Flow\\n\\n```mermaid\\nsequenceDiagram\\n    participant App as \\\"Application Code\\\"\\n    participant Logger as \\\"Python Logger\\\"\\n    participant RHandler as \\\"RedislHandler\\\"\\n    participant Redis as \\\"Redis Server\\\"\\n    participant WXSvc as \\\"WeChat Service\\\"\\n    \\n    App-\\u003e\\u003eLogger: logger.info(\\\"Order filled\\\")\\n    Logger-\\u003e\\u003eLogger: Check log level\\n    \\n    alt Level \\u003e= flower_level (INFO)\\n        Logger-\\u003e\\u003eRHandler: emit(LogRecord)\\n        RHandler-\\u003e\\u003eRHandler: Format message\\n        RHandler-\\u003e\\u003eRedis: publish(\\\"MSG:LOG:WEIXIN\\\", \\\"[INFO] Order filled\\\")\\n        Redis--\\u003e\\u003eWXSvc: Message delivered to subscribers\\n        WXSvc-\\u003e\\u003eWXSvc: Send notification to users\\n    end\\n    \\n    Note over Logger,RHandler: Same message also goes to\\u003cbr/\\u003efile and console handlers\\n```\\n\\nSources: [trader/main.py:35-45](), [trader/main.py:58-60]()\\n\\n---\\n\\n## Logger Creation and Management\\n\\nThe system provides two mechanisms for creating loggers: the main application logger initialized in `trader/main.py`, and the utility function `get_my_logger()` for creating named loggers.\\n\\n### Main Application Logger\\n\\nThe main logger is initialized when the trading system starts:\\n\\n**Initialization Steps:**\\n\\n1. Create log directory if it doesn't exist\\n2. Configure `RotatingFileHandler` with 1MB rotation\\n3. Configure console `StreamHandler` for immediate feedback\\n4. Configure `RedislHandler` for WeChat notifications\\n5. Attach all handlers to root logger\\n6. Create named logger for main module\\n\\n**Log Directory Creation:**\\n\\n```\\napp_dir.user_log_dir/\\n trader.log        # Current log file\\n trader.log.1      # Rotated backup\\n \\u003cname\\u003e.log        # Custom logger files\\n```\\n\\nSources: [trader/main.py:49-66]()\\n\\n### get_my_logger() Utility\\n\\nFor creating loggers in other modules, the `get_my_logger()` function provides a simplified interface:\\n\\n**Function Signature:**\\n```python\\ndef get_my_logger(logger_name='main') -\\u003e logging.Logger\\n```\\n\\n**Behavior:**\\n\\n- Returns existing logger if already configured (idempotent)\\n- Creates separate log file: `{logger_name}.log`\\n- Attaches both file and console handlers\\n- Uses same format string from configuration\\n- Level determined by `config.get('LOG', 'level')`\\n\\n**Usage Pattern:**\\n\\n```python\\nfrom trader.utils.my_logger import get_my_logger\\n\\nlogger = get_my_logger('data_fetch')\\nlogger.info('Starting data acquisition')\\n```\\n\\nSources: [trader/utils/my_logger.py:21-37]()\\n\\n### Logger Hierarchy\\n\\n```mermaid\\ngraph TB\\n    RootLogger[\\\"Root Logger\\u003cbr/\\u003eLevel: DEBUG\\\"]\\n    \\n    MainLogger[\\\"main\\u003cbr/\\u003e(TradeStrategy)\\\"]\\n    DataLogger[\\\"data_fetch\\u003cbr/\\u003e(via get_my_logger)\\\"]\\n    UtilsLogger[\\\"utils\\u003cbr/\\u003e(via get_my_logger)\\\"]\\n    \\n    subgraph \\\"Main App Handlers\\\"\\n        MFH[\\\"RotatingFileHandler\\u003cbr/\\u003etrader.log\\\"]\\n        MCH[\\\"StreamHandler\\\"]\\n        MRH[\\\"RedislHandler\\\"]\\n    end\\n    \\n    subgraph \\\"Custom Logger Handlers\\\"\\n        DFH[\\\"FileHandler\\u003cbr/\\u003edata_fetch.log\\\"]\\n        DCH[\\\"StreamHandler\\\"]\\n    end\\n    \\n    RootLogger --\\u003e MainLogger\\n    RootLogger --\\u003e DataLogger\\n    RootLogger --\\u003e UtilsLogger\\n    \\n    MainLogger --\\u003e MFH\\n    MainLogger --\\u003e MCH\\n    MainLogger --\\u003e MRH\\n    \\n    DataLogger --\\u003e DFH\\n    DataLogger --\\u003e DCH\\n```\\n\\nSources: [trader/main.py:61-66](), [trader/utils/my_logger.py:21-37]()\\n\\n---\\n\\n## Log File Management\\n\\n### Rotation Policy\\n\\nThe main `trader.log` file uses automatic rotation to prevent unbounded growth:\\n\\n**Configuration:**\\n- **Max Size**: 1,048,576 bytes (1 MB)\\n- **Backup Count**: 1 file\\n- **Encoding**: UTF-8\\n- **Handler**: `logging.handlers.RotatingFileHandler`\\n\\nWhen the log file exceeds 1MB:\\n1. Current `trader.log` renamed to `trader.log.1`\\n2. Previous `trader.log.1` (if exists) is deleted\\n3. New `trader.log` created for fresh entries\\n\\nSources: [trader/main.py:51]()\\n\\n### PID File Management\\n\\nThe system writes a PID file to track the running process:\\n\\n**Location:** `app_dir.user_cache_dir/trader.pid`\\n\\n**Platform-specific paths:**\\n- **Linux**: `/root/.cache/trader/trader.pid`\\n- **Windows**: `C:\\\\Users\\\\\\u003cusername\\u003e\\\\AppData\\\\Local\\\\trader\\\\trader\\\\Cache\\\\`\\n- **macOS**: `~/Library/Caches/trader/`\\n\\n**Content:** Single line containing the process ID\\n\\nThis enables external monitoring scripts to check if the trader is running and to send signals (e.g., graceful shutdown) to the correct process.\\n\\nSources: [trader/main.py:67-72]()\\n\\n---\\n\\n## Practical Usage Patterns\\n\\n### Log Levels by Component\\n\\nThe system uses different log levels based on the importance of the message:\\n\\n| Level | Use Case | Example |\\n|-------|----------|---------|\\n| DEBUG | Detailed execution flow | Position calculations, indicator values |\\n| INFO | Important events | Signal generated, order submitted, trade executed |\\n| WARNING | Recoverable issues | CTP API timeout, retry attempts |\\n| ERROR | Failures requiring attention | Order rejection, database errors |\\n| CRITICAL | System failures | Redis connection lost, fatal exceptions |\\n\\n### WeChat Notification Strategy\\n\\nSince WeChat notifications are rate-limited and intrusive, the `flower_level` is typically set to `INFO` or higher. This ensures only significant events generate notifications:\\n\\n**Recommended WeChat Triggers:**\\n- Order confirmations\\n- Trade executions\\n- Position changes\\n- Critical errors\\n- Daily performance summaries\\n\\n**Suppress from WeChat:**\\n- Debug traces\\n- Routine data updates\\n- Technical indicator calculations\\n\\n### Startup Output\\n\\nWhen the system starts, it prints key information to console before logging begins:\\n\\n```\\nBig Brother is watching you!\\nused config file: /root/.config/trader/config.ini\\nlog stored in: /root/.local/share/trader\\npid file: /root/.cache/trader/trader.pid\\n```\\n\\nThis provides immediate feedback about the system configuration even if logging fails to initialize.\\n\\nSources: [trader/main.py:73-76]()\\n\\n---\\n\\n## Integration with System Components\\n\\n### TradeStrategy Logging\\n\\nThe `TradeStrategy` class (see [TradeStrategy Class](#4.1)) uses the configured logger throughout its lifecycle:\\n\\n**Common Log Points:**\\n- Signal generation: `logger.info(f'Generated signal: {signal.code} {signal.type}')`\\n- Order submission: `logger.info(f'Order submitted: {order_ref}')`\\n- Trade confirmation: `logger.info(f'Trade executed: {trade.code} @ {trade.price}')`\\n- Error handling: `logger.error(f'CTP error: {error_code} - {error_msg}')`\\n\\n### Data Acquisition Logging\\n\\nData fetching operations in `trader/utils/fetch_data.py` use separate loggers to track:\\n- Exchange API requests\\n- Data parsing progress\\n- Database insertion results\\n- Error conditions\\n\\n### Redis Message Logging\\n\\nThe Redis Pub/Sub communication (see [Message Bus and Communication](#3.3)) generates logs at key points:\\n- Channel subscriptions\\n- Message publications\\n- Response timeouts\\n- Connection events\\n\\n---\\n\\n## Configuration Reference Table\\n\\nComplete reference for all logging-related configuration parameters:\\n\\n| Section | Key | Type | Default | Description |\\n|---------|-----|------|---------|-------------|\\n| LOG | level | String | DEBUG | Base log level for get_my_logger() |\\n| LOG | format | String | See example | Format for file/console output |\\n| LOG | weixin_format | String | `[%(levelname)s] %(message)s` | Format for WeChat messages |\\n| LOG | file_level | String | DEBUG | Threshold for file handler |\\n| LOG | flower_level | String | INFO | Threshold for Redis/WeChat handler |\\n| MSG_CHANNEL | weixin_log | String | MSG:LOG:WEIXIN | Redis channel for log messages |\\n| REDIS | host | String | 127.0.0.1 | Redis server hostname |\\n| REDIS | port | Integer | 6379 | Redis server port |\\n| REDIS | db | Integer | 0 | Redis database number |\\n| REDIS | encoding | String | utf-8 | Redis connection encoding |\\n\\nSources: [trader/utils/read_config.py:23-60](), [trader/main.py:38-60]()\\n\\n---\\n\\n## Monitoring Best Practices\\n\\n### 1. Log Level Strategy\\n\\n- **Development**: Set `file_level=DEBUG` and `flower_level=WARNING` to capture detailed traces without notification spam\\n- **Production**: Set `file_level=INFO` and `flower_level=INFO` for balanced monitoring\\n- **Critical Systems**: Set `file_level=DEBUG` and `flower_level=ERROR` to capture everything locally but only alert on failures\\n\\n### 2. Log Rotation Considerations\\n\\nThe default 1MB rotation with 1 backup file (total 2MB) is suitable for most deployments. For high-frequency trading or detailed debugging:\\n\\n```python\\n# Increase in trader/main.py\\nfile_handler = handlers.RotatingFileHandler(\\n    log_file, encoding='utf-8', \\n    maxBytes=10*1024*1024,  # 10MB\\n    backupCount=5            # 5 backups (60MB total)\\n)\\n```\\n\\n### 3. Redis Handler Resilience\\n\\nThe `RedislHandler` creates an independent Redis connection. If Redis fails:\\n- File and console logging continues uninterrupted\\n- WeChat notifications are lost (not queued)\\n- No exceptions raised to application code\\n\\nConsider implementing Redis connection health checks if WeChat monitoring is critical.\\n\\n### 4. Custom Logger Naming\\n\\nUse descriptive logger names in `get_my_logger()` to facilitate log analysis:\\n\\n```python\\n# Good naming\\nlogger = get_my_logger('signal_generation')\\nlogger = get_my_logger('order_execution')\\nlogger = get_my_logger('data_fetch_shfe')\\n\\n# Avoid generic names\\nlogger = get_my_logger('utils')\\nlogger = get_my_logger('module1')\\n```\\n\\n---\\n\\n## Error Handling and Diagnostics\\n\\n### Common Issues\\n\\n| Issue | Symptom | Solution |\\n|-------|---------|----------|\\n| Log directory permission denied | No log files created | Check ownership of `app_dir.user_log_dir` |\\n| Redis connection refused | WeChat notifications fail | Verify Redis server running and accessible |\\n| Log rotation not working | Single large log file | Check disk space and file permissions |\\n| Duplicate log messages | Each message appears multiple times | Check for multiple `logger.addHandler()` calls |\\n\\n### Diagnostic Commands\\n\\n**Check log file location:**\\n```python\\nfrom trader.utils.read_config import app_dir\\nprint(app_dir.user_log_dir)\\n```\\n\\n**Verify Redis handler connectivity:**\\n```python\\nimport redis\\nfrom trader.utils.read_config import config\\nclient = redis.StrictRedis(\\n    host=config.get('REDIS', 'host'),\\n    port=config.getint('REDIS', 'port'),\\n    db=config.getint('REDIS', 'db')\\n)\\nclient.ping()  # Should return True\\n```\\n\\n**Test log output:**\\n```python\\nimport logging\\nlogger = logging.getLogger('main')\\nlogger.debug('Debug message')\\nlogger.info('Info message')\\nlogger.warning('Warning message')\\nlogger.error('Error message')\\n```\\n\\nSources: [trader/main.py:35-77](), [trader/utils/my_logger.py:21-37](), [trader/utils/read_config.py:62-72]()\"])</script><script>self.__next_f.push([1,\"3a:T46c5,\"])</script><script>self.__next_f.push([1,\"# Deployment\\n\\n\\u003cdetails\\u003e\\n\\u003csummary\\u003eRelevant source files\\u003c/summary\\u003e\\n\\nThe following files were used as context for generating this wiki page:\\n\\n- [.github/workflows/auto-sync.yml](.github/workflows/auto-sync.yml)\\n- [README.rst](README.rst)\\n- [trader/main.py](trader/main.py)\\n\\n\\u003c/details\\u003e\\n\\n\\n\\n## Purpose and Scope\\n\\nThis document covers production deployment of the trader system, including process management, GitHub to Gitee repository mirroring, and operational best practices. It explains how the system initializes, manages processes, and integrates with external infrastructure.\\n\\nFor initial setup including dependency installation, see [Installation](#2.1). For system configuration details, see [Configuration](#2.2). For starting and running the system in development, see [Running the System](#2.3).\\n\\n## Deployment Architecture\\n\\nThe trader system runs as a long-lived daemon process that connects to multiple external services. Understanding the deployment topology is critical for production operations.\\n\\n### System Topology\\n\\n```mermaid\\nflowchart TB\\n    subgraph \\\"Host Environment\\\"\\n        direction TB\\n        MainProc[\\\"main.py process\\u003cbr/\\u003ePID stored in\\u003cbr/\\u003euser_cache_dir/trader.pid\\\"]\\n        \\n        subgraph \\\"Logging Infrastructure\\\"\\n            FileLog[\\\"RotatingFileHandler\\u003cbr/\\u003euser_log_dir/trader.log\\u003cbr/\\u003e1MB max, 1 backup\\\"]\\n            ConsoleLog[\\\"StreamHandler\\u003cbr/\\u003estdout\\\"]\\n            RedisLog[\\\"RedislHandler\\u003cbr/\\u003ePublishes to\\u003cbr/\\u003eMSG:LOG:WEIXIN channel\\\"]\\n        end\\n        \\n        PIDFile[\\\"PID File\\u003cbr/\\u003etracker\\\"]\\n    end\\n    \\n    subgraph \\\"External Dependencies\\\"\\n        RedisServer[\\\"Redis Server\\u003cbr/\\u003eMessage Bus + Cache\\\"]\\n        MySQLServer[\\\"MySQL Database\\u003cbr/\\u003eDjango ORM Backend\\\"]\\n        CTPGateway[\\\"CTP Gateway Process\\u003cbr/\\u003eSeparate service\\\"]\\n        WeixinService[\\\"WeChat Notification\\u003cbr/\\u003eService\\\"]\\n    end\\n    \\n    MainProc --\\u003e FileLog\\n    MainProc --\\u003e ConsoleLog\\n    MainProc --\\u003e RedisLog\\n    MainProc --\\u003e PIDFile\\n    \\n    MainProc \\u003c--\\u003e RedisServer\\n    MainProc \\u003c--\\u003e MySQLServer\\n    RedisServer \\u003c--\\u003e CTPGateway\\n    RedisLog --\\u003e WeixinService\\n    \\n    classDef processNode fill:#e8e8e8,stroke:#333\\n    classDef logNode fill:#f0f0f0,stroke:#666\\n    classDef extNode fill:#d0d0d0,stroke:#333\\n    \\n    class MainProc processNode\\n    class FileLog,ConsoleLog,RedisLog logNode\\n    class RedisServer,MySQLServer,CTPGateway,WeixinService extNode\\n```\\n\\n**Sources:** [trader/main.py:1-78]()\\n\\n### Platform-Specific Paths\\n\\nThe system adapts to different deployment platforms through platform detection. The entry point configures paths based on `sys.platform`:\\n\\n| Platform | `sys.platform` | Dashboard Path | Use Case |\\n|----------|---------------|----------------|----------|\\n| macOS | `darwin` | `/Users/jeffchen/Documents/gitdir/dashboard` | Local development |\\n| Windows | `win32` | `D:\\\\github\\\\dashboard` | Local development |\\n| Linux | other | `/root/gitee/dashboard` | Production deployment |\\n\\nThe production Linux deployment assumes the dashboard repository is cloned to `/root/gitee/dashboard`, reflecting the Gitee mirroring strategy (see GitHub to Gitee Mirroring section).\\n\\n**Sources:** [trader/main.py:19-24]()\\n\\n## Process Management\\n\\n### System Initialization\\n\\nThe `main.py` entry point performs a series of initialization steps before starting the trading strategy:\\n\\n```mermaid\\nsequenceDiagram\\n    participant Shell as \\\"Shell/Supervisor\\\"\\n    participant Main as \\\"trader/main.py\\\"\\n    participant Django as \\\"Django Framework\\\"\\n    participant FS as \\\"File System\\\"\\n    participant Logger as \\\"Logging System\\\"\\n    participant Strategy as \\\"TradeStrategy\\\"\\n    \\n    Shell-\\u003e\\u003eMain: python trader/main.py\\n    \\n    Main-\\u003e\\u003eMain: Detect platform\\u003cbr/\\u003e(darwin/win32/linux)\\n    Main-\\u003e\\u003eMain: sys.path.append(dashboard_path)\\n    Main-\\u003e\\u003eMain: Set DJANGO_SETTINGS_MODULE\\n    Main-\\u003e\\u003eMain: Set DJANGO_ALLOW_ASYNC_UNSAFE\\n    \\n    Main-\\u003e\\u003eDjango: django.setup()\\n    Django--\\u003e\\u003eMain: ORM ready\\n    \\n    Main-\\u003e\\u003eFS: Check app_dir.user_log_dir exists\\n    FS--\\u003e\\u003eMain: Create if missing\\n    \\n    Main-\\u003e\\u003eLogger: Configure RotatingFileHandler\\n    Main-\\u003e\\u003eLogger: Configure StreamHandler (console)\\n    Main-\\u003e\\u003eLogger: Configure RedislHandler (WeChat)\\n    Logger--\\u003e\\u003eMain: Logging ready\\n    \\n    Main-\\u003e\\u003eFS: Check app_dir.user_cache_dir exists\\n    FS--\\u003e\\u003eMain: Create if missing\\n    \\n    Main-\\u003e\\u003eFS: Write PID to user_cache_dir/trader.pid\\n    FS--\\u003e\\u003eMain: PID file created\\n    \\n    Main-\\u003e\\u003eStrategy: Initialize TradeStrategy(name='2.2')\\n    Main-\\u003e\\u003eStrategy: run()\\n    Strategy--\\u003e\\u003eMain: Event loop starts (blocking)\\n```\\n\\n**Sources:** [trader/main.py:16-77]()\\n\\n### PID File Management\\n\\nThe system writes its process ID to a file for external monitoring and control:\\n\\n- **Location:** `{app_dir.user_cache_dir}/trader.pid`\\n- **Purpose:** Enables process supervision, restart detection, and graceful shutdown scripts\\n- **Format:** Plain text containing the numeric PID\\n\\nThe PID file is created before the strategy runs, ensuring external tools can immediately track the process.\\n\\n**Sources:** [trader/main.py:67-72]()\\n\\n### Logging Configuration\\n\\nThe system implements a three-tier logging strategy for comprehensive observability:\\n\\n#### Log Handler Configuration\\n\\n```mermaid\\ngraph TB\\n    subgraph \\\"Log Sources\\\"\\n        TradeStrategy[\\\"TradeStrategy\\u003cbr/\\u003estrategy.brother2\\\"]\\n        Utils[\\\"trader.utils modules\\\"]\\n        BaseModule[\\\"BaseModule framework\\\"]\\n    end\\n    \\n    subgraph \\\"Log Handlers\\\"\\n        RFH[\\\"RotatingFileHandler\\u003cbr/\\u003eFile: user_log_dir/trader.log\\u003cbr/\\u003eMax: 1MB per file\\u003cbr/\\u003eBackups: 1\\u003cbr/\\u003eLevel: LOG.file_level (DEBUG)\\\"]\\n        \\n        SH[\\\"StreamHandler\\u003cbr/\\u003eTarget: stdout\\u003cbr/\\u003eLevel: DEBUG\\\"]\\n        \\n        RLH[\\\"RedislHandler\\u003cbr/\\u003eChannel: MSG_CHANNEL.weixin_log\\u003cbr/\\u003eLevel: LOG.flower_level (INFO)\\\"]\\n    end\\n    \\n    subgraph \\\"Log Destinations\\\"\\n        LogFile[\\\"trader.log\\u003cbr/\\u003ePersistent storage\\\"]\\n        Console[\\\"Console Output\\u003cbr/\\u003eReal-time monitoring\\\"]\\n        WeChat[\\\"WeChat Notifications\\u003cbr/\\u003eCritical alerts\\\"]\\n    end\\n    \\n    TradeStrategy --\\u003e RFH\\n    TradeStrategy --\\u003e SH\\n    TradeStrategy --\\u003e RLH\\n    \\n    Utils --\\u003e RFH\\n    Utils --\\u003e SH\\n    Utils --\\u003e RLH\\n    \\n    BaseModule --\\u003e RFH\\n    BaseModule --\\u003e SH\\n    BaseModule --\\u003e RLH\\n    \\n    RFH --\\u003e LogFile\\n    SH --\\u003e Console\\n    RLH --\\u003e WeChat\\n```\\n\\n#### Log Levels and Routing\\n\\n| Handler | Level | Format Source | Destination | Purpose |\\n|---------|-------|--------------|-------------|---------|\\n| RotatingFileHandler | `LOG.file_level` (DEBUG) | `LOG.format` | `user_log_dir/trader.log` | Persistent audit trail |\\n| StreamHandler | DEBUG | `LOG.format` | stdout | Real-time console output |\\n| RedislHandler | `LOG.flower_level` (INFO) | `LOG.weixin_format` | Redis channel  WeChat | Critical alerts |\\n\\nThe `RedislHandler` custom class publishes log messages to Redis, which are consumed by a WeChat notification service for real-time operational alerts.\\n\\n**Sources:** [trader/main.py:35-65]()\\n\\n## GitHub to Gitee Mirroring\\n\\nThe project uses automated repository mirroring from GitHub to Gitee (China's primary Git hosting platform) for improved accessibility in mainland China.\\n\\n### Mirroring Workflow\\n\\n```mermaid\\nsequenceDiagram\\n    participant Dev as \\\"Developer\\\"\\n    participant GH as \\\"GitHub\\u003cbr/\\u003eBigBrotherTrade/trader\\\"\\n    participant Actions as \\\"GitHub Actions\\\"\\n    participant Gitee as \\\"Gitee\\u003cbr/\\u003etimercrack/trader\\\"\\n    participant Server as \\\"Production Server\\u003cbr/\\u003e/root/gitee/dashboard\\\"\\n    \\n    Dev-\\u003e\\u003eGH: git push origin master\\n    GH-\\u003e\\u003eActions: Trigger on push to master\\n    \\n    Actions-\\u003e\\u003eActions: Run Yikun/hub-mirror-action\\n    Actions-\\u003e\\u003eActions: Authenticate with GITEE_PRIVATE_KEY\\n    Actions-\\u003e\\u003eActions: Authenticate with GITEE_TOKEN\\n    \\n    Actions-\\u003e\\u003eGitee: Force push to timercrack/trader\\n    Gitee--\\u003e\\u003eActions: Mirror updated\\n    \\n    Note over Server: Manual deployment step\\n    Server-\\u003e\\u003eGitee: git pull\\n    Server-\\u003e\\u003eServer: Restart trader service\\n```\\n\\n### Workflow Configuration\\n\\nThe mirroring is configured in `.github/workflows/auto-sync.yml`:\\n\\n| Parameter | Value | Description |\\n|-----------|-------|-------------|\\n| **Trigger** | `push` to `master` branch | Automatic sync on every commit to master |\\n| **Source** | `github/BigBrotherTrade` | Organization account on GitHub |\\n| **Destination** | `gitee/timercrack` | User account on Gitee |\\n| **Authentication** | `GITEE_PRIVATE_KEY`, `GITEE_TOKEN` | Stored as GitHub Secrets |\\n| **Force Update** | `true` | Overwrites Gitee history with GitHub as source of truth |\\n| **Static List** | `trader` | Explicitly mirrors the trader repository |\\n| **Mappings** | `dashboard=\\u003edashboards` | Renames dashboard repo to dashboards on Gitee |\\n\\n**Sources:** [.github/workflows/auto-sync.yml:1-23]()\\n\\n### Deployment Integration\\n\\nThe Linux production deployment path (`/root/gitee/dashboard`) reflects this mirroring strategy:\\n\\n1. **GitHub** serves as the primary development repository\\n2. **GitHub Actions** automatically mirrors to **Gitee** on every push\\n3. **Production servers** in China clone from Gitee for better network reliability\\n4. The `main.py` platform detection automatically uses `/root/gitee/dashboard` on Linux\\n\\nThis architecture provides:\\n- Fast development iteration on GitHub (better global access)\\n- Reliable production deployment from Gitee (better China access)\\n- Automated synchronization with no manual intervention\\n\\n**Sources:** [trader/main.py:19-24](), [.github/workflows/auto-sync.yml:1-23]()\\n\\n## Production Deployment Checklist\\n\\n### Prerequisites\\n\\nBefore deploying to production, ensure all dependencies are properly configured:\\n\\n1. **TA-Lib C Library** - Must be installed before Python packages (see [Installation](#2.1))\\n2. **MySQL Configuration** - Timeout settings must be adjusted for long-running connections\\n3. **Redis Server** - Running and accessible per `config.ini` settings\\n4. **CTP Gateway** - Separate service process must be running\\n5. **Dashboard Repository** - Must be available at the platform-specific path\\n\\n### MySQL Configuration Requirements\\n\\nThe system requires extended MySQL connection timeouts for long-lived database connections. Edit `/etc/my.cnf.d/server.cnf`:\\n\\n```ini\\n[mysqld]\\nwait_timeout=31536000\\ninteractive_timeout=31536000\\n```\\n\\nThese settings configure timeouts to one year, preventing connection drops during extended trading sessions. After editing, restart MySQL:\\n\\n```bash\\nsystemctl restart mysqld\\n```\\n\\n**Sources:** [README.rst:12-18]()\\n\\n### Deployment Steps\\n\\n```mermaid\\nflowchart TD\\n    Start[\\\"Start Deployment\\\"] --\\u003e Clone[\\\"Clone from Gitee\\u003cbr/\\u003egit clone to /root/gitee/dashboard\\\"]\\n    Clone --\\u003e InstallTA[\\\"Install TA-Lib C library\\u003cbr/\\u003eplatform-specific\\\"]\\n    InstallTA --\\u003e InstallPip[\\\"pip install dependencies\\u003cbr/\\u003erequirements.txt\\\"]\\n    InstallPip --\\u003e ConfigMySQL[\\\"Configure MySQL timeouts\\u003cbr/\\u003e/etc/my.cnf.d/server.cnf\\\"]\\n    ConfigMySQL --\\u003e RestartMySQL[\\\"systemctl restart mysqld\\\"]\\n    RestartMySQL --\\u003e ConfigINI[\\\"Configure config.ini\\u003cbr/\\u003eSee Configuration page\\\"]\\n    ConfigINI --\\u003e StartRedis[\\\"Ensure Redis running\\u003cbr/\\u003esystemctl start redis\\\"]\\n    StartRedis --\\u003e StartCTP[\\\"Start CTP gateway process\\\"]\\n    StartCTP --\\u003e RunMigrations[\\\"python manage.py migrate\\u003cbr/\\u003eInitialize Django DB\\\"]\\n    RunMigrations --\\u003e TestConfig[\\\"Test configuration\\u003cbr/\\u003epython -c 'from trader.utils.read_config import config'\\\"]\\n    TestConfig --\\u003e StartTrader[\\\"Start trader process\\u003cbr/\\u003epython trader/main.py\\\"]\\n    StartTrader --\\u003e VerifyPID[\\\"Verify PID file created\\u003cbr/\\u003ecat user_cache_dir/trader.pid\\\"]\\n    VerifyPID --\\u003e MonitorLogs[\\\"Monitor logs\\u003cbr/\\u003etail -f user_log_dir/trader.log\\\"]\\n    MonitorLogs --\\u003e End[\\\"Deployment Complete\\\"]\\n```\\n\\n**Sources:** [README.rst:1-26](), [trader/main.py:1-78]()\\n\\n## Process Supervision\\n\\n### Manual Process Management\\n\\nThe system can be managed using standard Unix process tools:\\n\\n```bash\\n# Start the trader\\ncd /path/to/trader\\npython trader/main.py \\u0026\\n\\n# Check if running\\nps aux | grep trader/main.py\\n\\n# Find PID\\ncat $(python -c \\\"from trader.utils.read_config import app_dir; print(app_dir.user_cache_dir)\\\")/trader.pid\\n\\n# Stop gracefully\\nkill $(cat path/to/trader.pid)\\n\\n# Force stop\\nkill -9 $(cat path/to/trader.pid)\\n```\\n\\n### Supervisor Configuration (Recommended)\\n\\nFor production deployments, use Supervisor for automatic restart and monitoring:\\n\\n```ini\\n[program:trader]\\ncommand=/usr/bin/python /root/gitee/trader/trader/main.py\\ndirectory=/root/gitee/trader\\nuser=root\\nautostart=true\\nautorestart=true\\nredirect_stderr=true\\nstdout_logfile=/var/log/supervisor/trader.log\\nenvironment=PYTHONPATH=\\\"/root/gitee/dashboard\\\"\\n```\\n\\n### Systemd Unit File (Alternative)\\n\\nFor systemd-based Linux distributions:\\n\\n```ini\\n[Unit]\\nDescription=Trader Automated Trading System\\nAfter=network.target mysql.service redis.service\\n\\n[Service]\\nType=simple\\nUser=root\\nWorkingDirectory=/root/gitee/trader\\nEnvironment=\\\"PYTHONPATH=/root/gitee/dashboard\\\"\\nExecStart=/usr/bin/python /root/gitee/trader/trader/main.py\\nRestart=always\\nRestartSec=10\\n\\n[Install]\\nWantedBy=multi-user.target\\n```\\n\\n## Production Best Practices\\n\\n### Logging and Monitoring\\n\\n| Component | Monitoring Strategy | Alert Threshold |\\n|-----------|-------------------|-----------------|\\n| **PID File** | Check existence and process liveness | Missing or stale PID |\\n| **Log File** | Monitor `trader.log` for ERROR/CRITICAL | Any ERROR level messages |\\n| **Redis Connection** | Monitor `RedislHandler` publish success | Connection failures |\\n| **Database Connection** | Monitor Django ORM query latency | Timeouts or slow queries |\\n| **CTP Gateway** | Monitor Redis Pub/Sub message flow | No messages for \\u003e5 minutes |\\n\\n### Log Rotation\\n\\nThe system uses `RotatingFileHandler` with built-in rotation:\\n- **Max Size:** 1 MB per file\\n- **Backups:** 1 (total of 2 files: current + 1 backup)\\n\\nFor long-term log retention, implement external log aggregation:\\n\\n```bash\\n# Example: Daily archive to separate storage\\n0 0 * * * cp /path/to/user_log_dir/trader.log /backup/logs/trader-$(date +\\\\%Y\\\\%m\\\\%d).log\\n```\\n\\n### Security Considerations\\n\\n| Risk | Mitigation |\\n|------|------------|\\n| **Config Credentials** | Ensure `config.ini` has restricted permissions: `chmod 600 config.ini` |\\n| **PID File Write** | Run as dedicated user, not root (despite example paths) |\\n| **Redis Access** | Configure Redis password in `config.ini`, firewall Redis port |\\n| **MySQL Access** | Use dedicated database user with minimal privileges |\\n| **Log Exposure** | Logs may contain sensitive data; restrict access to log directory |\\n\\n### Performance Tuning\\n\\n```mermaid\\ngraph TB\\n    subgraph \\\"Configuration Tuning\\\"\\n        LogLevel[\\\"Reduce log verbosity\\u003cbr/\\u003efile_level: INFO or WARNING\\\"]\\n        RedisPool[\\\"Redis connection pooling\\u003cbr/\\u003eaioredis maxsize\\\"]\\n        MySQLPool[\\\"MySQL connection pooling\\u003cbr/\\u003eDjango CONN_MAX_AGE\\\"]\\n    end\\n    \\n    subgraph \\\"System Resources\\\"\\n        Memory[\\\"Monitor memory usage\\u003cbr/\\u003eTradeStrategy event loop\\\"]\\n        CPU[\\\"Monitor CPU usage\\u003cbr/\\u003eindicator calculations\\\"]\\n        Disk[\\\"Monitor disk I/O\\u003cbr/\\u003elog file writes\\\"]\\n    end\\n    \\n    subgraph \\\"External Dependencies\\\"\\n        RedisPerf[\\\"Redis latency\\u003cbr/\\u003eredis-cli --latency\\\"]\\n        MySQLPerf[\\\"MySQL query performance\\u003cbr/\\u003eslow query log\\\"]\\n        NetworkLatency[\\\"Network latency to exchanges\\u003cbr/\\u003eping/traceroute\\\"]\\n    end\\n    \\n    LogLevel --\\u003e Memory\\n    RedisPool --\\u003e RedisPerf\\n    MySQLPool --\\u003e MySQLPerf\\n```\\n\\n**Sources:** [trader/main.py:35-65]()\\n\\n## Troubleshooting Deployment Issues\\n\\n### Common Issues\\n\\n| Symptom | Likely Cause | Solution |\\n|---------|--------------|----------|\\n| `ImportError: No module named 'talib'` | TA-Lib C library not installed | Install C library before pip packages |\\n| `django.core.exceptions.ImproperlyConfigured` | Dashboard not in `sys.path` | Verify platform-specific path in `main.py` |\\n| `redis.exceptions.ConnectionError` | Redis not running or wrong host/port | Check Redis service, verify `config.ini` settings |\\n| `pymysql.err.OperationalError: (2013, 'Lost connection')` | MySQL timeout too short | Configure wait_timeout/interactive_timeout |\\n| PID file not created | Directory permissions or path doesn't exist | Check `user_cache_dir` exists and is writable |\\n| No logs appearing | Log level too high or directory not writable | Verify `user_log_dir` exists, check log levels |\\n\\n### Debug Mode\\n\\nTo run with verbose debugging:\\n\\n1. Temporarily modify log levels in `main.py`:\\n   ```python\\n   file_handler.setLevel('DEBUG')\\n   console_handler.setLevel('DEBUG')\\n   ```\\n\\n2. Check Django database connectivity:\\n   ```bash\\n   python -c \\\"import os, django; os.environ['DJANGO_SETTINGS_MODULE']='dashboard.settings'; django.setup(); from panel.models import Broker; print(Broker.objects.all())\\\"\\n   ```\\n\\n3. Verify Redis connectivity:\\n   ```bash\\n   redis-cli -h \\u003chost\\u003e -p \\u003cport\\u003e ping\\n   ```\\n\\n**Sources:** [trader/main.py:48-77]()\\n\\n## Deployment Verification\\n\\nAfter deployment, verify the system is operational:\\n\\n```mermaid\\nflowchart LR\\n    Start[\\\"Deployment Complete\\\"] --\\u003e CheckPID[\\\"Verify PID file\\u003cbr/\\u003eexists and valid\\\"]\\n    CheckPID --\\u003e CheckLogs[\\\"Tail trader.log\\u003cbr/\\u003eLook for startup messages\\\"]\\n    CheckLogs --\\u003e CheckDB[\\\"Query database\\u003cbr/\\u003eCheck Broker/Strategy records\\\"]\\n    CheckDB --\\u003e CheckRedis[\\\"Monitor Redis\\u003cbr/\\u003ePub/Sub activity\\\"]\\n    CheckRedis --\\u003e CheckCTP[\\\"Verify CTP connection\\u003cbr/\\u003eMSG:CTP:RSP channels\\\"]\\n    CheckCTP --\\u003e CheckWeChat[\\\"Confirm WeChat\\u003cbr/\\u003enotification delivery\\\"]\\n    CheckWeChat --\\u003e Production[\\\"System Ready for Trading\\\"]\\n```\\n\\n### Verification Commands\\n\\n```bash\\n# 1. Check process is running\\nps aux | grep \\\"trader/main.py\\\"\\n\\n# 2. Verify PID file\\ncat /path/to/user_cache_dir/trader.pid\\n\\n# 3. Monitor startup logs\\ntail -f /path/to/user_log_dir/trader.log\\n\\n# 4. Check Redis connectivity\\nredis-cli -h \\u003chost\\u003e -p \\u003cport\\u003e SUBSCRIBE \\\"MSG:CTP:RSP:*\\\"\\n\\n# 5. Verify database connectivity\\npython manage.py shell -c \\\"from panel.models import Broker; print(Broker.objects.first())\\\"\\n\\n# 6. Monitor system resources\\ntop -p $(cat /path/to/trader.pid)\\n```\\n\\n**Sources:** [trader/main.py:48-77]()\\n\\n---\\n\\nThis deployment guide ensures reliable production operation of the trader system with proper monitoring, logging, and process management. For system configuration details, see [Configuration](#2.2). For operational monitoring and troubleshooting, see [Logging and Monitoring](#8.4) and [Troubleshooting](#11).\"])</script><script>self.__next_f.push([1,\"3b:T4227,\"])</script><script>self.__next_f.push([1,\"# API Reference\\n\\n\\u003cdetails\\u003e\\n\\u003csummary\\u003eRelevant source files\\u003c/summary\\u003e\\n\\nThe following files were used as context for generating this wiki page:\\n\\n- [panel/models.py](panel/models.py)\\n- [trader/strategy/__init__.py](trader/strategy/__init__.py)\\n- [trader/strategy/brother2.py](trader/strategy/brother2.py)\\n- [trader/utils/__init__.py](trader/utils/__init__.py)\\n\\n\\u003c/details\\u003e\\n\\n\\n\\n## Purpose and Scope\\n\\nThis section provides a complete reference for all major classes, functions, and data structures in the trader system. The API is organized into four major categories:\\n\\n1. **Trading Strategy API** - Core trading logic, signal processing, and order execution ([10.1](#10.1))\\n2. **Framework API** - Base classes for Redis integration, scheduling, and callbacks ([10.2](#10.2))\\n3. **Data Utilities API** - Exchange data fetching, technical analysis, and main contract calculation ([10.3](#10.3))\\n4. **Django Models API** - Database models for brokers, instruments, signals, orders, and trades ([10.4](#10.4))\\n\\nFor configuration options and constants, see [Configuration Reference](#7). For development patterns and best practices, see [Development Guide](#8).\\n\\n**Sources:** [trader/strategy/brother2.py:1-1100](), [trader/utils/__init__.py:1-797](), [panel/models.py:1-289](), [trader/strategy/__init__.py:1-140]()\\n\\n---\\n\\n## API Module Structure\\n\\nThe following diagram shows the physical organization of the API across Python modules and packages:\\n\\n```mermaid\\ngraph TB\\n    subgraph \\\"trader.strategy\\\"\\n        Brother2[\\\"brother2.py\\u003cbr/\\u003eTradeStrategy class\\\"]\\n        StrategyInit[\\\"__init__.py\\u003cbr/\\u003eBaseModule class\\\"]\\n    end\\n    \\n    subgraph \\\"trader.utils\\\"\\n        UtilsInit[\\\"__init__.py\\u003cbr/\\u003eData acquisition \\u0026 analysis\\\"]\\n        ReadConfig[\\\"read_config.py\\u003cbr/\\u003econfig, ctp_errors\\\"]\\n        FuncContainer[\\\"func_container.py\\u003cbr/\\u003eCallbackFunctionContainer\\u003cbr/\\u003eRegisterCallback decorator\\\"]\\n        FetchData[\\\"fetch_data.py\\u003cbr/\\u003eDaily data orchestration\\\"]\\n        MyLogger[\\\"my_logger.py\\u003cbr/\\u003eLogging utilities\\\"]\\n    end\\n    \\n    subgraph \\\"panel\\\"\\n        Models[\\\"models.py\\u003cbr/\\u003eDjango ORM models\\\"]\\n        Const[\\\"const.py\\u003cbr/\\u003eEnumerations \\u0026 constants\\\"]\\n    end\\n    \\n    Brother2 --\\u003e StrategyInit\\n    Brother2 --\\u003e UtilsInit\\n    Brother2 --\\u003e Models\\n    Brother2 --\\u003e Const\\n    Brother2 --\\u003e ReadConfig\\n    \\n    StrategyInit --\\u003e FuncContainer\\n    StrategyInit --\\u003e ReadConfig\\n    \\n    UtilsInit --\\u003e Models\\n    UtilsInit --\\u003e Const\\n    UtilsInit --\\u003e ReadConfig\\n    \\n    FetchData --\\u003e UtilsInit\\n```\\n\\n**Sources:** [trader/strategy/brother2.py:1-40](), [trader/strategy/__init__.py:1-40](), [trader/utils/__init__.py:1-56](), [panel/models.py:1-23]()\\n\\n---\\n\\n## Core API Classes\\n\\nThe following diagram maps the primary API classes to their file locations and shows their inheritance/composition relationships:\\n\\n```mermaid\\ngraph TB\\n    CallbackFunctionContainer[\\\"CallbackFunctionContainer\\u003cbr/\\u003etrader/utils/func_container.py\\u003cbr/\\u003e@RegisterCallback decorator support\\\"]\\n    \\n    BaseModule[\\\"BaseModule\\u003cbr/\\u003etrader/strategy/__init__.py\\u003cbr/\\u003eAbstract base class\\u003cbr/\\u003eRedis Pub/Sub integration\\u003cbr/\\u003eCron scheduling\\\"]\\n    \\n    TradeStrategy[\\\"TradeStrategy\\u003cbr/\\u003etrader/strategy/brother2.py\\u003cbr/\\u003eTrading logic implementation\\u003cbr/\\u003eSignal processing\\u003cbr/\\u003eOrder management\\\"]\\n    \\n    DjangoModels[\\\"Django Models\\u003cbr/\\u003epanel/models.py\\u003cbr/\\u003e8 core models:\\u003cbr/\\u003eBroker, Strategy, Instrument\\u003cbr/\\u003eSignal, Order, Trade\\u003cbr/\\u003eDailyBar, MainBar, Performance\\\"]\\n    \\n    DataUtils[\\\"Data Utilities\\u003cbr/\\u003etrader/utils/__init__.py\\u003cbr/\\u003eupdate_from_* functions\\u003cbr/\\u003ecalc_main_inst\\u003cbr/\\u003ecalc_history_signal\\\"]\\n    \\n    CallbackFunctionContainer --\\u003e|\\\"inherits\\\"| BaseModule\\n    BaseModule --\\u003e|\\\"inherits\\\"| TradeStrategy\\n    \\n    TradeStrategy --\\u003e|\\\"uses\\\"| DjangoModels\\n    TradeStrategy --\\u003e|\\\"calls\\\"| DataUtils\\n    DataUtils --\\u003e|\\\"persists via\\\"| DjangoModels\\n```\\n\\n**Sources:** [trader/strategy/__init__.py:36-140](), [trader/strategy/brother2.py:38-1100](), [trader/utils/__init__.py:1-797](), [panel/models.py:1-289]()\\n\\n---\\n\\n## Core API Components\\n\\n### Trading Strategy API\\n\\nThe `TradeStrategy` class in [trader/strategy/brother2.py]() provides the main trading engine interface. Key capabilities:\\n\\n| Method Category | Methods | Purpose |\\n|----------------|---------|---------|\\n| **Account Management** | `refresh_account()`, `refresh_position()`, `refresh_instrument()` | Query and update broker account state, positions, and instruments |\\n| **CTP Communication** | `query()`, `SubscribeMarketData()`, `ReqOrderInsert()`, `cancel_order()` | Send requests to CTP API via Redis |\\n| **Callbacks** | `OnRtnTrade()`, `OnRtnOrder()`, `OnRtnDepthMarketData()` | Handle CTP responses asynchronously |\\n| **Signal Processing** | `calc_signal()`, `processing_signal1/2/3()` | Generate and execute trading signals |\\n| **Scheduled Tasks** | `refresh_all()`, `update_equity()`, `collect_quote()`, `calculate()` | Cron-scheduled operations |\\n\\nFor detailed method signatures and usage, see [TradeStrategy API](#10.1).\\n\\n**Sources:** [trader/strategy/brother2.py:38-1100]()\\n\\n### Framework API\\n\\nThe `BaseModule` class in [trader/strategy/__init__.py]() provides infrastructure for Redis-based event-driven systems:\\n\\n| Component | Description |\\n|-----------|-------------|\\n| **CallbackFunctionContainer** | Base class providing `@RegisterCallback` decorator for registering channel subscriptions and cron jobs |\\n| **Redis Integration** | `redis_client` (aioredis), `raw_redis` (redis-py), `sub_client` (PubSub) |\\n| **Cron Scheduling** | `crontab_router` dict with croniter-based scheduling |\\n| **Lifecycle Management** | `install()`, `uninstall()`, `start()`, `stop()`, `run()` |\\n| **Message Routing** | `channel_router` dict, `_msg_reader()` coroutine |\\n\\nFor implementation details, see [BaseModule API](#10.2).\\n\\n**Sources:** [trader/strategy/__init__.py:36-140]()\\n\\n### Data Utilities API\\n\\nThe [trader/utils/__init__.py]() module provides standalone functions for data acquisition and analysis:\\n\\n| Function | Parameters | Return Type | Purpose |\\n|----------|-----------|-------------|---------|\\n| `update_from_shfe()` | `day: datetime` | `bool` | Fetch daily data from Shanghai Futures Exchange |\\n| `update_from_dce()` | `day: datetime` | `bool` | Fetch daily data from Dalian Commodity Exchange |\\n| `update_from_czce()` | `day: datetime` | `bool` | Fetch daily data from Zhengzhou Commodity Exchange |\\n| `update_from_cffex()` | `day: datetime` | `bool` | Fetch daily data from China Financial Futures Exchange |\\n| `update_from_gfex()` | `day: datetime` | `bool` | Fetch daily data from Guangzhou Futures Exchange |\\n| `calc_main_inst()` | `inst: Instrument, day: datetime` | `(str, bool)` | Calculate main contract and handle rollover |\\n| `calc_history_signal()` | `inst, day, strategy` | `None` | Generate historical trading signals for backtesting |\\n| `get_contracts_argument()` | `day: datetime` | `bool` | Fetch limit ratios from all exchanges |\\n| `price_round()` | `x: Decimal, base: Decimal` | `Decimal` | Round price to instrument tick size |\\n| `is_trading_day()` | `day: datetime` | `(datetime, bool)` | Check if date is a trading day |\\n\\nFor complete function signatures and examples, see [Data Utilities API](#10.3).\\n\\n**Sources:** [trader/utils/__init__.py:58-797]()\\n\\n### Data Models API\\n\\nThe [panel/models.py]() module defines 9 Django ORM models representing the system's data schema:\\n\\n| Model | Key Fields | Purpose |\\n|-------|------------|---------|\\n| `Broker` | `name`, `cash`, `current`, `margin` | Trading account credentials and balances |\\n| `Strategy` | `name`, `instruments`, `broker` | Trading strategy configuration |\\n| `Instrument` | `product_code`, `main_code`, `exchange`, `margin_rate` | Futures instrument metadata |\\n| `Signal` | `type`, `price`, `volume`, `trigger_time`, `processed` | Trading signals generated by strategies |\\n| `Order` | `order_ref`, `status`, `direction`, `offset_flag` | CTP order records |\\n| `Trade` | `open_time`, `close_time`, `profit`, `direction` | Position lifecycle tracking |\\n| `DailyBar` | `code`, `time`, `open`, `high`, `low`, `close` | Individual contract daily OHLC data |\\n| `MainBar` | `product_code`, `time`, `basis` | Continuous main contract series with rollover adjustments |\\n| `Performance` | `day`, `NAV`, `accumulated`, `capital` | Daily equity curve and performance metrics |\\n\\nFor field definitions and relationships, see [Django Models API](#10.4).\\n\\n**Sources:** [panel/models.py:42-289]()\\n\\n---\\n\\n## API Entry Points and Data Flow\\n\\nThe following diagram shows how external callers interact with the API and how data flows between components:\\n\\n```mermaid\\ngraph LR\\n    subgraph \\\"Entry Points\\\"\\n        MainPy[\\\"trader/main.py\\u003cbr/\\u003eInitialize Django\\u003cbr/\\u003eInstantiate TradeStrategy\\\"]\\n        FetchDataPy[\\\"trader/utils/fetch_data.py\\u003cbr/\\u003eCommand-line data fetcher\\\"]\\n    end\\n    \\n    subgraph \\\"Core API\\\"\\n        TradeStrategy[\\\"TradeStrategy.start()\\u003cbr/\\u003eTradeStrategy.run()\\\"]\\n        Query[\\\"TradeStrategy.query()\\u003cbr/\\u003etype: str, **kwargs\\\"]\\n        Insert[\\\"TradeStrategy.ReqOrderInsert()\\u003cbr/\\u003esig: Signal\\\"]\\n        CalcSignal[\\\"TradeStrategy.calc_signal()\\u003cbr/\\u003einst: Instrument, day: datetime\\\"]\\n    end\\n    \\n    subgraph \\\"Utilities API\\\"\\n        UpdateExchange[\\\"update_from_*()\\u003cbr/\\u003eday: datetime  bool\\\"]\\n        CalcMain[\\\"calc_main_inst()\\u003cbr/\\u003einst, day  str, bool\\\"]\\n        CalcHistory[\\\"calc_history_signal()\\u003cbr/\\u003einst, day, strategy  None\\\"]\\n    end\\n    \\n    subgraph \\\"Data API\\\"\\n        ORM[\\\"Django ORM\\u003cbr/\\u003eBroker.objects\\u003cbr/\\u003eSignal.objects\\u003cbr/\\u003eTrade.objects\\\"]\\n        Redis[\\\"Redis Pub/Sub\\u003cbr/\\u003eMSG:CTP:REQ:*\\u003cbr/\\u003eMSG:CTP:RSP:*\\\"]\\n    end\\n    \\n    MainPy --\\u003e TradeStrategy\\n    TradeStrategy --\\u003e Query\\n    TradeStrategy --\\u003e Insert\\n    TradeStrategy --\\u003e CalcSignal\\n    \\n    Query --\\u003e Redis\\n    Insert --\\u003e Redis\\n    \\n    CalcSignal --\\u003e ORM\\n    \\n    FetchDataPy --\\u003e UpdateExchange\\n    UpdateExchange --\\u003e ORM\\n    \\n    TradeStrategy --\\u003e CalcMain\\n    CalcMain --\\u003e ORM\\n    \\n    TradeStrategy --\\u003e CalcHistory\\n    CalcHistory --\\u003e ORM\\n```\\n\\n**Sources:** [trader/main.py:1-50](), [trader/strategy/brother2.py:64-85](), [trader/utils/__init__.py:121-796]()\\n\\n---\\n\\n## Key Data Structures\\n\\nThe following table documents important data structures passed between API components:\\n\\n| Structure | Type | Location | Key Fields |\\n|-----------|------|----------|------------|\\n| `ApiStruct` | Module | [trader/utils/__init__.py:37]() | CTP API constants: `D_Buy`, `D_Sell`, `OF_Open`, `OF_Close`, `OSS_Accepted`, etc. |\\n| `DirectionType` | Enum | [panel/const.py]() | `LONG`, `SHORT` with `values` dict for string mapping |\\n| `SignalType` | Enum | [panel/const.py]() | `BUY`, `SELL`, `BUY_COVER`, `SELL_SHORT`, `ROLL_OPEN`, `ROLL_CLOSE` |\\n| `OrderStatus` | Enum | [panel/const.py]() | `AllTraded`, `PartTradedQueueing`, `Canceled`, etc. |\\n| `ExchangeType` | Enum | [panel/const.py]() | `SHFE`, `DCE`, `CZCE`, `CFFEX`, `GFEX`, `INE` |\\n| `CombOffsetFlag` | Enum | [panel/const.py]() | `Open`, `Close`, `CloseToday`, `CloseYesterday` |\\n| Order dict | dict | Returned by `query('Order')` | `InstrumentID`, `OrderRef`, `Direction`, `LimitPrice`, `VolumeTotalOriginal`, `OrderStatus` |\\n| Trade dict | dict | Callback parameter | `InstrumentID`, `Direction`, `Price`, `Volume`, `OffsetFlag`, `TradeTime` |\\n| Tick dict | dict | `OnRtnDepthMarketData` | `InstrumentID`, `LastPrice`, `Volume`, `UpdateTime` |\\n\\n**Sources:** [panel/const.py:1-200](), [trader/utils/__init__.py:37](), [trader/strategy/brother2.py:374-469]()\\n\\n---\\n\\n## Request/Response Patterns\\n\\nAll CTP communication follows a Redis Pub/Sub request/response pattern:\\n\\n```mermaid\\nsequenceDiagram\\n    participant API as \\\"API Caller\\u003cbr/\\u003e(TradeStrategy method)\\\"\\n    participant Redis as \\\"Redis Pub/Sub\\\"\\n    participant CTP as \\\"CTP Gateway\\u003cbr/\\u003e(separate process)\\\"\\n    \\n    Note over API: Prepare request parameters\\n    API-\\u003e\\u003eAPI: \\\"request_id = get_next_id()\\\"\\n    API-\\u003e\\u003eAPI: \\\"kwargs['RequestID'] = request_id\\\"\\n    \\n    Note over API: Subscribe to response channels\\n    API-\\u003e\\u003eRedis: \\\"psubscribe(MSG:CTP:RSP:*:{request_id})\\\"\\n    \\n    Note over API: Publish request\\n    API-\\u003e\\u003eRedis: \\\"publish(MSG:CTP:REQ:ReqQry*, kwargs)\\\"\\n    \\n    Note over CTP: CTP handler receives request\\n    Redis-\\u003e\\u003eCTP: \\\"Request forwarded\\\"\\n    \\n    Note over CTP: CTP API executes\\n    CTP-\\u003e\\u003eRedis: \\\"publish(MSG:CTP:RSP:OnRspQry*, result)\\\"\\n    \\n    Note over API: Response received\\n    Redis-\\u003e\\u003eAPI: \\\"Pattern-matched message\\\"\\n    API-\\u003e\\u003eAPI: \\\"await asyncio.wait_for(task, timeout)\\\"\\n    \\n    Note over API: Cleanup\\n    API-\\u003e\\u003eRedis: \\\"punsubscribe()\\\"\\n```\\n\\n**Common Request/Response Methods:**\\n\\n| Method | Request Channel | Response Channels | Timeout |\\n|--------|----------------|-------------------|---------|\\n| `query(type, **kwargs)` | `MSG:CTP:REQ:ReqQry{type}` | `MSG:CTP:RSP:OnRspQry{type}:{request_id}`, `MSG:CTP:RSP:OnRspError:{request_id}` | 10s |\\n| `SubscribeMarketData(ids)` | `MSG:CTP:REQ:SubscribeMarketData` | `MSG:CTP:RSP:OnRspSubMarketData:0`, `MSG:CTP:RSP:OnRspError:0` | 10s |\\n| `ReqOrderInsert(sig)` | `MSG:CTP:REQ:ReqOrderInsert` | `MSG:CTP:RSP:OnRtnOrder:{order_ref}`, `MSG:CTP:RSP:OnRtnTrade:{order_ref}` | N/A (async callback) |\\n| `cancel_order(order)` | `MSG:CTP:REQ:ReqOrderAction` | `MSG:CTP:RSP:OnRtnOrder:{order_ref}`, `MSG:CTP:RSP:OnRspOrderAction:0` | 10s |\\n\\n**Sources:** [trader/strategy/brother2.py:220-372](), [trader/utils/read_config.py]()\\n\\n---\\n\\n## Callback Registration Pattern\\n\\nThe `@RegisterCallback` decorator registers functions to be called on Redis channel messages or cron schedules:\\n\\n```mermaid\\ngraph TB\\n    Decorator[\\\"@RegisterCallback\\u003cbr/\\u003edecorator function\\\"]\\n    \\n    FuncContainer[\\\"CallbackFunctionContainer\\u003cbr/\\u003ecallback_fun_args dict\\\"]\\n    \\n    BaseModule[\\\"BaseModule._register_callback()\\u003cbr/\\u003eProcesses annotations\\\"]\\n    \\n    ChannelRouter[\\\"channel_router dict\\u003cbr/\\u003eMaps pattern  function\\\"]\\n    \\n    CrontabRouter[\\\"crontab_router dict\\u003cbr/\\u003eMaps crontab  function + croniter\\\"]\\n    \\n    MsgReader[\\\"BaseModule._msg_reader()\\u003cbr/\\u003eListens to Redis PubSub\\\"]\\n    \\n    CallNext[\\\"BaseModule._call_next()\\u003cbr/\\u003eExecutes cron tasks\\\"]\\n    \\n    Decorator --\\u003e|\\\"stores args\\\"| FuncContainer\\n    FuncContainer --\\u003e|\\\"inherited by\\\"| BaseModule\\n    BaseModule --\\u003e|\\\"populates\\\"| ChannelRouter\\n    BaseModule --\\u003e|\\\"populates\\\"| CrontabRouter\\n    \\n    ChannelRouter --\\u003e|\\\"dispatches to\\\"| MsgReader\\n    CrontabRouter --\\u003e|\\\"schedules\\\"| CallNext\\n```\\n\\n**Example Usage:**\\n\\n```python\\n@RegisterCallback(channel='MSG:CTP:RSP:TRADE:OnRtnTrade:*')\\nasync def OnRtnTrade(self, channel, trade: dict):\\n    # Handle trade confirmation\\n    pass\\n\\n@RegisterCallback(crontab='55 8 * * *')\\nasync def processing_signal1(self):\\n    # Execute at 08:55 daily\\n    pass\\n```\\n\\n**Sources:** [trader/utils/func_container.py](), [trader/strategy/__init__.py:58-93](), [trader/strategy/brother2.py:373-566]()\\n\\n---\\n\\n## API Version and Compatibility\\n\\n| Component | Python Version | Key Dependencies |\\n|-----------|---------------|------------------|\\n| TradeStrategy | 3.10+ | Django 4.x, aioredis 2.x, redis-py 4.x |\\n| BaseModule | 3.10+ | aioredis 2.x, croniter 1.x |\\n| Data Utilities | 3.10+ | aiohttp 3.x, TA-Lib 0.4.x, pandas 1.x |\\n| Django Models | 3.10+ | Django 4.x, MySQL 8.x |\\n\\n**Python 3.10+ Required:** The codebase uses structural pattern matching (`match`/`case` statements) introduced in Python 3.10.\\n\\n**Sources:** [trader/strategy/brother2.py:312-340]()\\n\\n---\\n\\n## Quick Reference: Common Operations\\n\\n| Operation | API Call | Example |\\n|-----------|---------|---------|\\n| Query CTP account | `await strategy.query('TradingAccount')` | Returns list with account dict |\\n| Query positions | `await strategy.query('InvestorPositionDetail')` | Returns list of position dicts |\\n| Query instruments | `await strategy.query('Instrument')` | Returns list of instrument dicts |\\n| Subscribe to market data | `await strategy.SubscribeMarketData(['cu2301', 'au2306'])` | Returns subscription result |\\n| Insert order | `strategy.ReqOrderInsert(signal)` | Fire-and-forget, async callbacks |\\n| Cancel order | `await strategy.cancel_order(order_dict)` | Returns True/False |\\n| Fetch SHFE data | `await update_from_shfe(datetime.now())` | Returns True/False |\\n| Calculate main contract | `calc_main_inst(instrument, datetime.now())` | Returns (main_code, changed) |\\n| Generate historical signals | `calc_history_signal(inst, day, strategy)` | Populates Signal and Trade tables |\\n| Get next request ID | `get_next_id()` | Returns int 1-65535 cycling |\\n| Round price to tick | `price_round(Decimal('1234.56'), Decimal('0.2'))` | Returns Decimal |\\n\\n**Sources:** [trader/strategy/brother2.py:86-372](), [trader/utils/__init__.py:58-796]()\\n\\n---\\n\\nFor detailed documentation of each API component, refer to the following subsections:\\n\\n- [TradeStrategy API](#10.1) - Complete method reference with parameters, return types, and examples\\n- [BaseModule API](#10.2) - Framework internals, lifecycle hooks, and callback system\\n- [Data Utilities API](#10.3) - Exchange data fetchers, technical analysis functions, and helper utilities\\n- [Django Models API](#10.4) - Field definitions, relationships, and query examples for all models\"])</script><script>self.__next_f.push([1,\"3c:T788e,\"])</script><script>self.__next_f.push([1,\"# TradeStrategy API\\n\\n\\u003cdetails\\u003e\\n\\u003csummary\\u003eRelevant source files\\u003c/summary\\u003e\\n\\nThe following files were used as context for generating this wiki page:\\n\\n- [panel/const.py](panel/const.py)\\n- [trader/strategy/brother2.py](trader/strategy/brother2.py)\\n\\n\\u003c/details\\u003e\\n\\n\\n\\n## Purpose and Scope\\n\\nThis document provides a complete API reference for the `TradeStrategy` class, the core trading engine of the system. The `TradeStrategy` class orchestrates all trading operations including account management, order execution, signal processing, and risk management for automated futures trading on Chinese commodity exchanges.\\n\\nFor implementation details and usage patterns, see [Trading Strategy System](#4). For the base framework that `TradeStrategy` extends, see [BaseModule API](#10.2). For signal generation algorithms, see [Signal Generation](#4.3).\\n\\n**Sources:** [trader/strategy/brother2.py:38-871]()\\n\\n---\\n\\n## Class Overview\\n\\n### Inheritance Hierarchy\\n\\n```mermaid\\nclassDiagram\\n    class BaseModule {\\n        \\u003c\\u003cabstract\\u003e\\u003e\\n        +redis_client\\n        +raw_redis\\n        +io_loop\\n        +install()\\n    }\\n    \\n    class TradeStrategy {\\n        -__strategy: Strategy\\n        -__broker: Broker\\n        -__inst_ids: list\\n        -__shares: dict\\n        -__cur_pos: dict\\n        -__activeOrders: dict\\n        +start()\\n        +refresh_account()\\n        +refresh_position()\\n        +refresh_instrument()\\n        +query()\\n        +ReqOrderInsert()\\n        +cancel_order()\\n        +calc_signal()\\n        +calculate()\\n    }\\n    \\n    BaseModule \\u003c|-- TradeStrategy\\n    \\n    note for TradeStrategy \\\"Importance: 227.43\\\\nLocation: trader/strategy/brother2.py\\\"\\n```\\n\\n**Sources:** [trader/strategy/brother2.py:38-62]()\\n\\n### Constructor\\n\\n#### `__init__(self, name: str)`\\n\\nInitializes the trading strategy instance with the specified strategy name.\\n\\n**Parameters:**\\n- `name` (str): Strategy name that must exist in the `Strategy` model\\n\\n**Internal State Initialized:**\\n| Attribute | Type | Description |\\n|-----------|------|-------------|\\n| `__strategy` | `Strategy` | Strategy model instance from database |\\n| `__broker` | `Broker` | Associated broker account |\\n| `__inst_ids` | `list` | Product codes monitored by this strategy |\\n| `__fake` | `Decimal` | Virtual capital amount |\\n| `__current` | `Decimal` | Current dynamic equity |\\n| `__pre_balance` | `Decimal` | Static equity (previous settlement) |\\n| `__cash` | `Decimal` | Available cash |\\n| `__margin` | `Decimal` | Used margin |\\n| `__shares` | `dict` | Position dictionary: {instrument: position} |\\n| `__cur_pos` | `dict` | Current positions from CTP API |\\n| `__activeOrders` | `dict` | Unfilled orders |\\n| `__trading_day` | `datetime` | Current trading day |\\n| `__last_trading_day` | `datetime` | Previous trading day |\\n\\n**Redis Channel Formats:**\\n- `__market_response_format`: Pattern for market data responses\\n- `__trade_response_format`: Pattern for trade responses\\n- `__request_format`: Pattern for CTP requests\\n\\n**Sources:** [trader/strategy/brother2.py:39-62]()\\n\\n---\\n\\n## Lifecycle Methods\\n\\n### `async start(self)`\\n\\nInitializes the trading strategy, performs system checks, and synchronizes state with CTP API.\\n\\n**Workflow:**\\n1. Installs callback handlers via `install()`\\n2. Sets heartbeat in Redis with 61-second expiration\\n3. Checks if current time is within trading hours\\n4. Refreshes account balance and margin information\\n5. Queries all orders from CTP API\\n6. Cancels unfilled orders\\n7. Saves filled orders to database\\n8. Refreshes position information\\n\\n**Execution Conditions:**\\n- Only runs during trading hours: weekdays 08:20-15:50 or 20:10-23:59\\n- Skips execution on weekends (isoweekday \\u003e= 6)\\n\\n```mermaid\\nflowchart TD\\n    Start[\\\"start()\\\"] --\\u003e Install[\\\"install()\\u003cbr/\\u003eRegister callbacks\\\"]\\n    Install --\\u003e Heartbeat[\\\"Set HEARTBEAT:TRADER\\u003cbr/\\u003ein Redis (61s TTL)\\\"]\\n    Heartbeat --\\u003e CheckTime{\\\"Within trading\\u003cbr/\\u003ehours?\\\"}\\n    CheckTime --\\u003e|Yes| RefreshAcct[\\\"refresh_account()\\\"]\\n    CheckTime --\\u003e|No| End[\\\"End\\\"]\\n    RefreshAcct --\\u003e QueryOrders[\\\"query('Order')\\\"]\\n    QueryOrders --\\u003e ProcessOrders{\\\"For each order\\\"}\\n    ProcessOrders --\\u003e|Unfilled| CancelOrder[\\\"cancel_order()\\\"]\\n    ProcessOrders --\\u003e|Filled| SaveOrder[\\\"save_order()\\\"]\\n    CancelOrder --\\u003e RefreshPos[\\\"refresh_position()\\\"]\\n    SaveOrder --\\u003e RefreshPos\\n    RefreshPos --\\u003e End\\n```\\n\\n**Sources:** [trader/strategy/brother2.py:64-84]()\\n\\n---\\n\\n## Account \\u0026 Position Management\\n\\n### `async refresh_account(self)`\\n\\nQueries and updates broker account information from CTP API.\\n\\n**Updates:**\\n- Withdrawal amount (`__withdraw`)\\n- Deposit amount (`__deposit`)\\n- Pre-balance (static equity)\\n- Current equity (dynamic equity)\\n- Margin usage\\n- Available cash\\n- Virtual capital adjustment\\n\\n**Formula:**\\n```\\nfake = __fake - __deposit + __withdraw\\npre_balance = PreBalance + __deposit - __withdraw\\ncurrent = pre_balance + CloseProfit + PositionProfit - Commission\\n```\\n\\n**Database Updates:**\\nUpdates `Broker` model fields: `cash`, `current`, `pre_balance`, `margin`\\n\\n**Sources:** [trader/strategy/brother2.py:86-112]()\\n\\n---\\n\\n### `async refresh_position(self)`\\n\\nSynchronizes position information from CTP API to local database.\\n\\n**Process:**\\n1. Queries `InvestorPositionDetail` from CTP\\n2. Aggregates positions by instrument code\\n3. Deletes non-existent positions from `Trade` model\\n4. Creates or updates `Trade` records with:\\n   - Position volume\\n   - Average entry price\\n   - Profit/loss calculation\\n   - Frozen margin\\n   - Direction (long/short)\\n\\n**Position Aggregation:**\\nWhen multiple position details exist for same instrument, combines them by:\\n- Weighted average entry price\\n- Sum of volumes\\n- Sum of profits and margins\\n\\n**Sources:** [trader/strategy/brother2.py:114-154]()\\n\\n---\\n\\n### `async refresh_instrument(self)`\\n\\nUpdates instrument contract information from CTP API.\\n\\n**Process:**\\n1. Queries all tradable futures contracts\\n2. Filters by:\\n   - `IsTrading == 1`\\n   - `ProductClass == 'Futures'`\\n   - Not in ignore list (configured)\\n   - `LongMarginRatio \\u003c= 1`\\n3. Updates `Instrument` model with:\\n   - Contract names and multipliers\\n   - Price tick size\\n   - Margin rates (for main contracts)\\n   - Commission fees (for main contracts)\\n\\n**Margin and Fee Updates:**\\nFor instruments with `main_code` set:\\n- Queries `InstrumentMarginRate` \\n- Queries `InstrumentCommissionRate`\\n- Updates `margin_rate`, `fee_money`, `fee_volume`\\n\\n**Sources:** [trader/strategy/brother2.py:156-205]()\\n\\n---\\n\\n## Query Operations\\n\\n### `async query(self, query_type: str, **kwargs) -\\u003e list`\\n\\nGeneric asynchronous query method for CTP API requests with timeout handling.\\n\\n**Parameters:**\\n- `query_type` (str): Type of query (e.g., 'TradingAccount', 'InvestorPositionDetail', 'Instrument')\\n- `**kwargs`: Additional parameters passed to CTP API\\n\\n**Returns:**\\n- `list`: Query results as list of dictionaries\\n- `None`: On error or timeout\\n\\n**Mechanism:**\\n1. Creates Redis pub/sub client\\n2. Generates unique request ID\\n3. Subscribes to response channels:\\n   - `OnRspQry{query_type}:{request_id}`\\n   - `OnRspError:{request_id}`\\n4. Publishes request to `ReqQry{query_type}` channel\\n5. Waits for response with timeout (default: 10 seconds)\\n6. Aggregates multi-part responses (when `bIsLast == true`)\\n\\n```mermaid\\nsequenceDiagram\\n    participant TS as TradeStrategy\\n    participant RS as Redis Pub/Sub\\n    participant CTP as CTP Gateway\\n    \\n    TS-\\u003e\\u003eRS: Subscribe to response channels\\u003cbr/\\u003e(OnRspQry*, OnRspError)\\n    TS-\\u003e\\u003eRS: Publish request with RequestID\\n    RS-\\u003e\\u003eCTP: Forward query request\\n    \\n    loop Until bIsLast=true\\n        CTP-\\u003e\\u003eRS: Publish response data\\n        RS-\\u003e\\u003eTS: Deliver response message\\n        TS-\\u003e\\u003eTS: Accumulate results\\n    end\\n    \\n    TS-\\u003e\\u003eRS: Unsubscribe \\u0026 close\\n    TS-\\u003e\\u003eTS: Return aggregated results\\n```\\n\\n**Timeout Handling:**\\nConfigured via `HANDLER_TIME_OUT` (default: 10 seconds from config.ini)\\n\\n**Sources:** [trader/strategy/brother2.py:236-257]()\\n\\n---\\n\\n### `void async_query(self, query_type: str, **kwargs)`\\n\\nNon-blocking query method that publishes request without waiting for response.\\n\\n**Use Case:**\\nFire-and-forget queries where response is not needed immediately.\\n\\n**Sources:** [trader/strategy/brother2.py:220-223]()\\n\\n---\\n\\n### `async query_reader(pb: aioredis.client.PubSub) -\\u003e list`\\n\\nStatic coroutine that reads multi-part query responses from Redis pub/sub.\\n\\n**Logic:**\\n- Accumulates non-empty messages\\n- Continues until `bIsLast` field is true\\n- Returns complete message list\\n\\n**Sources:** [trader/strategy/brother2.py:225-234]()\\n\\n---\\n\\n## Market Data Subscription\\n\\n### `async SubscribeMarketData(self, inst_ids: list) -\\u003e list`\\n\\nSubscribes to real-time market data for specified instruments.\\n\\n**Parameters:**\\n- `inst_ids` (list): List of instrument codes to subscribe\\n\\n**Process:**\\n1. Subscribes to `OnRspSubMarketData` response channel\\n2. Publishes subscription request\\n3. Waits for confirmation with timeout\\n4. Returns subscription results\\n\\n**Sources:** [trader/strategy/brother2.py:259-278]()\\n\\n---\\n\\n### `async UnSubscribeMarketData(self, inst_ids: list) -\\u003e list`\\n\\nUnsubscribes from real-time market data for specified instruments.\\n\\n**Parameters:**\\n- `inst_ids` (list): List of instrument codes to unsubscribe\\n\\n**Sources:** [trader/strategy/brother2.py:280-299]()\\n\\n---\\n\\n## Order Execution\\n\\n### `void ReqOrderInsert(self, sig: Signal)`\\n\\nSubmits an order to CTP API based on a trading signal.\\n\\n**Parameters:**\\n- `sig` (Signal): Signal model instance containing order details\\n\\n**Order Parameters Generated:**\\n\\n| Parameter | Source | Description |\\n|-----------|--------|-------------|\\n| `RequestID` | Generated | Unique request identifier |\\n| `OrderRef` | Generated | `{autoid:07}{signal.id:05}` format |\\n| `InstrumentID` | `sig.code` | Contract code |\\n| `VolumeTotalOriginal` | `sig.volume` | Order quantity |\\n| `LimitPrice` | `sig.price` | Limit price |\\n| `Direction` | Based on signal type | Buy/Sell |\\n| `CombOffsetFlag` | Based on signal type | Open/Close/CloseToday |\\n\\n**Signal Type Handling:**\\n\\n```mermaid\\nflowchart TD\\n    Signal[\\\"Signal Type\\\"] --\\u003e BuyType{\\\"Type?\\\"}\\n    BuyType --\\u003e|BUY| OpenLong[\\\"Direction: Buy\\u003cbr/\\u003eOffset: Open\\\"]\\n    BuyType --\\u003e|SELL_SHORT| OpenShort[\\\"Direction: Sell\\u003cbr/\\u003eOffset: Open\\\"]\\n    BuyType --\\u003e|SELL| CloseLong[\\\"Direction: Sell\\u003cbr/\\u003eOffset: Close\\\"]\\n    BuyType --\\u003e|BUY_COVER| CloseShort[\\\"Direction: Buy\\u003cbr/\\u003eOffset: Close\\\"]\\n    BuyType --\\u003e|ROLL_CLOSE| RollClose[\\\"Query existing position\\u003cbr/\\u003eSet opposite direction\\u003cbr/\\u003eOffset: Close or CloseToday\\\"]\\n    BuyType --\\u003e|ROLL_OPEN| RollOpen[\\\"Match rollover position\\u003cbr/\\u003eSame direction\\u003cbr/\\u003eOffset: Open\\\"]\\n    \\n    CloseLong --\\u003e CheckSHFE{\\\"SHFE \\u0026\\u003cbr/\\u003esame day?\\\"}\\n    CloseShort --\\u003e CheckSHFE\\n    RollClose --\\u003e CheckSHFE\\n    CheckSHFE --\\u003e|Yes| CloseToday[\\\"CombOffsetFlag:\\u003cbr/\\u003eCloseToday\\\"]\\n    CheckSHFE --\\u003e|No| CloseNormal[\\\"CombOffsetFlag:\\u003cbr/\\u003eClose\\\"]\\n```\\n\\n**SHFE Special Handling:**\\nFor Shanghai Futures Exchange, distinguishes between:\\n- **CloseToday**: Closing positions opened today\\n- **Close**: Closing positions from previous days\\n\\n**Sources:** [trader/strategy/brother2.py:301-343]()\\n\\n---\\n\\n### `async cancel_order(self, order: dict) -\\u003e bool`\\n\\nCancels an existing order through CTP API.\\n\\n**Parameters:**\\n- `order` (dict): Order dictionary with `OrderRef` and other CTP fields\\n\\n**Returns:**\\n- `bool`: `True` if cancellation successful, `False` otherwise\\n\\n**Process:**\\n1. Subscribes to channels:\\n   - `OnRtnOrder:{OrderRef}` - Order status update\\n   - `OnRspOrderAction` - Cancellation response\\n   - `OnRspError:{RequestID}` - Error response\\n2. Publishes cancellation request to `ReqOrderAction` channel\\n3. Waits for confirmation\\n4. Checks for error codes in response\\n\\n**Sources:** [trader/strategy/brother2.py:345-371]()\\n\\n---\\n\\n## Callback Handlers\\n\\n### `@RegisterCallback(channel='MSG:CTP:RSP:MARKET:OnRtnDepthMarketData:*')`\\n### `async OnRtnDepthMarketData(self, channel, tick: dict)`\\n\\nHandles real-time market data tick updates.\\n\\n**Parameters:**\\n- `channel` (str): Redis channel name (contains instrument code)\\n- `tick` (dict): Market data dictionary with fields:\\n  - `UpdateTime`: Tick timestamp\\n  - Price fields (last, bid, ask)\\n  - Volume and open interest\\n\\n**Processing:**\\n- Extracts instrument code from channel name\\n- Parses update time to datetime\\n- Logs tick data at debug level\\n\\n**Sources:** [trader/strategy/brother2.py:373-380]()\\n\\n---\\n\\n### `@RegisterCallback(channel='MSG:CTP:RSP:TRADE:OnRtnTrade:*')`\\n### `async OnRtnTrade(self, channel, trade: dict)`\\n\\nProcesses trade execution confirmations from CTP API.\\n\\n**Parameters:**\\n- `channel` (str): Channel name containing `OrderRef`\\n- `trade` (dict): Trade details from CTP\\n\\n**Complex Processing Logic:**\\n\\n```mermaid\\nflowchart TD\\n    Start[\\\"OnRtnTrade\\\"] --\\u003e ExtractRef[\\\"Extract OrderRef\\u003cbr/\\u003efrom channel\\\"]\\n    ExtractRef --\\u003e CheckManual{\\\"OrderRef \\u003c 10000?\\\"}\\n    CheckManual --\\u003e|Yes| ManualTrade[\\\"Manual trade\\\"]\\n    CheckManual --\\u003e|No| LoadSignal[\\\"Load Signal by ID\\\"]\\n    \\n    ManualTrade --\\u003e CheckOffset{\\\"Offset Flag?\\\"}\\n    LoadSignal --\\u003e CheckOffset\\n    \\n    CheckOffset --\\u003e|Open| OpenPos[\\\"Process Open Position\\\"]\\n    CheckOffset --\\u003e|Close| ClosePos[\\\"Process Close Position\\\"]\\n    \\n    OpenPos --\\u003e FindTrade{\\\"Existing Trade\\u003cbr/\\u003erecord?\\\"}\\n    FindTrade --\\u003e|No| CreateTrade[\\\"Create new Trade\\u003cbr/\\u003ewith initial volume\\\"]\\n    FindTrade --\\u003e|Yes| UpdateTrade[\\\"Update avg_entry_price\\u003cbr/\\u003efilled_shares\\u003cbr/\\u003ecost, margin\\\"]\\n    \\n    ClosePos --\\u003e FindOpenTrade[\\\"Find open Trade\\u003cbr/\\u003eopposite direction\\\"]\\n    FindOpenTrade --\\u003e UpdateClose[\\\"Update avg_exit_price\\u003cbr/\\u003eclosed_shares\\\"]\\n    UpdateClose --\\u003e CheckComplete{\\\"All shares\\u003cbr/\\u003eclosed?\\\"}\\n    CheckComplete --\\u003e|Yes| CalcProfit[\\\"Calculate profit\\u003cbr/\\u003eSet close_time\\\"]\\n    CheckComplete --\\u003e|No| PartialClose[\\\"Update partial close\\\"]\\n    \\n    CreateTrade --\\u003e CheckSignal{\\\"Signal\\u003cbr/\\u003eexists?\\\"}\\n    UpdateTrade --\\u003e CheckSignal\\n    CalcProfit --\\u003e CheckSignal\\n    PartialClose --\\u003e CheckSignal\\n    \\n    CheckSignal --\\u003e|Yes \\u0026 Complete| MarkProcessed[\\\"signal.processed = True\\\"]\\n    CheckSignal --\\u003e|No| End[\\\"End\\\"]\\n    MarkProcessed --\\u003e End\\n```\\n\\n**Trade Cost Calculation:**\\n```\\ntrade_cost = volume  price  fee_money  volume_multiple + volume  fee_volume\\ntrade_margin = volume  price  margin_rate\\n```\\n\\n**Profit Calculation (when closing):**\\n```python\\n# For long positions\\nprofit_point = avg_exit_price - avg_entry_price\\n# For short positions  \\nprofit_point = avg_entry_price - avg_exit_price\\n\\nprofit = profit_point  shares  volume_multiple\\n```\\n\\n**Sources:** [trader/strategy/brother2.py:391-469]()\\n\\n---\\n\\n### `@RegisterCallback(channel='MSG:CTP:RSP:TRADE:OnRtnOrder:*')`\\n### `async OnRtnOrder(self, _, order: dict)`\\n\\nHandles order status updates and rejected order resubmission.\\n\\n**Key Features:**\\n1. Saves order to database via `save_order()`\\n2. Detects orders rejected due to price limit violations\\n3. Automatically adjusts price and resubmits order\\n\\n**Rejection Handling Logic:**\\n\\nWhen `OrderStatus == Canceled` and `OrderSubmitStatus == InsertRejected`:\\n\\n```mermaid\\nflowchart TD\\n    Reject[\\\"Order Rejected\\\"] --\\u003e GetBar[\\\"Get last DailyBar\\\"]\\n    GetBar --\\u003e CalcDelta[\\\"Calculate delta:\\u003cbr/\\u003e50% toward settlement\\\"]\\n    CalcDelta --\\u003e CheckDelta{\\\"delta / settlement\\u003cbr/\\u003e\\u003c 0.01?\\\"}\\n    CheckDelta --\\u003e|Yes| Abandon[\\\"Log warning\\u003cbr/\\u003eAbandon order\\\"]\\n    CheckDelta --\\u003e|No| NewPrice[\\\"Adjust price by delta\\\"]\\n    NewPrice --\\u003e Resubmit[\\\"ReqOrderInsert with\\u003cbr/\\u003enew price\\\"]\\n```\\n\\n**Price Adjustment Formula:**\\n- **For buy orders:** `new_price = settlement + delta  0.5`\\n- **For sell orders:** `new_price = settlement - delta  0.5`\\n\\nWhere `delta = abs(limit_price - settlement)`\\n\\n**Sources:** [trader/strategy/brother2.py:510-566]()\\n\\n---\\n\\n## Scheduled Task Callbacks\\n\\n### `@RegisterCallback(crontab='*/1 * * * *')`\\n### `async heartbeat(self)`\\n\\nUpdates heartbeat indicator in Redis every minute.\\n\\n**Purpose:** Monitoring system health\\n\\n**Redis Key:** `HEARTBEAT:TRADER` with 301-second TTL\\n\\n**Sources:** [trader/strategy/brother2.py:568-570]()\\n\\n---\\n\\n### `@RegisterCallback(crontab='55 8 * * *')`\\n### `async processing_signal1(self)`\\n\\nProcesses day session signals for commodities (excluding CFFEX).\\n\\n**Execution Time:** 08:55 (5 minutes before day session starts at 09:00)\\n\\n**Signal Filter:**\\n- Instruments: Not CFFEX exchange\\n- Night trade: `False`\\n- Trigger time: \\u003e= last trading day\\n- Processed: `False`\\n- Order by: Priority (descending)\\n\\n**Special Logic:**\\nAfter long holidays (\\u003e 3 days gap), also processes unprocessed night signals.\\n\\n**Sources:** [trader/strategy/brother2.py:572-585]()\\n\\n---\\n\\n### `@RegisterCallback(crontab='1 9 * * *')`\\n### `async check_signal1_processed(self)`\\n\\nChecks for missed day session signals at 09:01.\\n\\n**Purpose:** Safety net to catch signals that failed to process at 08:55\\n\\n**Sources:** [trader/strategy/brother2.py:587-596]()\\n\\n---\\n\\n### `@RegisterCallback(crontab='25 9 * * *')`\\n### `async processing_signal2(self)`\\n\\nProcesses signals for stock index futures (CFFEX).\\n\\n**Execution Time:** 09:25 (after market opening at 09:15)\\n\\n**Signal Filter:**\\n- Instruments: CFFEX exchange only (IF, IC, IH, T, TF, TS)\\n- Night trade: `False`\\n\\n**Sources:** [trader/strategy/brother2.py:598-608]()\\n\\n---\\n\\n### `@RegisterCallback(crontab='31 9 * * *')`\\n### `async check_signal2_processed(self)`\\n\\nChecks for missed CFFEX signals at 09:31.\\n\\n**Sources:** [trader/strategy/brother2.py:610-619]()\\n\\n---\\n\\n### `@RegisterCallback(crontab='55 20 * * *')`\\n### `async processing_signal3(self)`\\n\\nProcesses night session signals.\\n\\n**Execution Time:** 20:55 (5 minutes before night session starts at 21:00)\\n\\n**Signal Filter:**\\n- Night trade: `True`\\n- Trigger time: \\u003e= last trading day\\n- Processed: `False`\\n\\n**Sources:** [trader/strategy/brother2.py:621-631]()\\n\\n---\\n\\n### `@RegisterCallback(crontab='1 21 * * *')`\\n### `async check_signal3_processed(self)`\\n\\nChecks for missed night session signals at 21:01.\\n\\n**Sources:** [trader/strategy/brother2.py:633-642]()\\n\\n---\\n\\n### `@RegisterCallback(crontab='20 15 * * *')`\\n### `async refresh_all(self)`\\n\\nComprehensive system state refresh after market close.\\n\\n**Execution Time:** 15:20 (after day session closes at 15:00)\\n\\n**Operations:**\\n1. Checks if today is trading day\\n2. Calls `refresh_account()`\\n3. Calls `refresh_position()`\\n4. Calls `refresh_instrument()`\\n\\n**Sources:** [trader/strategy/brother2.py:644-654]()\\n\\n---\\n\\n### `@RegisterCallback(crontab='30 15 * * *')`\\n### `async update_equity(self)`\\n\\nCalculates and updates daily performance metrics.\\n\\n**Execution Time:** 15:30\\n\\n**Calculations:**\\n\\n| Metric | Formula |\\n|--------|---------|\\n| Dividend | Sum of historical dividends + deposit - withdraw |\\n| Fake (adjusted) | `__fake - __deposit + __withdraw` |\\n| Unit count | `dividend + __fake` |\\n| NAV | `(__current + __fake) / unit_count` |\\n| Accumulated NAV | `__current / (unit_count - __fake)` |\\n\\n**Database Update:**\\nCreates or updates `Performance` record with:\\n- `used_margin`: Current margin usage\\n- `dividend`: Net deposit/withdrawal\\n- `capital`: Current equity\\n- `unit_count`: Total units\\n- `NAV`: Net asset value per unit\\n- `accumulated`: Accumulated net asset value\\n\\n**Sources:** [trader/strategy/brother2.py:656-682]()\\n\\n---\\n\\n### `@RegisterCallback(crontab='0 17 * * *')`\\n### `async collect_quote(self, tasks=None)`\\n\\nFetches daily market data from all exchanges and triggers signal calculation.\\n\\n**Execution Time:** 17:00 (post-market data publication)\\n\\n**Default Tasks:**\\n- `update_from_shfe`: Shanghai Futures Exchange\\n- `update_from_dce`: Dalian Commodity Exchange\\n- `update_from_czce`: Zhengzhou Commodity Exchange\\n- `update_from_cffex`: China Financial Futures Exchange\\n- `update_from_gfex`: Guangzhou Futures Exchange\\n- `get_contracts_argument`: Contract specifications\\n\\n**Workflow:**\\n1. Executes all tasks concurrently using `asyncio.gather()`\\n2. If all succeed: Calls `calculate()` immediately\\n3. If any fail: Retries failed tasks after 10-minute delay\\n\\n**Sources:** [trader/strategy/brother2.py:684-703]()\\n\\n---\\n\\n## Signal Calculation Methods\\n\\n### `void calculate(self, day, create_main_bar=True)`\\n\\nMain calculation orchestrator that processes all instruments.\\n\\n**Parameters:**\\n- `day` (datetime): Target calculation date\\n- `create_main_bar` (bool): Whether to generate main contract bars\\n\\n**Process:**\\n1. Collects product codes from strategy instruments and current positions\\n2. Iterates through all instruments in database\\n3. For each instrument:\\n   - Generates main contract bar via `calc_main_inst()` (if enabled)\\n   - Calculates trading signals via `calc_signal()`\\n   - Accumulates margin requirements\\n4. Risk check: Warns if total margin usage exceeds 80% of equity\\n\\n**Risk Formula:**\\n```python\\nrisk_ratio = (all_margin + __margin) / __current\\nif risk_ratio \\u003e 0.8:\\n    # Log warning\\n```\\n\\n**Sources:** [trader/strategy/brother2.py:705-723]()\\n\\n---\\n\\n### `calc_signal(self, inst: Instrument, day: datetime) -\\u003e (Signal, Decimal)`\\n\\nGenerates trading signals based on technical analysis and current positions.\\n\\n**Parameters:**\\n- `inst` (Instrument): Target instrument\\n- `day` (datetime): Calculation date\\n\\n**Returns:**\\n- Tuple: `(Signal, Decimal)` - Created/updated signal and estimated margin\\n\\n**Strategy Parameters (from database):**\\n\\n| Parameter | Code | Type | Description |\\n|-----------|------|------|-------------|\\n| Break Period | `BreakPeriod` | int | Breakout detection window |\\n| ATR Period | `AtrPeriod` | int | ATR calculation period |\\n| Long Period | `LongPeriod` | int | Long-term SMA period |\\n| Short Period | `ShortPeriod` | int | Short-term SMA period |\\n| Stop Loss | `StopLoss` | int | Stop loss ATR multiplier |\\n| Risk | `Risk` | float | Risk per trade ratio |\\n\\n**Technical Indicators Calculated:**\\n\\n```python\\ndf[\\\"atr\\\"] = ATR(df.high, df.low, df.close, timeperiod=atr_n)\\ndf[\\\"short_trend\\\"] = SMA(df.close, short_n)  # Manual calculation\\ndf[\\\"long_trend\\\"] = SMA(df.close, long_n)    # Manual calculation\\ndf[\\\"high_line\\\"] = df.close.rolling(window=break_n).max()\\ndf[\\\"low_line\\\"] = df.close.rolling(window=break_n).min()\\n```\\n\\n**Signal Generation Logic:**\\n\\n```mermaid\\nflowchart TD\\n    Start[\\\"calc_signal()\\\"] --\\u003e LoadData[\\\"Load last 400 MainBars\\u003cbr/\\u003eCalculate indicators\\\"]\\n    LoadData --\\u003e CheckPos{\\\"Existing\\u003cbr/\\u003eposition?\\\"}\\n    \\n    CheckPos --\\u003e|Yes| CheckDir{\\\"Position\\u003cbr/\\u003edirection?\\\"}\\n    CheckPos --\\u003e|No| CheckEntry{\\\"Entry signal?\\\"}\\n    \\n    CheckDir --\\u003e|Long| LongPos[\\\"Check long position\\\"]\\n    CheckDir --\\u003e|Short| ShortPos[\\\"Check short position\\\"]\\n    \\n    LongPos --\\u003e LongStop{\\\"close \\u003c= high_max\\u003cbr/\\u003e- ATR  stop_n?\\\"}\\n    LongStop --\\u003e|Yes| GenSell[\\\"Generate SELL signal\\u003cbr/\\u003ePriority: High\\\"]\\n    LongStop --\\u003e|No| LongRoll{\\\"Rollover\\u003cbr/\\u003eneeded?\\\"}\\n    LongRoll --\\u003e|Yes| GenRollLong[\\\"Generate ROLL_OPEN\\u003cbr/\\u003e+ ROLL_CLOSE signals\\\"]\\n    LongRoll --\\u003e|No| EndCalc[\\\"No signal\\\"]\\n    \\n    ShortPos --\\u003e ShortStop{\\\"close \\u003e= low_min\\u003cbr/\\u003e+ ATR  stop_n?\\\"}\\n    ShortStop --\\u003e|Yes| GenCover[\\\"Generate BUY_COVER\\u003cbr/\\u003ePriority: High\\\"]\\n    ShortStop --\\u003e|No| ShortRoll{\\\"Rollover\\u003cbr/\\u003eneeded?\\\"}\\n    ShortRoll --\\u003e|Yes| GenRollShort[\\\"Generate ROLL_OPEN\\u003cbr/\\u003e+ ROLL_CLOSE signals\\\"]\\n    ShortRoll --\\u003e|No| EndCalc\\n    \\n    CheckEntry --\\u003e|Buy| BuySig{\\\"short_trend \\u003e long_trend\\u003cbr/\\u003eAND close \\u003e= high_line?\\\"}\\n    CheckEntry --\\u003e|Sell| SellSig{\\\"short_trend \\u003c long_trend\\u003cbr/\\u003eAND close \\u003c= low_line?\\\"}\\n    \\n    BuySig --\\u003e|Yes| CalcVolume[\\\"Calculate position size:\\u003cbr/\\u003evolume = (capital + profit)\\u003cbr/\\u003e risk / (ATR  multiple)\\\"]\\n    SellSig --\\u003e|Yes| CalcVolume\\n    \\n    CalcVolume --\\u003e CheckVolume{\\\"volume \\u003e 0?\\\"}\\n    CheckVolume --\\u003e|Yes| GenOpen[\\\"Generate BUY or\\u003cbr/\\u003eSELL_SHORT signal\\\"]\\n    CheckVolume --\\u003e|No| RiskWarn[\\\"Log risk warning\\\"]\\n    \\n    GenSell --\\u003e SaveSignal[\\\"Save to Signal model\\\"]\\n    GenCover --\\u003e SaveSignal\\n    GenRollLong --\\u003e SaveSignal\\n    GenRollShort --\\u003e SaveSignal\\n    GenOpen --\\u003e SaveSignal\\n    SaveSignal --\\u003e EndCalc\\n    RiskWarn --\\u003e EndCalc\\n```\\n\\n**Position Sizing Formula:**\\n```python\\nstart_cash = Performance.objects.last().unit_count\\nprofit = sum(Trade.profit for section trades)\\nrisk_each = ATR  volume_multiple\\nvolume = round((start_cash + profit)  risk / risk_each)\\nuse_margin = settlement  volume_multiple  margin_rate  volume\\n```\\n\\n**Rollover Detection:**\\nPosition needs rollover when:\\n```python\\npos.code != inst.main_code and pos.code \\u003c inst.main_code\\n```\\n\\n**Stop Loss Logic:**\\n- **Long positions:** Close if `price \\u003c= highest_since_entry - ATR  stop_n`\\n- **Short positions:** Close if `price \\u003e= lowest_since_entry + ATR  stop_n`\\n\\n**Sources:** [trader/strategy/brother2.py:725-856]()\\n\\n---\\n\\n### `calc_up_limit(self, inst: Instrument, bar: DailyBar) -\\u003e Decimal`\\n\\nCalculates buy order limit price just below the daily price limit.\\n\\n**Formula:**\\n```python\\nprice = price_round(settlement  (1 + limit_ratio), price_tick)\\nreturn price - price_tick  # One tick below limit\\n```\\n\\n**Sources:** [trader/strategy/brother2.py:858-863]()\\n\\n---\\n\\n### `calc_down_limit(self, inst: Instrument, bar: DailyBar) -\\u003e Decimal`\\n\\nCalculates sell order limit price just above the daily price limit.\\n\\n**Formula:**\\n```python\\nprice = price_round(settlement  (1 - limit_ratio), price_tick)\\nreturn price + price_tick  # One tick above limit\\n```\\n\\n**Sources:** [trader/strategy/brother2.py:865-870]()\\n\\n---\\n\\n## Utility Methods\\n\\n### `getShares(self, instrument: str) -\\u003e tuple`\\n\\nReturns position information for a specific instrument.\\n\\n**Returns:**\\n- Tuple: `(shares, avg_price, open_date)`\\n  - `shares` (int): Net position (positive for long, negative for short)\\n  - `avg_price` (float): Weighted average entry price\\n  - `open_date` (str): Opening date\\n\\n**Limitation:** Only accurate when holding single-direction positions.\\n\\n**Sources:** [trader/strategy/brother2.py:207-214]()\\n\\n---\\n\\n### `getPositions(self, inst_id: int) -\\u003e dict`\\n\\nReturns the first position dictionary for an instrument.\\n\\n**Returns:**\\n- `dict`: Position details from `__shares` dictionary\\n\\n**Limitation:** Only returns first position when multiple exist.\\n\\n**Sources:** [trader/strategy/brother2.py:216-218]()\\n\\n---\\n\\n### `@staticmethod save_order(order: dict) -\\u003e tuple`\\n\\nSaves or updates order record in database.\\n\\n**Parameters:**\\n- `order` (dict): Order dictionary from CTP API\\n\\n**Returns:**\\n- Tuple: `(Order, bool)` - Order object and created flag\\n- `(None, None)` on error or if OrderRef \\u003c 10000\\n\\n**Processing:**\\n1. Extracts signal ID from `OrderRef` (last 5 digits)\\n2. Creates or updates `Order` model\\n3. Deletes canceled orders (`OST_Canceled`)\\n4. Adjusts timestamp if trade occurred during night session\\n5. Links order to signal\\n\\n**Sources:** [trader/strategy/brother2.py:471-495]()\\n\\n---\\n\\n### `@staticmethod get_trade_string(trade: dict) -\\u003e str`\\n\\nFormats trade execution details for logging.\\n\\n**Returns:**\\n- Formatted string: `\\\"{exchange}.{instrument} {offset}{direction} {volume} :{price} :{time} :{ref}\\\"`\\n\\n**Example Output:**\\n```\\n\\\"SHFE.rb2310 3 :3850 :09:35:21 : 00123400456\\\"\\n```\\n\\n**Sources:** [trader/strategy/brother2.py:382-389]()\\n\\n---\\n\\n### `@staticmethod get_order_string(order: dict) -\\u003e str`\\n\\nFormats order status details for logging.\\n\\n**Returns:**\\n- Formatted string with order details, submission status, and trade status\\n\\n**Example Output:**\\n```\\n\\\":00123400456,SHFE.rb2310 3 :3850 :09:35:15 : :\\\"\\n```\\n\\n**Sources:** [trader/strategy/brother2.py:497-508]()\\n\\n---\\n\\n## Method Reference Summary\\n\\n### Quick Reference Table\\n\\n| Category | Method | Async | Cron | Description |\\n|----------|--------|-------|------|-------------|\\n| **Lifecycle** | `start()` |  | - | Initialize and sync with CTP |\\n| **Account** | `refresh_account()` |  | - | Update broker account info |\\n| | `refresh_position()` |  | - | Sync positions from CTP |\\n| | `refresh_instrument()` |  | - | Update contract specifications |\\n| **Query** | `query()` |  | - | Generic CTP query with timeout |\\n| | `async_query()` | - | - | Fire-and-forget query |\\n| **Market Data** | `SubscribeMarketData()` |  | - | Subscribe to tick data |\\n| | `UnSubscribeMarketData()` |  | - | Unsubscribe from tick data |\\n| **Orders** | `ReqOrderInsert()` | - | - | Submit order to CTP |\\n| | `cancel_order()` |  | - | Cancel existing order |\\n| **Callbacks** | `OnRtnDepthMarketData()` |  | Channel | Handle tick updates |\\n| | `OnRtnTrade()` |  | Channel | Process trade executions |\\n| | `OnRtnOrder()` |  | Channel | Handle order status updates |\\n| **Scheduled** | `heartbeat()` |  | `*/1 * * * *` | Update heartbeat |\\n| | `processing_signal1()` |  | `55 8 * * *` | Process day signals |\\n| | `check_signal1_processed()` |  | `1 9 * * *` | Check missed day signals |\\n| | `processing_signal2()` |  | `25 9 * * *` | Process CFFEX signals |\\n| | `check_signal2_processed()` |  | `31 9 * * *` | Check missed CFFEX signals |\\n| | `processing_signal3()` |  | `55 20 * * *` | Process night signals |\\n| | `check_signal3_processed()` |  | `1 21 * * *` | Check missed night signals |\\n| | `refresh_all()` |  | `20 15 * * *` | Full system refresh |\\n| | `update_equity()` |  | `30 15 * * *` | Calculate performance |\\n| | `collect_quote()` |  | `0 17 * * *` | Fetch exchange data |\\n| **Calculation** | `calculate()` | - | - | Process all instruments |\\n| | `calc_signal()` | - | - | Generate trading signals |\\n| | `calc_up_limit()` | - | - | Calculate buy limit price |\\n| | `calc_down_limit()` | - | - | Calculate sell limit price |\\n| **Utility** | `getShares()` | - | - | Get position shares |\\n| | `getPositions()` | - | - | Get position dict |\\n| | `save_order()` | - | - | Save order to database |\\n| | `get_trade_string()` | - | - | Format trade for logging |\\n| | `get_order_string()` | - | - | Format order for logging |\\n\\n**Sources:** [trader/strategy/brother2.py:38-871]()\\n\\n---\\n\\n## State Management Diagram\\n\\n```mermaid\\nstateDiagram-v2\\n    [*] --\\u003e Initialization: __init__()\\n    Initialization --\\u003e Starting: start()\\n    \\n    Starting --\\u003e Syncing: Within trading hours\\n    Starting --\\u003e Idle: Outside trading hours\\n    \\n    Syncing --\\u003e Running: refresh_account()\\u003cbr/\\u003erefresh_position()\\u003cbr/\\u003ecancel unfilled orders\\n    \\n    Running --\\u003e ProcessingSignals: Scheduled signal processing\\n    Running --\\u003e MonitoringMarket: Real-time callbacks\\n    Running --\\u003e RefreshingData: Post-market data collection\\n    \\n    ProcessingSignals --\\u003e OrderExecution: ReqOrderInsert()\\n    OrderExecution --\\u003e AwaitingFill: Order sent to CTP\\n    AwaitingFill --\\u003e TradeConfirmed: OnRtnTrade callback\\n    AwaitingFill --\\u003e OrderRejected: OnRtnOrder (rejected)\\n    OrderRejected --\\u003e OrderExecution: Adjust price \\u0026 retry\\n    TradeConfirmed --\\u003e Running: Update position \\u0026 P/L\\n    \\n    MonitoringMarket --\\u003e Running: OnRtnDepthMarketData\\n    \\n    RefreshingData --\\u003e CalculatingSignals: collect_quote()\\n    CalculatingSignals --\\u003e StoringSignals: calculate()\\u003cbr/\\u003ecalc_signal()\\n    StoringSignals --\\u003e Running: Signals saved for next day\\n    \\n    Running --\\u003e DailyReset: End of day\\n    DailyReset --\\u003e RefreshAll: refresh_all()\\u003cbr/\\u003eupdate_equity()\\n    RefreshAll --\\u003e Running: Ready for next session\\n```\\n\\n**Sources:** [trader/strategy/brother2.py:38-871](), [panel/const.py:1-178]()\"])</script><script>self.__next_f.push([1,\"3d:T6336,\"])</script><script>self.__next_f.push([1,\"# BaseModule API\\n\\n\\u003cdetails\\u003e\\n\\u003csummary\\u003eRelevant source files\\u003c/summary\\u003e\\n\\nThe following files were used as context for generating this wiki page:\\n\\n- [.gitignore](.gitignore)\\n- [trader/strategy/__init__.py](trader/strategy/__init__.py)\\n- [trader/utils/func_container.py](trader/utils/func_container.py)\\n\\n\\u003c/details\\u003e\\n\\n\\n\\n## Purpose and Scope\\n\\nThis document provides a complete API reference for the `BaseModule` abstract class defined in [trader/strategy/__init__.py:36-140](). `BaseModule` is the foundational framework class that provides core infrastructure for building trading strategy modules, including Redis Pub/Sub integration, cron-based task scheduling, and event-driven callback management.\\n\\nFor information about how to use BaseModule to create custom trading strategies, see [Creating Custom Strategies](#8.3). For documentation of the concrete `TradeStrategy` implementation that extends BaseModule, see [TradeStrategy API](#10.1). For details on the callback decorator system, see [Callback System](#8.2).\\n\\n**Sources:** [trader/strategy/__init__.py:1-140]()\\n\\n---\\n\\n## Class Overview\\n\\n```python\\nclass BaseModule(CallbackFunctionContainer, metaclass=ABCMeta)\\n```\\n\\n`BaseModule` is an abstract base class that provides the following core capabilities:\\n\\n| Feature | Description |\\n|---------|-------------|\\n| **Redis Integration** | Dual Redis clients: async (`aioredis`) for event loop operations and sync (`redis.StrictRedis`) for blocking operations |\\n| **Event Loop** | Dedicated asyncio event loop for non-blocking I/O operations |\\n| **Pub/Sub Pattern** | Redis pattern-based channel subscriptions with automatic message routing |\\n| **Cron Scheduling** | `croniter`-based task scheduling for time-triggered operations |\\n| **Callback Routing** | Automatic registration and routing of decorated callback methods |\\n| **Lifecycle Management** | Install/uninstall hooks for module initialization and cleanup |\\n\\n**Sources:** [trader/strategy/__init__.py:36-57]()\\n\\n---\\n\\n## Class Hierarchy\\n\\n```mermaid\\nclassDiagram\\n    class CallbackFunctionContainer {\\n        \\u003c\\u003cabstract\\u003e\\u003e\\n        +dict callback_fun_args\\n        +_collect_all()\\n    }\\n    \\n    class BaseModule {\\n        \\u003c\\u003cabstract\\u003e\\u003e\\n        +io_loop: asyncio.EventLoop\\n        +redis_client: aioredis.Redis\\n        +raw_redis: redis.StrictRedis\\n        +sub_client: aioredis.PubSub\\n        +initialized: bool\\n        +channel_router: dict\\n        +crontab_router: defaultdict\\n        +__init__()\\n        +install() async\\n        +uninstall() async\\n        +start() async\\n        +stop() async\\n        +run()\\n        #_register_callback()\\n        #_msg_reader() async\\n        #_get_next(key)\\n        #_call_next(key)\\n    }\\n    \\n    class TradeStrategy {\\n        +refresh_all() async\\n        +processing_signal1() async\\n        +collect_quote() async\\n        ...\\n    }\\n    \\n    CallbackFunctionContainer \\u003c|-- BaseModule\\n    BaseModule \\u003c|-- TradeStrategy\\n```\\n\\n**Sources:** [trader/strategy/__init__.py:36](), [trader/utils/func_container.py:35-49]()\\n\\n---\\n\\n## Constructor\\n\\n### `__init__(self)`\\n\\nInitializes the BaseModule with Redis clients, event loop, and internal data structures.\\n\\n**Initialization Sequence:**\\n\\n1. Calls parent `CallbackFunctionContainer.__init__()` to collect decorated methods\\n2. Creates new asyncio event loop and sets it as current\\n3. Initializes async Redis client (`aioredis`) with configuration from `config.ini`\\n4. Initializes synchronous Redis client (`redis.StrictRedis`)\\n5. Creates Pub/Sub client from async Redis client\\n6. Initializes internal state tracking structures\\n\\n**Instance Variables Created:**\\n\\n| Variable | Type | Purpose |\\n|----------|------|---------|\\n| `io_loop` | `asyncio.EventLoop` | Dedicated event loop for async operations |\\n| `redis_client` | `aioredis.Redis` | Async Redis client for non-blocking operations |\\n| `raw_redis` | `redis.StrictRedis` | Sync Redis client for blocking operations |\\n| `sub_client` | `aioredis.PubSub` | Pub/Sub client for channel subscriptions |\\n| `initialized` | `bool` | Module initialization state (default: False) |\\n| `sub_tasks` | `list` | List of subscription task handles |\\n| `sub_channels` | `list` | List of subscribed channel patterns |\\n| `channel_router` | `dict` | Maps channel patterns to callback functions |\\n| `crontab_router` | `defaultdict(dict)` | Maps cron expressions to callback metadata |\\n| `datetime` | `datetime` | Timestamp at initialization |\\n| `time` | `float` | Unix timestamp at initialization |\\n| `loop_time` | `float` | Event loop time at initialization |\\n\\n**Sources:** [trader/strategy/__init__.py:37-57]()\\n\\n---\\n\\n## Callback Registration System\\n\\n### `_register_callback(self)`\\n\\nInternal method that registers all decorated callback methods into routing tables. This method is called during the `install()` lifecycle phase.\\n\\n**Registration Logic:**\\n\\n```mermaid\\nflowchart TD\\n    Start[\\\"_register_callback()\\\"] --\\u003e InitTime[\\\"Initialize timestamps:\\u003cbr/\\u003edatetime, time, loop_time\\\"]\\n    InitTime --\\u003e Iterate[\\\"Iterate callback_fun_args\\u003cbr/\\u003e(collected by parent class)\\\"]\\n    Iterate --\\u003e CheckType{\\\"Callback type?\\\"}\\n    \\n    CheckType --\\u003e|\\\"Has 'crontab' arg\\\"| CronReg[\\\"Register in crontab_router:\\u003cbr/\\u003e- func: method reference\\u003cbr/\\u003e- iter: croniter instance\\u003cbr/\\u003e- handle: None (init)\\\"]\\n    CheckType --\\u003e|\\\"Has 'channel' arg\\\"| ChanReg[\\\"Register in channel_router:\\u003cbr/\\u003epattern -\\u003e method reference\\\"]\\n    \\n    CronReg --\\u003e Next{More callbacks?}\\n    ChanReg --\\u003e Next\\n    Next --\\u003e|Yes| Iterate\\n    Next --\\u003e|No| End[\\\"Registration complete\\\"]\\n```\\n\\n**Crontab Router Structure:**\\n\\n```python\\nself.crontab_router = {\\n    '0 15 * * 1-5': {  # Cron expression as key\\n        'func': \\u003cbound method\\u003e,\\n        'iter': \\u003ccroniter object\\u003e,\\n        'handle': \\u003casyncio.TimerHandle\\u003e  # None until scheduled\\n    }\\n}\\n```\\n\\n**Channel Router Structure:**\\n\\n```python\\nself.channel_router = {\\n    'MSG:CTP:RSP:TRADE:*': \\u003cbound method\\u003e,  # Pattern -\\u003e callback\\n    'MSG:CTP:RSP:MARKET:*': \\u003cbound method\\u003e\\n}\\n```\\n\\n**Sources:** [trader/strategy/__init__.py:58-70]()\\n\\n---\\n\\n## Cron Scheduling Methods\\n\\n### `_get_next(self, key) -\\u003e float`\\n\\nCalculates the next execution time for a cron task in event loop time.\\n\\n**Parameters:**\\n- `key` (str): Cron expression (e.g., `'55 8 * * 1-5'`)\\n\\n**Returns:**\\n- `float`: Event loop timestamp for next execution\\n\\n**Algorithm:**\\n```python\\nloop_time + (croniter.get_next() - time)\\n```\\n\\nThis converts the croniter's next Unix timestamp to event loop time by calculating the offset from initialization.\\n\\n**Sources:** [trader/strategy/__init__.py:71-72]()\\n\\n---\\n\\n### `_call_next(self, key)`\\n\\nSchedules and executes a cron callback, then reschedules itself for the next occurrence.\\n\\n**Parameters:**\\n- `key` (str): Cron expression\\n\\n**Execution Flow:**\\n\\n```mermaid\\nsequenceDiagram\\n    participant EventLoop as \\\"asyncio.EventLoop\\\"\\n    participant CallNext as \\\"_call_next(key)\\\"\\n    participant CronRouter as \\\"crontab_router[key]\\\"\\n    participant Callback as \\\"Registered Method\\\"\\n    \\n    EventLoop-\\u003e\\u003eCallNext: call_at(next_time)\\n    CallNext-\\u003e\\u003eCronRouter: Cancel previous handle\\n    CallNext-\\u003e\\u003eEventLoop: call_at(_get_next(key))\\n    Note over CallNext,EventLoop: Reschedule self\\n    CallNext-\\u003e\\u003eEventLoop: create_task(callback())\\n    EventLoop-\\u003e\\u003eCallback: Execute async method\\n```\\n\\n**Key Behavior:**\\n- Cancels previous timer handle if exists\\n- Reschedules itself for next cron occurrence before executing callback\\n- Executes callback as an asyncio task (non-blocking)\\n\\n**Sources:** [trader/strategy/__init__.py:74-78]()\\n\\n---\\n\\n## Lifecycle Methods\\n\\n### `install(self) -\\u003e None` (async)\\n\\nInitializes the module by registering callbacks, subscribing to channels, and scheduling cron tasks.\\n\\n**Installation Steps:**\\n\\n| Step | Action | Error Handling |\\n|------|--------|----------------|\\n| 1 | Call `_register_callback()` | Wrapped in try/except |\\n| 2 | Subscribe to all channel patterns | Logs error on failure |\\n| 3 | Start `_msg_reader()` coroutine | Runs in event loop |\\n| 4 | Schedule all cron tasks | Cancels existing handles first |\\n| 5 | Set `initialized = True` | Marks module as ready |\\n\\n**Channel Subscription:**\\n\\nThe method subscribes to all patterns registered in `channel_router` using Redis pattern matching:\\n\\n```python\\nawait self.sub_client.psubscribe(*self.channel_router.keys())\\n```\\n\\n**Cron Scheduling:**\\n\\nFor each cron expression in `crontab_router`:\\n1. Cancel existing timer handle if present\\n2. Calculate next execution time via `_get_next(key)`\\n3. Schedule `_call_next(key)` using `io_loop.call_at()`\\n\\n**Sources:** [trader/strategy/__init__.py:80-93]()\\n\\n---\\n\\n### `uninstall(self) -\\u003e None` (async)\\n\\nCleanly shuts down the module by unsubscribing from channels and canceling scheduled tasks.\\n\\n**Cleanup Steps:**\\n\\n```mermaid\\nflowchart TD\\n    Start[\\\"uninstall()\\\"] --\\u003e Unsub[\\\"await sub_client.punsubscribe()\\\"]\\n    Unsub --\\u003e ClearTasks[\\\"Clear sub_tasks list\\\"]\\n    ClearTasks --\\u003e CloseClient[\\\"await sub_client.close()\\\"]\\n    CloseClient --\\u003e CancelCron[\\\"Cancel all cron handles\\u003cbr/\\u003ein crontab_router\\\"]\\n    CancelCron --\\u003e SetFlag[\\\"Set initialized = False\\\"]\\n    SetFlag --\\u003e Log[\\\"Log uninstall message\\\"]\\n    Log --\\u003e End[\\\"Return\\\"]\\n    \\n    Start -.-\\u003e|Exception| ErrorLog[\\\"Log error with traceback\\\"]\\n    ErrorLog -.-\\u003e End\\n```\\n\\n**Key Operations:**\\n- Unsubscribes from all Redis patterns (triggers `_msg_reader` to exit)\\n- Closes Pub/Sub client\\n- Cancels all scheduled cron tasks\\n- Sets `initialized = False`\\n\\n**Sources:** [trader/strategy/__init__.py:95-108]()\\n\\n---\\n\\n### `start(self) -\\u003e None` (async)\\n\\nWrapper method that calls `install()`. Can be overridden in subclasses for custom initialization logic.\\n\\n**Default Implementation:**\\n```python\\nasync def start(self):\\n    await self.install()\\n```\\n\\n**Sources:** [trader/strategy/__init__.py:123-124]()\\n\\n---\\n\\n### `stop(self) -\\u003e None` (async)\\n\\nWrapper method that calls `uninstall()`. Can be overridden in subclasses for custom cleanup logic.\\n\\n**Default Implementation:**\\n```python\\nasync def stop(self):\\n    await self.uninstall()\\n```\\n\\n**Sources:** [trader/strategy/__init__.py:126-127]()\\n\\n---\\n\\n### `run(self)`\\n\\nMain entry point that starts the event loop and handles graceful shutdown.\\n\\n**Execution Flow:**\\n\\n```mermaid\\nstateDiagram-v2\\n    [*] --\\u003e CreateTask: io_loop.create_task(start())\\n    CreateTask --\\u003e RunLoop: io_loop.run_forever()\\n    \\n    RunLoop --\\u003e KeyboardInt: KeyboardInterrupt\\n    RunLoop --\\u003e Exception: Other Exception\\n    RunLoop --\\u003e Stopped: Normal stop\\n    \\n    KeyboardInt --\\u003e Cleanup: run_until_complete(stop())\\n    Exception --\\u003e Cleanup\\n    Stopped --\\u003e Cleanup\\n    \\n    Cleanup --\\u003e LogExit: Log program exit\\n    LogExit --\\u003e [*]\\n```\\n\\n**Exception Handling:**\\n\\n| Exception | Behavior |\\n|-----------|----------|\\n| `KeyboardInterrupt` | Calls `stop()` synchronously and exits gracefully |\\n| Any other exception | Logs error with traceback, calls `stop()`, exits |\\n| No exception | Logs normal exit |\\n\\n**Sources:** [trader/strategy/__init__.py:129-139]()\\n\\n---\\n\\n## Message Handling\\n\\n### `_msg_reader(self) -\\u003e None` (async)\\n\\nContinuously reads messages from subscribed Redis channels and dispatches them to registered callbacks.\\n\\n**Message Processing Loop:**\\n\\n```mermaid\\nflowchart LR\\n    Listen[\\\"async for msg in\\u003cbr/\\u003esub_client.listen()\\\"] --\\u003e CheckType{\\\"msg['type']\\\"}\\n    \\n    CheckType --\\u003e|\\\"'pmessage'\\\"| Extract[\\\"Extract:\\u003cbr/\\u003e- channel\\u003cbr/\\u003e- pattern\\u003cbr/\\u003e- data (JSON)\\\"]\\n    CheckType --\\u003e|\\\"'punsubscribe'\\\"| Break[\\\"Break loop\\\"]\\n    CheckType --\\u003e|\\\"Other\\\"| Listen\\n    \\n    Extract --\\u003e Route[\\\"channel_router[pattern]\\\"]\\n    Route --\\u003e CreateTask[\\\"io_loop.create_task(\\u003cbr/\\u003ecallback(channel, data))\\\"]\\n    CreateTask --\\u003e Listen\\n    \\n    Break --\\u003e Exit[\\\"Log quit message\\\"]\\n```\\n\\n**Message Format:**\\n\\nRedis Pub/Sub messages are received with this structure:\\n```python\\n{\\n    'type': 'pmessage',\\n    'pattern': 'MSG:CTP:RSP:TRADE:*',  # Subscribed pattern\\n    'channel': 'MSG:CTP:RSP:TRADE:12345',  # Actual channel\\n    'data': '{\\\"key\\\": \\\"value\\\"}'  # JSON string\\n}\\n```\\n\\n**Routing Logic:**\\n\\n1. Parse JSON data using `ujson.loads()`\\n2. Look up callback function using the **pattern** (not channel) in `channel_router`\\n3. Create async task passing both `channel` and `data` to callback\\n4. Continue listening (non-blocking)\\n\\n**Exit Condition:**\\n\\nThe loop exits when it receives a `punsubscribe` message type, which occurs during `uninstall()`.\\n\\n**Sources:** [trader/strategy/__init__.py:110-121]()\\n\\n---\\n\\n## Integration with RegisterCallback Decorator\\n\\n### Decorator Usage Pattern\\n\\nSubclasses use the `@RegisterCallback` decorator from `CallbackFunctionContainer` to mark methods for automatic registration:\\n\\n```python\\nfrom trader.strategy import BaseModule\\nfrom trader.utils.func_container import RegisterCallback\\n\\nclass MyStrategy(BaseModule):\\n    @RegisterCallback(crontab='55 8 * * 1-5')  # Run at 08:55 on weekdays\\n    async def morning_task(self):\\n        # Task implementation\\n        pass\\n    \\n    @RegisterCallback(channel='MSG:CTP:RSP:TRADE:*')\\n    async def on_trade_update(self, channel, data):\\n        # Handle trade messages\\n        pass\\n```\\n\\n### How Decoration Works\\n\\n```mermaid\\nflowchart TB\\n    Decorator[\\\"@RegisterCallback(crontab=...)\\\"] --\\u003e Wrapper[\\\"Creates wrapper function\\\"]\\n    Wrapper --\\u003e SetAttr[\\\"Sets attributes:\\u003cbr/\\u003e- arg_crontab\\u003cbr/\\u003e- is_callback_function\\\"]\\n    SetAttr --\\u003e Store[\\\"CallbackFunctionContainer\\u003cbr/\\u003ecollects in __init__\\\"]\\n    Store --\\u003e Register[\\\"BaseModule._register_callback()\\u003cbr/\\u003eroutes to appropriate system\\\"]\\n    Register --\\u003e CronSystem[\\\"Cron Scheduler\\\"]\\n    Register --\\u003e ChannelSystem[\\\"Channel Router\\\"]\\n```\\n\\n**Decorator Parameters:**\\n\\n| Parameter | Type | Purpose | Example |\\n|-----------|------|---------|---------|\\n| `crontab` | `str` | Cron expression for scheduled execution | `'0 15 * * 1-5'` (3pm weekdays) |\\n| `channel` | `str` | Redis channel pattern to subscribe | `'MSG:CTP:RSP:*'` (all CTP responses) |\\n\\n**Sources:** [trader/utils/func_container.py:21-32](), [trader/strategy/__init__.py:58-70]()\\n\\n---\\n\\n## Redis Client Properties\\n\\n### Async Redis Client (`redis_client`)\\n\\n**Type:** `aioredis.Redis`\\n\\n**Configuration:** Read from `config.ini`:\\n- Host: `[REDIS] host` (default: localhost)\\n- Port: `[REDIS] port` (default: 6379)\\n- Database: `[REDIS] db` (default: 0)\\n\\n**Features:**\\n- Connection pool management\\n- Non-blocking operations\\n- Pub/Sub support\\n- Automatic response decoding\\n\\n**Usage Context:** All async operations including Pub/Sub, caching, and non-blocking queries.\\n\\n**Sources:** [trader/strategy/__init__.py:41-44]()\\n\\n---\\n\\n### Synchronous Redis Client (`raw_redis`)\\n\\n**Type:** `redis.StrictRedis`\\n\\n**Configuration:** Same as async client\\n\\n**Features:**\\n- Blocking operations\\n- Thread-safe\\n- Immediate execution\\n\\n**Usage Context:** Used when async/await syntax is not available or blocking behavior is desired (e.g., in synchronous utility functions).\\n\\n**Sources:** [trader/strategy/__init__.py:45-47]()\\n\\n---\\n\\n## Complete Method Reference Table\\n\\n| Method | Type | Visibility | Purpose |\\n|--------|------|-----------|---------|\\n| `__init__()` | sync | public | Constructor - initializes clients and data structures |\\n| `_register_callback()` | sync | protected | Registers decorated methods into routing tables |\\n| `_get_next(key)` | sync | protected | Calculates next cron execution time |\\n| `_call_next(key)` | sync | protected | Executes and reschedules cron task |\\n| `_msg_reader()` | async | protected | Reads and dispatches Redis Pub/Sub messages |\\n| `install()` | async | public | Initializes subscriptions and scheduling |\\n| `uninstall()` | async | public | Cleanup: unsubscribe and cancel tasks |\\n| `start()` | async | public | Lifecycle hook - calls install() |\\n| `stop()` | async | public | Lifecycle hook - calls uninstall() |\\n| `run()` | sync | public | Main entry point - runs event loop |\\n\\n**Sources:** [trader/strategy/__init__.py:36-140]()\\n\\n---\\n\\n## Time Management System\\n\\n### Time Tracking Variables\\n\\nBaseModule maintains three time references initialized during `_register_callback()`:\\n\\n| Variable | Type | Source | Purpose |\\n|----------|------|--------|---------|\\n| `datetime` | `datetime.datetime` | `timezone.localtime()` | Local timezone-aware timestamp |\\n| `time` | `float` | `time.time()` | Unix timestamp (seconds since epoch) |\\n| `loop_time` | `float` | `io_loop.time()` | Event loop monotonic time |\\n\\n**Time Synchronization:**\\n\\n```mermaid\\ngraph LR\\n    RealTime[\\\"Real World Time\\\"] --\\u003e|\\\"timezone.localtime()\\\"| DateTime[\\\"self.datetime\\\"]\\n    RealTime --\\u003e|\\\"time.time()\\\"| UnixTime[\\\"self.time\\\"]\\n    EventLoop[\\\"asyncio.EventLoop\\\"] --\\u003e|\\\"io_loop.time()\\\"| LoopTime[\\\"self.loop_time\\\"]\\n    \\n    DateTime --\\u003e Croniter[\\\"croniter.get_next()\\\"]\\n    UnixTime --\\u003e Offset[\\\"Calculate offset\\\"]\\n    LoopTime --\\u003e Offset\\n    Offset --\\u003e Schedule[\\\"io_loop.call_at()\\\"]\\n```\\n\\n**Offset Calculation:**\\n\\nTo schedule a cron task in the event loop:\\n```python\\nevent_loop_time = self.loop_time + (cron_next_unix_time - self.time)\\n```\\n\\nThis translates croniter's Unix timestamps to event loop monotonic time.\\n\\n**Sources:** [trader/strategy/__init__.py:54-56, 59-61, 71-72]()\\n\\n---\\n\\n## Error Handling and Logging\\n\\n### Logging Configuration\\n\\nAll BaseModule operations use a dedicated logger:\\n\\n```python\\nlogger = logging.getLogger('BaseModule')\\n```\\n\\n### Error Handling Patterns\\n\\n| Operation | Exception Handling | Logging |\\n|-----------|-------------------|---------|\\n| `install()` | Try/except wrapper | Error logged with `repr(e)` and traceback |\\n| `uninstall()` | Try/except wrapper | Error logged with `repr(e)` and traceback |\\n| `run()` | Catches `KeyboardInterrupt` and all exceptions | Error logged, cleanup executed |\\n| `_msg_reader()` | No explicit handling | Relies on asyncio error propagation |\\n| Cron callbacks | Each task runs independently | Errors don't affect other tasks |\\n\\n### Log Messages\\n\\n| Event | Level | Message Template |\\n|-------|-------|------------------|\\n| Install success | DEBUG | `'%s plugin installed'` |\\n| Install failure | ERROR | `'%s plugin install failed: %s'` |\\n| Uninstall success | DEBUG | `'%s plugin uninstalled'` |\\n| Uninstall failure | ERROR | `'%s plugin uninstall failed: %s'` |\\n| Message reader exit | DEBUG | `'%s quit _msg_reader!'` |\\n| Run error | ERROR | `': %s'` |\\n| Exit | DEBUG | `''` |\\n\\n**Sources:** [trader/strategy/__init__.py:33, 82-93, 95-108, 121, 129-139]()\\n\\n---\\n\\n## Configuration Dependencies\\n\\n### Required Configuration Sections\\n\\nBaseModule reads from `config.ini` via the `trader.utils.read_config.config` object:\\n\\n```ini\\n[REDIS]\\nhost = localhost\\nport = 6379\\ndb = 0\\n```\\n\\n### Configuration Access Pattern\\n\\n```python\\nfrom trader.utils.read_config import config\\n\\nhost = config.get('REDIS', 'host', fallback='localhost')\\nport = config.getint('REDIS', 'port', fallback=6379)\\ndb = config.getint('REDIS', 'db', fallback=0)\\n```\\n\\nAll configuration reads include fallback values for robustness.\\n\\n**Sources:** [trader/strategy/__init__.py:31, 41-47]()\\n\\n---\\n\\n## Usage Example: Creating a BaseModule Subclass\\n\\n### Minimal Implementation\\n\\n```python\\nfrom trader.strategy import BaseModule\\nfrom trader.utils.func_container import RegisterCallback\\n\\nclass MyModule(BaseModule):\\n    def __init__(self):\\n        super().__init__()\\n        # Add custom initialization here\\n    \\n    @RegisterCallback(crontab='0 9 * * 1-5')\\n    async def daily_task(self):\\n        \\\"\\\"\\\"Runs at 9:00 AM on weekdays\\\"\\\"\\\"\\n        print(\\\"Executing daily task\\\")\\n    \\n    @RegisterCallback(channel='MSG:MY:PATTERN:*')\\n    async def on_message(self, channel, data):\\n        \\\"\\\"\\\"Handles messages matching pattern\\\"\\\"\\\"\\n        print(f\\\"Received on {channel}: {data}\\\")\\n\\nif __name__ == '__main__':\\n    module = MyModule()\\n    module.run()\\n```\\n\\n### Execution Lifecycle\\n\\n```mermaid\\nsequenceDiagram\\n    participant Main as \\\"Main Thread\\\"\\n    participant Module as \\\"MyModule\\\"\\n    participant BaseModule as \\\"BaseModule\\\"\\n    participant EventLoop as \\\"asyncio.EventLoop\\\"\\n    participant Redis as \\\"Redis Server\\\"\\n    \\n    Main-\\u003e\\u003eModule: module = MyModule()\\n    Module-\\u003e\\u003eBaseModule: super().__init__()\\n    BaseModule-\\u003e\\u003eEventLoop: Create new event loop\\n    BaseModule-\\u003e\\u003eRedis: Initialize clients\\n    \\n    Main-\\u003e\\u003eModule: module.run()\\n    Module-\\u003e\\u003eEventLoop: create_task(start())\\n    Module-\\u003e\\u003eEventLoop: run_forever()\\n    \\n    EventLoop-\\u003e\\u003eBaseModule: install()\\n    BaseModule-\\u003e\\u003eBaseModule: _register_callback()\\n    BaseModule-\\u003e\\u003eRedis: psubscribe(patterns)\\n    BaseModule-\\u003e\\u003eEventLoop: Schedule cron tasks\\n    \\n    loop Message Loop\\n        Redis--\\u003e\\u003eBaseModule: Message on channel\\n        BaseModule-\\u003e\\u003eModule: on_message(channel, data)\\n    end\\n    \\n    loop Cron Loop\\n        EventLoop-\\u003e\\u003eBaseModule: Timer fires\\n        BaseModule-\\u003e\\u003eModule: daily_task()\\n    end\\n    \\n    Main-\\u003e\\u003eModule: KeyboardInterrupt\\n    Module-\\u003e\\u003eBaseModule: stop()\\n    BaseModule-\\u003e\\u003eRedis: punsubscribe()\\n    BaseModule-\\u003e\\u003eEventLoop: Cancel tasks\\n    EventLoop-\\u003e\\u003eMain: Exit\\n```\\n\\n**Sources:** [trader/strategy/__init__.py:36-140]()\\n\\n---\\n\\n## Internal State Management\\n\\n### State Variables\\n\\n| Variable | Initial Value | Modified By | Purpose |\\n|----------|--------------|-------------|---------|\\n| `initialized` | `False` | `install()`, `uninstall()` | Tracks module readiness |\\n| `sub_tasks` | `[]` | `install()`, `uninstall()` | Subscription task handles |\\n| `sub_channels` | `[]` | *(unused in current implementation)* | Reserved for channel tracking |\\n| `channel_router` | `{}` | `_register_callback()` | Pattern  callback mapping |\\n| `crontab_router` | `defaultdict(dict)` | `_register_callback()`, `_call_next()` | Cron  metadata mapping |\\n\\n### State Transitions\\n\\n```mermaid\\nstateDiagram-v2\\n    [*] --\\u003e Uninitialized: __init__()\\n    Uninitialized --\\u003e Initialized: install() success\\n    Initialized --\\u003e Running: Event loop active\\n    Running --\\u003e Initialized: Temporary state\\n    Initialized --\\u003e Uninitialized: uninstall()\\n    Uninitialized --\\u003e [*]: run() exits\\n    \\n    note right of Initialized\\n        initialized = True\\n        Subscriptions active\\n        Cron tasks scheduled\\n    end note\\n    \\n    note right of Uninitialized\\n        initialized = False\\n        No active subscriptions\\n        No scheduled tasks\\n    end note\\n```\\n\\n**Sources:** [trader/strategy/__init__.py:49-56, 80-108]()\\n\\n---\\n\\n## Dependencies and Imports\\n\\n### External Dependencies\\n\\n| Module | Purpose | Usage |\\n|--------|---------|-------|\\n| `redis` | Synchronous Redis client | `raw_redis` initialization |\\n| `aioredis` | Asynchronous Redis client | `redis_client` and `sub_client` |\\n| `ujson` | Fast JSON parsing | Message data deserialization |\\n| `croniter` | Cron expression parser | Task scheduling |\\n| `asyncio` | Async I/O framework | Event loop and task management |\\n| `pytz` | Timezone handling | *(imported but not directly used in BaseModule)* |\\n\\n### Internal Dependencies\\n\\n| Module | Component | Purpose |\\n|--------|-----------|---------|\\n| `trader.utils.func_container` | `CallbackFunctionContainer` | Parent class for callback collection |\\n| `trader.utils.func_container` | `RegisterCallback` | Decorator for marking callbacks |\\n| `trader.utils.read_config` | `config` | Configuration file reader |\\n| `django.utils.timezone` | `timezone.localtime()` | Local timezone-aware time |\\n\\n**Sources:** [trader/strategy/__init__.py:16-31]()\\n\\n---\\n\\n## Thread Safety and Concurrency\\n\\n### Event Loop Design\\n\\nBaseModule creates a **dedicated event loop** per instance:\\n\\n```python\\nself.io_loop = asyncio.new_event_loop()\\nasyncio.set_event_loop(self.io_loop)\\n```\\n\\n**Implications:**\\n- Each module instance runs in its own event loop\\n- Callbacks execute serially within the loop (no race conditions)\\n- Multiple module instances require separate threads/processes\\n\\n### Redis Client Thread Safety\\n\\n| Client | Thread Safe? | Notes |\\n|--------|--------------|-------|\\n| `redis_client` (aioredis) | **No** | Must be accessed from event loop thread only |\\n| `raw_redis` (StrictRedis) | **Yes** | Uses connection pooling, safe for multi-threaded access |\\n\\n**Best Practice:** Use `redis_client` for all async operations within callbacks. Reserve `raw_redis` for synchronous utility functions.\\n\\n**Sources:** [trader/strategy/__init__.py:39-47]()\\n\\n---\\n\\n## Performance Considerations\\n\\n### Non-Blocking Operations\\n\\nAll callback executions are non-blocking:\\n\\n```python\\nself.io_loop.create_task(self.channel_router[pattern](channel, data))\\n```\\n\\nThis ensures that:\\n- Long-running callbacks don't block message processing\\n- Multiple callbacks can execute concurrently\\n- Cron tasks don't delay message handling\\n\\n### Message Processing Overhead\\n\\nEach message requires:\\n1. JSON deserialization (`ujson.loads`)\\n2. Dictionary lookup in `channel_router`\\n3. Task creation overhead (minimal)\\n\\n**Optimization:** Use pattern matching sparingly; specific channels route faster than broad patterns.\\n\\n### Cron Scheduling Precision\\n\\n- Uses `croniter` for exact cron expression evaluation\\n- Scheduling overhead: ~1ms per task\\n- Timer precision: Limited by asyncio event loop resolution (~1-15ms depending on OS)\\n\\n**Sources:** [trader/strategy/__init__.py:74-78, 110-121]()\\n\\n---\\n\\n## Related Components\\n\\nFor complete understanding of the BaseModule ecosystem, refer to:\\n\\n- **[TradeStrategy API](#10.1):** Concrete implementation extending BaseModule\\n- **[Callback System](#8.2):** Detailed guide on `@RegisterCallback` usage\\n- **[Creating Custom Strategies](#8.3):** Tutorial on building strategy modules\\n- **[Message Bus and Communication](#3.3):** Redis Pub/Sub architecture details\\n- **[Configuration Reference](#7.1):** Complete config.ini documentation\\n\\n**Sources:** [trader/strategy/__init__.py:1-140](), [trader/utils/func_container.py:1-49]()\"])</script><script>self.__next_f.push([1,\"3e:T9578,\"])</script><script>self.__next_f.push([1,\"# Data Utilities API\\n\\n\\u003cdetails\\u003e\\n\\u003csummary\\u003eRelevant source files\\u003c/summary\\u003e\\n\\nThe following files were used as context for generating this wiki page:\\n\\n- [trader/utils/__init__.py](trader/utils/__init__.py)\\n- [trader/utils/fetch_data.py](trader/utils/fetch_data.py)\\n\\n\\u003c/details\\u003e\\n\\n\\n\\n## Purpose and Scope\\n\\nThis page provides a complete API reference for the utility functions in the `trader/utils` module. These functions handle data acquisition from Chinese commodity exchanges, main contract calculation, historical signal generation, price conversions, and data management tasks.\\n\\nFor information about using these utilities in trading strategies, see [Trading Strategy System](#4). For details on the data models these functions operate on, see [Data Models](#5.1). For orchestrating daily data updates, see [Exchange Data Acquisition](#5.2).\\n\\n**Sources:** [trader/utils/__init__.py:1-797]()\\n\\n---\\n\\n## Module Overview\\n\\nThe `trader.utils` module provides three main categories of functionality:\\n\\n| Category | Key Functions | Purpose |\\n|----------|---------------|---------|\\n| **Exchange Data** | `update_from_shfe`, `update_from_dce`, `update_from_czce`, `update_from_cffex`, `update_from_gfex` | Fetch daily market data from exchanges |\\n| **Main Contract** | `calc_main_inst`, `create_main`, `handle_rollover` | Identify main contracts and manage rollovers |\\n| **Signal Generation** | `calc_history_signal`, `calc_his_all` | Generate historical trading signals for backtesting |\\n| **Price Utilities** | `price_round`, `calc_his_up_limit`, `calc_his_down_limit` | Price calculations and limit price determination |\\n| **Trading Day** | `is_trading_day`, `check_trading_day` | Validate trading days |\\n| **Data Management** | `clean_daily_bar`, `load_kt_data`, `get_contracts_argument` | Data cleanup and import operations |\\n\\n**Sources:** [trader/utils/__init__.py:1-797]()\\n\\n---\\n\\n## Function Call Hierarchy\\n\\n```mermaid\\ngraph TB\\n    subgraph \\\"Orchestration Layer\\\"\\n        FetchBar[\\\"fetch_bar()\\u003cbr/\\u003efetch_data.py:24-46\\\"]\\n        FetchBar2[\\\"fetch_bar2()\\u003cbr/\\u003efetch_data.py:49-64\\\"]\\n    end\\n    \\n    subgraph \\\"Exchange Update Functions\\\"\\n        UpdateSHFE[\\\"update_from_shfe(day)\\\"]\\n        UpdateDCE[\\\"update_from_dce(day)\\\"]\\n        UpdateCZCE[\\\"update_from_czce(day)\\\"]\\n        UpdateCFFEX[\\\"update_from_cffex(day)\\\"]\\n        UpdateGFEX[\\\"update_from_gfex(day)\\\"]\\n    end\\n    \\n    subgraph \\\"Main Contract Management\\\"\\n        CreateMainAll[\\\"create_main_all()\\\"]\\n        CreateMain[\\\"create_main(inst)\\\"]\\n        CalcMainInst[\\\"calc_main_inst(inst, day)\\\"]\\n        StoreMainBar[\\\"store_main_bar(inst, bar)\\\"]\\n        HandleRollover[\\\"handle_rollover(inst, new_bar)\\\"]\\n    end\\n    \\n    subgraph \\\"Historical Analysis\\\"\\n        CalcHisAll[\\\"calc_his_all(day)\\\"]\\n        CalcHistorySignal[\\\"calc_history_signal(inst, day, strategy)\\\"]\\n    end\\n    \\n    subgraph \\\"Supporting Functions\\\"\\n        CheckTradingDay[\\\"check_trading_day(day)\\\"]\\n        GetExpireDate[\\\"get_expire_date(inst_code, day)\\\"]\\n        PriceRound[\\\"price_round(x, base)\\\"]\\n        StrToNumber[\\\"str_to_number(s)\\\"]\\n    end\\n    \\n    FetchBar --\\u003e CheckTradingDay\\n    FetchBar --\\u003e UpdateSHFE\\n    FetchBar --\\u003e UpdateDCE\\n    FetchBar --\\u003e UpdateCZCE\\n    FetchBar --\\u003e UpdateCFFEX\\n    \\n    FetchBar2 --\\u003e CheckTradingDay\\n    FetchBar2 --\\u003e UpdateSHFE\\n    FetchBar2 --\\u003e UpdateDCE\\n    FetchBar2 --\\u003e UpdateCZCE\\n    FetchBar2 --\\u003e UpdateCFFEX\\n    \\n    CreateMainAll --\\u003e CreateMain\\n    CreateMain --\\u003e CalcMainInst\\n    CalcMainInst --\\u003e StoreMainBar\\n    CalcMainInst --\\u003e HandleRollover\\n    \\n    CalcHisAll --\\u003e CalcHistorySignal\\n    \\n    UpdateSHFE --\\u003e StrToNumber\\n    UpdateCZCE --\\u003e GetExpireDate\\n    UpdateDCE --\\u003e StrToNumber\\n    \\n    HandleRollover --\\u003e PriceRound\\n```\\n\\n**Sources:** [trader/utils/__init__.py:121-349,381-444,500-614](), [trader/utils/fetch_data.py:24-64]()\\n\\n---\\n\\n## Exchange Data Update Functions\\n\\nThese asynchronous functions fetch daily market data from the five major Chinese commodity exchanges and store them in the `DailyBar` model.\\n\\n### `update_from_shfe(day: datetime.datetime) -\\u003e bool`\\n\\nFetches daily market data from Shanghai Futures Exchange (SHFE) and International Energy Exchange (INE).\\n\\n**Parameters:**\\n- `day` (datetime.datetime): The trading day to fetch data for\\n\\n**Returns:**\\n- `bool`: `True` if successful, `False` on error\\n\\n**Behavior:**\\n- Makes HTTP GET request to `http://www.shfe.com.cn/data/tradedata/future/dailydata/kx{YYYYMMDD}.dat`\\n- Parses JSON response containing contract daily data\\n- Filters out summary records (`DELIVERYMONTH=''` or `PRODUCTID=''`)\\n- Only processes futures contracts (`'_f'` in `PRODUCTID`)\\n- Creates/updates `DailyBar` records with OHLC, volume, and open interest data\\n- Handles INE instruments (sc, bc, nr, lu) separately with `ExchangeType.INE`\\n- Updates instrument names for all SHFE products\\n- Uses semaphore `max_conn_shfe` (limit: 15) to control concurrent connections\\n\\n**Related Constants:**\\n- `shfe_ip = 'www.shfe.com.cn'` [trader/utils/__init__.py:49]()\\n- `INE_INST_LIST = ['sc', 'bc', 'nr', 'lu']` [trader/utils/__init__.py:54]()\\n- `IGNORE_INST_LIST` [trader/utils/__init__.py:53]()\\n\\n**Sources:** [trader/utils/__init__.py:121-174]()\\n\\n---\\n\\n### `update_from_czce(day: datetime.datetime) -\\u003e bool`\\n\\nFetches daily market data from Zhengzhou Commodity Exchange (CZCE).\\n\\n**Parameters:**\\n- `day` (datetime.datetime): The trading day to fetch data for\\n\\n**Returns:**\\n- `bool`: `True` if successful, `False` on error\\n\\n**Behavior:**\\n- Makes HTTP GET request to `http://www.czce.com.cn/cn/DFSStaticFiles/Future/{YEAR}/{YYYYMMDD}/FutureDataDaily.txt`\\n- Parses pipe-delimited or comma-delimited text format\\n- Skips summary rows containing '', '', or ''\\n- Handles missing price data by using settlement or close price as fallback\\n- Removes commas from numeric strings\\n- Calculates expire date using `get_expire_date()`\\n- Creates/updates `DailyBar` records\\n\\n**Text Format:**\\n```\\n|||||||1|2|()|||()|\\nCF601|11,970.00|11,970.00|11,970.00|11,800.00|11,870.00|11,905.00|-100.00|-65.00|13,826|59,140|-10,760|82,305.24|\\n```\\n\\n**Sources:** [trader/utils/__init__.py:177-217]()\\n\\n---\\n\\n### `update_from_dce(day: datetime.datetime) -\\u003e bool`\\n\\nFetches daily market data from Dalian Commodity Exchange (DCE).\\n\\n**Parameters:**\\n- `day` (datetime.datetime): The trading day to fetch data for\\n\\n**Returns:**\\n- `bool`: `True` if successful, `False` on error\\n\\n**Behavior:**\\n- Makes HTTP POST request to `http://www.dce.com.cn/publicweb/quotesdata/exportDayQuotesChData.html`\\n- POST data includes: `variety='all'`, `trade_type=0`, `exportFlag='txt'`, year, month (0-indexed), day\\n- Parses tab-delimited text format\\n- Filters out summary rows ('', '')\\n- Uses `DCE_NAME_CODE` dictionary to map Chinese names to product codes\\n- Handles missing data (marked as '-') by using close price as fallback\\n- Uses semaphore `max_conn_dce` (limit: 5)\\n\\n**Text Format:**\\n```\\n                                    1                \\n    1611    3,760    3,760    3,760    3,760    3,860    3,760    -100    -100    2    0    0    7.52\\n```\\n\\n**Sources:** [trader/utils/__init__.py:220-265]()\\n\\n---\\n\\n### `update_from_gfex(day: datetime.datetime) -\\u003e bool`\\n\\nFetches daily market data from Guangzhou Futures Exchange (GFEX).\\n\\n**Parameters:**\\n- `day` (datetime.datetime): The trading day to fetch data for\\n\\n**Returns:**\\n- `bool`: `True` if successful, `False` on error\\n\\n**Behavior:**\\n- Makes HTTP POST requests to `http://www.gfex.com.cn/gfexweb/Quote/getQuote_ftr`\\n- Queries two variety IDs: 'lc' and 'si'\\n- Parses JSON response with `contractQuote` dictionary\\n- Handles missing data (marked as \\\"--\\\") by using close price as fallback\\n- Uses semaphore `max_conn_gfex` (limit: 5)\\n\\n**JSON Response Structure:**\\n```json\\n{\\n  \\\"contractQuote\\\": {\\n    \\\"si2201\\\": {\\n      \\\"openPrice\\\": \\\"5000\\\",\\n      \\\"highPrice\\\": \\\"5100\\\",\\n      \\\"lowPrice\\\": \\\"4950\\\",\\n      \\\"closePrice\\\": \\\"5050\\\",\\n      \\\"clearPrice\\\": \\\"5055\\\",\\n      \\\"matchTotQty\\\": \\\"1000\\\",\\n      \\\"openInterest\\\": \\\"5000\\\"\\n    }\\n  }\\n}\\n```\\n\\n**Sources:** [trader/utils/__init__.py:268-293]()\\n\\n---\\n\\n### `update_from_cffex(day: datetime.datetime) -\\u003e bool`\\n\\nFetches daily market data from China Financial Futures Exchange (CFFEX).\\n\\n**Parameters:**\\n- `day` (datetime.datetime): The trading day to fetch data for\\n\\n**Returns:**\\n- `bool`: `True` if successful, `False` on error\\n\\n**Behavior:**\\n- Makes HTTP GET request to `http://www.cffex.com.cn/sj/hqsj/rtj/{YYYYMM}/{DD}/index.xml?id=7`\\n- Parses XML response using `xml.etree.ElementTree`\\n- Skips option contracts (instrument IDs longer than 6 characters)\\n- Extracts expire date from XML field (format: YYYYMMDD  YYMM)\\n- Uses semaphore `max_conn_cffex` (limit: 15)\\n\\n**XML Structure:**\\n```xml\\n\\u003cdailydata\\u003e\\n  \\u003cinstrumentid\\u003eIC2112\\u003c/instrumentid\\u003e\\n  \\u003ctradingday\\u003e20211209\\u003c/tradingday\\u003e\\n  \\u003copenprice\\u003e7272\\u003c/openprice\\u003e\\n  \\u003chighestprice\\u003e7330\\u003c/highestprice\\u003e\\n  \\u003clowestprice\\u003e7264.4\\u003c/lowestprice\\u003e\\n  \\u003ccloseprice\\u003e7302.4\\u003c/closeprice\\u003e\\n  \\u003csettlementprice\\u003e7314.2\\u003c/settlementprice\\u003e\\n  \\u003cvolume\\u003e51752\\u003c/volume\\u003e\\n  \\u003copeninterest\\u003e101956\\u003c/openinterest\\u003e\\n  \\u003cexpiredate\\u003e20211217\\u003c/expiredate\\u003e\\n\\u003c/dailydata\\u003e\\n```\\n\\n**Sources:** [trader/utils/__init__.py:296-349]()\\n\\n---\\n\\n## Main Contract Management Functions\\n\\nThese functions identify the \\\"main\\\" (most liquid) contract for each product and manage contract rollovers with basis adjustments.\\n\\n### Main Contract Selection Algorithm\\n\\n```mermaid\\nflowchart TD\\n    Start[\\\"calc_main_inst(inst, day)\\\"]\\n    \\n    Condition1[\\\"Condition 1:\\u003cbr/\\u003eVolume = Max\\u003cbr/\\u003eAND\\u003cbr/\\u003e(Volume \\u003e 10k AND OI \\u003e 10k\\u003cbr/\\u003eOR Exchange = CFFEX)\\\"]\\n    \\n    Condition2[\\\"Condition 2:\\u003cbr/\\u003eMax volume for\\u003cbr/\\u003e3 consecutive days\\u003cbr/\\u003e(same contract)\\\"]\\n    \\n    Condition3[\\\"Condition 3:\\u003cbr/\\u003eCurrent max volume\\u003cbr/\\u003e(fallback)\\\"]\\n    \\n    CheckChanged{\\\"Contract\\u003cbr/\\u003echanged?\\\"}\\n    \\n    StoreMainBar[\\\"store_main_bar(inst, bar)\\\"]\\n    HandleRollover[\\\"handle_rollover(inst, new_bar)\\u003cbr/\\u003eBasis adjustment\\\"]\\n    \\n    Return[\\\"Return (main_code, updated)\\\"]\\n    \\n    Start --\\u003e Condition1\\n    Condition1 --\\u003e|Found| CheckChanged\\n    Condition1 --\\u003e|Not Found| Condition2\\n    Condition2 --\\u003e|Found| CheckChanged\\n    Condition2 --\\u003e|Not Found| Condition3\\n    Condition3 --\\u003e CheckChanged\\n    \\n    CheckChanged --\\u003e|Yes| StoreMainBar\\n    CheckChanged --\\u003e|No| StoreMainBar\\n    \\n    StoreMainBar --\\u003e|Changed| HandleRollover\\n    StoreMainBar --\\u003e|Unchanged| Return\\n    HandleRollover --\\u003e Return\\n```\\n\\n**Sources:** [trader/utils/__init__.py:381-421]()\\n\\n---\\n\\n### `calc_main_inst(inst: Instrument, day: datetime.datetime) -\\u003e (str, bool)`\\n\\nIdentifies the main (most liquid) contract for a given instrument and day using a three-tier algorithm.\\n\\n**Parameters:**\\n- `inst` (Instrument): The instrument to calculate main contract for\\n- `day` (datetime.datetime): The trading day\\n\\n**Returns:**\\n- `tuple`: `(main_code: str, updated: bool)` - The main contract code and whether it changed\\n\\n**Algorithm:**\\n\\n**Condition 1** (Primary): Contract with maximum volume where:\\n- (Volume  10,000 AND Open Interest  10,000) OR Exchange = CFFEX\\n- Expire date  previous main contract's expire date\\n\\n**Condition 2** (Secondary): If Condition 1 fails, check if the same contract has maximum volume for 3 consecutive days\\n\\n**Condition 3** (Fallback): Take the contract with maximum volume, then maximum open interest, then earliest code\\n\\n**Rollover Handling:**\\nWhen main contract changes (`check_bar.code \\u003e inst.main_code`):\\n1. Updates `inst.last_main`, `inst.main_code`, `inst.change_time`\\n2. Stores new main bar\\n3. Calls `handle_rollover()` to adjust historical prices\\n\\n**Sources:** [trader/utils/__init__.py:381-421]()\\n\\n---\\n\\n### `store_main_bar(inst: Instrument, bar: DailyBar)`\\n\\nCreates or updates a `MainBar` record for continuous price series.\\n\\n**Parameters:**\\n- `inst` (Instrument): The instrument\\n- `bar` (DailyBar): The daily bar data to store\\n\\n**Behavior:**\\n- Copies OHLC, volume, and open interest from `DailyBar` to `MainBar`\\n- Uses `update_or_create` to handle both inserts and updates\\n- Maintains continuous price series for each product\\n\\n**Sources:** [trader/utils/__init__.py:352-362]()\\n\\n---\\n\\n### `handle_rollover(inst: Instrument, new_bar: DailyBar)`\\n\\nAdjusts historical prices when main contract changes to create continuous price series.\\n\\n**Parameters:**\\n- `inst` (Instrument): The instrument undergoing rollover\\n- `new_bar` (DailyBar): The new main contract's bar\\n\\n**Behavior:**\\n- Calculates basis: `basis = new_contract_close - old_contract_close`\\n- Stores basis in today's `MainBar` record\\n- Adjusts all historical `MainBar` records before today: `price_adjusted = price_original + basis`\\n- Updates: `open`, `high`, `low`, `close`, `settlement`\\n- Uses Django F() expressions for efficient bulk update\\n\\n**Mathematical Formula:**\\n```\\nbasis = new_bar.close - old_bar.close\\nMainBar[date \\u003c today].open += basis\\nMainBar[date \\u003c today].high += basis\\nMainBar[date \\u003c today].low += basis\\nMainBar[date \\u003c today].close += basis\\nMainBar[date \\u003c today].settlement += basis\\n```\\n\\n**Sources:** [trader/utils/__init__.py:365-378]()\\n\\n---\\n\\n### `create_main(inst: Instrument) -\\u003e bool`\\n\\nProcesses all historical daily bars for an instrument to build complete main contract series.\\n\\n**Parameters:**\\n- `inst` (Instrument): The instrument to process\\n\\n**Returns:**\\n- `bool`: `True` on success\\n\\n**Behavior:**\\n- If `inst.change_time` is None, processes all historical bars\\n- Otherwise, processes only bars after `inst.change_time`\\n- Calls `calc_main_inst()` for each distinct trading day\\n- Prints progress: `(day, (main_code, updated))`\\n\\n**Sources:** [trader/utils/__init__.py:424-438]()\\n\\n---\\n\\n### `create_main_all()`\\n\\nConvenience function to rebuild main contract series for all instruments.\\n\\n**Behavior:**\\n- Iterates through all `Instrument` objects\\n- Calls `create_main(inst)` for each\\n- Typically used for initial data loading or full recalculation\\n\\n**Sources:** [trader/utils/__init__.py:441-444]()\\n\\n---\\n\\n## Historical Signal Generation Functions\\n\\nThese functions generate trading signals for backtesting using technical indicators.\\n\\n### Signal Generation Algorithm\\n\\n```mermaid\\nflowchart TD\\n    Start[\\\"calc_history_signal(inst, day, strategy)\\\"]\\n    \\n    LoadData[\\\"Load MainBar data\\u003cbr/\\u003eCalculate ATR, SMA trends\\u003cbr/\\u003eCalculate breakout lines\\\"]\\n    \\n    InitState[\\\"cur_pos = 0\\u003cbr/\\u003elast_trade = None\\\"]\\n    \\n    LoopStart[\\\"For each bar from break_n+1 to end\\\"]\\n    \\n    CheckPos{\\\"Current\\u003cbr/\\u003ePosition?\\\"}\\n    \\n    NoPos[\\\"Position = 0\\\"]\\n    LongPos[\\\"Position \\u003e 0\\u003cbr/\\u003e(Long)\\\"]\\n    ShortPos[\\\"Position \\u003c 0\\u003cbr/\\u003e(Short)\\\"]\\n    \\n    CheckLongEntry{\\\"short_trend \\u003e long_trend\\u003cbr/\\u003eAND\\u003cbr/\\u003eclose \\u003e= high_line?\\\"}\\n    CheckShortEntry{\\\"short_trend \\u003c long_trend\\u003cbr/\\u003eAND\\u003cbr/\\u003eclose \\u003c= low_line?\\\"}\\n    \\n    CheckLongStop{\\\"close \\u003c= HH - ATR * stop_n?\\\"}\\n    CheckShortStop{\\\"close \\u003e= LL + ATR * stop_n?\\\"}\\n    \\n    OpenLong[\\\"Create BUY signal\\u003cbr/\\u003eCreate LONG trade\\u003cbr/\\u003ecur_pos = cur_idx\\\"]\\n    OpenShort[\\\"Create SELL_SHORT signal\\u003cbr/\\u003eCreate SHORT trade\\u003cbr/\\u003ecur_pos = -cur_idx\\\"]\\n    \\n    CloseLong[\\\"Create SELL signal\\u003cbr/\\u003eClose LONG trade\\u003cbr/\\u003eCalculate profit\\u003cbr/\\u003ecur_pos = 0\\\"]\\n    CloseShort[\\\"Create BUY_COVER signal\\u003cbr/\\u003eClose SHORT trade\\u003cbr/\\u003eCalculate profit\\u003cbr/\\u003ecur_pos = 0\\\"]\\n    \\n    CheckEndDay{\\\"Is end\\u003cbr/\\u003eof period?\\\"}\\n    ForceClose[\\\"Force close position\\u003cbr/\\u003eat current open price\\\"]\\n    \\n    Continue[\\\"Continue to next bar\\\"]\\n    End[\\\"End\\\"]\\n    \\n    Start --\\u003e LoadData\\n    LoadData --\\u003e InitState\\n    InitState --\\u003e LoopStart\\n    LoopStart --\\u003e CheckPos\\n    \\n    CheckPos --\\u003e|\\\"= 0\\\"| NoPos\\n    CheckPos --\\u003e|\\\"\\u003e 0\\\"| LongPos\\n    CheckPos --\\u003e|\\\"\\u003c 0\\\"| ShortPos\\n    \\n    NoPos --\\u003e CheckLongEntry\\n    CheckLongEntry --\\u003e|Yes| OpenLong\\n    CheckLongEntry --\\u003e|No| CheckShortEntry\\n    CheckShortEntry --\\u003e|Yes| OpenShort\\n    CheckShortEntry --\\u003e|No| CheckEndDay\\n    \\n    LongPos --\\u003e CheckLongStop\\n    CheckLongStop --\\u003e|Yes| CloseLong\\n    CheckLongStop --\\u003e|No| CheckEndDay\\n    \\n    ShortPos --\\u003e CheckShortStop\\n    CheckShortStop --\\u003e|Yes| CloseShort\\n    CheckShortStop --\\u003e|No| CheckEndDay\\n    \\n    OpenLong --\\u003e CheckEndDay\\n    OpenShort --\\u003e CheckEndDay\\n    CloseLong --\\u003e CheckEndDay\\n    CloseShort --\\u003e CheckEndDay\\n    \\n    CheckEndDay --\\u003e|Yes| ForceClose\\n    CheckEndDay --\\u003e|No| Continue\\n    ForceClose --\\u003e Continue\\n    Continue --\\u003e LoopStart\\n    \\n    LoopStart --\\u003e|Done| End\\n```\\n\\n**Sources:** [trader/utils/__init__.py:500-600]()\\n\\n---\\n\\n### `calc_history_signal(inst: Instrument, day: datetime.datetime, strategy: Strategy)`\\n\\nGenerates historical trading signals for backtesting using ATR-based trend following strategy.\\n\\n**Parameters:**\\n- `inst` (Instrument): The instrument to generate signals for\\n- `day` (datetime.datetime): The end date for signal generation\\n- `strategy` (Strategy): The strategy containing parameters\\n\\n**Strategy Parameters** (from `strategy.param_set`):\\n- `BreakPeriod`: Lookback period for breakout levels\\n- `AtrPeriod`: Period for ATR calculation\\n- `LongPeriod`: Period for long-term trend SMA\\n- `ShortPeriod`: Period for short-term trend SMA\\n- `StopLoss`: Stop-loss multiplier (ATR units)\\n\\n**Algorithm:**\\n\\n1. **Data Preparation:**\\n   - Loads all `MainBar` records up to `day` for the instrument\\n   - Calculates ATR using TA-Lib: `ATR(high, low, close, timeperiod=atr_n)`\\n   - Calculates short-term and long-term trends using exponential moving average\\n   - Calculates breakout lines: `high_line = max(close, break_n)`, `low_line = min(close, break_n)`\\n\\n2. **Entry Signals:**\\n   - **Long Entry:** `short_trend \\u003e long_trend AND close \\u003e= high_line[previous]`\\n   - **Short Entry:** `short_trend \\u003c long_trend AND close \\u003c= low_line[previous]`\\n   - Uses next bar's open price for entry\\n\\n3. **Exit Signals (Stop Loss):**\\n   - **Long Exit:** `close \\u003c= highest_high_since_entry - ATR[entry] * stop_n`\\n   - **Short Exit:** `close \\u003e= lowest_low_since_entry + ATR[entry] * stop_n`\\n   - Uses next bar's open price for exit\\n\\n4. **Database Operations:**\\n   - Creates `Signal` records with `processed=True`, `priority=LOW`\\n   - Creates `Trade` records with entry/exit prices and profit calculations\\n   - Profit calculation: `(exit_price - entry_price) * volume_multiple` for long, inverted for short\\n\\n**Trend Calculation:**\\n```python\\nshort_trend[i] = (short_trend[i-1] * (short_n - 1) + close[i]) / short_n\\nlong_trend[i] = (long_trend[i-1] * (long_n - 1) + close[i]) / long_n\\n```\\n\\n**Sources:** [trader/utils/__init__.py:500-600]()\\n\\n---\\n\\n### `calc_his_all(day: datetime.datetime)`\\n\\nGenerates historical signals for all instruments in the \\\"2.0\\\" strategy up to the specified day.\\n\\n**Parameters:**\\n- `day` (datetime.datetime): The end date for signal generation\\n\\n**Behavior:**\\n- Queries `Strategy.objects.get(name='2.0')`\\n- For each instrument in `strategy.instruments.all()`:\\n  - Finds the last unclosed trade's open time, or last `MainBar` date\\n  - Calls `calc_history_signal(inst, last_day, strategy)`\\n- Prints progress for each instrument\\n\\n**Use Case:**\\nTypically run after data import to generate complete historical signal series for backtesting.\\n\\n**Sources:** [trader/utils/__init__.py:603-614]()\\n\\n---\\n\\n## Price Utility Functions\\n\\nFunctions for price calculations, rounding, and limit price determination.\\n\\n### `str_to_number(s) -\\u003e Union[int, float]`\\n\\nConverts string to number, attempting integer first, then float.\\n\\n**Parameters:**\\n- `s`: String representation of a number (or already a number)\\n\\n**Returns:**\\n- `int` if parseable as integer\\n- `float` if parseable as float but not integer\\n- Original value if not a string\\n\\n**Sources:** [trader/utils/__init__.py:58-64]()\\n\\n---\\n\\n### `price_round(x: Decimal, base: Decimal) -\\u003e float`\\n\\nRounds price to nearest tick size.\\n\\n**Parameters:**\\n- `x` (Decimal): Price to round\\n- `base` (Decimal): Minimum tick size (e.g., 0.2 for stock indices)\\n\\n**Returns:**\\n- `float`: Rounded price\\n\\n**Algorithm:**\\n```python\\nrounded = base * round(x / base)\\nprecision = decimal_places_in(base)\\nreturn round(rounded, precision)\\n```\\n\\n**Examples:**\\n- `price_round(1.3, 0.2)`  `1.2`\\n- `price_round(1.5, 0.2)`  `1.4`\\n- `price_round(1234.567, 1)`  `1235.0`\\n\\n**Sources:** [trader/utils/__init__.py:67-84]()\\n\\n---\\n\\n### `get_next_id() -\\u003e int`\\n\\nGenerates sequential request IDs for CTP API calls, cycling from 1 to 65535.\\n\\n**Returns:**\\n- `int`: Next request ID (1-65535)\\n\\n**Behavior:**\\n- Uses function attribute `get_next_id.request_id` for state persistence\\n- Automatically resets to 1 after reaching 65535\\n- Thread-safe within single process (not distributed-safe)\\n\\n**Sources:** [trader/utils/__init__.py:87-91]()\\n\\n---\\n\\n### `calc_his_up_limit(inst: Instrument, bar: DailyBar) -\\u003e Decimal`\\n\\nCalculates the upper limit price for a contract based on previous settlement.\\n\\n**Parameters:**\\n- `inst` (Instrument): Instrument with `up_limit_ratio` and `price_tick`\\n- `bar` (DailyBar): Previous day's bar with settlement price\\n\\n**Returns:**\\n- `Decimal`: Upper limit price (one tick below theoretical limit)\\n\\n**Formula:**\\n```python\\ntheoretical_limit = bar.settlement * (1 + inst.up_limit_ratio)\\nrounded_limit = price_round(theoretical_limit, inst.price_tick)\\nreturn rounded_limit - inst.price_tick\\n```\\n\\n**Note:** Subtracts one tick to ensure price is tradeable (exchange limits are often not inclusive).\\n\\n**Sources:** [trader/utils/__init__.py:617-621]()\\n\\n---\\n\\n### `calc_his_down_limit(inst: Instrument, bar: DailyBar) -\\u003e Decimal`\\n\\nCalculates the lower limit price for a contract based on previous settlement.\\n\\n**Parameters:**\\n- `inst` (Instrument): Instrument with `down_limit_ratio` and `price_tick`\\n- `bar` (DailyBar): Previous day's bar with settlement price\\n\\n**Returns:**\\n- `Decimal`: Lower limit price (one tick above theoretical limit)\\n\\n**Formula:**\\n```python\\ntheoretical_limit = bar.settlement * (1 - inst.down_limit_ratio)\\nrounded_limit = price_round(theoretical_limit, inst.price_tick)\\nreturn rounded_limit + inst.price_tick\\n```\\n\\n**Sources:** [trader/utils/__init__.py:624-628]()\\n\\n---\\n\\n### `calc_sma(price: Iterable, period: int) -\\u003e float`\\n\\nCalculates Simple Moving Average using recursive formula.\\n\\n**Parameters:**\\n- `price`: Iterable of price values\\n- `period` (int): SMA period\\n\\n**Returns:**\\n- `float`: Final SMA value\\n\\n**Formula:**\\n```\\nSMA[i] = ((period - 1) * SMA[i-1] + price[i]) / period\\n```\\n\\nUses `functools.reduce()` for efficient calculation.\\n\\n**Sources:** [trader/utils/__init__.py:461-462]()\\n\\n---\\n\\n## Trading Day Functions\\n\\nFunctions for validating and checking trading days.\\n\\n### `is_trading_day(day: datetime.datetime) -\\u003e (datetime.datetime, bool)`\\n\\nChecks if a day is a trading day using Redis cache.\\n\\n**Parameters:**\\n- `day` (datetime.datetime): Date to check\\n\\n**Returns:**\\n- `tuple`: `(day, is_trading: bool)`\\n\\n**Behavior:**\\n- Connects to Redis using config from `[REDIS]` section\\n- Checks if `day.strftime('%Y%m%d')` matches `TradingDay` or `LastTradingDay` keys\\n- These keys are typically set by the CTP trading system\\n\\n**Async:** Must be awaited\\n\\n**Sources:** [trader/utils/__init__.py:94-98]()\\n\\n---\\n\\n### `check_trading_day(day: datetime.datetime) -\\u003e (datetime.datetime, bool)`\\n\\nVerifies if a day is a trading day by checking CFFEX website availability.\\n\\n**Parameters:**\\n- `day` (datetime.datetime): Date to check\\n\\n**Returns:**\\n- `tuple`: `(day, is_trading: bool)`\\n\\n**Behavior:**\\n- Makes HTTP GET to `http://www.cffex.com.cn/fzjy/mrhq/{YYYY}MM/{DD}/index.xml`\\n- Uses `allow_redirects=False` to detect redirects (non-trading days)\\n- Returns `True` if response status is 200, `False` otherwise\\n- Uses semaphore `max_conn_cffex` (limit: 15)\\n\\n**Async:** Must be awaited\\n\\n**Use Case:** Used by `fetch_bar()` to filter date ranges before fetching data.\\n\\n**Sources:** [trader/utils/__init__.py:101-108]()\\n\\n---\\n\\n## Contract Limit Functions\\n\\nFunctions for fetching and storing daily limit ratios from exchanges.\\n\\n### `get_contracts_argument(day: datetime.datetime = None) -\\u003e bool`\\n\\nFetches trading parameters (limit ratios, margins) from all exchanges and stores in Redis and database.\\n\\n**Parameters:**\\n- `day` (datetime.datetime, optional): Trading day to fetch parameters for (defaults to today)\\n\\n**Returns:**\\n- `bool`: `True` if successful, `False` on error\\n\\n**Data Sources:**\\n\\n| Exchange | URL | Data Format |\\n|----------|-----|-------------|\\n| SHFE | `http://www.shfe.com.cn/data/busiparamdata/future/ContractDailyTradeArgument{YYYYMMDD}.dat` | JSON |\\n| DCE | `http://www.dce.com.cn/publicweb/notificationtips/exportDayTradPara.html` (POST) | Text |\\n| CZCE | `http://www.czce.com.cn/cn/DFSStaticFiles/Future/{YEAR}/{YYYYMMDD}/FutureDataClearParams.txt` | Text |\\n| CFFEX | `http://www.cffex.com.cn/sj/jycs/{YYYYMM}/{DD}/index.xml` | XML |\\n\\n**Behavior:**\\n\\n1. **Fetch from Each Exchange:**\\n   - Parses exchange-specific formats to extract limit ratios\\n   - Stores in Redis: `LIMITRATIO:{exchange}:{product_code}:{contract_code}`  `{ratio}`\\n\\n2. **Update Database:**\\n   - For each `Instrument`, retrieves ratio from Redis\\n   - Updates `inst.up_limit_ratio` and `inst.down_limit_ratio`\\n   - Saves to database\\n\\n**SHFE JSON Structure:**\\n```json\\n{\\n  \\\"INSTRUMENTID\\\": \\\"cu2201\\\",\\n  \\\"UPPER_VALUE\\\": \\\".08000000\\\",\\n  \\\"LOWER_VALUE\\\": \\\".08000000\\\",\\n  \\\"TRADINGDAY\\\": \\\"20211217\\\"\\n}\\n```\\n\\n**DCE Text Format:**\\n```\\n () ...   \\na2201 0.12 ... 0.08 6,561 5,589\\n```\\n\\n**CZCE Text Format:**\\n```\\n,,...,(%),,...\\nAP201,8,148.00,...,9,5.00,...\\n```\\n\\n**CFFEX XML Structure:**\\n```xml\\n\\u003cINDEX\\u003e\\n  \\u003cINSTRUMENT_ID\\u003eIC2112\\u003c/INSTRUMENT_ID\\u003e\\n  \\u003cUPPER_VALUE\\u003e0.1\\u003c/UPPER_VALUE\\u003e\\n  \\u003cLOWER_VALUE\\u003e0.1\\u003c/LOWER_VALUE\\u003e\\n\\u003c/INDEX\\u003e\\n```\\n\\n**Note:** GFEX is not currently supported (marked as TODO in code).\\n\\n**Sources:** [trader/utils/__init__.py:685-796]()\\n\\n---\\n\\n### `get_expire_date(inst_code: str, day: datetime.datetime) -\\u003e int`\\n\\nExtracts and normalizes expire date from contract code.\\n\\n**Parameters:**\\n- `inst_code` (str): Contract code (e.g., \\\"CF601\\\", \\\"cu2201\\\")\\n- `day` (datetime.datetime): Current date for year inference\\n\\n**Returns:**\\n- `int`: Normalized expire date in YYMM format\\n\\n**Algorithm:**\\n- Extracts numeric portion from contract code\\n- If \\u003c 1000: Infers century from current year's decade digit\\n- Handles year boundary (if current year ends in 9 and expire \\u003c 100, add 10 to decade)\\n- Examples:\\n  - \\\"CF601\\\" on 2020-01-01  2601\\n  - \\\"cu2201\\\" on 2021-12-01  2201\\n\\n**Sources:** [trader/utils/__init__.py:111-118]()\\n\\n---\\n\\n### `is_auction_time(inst: Instrument, status: dict) -\\u003e bool`\\n\\nDetermines if current time is during auction period for an instrument.\\n\\n**Parameters:**\\n- `inst` (Instrument): Instrument with `exchange` and `night_trade` properties\\n- `status` (dict): Instrument status with `InstrumentStatus` key\\n\\n**Returns:**\\n- `bool`: `True` if in auction period\\n\\n**Logic:**\\n- If `status['InstrumentStatus'] != ApiStruct.IS_AuctionOrdering`: return `False`\\n- If `inst.exchange == ExchangeType.CFFEX`: return `True` (CFFEX uses longer auction)\\n- If `inst.night_trade` and current hour is 20: return `True` (night session auction at 20:55)\\n- If not `inst.night_trade` and current hour is 8: return `True` (day session auction at 8:55)\\n- Otherwise: return `False`\\n\\n**Sources:** [trader/utils/__init__.py:447-458]()\\n\\n---\\n\\n## Data Management Functions\\n\\nFunctions for data cleanup, import, and maintenance.\\n\\n### `clean_daily_bar()`\\n\\nRemoves `DailyBar` records for non-trading days within a specified date range.\\n\\n**Behavior:**\\n- Date range: 2010-04-16 to 2016-01-18 (hardcoded in function)\\n- Generates tasks to check each day using `is_trading_day()`\\n- Deletes all `DailyBar` records where `trading=False`\\n- Uses `tqdm` progress bar\\n\\n**Async:** Must be awaited\\n\\n**Use Case:** Data cleanup after bulk import.\\n\\n**Sources:** [trader/utils/__init__.py:631-646]()\\n\\n---\\n\\n### `load_kt_data(directory: str = r'D:\\\\test') -\\u003e bool`\\n\\nImports historical main contract data from Kingstar data files.\\n\\n**Parameters:**\\n- `directory` (str): Path to directory containing .txt files\\n\\n**Returns:**\\n- `bool`: `True` if successful, `False` on error\\n\\n**File Format:** `PK99.txt`\\n```\\n1210224,10944.000  ,10992.000  ,10758.000  ,10904.000  ,10702.000  ,42202  ,20897  ,PK2110\\n```\\n\\nFields: `date(YDDDMM), open, high, low, close, settlement, open_interest, volume, main_code`\\n\\n**Behavior:**\\n- Filename format: `{product_code}99.txt`\\n- Date conversion: `YDDDMM`  `YYYY-MM-DD` (Y: years since 1900, DDD: day of year)\\n- Detects main contract changes by comparing consecutive `main_code` values\\n- Bulk creates `MainBar` records using `MainBar.objects.bulk_create()`\\n- Updates `Instrument` with `last_main`, `main_code`, `change_time`\\n\\n**Sources:** [trader/utils/__init__.py:649-681]()\\n\\n---\\n\\n## Analysis Functions\\n\\nFunctions for portfolio analysis and correlation calculations.\\n\\n### `calc_corr(day: datetime.datetime) -\\u003e pd.DataFrame`\\n\\nCalculates correlation matrix of daily returns for all instruments in \\\"2.0\\\" strategy.\\n\\n**Parameters:**\\n- `day` (datetime.datetime): End date for calculation\\n\\n**Returns:**\\n- `pd.DataFrame`: Correlation matrix (product_code  product_code)\\n\\n**Behavior:**\\n- Lookback period: 3 years from `day`\\n- Loads `MainBar` close prices for each instrument\\n- Calculates daily returns: `pct_change()`\\n- Returns correlation matrix using `pd.DataFrame.corr()`\\n\\n**Sources:** [trader/utils/__init__.py:465-475]()\\n\\n---\\n\\n### `find_best_score(n: int = 20)`\\n\\nFinds the best and worst portfolio combinations of `n` instruments based on correlation scores.\\n\\n**Parameters:**\\n- `n` (int): Number of instruments in each combination (default: 20)\\n\\n**Behavior:**\\n- Calculates correlation matrix using `calc_corr()`\\n- Iterates through all combinations of `n` instruments (nCr)\\n- For each combination:\\n  - Extracts pairwise correlations\\n  - Calculates score: `((1 - avg(abs(corr)^2)) * 100 - 50) * 2`\\n  - Lower correlation  Higher score (better diversification)\\n- Prints top 3 and bottom 3 scoring combinations\\n- Uses `tqdm` progress bar\\n\\n**Complexity:** O(nCr(total_instruments, n)) - computationally expensive\\n\\n**Note:** Comment in code warns this takes ~100 years for large portfolios at 5 combinations/second.\\n\\n**Sources:** [trader/utils/__init__.py:483-497]()\\n\\n---\\n\\n### `nCr(n: int, r: int) -\\u003e float`\\n\\nCalculates binomial coefficient (n choose r).\\n\\n**Parameters:**\\n- `n` (int): Total items\\n- `r` (int): Items to choose\\n\\n**Returns:**\\n- `float`: Number of combinations = n! / (r! * (n-r)!)\\n\\n**Sources:** [trader/utils/__init__.py:478-480]()\\n\\n---\\n\\n## Orchestration Functions\\n\\nHigh-level functions that coordinate data fetching workflows.\\n\\n### `fetch_bar()`\\n\\nFetches daily market data for all exchanges over a 365-day period using parallel async execution.\\n\\n**Behavior:**\\n\\n1. **Check Trading Days:**\\n   - Date range: today - 365 days to today\\n   - Creates tasks: `check_trading_day()` for each day\\n   - Collects list of `(day, is_trading)` tuples\\n\\n2. **Fetch Data:**\\n   - For each trading day, creates 4 async tasks:\\n     - `update_from_shfe(day)`\\n     - `update_from_dce(day)`\\n     - `update_from_czce(day)`\\n     - `update_from_cffex(day)`\\n   - Executes all tasks concurrently\\n   - Uses `tqdm` progress bars for both phases\\n\\n**Async:** Must be awaited\\n\\n**Use Case:** Bulk data import or historical data refresh.\\n\\n**Sources:** [trader/utils/fetch_data.py:24-46]()\\n\\n---\\n\\n### `fetch_bar2()`\\n\\nSequential version of `fetch_bar()` that processes one day at a time.\\n\\n**Behavior:**\\n- Checks if each day is a trading day\\n- If trading day:\\n  - Prints \\\"process {day}\\\"\\n  - Creates 4 async tasks for exchange updates\\n  - Waits for all tasks to complete before moving to next day\\n- Processes days sequentially (day by day)\\n\\n**Async:** Must be awaited\\n\\n**Use Case:** When rate limiting or sequential processing is preferred.\\n\\n**Sources:** [trader/utils/fetch_data.py:49-64]()\\n\\n---\\n\\n## Module Constants\\n\\nKey constants and semaphores defined at module level:\\n\\n| Constant | Value | Purpose |\\n|----------|-------|---------|\\n| `max_conn_shfe` | `asyncio.Semaphore(15)` | Limits concurrent SHFE requests |\\n| `max_conn_dce` | `asyncio.Semaphore(5)` | Limits concurrent DCE requests |\\n| `max_conn_gfex` | `asyncio.Semaphore(5)` | Limits concurrent GFEX requests |\\n| `max_conn_czce` | `asyncio.Semaphore(15)` | Limits concurrent CZCE requests |\\n| `max_conn_cffex` | `asyncio.Semaphore(15)` | Limits concurrent CFFEX requests |\\n| `max_conn_sina` | `asyncio.Semaphore(15)` | Limits concurrent Sina Finance requests |\\n| `cffex_ip` | `'www.cffex.com.cn'` | CFFEX API domain |\\n| `shfe_ip` | `'www.shfe.com.cn'` | SHFE API domain |\\n| `czce_ip` | `'www.czce.com.cn'` | CZCE API domain |\\n| `dce_ip` | `'www.dce.com.cn'` | DCE API domain |\\n| `gfex_ip` | `'www.gfex.com.cn'` | GFEX API domain |\\n| `IGNORE_INST_LIST` | Config value | Product codes to skip during data fetch |\\n| `INE_INST_LIST` | `['sc', 'bc', 'nr', 'lu']` | Products traded on INE exchange |\\n| `ORDER_REF_SIGNAL_ID_START` | `-5` | Starting offset for OrderRef to Signal ID mapping |\\n\\n**Sources:** [trader/utils/__init__.py:42-55]()\\n\\n---\\n\\n## Integration with Django Models\\n\\n```mermaid\\ngraph TB\\n    subgraph \\\"Utility Functions\\\"\\n        UpdateFuncs[\\\"update_from_*()\\\"]\\n        CalcMain[\\\"calc_main_inst()\\\"]\\n        CalcSignal[\\\"calc_history_signal()\\\"]\\n        GetLimit[\\\"get_contracts_argument()\\\"]\\n    end\\n    \\n    subgraph \\\"Django Models\\\"\\n        DailyBar[\\\"DailyBar\\u003cbr/\\u003eexchange, code, time\\u003cbr/\\u003eopen, high, low, close\\u003cbr/\\u003esettlement, volume, OI\\\"]\\n        \\n        MainBar[\\\"MainBar\\u003cbr/\\u003eexchange, product_code, time\\u003cbr/\\u003ecode, OHLC, basis\\\"]\\n        \\n        Instrument[\\\"Instrument\\u003cbr/\\u003eproduct_code, exchange\\u003cbr/\\u003emain_code, last_main\\u003cbr/\\u003eup_limit_ratio, price_tick\\\"]\\n        \\n        Signal[\\\"Signal\\u003cbr/\\u003ecode, strategy, instrument\\u003cbr/\\u003etype, price, volume\\u003cbr/\\u003etrigger_time, processed\\\"]\\n        \\n        Trade[\\\"Trade\\u003cbr/\\u003ebroker, strategy, instrument\\u003cbr/\\u003edirection, open_time, close_time\\u003cbr/\\u003eavg_entry_price, profit\\\"]\\n        \\n        Strategy[\\\"Strategy\\u003cbr/\\u003ename, instruments\\u003cbr/\\u003eparam_set\\\"]\\n    end\\n    \\n    subgraph \\\"External Data\\\"\\n        Exchanges[\\\"5 Exchanges\\u003cbr/\\u003eSHFE, DCE, CZCE\\u003cbr/\\u003eCFFEX, GFEX\\\"]\\n    end\\n    \\n    Exchanges --\\u003e|\\\"HTTP/HTTPS\\\"| UpdateFuncs\\n    UpdateFuncs --\\u003e|\\\"Create/Update\\\"| DailyBar\\n    \\n    DailyBar --\\u003e|\\\"Query by volume/OI\\\"| CalcMain\\n    CalcMain --\\u003e|\\\"Create/Update\\\"| MainBar\\n    CalcMain --\\u003e|\\\"Update main_code\\\"| Instrument\\n    \\n    MainBar --\\u003e|\\\"Load OHLC data\\\"| CalcSignal\\n    Strategy --\\u003e|\\\"Load parameters\\\"| CalcSignal\\n    Instrument --\\u003e|\\\"Product info\\\"| CalcSignal\\n    CalcSignal --\\u003e|\\\"Create\\\"| Signal\\n    CalcSignal --\\u003e|\\\"Create\\\"| Trade\\n    \\n    Exchanges --\\u003e|\\\"HTTP/HTTPS\\\"| GetLimit\\n    GetLimit --\\u003e|\\\"Update limit_ratio\\\"| Instrument\\n```\\n\\n**Sources:** [trader/utils/__init__.py:121-796]()\\n\\n---\\n\\n## Usage Examples\\n\\n### Example 1: Fetch Data for a Single Day\\n\\n```python\\nimport asyncio\\nfrom django.utils import timezone\\nfrom trader.utils import update_from_shfe, update_from_dce\\n\\nasync def fetch_today():\\n    day = timezone.localtime()\\n    \\n    # Fetch from all exchanges concurrently\\n    results = await asyncio.gather(\\n        update_from_shfe(day),\\n        update_from_dce(day),\\n        update_from_czce(day),\\n        update_from_cffex(day),\\n        update_from_gfex(day)\\n    )\\n    \\n    success_count = sum(results)\\n    print(f\\\"Successfully fetched from {success_count}/5 exchanges\\\")\\n\\nasyncio.run(fetch_today())\\n```\\n\\n### Example 2: Calculate Main Contract\\n\\n```python\\nfrom django.utils import timezone\\nfrom panel.models import Instrument\\nfrom trader.utils import calc_main_inst\\n\\n# Calculate main contract for copper (cu)\\ninst = Instrument.objects.get(product_code='cu')\\nday = timezone.localtime()\\n\\nmain_code, updated = calc_main_inst(inst, day)\\n\\nif updated:\\n    print(f\\\"Main contract changed to {main_code}\\\")\\nelse:\\n    print(f\\\"Main contract remains {main_code}\\\")\\n```\\n\\n### Example 3: Generate Historical Signals\\n\\n```python\\nfrom django.utils import timezone\\nfrom panel.models import Instrument, Strategy\\nfrom trader.utils import calc_history_signal\\n\\nstrategy = Strategy.objects.get(name='2.0')\\ninst = Instrument.objects.get(product_code='rb')\\nday = timezone.localtime()\\n\\n# Generate signals from beginning to today\\ncalc_history_signal(inst, day, strategy)\\n\\n# Check generated signals\\nsignals = inst.signal_set.filter(processed=True).count()\\nprint(f\\\"Generated {signals} historical signals for {inst.name}\\\")\\n```\\n\\n### Example 4: Rebuild All Main Contracts\\n\\n```python\\nfrom trader.utils import create_main_all\\n\\n# Rebuild all main contract series\\n# (processes all instruments in database)\\ncreate_main_all()\\n```\\n\\n**Sources:** [trader/utils/__init__.py:121-614]()\\n\\n---\\n\\n## Error Handling\\n\\nAll exchange update functions follow consistent error handling:\\n\\n```python\\ntry:\\n    # Fetch and process data\\n    async with aiohttp.ClientSession() as session:\\n        async with session.get(url) as response:\\n            # Parse and store data\\n    return True\\nexcept Exception as e:\\n    logger.warning(f'update_from_xxx failed: {repr(e)}', exc_info=True)\\n    return False\\n```\\n\\n**Key Points:**\\n- Functions return `bool` to indicate success/failure\\n- Exceptions are logged with full traceback using `exc_info=True`\\n- Logger name: `'utils'`\\n- Caller should check return value and implement retry logic if needed\\n\\n**Sources:** [trader/utils/__init__.py:172-174,216-217,264-265,291-292,348-349]()\\n\\n---\\n\\n## Performance Considerations\\n\\n### Semaphore Limits\\n\\nConnection semaphores prevent overwhelming exchange servers:\\n\\n| Exchange | Limit | Rationale |\\n|----------|-------|-----------|\\n| SHFE | 15 | Large exchange, handles more concurrent connections |\\n| DCE | 5 | More conservative rate limiting |\\n| GFEX | 5 | Smaller exchange, fewer resources |\\n| CZCE | 15 | Can handle higher concurrency |\\n| CFFEX | 15 | Financial futures exchange with robust infrastructure |\\n\\n### Optimization Strategies\\n\\n1. **Bulk Operations:**\\n   - `MainBar.objects.bulk_create()` for batch inserts [trader/utils/__init__.py:675]()\\n   - Django F() expressions for bulk updates [trader/utils/__init__.py:376-378]()\\n\\n2. **Async/Await:**\\n   - All exchange update functions are async\\n   - Use `asyncio.gather()` or `asyncio.wait()` for concurrent execution\\n\\n3. **Database Queries:**\\n   - Use `update_or_create()` to avoid separate existence checks\\n   - Use `.values_list()` when only specific fields are needed\\n   - Use `.order_by('-volume')` with `.first()` instead of loading all records\\n\\n**Sources:** [trader/utils/__init__.py:42-47,121-349,675-676]()\"])</script><script>self.__next_f.push([1,\"3f:T7624,\"])</script><script>self.__next_f.push([1,\"# Django Models API\\n\\n\\u003cdetails\\u003e\\n\\u003csummary\\u003eRelevant source files\\u003c/summary\\u003e\\n\\nThe following files were used as context for generating this wiki page:\\n\\n- [panel/const.py](panel/const.py)\\n- [panel/models.py](panel/models.py)\\n\\n\\u003c/details\\u003e\\n\\n\\n\\nThis page provides complete API reference documentation for all Django models in the trader system. These models define the database schema and provide the ORM interface for all data persistence operations.\\n\\nFor information about how these models are used in trading logic, see [TradeStrategy API](#10.1). For details on how market data flows into these models, see [Exchange Data Acquisition](#5.2) and [Main Contract Calculation](#5.3). For the enumeration constants used by these models, see [Constants and Enumerations](#7.2).\\n\\n## Overview\\n\\nThe system defines **12 Django models** organized into four functional categories:\\n\\n| Category | Models | Purpose |\\n|----------|--------|---------|\\n| **Configuration** | `Address`, `Broker`, `Strategy`, `Param` | System setup and account configuration |\\n| **Market Data** | `Instrument`, `DailyBar`, `MainBar` | Product definitions and historical price data |\\n| **Trading Operations** | `Signal`, `Order`, `Trade` | Signal generation, order execution, position tracking |\\n| **Performance** | `Performance` | Daily NAV and equity tracking |\\n| **Utility** | `Autonumber` | Auto-incrementing ID generation |\\n\\nAll models are located in [panel/models.py:1-289]() and use constants defined in [panel/const.py:1-178]().\\n\\n## Model Relationship Diagram\\n\\n```mermaid\\ngraph TB\\n    Address[\\\"Address\\\"]\\n    Broker[\\\"Broker\\\"]\\n    Strategy[\\\"Strategy\\\"]\\n    Param[\\\"Param\\\"]\\n    Instrument[\\\"Instrument\\\"]\\n    Signal[\\\"Signal\\\"]\\n    Order[\\\"Order\\\"]\\n    Trade[\\\"Trade\\\"]\\n    Performance[\\\"Performance\\\"]\\n    DailyBar[\\\"DailyBar\\\"]\\n    MainBar[\\\"MainBar\\\"]\\n    \\n    Broker --\\u003e|\\\"trade_address\\\"| Address\\n    Broker --\\u003e|\\\"market_address\\\"| Address\\n    \\n    Performance --\\u003e|\\\"broker\\\"| Broker\\n    Strategy --\\u003e|\\\"broker\\\"| Broker\\n    \\n    Strategy -.-\\u003e|\\\"instruments (M2M)\\\"| Instrument\\n    Strategy -.-\\u003e|\\\"force_opens (M2M)\\\"| Instrument\\n    \\n    Param --\\u003e|\\\"strategy\\\"| Strategy\\n    \\n    Signal --\\u003e|\\\"strategy\\\"| Strategy\\n    Signal --\\u003e|\\\"instrument\\\"| Instrument\\n    \\n    Order --\\u003e|\\\"broker\\\"| Broker\\n    Order --\\u003e|\\\"strategy\\\"| Strategy\\n    Order --\\u003e|\\\"instrument\\\"| Instrument\\n    Order --\\u003e|\\\"signal (1:1)\\\"| Signal\\n    \\n    Trade --\\u003e|\\\"broker\\\"| Broker\\n    Trade --\\u003e|\\\"strategy\\\"| Strategy\\n    Trade --\\u003e|\\\"instrument\\\"| Instrument\\n    Trade --\\u003e|\\\"open_order (1:1)\\\"| Order\\n    Trade --\\u003e|\\\"close_order (1:1)\\\"| Order\\n    \\n    style Broker fill:#f9f9f9\\n    style Strategy fill:#f9f9f9\\n    style Signal fill:#fff3cd\\n    style Order fill:#fff3cd\\n    style Trade fill:#fff3cd\\n```\\n\\n**Sources:** [panel/models.py:42-289]()\\n\\n## Data Flow Through Models\\n\\n```mermaid\\nflowchart LR\\n    ExchangeAPI[\\\"Exchange APIs\\u003cbr/\\u003e(SHFE, DCE, CZCE,\\u003cbr/\\u003eCFFEX, GFEX)\\\"]\\n    \\n    DailyBar[\\\"DailyBar\\u003cbr/\\u003eIndividual contracts\\u003cbr/\\u003eOHLCV data\\\"]\\n    \\n    MainBar[\\\"MainBar\\u003cbr/\\u003eContinuous series\\u003cbr/\\u003eMain contract only\\\"]\\n    \\n    Instrument[\\\"Instrument\\u003cbr/\\u003eProduct metadata\\u003cbr/\\u003emain_code field\\\"]\\n    \\n    Signal[\\\"Signal\\u003cbr/\\u003eBUY, SELL,\\u003cbr/\\u003eROLL signals\\\"]\\n    \\n    Order[\\\"Order\\u003cbr/\\u003eCTP order\\u003cbr/\\u003erequests\\\"]\\n    \\n    Trade[\\\"Trade\\u003cbr/\\u003ePosition \\u0026\\u003cbr/\\u003eP\\u0026L tracking\\\"]\\n    \\n    ExchangeAPI --\\u003e|\\\"update_from_*\\\"| DailyBar\\n    DailyBar --\\u003e|\\\"calc_main_inst\\\"| Instrument\\n    DailyBar --\\u003e|\\\"calc_main_inst\\\"| MainBar\\n    MainBar --\\u003e|\\\"calc_signal\\\"| Signal\\n    Signal --\\u003e|\\\"processing_signal\\\"| Order\\n    Order --\\u003e|\\\"OnRtnTrade\\\"| Trade\\n    \\n    Instrument -.-\\u003e|\\\"references\\\"| Signal\\n    Instrument -.-\\u003e|\\\"references\\\"| Order\\n    Instrument -.-\\u003e|\\\"references\\\"| Trade\\n```\\n\\n**Sources:** [panel/models.py:146-289](), Diagram 2 from system architecture\\n\\n## Utility Functions\\n\\n### to_df()\\n\\nConverts a Django QuerySet to a pandas DataFrame.\\n\\n```python\\ndef to_df(queryset, index_col=None, parse_dates=None):\\n    \\\"\\\"\\\"\\n    Convert Django QuerySet to pandas DataFrame\\n    \\n    Args:\\n        queryset: django.db.models.query.QuerySet\\n        index_col: str or list of str, optional column(s) to use as index\\n        parse_dates: list or dict of columns to parse as dates\\n        \\n    Returns:\\n        pandas.DataFrame\\n    \\\"\\\"\\\"\\n```\\n\\n**Parameters:**\\n\\n| Parameter | Type | Description |\\n|-----------|------|-------------|\\n| `queryset` | `QuerySet` | Django queryset to convert |\\n| `index_col` | `str` or `list`, optional | Column name(s) to set as DataFrame index |\\n| `parse_dates` | `list` or `dict`, optional | Columns to parse as datetime objects |\\n\\n**Returns:** `pandas.DataFrame` with queryset data\\n\\n**Behavior:** Returns empty DataFrame if queryset would produce no results (handles `EmptyResultSet` exception).\\n\\n**Usage Example:**\\n```python\\n# Convert DailyBar queryset to DataFrame\\nbars = DailyBar.objects.filter(code='rb2405')\\ndf = to_df(bars, index_col='time', parse_dates=['time'])\\n```\\n\\n**Sources:** [panel/models.py:25-39]()\\n\\n## Configuration Models\\n\\n### Autonumber\\n\\nSimple auto-incrementing counter model for generating unique identifiers.\\n\\n**Fields:**\\n\\n| Field | Type | Constraints | Description |\\n|-------|------|-------------|-------------|\\n| `id` | `AutoField` | Primary Key | Auto-incrementing ID value |\\n| `create_date` | `DateTimeField` | `auto_now_add=True` | Timestamp when record was created |\\n\\n**Meta:**\\n- No explicit verbose name or table configuration\\n\\n**Methods:**\\n- Inherits default Django model methods only\\n\\n**Sources:** [panel/models.py:42-44]()\\n\\n---\\n\\n### Address\\n\\nStores CTP trading and market data server addresses for broker connections.\\n\\n**Fields:**\\n\\n| Field | Type | Constraints | Description |\\n|-------|------|-------------|-------------|\\n| `name` | `CharField` | `max_length=64` | Display name for this address |\\n| `url` | `CharField` | `max_length=128` | Connection URL (e.g., `tcp://180.168.146.187:10130`) |\\n| `type` | `CharField` | `max_length=16`, choices: `AddressType` | Either `TRADE` or `MARKET` |\\n| `operator` | `CharField` | `max_length=16`, choices: `OperatorType` | Network operator: `TELECOM` or `UNICOM` |\\n\\n**Meta:**\\n- `verbose_name = ''`\\n- `verbose_name_plural = ''`\\n\\n**Methods:**\\n\\n| Method | Returns | Description |\\n|--------|---------|-------------|\\n| `__str__()` | `str` | Format: `{name}{operator}-{type}` |\\n\\n**Constants Used:** `AddressType`, `OperatorType` from [panel/const.py:55-63]()\\n\\n**Sources:** [panel/models.py:47-59]()\\n\\n---\\n\\n### Broker\\n\\nRepresents a trading account with connection details, credentials, and account balance information.\\n\\n**Fields:**\\n\\n| Field | Type | Constraints | Description |\\n|-------|------|-------------|-------------|\\n| `name` | `CharField` | `max_length=64` | Account display name |\\n| `contract_type` | `CharField` | `max_length=32`, choices: `ContractType` | Market type: `STOCK`, `FUTURE`, or `OPTION` |\\n| `trade_address` | `ForeignKey` | ` Address`, `related_name='trade_address'` | CTP trading server address |\\n| `market_address` | `ForeignKey` | ` Address`, `related_name='market_address'` | CTP market data server address |\\n| `identify` | `CharField` | `max_length=32` | Broker identifier (BrokerID in CTP) |\\n| `username` | `CharField` | `max_length=32` | CTP account username |\\n| `password` | `CharField` | `max_length=32` | CTP account password |\\n| `fake` | `DecimalField` | `max_digits=12, decimal_places=2`, nullable | Virtual capital for simulation |\\n| `cash` | `DecimalField` | `max_digits=12, decimal_places=2`, nullable | Available cash (updated by `refresh_all()`) |\\n| `current` | `DecimalField` | `max_digits=12, decimal_places=2`, nullable | Current equity () |\\n| `pre_balance` | `DecimalField` | `max_digits=12, decimal_places=2`, nullable | Previous balance () |\\n| `margin` | `DecimalField` | `max_digits=12, decimal_places=2`, nullable | Used margin |\\n\\n**Meta:**\\n- `verbose_name = ''`\\n- `verbose_name_plural = ''`\\n\\n**Methods:**\\n\\n| Method | Returns | Description |\\n|--------|---------|-------------|\\n| `__str__()` | `str` | Format: `{name}-{contract_type}` |\\n\\n**Constants Used:** `ContractType` from [panel/const.py:19-22]()\\n\\n**Related Models:** \\n- Referenced by: `Performance`, `Strategy`, `Order`, `Trade`\\n- References: `Address` (two foreign keys)\\n\\n**Update Schedule:** Account balances are refreshed daily by `TradeStrategy.refresh_all()` at market close (15:20).\\n\\n**Sources:** [panel/models.py:61-83]()\\n\\n---\\n\\n### Performance\\n\\nTracks daily portfolio performance metrics including NAV, equity, and margin usage.\\n\\n**Fields:**\\n\\n| Field | Type | Constraints | Description |\\n|-------|------|-------------|-------------|\\n| `broker` | `ForeignKey` | ` Broker` | Account this performance record belongs to |\\n| `day` | `DateField` | | Trading day for this snapshot |\\n| `capital` | `DecimalField` | `max_digits=12, decimal_places=2` | Total capital |\\n| `unit_count` | `IntegerField` | nullable | Number of fund units |\\n| `NAV` | `DecimalField` | `max_digits=8, decimal_places=3`, nullable | Net Asset Value per unit |\\n| `accumulated` | `DecimalField` | `max_digits=8, decimal_places=3`, nullable | Accumulated NAV |\\n| `dividend` | `DecimalField` | `max_digits=12, decimal_places=2`, nullable | Dividend amount |\\n| `used_margin` | `DecimalField` | `max_digits=12, decimal_places=2`, nullable | Total margin in use |\\n| `fake` | `DecimalField` | `max_digits=12, decimal_places=2`, nullable | Virtual capital component |\\n\\n**Meta:**\\n- `verbose_name = ''`\\n- `verbose_name_plural = ''`\\n\\n**Methods:**\\n\\n| Method | Returns | Description |\\n|--------|---------|-------------|\\n| `__str__()` | `str` | Format: `{broker}-{NAV}` |\\n\\n**Usage:** Daily snapshots are created after market close to track portfolio value over time. Used for equity curve analysis and performance reporting.\\n\\n**Sources:** [panel/models.py:85-102]()\\n\\n---\\n\\n### Strategy\\n\\nDefines a trading strategy configuration linking a broker account to instruments.\\n\\n**Fields:**\\n\\n| Field | Type | Constraints | Description |\\n|-------|------|-------------|-------------|\\n| `broker` | `ForeignKey` | ` Broker` | Account executing this strategy |\\n| `name` | `CharField` | `max_length=64` | Strategy name |\\n| `instruments` | `ManyToManyField` | ` Instrument` | Products this strategy trades |\\n| `force_opens` | `ManyToManyField` | ` Instrument`, `related_name='force_opens'` | Manual override for opening positions |\\n\\n**Meta:**\\n- `verbose_name = ''`\\n- `verbose_name_plural = ''`\\n\\n**Methods:**\\n\\n| Method | Returns | Description |\\n|--------|---------|-------------|\\n| `__str__()` | `str` | Returns strategy name |\\n| `get_instruments()` | `list[Instrument]` | Returns list of assigned instruments |\\n| `get_force_opens()` | `list[Instrument]` | Returns list of force-open instruments |\\n\\n**Method Details:**\\n\\nThe `get_instruments()` and `get_force_opens()` methods include Django admin metadata:\\n- `short_description`: Display name in admin interface\\n- `allow_tags`: Deprecated Django attribute (always `True`)\\n\\n**Related Models:**\\n- Referenced by: `Param`, `Signal`, `Order`, `Trade`\\n- References: `Broker`, `Instrument`\\n\\n**Usage:** Each strategy instance represents a distinct trading approach with its own parameter set and instrument universe.\\n\\n**Sources:** [panel/models.py:104-126]()\\n\\n---\\n\\n### Param\\n\\nStores configurable parameters for strategies with support for different data types.\\n\\n**Fields:**\\n\\n| Field | Type | Constraints | Description |\\n|-------|------|-------------|-------------|\\n| `strategy` | `ForeignKey` | ` Strategy` | Strategy this parameter belongs to |\\n| `code` | `CharField` | `max_length=64` | Parameter name/identifier |\\n| `str_value` | `CharField` | `max_length=128`, nullable, blank | String parameter value |\\n| `int_value` | `IntegerField` | nullable, blank | Integer parameter value |\\n| `float_value` | `DecimalField` | `max_digits=12, decimal_places=3`, nullable, blank | Float parameter value |\\n| `update_time` | `DateTimeField` | `auto_now=True` | Last update timestamp |\\n\\n**Meta:**\\n- `verbose_name = ''`\\n- `verbose_name_plural = ''`\\n\\n**Methods:**\\n\\n| Method | Returns | Description |\\n|--------|---------|-------------|\\n| `__str__()` | `str` | Format: `{strategy}: {code} = {value}` |\\n\\n**Design Pattern:** The model uses a **discriminated union** pattern with three value fields. Only one value field should be populated per record. The `__str__()` method selects the first non-None value for display.\\n\\n**Sources:** [panel/models.py:128-144]()\\n\\n## Market Data Models\\n\\n### Instrument\\n\\nStores product metadata including contract specifications, main contract tracking, and trading parameters.\\n\\n**Fields:**\\n\\n| Field | Type | Constraints | Description |\\n|-------|------|-------------|-------------|\\n| `exchange` | `CharField` | `max_length=8`, choices: `ExchangeType` | Exchange: SHFE, DCE, CZCE, CFFEX, INE, GFEX |\\n| `section` | `CharField` | `max_length=48`, choices: `SectionType`, nullable | Broad category (Metal, Agricultural, etc.) |\\n| `sort` | `CharField` | `max_length=48`, choices: `SortType`, nullable | Specific category (Rare metal, Feed, etc.) |\\n| `name` | `CharField` | `max_length=32`, nullable | Display name (e.g., \\\"\\\") |\\n| `product_code` | `CharField` | `max_length=16`, **unique** | Product code (e.g., \\\"rb\\\", \\\"cu\\\") |\\n| `all_inst` | `CharField` | `max_length=256`, nullable | Comma-separated list of all contract codes |\\n| `main_code` | `CharField` | `max_length=16`, nullable | Current main contract code |\\n| `last_main` | `CharField` | `max_length=16`, nullable | Previous main contract code |\\n| `change_time` | `DateTimeField` | nullable | Timestamp of last main contract rollover |\\n| `night_trade` | `BooleanField` | default: `False` | Whether product has night trading session |\\n| `volume_multiple` | `IntegerField` | nullable | Contract multiplier (lots to units) |\\n| `price_tick` | `DecimalField` | `max_digits=8, decimal_places=3`, nullable | Minimum price movement |\\n| `margin_rate` | `DecimalField` | `max_digits=6, decimal_places=5`, nullable | Margin requirement (as decimal, e.g., 0.08 = 8%) |\\n| `fee_money` | `DecimalField` | `max_digits=7, decimal_places=6`, nullable | Fee as percentage of value |\\n| `fee_volume` | `DecimalField` | `max_digits=6, decimal_places=2`, nullable | Fee per contract |\\n| `up_limit_ratio` | `DecimalField` | `max_digits=3, decimal_places=2`, nullable | Daily up limit (as decimal) |\\n| `down_limit_ratio` | `DecimalField` | `max_digits=3, decimal_places=2`, nullable | Daily down limit (as decimal) |\\n\\n**Meta:**\\n- `verbose_name = ''`\\n- `verbose_name_plural = ''`\\n\\n**Methods:**\\n\\n| Method | Returns | Description |\\n|--------|---------|-------------|\\n| `__str__()` | `str` | Format: `{exchange}.{name}` |\\n\\n**Key Features:**\\n\\n1. **Main Contract Tracking:** The `main_code`, `last_main`, and `change_time` fields track rollover events when the most liquid contract changes.\\n\\n2. **Trading Sessions:** The `night_trade` field indicates whether the product trades during the evening session (20:55-02:30).\\n\\n3. **Cost Calculation:** Uses `margin_rate`, `fee_money`, and `fee_volume` to calculate position costs.\\n\\n**Constants Used:** `ExchangeType`, `SectionType`, `SortType` from [panel/const.py:25-53]()\\n\\n**Update Schedule:** Main contract is recalculated daily by `calc_main_inst()` at 17:00.\\n\\n**Sources:** [panel/models.py:146-171]()\\n\\n---\\n\\n### DailyBar\\n\\nStores daily OHLCV data for individual futures contracts.\\n\\n**Fields:**\\n\\n| Field | Type | Constraints | Description |\\n|-------|------|-------------|-------------|\\n| `exchange` | `CharField` | `max_length=8`, choices: `ExchangeType` | Exchange identifier |\\n| `code` | `CharField` | `max_length=16`, indexed | Contract code (e.g., \\\"rb2405\\\") |\\n| `expire_date` | `IntegerField` | nullable | Expiration date in YYYYMMDD format |\\n| `time` | `DateField` | indexed | Trading date |\\n| `open` | `DecimalField` | `max_digits=12, decimal_places=3` | Opening price |\\n| `high` | `DecimalField` | `max_digits=12, decimal_places=3` | Highest price |\\n| `low` | `DecimalField` | `max_digits=12, decimal_places=3` | Lowest price |\\n| `close` | `DecimalField` | `max_digits=12, decimal_places=3` | Closing price |\\n| `settlement` | `DecimalField` | `max_digits=12, decimal_places=3`, nullable | Settlement price |\\n| `volume` | `IntegerField` | | Trading volume |\\n| `open_interest` | `DecimalField` | `max_digits=12, decimal_places=3` | Open interest |\\n\\n**Meta:**\\n- `verbose_name = 'K'`\\n- `verbose_name_plural = 'K'`\\n\\n**Methods:**\\n\\n| Method | Returns | Description |\\n|--------|---------|-------------|\\n| `__str__()` | `str` | Format: `{exchange}.{code}` |\\n\\n**Database Indexes:**\\n- `code`: For fast contract-specific queries\\n- `time`: For date range filtering\\n\\n**Data Source:** Populated daily by `update_from_shfe()`, `update_from_dce()`, `update_from_czce()`, `update_from_cffex()`, and `update_from_gfex()` functions.\\n\\n**Constants Used:** `ExchangeType` from [panel/const.py:25-31]()\\n\\n**Sources:** [panel/models.py:216-235]()\\n\\n---\\n\\n### MainBar\\n\\nStores continuous daily OHLCV data for the main (most liquid) contract of each product.\\n\\n**Fields:**\\n\\n| Field | Type | Constraints | Description |\\n|-------|------|-------------|-------------|\\n| `exchange` | `CharField` | `max_length=8`, choices: `ExchangeType` | Exchange identifier |\\n| `product_code` | `CharField` | `max_length=8`, indexed | Product code (e.g., \\\"rb\\\") |\\n| `code` | `CharField` | `max_length=16`, nullable | Actual contract code on this date |\\n| `time` | `DateField` | indexed | Trading date |\\n| `open` | `DecimalField` | `max_digits=12, decimal_places=3` | Opening price |\\n| `high` | `DecimalField` | `max_digits=12, decimal_places=3` | Highest price |\\n| `low` | `DecimalField` | `max_digits=12, decimal_places=3` | Lowest price |\\n| `close` | `DecimalField` | `max_digits=12, decimal_places=3` | Closing price |\\n| `settlement` | `DecimalField` | `max_digits=12, decimal_places=3`, nullable | Settlement price |\\n| `volume` | `IntegerField` | | Trading volume |\\n| `open_interest` | `DecimalField` | `max_digits=12, decimal_places=3` | Open interest |\\n| `basis` | `DecimalField` | `max_digits=12, decimal_places=3`, nullable | Basis (spot - futures) |\\n\\n**Meta:**\\n- `verbose_name = 'K'`\\n- `verbose_name_plural = 'K'`\\n\\n**Methods:**\\n\\n| Method | Returns | Description |\\n|--------|---------|-------------|\\n| `__str__()` | `str` | Format: `{exchange}.{product_code}` |\\n\\n**Key Differences from DailyBar:**\\n\\n1. **Continuous Series:** MainBar creates a continuous price series by always using the main contract.\\n2. **Rollover Handling:** When main contract changes, the series adjusts prices to maintain continuity.\\n3. **Product-level:** Indexed by `product_code` rather than individual contract `code`.\\n4. **Basis Field:** Additional `basis` field for spot-futures spread tracking.\\n\\n**Database Indexes:**\\n- `product_code`: For fast product-specific queries\\n- `time`: For date range filtering\\n\\n**Generation:** Created by `calc_main_inst()` which identifies main contracts and builds continuous series.\\n\\n**Constants Used:** `ExchangeType` from [panel/const.py:25-31]()\\n\\n**Sources:** [panel/models.py:194-214]()\\n\\n## Trading Operation Models\\n\\n### Signal\\n\\nRepresents trading signals generated by strategy logic.\\n\\n**Fields:**\\n\\n| Field | Type | Constraints | Description |\\n|-------|------|-------------|-------------|\\n| `strategy` | `ForeignKey` | ` Strategy` | Strategy that generated this signal |\\n| `instrument` | `ForeignKey` | ` Instrument` | Target product |\\n| `code` | `CharField` | `max_length=16`, nullable | Specific contract code |\\n| `type` | `CharField` | `max_length=16`, choices: `SignalType` | Signal type (see below) |\\n| `trigger_value` | `DecimalField` | `max_digits=12, decimal_places=3`, nullable | Price/indicator value that triggered signal |\\n| `price` | `DecimalField` | `max_digits=12, decimal_places=3`, nullable | Target execution price |\\n| `volume` | `IntegerField` | nullable | Number of contracts |\\n| `trigger_time` | `DateTimeField` | | When signal was generated |\\n| `priority` | `IntegerField` | choices: `PriorityType`, default: `Normal` | Execution priority: LOW(0), Normal(1), High(2) |\\n| `processed` | `BooleanField` | default: `False` | Whether signal has been executed |\\n\\n**Signal Types (`SignalType`):**\\n\\n| Type | Description | Direction |\\n|------|-------------|-----------|\\n| `BUY` | Open long position | Long entry |\\n| `SELL_SHORT` | Open short position | Short entry |\\n| `SELL` | Close long position | Long exit |\\n| `BUY_COVER` | Close short position | Short exit |\\n| `ROLL_CLOSE` | Close old contract (rollover) | Position transfer |\\n| `ROLL_OPEN` | Open new contract (rollover) | Position transfer |\\n\\n**Meta:**\\n- `verbose_name = ''`\\n- `verbose_name_plural = ''`\\n\\n**Methods:**\\n\\n| Method | Returns | Description |\\n|--------|---------|-------------|\\n| `__str__()` | `str` | Format: `{instrument}({code}){type}{volume}()` |\\n\\n**Signal Processing Workflow:**\\n\\n```mermaid\\nstateDiagram-v2\\n    [*] --\\u003e Generated: \\\"calc_signal()\\\"\\n    Generated --\\u003e Queued: \\\"processed=False\\\"\\n    Queued --\\u003e Processing: \\\"processing_signal*()\\\"\\n    Processing --\\u003e OrderCreated: \\\"ReqOrderInsert\\\"\\n    OrderCreated --\\u003e Filled: \\\"OnRtnTrade\\\"\\n    Filled --\\u003e Processed: \\\"processed=True\\\"\\n    Processed --\\u003e [*]\\n    \\n    Processing --\\u003e Failed: \\\"Order rejected\\\"\\n    Failed --\\u003e Queued: \\\"Retry logic\\\"\\n```\\n\\n**Processing Schedule:**\\n- **08:55**: `processing_signal1()` - Morning session signals\\n- **09:25**: `processing_signal2()` - Main morning session\\n- **20:55**: `processing_signal3()` - Night session signals\\n\\n**Constants Used:** `SignalType` from [panel/const.py:165-171](), `PriorityType` from [panel/const.py:174-177]()\\n\\n**Related Models:**\\n- One-to-one with `Order` (via `Order.signal` field)\\n\\n**Sources:** [panel/models.py:173-192]()\\n\\n---\\n\\n### Order\\n\\nRepresents CTP order requests and their execution status.\\n\\n**Fields:**\\n\\n| Field | Type | Constraints | Description |\\n|-------|------|-------------|-------------|\\n| `broker` | `ForeignKey` | ` Broker` | Account placing the order |\\n| `strategy` | `ForeignKey` | ` Strategy`, nullable | Strategy that generated this order |\\n| `order_ref` | `CharField` | `max_length=13` | Unique order reference (FrontID+SessionID+OrderRef) |\\n| `instrument` | `ForeignKey` | ` Instrument` | Target product |\\n| `code` | `CharField` | `max_length=16`, nullable | Specific contract code |\\n| `front` | `IntegerField` | | CTP FrontID |\\n| `session` | `IntegerField` | | CTP SessionID |\\n| `price` | `DecimalField` | `max_digits=12, decimal_places=3` | Order limit price |\\n| `volume` | `IntegerField` | nullable | Order quantity |\\n| `direction` | `CharField` | `max_length=8`, choices: `DirectionType` | LONG or SHORT |\\n| `offset_flag` | `CharField` | `max_length=8`, choices: `OffsetFlag` | Open/Close flag |\\n| `status` | `CharField` | `max_length=16`, choices: `OrderStatus` | Current order status |\\n| `send_time` | `DateTimeField` | | When order was sent to CTP |\\n| `update_time` | `DateTimeField` | | Last status update time |\\n| `signal` | `OneToOneField` | ` Signal`, nullable | Signal that generated this order |\\n\\n**Order Status Values (`OrderStatus`):**\\n\\n| Status | Value | Description |\\n|--------|-------|-------------|\\n| `AllTraded` | `0` | Order fully executed |\\n| `PartTradedQueueing` | `1` | Partially filled, rest in queue |\\n| `PartTradedNotQueueing` | `2` | Partially filled, rest canceled |\\n| `NoTradeQueueing` | `3` | Not filled, still in queue |\\n| `NoTradeNotQueueing` | `4` | Not filled, removed from queue |\\n| `Canceled` | `5` | Manually canceled |\\n| `Unknown` | `a` | Status unknown |\\n\\n**Offset Flag Values (`OffsetFlag`):**\\n\\n| Flag | Description | Use Case |\\n|------|-------------|----------|\\n| `Open` | Open position | New position entry |\\n| `Close` | Close position | Generic close (SHFE) |\\n| `CloseToday` | Close today's position | For exchanges requiring it |\\n| `CloseYesterday` | Close yesterday's position | For exchanges requiring it |\\n\\n**Meta:**\\n- `verbose_name = ''`\\n- `verbose_name_plural = ''`\\n\\n**Methods:**\\n\\n| Method | Returns | Description |\\n|--------|---------|-------------|\\n| `__str__()` | `str` | Format: `{instrument}-{offset_flag}` |\\n\\n**Order Lifecycle:**\\n\\n```mermaid\\nsequenceDiagram\\n    participant S as \\\"Signal\\\"\\n    participant O as \\\"Order\\\"\\n    participant R as \\\"Redis\\\"\\n    participant C as \\\"CTP\\\"\\n    \\n    S-\\u003e\\u003eO: \\\"Create Order record\\\"\\n    O-\\u003e\\u003eR: \\\"Publish MSG:CTP:REQ:*\\\"\\n    R-\\u003e\\u003eC: \\\"ReqOrderInsert\\\"\\n    C-\\u003e\\u003eR: \\\"OnRtnOrder\\\"\\n    R-\\u003e\\u003eO: \\\"Update status\\\"\\n    \\n    alt Order Filled\\n        C-\\u003e\\u003eR: \\\"OnRtnTrade\\\"\\n        R-\\u003e\\u003eO: \\\"status = AllTraded\\\"\\n        Note over O: \\\"Trade record created\\\"\\n    else Order Rejected\\n        C-\\u003e\\u003eR: \\\"OnRspOrderInsert (error)\\\"\\n        R-\\u003e\\u003eO: \\\"status = NoTradeNotQueueing\\\"\\n    end\\n```\\n\\n**Constants Used:** `DirectionType` from [panel/const.py:65-67](), `OffsetFlag` from [panel/const.py:80-87](), `OrderStatus` from [panel/const.py:90-99]()\\n\\n**Related Models:**\\n- One-to-one with `Signal`\\n- One-to-one with `Trade` (via `open_order` or `close_order`)\\n\\n**Sources:** [panel/models.py:237-260]()\\n\\n---\\n\\n### Trade\\n\\nTracks open positions and closed trades with P\\u0026L calculation.\\n\\n**Fields:**\\n\\n| Field | Type | Constraints | Description |\\n|-------|------|-------------|-------------|\\n| `broker` | `ForeignKey` | ` Broker` | Account holding the position |\\n| `strategy` | `ForeignKey` | ` Strategy`, nullable | Strategy managing this position |\\n| `instrument` | `ForeignKey` | ` Instrument` | Product traded |\\n| `open_order` | `OneToOneField` | ` Order`, nullable | Order that opened position |\\n| `close_order` | `OneToOneField` | ` Order`, nullable | Order that closed position |\\n| `code` | `CharField` | `max_length=16`, nullable | Contract code |\\n| `direction` | `CharField` | `max_length=8`, choices: `DirectionType` | LONG or SHORT |\\n| `open_time` | `DateTimeField` | | When position was opened |\\n| `close_time` | `DateTimeField` | nullable | When position was closed (null if open) |\\n| `shares` | `IntegerField` | nullable | Target position size |\\n| `filled_shares` | `IntegerField` | nullable | Contracts actually filled |\\n| `closed_shares` | `IntegerField` | nullable | Contracts closed out |\\n| `avg_entry_price` | `DecimalField` | `max_digits=12, decimal_places=3`, nullable | Average entry price |\\n| `avg_exit_price` | `DecimalField` | `max_digits=12, decimal_places=3`, nullable | Average exit price |\\n| `profit` | `DecimalField` | `max_digits=12, decimal_places=3`, nullable | Unrealized/realized P\\u0026L |\\n| `frozen_margin` | `DecimalField` | `max_digits=12, decimal_places=3`, nullable | Margin locked for this position |\\n| `cost` | `DecimalField` | `max_digits=12, decimal_places=2`, nullable | Total transaction fees |\\n\\n**Meta:**\\n- `verbose_name = ''`\\n- `verbose_name_plural = ''`\\n\\n**Methods:**\\n\\n| Method | Returns | Description |\\n|--------|---------|-------------|\\n| `__str__()` | `str` | Format: `{instrument}{direction}{shares}` |\\n\\n**Position States:**\\n\\n| State | Conditions | Description |\\n|-------|-----------|-------------|\\n| **Open** | `close_order == None`, `close_time == None` | Active position |\\n| **Partially Closed** | `close_order != None`, `closed_shares \\u003c filled_shares` | Some contracts closed |\\n| **Fully Closed** | `close_order != None`, `closed_shares == filled_shares` | Position completely liquidated |\\n\\n**P\\u0026L Calculation:**\\n\\nFor **LONG** positions:\\n```\\nprofit = (current_price - avg_entry_price) * filled_shares * volume_multiple\\n```\\n\\nFor **SHORT** positions:\\n```\\nprofit = (avg_entry_price - current_price) * filled_shares * volume_multiple\\n```\\n\\n**Update Schedule:**\\n- **Real-time:** Updated when orders fill via `OnRtnTrade` callback\\n- **Daily:** Refreshed at market close (15:20) by `TradeStrategy.refresh_all()`\\n\\n**Constants Used:** `DirectionType` from [panel/const.py:65-67]()\\n\\n**Related Models:**\\n- References two `Order` records (open and close)\\n- Used to calculate `Performance` metrics\\n\\n**Sources:** [panel/models.py:262-289]()\\n\\n## Model Usage Patterns\\n\\n### Querying Historical Prices\\n\\n```python\\n# Get last 60 days of MainBar data as DataFrame\\nfrom panel.models import MainBar, to_df\\n\\nqueryset = MainBar.objects.filter(\\n    product_code='rb',\\n    time__gte=start_date\\n).order_by('time')\\n\\ndf = to_df(queryset, index_col='time', parse_dates=['time'])\\n```\\n\\n### Retrieving Open Positions\\n\\n```python\\n# Get all open positions for a broker\\nfrom panel.models import Trade\\n\\nopen_trades = Trade.objects.filter(\\n    broker=broker_instance,\\n    close_time__isnull=True\\n)\\n```\\n\\n### Finding Unprocessed Signals\\n\\n```python\\n# Get pending signals for execution\\nfrom panel.models import Signal\\n\\npending = Signal.objects.filter(\\n    strategy=strategy_instance,\\n    processed=False\\n).order_by('-priority', 'trigger_time')\\n```\\n\\n### Tracking Main Contract Changes\\n\\n```python\\n# Detect rollover events\\nfrom panel.models import Instrument\\n\\nrollovers = Instrument.objects.filter(\\n    change_time__gte=start_date\\n).values('product_code', 'last_main', 'main_code', 'change_time')\\n```\\n\\n**Sources:** [panel/models.py:25-289]()\\n\\n## Field Type Reference\\n\\n| Django Field Type | Database Type | Python Type | Precision |\\n|-------------------|----------------|-------------|-----------|\\n| `CharField` | VARCHAR | `str` | `max_length` param |\\n| `IntegerField` | INTEGER | `int` | 32-bit signed |\\n| `DecimalField` | DECIMAL | `Decimal` | `max_digits`, `decimal_places` |\\n| `DateField` | DATE | `datetime.date` | - |\\n| `DateTimeField` | DATETIME | `datetime.datetime` | - |\\n| `BooleanField` | TINYINT(1) | `bool` | - |\\n| `ForeignKey` | INTEGER | Model instance | - |\\n| `OneToOneField` | INTEGER | Model instance | UNIQUE constraint |\\n| `ManyToManyField` | Junction table | QuerySet | - |\\n\\n**Sources:** [panel/models.py:1-289]()\\n\\n## Database Indexes\\n\\nIndexed fields for query performance:\\n\\n| Model | Field | Index Type | Purpose |\\n|-------|-------|------------|---------|\\n| `DailyBar` | `code` | B-tree | Contract-specific queries |\\n| `DailyBar` | `time` | B-tree | Date range filtering |\\n| `MainBar` | `product_code` | B-tree | Product-specific queries |\\n| `MainBar` | `time` | B-tree | Date range filtering |\\n\\nAdditional indexes are created automatically for:\\n- Primary keys (`id` fields)\\n- Foreign keys\\n- Fields with `unique=True`\\n\\n**Sources:** [panel/models.py:194-235]()\"])</script><script>self.__next_f.push([1,\"40:Tc942,\"])</script><script>self.__next_f.push([1,\"# Troubleshooting\\n\\n\\u003cdetails\\u003e\\n\\u003csummary\\u003eRelevant source files\\u003c/summary\\u003e\\n\\nThe following files were used as context for generating this wiki page:\\n\\n- [trader/strategy/brother2.py](trader/strategy/brother2.py)\\n- [trader/utils/error.xml](trader/utils/error.xml)\\n- [trader/utils/read_config.py](trader/utils/read_config.py)\\n\\n\\u003c/details\\u003e\\n\\n\\n\\nThis page provides solutions to common issues encountered when running the trader system, including connection failures, CTP API errors, order execution problems, and data synchronization issues. For information about logging and monitoring, see [Logging and Monitoring](#8.4). For configuration details, see [Configuration Reference](#7).\\n\\n---\\n\\n## Common Issues Quick Reference\\n\\nThe following table summarizes the most frequently encountered issues and their quick solutions:\\n\\n| Symptom | Likely Cause | Quick Fix | Section |\\n|---------|--------------|-----------|---------|\\n| System fails to start | Missing config.ini | Check configuration file exists | [Configuration Problems](#configuration-problems) |\\n| Orders not executing | CTP API not connected | Verify Redis channels and CTP gateway | [Connection Issues](#connection-issues) |\\n| \\\"Query timeout\\\" errors | Network latency or CTP busy | Increase `command_timeout` in config | [Query Timeouts](#query-timeouts) |\\n| Positions not updating | Database sync failure | Run `refresh_position()` manually | [Position Synchronization](#position-synchronization-failures) |\\n| Signals not processing | Trading time mismatch | Verify system clock and trading hours | [Signal Processing Issues](#signal-processing-issues) |\\n| Order rejected with error code | CTP API constraint violation | Check error code in error.xml | [CTP API Error Reference](#ctp-api-error-reference) |\\n| \\\"\\\" (Insufficient funds) | Margin requirement exceeds available | Add funds or reduce position size | [Insufficient Margin](#insufficient-margin) |\\n| Price limit rejection | Order price beyond exchange limits | System will auto-adjust and retry | [Price Limit Violations](#price-limit-violations) |\\n| Data fetch failures | Exchange API unavailable | System retries automatically after 10min | [Exchange Data Failures](#exchange-data-acquisition-failures) |\\n| Duplicate order errors | OrderRef collision | Check Autonumber table sequence | [Duplicate Orders](#duplicate-order-submissions) |\\n\\n---\\n\\n## Connection Issues\\n\\n### Redis Connection Failures\\n\\n**Symptoms:**\\n- Error messages: `ConnectionError`, `Connection refused`\\n- System fails to start\\n- Heartbeat monitoring stops\\n\\n**Diagnosis:**\\n\\n```mermaid\\ngraph TB\\n    Start[Connection Failure]\\n    CheckRedis{Redis\\u003cbr/\\u003eRunning?}\\n    CheckConfig{Config\\u003cbr/\\u003eCorrect?}\\n    CheckFirewall{Firewall\\u003cbr/\\u003eBlocking?}\\n    CheckAuth{Auth\\u003cbr/\\u003eRequired?}\\n    \\n    Start --\\u003e CheckRedis\\n    CheckRedis --\\u003e|No| StartRedis[Start Redis Server]\\n    CheckRedis --\\u003e|Yes| CheckConfig\\n    \\n    CheckConfig --\\u003e|No| FixConfig[Fix config.ini\\u003cbr/\\u003eREDIS section]\\n    CheckConfig --\\u003e|Yes| CheckFirewall\\n    \\n    CheckFirewall --\\u003e|Yes| DisableFirewall[Allow port 6379]\\n    CheckFirewall --\\u003e|No| CheckAuth\\n    \\n    CheckAuth --\\u003e|Yes| AddPassword[Add password to config]\\n    CheckAuth --\\u003e|No| CheckLogs[Check Redis logs]\\n```\\n\\n**Common Causes:**\\n\\n1. **Redis not running:**\\n   ```bash\\n   # Check if Redis is running\\n   systemctl status redis\\n   # Start Redis\\n   systemctl start redis\\n   ```\\n\\n2. **Wrong configuration** - Check [trader/utils/read_config.py:37-41]():\\n   ```ini\\n   [REDIS]\\n   host = 127.0.0.1\\n   port = 6379\\n   db = 0\\n   encoding = utf-8\\n   ```\\n\\n3. **Network issues:**\\n   - Verify Redis is listening: `netstat -an | grep 6379`\\n   - Test connection: `redis-cli ping` (should return PONG)\\n\\n**Solutions:**\\n\\nThe system creates connections in [trader/strategy/__init__.py]() using `aioredis`. Check these locations:\\n- Raw Redis client: [trader/strategy/__init__.py:70-76]()\\n- Async Redis client: [trader/strategy/__init__.py:77-79]()\\n\\nSources: [trader/strategy/__init__.py:62-82](), [trader/utils/read_config.py:37-41]()\\n\\n---\\n\\n### MySQL Connection Failures\\n\\n**Symptoms:**\\n- Django database errors: `OperationalError`, `Can't connect to MySQL server`\\n- Data queries fail\\n- Model save operations fail\\n\\n**Diagnosis Flow:**\\n\\n```mermaid\\ngraph LR\\n    Error[MySQL Error]\\n    CheckServer[Check MySQL Status]\\n    CheckCreds[Verify Credentials]\\n    CheckDB[Database Exists?]\\n    CheckPerms[User Permissions?]\\n    CheckNetwork[Network Access?]\\n    \\n    Error --\\u003e CheckServer\\n    CheckServer --\\u003e CheckCreds\\n    CheckCreds --\\u003e CheckDB\\n    CheckDB --\\u003e CheckPerms\\n    CheckPerms --\\u003e CheckNetwork\\n```\\n\\n**Common Causes:**\\n\\n1. **MySQL not running:**\\n   ```bash\\n   systemctl status mysql\\n   systemctl start mysql\\n   ```\\n\\n2. **Database doesn't exist:**\\n   ```sql\\n   CREATE DATABASE QuantDB CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;\\n   ```\\n\\n3. **Wrong credentials** - Check [trader/utils/read_config.py:43-48]():\\n   ```ini\\n   [MYSQL]\\n   host = 127.0.0.1\\n   port = 3306\\n   db = QuantDB\\n   user = quant\\n   password = 123456\\n   ```\\n\\n4. **User permissions:**\\n   ```sql\\n   GRANT ALL PRIVILEGES ON QuantDB.* TO 'quant'@'localhost';\\n   FLUSH PRIVILEGES;\\n   ```\\n\\n**Verification Steps:**\\n\\n1. Test connection from command line:\\n   ```bash\\n   mysql -h 127.0.0.1 -P 3306 -u quant -p QuantDB\\n   ```\\n\\n2. Check Django settings are using config.ini values\\n\\n3. Run Django migrations to ensure schema is current:\\n   ```bash\\n   python manage.py migrate\\n   ```\\n\\nSources: [trader/utils/read_config.py:43-48](), [trader/main.py:29-41]()\\n\\n---\\n\\n### CTP API Connection Problems\\n\\n**Symptoms:**\\n- Orders not reaching exchange\\n- Market data not updating\\n- Query operations timeout\\n- No response from CTP channels\\n\\n**Architecture Diagram:**\\n\\n```mermaid\\ngraph TB\\n    subgraph \\\"TradeStrategy\\\"\\n        TS[TradeStrategy\\u003cbr/\\u003ebrother2.py]\\n    end\\n    \\n    subgraph \\\"Redis Message Bus\\\"\\n        REQ[\\\"MSG:CTP:REQ:*\\\"]\\n        TRADE_RSP[\\\"MSG:CTP:RSP:TRADE:*\\\"]\\n        MARKET_RSP[\\\"MSG:CTP:RSP:MARKET:*\\\"]\\n    end\\n    \\n    subgraph \\\"CTP Gateway Process\\\"\\n        Gateway[CTP API Handler]\\n        CTPLib[CTP Library]\\n    end\\n    \\n    subgraph \\\"Exchange\\\"\\n        Exchange[Futures Exchange]\\n    end\\n    \\n    TS --\\u003e|Publish| REQ\\n    REQ -.-\\u003e|Subscribe| Gateway\\n    Gateway --\\u003e CTPLib\\n    CTPLib \\u003c--\\u003e|Network| Exchange\\n    \\n    Gateway --\\u003e|Publish| TRADE_RSP\\n    Gateway --\\u003e|Publish| MARKET_RSP\\n    TRADE_RSP -.-\\u003e|Subscribe| TS\\n    MARKET_RSP -.-\\u003e|Subscribe| TS\\n```\\n\\n**Diagnosis:**\\n\\n1. **Check Redis channels are configured** - See [trader/strategy/brother2.py:41-43]():\\n   - Request format: `MSG:CTP:REQ:{command}`\\n   - Trade response: `MSG:CTP:RSP:TRADE:{callback}:{request_id}`\\n   - Market response: `MSG:CTP:RSP:MARKET:{callback}:{request_id}`\\n\\n2. **Verify CTP gateway process is running:**\\n   - Check for separate CTP gateway process\\n   - Monitor Redis subscriptions: `redis-cli CLIENT LIST`\\n\\n3. **Check heartbeat:**\\n   ```bash\\n   redis-cli GET \\\"HEARTBEAT:TRADER\\\"\\n   # Should return \\\"1\\\" if system is alive\\n   ```\\n   See [trader/strategy/brother2.py:66,570]()\\n\\n**Common Issues:**\\n\\n1. **CTP credentials invalid:**\\n   - Verify BrokerID, UserID, Password in config\\n   - Check if account is active\\n\\n2. **Network firewall blocking CTP ports:**\\n   - CTP uses TCP ports (typically 41205 for MD, 41205 for TD)\\n   - Check firewall rules\\n\\n3. **Trading hours:**\\n   - CTP API only works during trading sessions\\n   - System checks trading day: [trader/strategy/brother2.py:69,576,601,625,647,688]()\\n\\n4. **Session limits exceeded:**\\n   - CTP limits concurrent sessions per account\\n   - Error code 60: \\\"CTP:\\\"\\n\\n**Debugging:**\\n\\nMonitor Redis pub/sub in real-time:\\n```bash\\nredis-cli PSUBSCRIBE \\\"MSG:CTP:*\\\"\\n```\\n\\nCheck if requests are being published:\\n```bash\\nredis-cli MONITOR | grep \\\"MSG:CTP:REQ\\\"\\n```\\n\\nSources: [trader/strategy/brother2.py:38-43,220-257](), [trader/utils/read_config.py:23-31]()\\n\\n---\\n\\n## Configuration Problems\\n\\n### Missing or Invalid config.ini\\n\\n**Symptoms:**\\n- `FileNotFoundError` when starting system\\n- `configparser.NoSectionError` or `configparser.NoOptionError`\\n- Default values being used unexpectedly\\n\\n**Configuration File Location:**\\n\\nThe system looks for config.ini in the application directory defined by `appdirs`:\\n\\n```mermaid\\ngraph LR\\n    AppDirs[appdirs.AppDirs\\u003cbr/\\u003e'trader']\\n    ConfigDir[User Config Dir]\\n    ConfigFile[config.ini]\\n    \\n    AppDirs --\\u003e ConfigDir\\n    ConfigDir --\\u003e ConfigFile\\n    \\n    Windows[Windows:\\u003cbr/\\u003eC:\\\\Users\\\\username\\\\AppData\\\\Local\\\\trader]\\n    Linux[Linux:\\u003cbr/\\u003e~/.config/trader]\\n    \\n    ConfigDir -.-\\u003e Windows\\n    ConfigDir -.-\\u003e Linux\\n```\\n\\n**File Structure Check:**\\n\\n[trader/utils/read_config.py:23-60]() shows the expected configuration:\\n\\n```ini\\n[MSG_CHANNEL]\\nrequest_pattern = MSG:CTP:REQ:*\\nrequest_format = MSG:CTP:REQ:{}\\ntrade_response_prefix = MSG:CTP:RSP:TRADE:\\ntrade_response_format = MSG:CTP:RSP:TRADE:{}:{}\\nmarket_response_prefix = MSG:CTP:RSP:MARKET:\\nmarket_response_format = MSG:CTP:RSP:MARKET:{}:{}\\nweixin_log = MSG:LOG:WEIXIN\\n\\n[TRADE]\\ncommand_timeout = 5\\nignore_inst = WH,bb,JR,RI,RS,LR,PM,im\\n\\n[REDIS]\\nhost = 127.0.0.1\\nport = 6379\\ndb = 0\\nencoding = utf-8\\n\\n[MYSQL]\\nhost = 127.0.0.1\\nport = 3306\\ndb = QuantDB\\nuser = quant\\npassword = 123456\\n\\n[LOG]\\nlevel = DEBUG\\nformat = %(asctime)s %(name)s [%(levelname)s] %(message)s\\n```\\n\\n**Solutions:**\\n\\n1. **Auto-generate config file:**\\n   The system automatically creates a default config.ini on first run - see [trader/utils/read_config.py:64-69]()\\n\\n2. **Manually create config file:**\\n   ```bash\\n   mkdir -p ~/.config/trader  # Linux\\n   # or\\n   mkdir %APPDATA%\\\\trader     # Windows\\n   \\n   # Copy example configuration\\n   cp trader/utils/read_config.py ~/.config/trader/config.ini\\n   ```\\n\\n3. **Verify file permissions:**\\n   ```bash\\n   ls -l ~/.config/trader/config.ini\\n   # Should be readable by the user running the system\\n   ```\\n\\n4. **Check for syntax errors:**\\n   - No spaces around `=` in INI files\\n   - No quotes around values\\n   - Section headers must be in square brackets\\n\\nSources: [trader/utils/read_config.py:62-72]()\\n\\n---\\n\\n### Invalid Configuration Values\\n\\n**Common Errors:**\\n\\n| Configuration | Invalid Value | Symptom | Fix |\\n|---------------|---------------|---------|-----|\\n| `command_timeout` | Too low (\\u003c 3) | Frequent timeouts | Increase to 10+ for slow networks |\\n| `host` | Wrong IP | Connection refused | Verify server IP address |\\n| `port` | Wrong number | Connection refused | Use default: Redis=6379, MySQL=3306 |\\n| `ignore_inst` | Invalid codes | Unwanted instruments traded | Check exchange product codes |\\n| `level` | Invalid log level | Logging fails | Use: DEBUG, INFO, WARNING, ERROR |\\n\\n**Timeout Configuration:**\\n\\nThe system uses [trader/strategy/brother2.py:35]():\\n```python\\nHANDLER_TIME_OUT = config.getint('TRADE', 'command_timeout', fallback=10)\\n```\\n\\nThis timeout applies to:\\n- Query operations: [trader/strategy/brother2.py:248]()\\n- Market data subscription: [trader/strategy/brother2.py:269]()\\n- Order cancellation: [trader/strategy/brother2.py:358]()\\n\\n**Recommended Values:**\\n\\n```ini\\n[TRADE]\\n# For local network: 5 seconds\\n# For remote/VPN: 10-15 seconds\\n# For poor network: 20+ seconds\\ncommand_timeout = 10\\n```\\n\\nSources: [trader/strategy/brother2.py:35](), [trader/utils/read_config.py:34-35]()\\n\\n---\\n\\n## CTP API Error Reference\\n\\n### Error Code Lookup\\n\\nThe system loads CTP error codes from [trader/utils/error.xml]() and maps them in [trader/utils/read_config.py:74-78]():\\n\\n```python\\nctp_errors = {}\\nfor error in ET.parse(ctp_xml_path).getroot():\\n    ctp_errors[int(error.attrib['value'])] = error.attrib['prompt']\\n```\\n\\n**Critical Error Codes:**\\n\\n| Code | Error ID | Message | Common Cause | Solution |\\n|------|----------|---------|--------------|----------|\\n| 22 | DUPLICATE_ORDER_REF |  | OrderRef collision | Check Autonumber sequence |\\n| 25 | ORDER_NOT_FOUND |  | Canceling non-existent order | Verify order exists before cancel |\\n| 26 | INSUITABLE_ORDER_STATUS |  | Order already filled/cancelled | Check order status first |\\n| 30 | OVER_CLOSE_POSITION |  | Closing more than held | Query current position |\\n| 31 | INSUFFICIENT_MONEY |  | Not enough margin | Add funds or reduce size |\\n| 42 | SETTLEMENT_INFO_NOT_CONFIRMED |  | Need to confirm settlement | Confirm settlement first |\\n| 50 | OVER_CLOSETODAY_POSITION |  | Insufficient today positions | Use OF_Close instead |\\n| 51 | OVER_CLOSEYESTERDAY_POSITION |  | Insufficient old positions | Check position dates |\\n| 90 | NEED_RETRY |  | Query too soon | Retry after delay |\\n| 116 | ORDER_FREQ_LIMIT |  | Too many orders | Reduce order frequency |\\n\\n**Error Handling in Code:**\\n\\nWhen orders are cancelled due to price limits, the system automatically adjusts and retries - see [trader/strategy/brother2.py:522-564]():\\n\\n```mermaid\\ngraph TB\\n    OrderRejected[\\\"Order Rejected\\u003cbr/\\u003eStatus=Canceled\\u003cbr/\\u003eSubmit=InsertRejected\\\"]\\n    CheckPrice{Price Beyond\\u003cbr/\\u003eLimit?}\\n    CalcNewPrice[\\\"Calculate New Price\\u003cbr/\\u003e50% of distance to settlement\\\"]\\n    CheckValid{Delta \\u003e 1%\\u003cbr/\\u003eof settlement?}\\n    Resubmit[Resubmit Order]\\n    Abandon[Abandon Order]\\n    \\n    OrderRejected --\\u003e CheckPrice\\n    CheckPrice --\\u003e|Yes| CalcNewPrice\\n    CalcNewPrice --\\u003e CheckValid\\n    CheckValid --\\u003e|Yes| Resubmit\\n    CheckValid --\\u003e|No| Abandon\\n```\\n\\nSources: [trader/utils/error.xml:1-267](), [trader/utils/read_config.py:74-78](), [trader/strategy/brother2.py:522-564]()\\n\\n---\\n\\n### Authentication and Authorization Errors\\n\\n**Common Error Codes:**\\n\\n- **3** (INVALID_LOGIN): Invalid user credentials\\n- **4** (USER_NOT_ACTIVE): Account not active\\n- **5** (DUPLICATE_LOGIN): Already logged in elsewhere\\n- **6** (NOT_LOGIN_YET): Operation requires login\\n- **9** (NO_PRIVILEGE): No permission for operation\\n- **28** (NO_TRADING_RIGHT): No trading permission\\n- **48** (INVALID_INVESTORIDORPASSWORD): Wrong investor ID or password\\n- **63** (AUTH_FAILED): Client authentication failed\\n- **75** (LOGIN_FORBIDDEN): Too many failed login attempts\\n- **140** (FIRST_LOGIN): Must change password on first login\\n- **143** (IP_FORBIDDEN): IP blocked due to failed attempts\\n\\n**Diagnosis Steps:**\\n\\n1. Verify CTP credentials in broker configuration\\n2. Check if account is enabled for trading\\n3. Confirm IP is whitelisted at broker\\n4. Check if another session is active\\n5. Verify trading permissions for specific instruments\\n\\nSources: [trader/utils/error.xml:11-123]()\\n\\n---\\n\\n### Exchange and Trading Errors\\n\\n**Position and Order Errors:**\\n\\n| Code | Error | Description | Fix |\\n|------|-------|-------------|-----|\\n| 16 | INSTRUMENT_NOT_FOUND | Invalid instrument code | Check instrument exists |\\n| 17 | INSTRUMENT_NOT_TRADING | Instrument not tradable | Wait for trading session |\\n| 29 | CLOSE_ONLY | Only closing allowed | Don't open new positions |\\n| 30 | OVER_CLOSE_POSITION | Close exceeds position | Query current positions |\\n| 106 | POSI_LIMIT | Position limit exceeded | Reduce position size |\\n\\n**Exchange Network Errors:**\\n\\n- **39** (CFFEX_NETWORK_ERROR): Exchange connection failed\\n- **40** (CFFEX_OVER_REQUEST): Too many pending requests\\n- **41** (CFFEX_OVER_REQUEST_PER_SECOND): Request rate limit exceeded\\n\\n**Handling in System:**\\n\\nPosition queries may fail during market hours - see [trader/strategy/brother2.py:114-154]():\\n```python\\nasync def refresh_position(self):\\n    try:\\n        logger.debug('...')\\n        pos_list = await self.query('InvestorPositionDetail')\\n        # Process positions...\\n    except Exception as e:\\n        logger.warning(f'refresh_position : {repr(e)}', exc_info=True)\\n```\\n\\nSources: [trader/utils/error.xml:11-267](), [trader/strategy/brother2.py:114-154]()\\n\\n---\\n\\n## Order Execution Problems\\n\\n### Price Limit Violations\\n\\n**Symptom:**\\nOrders rejected with status `OST_Canceled` and submit status `OSS_InsertRejected`\\n\\n**Root Cause:**\\nOrder price exceeds exchange price limits (typically 10% of settlement price)\\n\\n**System Behavior:**\\n\\nThe system automatically handles price limit rejections with exponential backoff - see [trader/strategy/brother2.py:522-564]():\\n\\n```mermaid\\ngraph TB\\n    Rejected[Order Rejected\\u003cbr/\\u003ePrice Beyond Limit]\\n    GetLastBar[Get Last DailyBar\\u003cbr/\\u003efor settlement price]\\n    CalcDelta[\\\"Calculate Delta\\u003cbr/\\u003edelta = (price - settlement)  0.5\\\"]\\n    CalcNewPrice[\\\"New Price\\u003cbr/\\u003esettlement  delta\\\"]\\n    CheckMinDelta{delta/settlement\\u003cbr/\\u003e\\u003e 1%?}\\n    RoundPrice[\\\"Round to price_tick\\\"]\\n    Resubmit[ReqOrderInsert\\u003cbr/\\u003ewith new price]\\n    Abandon[\\\"Log Warning\\u003cbr/\\u003eAbandon Order\\\"]\\n    \\n    Rejected --\\u003e GetLastBar\\n    GetLastBar --\\u003e CalcDelta\\n    CalcDelta --\\u003e CalcNewPrice\\n    CalcNewPrice --\\u003e CheckMinDelta\\n    CheckMinDelta --\\u003e|Yes| RoundPrice\\n    CheckMinDelta --\\u003e|No| Abandon\\n    RoundPrice --\\u003e Resubmit\\n```\\n\\n**Example:**\\n\\n```\\nOriginal buy order: price = 5500 (limit is 5400)\\nSettlement price: 5000\\nDelta: (5500 - 5000)  0.5 = 250\\nNew price: 5000 + 250 = 5250\\nCheck: 250 / 5000 = 5% \\u003e 1%  (valid)\\nResult: Resubmit at 5250\\n```\\n\\n**Manual Intervention:**\\n\\nIf automated retry fails, check:\\n1. Is settlement price accurate? Query `DailyBar.settlement`\\n2. Is price_tick correct? Check `Instrument.price_tick`\\n3. Are limit ratios current? Check Redis key: `LIMITRATIO:{exchange}:{product}:{code}`\\n\\nSources: [trader/strategy/brother2.py:522-564,858-870]()\\n\\n---\\n\\n### Insufficient Margin\\n\\n**Symptom:**\\n- Error code 31: \\\"CTP:\\\"\\n- Orders rejected before submission\\n- Warning: \\\"\\\"\\n\\n**Risk Check:**\\n\\nBefore generating signals, the system checks total margin requirement - see [trader/strategy/brother2.py:719-721]():\\n\\n```python\\nif (all_margin + self.__margin) / self.__current \\u003e 0.8:\\n    logger.info(f\\\": {all_margin:.0f}({all_margin / 10000:.1f}) \\\"\\n                f\\\": {100 * (all_margin + self.__margin) / self.__current:.0f}% \\\"\\n                f\\\"\\\")\\n```\\n\\n**Diagnosis:**\\n\\n1. **Query current account status:**\\n   ```python\\n   # Check broker model\\n   broker = Broker.objects.get(name='your_broker')\\n   print(f\\\"Cash: {broker.cash}\\\")\\n   print(f\\\"Margin: {broker.margin}\\\")\\n   print(f\\\"Current: {broker.current}\\\")\\n   print(f\\\"Risk: {broker.margin / broker.current * 100:.1f}%\\\")\\n   ```\\n\\n2. **Check recent trades:**\\n   ```python\\n   # Sum frozen margin for open positions\\n   total_margin = Trade.objects.filter(\\n       close_time__isnull=True\\n   ).aggregate(Sum('frozen_margin'))['frozen_margin__sum']\\n   ```\\n\\n3. **Verify margin rate:**\\n   ```python\\n   inst = Instrument.objects.get(product_code='rb')\\n   print(f\\\"Margin rate: {inst.margin_rate}\\\")\\n   # Should be decimal like 0.10 for 10%\\n   ```\\n\\n**Solutions:**\\n\\n1. **Add funds:** Deposit more margin to account\\n2. **Reduce position size:** Lower `Risk` parameter in strategy\\n3. **Close losing positions:** Free up margin\\n4. **Adjust risk parameters:**\\n   ```python\\n   # In strategy parameters\\n   risk = strategy.param_set.get(code='Risk')\\n   risk.float_value = 0.005  # Reduce from 0.01 to 0.005\\n   risk.save()\\n   ```\\n\\n**Margin Calculation:**\\n\\nFor new positions, margin is calculated at [trader/strategy/brother2.py:840]():\\n```python\\nuse_margin = new_bar.settlement * inst.volume_multiple * inst.margin_rate * volume\\n```\\n\\nSources: [trader/strategy/brother2.py:86-112,719-721,832-844]()\\n\\n---\\n\\n### Duplicate Order Submissions\\n\\n**Symptom:**\\n- Error code 22: \\\"CTP:\\\"\\n- Multiple orders for same signal\\n\\n**Root Cause:**\\n\\nOrderRef collision - CTP requires unique OrderRef for each order. The system generates OrderRef from:\\n- Autonumber sequence (7 digits)\\n- Signal ID (5 digits)\\n\\nSee [trader/strategy/brother2.py:304-305]():\\n```python\\nautoid = Autonumber.objects.create()\\norder_ref = f\\\"{autoid.id:07}{sig.id:05}\\\"\\n```\\n\\n**Diagnosis:**\\n\\n```mermaid\\ngraph LR\\n    Signal[Signal Created\\u003cbr/\\u003eid=12345]\\n    Autonumber[Autonumber.create\\u003cbr/\\u003eid=9999]\\n    OrderRef[\\\"OrderRef\\u003cbr/\\u003e0000999912345\\\"]\\n    Order[Order Submitted\\u003cbr/\\u003eto CTP]\\n    \\n    Signal --\\u003e Autonumber\\n    Autonumber --\\u003e OrderRef\\n    OrderRef --\\u003e Order\\n    \\n    Duplicate{OrderRef\\u003cbr/\\u003eAlready Used?}\\n    Order --\\u003e Duplicate\\n    Duplicate --\\u003e|Yes| Error[Error 22:\\u003cbr/\\u003eDuplicate OrderRef]\\n    Duplicate --\\u003e|No| Success[Order Accepted]\\n```\\n\\n**Solutions:**\\n\\n1. **Check Autonumber table:**\\n   ```sql\\n   SELECT MAX(id) FROM panel_autonumber;\\n   # Should be incrementing\\n   ```\\n\\n2. **Check for stuck transactions:**\\n   ```python\\n   # If database locks preventing increment\\n   from django.db import connection\\n   with connection.cursor() as cursor:\\n       cursor.execute(\\\"SHOW PROCESSLIST\\\")\\n       print(cursor.fetchall())\\n   ```\\n\\n3. **Reset sequence if necessary:**\\n   ```sql\\n   -- MySQL\\n   ALTER TABLE panel_autonumber AUTO_INCREMENT = 1000000;\\n   ```\\n\\n4. **Check for manual orders:**\\n   Orders with OrderRef \\u003c 10000 are considered manual - see [trader/strategy/brother2.py:400,474]()\\n\\n**Prevention:**\\n\\nThe system marks signals as processed after completion - [trader/strategy/brother2.py:463-465]():\\n```python\\nif trade_completed and not manual_trade:\\n    signal.processed = True\\n    signal.save(update_fields=['processed'])\\n```\\n\\nSources: [trader/strategy/brother2.py:301-343,400,463-467,474-476]()\\n\\n---\\n\\n## Data Synchronization Issues\\n\\n### Position Synchronization Failures\\n\\n**Symptoms:**\\n- Trade records don't match CTP positions\\n- Missing positions in database\\n- Stale position data\\n\\n**Synchronization Flow:**\\n\\n```mermaid\\nsequenceDiagram\\n    participant Cron as Cron Job\\u003cbr/\\u003e15:20 daily\\n    participant TS as TradeStrategy\\n    participant CTP as CTP API\\n    participant DB as MySQL Database\\n    \\n    Cron-\\u003e\\u003eTS: refresh_all()\\n    TS-\\u003e\\u003eCTP: Query InvestorPositionDetail\\n    CTP--\\u003e\\u003eTS: Position list\\n    \\n    loop For each position\\n        TS-\\u003e\\u003eDB: Find or Create Trade\\n        TS-\\u003e\\u003eDB: Update shares, profit\\n    end\\n    \\n    TS-\\u003e\\u003eDB: Delete closed positions\\u003cbr/\\u003enot in CTP\\n    TS--\\u003e\\u003eCron: Complete\\n```\\n\\n**Root Causes:**\\n\\n1. **Network failure during sync** - Query times out\\n2. **Position opened manually** - Not tracked by system\\n3. **Database transaction failure** - Partial update\\n4. **Position changed during sync** - Race condition\\n\\n**Diagnosis Steps:**\\n\\n1. **Compare CTP vs Database:**\\n   ```python\\n   # In Django shell\\n   from panel.models import Trade\\n   \\n   # Active trades in database\\n   db_positions = Trade.objects.filter(close_time__isnull=True)\\n   for trade in db_positions:\\n       print(f\\\"{trade.code}: {trade.shares} shares, direction={trade.direction}\\\")\\n   ```\\n\\n2. **Check last sync time:**\\n   ```python\\n   broker = Broker.objects.get(name='your_broker')\\n   print(f\\\"Last update: {broker.modified_time}\\\")\\n   ```\\n\\n3. **Manual sync:**\\n   ```python\\n   # Trigger sync manually (during trading hours)\\n   await strategy.refresh_position()\\n   ```\\n\\n**Position Sync Logic:**\\n\\nThe system aggregates positions by instrument - see [trader/strategy/brother2.py:119-131]():\\n\\n```python\\nfor pos in pos_list:\\n    if pos['Volume'] \\u003e 0:\\n        old_pos = self.__cur_pos.get(pos['InstrumentID'])\\n        if old_pos is None:\\n            self.__cur_pos[pos['InstrumentID']] = pos\\n        else:\\n            # Average position price\\n            old_pos['OpenPrice'] = (\\n                old_pos['OpenPrice'] * old_pos['Volume'] + \\n                pos['OpenPrice'] * pos['Volume']\\n            ) / (old_pos['Volume'] + pos['Volume'])\\n            old_pos['Volume'] += pos['Volume']\\n```\\n\\n**Cleanup Process:**\\n\\nPositions closed in CTP but still in database are deleted - [trader/strategy/brother2.py:131]():\\n```python\\nTrade.objects.filter(\\n    ~Q(code__in=self.__cur_pos.keys()), \\n    close_time__isnull=True\\n).delete()\\n```\\n\\n**Solutions:**\\n\\n1. **Run scheduled refresh:**\\n   The system automatically syncs at 15:20 daily - [trader/strategy/brother2.py:644-654]()\\n\\n2. **Force immediate sync:**\\n   ```bash\\n   # In Django shell during trading hours\\n   from trader.strategy.brother2 import TradeStrategy\\n   strategy = TradeStrategy('your_strategy_name')\\n   await strategy.start()  # Includes refresh_position\\n   ```\\n\\n3. **Check for lock conflicts:**\\n   ```sql\\n   -- MySQL\\n   SELECT * FROM INFORMATION_SCHEMA.INNODB_LOCKS;\\n   ```\\n\\n4. **Verify position details:**\\n   ```python\\n   # Check CTP raw position data\\n   pos_list = await strategy.query('InvestorPositionDetail')\\n   for pos in pos_list:\\n       if not pos.get('empty'):\\n           print(f\\\"CTP: {pos['InstrumentID']} {pos['Direction']} \\\"\\n                 f\\\"{pos['Volume']}@{pos['OpenPrice']}\\\")\\n   ```\\n\\nSources: [trader/strategy/brother2.py:114-154,644-654]()\\n\\n---\\n\\n### Account Balance Discrepancies\\n\\n**Symptoms:**\\n- `broker.cash` doesn't match CTP account\\n- `broker.current` (equity) incorrect\\n- Performance NAV calculation wrong\\n\\n**Account Fields:**\\n\\n| Field | Source | Calculation | Updated |\\n|-------|--------|-------------|---------|\\n| `cash` | CTP | `Available` | 15:20 refresh |\\n| `pre_balance` | CTP | `PreBalance + Deposit - Withdraw` | 15:20 refresh |\\n| `current` | CTP | `pre_balance + CloseProfit + PositionProfit - Commission` | 15:20 refresh |\\n| `margin` | CTP | `CurrMargin` | 15:20 refresh |\\n| `fake` | Calculated | Original fake - Deposit + Withdraw | 15:30 equity update |\\n\\n**Refresh Logic:**\\n\\nSee [trader/strategy/brother2.py:86-112]():\\n\\n```python\\nasync def refresh_account(self):\\n    account = await self.query('TradingAccount')\\n    account = account[0]\\n    \\n    self.__withdraw = Decimal(account['Withdraw'])\\n    self.__deposit = Decimal(account['Deposit'])\\n    \\n    # Adjust pre_balance for deposits/withdrawals\\n    self.__pre_balance = (\\n        Decimal(account['PreBalance']) + \\n        self.__deposit - \\n        self.__withdraw\\n    )\\n    \\n    # Calculate current equity\\n    self.__current = (\\n        self.__pre_balance + \\n        Decimal(account['CloseProfit']) + \\n        Decimal(account['PositionProfit']) - \\n        Decimal(account['Commission'])\\n    )\\n```\\n\\n**Diagnosis:**\\n\\n1. **Check raw CTP data:**\\n   ```python\\n   account = await strategy.query('TradingAccount')\\n   print(f\\\"CTP Available: {account[0]['Available']}\\\")\\n   print(f\\\"CTP Current: {account[0]['Balance']}\\\")\\n   ```\\n\\n2. **Verify deposits/withdrawals:**\\n   ```python\\n   broker = Broker.objects.get(name='your_broker')\\n   print(f\\\"Deposit: {broker.deposit}\\\")\\n   print(f\\\"Withdraw: {broker.withdraw}\\\")\\n   ```\\n\\n3. **Check Performance records:**\\n   ```python\\n   last_perf = Performance.objects.filter(\\n       broker=broker\\n   ).order_by('-day').first()\\n   print(f\\\"NAV: {last_perf.NAV}\\\")\\n   print(f\\\"Accumulated: {last_perf.accumulated}\\\")\\n   ```\\n\\n**Solutions:**\\n\\n1. **Manual account refresh:**\\n   ```python\\n   await strategy.refresh_account()\\n   ```\\n\\n2. **Recalculate equity:**\\n   The system updates equity daily at 15:30 - [trader/strategy/brother2.py:656-682]()\\n\\n3. **Check for missing Performance records:**\\n   ```sql\\n   SELECT * FROM panel_performance \\n   WHERE broker_id = YOUR_BROKER_ID \\n   ORDER BY day DESC \\n   LIMIT 10;\\n   ```\\n\\nSources: [trader/strategy/brother2.py:86-112,656-682]()\\n\\n---\\n\\n### Exchange Data Acquisition Failures\\n\\n**Symptoms:**\\n- Missing DailyBar records for current date\\n- \\\"\\\" (Daily bar not found) warnings\\n- Signal generation fails\\n\\n**Data Collection Process:**\\n\\n```mermaid\\ngraph TB\\n    Cron[\\\"Cron: 17:00\\u003cbr/\\u003ecollect_quote()\\\"]\\n    Tasks[\\\"Async Tasks:\\u003cbr/\\u003eupdate_from_shfe\\u003cbr/\\u003eupdate_from_dce\\u003cbr/\\u003eupdate_from_czce\\u003cbr/\\u003eupdate_from_cffex\\u003cbr/\\u003eupdate_from_gfex\\u003cbr/\\u003eget_contracts_argument\\\"]\\n    \\n    Gather[\\\"asyncio.gather\\u003cbr/\\u003ereturn_exceptions=True\\\"]\\n    CheckResult{All\\u003cbr/\\u003eSucceeded?}\\n    Calculate[\\\"calculate()\\u003cbr/\\u003eGenerate signals\\\"]\\n    RetryLater[\\\"Retry after 10min\\u003cbr/\\u003eFailed tasks only\\\"]\\n    \\n    Cron --\\u003e Tasks\\n    Tasks --\\u003e Gather\\n    Gather --\\u003e CheckResult\\n    CheckResult --\\u003e|Yes| Calculate\\n    CheckResult --\\u003e|No| RetryLater\\n    RetryLater --\\u003e Tasks\\n```\\n\\n**Error Handling:**\\n\\nThe system retries failed exchanges - see [trader/strategy/brother2.py:693-700]():\\n\\n```python\\nresult = await asyncio.gather(\\n    *[func(day) for func in tasks], \\n    return_exceptions=True\\n)\\nif all(result):\\n    self.io_loop.call_soon(self.calculate, day)\\nelse:\\n    failed_tasks = [tasks[i] for i, rst in enumerate(result) if not rst]\\n    self.io_loop.call_later(\\n        10 * 60,  # 10 minutes\\n        asyncio.create_task, \\n        self.collect_quote(failed_tasks)\\n    )\\n```\\n\\n**Common Failures:**\\n\\n1. **Network timeout:**\\n   - Exchange website slow or unavailable\\n   - Increase timeout in aiohttp calls\\n\\n2. **Data format changed:**\\n   - Exchange updated API response format\\n   - Check parsing logic in `trader/utils/__init__.py`\\n\\n3. **Holiday/weekend:**\\n   - No data published on non-trading days\\n   - System checks trading day first: [trader/strategy/brother2.py:688]()\\n\\n4. **Authentication required:**\\n   - Some APIs require tokens\\n   - Check API keys in config.ini\\n\\n**Diagnosis:**\\n\\n1. **Check recent DailyBar records:**\\n   ```python\\n   from panel.models import DailyBar\\n   today = timezone.localtime().date()\\n   \\n   bars_today = DailyBar.objects.filter(time=today).count()\\n   print(f\\\"Bars collected today: {bars_today}\\\")\\n   \\n   # Check by exchange\\n   for exchange in ['SHFE', 'DCE', 'CZCE', 'CFFEX', 'GFEX']:\\n       count = DailyBar.objects.filter(\\n           time=today, \\n           exchange=exchange\\n       ).count()\\n       print(f\\\"{exchange}: {count} bars\\\")\\n   ```\\n\\n2. **Test individual exchange function:**\\n   ```python\\n   from trader.utils import update_from_shfe\\n   import asyncio\\n   \\n   result = await update_from_shfe(timezone.localtime())\\n   print(f\\\"SHFE update result: {result}\\\")\\n   ```\\n\\n3. **Check system logs:**\\n   ```bash\\n   grep \\\"collect_quote\\\" /var/log/trader.log\\n   grep \\\"\\\" /var/log/trader.log\\n   ```\\n\\n**Solutions:**\\n\\n1. **Wait for automatic retry** - System retries after 10 minutes\\n\\n2. **Manual data collection:**\\n   ```python\\n   # In Django shell\\n   from trader.strategy.brother2 import TradeStrategy\\n   strategy = TradeStrategy('your_strategy_name')\\n   await strategy.collect_quote()\\n   ```\\n\\n3. **Run individual exchange updates:**\\n   ```python\\n   from trader.utils import (\\n       update_from_shfe, update_from_dce, \\n       update_from_czce, update_from_cffex, update_from_gfex\\n   )\\n   from django.utils import timezone\\n   \\n   day = timezone.localtime()\\n   await update_from_shfe(day)  # Update only SHFE\\n   ```\\n\\n4. **Check exchange website directly:**\\n   - SHFE: http://www.shfe.com.cn/\\n   - DCE: http://www.dce.com.cn/\\n   - CZCE: http://www.czce.com.cn/\\n   - CFFEX: http://www.cffex.com.cn/\\n\\nSources: [trader/strategy/brother2.py:684-703](), [trader/utils/__init__.py]()\\n\\n---\\n\\n## Signal Processing Issues\\n\\n### Signals Not Being Processed\\n\\n**Symptoms:**\\n- Signals with `processed=False` not executing\\n- Orders not submitted despite signals\\n- Log shows \\\"\\\" but no order activity\\n\\n**Signal Processing Schedule:**\\n\\n```mermaid\\ngantt\\n    title Daily Signal Processing Schedule\\n    dateFormat HH:mm\\n    axisFormat %H:%M\\n    \\n    section Day Session\\n    processing_signal1 (Non-CFFEX, Day only)   :08:55, 1m\\n    Check signal1 processed                      :09:01, 1m\\n    processing_signal2 (CFFEX only)              :09:25, 1m\\n    Check signal2 processed                      :09:31, 1m\\n    \\n    section Night Session\\n    processing_signal3 (Night trade)             :20:55, 1m\\n    Check signal3 processed                      :21:01, 1m\\n    \\n    section Market Close\\n    refresh_all (Account \\u0026 Positions)            :15:20, 1m\\n    update_equity (Performance)                  :15:30, 1m\\n    collect_quote (Data collection)              :17:00, 1m\\n```\\n\\n**Signal Processing Logic:**\\n\\nThree separate cron jobs handle different trading sessions:\\n\\n1. **Day session (08:55)** - [trader/strategy/brother2.py:572-585]():\\n   ```python\\n   # Non-CFFEX instruments, day trade only\\n   Signal.objects.filter(\\n       ~Q(instrument__exchange=ExchangeType.CFFEX),\\n       trigger_time__gte=self.__last_trading_day,\\n       instrument__night_trade=False,\\n       processed=False\\n   )\\n   ```\\n\\n2. **CFFEX session (09:25)** - [trader/strategy/brother2.py:598-608]():\\n   ```python\\n   # CFFEX (stock index futures and treasury bonds)\\n   Signal.objects.filter(\\n       instrument__exchange=ExchangeType.CFFEX,\\n       trigger_time__gte=self.__last_trading_day,\\n       processed=False\\n   )\\n   ```\\n\\n3. **Night session (20:55)** - [trader/strategy/brother2.py:621-631]():\\n   ```python\\n   # Instruments with night trading\\n   Signal.objects.filter(\\n       trigger_time__gte=self.__last_trading_day,\\n       instrument__night_trade=True,\\n       processed=False\\n   )\\n   ```\\n\\n**Diagnosis:**\\n\\n1. **Check unprocessed signals:**\\n   ```python\\n   from panel.models import Signal\\n   \\n   unprocessed = Signal.objects.filter(processed=False)\\n   for sig in unprocessed:\\n       print(f\\\"{sig.trigger_time} {sig.instrument} {sig.type} \\\"\\n             f\\\"{sig.volume}@{sig.price} processed={sig.processed}\\\")\\n   ```\\n\\n2. **Verify signal timestamp:**\\n   ```python\\n   # Signal must have trigger_time \\u003e= last_trading_day\\n   strategy = Strategy.objects.get(name='your_strategy')\\n   last_trading_day = strategy.broker.last_trading_day\\n   \\n   old_signals = Signal.objects.filter(\\n       processed=False,\\n       trigger_time__lt=last_trading_day\\n   )\\n   print(f\\\"Stale signals: {old_signals.count()}\\\")\\n   ```\\n\\n3. **Check trading day status:**\\n   ```python\\n   from trader.utils import is_trading_day\\n   \\n   today = timezone.localtime()\\n   _, trading = await is_trading_day(today)\\n   print(f\\\"Is trading day: {trading}\\\")\\n   ```\\n\\n4. **Check instrument configuration:**\\n   ```python\\n   inst = Instrument.objects.get(product_code='rb')\\n   print(f\\\"Exchange: {inst.exchange}\\\")\\n   print(f\\\"Night trade: {inst.night_trade}\\\")\\n   ```\\n\\n**Common Issues:**\\n\\n1. **System clock mismatch:**\\n   - Signal trigger_time is in future\\n   - Server timezone incorrect\\n\\n2. **Wrong instrument configuration:**\\n   - `night_trade` flag incorrect\\n   - Exchange type wrong\\n\\n3. **Holiday processing:**\\n   - After long holiday, signals may accumulate\\n   - System processes backlog: [trader/strategy/brother2.py:583-585]()\\n\\n4. **Signal priority:**\\n   - High priority signals processed first\\n   - Check `signal.priority` field\\n\\n**Solutions:**\\n\\n1. **Manual signal processing:**\\n   ```python\\n   # During appropriate trading session\\n   await strategy.processing_signal1()  # Day session\\n   await strategy.processing_signal2()  # CFFEX\\n   await strategy.processing_signal3()  # Night session\\n   ```\\n\\n2. **Force signal processed:**\\n   ```python\\n   signal = Signal.objects.get(id=12345)\\n   signal.processed = True\\n   signal.save()\\n   ```\\n\\n3. **Check cron scheduling:**\\n   ```python\\n   # Verify cron decorator active\\n   from trader.strategy.brother2 import TradeStrategy\\n   strategy = TradeStrategy('your_strategy')\\n   # Should see scheduled tasks in logs\\n   ```\\n\\n4. **Clear stale signals:**\\n   ```sql\\n   -- Mark old signals as processed\\n   UPDATE panel_signal \\n   SET processed = TRUE \\n   WHERE trigger_time \\u003c '2024-01-01' \\n   AND processed = FALSE;\\n   ```\\n\\nSources: [trader/strategy/brother2.py:572-642]()\\n\\n---\\n\\n### Signal Generation Failures\\n\\n**Symptoms:**\\n- No signals generated after market close\\n- \\\"calculate \\\" in logs\\n- Missing entries in Signal table\\n\\n**Signal Generation Flow:**\\n\\n```mermaid\\ngraph TB\\n    CollectQuote[\\\"collect_quote()\\u003cbr/\\u003e17:00 daily\\\"]\\n    FetchData[\\\"Fetch exchange data\\u003cbr/\\u003eupdate_from_*\\\"]\\n    Calculate[\\\"calculate()\\u003cbr/\\u003eGenerate signals\\\"]\\n    CalcMain[\\\"calc_main_inst\\u003cbr/\\u003eSelect main contract\\\"]\\n    CalcSignal[\\\"calc_signal\\u003cbr/\\u003eFor each instrument\\\"]\\n    \\n    CheckData{All data\\u003cbr/\\u003efetched?}\\n    CheckPosition{Has\\u003cbr/\\u003eposition?}\\n    CheckTrend{Trend\\u003cbr/\\u003ebreakout?}\\n    \\n    GenSignal[\\\"Generate Signal:\\u003cbr/\\u003eBUY/SELL/ROLL\\\"]\\n    SaveSignal[\\\"Save to database\\u003cbr/\\u003eprocessed=False\\\"]\\n    \\n    CollectQuote --\\u003e FetchData\\n    FetchData --\\u003e CheckData\\n    CheckData --\\u003e|Yes| Calculate\\n    CheckData --\\u003e|No| RetryLater[\\\"Retry in 10min\\\"]\\n    \\n    Calculate --\\u003e CalcMain\\n    CalcMain --\\u003e CalcSignal\\n    CalcSignal --\\u003e CheckPosition\\n    \\n    CheckPosition --\\u003e|Yes| CheckStopLoss[Check stop loss]\\n    CheckPosition --\\u003e|No| CheckTrend\\n    \\n    CheckStopLoss --\\u003e GenSignal\\n    CheckTrend --\\u003e|Yes| GenSignal\\n    CheckTrend --\\u003e|No| NoSignal[No signal]\\n    \\n    GenSignal --\\u003e SaveSignal\\n```\\n\\n**Signal Calculation Logic:**\\n\\nSee [trader/strategy/brother2.py:725-856]():\\n\\nKey components:\\n1. **Technical indicators:** ATR, SMA (short/long), high/low lines\\n2. **Breakout detection:** Close \\u003e previous high or \\u003c previous low\\n3. **Trend confirmation:** Short MA vs Long MA\\n4. **Position sizing:** Based on ATR and risk parameter\\n\\n**Common Failures:**\\n\\n1. **Missing main contract:**\\n   ```python\\n   inst = Instrument.objects.get(product_code='rb')\\n   if not inst.main_code:\\n       print(\\\"Main contract not set - run calc_main_inst\\\")\\n   ```\\n\\n2. **Insufficient DailyBar data:**\\n   ```python\\n   # Need at least 400 bars for calculation\\n   bar_count = DailyBar.objects.filter(\\n       exchange=inst.exchange,\\n       product_code=inst.product_code\\n   ).count()\\n   print(f\\\"Available bars: {bar_count}\\\")\\n   ```\\n\\n3. **TA-Lib calculation error:**\\n   - ATR, SMA require minimum periods\\n   - NaN values in price data\\n\\n4. **Risk calculation error:**\\n   ```python\\n   # Volume must be \\u003e 0\\n   # risk_each = ATR * volume_multiple\\n   # volume = (capital * risk) / risk_each\\n   # If volume rounds to 0, signal not generated\\n   ```\\n\\n**Diagnosis:**\\n\\n1. **Check calculation was called:**\\n   ```bash\\n   grep \\\"\\\" /var/log/trader.log\\n   grep \\\"calculate \\\" /var/log/trader.log\\n   ```\\n\\n2. **Test signal calculation manually:**\\n   ```python\\n   from trader.strategy.brother2 import TradeStrategy\\n   strategy = TradeStrategy('your_strategy_name')\\n   \\n   inst = Instrument.objects.get(product_code='rb')\\n   day = timezone.localtime()\\n   signal, margin = strategy.calc_signal(inst, day)\\n   print(f\\\"Signal: {signal}, Margin: {margin}\\\")\\n   ```\\n\\n3. **Check MainBar continuity:**\\n   ```python\\n   bars = MainBar.objects.filter(\\n       exchange=inst.exchange,\\n       product_code=inst.product_code\\n   ).order_by('-time')[:5]\\n   \\n   for bar in bars:\\n       print(f\\\"{bar.time}: O={bar.open} H={bar.high} \\\"\\n             f\\\"L={bar.low} C={bar.close}\\\")\\n   ```\\n\\n4. **Verify strategy parameters:**\\n   ```python\\n   strategy = Strategy.objects.get(name='your_strategy')\\n   for param in strategy.param_set.all():\\n       print(f\\\"{param.code}: {param.int_value or param.float_value}\\\")\\n   ```\\n\\n**Solutions:**\\n\\n1. **Regenerate main contracts:**\\n   ```python\\n   from trader.utils import calc_main_inst\\n   \\n   for inst in Instrument.objects.all():\\n       calc_main_inst(inst, timezone.localtime())\\n   ```\\n\\n2. **Manually trigger calculation:**\\n   ```python\\n   strategy.calculate(timezone.localtime(), create_main_bar=True)\\n   ```\\n\\n3. **Check data quality:**\\n   ```sql\\n   -- Find bars with NULL values\\n   SELECT * FROM panel_dailybar \\n   WHERE close IS NULL OR high IS NULL OR low IS NULL\\n   ORDER BY time DESC LIMIT 10;\\n   ```\\n\\n4. **Adjust risk parameters:**\\n   ```python\\n   # If volumes are consistently 0\\n   risk_param = strategy.param_set.get(code='Risk')\\n   risk_param.float_value = 0.02  # Increase risk allocation\\n   risk_param.save()\\n   ```\\n\\nSources: [trader/strategy/brother2.py:705-856]()\\n\\n---\\n\\n## Query Timeouts\\n\\n**Symptoms:**\\n- `asyncio.TimeoutError` exceptions\\n- Operations hang indefinitely\\n- \\\"Query timeout\\\" in logs\\n\\n**Timeout Configuration:**\\n\\nSet in [trader/strategy/brother2.py:35]():\\n```python\\nHANDLER_TIME_OUT = config.getint('TRADE', 'command_timeout', fallback=10)\\n```\\n\\nApplied to:\\n- `query()`: [trader/strategy/brother2.py:248]()\\n- `SubscribeMarketData()`: [trader/strategy/brother2.py:269]()\\n- `UnSubscribeMarketData()`: [trader/strategy/brother2.py:290]()\\n- `cancel_order()`: [trader/strategy/brother2.py:358]()\\n\\n**Timeout Flow:**\\n\\n```mermaid\\nsequenceDiagram\\n    participant TS as TradeStrategy\\n    participant Redis as Redis PubSub\\n    participant CTP as CTP Gateway\\n    \\n    TS-\\u003e\\u003eRedis: Subscribe to response channel\\n    TS-\\u003e\\u003eRedis: Publish query request\\n    TS-\\u003e\\u003eTS: asyncio.wait_for(task, timeout)\\n    \\n    alt Response within timeout\\n        CTP-\\u003e\\u003eRedis: Publish response\\n        Redis-\\u003e\\u003eTS: Response received\\n        TS-\\u003e\\u003eTS: Return result\\n    else Timeout exceeded\\n        TS-\\u003e\\u003eTS: asyncio.TimeoutError\\n        TS-\\u003e\\u003eRedis: Unsubscribe\\n        TS-\\u003e\\u003eTS: Log warning, return None\\n    end\\n```\\n\\n**Common Causes:**\\n\\n1. **Network latency:**\\n   - CTP server slow\\n   - Network congestion\\n   - VPN overhead\\n\\n2. **CTP server busy:**\\n   - Peak trading hours\\n   - Multiple queries queued\\n   - Error code 90: \\\"\\\"\\n\\n3. **Redis pub/sub lag:**\\n   - Redis under heavy load\\n   - Too many subscribers\\n   - Network between trader and Redis\\n\\n4. **Timeout too short:**\\n   - Default 10 seconds may be insufficient\\n   - Complex queries need more time\\n\\n**Diagnosis:**\\n\\n1. **Measure query latency:**\\n   ```python\\n   import time\\n   start = time.time()\\n   result = await strategy.query('TradingAccount')\\n   elapsed = time.time() - start\\n   print(f\\\"Query took {elapsed:.2f} seconds\\\")\\n   ```\\n\\n2. **Test Redis latency:**\\n   ```bash\\n   redis-cli --latency\\n   # Should be \\u003c 1ms locally\\n   ```\\n\\n3. **Monitor CTP response time:**\\n   ```bash\\n   redis-cli MONITOR | grep \\\"MSG:CTP:RSP\\\"\\n   # Watch for delays between REQ and RSP\\n   ```\\n\\n4. **Check network conditions:**\\n   ```bash\\n   ping ctp_server_ip\\n   traceroute ctp_server_ip\\n   ```\\n\\n**Solutions:**\\n\\n1. **Increase timeout:**\\n   ```ini\\n   [TRADE]\\n   command_timeout = 20  # Increase from 10 to 20 seconds\\n   ```\\n\\n2. **Retry with backoff:**\\n   ```python\\n   async def query_with_retry(self, query_type, max_retries=3, **kwargs):\\n       for i in range(max_retries):\\n           try:\\n               result = await self.query(query_type, **kwargs)\\n               if result:\\n                   return result\\n           except asyncio.TimeoutError:\\n               if i \\u003c max_retries - 1:\\n                   await asyncio.sleep(2 ** i)  # Exponential backoff\\n               else:\\n                   raise\\n   ```\\n\\n3. **Use async query (no response):**\\n   For non-critical queries - [trader/strategy/brother2.py:220-223]():\\n   ```python\\n   # Fire and forget - no timeout\\n   strategy.async_query('Instrument')\\n   ```\\n\\n4. **Optimize query frequency:**\\n   - Don't query during busy market hours\\n   - Cache results when possible\\n   - Use scheduled refreshes instead of on-demand\\n\\n5. **Check CTP gateway health:**\\n   ```bash\\n   # Monitor CTP process\\n   ps aux | grep ctp\\n   top -p \\u003cctp_pid\\u003e\\n   ```\\n\\nSources: [trader/strategy/brother2.py:35,220-257,259-299,345-371]()\\n\\n---\\n\\n## Debugging Strategies\\n\\n### Log Analysis\\n\\n**Log Locations:**\\n\\nThe system uses Python's logging module configured in [trader/utils/read_config.py:56-59]():\\n\\n```ini\\n[LOG]\\nlevel = DEBUG\\nformat = %(asctime)s %(name)s [%(levelname)s] %(message)s\\nweixin_format = [%(levelname)s] %(message)s\\n```\\n\\n**Log Levels:**\\n\\n| Level | Usage | Examples |\\n|-------|-------|----------|\\n| DEBUG | Detailed diagnostics | Query details, position updates |\\n| INFO | Normal operations | Signal generation, order submission |\\n| WARNING | Recoverable errors | Query failures, retry attempts |\\n| ERROR | Serious problems | Exceptions, data corruption |\\n\\n**Key Log Patterns:**\\n\\n```bash\\n# Signal generation\\ngrep \\\"\\\" /var/log/trader.log\\n\\n# Order execution\\ngrep \\\"\\\" /var/log/trader.log\\ngrep \\\"\\\" /var/log/trader.log\\n\\n# Position updates\\ngrep \\\"\\\" /var/log/trader.log\\ngrep \\\"\\\" /var/log/trader.log\\n\\n# Errors\\ngrep \\\"\\\" /var/log/trader.log\\ngrep \\\"WARNING\\\" /var/log/trader.log\\n\\n# Data collection\\ngrep \\\"\\\" /var/log/trader.log\\ngrep \\\"collect_quote\\\" /var/log/trader.log\\n```\\n\\n**Understanding Log Messages:**\\n\\n```\\n2024-01-15 17:05:30 CTPApi [INFO] : rb2(1.8) : 45000(4.5)\\n                    ^       ^      ^                            ^               ^\\n                    |       |      |                            |               |\\n                Timestamp  Logger Signal description       Original volume  Margin required\\n```\\n\\nSources: [trader/strategy/brother2.py:34](), [trader/utils/read_config.py:56-59]()\\n\\n---\\n\\n### Redis Monitoring\\n\\n**Real-time Message Monitoring:**\\n\\n```bash\\n# Monitor all Redis operations\\nredis-cli MONITOR\\n\\n# Filter CTP messages only\\nredis-cli MONITOR | grep \\\"MSG:CTP\\\"\\n\\n# Watch specific channel pattern\\nredis-cli PSUBSCRIBE \\\"MSG:CTP:RSP:TRADE:*\\\"\\n```\\n\\n**Check Active Subscriptions:**\\n\\n```bash\\n# List all pub/sub channels\\nredis-cli PUBSUB CHANNELS\\n\\n# Count subscribers per channel\\nredis-cli PUBSUB NUMSUB \\\"MSG:CTP:REQ:ReqQryInvestorPosition\\\"\\n```\\n\\n**Verify System Heartbeat:**\\n\\n```bash\\n# Check trader is alive\\nredis-cli GET \\\"HEARTBEAT:TRADER\\\"\\n\\n# Monitor heartbeat updates\\nredis-cli --csv GET \\\"HEARTBEAT:TRADER\\\" | xargs -I {} sh -c 'echo \\\"$(date): {}\\\"' \\u0026\\u0026 sleep 1\\n```\\n\\n**Check Cached Data:**\\n\\n```bash\\n# Trading day information\\nredis-cli GET \\\"TradingDay\\\"\\nredis-cli GET \\\"LastTradingDay\\\"\\n\\n# Price limits\\nredis-cli KEYS \\\"LIMITRATIO:*\\\"\\nredis-cli GET \\\"LIMITRATIO:SHFE:rb:rb2405\\\"\\n```\\n\\n**Message Flow Diagram:**\\n\\n```mermaid\\ngraph LR\\n    subgraph \\\"Monitor Points\\\"\\n        M1[Request Channel\\u003cbr/\\u003eMSG:CTP:REQ:*]\\n        M2[Trade Response\\u003cbr/\\u003eMSG:CTP:RSP:TRADE:*]\\n        M3[Market Response\\u003cbr/\\u003eMSG:CTP:RSP:MARKET:*]\\n        M4[Heartbeat\\u003cbr/\\u003eHEARTBEAT:TRADER]\\n    end\\n    \\n    Strategy[TradeStrategy] --\\u003e|Publish| M1\\n    M1 --\\u003e|Subscribe| Gateway[CTP Gateway]\\n    Gateway --\\u003e|Publish| M2\\n    Gateway --\\u003e|Publish| M3\\n    M2 --\\u003e|Subscribe| Strategy\\n    M3 --\\u003e|Subscribe| Strategy\\n    Strategy --\\u003e|SET every 60s| M4\\n```\\n\\nSources: [trader/strategy/brother2.py:41-43,66,570](), [trader/utils/read_config.py:23-31]()\\n\\n---\\n\\n### Database Diagnostics\\n\\n**Query Performance:**\\n\\n```python\\n# Enable query logging in Django\\nfrom django.db import connection\\nfrom django.test.utils import override_settings\\n\\nwith override_settings(DEBUG=True):\\n    # Your code here\\n    print(connection.queries)\\n```\\n\\n**Check Recent Activity:**\\n\\n```sql\\n-- Recent orders\\nSELECT * FROM panel_order \\nORDER BY send_time DESC \\nLIMIT 10;\\n\\n-- Recent trades\\nSELECT * FROM panel_trade \\nWHERE open_time \\u003e DATE_SUB(NOW(), INTERVAL 1 DAY)\\nORDER BY open_time DESC;\\n\\n-- Unprocessed signals\\nSELECT * FROM panel_signal \\nWHERE processed = FALSE \\nORDER BY trigger_time DESC;\\n\\n-- Today's performance\\nSELECT * FROM panel_performance \\nWHERE day = CURDATE();\\n```\\n\\n**Data Consistency Checks:**\\n\\n```sql\\n-- Positions without close_time\\nSELECT instrument_id, code, direction, shares, open_time\\nFROM panel_trade \\nWHERE close_time IS NULL;\\n\\n-- Orders without matching signals\\nSELECT o.* \\nFROM panel_order o\\nLEFT JOIN panel_signal s ON o.signal_id = s.id\\nWHERE o.order_ref \\u003e= '0010000' \\nAND s.id IS NULL;\\n\\n-- Duplicate main contracts\\nSELECT exchange, product_code, COUNT(*) \\nFROM panel_instrument \\nWHERE main_code IS NOT NULL \\nGROUP BY exchange, product_code \\nHAVING COUNT(*) \\u003e 1;\\n```\\n\\n**Slow Query Analysis:**\\n\\n```sql\\n-- MySQL slow query log\\nSHOW VARIABLES LIKE 'slow_query_log%';\\nSET GLOBAL slow_query_log = 'ON';\\nSET GLOBAL long_query_time = 2;\\n\\n-- Analyze table statistics\\nANALYZE TABLE panel_dailybar;\\nANALYZE TABLE panel_mainbar;\\n\\n-- Check for missing indexes\\nSHOW INDEX FROM panel_trade;\\n```\\n\\nSources: [panel/models.py]()\\n\\n---\\n\\n## FAQ\\n\\n### Q: System starts but no orders execute?\\n\\n**A:** Check the following in order:\\n\\n1. **Is it a trading day?**\\n   ```python\\n   from trader.utils import is_trading_day\\n   _, trading = await is_trading_day(timezone.localtime())\\n   ```\\n\\n2. **Are signals generated?**\\n   ```sql\\n   SELECT COUNT(*) FROM panel_signal \\n   WHERE DATE(trigger_time) = CURDATE() AND processed = FALSE;\\n   ```\\n\\n3. **Is CTP connected?**\\n   ```bash\\n   redis-cli PUBSUB CHANNELS \\\"MSG:CTP:*\\\"\\n   # Should see active channels\\n   ```\\n\\n4. **Check system time:**\\n   Orders process at specific times (08:55, 09:25, 20:55)\\n\\n---\\n\\n### Q: Why are my signals not generating?\\n\\n**A:** Signal generation happens at 17:00 daily via `collect_quote()`. Check:\\n\\n1. **Is data collection completing?**\\n   ```bash\\n   grep \\\"\\\" /var/log/trader.log\\n   ```\\n\\n2. **Are DailyBars present?**\\n   ```sql\\n   SELECT COUNT(*) FROM panel_dailybar WHERE time = CURDATE();\\n   ```\\n\\n3. **Is main contract set?**\\n   ```sql\\n   SELECT product_code, main_code FROM panel_instrument WHERE main_code IS NULL;\\n   ```\\n\\n4. **Check calculation errors:**\\n   ```bash\\n   grep \\\"calc_signal \\\" /var/log/trader.log\\n   ```\\n\\n---\\n\\n### Q: How do I manually trigger a data refresh?\\n\\n**A:** Use Django shell:\\n\\n```python\\nfrom trader.strategy.brother2 import TradeStrategy\\nfrom django.utils import timezone\\n\\nstrategy = TradeStrategy('your_strategy_name')\\nawait strategy.start()  # Includes account and position refresh\\n\\n# Or individual refreshes\\nawait strategy.refresh_account()\\nawait strategy.refresh_position()\\nawait strategy.collect_quote()\\n```\\n\\n---\\n\\n### Q: Order rejected with \\\"\\\" but I have cash?\\n\\n**A:** Check margin requirements:\\n\\n```python\\nbroker = Broker.objects.get(name='your_broker')\\nrisk_ratio = broker.margin / broker.current\\nprint(f\\\"Current risk: {risk_ratio * 100:.1f}%\\\")\\n\\n# System prevents opening if risk would exceed 80%\\n```\\n\\nAlso verify:\\n- Frozen margin for pending orders\\n- Margin rate for the instrument\\n- Settlement price vs limit price\\n\\n---\\n\\n### Q: Position counts don't match between system and broker statement?\\n\\n**A:** Run position sync:\\n\\n```python\\nawait strategy.refresh_position()\\n```\\n\\nIf still incorrect:\\n1. Check for manual trades (OrderRef \\u003c 10000)\\n2. Verify position open dates match\\n3. Compare `Trade.shares` vs `Trade.filled_shares`\\n4. Look for partial fills\\n\\n---\\n\\n### Q: How do I reset the system after errors?\\n\\n**A:** Complete reset procedure:\\n\\n```bash\\n# 1. Stop the system\\npkill -f trader.main\\n\\n# 2. Clear Redis cache\\nredis-cli FLUSHDB\\n\\n# 3. Mark old signals as processed\\nmysql -u quant -p QuantDB \\u003c\\u003c EOF\\nUPDATE panel_signal SET processed = TRUE WHERE processed = FALSE;\\nEOF\\n\\n# 4. Restart system\\npython trader/main.py\\n```\\n\\n---\\n\\n### Q: What does \\\"\\\" (rollover) mean in logs?\\n\\n**A:** Contract rollover - switching from expiring contract to next month:\\n\\n```\\nrb2401rb2405 2 : 3850\\n# Old contract: rb2401\\n# New contract: rb2405\\n# Direction: LONG\\n# Action: Open position in new contract\\n```\\n\\nSystem generates two signals:\\n- `ROLL_CLOSE`: Close position in old contract\\n- `ROLL_OPEN`: Open position in new contract\\n\\nSee [trader/strategy/brother2.py:750-751,784-793,816-825]()\\n\\n---\\n\\n### Q: How do I change strategy parameters?\\n\\n**A:** Update via Django admin or shell:\\n\\n```python\\nstrategy = Strategy.objects.get(name='your_strategy')\\n\\n# View current parameters\\nfor param in strategy.param_set.all():\\n    print(f\\\"{param.code}: {param.int_value or param.float_value}\\\")\\n\\n# Update parameter\\nrisk = strategy.param_set.get(code='Risk')\\nrisk.float_value = 0.01  # Change risk from 2% to 1%\\nrisk.save()\\n\\n# Changes take effect on next calculate() run (17:00 daily)\\n```\\n\\n---\\n\\n### Q: System crashed, how to diagnose?\\n\\n**A:** Follow this checklist:\\n\\n1. **Check logs for traceback:**\\n   ```bash\\n   tail -100 /var/log/trader.log | grep -A 20 \\\"Traceback\\\"\\n   ```\\n\\n2. **Verify all services running:**\\n   ```bash\\n   systemctl status redis\\n   systemctl status mysql\\n   ps aux | grep ctp\\n   ```\\n\\n3. **Test database connection:**\\n   ```bash\\n   mysql -u quant -p QuantDB -e \\\"SELECT 1\\\"\\n   ```\\n\\n4. **Test Redis connection:**\\n   ```bash\\n   redis-cli PING\\n   ```\\n\\n5. **Check disk space:**\\n   ```bash\\n   df -h\\n   # MySQL and logs can fill disk\\n   ```\\n\\n6. **Review system resources:**\\n   ```bash\\n   free -h  # Memory\\n   top      # CPU usage\\n   ```\\n\\n---\\n\\nSources: [trader/strategy/brother2.py](), [trader/utils/read_config.py](), [trader/utils/error.xml]()\"])</script><script>self.__next_f.push([1,\"41:T49c9,\"])</script><script>self.__next_f.push([1,\"# Appendix\\n\\n\\u003cdetails\\u003e\\n\\u003csummary\\u003eRelevant source files\\u003c/summary\\u003e\\n\\nThe following files were used as context for generating this wiki page:\\n\\n- [LICENSE.md](LICENSE.md)\\n- [README.rst](README.rst)\\n- [trader/__init__.py](trader/__init__.py)\\n\\n\\u003c/details\\u003e\\n\\n\\n\\nThis appendix provides supplementary reference material for the trader system, including version information, licensing details, external dependencies, terminology glossary, and contribution guidelines. For system architecture details, see [Architecture](#3). For installation and setup procedures, see [Getting Started](#2).\\n\\n---\\n\\n## A.1 Version Information\\n\\nThe trader system follows semantic versioning with version metadata defined in [trader/__init__.py:18-26]().\\n\\n**Current Version**: 0.1\\n\\n**Version Tuple**: `(0, 1, 0, 0)`\\n\\nThe version tuple format is:\\n- **Elements 0-2**: Major, minor, patch version numbers\\n- **Element 3**: Release status indicator\\n  - `0` = Official release\\n  - `\\u003e 0` = Development branch\\n  - `\\u003c 0` = Release candidate or beta\\n\\n**Sources**: [trader/__init__.py:1-27]()\\n\\n---\\n\\n## A.2 License\\n\\nThe trader system is licensed under the **Apache License, Version 2.0**.\\n\\n### License Summary\\n\\n| Aspect | Details |\\n|--------|---------|\\n| License Type | Apache License 2.0 |\\n| Copyright Holder | timercrack (2016) |\\n| Commercial Use | Permitted |\\n| Modification | Permitted with attribution |\\n| Distribution | Permitted under same license |\\n| Patent Grant | Included |\\n| Warranty | None (AS-IS) |\\n\\n### License Headers\\n\\nAll source files include the standard Apache License header as defined in [trader/__init__.py:3-15]():\\n\\n```\\nCopyright 2016 timercrack\\n\\nLicensed under the Apache License, Version 2.0 (the \\\"License\\\");\\nyou may not use this file except in compliance with the License.\\nYou may obtain a copy of the License at\\n\\n    http://www.apache.org/licenses/LICENSE-2.0\\n```\\n\\n### Full License Text\\n\\nThe complete Apache License 2.0 text is available in [LICENSE.md:1-202](). Key provisions include:\\n\\n- **Grant of Copyright License** [LICENSE.md:66-71]() - Perpetual, worldwide, royalty-free license for reproduction and distribution\\n- **Grant of Patent License** [LICENSE.md:73-87]() - Protection against patent litigation\\n- **Redistribution Requirements** [LICENSE.md:89-128]() - Attribution and license notice requirements\\n- **Disclaimer of Warranty** [LICENSE.md:143-151]() - No warranties provided\\n- **Limitation of Liability** [LICENSE.md:153-163]() - Limited liability for damages\\n\\n**Sources**: [LICENSE.md:1-202](), [trader/__init__.py:3-15]()\\n\\n---\\n\\n## A.3 External Dependencies\\n\\nThe trader system integrates with multiple external systems and libraries. This section provides a comprehensive reference.\\n\\n### A.3.1 Core System Dependencies\\n\\n```mermaid\\ngraph TB\\n    subgraph \\\"trader_system[Trader System]\\\"\\n        main[trader/main.py]\\n        strategy[trader/strategy/brother2.py]\\n        utils[trader/utils/__init__.py]\\n    end\\n    \\n    subgraph \\\"python_runtime[Python Runtime Environment]\\\"\\n        python[\\\"Python 3.x\\\"]\\n    end\\n    \\n    subgraph \\\"database_layer[Database Layer]\\\"\\n        django_orm[\\\"Django ORM Framework\\\"]\\n        mysql[\\\"MySQL/MariaDB Server\\\"]\\n        mysql_config[\\\"/etc/my.cnf.d/server.cnf\\\"]\\n    end\\n    \\n    subgraph \\\"message_broker[Message Broker]\\\"\\n        redis_server[\\\"Redis Server\\\"]\\n        aioredis[\\\"aioredis Python Library\\\"]\\n    end\\n    \\n    subgraph \\\"technical_analysis[Technical Analysis]\\\"\\n        talib_c[\\\"TA-Lib C Library\\\"]\\n        talib_python[\\\"TA-Lib Python Wrapper\\\"]\\n    end\\n    \\n    subgraph \\\"async_io[Async I/O]\\\"\\n        aiohttp[\\\"aiohttp Client Library\\\"]\\n        asyncio[\\\"asyncio Standard Library\\\"]\\n    end\\n    \\n    subgraph \\\"ctp_integration[CTP Integration]\\\"\\n        ctp_gateway[\\\"CTP API Gateway Process\\\"]\\n        error_xml[\\\"error.xml\\\"]\\n    end\\n    \\n    main --\\u003e strategy\\n    strategy --\\u003e utils\\n    strategy --\\u003e django_orm\\n    strategy --\\u003e aioredis\\n    strategy --\\u003e aiohttp\\n    \\n    django_orm --\\u003e mysql\\n    mysql --\\u003e mysql_config\\n    \\n    aioredis --\\u003e redis_server\\n    \\n    utils --\\u003e talib_python\\n    talib_python --\\u003e talib_c\\n    \\n    aiohttp --\\u003e asyncio\\n    aioredis --\\u003e asyncio\\n    \\n    strategy --\\u003e ctp_gateway\\n    ctp_gateway --\\u003e error_xml\\n    \\n    python --\\u003e main\\n```\\n\\n**Sources**: [README.rst:1-26](), [trader/main.py](), [trader/strategy/brother2.py]()\\n\\n### A.3.2 Required System Packages\\n\\n| Package | Purpose | Configuration |\\n|---------|---------|---------------|\\n| **TA-Lib C Library** | Technical analysis calculations (RSI, MACD, ATR, SMA) | Must be installed before Python packages |\\n| **MySQL/MariaDB** | Primary data persistence | Configuration in `/etc/my.cnf.d/server.cnf` |\\n| **Redis** | Message broker and cache | Connection details in `config.ini` |\\n\\n### A.3.3 MySQL Configuration Requirements\\n\\nThe system requires specific MySQL timeout settings to maintain long-running connections. As documented in [README.rst:12-18]():\\n\\n**Configuration File**: `/etc/my.cnf.d/server.cnf`\\n\\n```ini\\n[mysqld]\\nwait_timeout=31536000\\ninteractive_timeout=31536000\\n```\\n\\n**Rationale**: These settings prevent connection timeouts during extended market hours and overnight sessions (31536000 seconds = 365 days).\\n\\n**Important**: MySQL service must be restarted after configuration changes.\\n\\n**Sources**: [README.rst:10-20]()\\n\\n### A.3.4 Python Package Dependencies\\n\\n| Package | Minimum Version | Purpose |\\n|---------|----------------|---------|\\n| `Django` | Latest stable | ORM framework, admin interface |\\n| `TA-Lib` | Latest stable | Technical indicator calculations |\\n| `aioredis` | Latest stable | Async Redis client |\\n| `aiohttp` | Latest stable | Async HTTP client for exchange APIs |\\n| `croniter` | Latest stable | Cron expression parsing for scheduling |\\n| `mysqlclient` | Latest stable | MySQL database adapter |\\n| `lxml` | Latest stable | XML parsing for CFFEX data |\\n\\n**Installation**: Use `pip` to install Python dependencies after installing TA-Lib C library.\\n\\n**Sources**: [README.rst:10]()\\n\\n---\\n\\n## A.4 Chinese Futures Exchange Reference\\n\\nThe trader system connects to five Chinese commodity and financial futures exchanges. This section provides reference information.\\n\\n### A.4.1 Exchange Acronyms and Full Names\\n\\n```mermaid\\ngraph LR\\n    subgraph \\\"exchange_ecosystem[Chinese Futures Exchange Ecosystem]\\\"\\n        subgraph \\\"commodity_exchanges[Commodity Exchanges]\\\"\\n            shfe[\\\"SHFE\\u003cbr/\\u003eShanghai Futures Exchange\\u003cbr/\\u003e\\\"]\\n            dce[\\\"DCE\\u003cbr/\\u003eDalian Commodity Exchange\\u003cbr/\\u003e\\\"]\\n            czce[\\\"CZCE\\u003cbr/\\u003eZhengzhou Commodity Exchange\\u003cbr/\\u003e\\\"]\\n            gfex[\\\"GFEX\\u003cbr/\\u003eGuangzhou Futures Exchange\\u003cbr/\\u003e\\\"]\\n        end\\n        \\n        subgraph \\\"financial_exchange[Financial Futures Exchange]\\\"\\n            cffex[\\\"CFFEX\\u003cbr/\\u003eChina Financial Futures Exchange\\u003cbr/\\u003e\\\"]\\n        end\\n    end\\n    \\n    subgraph \\\"data_fetch[trader/utils/fetch_data.py]\\\"\\n        update_shfe[\\\"update_from_shfe\\u003cbr/\\u003eJSON format\\\"]\\n        update_dce[\\\"update_from_dce\\u003cbr/\\u003eTXT format\\\"]\\n        update_czce[\\\"update_from_czce\\u003cbr/\\u003eTXT format\\\"]\\n        update_cffex[\\\"update_from_cffex\\u003cbr/\\u003eXML format\\\"]\\n        update_gfex[\\\"update_from_gfex\\u003cbr/\\u003eJSON format\\\"]\\n    end\\n    \\n    shfe -.-\\u003e|\\\"Daily market data\\\"| update_shfe\\n    dce -.-\\u003e|\\\"Daily market data\\\"| update_dce\\n    czce -.-\\u003e|\\\"Daily market data\\\"| update_czce\\n    cffex -.-\\u003e|\\\"Daily market data\\\"| update_cffex\\n    gfex -.-\\u003e|\\\"Daily market data\\\"| update_gfex\\n```\\n\\n**Sources**: Diagrams from high-level architecture documentation\\n\\n### A.4.2 Exchange Details\\n\\n| Exchange | Acronym | Chinese Name | Primary Products | Data Format |\\n|----------|---------|--------------|------------------|-------------|\\n| Shanghai Futures Exchange | SHFE |  | Metals, energy | JSON |\\n| Dalian Commodity Exchange | DCE |  | Agricultural products, chemicals | TXT |\\n| Zhengzhou Commodity Exchange | CZCE |  | Agricultural products | TXT |\\n| China Financial Futures Exchange | CFFEX |  | Stock index futures, treasury bonds | XML |\\n| Guangzhou Futures Exchange | GFEX |  | Industrial products, power | JSON |\\n\\n**Sources**: Referenced from overall system architecture\\n\\n### A.4.3 CTP Platform\\n\\n**China Futures Trading Platform (CTP)** is the primary order execution system used by the trader.\\n\\n| Aspect | Details |\\n|--------|---------|\\n| Full Name | China Futures Trading Platform |\\n| Provider | Shanghai Futures Information Technology (SFIT) |\\n| Purpose | Order routing, market data, account management |\\n| Integration | Via Redis message bus (see [Message Bus and Communication](#3.3)) |\\n| Error Definitions | Stored in `error.xml` (see [Error Codes and Handling](#6.4)) |\\n\\n**Sources**: System architecture documentation\\n\\n---\\n\\n## A.5 Terminology Glossary\\n\\n### A.5.1 Trading Terms\\n\\n| Term | Definition |\\n|------|------------|\\n| **Main Contract** | The most actively traded contract for a given commodity, typically the nearest expiry with highest open interest |\\n| **Rollover** | The process of closing positions in an expiring contract and opening equivalent positions in the next active contract |\\n| **Open Interest (OI)** | Total number of outstanding contracts that have not been settled |\\n| **ATR** | Average True Range - volatility indicator measuring price movement range |\\n| **CTP** | China Futures Trading Platform - the order execution interface |\\n| **NAV** | Net Asset Value - the total value of the trading account |\\n\\n### A.5.2 System Component Terms\\n\\n| Term | Definition | Code Reference |\\n|------|------------|----------------|\\n| **BaseModule** | Abstract base class providing Redis integration and callback system | `trader/strategy/__init__.py` |\\n| **TradeStrategy** | Main trading strategy implementation (importance: 227.43) | `trader/strategy/brother2.py` |\\n| **Signal** | A trading recommendation (BUY, SELL, ROLL) generated by strategy logic | `panel/models.py` Signal model |\\n| **DailyBar** | OHLC data for individual futures contracts | `panel/models.py` DailyBar model |\\n| **MainBar** | Continuous OHLC series constructed from main contracts | `panel/models.py` MainBar model |\\n| **CallbackFunctionContainer** | Registry for event-driven callback functions | `trader/strategy/__init__.py` |\\n| **@RegisterCallback** | Decorator for registering Redis message handlers | `trader/strategy/__init__.py` |\\n\\n### A.5.3 Configuration Terms\\n\\n| Term | Definition | Config Location |\\n|------|------------|-----------------|\\n| **MSG_CHANNEL** | Redis Pub/Sub channel configuration section | `config.ini` [MSG_CHANNEL] |\\n| **TRADE** | Trading parameters section (strategy, broker, instruments) | `config.ini` [TRADE] |\\n| **REDIS** | Redis connection parameters | `config.ini` [REDIS] |\\n| **MYSQL** | MySQL/Django database configuration | `config.ini` [MYSQL] |\\n| **LOG** | Logging configuration (file paths, WeChat integration) | `config.ini` [LOG] |\\n\\n**Sources**: Documentation from [Configuration Reference](#7) and [Constants and Enumerations](#7.2)\\n\\n---\\n\\n## A.6 Contributing Guidelines\\n\\n### A.6.1 Development Workflow\\n\\n```mermaid\\ngraph TB\\n    subgraph \\\"source_control[Source Control]\\\"\\n        github[\\\"GitHub Repository\\u003cbr/\\u003ehttps://github.com/timercrack/trader\\\"]\\n        gitee[\\\"Gitee Mirror\\u003cbr/\\u003eDeployment target\\\"]\\n    end\\n    \\n    subgraph \\\"development[Development Process]\\\"\\n        fork[\\\"Fork repository\\\"]\\n        branch[\\\"Create feature branch\\\"]\\n        develop[\\\"Implement changes\\\"]\\n        test[\\\"Run tests\\\"]\\n        commit[\\\"Commit with messages\\\"]\\n    end\\n    \\n    subgraph \\\"contribution[Contribution]\\\"\\n        pr[\\\"Submit Pull Request\\\"]\\n        review[\\\"Code review\\\"]\\n        merge[\\\"Merge to main\\\"]\\n    end\\n    \\n    subgraph \\\"deployment[Deployment]\\\"\\n        mirror[\\\"GitHub  Gitee sync\\\"]\\n        deploy[\\\"Deploy to production\\\"]\\n    end\\n    \\n    github --\\u003e fork\\n    fork --\\u003e branch\\n    branch --\\u003e develop\\n    develop --\\u003e test\\n    test --\\u003e commit\\n    commit --\\u003e pr\\n    pr --\\u003e review\\n    review --\\u003e merge\\n    merge --\\u003e github\\n    \\n    github -.-\\u003e|\\\"Automatic mirror\\\"| gitee\\n    gitee --\\u003e deploy\\n```\\n\\n**Sources**: [Deployment](#9) section documentation\\n\\n### A.6.2 Code Standards\\n\\n1. **License Headers**: All new source files must include the Apache License header as shown in [trader/__init__.py:3-15]()\\n\\n2. **Python Style**: Follow PEP 8 conventions\\n   - UTF-8 encoding declaration: `# coding=utf-8`\\n   - Proper imports and module organization\\n\\n3. **Documentation**: \\n   - Document all public classes and methods\\n   - Include docstrings for complex algorithms\\n   - Update relevant wiki pages for new features\\n\\n4. **Testing**: \\n   - Write unit tests for new functionality\\n   - Verify data acquisition functions (see [Testing](#8.1))\\n   - Validate trading logic in test environment\\n\\n### A.6.3 Commit Message Format\\n\\nFollow conventional commit format:\\n```\\ntype(scope): brief description\\n\\nDetailed explanation if necessary\\n\\nFixes #issue_number\\n```\\n\\n**Types**: `feat`, `fix`, `docs`, `style`, `refactor`, `test`, `chore`\\n\\n### A.6.4 Pull Request Requirements\\n\\n| Requirement | Description |\\n|-------------|-------------|\\n| **Description** | Clear explanation of changes and motivation |\\n| **Tests** | Include test coverage for new features |\\n| **Documentation** | Update wiki pages and code comments |\\n| **License** | Ensure all new files have license headers |\\n| **Breaking Changes** | Clearly document any breaking changes |\\n\\n**Sources**: [README.rst:1-26](), [LICENSE.md:1-202](), [trader/__init__.py:3-15]()\\n\\n---\\n\\n## A.7 Repository Information\\n\\n### A.7.1 Source Code Location\\n\\n**Primary Repository**: https://github.com/timercrack/trader\\n\\n**Description**:  (Trading components for automated futures trading)\\n\\n### A.7.2 Repository Structure\\n\\n```mermaid\\ngraph TB\\n    root[\\\"trader/\\\"]\\n    \\n    subgraph \\\"core[Core Application]\\\"\\n        trader_pkg[\\\"trader/\\u003cbr/\\u003eMain package\\\"]\\n        strategy[\\\"trader/strategy/\\u003cbr/\\u003eTrading strategies\\\"]\\n        utils[\\\"trader/utils/\\u003cbr/\\u003eData utilities\\\"]\\n        main[\\\"trader/main.py\\u003cbr/\\u003eEntry point\\\"]\\n    end\\n    \\n    subgraph \\\"data_layer[Data Layer]\\\"\\n        panel[\\\"panel/\\u003cbr/\\u003eDjango app\\\"]\\n        models[\\\"panel/models.py\\u003cbr/\\u003eData models\\\"]\\n        const[\\\"panel/const.py\\u003cbr/\\u003eConstants\\\"]\\n    end\\n    \\n    subgraph \\\"config[Configuration]\\\"\\n        config_ini[\\\"config.ini\\u003cbr/\\u003eSystem config\\\"]\\n        error_xml[\\\"error.xml\\u003cbr/\\u003eCTP errors\\\"]\\n    end\\n    \\n    subgraph \\\"docs[Documentation]\\\"\\n        readme[\\\"README.rst\\\"]\\n        license[\\\"LICENSE.md\\\"]\\n    end\\n    \\n    root --\\u003e trader_pkg\\n    root --\\u003e panel\\n    root --\\u003e config_ini\\n    root --\\u003e error_xml\\n    root --\\u003e readme\\n    root --\\u003e license\\n    \\n    trader_pkg --\\u003e strategy\\n    trader_pkg --\\u003e utils\\n    trader_pkg --\\u003e main\\n    \\n    panel --\\u003e models\\n    panel --\\u003e const\\n```\\n\\n**Sources**: Overall system architecture\\n\\n### A.7.3 Key Files Reference\\n\\n| File Path | Purpose | Importance Score |\\n|-----------|---------|------------------|\\n| `trader/strategy/brother2.py` | Main trading strategy implementation | 227.43 |\\n| `trader/utils/__init__.py` | Data utilities and technical analysis | 76.12 |\\n| `panel/models.py` | Django data models (8 core models) | 36.57 |\\n| `trader/main.py` | Application entry point | 24.87 |\\n| `panel/const.py` | System constants and enumerations | 18.82 |\\n| `trader/__init__.py` | Version and license metadata | 5.01 |\\n| `README.rst` | Installation instructions | 4.92 |\\n| `LICENSE.md` | Full license text | 0.50 |\\n\\n**Sources**: Importance scores from repository analysis\\n\\n---\\n\\n## A.8 Support and Resources\\n\\n### A.8.1 Documentation Structure\\n\\n| Section | Page ID | Content |\\n|---------|---------|---------|\\n| Overview | [1](#1) | System introduction and capabilities |\\n| Getting Started | [2](#2) | Installation and configuration |\\n| Architecture | [3](#3) | System design and components |\\n| Trading Strategy System | [4](#4) | Core trading engine documentation |\\n| Data Management | [5](#5) | Data models and acquisition |\\n| CTP API Integration | [6](#6) | Order execution interface |\\n| Configuration Reference | [7](#7) | Complete config.ini documentation |\\n| Development Guide | [8](#8) | Developer information |\\n| Deployment | [9](#9) | Production deployment guide |\\n| API Reference | [10](#10) | Complete API documentation |\\n| Troubleshooting | [11](#11) | Common issues and solutions |\\n\\n### A.8.2 Related Documentation\\n\\nFor specific topics, refer to:\\n- **Installation procedures**: [Installation](#2.1)\\n- **Configuration details**: [Configuration Reference](#7)\\n- **System architecture**: [Architecture](#3)\\n- **Trading strategy development**: [Creating Custom Strategies](#8.3)\\n- **Testing procedures**: [Testing](#8.1)\\n- **Error handling**: [Error Codes and Handling](#6.4)\\n- **Common issues**: [Troubleshooting](#11)\\n\\n### A.8.3 External Resources\\n\\n| Resource | Description | Relevance |\\n|----------|-------------|-----------|\\n| **TA-Lib Documentation** | Technical Analysis Library reference | Required for indicator calculations |\\n| **Django Documentation** | Django framework reference | Required for ORM and admin interface |\\n| **Redis Documentation** | Redis Pub/Sub patterns | Required for message bus architecture |\\n| **CTP API Documentation** | CTP trading platform API reference | Required for order execution |\\n| **aiohttp Documentation** | Async HTTP client library | Required for exchange data fetching |\\n\\n**Sources**: [README.rst:1-26](), repository structure analysis\\n\\n---\\n\\n## A.9 Version History\\n\\n### Current Release: 0.1.0.0\\n\\n**Status**: Development\\n\\n**Release Date**: In development\\n\\n**Major Features**:\\n- Five-exchange data acquisition (SHFE, DCE, CZCE, CFFEX, GFEX)\\n- ATR-based trading strategy implementation\\n- Redis Pub/Sub message bus architecture\\n- Django ORM with 8 core data models\\n- CTP API integration via message broker\\n- Scheduled task execution (pre-market, close, evening)\\n- Historical backtesting support\\n- WeChat notification integration\\n\\n**Known Limitations**:\\n- Single strategy implementation (brother2.py)\\n- Manual configuration required for new instruments\\n- No web UI for strategy management (uses Django admin)\\n\\n**Planned Enhancements**:\\n- Additional strategy implementations\\n- Web-based configuration interface\\n- Enhanced performance analytics\\n- Multi-strategy portfolio management\\n\\n**Sources**: [trader/__init__.py:25-26](), system architecture analysis\\n\\n---\\n\\n## A.10 Copyright and Attribution\\n\\n**Copyright**:  2016 timercrack\\n\\n**License**: Apache License, Version 2.0\\n\\n**Full License**: [LICENSE.md:1-202]()\\n\\n**Attribution Requirements**: \\n- Retain copyright notices in source files [LICENSE.md:100-104]()\\n- Include copy of Apache License with distributions [LICENSE.md:94-95]()\\n- Document modifications to files [LICENSE.md:97-98]()\\n\\n**Disclaimer**: This software is provided \\\"AS IS\\\" without warranty of any kind, express or implied. See [LICENSE.md:143-151]() for complete warranty disclaimer.\\n\\n**Sources**: [LICENSE.md:1-202](), [trader/__init__.py:3-15](), [README.rst:22-25]()\"])</script><script>self.__next_f.push([1,\"5:[\\\"$\\\",\\\"$L15\\\",null,{\\\"repoName\\\":\\\"timercrack/trader\\\",\\\"hasConfig\\\":false,\\\"canSteer\\\":true,\\\"children\\\":[\\\"$\\\",\\\"$L16\\\",null,{\\\"wiki\\\":{\\\"metadata\\\":{\\\"repo_name\\\":\\\"timercrack/trader\\\",\\\"commit_hash\\\":\\\"3307c308\\\",\\\"generated_at\\\":\\\"2025-10-30T08:11:36.456527\\\",\\\"config\\\":null,\\\"config_source\\\":\\\"none\\\"},\\\"pages\\\":[{\\\"page_plan\\\":{\\\"id\\\":\\\"1\\\",\\\"title\\\":\\\"Overview\\\"},\\\"content\\\":\\\"$17\\\"},{\\\"page_plan\\\":{\\\"id\\\":\\\"2\\\",\\\"title\\\":\\\"Getting Started\\\"},\\\"content\\\":\\\"$18\\\"},{\\\"page_plan\\\":{\\\"id\\\":\\\"2.1\\\",\\\"title\\\":\\\"Installation\\\"},\\\"content\\\":\\\"$19\\\"},{\\\"page_plan\\\":{\\\"id\\\":\\\"2.2\\\",\\\"title\\\":\\\"Configuration\\\"},\\\"content\\\":\\\"$1a\\\"},{\\\"page_plan\\\":{\\\"id\\\":\\\"2.3\\\",\\\"title\\\":\\\"Running the System\\\"},\\\"content\\\":\\\"$1b\\\"},{\\\"page_plan\\\":{\\\"id\\\":\\\"3\\\",\\\"title\\\":\\\"Architecture\\\"},\\\"content\\\":\\\"$1c\\\"},{\\\"page_plan\\\":{\\\"id\\\":\\\"3.1\\\",\\\"title\\\":\\\"System Components\\\"},\\\"content\\\":\\\"$1d\\\"},{\\\"page_plan\\\":{\\\"id\\\":\\\"3.2\\\",\\\"title\\\":\\\"Data Flow Pipeline\\\"},\\\"content\\\":\\\"$1e\\\"},{\\\"page_plan\\\":{\\\"id\\\":\\\"3.3\\\",\\\"title\\\":\\\"Message Bus and Communication\\\"},\\\"content\\\":\\\"$1f\\\"},{\\\"page_plan\\\":{\\\"id\\\":\\\"4\\\",\\\"title\\\":\\\"Trading Strategy System\\\"},\\\"content\\\":\\\"$20\\\"},{\\\"page_plan\\\":{\\\"id\\\":\\\"4.1\\\",\\\"title\\\":\\\"TradeStrategy Class\\\"},\\\"content\\\":\\\"$21\\\"},{\\\"page_plan\\\":{\\\"id\\\":\\\"4.2\\\",\\\"title\\\":\\\"BaseModule Framework\\\"},\\\"content\\\":\\\"$22\\\"},{\\\"page_plan\\\":{\\\"id\\\":\\\"4.3\\\",\\\"title\\\":\\\"Signal Generation\\\"},\\\"content\\\":\\\"$23\\\"},{\\\"page_plan\\\":{\\\"id\\\":\\\"4.4\\\",\\\"title\\\":\\\"Order Execution Flow\\\"},\\\"content\\\":\\\"$24\\\"},{\\\"page_plan\\\":{\\\"id\\\":\\\"4.5\\\",\\\"title\\\":\\\"Risk Management\\\"},\\\"content\\\":\\\"$25\\\"},{\\\"page_plan\\\":{\\\"id\\\":\\\"4.6\\\",\\\"title\\\":\\\"Scheduled Tasks\\\"},\\\"content\\\":\\\"$26\\\"},{\\\"page_plan\\\":{\\\"id\\\":\\\"5\\\",\\\"title\\\":\\\"Data Management\\\"},\\\"content\\\":\\\"$27\\\"},{\\\"page_plan\\\":{\\\"id\\\":\\\"5.1\\\",\\\"title\\\":\\\"Data Models\\\"},\\\"content\\\":\\\"$28\\\"},{\\\"page_plan\\\":{\\\"id\\\":\\\"5.2\\\",\\\"title\\\":\\\"Exchange Data Acquisition\\\"},\\\"content\\\":\\\"$29\\\"},{\\\"page_plan\\\":{\\\"id\\\":\\\"5.3\\\",\\\"title\\\":\\\"Main Contract Calculation\\\"},\\\"content\\\":\\\"$2a\\\"},{\\\"page_plan\\\":{\\\"id\\\":\\\"5.4\\\",\\\"title\\\":\\\"Technical Analysis\\\"},\\\"content\\\":\\\"$2b\\\"},{\\\"page_plan\\\":{\\\"id\\\":\\\"5.5\\\",\\\"title\\\":\\\"Historical Signal Calculation\\\"},\\\"content\\\":\\\"$2c\\\"},{\\\"page_plan\\\":{\\\"id\\\":\\\"6\\\",\\\"title\\\":\\\"CTP API Integration\\\"},\\\"content\\\":\\\"$2d\\\"},{\\\"page_plan\\\":{\\\"id\\\":\\\"6.1\\\",\\\"title\\\":\\\"Request-Response Patterns\\\"},\\\"content\\\":\\\"$2e\\\"},{\\\"page_plan\\\":{\\\"id\\\":\\\"6.2\\\",\\\"title\\\":\\\"Order Management\\\"},\\\"content\\\":\\\"$2f\\\"},{\\\"page_plan\\\":{\\\"id\\\":\\\"6.3\\\",\\\"title\\\":\\\"Market Data Handling\\\"},\\\"content\\\":\\\"$30\\\"},{\\\"page_plan\\\":{\\\"id\\\":\\\"6.4\\\",\\\"title\\\":\\\"Error Codes and Handling\\\"},\\\"content\\\":\\\"$31\\\"},{\\\"page_plan\\\":{\\\"id\\\":\\\"7\\\",\\\"title\\\":\\\"Configuration Reference\\\"},\\\"content\\\":\\\"$32\\\"},{\\\"page_plan\\\":{\\\"id\\\":\\\"7.1\\\",\\\"title\\\":\\\"Configuration File Format\\\"},\\\"content\\\":\\\"$33\\\"},{\\\"page_plan\\\":{\\\"id\\\":\\\"7.2\\\",\\\"title\\\":\\\"Constants and Enumerations\\\"},\\\"content\\\":\\\"$34\\\"},{\\\"page_plan\\\":{\\\"id\\\":\\\"8\\\",\\\"title\\\":\\\"Development Guide\\\"},\\\"content\\\":\\\"$35\\\"},{\\\"page_plan\\\":{\\\"id\\\":\\\"8.1\\\",\\\"title\\\":\\\"Testing\\\"},\\\"content\\\":\\\"$36\\\"},{\\\"page_plan\\\":{\\\"id\\\":\\\"8.2\\\",\\\"title\\\":\\\"Callback System\\\"},\\\"content\\\":\\\"$37\\\"},{\\\"page_plan\\\":{\\\"id\\\":\\\"8.3\\\",\\\"title\\\":\\\"Creating Custom Strategies\\\"},\\\"content\\\":\\\"$38\\\"},{\\\"page_plan\\\":{\\\"id\\\":\\\"8.4\\\",\\\"title\\\":\\\"Logging and Monitoring\\\"},\\\"content\\\":\\\"$39\\\"},{\\\"page_plan\\\":{\\\"id\\\":\\\"9\\\",\\\"title\\\":\\\"Deployment\\\"},\\\"content\\\":\\\"$3a\\\"},{\\\"page_plan\\\":{\\\"id\\\":\\\"10\\\",\\\"title\\\":\\\"API Reference\\\"},\\\"content\\\":\\\"$3b\\\"},{\\\"page_plan\\\":{\\\"id\\\":\\\"10.1\\\",\\\"title\\\":\\\"TradeStrategy API\\\"},\\\"content\\\":\\\"$3c\\\"},{\\\"page_plan\\\":{\\\"id\\\":\\\"10.2\\\",\\\"title\\\":\\\"BaseModule API\\\"},\\\"content\\\":\\\"$3d\\\"},{\\\"page_plan\\\":{\\\"id\\\":\\\"10.3\\\",\\\"title\\\":\\\"Data Utilities API\\\"},\\\"content\\\":\\\"$3e\\\"},{\\\"page_plan\\\":{\\\"id\\\":\\\"10.4\\\",\\\"title\\\":\\\"Django Models API\\\"},\\\"content\\\":\\\"$3f\\\"},{\\\"page_plan\\\":{\\\"id\\\":\\\"11\\\",\\\"title\\\":\\\"Troubleshooting\\\"},\\\"content\\\":\\\"$40\\\"},{\\\"page_plan\\\":{\\\"id\\\":\\\"12\\\",\\\"title\\\":\\\"Appendix\\\"},\\\"content\\\":\\\"$41\\\"}]},\\\"children\\\":\\\"$L42\\\"}]}]\\n\"])</script><script>self.__next_f.push([1,\"42:[\\\"$\\\",\\\"$L3\\\",null,{\\\"parallelRouterKey\\\":\\\"children\\\",\\\"error\\\":\\\"$undefined\\\",\\\"errorStyles\\\":\\\"$undefined\\\",\\\"errorScripts\\\":\\\"$undefined\\\",\\\"template\\\":[\\\"$\\\",\\\"$L4\\\",null,{}],\\\"templateStyles\\\":\\\"$undefined\\\",\\\"templateScripts\\\":\\\"$undefined\\\",\\\"notFound\\\":\\\"$undefined\\\",\\\"forbidden\\\":\\\"$undefined\\\",\\\"unauthorized\\\":\\\"$undefined\\\"}]\\n\"])</script><script>self.__next_f.push([1,\"43:I[36505,[],\\\"IconMark\\\"]\\n\"])</script><script>self.__next_f.push([1,\"6:[[\\\"$\\\",\\\"script\\\",null,{\\\"type\\\":\\\"application/ld+json\\\",\\\"dangerouslySetInnerHTML\\\":{\\\"__html\\\":\\\"{\\\\\\\"@context\\\\\\\":\\\\\\\"https://schema.org\\\\\\\",\\\\\\\"@type\\\\\\\":\\\\\\\"TechArticle\\\\\\\",\\\\\\\"headline\\\\\\\":\\\\\\\"Overview\\\\\\\",\\\\\\\"description\\\\\\\":\\\\\\\"This page provides a high-level introduction to the trader system, explaining its purpose, architecture, and major components. For detailed information on specific subsystems, see: $1, $1, $1, $1, and\\\\\\\",\\\\\\\"image\\\\\\\":\\\\\\\"https://deepwiki.com/timercrack/trader/og-image.png\\\\\\\",\\\\\\\"datePublished\\\\\\\":\\\\\\\"2025-10-30T08:11:36.456527\\\\\\\",\\\\\\\"dateModified\\\\\\\":\\\\\\\"2025-10-30T08:11:36.456527\\\\\\\",\\\\\\\"author\\\\\\\":{\\\\\\\"@type\\\\\\\":\\\\\\\"Organization\\\\\\\",\\\\\\\"name\\\\\\\":\\\\\\\"DeepWiki\\\\\\\",\\\\\\\"url\\\\\\\":\\\\\\\"https://deepwiki.com\\\\\\\"},\\\\\\\"publisher\\\\\\\":{\\\\\\\"@type\\\\\\\":\\\\\\\"Organization\\\\\\\",\\\\\\\"name\\\\\\\":\\\\\\\"DeepWiki\\\\\\\",\\\\\\\"logo\\\\\\\":{\\\\\\\"@type\\\\\\\":\\\\\\\"ImageObject\\\\\\\",\\\\\\\"url\\\\\\\":\\\\\\\"https://deepwiki.com/icon.png\\\\\\\"}},\\\\\\\"mainEntityOfPage\\\\\\\":{\\\\\\\"@type\\\\\\\":\\\\\\\"WebPage\\\\\\\",\\\\\\\"@id\\\\\\\":\\\\\\\"https://deepwiki.com/timercrack/trader\\\\\\\"}}\\\"}}],[\\\"$\\\",\\\"$L3\\\",null,{\\\"parallelRouterKey\\\":\\\"children\\\",\\\"error\\\":\\\"$undefined\\\",\\\"errorStyles\\\":\\\"$undefined\\\",\\\"errorScripts\\\":\\\"$undefined\\\",\\\"template\\\":[\\\"$\\\",\\\"$L4\\\",null,{}],\\\"templateStyles\\\":\\\"$undefined\\\",\\\"templateScripts\\\":\\\"$undefined\\\",\\\"notFound\\\":\\\"$undefined\\\",\\\"forbidden\\\":\\\"$undefined\\\",\\\"unauthorized\\\":\\\"$undefined\\\"}]]\\n\"])</script><script>self.__next_f.push([1,\"e:{\\\"metadata\\\":[[\\\"$\\\",\\\"title\\\",\\\"0\\\",{\\\"children\\\":\\\"timercrack/trader | DeepWiki\\\"}],[\\\"$\\\",\\\"meta\\\",\\\"1\\\",{\\\"name\\\":\\\"description\\\",\\\"content\\\":\\\"This page provides a high-level introduction to the trader system, explaining its purpose, architecture, and major components. For detailed information on specific subsystems, see: $1, $1, $1, $1, and\\\"}],[\\\"$\\\",\\\"meta\\\",\\\"2\\\",{\\\"name\\\":\\\"keywords\\\",\\\"content\\\":\\\"timercrack/trader,timercrack,trader,documentation,wiki,codebase,AI documentation,Devin,Overview\\\"}],[\\\"$\\\",\\\"link\\\",\\\"3\\\",{\\\"rel\\\":\\\"canonical\\\",\\\"href\\\":\\\"https://deepwiki.com/timercrack/trader\\\"}],[\\\"$\\\",\\\"meta\\\",\\\"4\\\",{\\\"property\\\":\\\"og:title\\\",\\\"content\\\":\\\"timercrack/trader | DeepWiki\\\"}],[\\\"$\\\",\\\"meta\\\",\\\"5\\\",{\\\"property\\\":\\\"og:description\\\",\\\"content\\\":\\\"This page provides a high-level introduction to the trader system, explaining its purpose, architecture, and major components. For detailed information on specific subsystems, see: $1, $1, $1, $1, and\\\"}],[\\\"$\\\",\\\"meta\\\",\\\"6\\\",{\\\"property\\\":\\\"og:url\\\",\\\"content\\\":\\\"https://deepwiki.com/timercrack/trader\\\"}],[\\\"$\\\",\\\"meta\\\",\\\"7\\\",{\\\"property\\\":\\\"og:site_name\\\",\\\"content\\\":\\\"DeepWiki\\\"}],[\\\"$\\\",\\\"meta\\\",\\\"8\\\",{\\\"property\\\":\\\"og:image\\\",\\\"content\\\":\\\"https://deepwiki.com/timercrack/trader/og-image.png?page=1\\\"}],[\\\"$\\\",\\\"meta\\\",\\\"9\\\",{\\\"property\\\":\\\"og:type\\\",\\\"content\\\":\\\"website\\\"}],[\\\"$\\\",\\\"meta\\\",\\\"10\\\",{\\\"name\\\":\\\"twitter:card\\\",\\\"content\\\":\\\"summary_large_image\\\"}],[\\\"$\\\",\\\"meta\\\",\\\"11\\\",{\\\"name\\\":\\\"twitter:site\\\",\\\"content\\\":\\\"@cognition\\\"}],[\\\"$\\\",\\\"meta\\\",\\\"12\\\",{\\\"name\\\":\\\"twitter:creator\\\",\\\"content\\\":\\\"@cognition\\\"}],[\\\"$\\\",\\\"meta\\\",\\\"13\\\",{\\\"name\\\":\\\"twitter:title\\\",\\\"content\\\":\\\"timercrack/trader | DeepWiki\\\"}],[\\\"$\\\",\\\"meta\\\",\\\"14\\\",{\\\"name\\\":\\\"twitter:description\\\",\\\"content\\\":\\\"This page provides a high-level introduction to the trader system, explaining its purpose, architecture, and major components. For detailed information on specific subsystems, see: $1, $1, $1, $1, and\\\"}],[\\\"$\\\",\\\"meta\\\",\\\"15\\\",{\\\"name\\\":\\\"twitter:image\\\",\\\"content\\\":\\\"https://deepwiki.com/timercrack/trader/og-image.png?page=1\\\"}],[\\\"$\\\",\\\"link\\\",\\\"16\\\",{\\\"rel\\\":\\\"icon\\\",\\\"href\\\":\\\"/favicon.ico\\\",\\\"type\\\":\\\"image/x-icon\\\",\\\"sizes\\\":\\\"48x48\\\"}],[\\\"$\\\",\\\"link\\\",\\\"17\\\",{\\\"rel\\\":\\\"icon\\\",\\\"href\\\":\\\"/icon.png?1ee4c6a68a73a205\\\",\\\"type\\\":\\\"image/png\\\",\\\"sizes\\\":\\\"48x48\\\"}],[\\\"$\\\",\\\"link\\\",\\\"18\\\",{\\\"rel\\\":\\\"apple-touch-icon\\\",\\\"href\\\":\\\"/apple-icon.png?a4f658907db0ab87\\\",\\\"type\\\":\\\"image/png\\\",\\\"sizes\\\":\\\"180x180\\\"}],[\\\"$\\\",\\\"$L43\\\",\\\"19\\\",{}]],\\\"error\\\":null,\\\"digest\\\":\\\"$undefined\\\"}\\n\"])</script><script>self.__next_f.push([1,\"13:\\\"$e:metadata\\\"\\n\"])</script><next-route-announcer style=\"position: absolute;\"></next-route-announcer><iframe id=\"_hjSafeContext_36608177\" title=\"_hjSafeContext\" tabindex=\"-1\" aria-hidden=\"true\" src=\"about:blank\" style=\"display: none !important; width: 1px !important; height: 1px !important; opacity: 0 !important; pointer-events: none !important;\"></iframe></body></html>",
    "metadata": {
      "description": "This page provides a high-level introduction to the trader system, explaining its purpose, architecture, and major components. For detailed information on specific subsystems, see: $1, $1, $1, $1, and",
      "keywords": "timercrack/trader,timercrack,trader,documentation,wiki,codebase,AI documentation,Devin,Overview",
      "lang": "en",
      "next-size-adjust": "",
      "og:description": "This page provides a high-level introduction to the trader system, explaining its purpose, architecture, and major components. For detailed information on specific subsystems, see: $1, $1, $1, $1, and",
      "og:image": "https://deepwiki.com/timercrack/trader/og-image.png?page=1",
      "og:site_name": "DeepWiki",
      "og:title": "timercrack/trader | DeepWiki",
      "og:type": "website",
      "og:url": "https://deepwiki.com/timercrack/trader",
      "twitter:card": "summary_large_image",
      "twitter:creator": "@cognition",
      "twitter:description": "This page provides a high-level introduction to the trader system, explaining its purpose, architecture, and major components. For detailed information on specific subsystems, see: $1, $1, $1, $1, and",
      "twitter:image": "https://deepwiki.com/timercrack/trader/og-image.png?page=1",
      "twitter:site": "@cognition",
      "twitter:title": "timercrack/trader | DeepWiki",
      "viewport": "width=device-width, initial-scale=1"
    },
    "publishedTime": "2025-10-30T08:11:36.456527",
    "title": "Overview",
    "url": "https://deepwiki.com/timercrack/trader",
    "usage": {
      "tokens": 424852
    }
  },
  "meta": {
    "usage": {
      "tokens": 424852
    }
  },
  "status": 20000
}